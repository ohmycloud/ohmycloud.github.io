<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-us" lang="en-us">

    <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    <link href="https://gmpg.org/xfn/11" rel="profile">
    <meta charset="utf-8">
    
    
    

    
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5">

    
    <meta name="referrer" content="no-referrer">

    <title>
        
            原生调用接口 ❚ 焉知非鱼
        
    </title>

    
    


    
    
    
    

    
    
    
    

    
    
    

    
    
    
    <style>
     
     
     :root {
         --theme-color: #ac4142;
         --theme-color-light: rgba(172, 65, 66, 0.2);
     }
     
     html {
         line-height: 1.5;
     }
    </style>

    
    

    
    
    
    
    <link rel="stylesheet" href="/css/refined.min.7f6d3ee611034e4ebcbc063f1db3bc042fecdc8901afbedad80ff02bae409204.css">
    
    <link rel="preload" href="/css/refined.min.7f6d3ee611034e4ebcbc063f1db3bc042fecdc8901afbedad80ff02bae409204.css" as="style">

    



    
        <style>
         
         /* Background */ .chroma { background-color: #ffffff }
/* Error */ .chroma .err { color: #a61717; background-color: #e3d2d2 }
/* LineTableTD */ .chroma .lntd { vertical-align: top; padding: 0; margin: 0; border: 0; }
/* LineTable */ .chroma .lntable { border-spacing: 0; padding: 0; margin: 0; border: 0; width: auto; overflow: auto; display: block; }
/* LineHighlight */ .chroma .hl { display: block; width: 100%;background-color: #ffffcc }
/* LineNumbersTable */ .chroma .lnt { margin-right: 0.4em; padding: 0 0.4em 0 0.4em; }
/* LineNumbers */ .chroma .ln { margin-right: 0.4em; padding: 0 0.4em 0 0.4em; }
/* Keyword */ .chroma .k { color: #000000; font-weight: bold }
/* KeywordConstant */ .chroma .kc { color: #000000; font-weight: bold }
/* KeywordDeclaration */ .chroma .kd { color: #000000; font-weight: bold }
/* KeywordNamespace */ .chroma .kn { color: #000000; font-weight: bold }
/* KeywordPseudo */ .chroma .kp { color: #000000; font-weight: bold }
/* KeywordReserved */ .chroma .kr { color: #000000; font-weight: bold }
/* KeywordType */ .chroma .kt { color: #445588; font-weight: bold }
/* NameAttribute */ .chroma .na { color: #008080 }
/* NameBuiltin */ .chroma .nb { color: #0086b3 }
/* NameBuiltinPseudo */ .chroma .bp { color: #999999 }
/* NameClass */ .chroma .nc { color: #445588; font-weight: bold }
/* NameConstant */ .chroma .no { color: #008080 }
/* NameDecorator */ .chroma .nd { color: #3c5d5d; font-weight: bold }
/* NameEntity */ .chroma .ni { color: #800080 }
/* NameException */ .chroma .ne { color: #990000; font-weight: bold }
/* NameFunction */ .chroma .nf { color: #990000; font-weight: bold }
/* NameLabel */ .chroma .nl { color: #990000; font-weight: bold }
/* NameNamespace */ .chroma .nn { color: #555555 }
/* NameTag */ .chroma .nt { color: #000080 }
/* NameVariable */ .chroma .nv { color: #008080 }
/* NameVariableClass */ .chroma .vc { color: #008080 }
/* NameVariableGlobal */ .chroma .vg { color: #008080 }
/* NameVariableInstance */ .chroma .vi { color: #008080 }
/* LiteralString */ .chroma .s { color: #dd1144 }
/* LiteralStringAffix */ .chroma .sa { color: #dd1144 }
/* LiteralStringBacktick */ .chroma .sb { color: #dd1144 }
/* LiteralStringChar */ .chroma .sc { color: #dd1144 }
/* LiteralStringDelimiter */ .chroma .dl { color: #dd1144 }
/* LiteralStringDoc */ .chroma .sd { color: #dd1144 }
/* LiteralStringDouble */ .chroma .s2 { color: #dd1144 }
/* LiteralStringEscape */ .chroma .se { color: #dd1144 }
/* LiteralStringHeredoc */ .chroma .sh { color: #dd1144 }
/* LiteralStringInterpol */ .chroma .si { color: #dd1144 }
/* LiteralStringOther */ .chroma .sx { color: #dd1144 }
/* LiteralStringRegex */ .chroma .sr { color: #009926 }
/* LiteralStringSingle */ .chroma .s1 { color: #dd1144 }
/* LiteralStringSymbol */ .chroma .ss { color: #990073 }
/* LiteralNumber */ .chroma .m { color: #009999 }
/* LiteralNumberBin */ .chroma .mb { color: #009999 }
/* LiteralNumberFloat */ .chroma .mf { color: #009999 }
/* LiteralNumberHex */ .chroma .mh { color: #009999 }
/* LiteralNumberInteger */ .chroma .mi { color: #009999 }
/* LiteralNumberIntegerLong */ .chroma .il { color: #009999 }
/* LiteralNumberOct */ .chroma .mo { color: #009999 }
/* Operator */ .chroma .o { color: #000000; font-weight: bold }
/* OperatorWord */ .chroma .ow { color: #000000; font-weight: bold }
/* Comment */ .chroma .c { color: #999988; font-style: italic }
/* CommentHashbang */ .chroma .ch { color: #999988; font-style: italic }
/* CommentMultiline */ .chroma .cm { color: #999988; font-style: italic }
/* CommentSingle */ .chroma .c1 { color: #999988; font-style: italic }
/* CommentSpecial */ .chroma .cs { color: #999999; font-weight: bold; font-style: italic }
/* CommentPreproc */ .chroma .cp { color: #999999; font-weight: bold; font-style: italic }
/* CommentPreprocFile */ .chroma .cpf { color: #999999; font-weight: bold; font-style: italic }
/* GenericDeleted */ .chroma .gd { color: #000000; background-color: #ffdddd }
/* GenericEmph */ .chroma .ge { color: #000000; font-style: italic }
/* GenericError */ .chroma .gr { color: #aa0000 }
/* GenericHeading */ .chroma .gh { color: #999999 }
/* GenericInserted */ .chroma .gi { color: #000000; background-color: #ddffdd }
/* GenericOutput */ .chroma .go { color: #888888 }
/* GenericPrompt */ .chroma .gp { color: #555555 }
/* GenericStrong */ .chroma .gs { font-weight: bold }
/* GenericSubheading */ .chroma .gu { color: #aaaaaa }
/* GenericTraceback */ .chroma .gt { color: #aa0000 }
/* GenericUnderline */ .chroma .gl { text-decoration: underline }
/* TextWhitespace */ .chroma .w { color: #bbbbbb }

         
         /* Overrides on top of the theme and Chroma CSS */
/* Chroma-based lines highlighting in code blocks */
.chroma .hl {
    background-color: #e8e8e8;
    /* Extend highlight up to 100 characters (assuming that the code blocks never have more than 100 characters in a line) */
    min-width: 100ch;
}
/* GenericHeading */ .chroma .gh { color: #999999; font-weight: bold }
/* GenericSubheading */ .chroma .gu { color: #aaaaaa; font-weight: bold }

         
        </style>
    

    

    
    
    

    
    <script src="/js/responsive-nav-orig.min.e2b5f2a956b488f466da513820636134defdc38b90ed566248960593f2bb4ba5.js"></script>
    
    <link rel="preload" href="/js/responsive-nav-orig.min.e2b5f2a956b488f466da513820636134defdc38b90ed566248960593f2bb4ba5.js" as="script">

    
    
    <script defer src="/js/libs/fa/fontawesome-all.min.08916ac0fd078adfb58edc890460e2c8990729aee02bca7586404b56805f5219.js"></script>
    
    <link rel="preload" href="/js/libs/fa/fontawesome-all.min.08916ac0fd078adfb58edc890460e2c8990729aee02bca7586404b56805f5219.js" as="script">

    

    

    
    
    

    
    
<!-- rel="me" links for IndieAuth -->







    
 
<meta property="og:title" content="原生调用接口" />
<meta property="og:description"
      content=" " />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://localhost:1313/rakulang/50.native-calling-interface/" />


    
        <meta property="article:published_time" content="2018-11-25T21:13:31&#43;08:00"/>
    
    
        <meta property="article:modified_time" content="2018-11-25T21:13:31&#43;08:00"/>
    









    




     <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="原生调用接口"/>
<meta name="twitter:description" content=" "/>


    
    
    <link rel="alternate" type="application/jf2post+json" href="http://localhost:1313/rakulang/50.native-calling-interface/jf2post.json" title="Jf2post for 焉知非鱼" />
    
     



    
    
    
        
    


     
        
        <meta name="DC.Creator" content="焉知非鱼"/>
    



    
    
    
    <meta name="hugo-build-date" content="2024-03-01T16:16:06Z"/>
    <meta name="hugo-commit-hash" content="312735366b20d64bd61bff8627f593749f86c964"/>
    <meta name="generator" content="Hugo 0.123.7">
</head>


    
        <body lang="en">
    

        
        <div class="border" id="home"></div>

        <div class="wrapper">   
            
<nav id="nav" class="nav-collapse opened" aria-hidden="false">
    <ul class="navbar">
        <li><a class="" href="/">Home</a></li>
        
            
                <li><a class="" href="http://localhost:1313/posts/">Posts</a></li>
            
        
            
                <li><a class="" href="http://localhost:1313/notes/">Notes</a></li>
            
        
            
                <li><a class="" href="http://localhost:1313/rakulang/">Rakulang</a></li>
            
        
        
            <li><a class="" href="http://localhost:1313/search/">Search</a></li>
        
    </ul>
</nav>

            <div class="container">
                <header class="masthead">
                    <div class="masthead-title no-text-decoration">
                        <a href="/">焉知非鱼</a> <span class="blinking-cursor">❚</span>
                    </div>
                    <div class="masthead-tagline">
                        Wait the light to fall
                    </div>
                </header>

                








<article class="post h-entry rakulang">
    <header>
        <div class="center">
    <div class="taxo no-text-decoration">
         
            
                <ul class="no-bullets inline categories">
                    
                        
                        
                        
                            
                            
                            
                            
                            
                            <li class="__rakulang__"
                                
                                
                                title="See all 0 posts categorized in ‘rakulang’"
                                
                            >
                                <a class="p-category" href="http://localhost:1313/categories/rakulang/">rakulang</a>
                            </li>
                        
                    
                </ul>
            
         
            
                <ul class="no-bullets inline tags">
                    
                        
                        
                        
                            
                            
                            
                            
                            
                            <li class="__rakulang__"
                                
                                
                                title="See all 0 posts tagged with ‘rakulang’"
                                
                            >
                                <a class="p-category" href="http://localhost:1313/tags/rakulang/">rakulang</a>
                            </li>
                        
                    
                </ul>
            
        
    </div>

</div>

        <h1 class="post-title p-name">原生调用接口</h1>

        
        <data class="u-url" value="http://localhost:1313/rakulang/50.native-calling-interface/"></data>

        <div class="date-syndication">
            


    
    
    <div class="post-date">
        
        <time datetime="2018-11-25T21:13:31+0800" class="dt-published">Sun Nov 25, 2018</time>
        
        
    </div>


            




        </div>
         



    
    
    
        
    


    
        
        <span class="hide">
            &mdash; <a href="http://localhost:1313/" class="u-author">焉知非鱼</a>
        </span>
    


    </header>

    <div class="content">
        


        





                       


        <div class="e-content">
            




<h1 id="原生调用接口">原生调用接口</h1>
<h2 id="入门指南">入门指南&nbsp;<a class="headline-hash no-text-decoration" href="#入门指南">#</a> </h2>
<p>能想象出的最简单的 <code>NativeCall</code> 用法应该类似于这样的东西：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-raku" data-lang="raku"><span class="line"><span class="cl"><span class="k">use</span> <span class="kt">NativeCall</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">sub</span> <span class="nf">some_argless_function</span><span class="p">()</span> <span class="k">is</span> <span class="k">native</span><span class="p">(&#39;</span><span class="s1">something</span><span class="p">&#39;)</span> <span class="p">{</span> <span class="o">*</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="nf">some_argless_function</span><span class="p">();</span>
</span></span></code></pre></div><p>第一行导入了各种 <code>traits</code> 和类型，接下来的一行看起来很像相对普通的 Raku 子例程声明 - 稍微有点变化。我们使用<strong>native</strong>这个 <code>trait </code> 是为了指定这个 sub 子例程实际上被定义在<strong>原生库</strong>中。Raku 会给你添加特定平台的扩展名（比如 <code>.so</code> 或者 <code>.dll</code>）还有任何惯常的前缀(例如: &rsquo;lib&rsquo;)。</p>
<p>当你第一次调用 “some_argless_function” 时，“<strong>lib</strong>something” 将会被加载，然后会在 libsomething 库中定位到 “some_argless_function” 函数，接下来将会进行一次调用。之后的调用将会更快，因为符号句柄会被保留。</p>
<p>当然，大部分的函数都会接受参数或者返回值 - 但是你可以做的其他事情只是增加了这个声明Raku sub的简单模式</p>
<p>但是一切你需要做的就是增加这个简单的模式，通过声明一个 Raku 的过程、在符号后面指出你想要调用的名字，并且使用 “native” trait。</p>
<h2 id="改变名字">改变名字&nbsp;<a class="headline-hash no-text-decoration" href="#改变名字">#</a> </h2>
<p>有时你想要 Raku 子例程的名字和加载库中使用的名字不同，可能这个名字很长, 或者有不同的大小写或者在你想要创建的模块的上下文中, 这个名字很繁琐。</p>
<p>NativeCall 为你提供了一个 <code>symbol</code> trait 以指定库中<strong>原生子例程</strong>的名字, 这个名字和你的 Raku 子例程名字不同。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-raku" data-lang="raku"><span class="line"><span class="cl"><span class="k">module</span> <span class="nn">Foo</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">use</span> <span class="kt">NativeCall</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">our</span> <span class="k">sub</span> <span class="nf">init</span><span class="p">()</span> <span class="k">is</span> <span class="k">native</span><span class="p">(&#39;</span><span class="s1">foo</span><span class="p">&#39;)</span> <span class="k">is</span> <span class="k">symbol</span><span class="p">(&#39;</span><span class="s1">FOO_INIT</span><span class="p">&#39;)</span> <span class="p">{</span> <span class="o">*</span> <span class="p">}</span>
</span></span></code></pre></div><p>在 <code>libfoo</code> 库里面有一个子例程叫 <code>FOO_INIT</code>，因为我们创建了一个模块叫做 Foo，我们更愿意使用 <code>Foo::init</code> 调用子例程，我们使用 <code>symbol</code> trait 来指定在 <code>libfoo</code> 库名字符号的名字，然后以任何我们想要的方式调用这个子例程（这里是 “init”）。</p>
<h2 id="传递值和返回值">传递值和返回值&nbsp;<a class="headline-hash no-text-decoration" href="#传递值和返回值">#</a> </h2>
<p>普通的 Raku 签名和 <code>returns</code> trait 的使用是为了传送原生函数期望的参数类型以及返回的东西，下面有个例子：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-raku" data-lang="raku"><span class="line"><span class="cl"><span class="k">sub</span> <span class="nb">add</span><span class="p">(</span><span class="kt">int32</span><span class="o">,</span> <span class="kt">int32</span><span class="p">)</span> <span class="k">returns</span> <span class="kt">int32</span> <span class="k">is</span> <span class="k">native</span><span class="p">(&#39;</span><span class="s1">calculator</span><span class="p">&#39;)</span> <span class="p">{</span> <span class="o">*</span> <span class="p">}</span>
</span></span></code></pre></div><p>在这里，我们声明该函数接受两个32位整数，返回一个32位整数。你可以在<a href="https://docs.raku.org/language/nativetypes">原生类型</a>页面中找到可以传递的其他类型。 请注意，缺少 <code>returns</code> trait 用于指示 <code>void</code> 返回类型。 除指针参数化外，不要在任何地方使用 <code>void</code> 类型。</p>
<p>对于字符串，还有一个额外的 <code>encoded</code> trait，可以提供一些关于如何进行编组的额外提示。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-raku" data-lang="raku"><span class="line"><span class="cl"><span class="k">use</span> <span class="kt">NativeCall</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">sub</span> <span class="nf">message_box</span><span class="p">(</span><span class="kt">Str</span> <span class="k">is</span> <span class="nc">encoded</span><span class="p">(&#39;</span><span class="s1">utf8</span><span class="p">&#39;))</span> <span class="k">is</span> <span class="k">native</span><span class="p">(&#39;</span><span class="s1">gui</span><span class="p">&#39;)</span> <span class="p">{</span> <span class="o">*</span> <span class="p">}</span>
</span></span></code></pre></div><p>为了指定如何对返回类型进行编组，只需在子例程自身应用这个 trait 即可。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-raku" data-lang="raku"><span class="line"><span class="cl"><span class="k">use</span> <span class="kt">NativeCall</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">sub</span> <span class="nf">input_box</span><span class="p">()</span> <span class="k">returns</span> <span class="kt">Str</span> <span class="k">is</span> <span class="nc">encoded</span><span class="p">(&#39;</span><span class="s1">utf8</span><span class="p">&#39;)</span> <span class="k">is</span> <span class="k">native</span><span class="p">(&#39;</span><span class="s1">gui</span><span class="p">&#39;)</span> <span class="p">{</span> <span class="o">*</span> <span class="p">}</span>
</span></span></code></pre></div><p>注意, 可以通过传递 Str 类型对象来传递 NULL 字符串指针; NULL 返回也将由类型对象表示。</p>
<p>如果 C 函数要求字符串的生命周期超过函数调用，则必须手动编码该参数并将其作为 <code>CArray[uint8]</code> 传递：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-raku" data-lang="raku"><span class="line"><span class="cl"><span class="k">use</span> <span class="kt">NativeCall</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="c1"># C prototype is void set_foo(const char *) </span>
</span></span><span class="line"><span class="cl"><span class="k">sub</span> <span class="nf">set_foo</span><span class="p">(</span><span class="kt">CArray</span><span class="o">[</span><span class="kt">uint8</span><span class="o">]</span><span class="p">)</span> <span class="k">is</span> <span class="k">native</span><span class="p">(&#39;</span><span class="s1">foo</span><span class="p">&#39;)</span> <span class="p">{</span> <span class="o">*</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1"># C prototype is void use_foo(void) </span>
</span></span><span class="line"><span class="cl"><span class="k">sub</span> <span class="nf">use_foo</span><span class="p">()</span> <span class="k">is</span> <span class="k">native</span><span class="p">(&#39;</span><span class="s1">foo</span><span class="p">&#39;)</span> <span class="p">{</span> <span class="o">*</span> <span class="p">}</span> <span class="c1"># will use pointer stored by set_foo() </span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="k">my</span> <span class="nv">$string</span> <span class="o">=</span> <span class="p">&#34;</span><span class="s2">FOO</span><span class="p">&#34;;</span>
</span></span><span class="line"><span class="cl"><span class="c1"># The lifetime of this variable must be equal to the required lifetime of </span>
</span></span><span class="line"><span class="cl"><span class="c1"># the data passed to the C function. </span>
</span></span><span class="line"><span class="cl"><span class="k">my</span> <span class="nv">$array</span> <span class="o">=</span> <span class="kt">CArray</span><span class="o">[</span><span class="kt">uint8</span><span class="o">].</span><span class="nb">new</span><span class="p">(</span><span class="nv">$string</span><span class="o">.</span><span class="nb">encode</span><span class="o">.</span><span class="nb">list</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="nf">set_foo</span><span class="p">(</span><span class="nv">$array</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="c1"># ... </span>
</span></span><span class="line"><span class="cl"><span class="nf">use_foo</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="c1"># It&#39;s fine if $array goes out of scope starting from here. </span>
</span></span></code></pre></div><h2 id="指定原生表示">指定原生表示&nbsp;<a class="headline-hash no-text-decoration" href="#指定原生表示">#</a> </h2>
<p>使用原生函数时，有时需要指定要使用的原生数据结构类型。 <code>is repr</code> 是用于此的术语。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-raku" data-lang="raku"><span class="line"><span class="cl"><span class="k">use</span> <span class="kt">NativeCall</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">timespec</span> <span class="k">is</span> <span class="k">repr</span><span class="p">(&#39;</span><span class="s1">CStruct</span><span class="p">&#39;)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">has</span> <span class="kt">uint32</span> <span class="nv">$.tv_sec</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">has</span> <span class="kt">long</span> <span class="nv">$.tv_nanosecs</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="k">sub</span> <span class="nf">clock_gettime</span><span class="p">(</span><span class="kt">uint32</span> <span class="nv">$clock-id</span><span class="o">,</span> <span class="n">timespec</span> <span class="nv">$tspec</span> <span class="k">--&gt;</span> <span class="kt">uint32</span><span class="p">)</span> <span class="k">is</span> <span class="k">native</span> <span class="p">{</span> <span class="o">*</span> <span class="p">};</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="k">my</span> <span class="n">timespec</span> <span class="nv">$this-time</span> <span class="o">.=</span><span class="nb">new</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="k">my</span> <span class="nv">$result</span> <span class="o">=</span> <span class="nf">clock_gettime</span><span class="p">(</span> <span class="mi">0</span><span class="o">,</span> <span class="nv">$this-time</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="nb">say</span> <span class="p">&#34;</span><span class="nv">$result</span><span class="s2">, </span><span class="nv">$this-time</span><span class="p">&#34;;</span> <span class="c1"># OUTPUT: «0, timespec&lt;65385480&gt;␤» </span>
</span></span></code></pre></div><p><a href="https://linux.die.net/man/3/clock_gettime">我们调用的原始函数</a>, <a href="https://docs.raku.org/routine/clock_gettime">clock_gettime</a> 使用指向 <code>timespec</code> 结构的指针作为第二个参数。 我们在这里将它声明为一个<a href="https://docs.raku.org/routine/class">类</a>，但是将其表示指定为 <code>repr('CStruct')</code>, 以指示它对应于 C 数据结构。 当我们创建该类的对象时，我们正在创建 <code>clock_gettime</code> 所期望的指针类型。 这样，数据可以无缝地传输到原生接口和从原生接口传输。</p>
<h2 id="指针的基本使用">指针的基本使用&nbsp;<a class="headline-hash no-text-decoration" href="#指针的基本使用">#</a> </h2>
<p>当你的原生函数签名需要一个指向某些原生类型（<code>int32</code>、<code>uint32</code>等等）的指针时，所有你需要做的就是将参数声明为 <code>is rw</code>：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-raku" data-lang="raku"><span class="line"><span class="cl"><span class="k">use</span> <span class="kt">NativeCall</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="c1"># C prototype is void my_version(int *major, int *minor) </span>
</span></span><span class="line"><span class="cl"><span class="k">sub</span> <span class="nf">my_version</span><span class="p">(</span><span class="kt">int32</span> <span class="k">is</span> <span class="k">rw</span><span class="o">,</span> <span class="kt">int32</span> <span class="k">is</span> <span class="k">rw</span><span class="p">)</span> <span class="k">is</span> <span class="k">native</span><span class="p">(&#39;</span><span class="s1">foo</span><span class="p">&#39;)</span> <span class="p">{</span> <span class="o">*</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="nf">my_version</span><span class="p">(</span><span class="k">my</span> <span class="kt">int32</span> <span class="nv">$major</span><span class="o">,</span> <span class="k">my</span> <span class="kt">int32</span> <span class="nv">$minor</span><span class="p">);</span> <span class="c1"># Pass a pointer to </span>
</span></span></code></pre></div><p>有的时候你需要获取一个从 C 库返回的指针（比如一个库句柄），你不关心它指向什么 - 你只需要保存它就可以了，<code>Pointer</code> 类型就是为此而生的：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-raku" data-lang="raku"><span class="line"><span class="cl"><span class="k">use</span> <span class="kt">NativeCall</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">sub</span> <span class="nf">Foo_init</span><span class="p">()</span> <span class="k">returns</span> <span class="kt">Pointer</span> <span class="k">is</span> <span class="k">native</span><span class="p">(&#34;</span><span class="s2">foo</span><span class="p">&#34;)</span> <span class="p">{</span> <span class="o">*</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k">sub</span> <span class="nf">Foo_free</span><span class="p">(</span><span class="kt">Pointer</span><span class="p">)</span> <span class="k">is</span> <span class="k">native</span><span class="p">(&#34;</span><span class="s2">foo</span><span class="p">&#34;)</span> <span class="p">{</span> <span class="o">*</span> <span class="p">}</span>
</span></span></code></pre></div><p>这个可以正常工作，但是你可能想要使用比 <code>Pointer</code> 更好的类型，事实证明，任何具有表示“CPointer”的类都可以担任此角色，这意味着你可以通过编写如下类来暴露工作在句柄上的库：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-raku" data-lang="raku"><span class="line"><span class="cl"><span class="k">use</span> <span class="kt">NativeCall</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">FooHandle</span> <span class="k">is</span> <span class="k">repr</span><span class="p">(&#39;</span><span class="s1">CPointer</span><span class="p">&#39;)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># Here are the actual NativeCall functions. </span>
</span></span><span class="line"><span class="cl">    <span class="k">sub</span> <span class="nf">Foo_init</span><span class="p">()</span> <span class="k">returns</span> <span class="n">FooHandle</span> <span class="k">is</span> <span class="k">native</span><span class="p">(&#34;</span><span class="s2">foo</span><span class="p">&#34;)</span> <span class="p">{</span> <span class="o">*</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">sub</span> <span class="nf">Foo_free</span><span class="p">(</span><span class="n">FooHandle</span><span class="p">)</span> <span class="k">is</span> <span class="k">native</span><span class="p">(&#34;</span><span class="s2">foo</span><span class="p">&#34;)</span> <span class="p">{</span> <span class="o">*</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">sub</span> <span class="nf">Foo_query</span><span class="p">(</span><span class="n">FooHandle</span><span class="o">,</span> <span class="kt">Str</span><span class="p">)</span> <span class="k">returns</span> <span class="kt">int8</span> <span class="k">is</span> <span class="k">native</span><span class="p">(&#34;</span><span class="s2">foo</span><span class="p">&#34;)</span> <span class="p">{</span> <span class="o">*</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">sub</span> <span class="nf">Foo_close</span><span class="p">(</span><span class="n">FooHandle</span><span class="p">)</span> <span class="k">returns</span> <span class="kt">int8</span> <span class="k">is</span> <span class="k">native</span><span class="p">(&#34;</span><span class="s2">foo</span><span class="p">&#34;)</span> <span class="p">{</span> <span class="o">*</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">    <span class="c1"># Here are the methods we use to expose it to the outside world. </span>
</span></span><span class="line"><span class="cl">    <span class="k">method</span> <span class="nb">new</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">Foo_init</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">    <span class="k">method</span> <span class="nf">query</span><span class="p">(</span><span class="kt">Str</span> <span class="nv">$stmt</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">Foo_query</span><span class="p">(</span><span class="nb">self</span><span class="o">,</span> <span class="nv">$stmt</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">    <span class="k">method</span> <span class="nb">close</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">Foo_close</span><span class="p">(</span><span class="nb">self</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">    <span class="c1"># Free data when the object is garbage collected. </span>
</span></span><span class="line"><span class="cl">    <span class="k">submethod</span> <span class="nb">DESTROY</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">Foo_free</span><span class="p">(</span><span class="nb">self</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>请注意，CPointer 表示只能保存 C 指针。 这意味着你的类不能有额外的属性。 但是，对于简单的库，这可能是向其暴露面向对象的接口的一种巧妙方式。</p>
<p>当然，你总是可以有一个空类：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-raku" data-lang="raku"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">DoorHandle</span> <span class="k">is</span> <span class="k">repr</span><span class="p">(&#39;</span><span class="s1">CPointer</span><span class="p">&#39;)</span> <span class="p">{</span> <span class="p">}</span>
</span></span></code></pre></div><p>只需像使用 <code>Pointer</code> 一样使用类，但有可能提高类型安全性和更易读的代码。</p>
<p>同样，类型对象用于表示 NULL 指针。</p>
<h2 id="函数指针">函数指针&nbsp;<a class="headline-hash no-text-decoration" href="#函数指针">#</a> </h2>
<p>C 库可以将指向 C 函数的指针暴露为函数的返回值和结构体的成员，例如 structs 和 unions。</p>
<p>使用定义所需函数参数和返回值的签名调用函数“f”返回的函数指针“$fptr”的示例：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-raku" data-lang="raku"><span class="line"><span class="cl"><span class="k">sub</span> <span class="nb">f</span><span class="p">()</span> <span class="k">returns</span> <span class="kt">Pointer</span> <span class="k">is</span> <span class="k">native</span><span class="p">(&#39;</span><span class="s1">mylib</span><span class="p">&#39;)</span> <span class="p">{</span> <span class="o">*</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">my</span> <span class="nv">$fptr</span>    <span class="o">=</span> <span class="nb">f</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="k">my</span> <span class="nv">$nfptr</span>   <span class="o">=</span> <span class="nb">nativecast</span><span class="p">(</span><span class="o">:</span><span class="p">(</span><span class="kt">Str</span><span class="o">,</span> <span class="kt">size_t</span> <span class="k">--&gt;</span> <span class="kt">int32</span><span class="p">)</span><span class="o">,</span> <span class="nv">$fptr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">say</span> <span class="nv">$nfptr</span><span class="p">(&#34;</span><span class="s2">test</span><span class="p">&#34;</span><span class="o">,</span> <span class="mi">4</span><span class="p">);</span>
</span></span></code></pre></div><h2 id="数组">数组&nbsp;<a class="headline-hash no-text-decoration" href="#数组">#</a> </h2>
<p>NativeCall 对数组有一些支持。 它受限于使用机器大小的整数，双精度和字符串，定型的数字类型，指针数组，结构体数组和数组的数组。</p>
<p>Raku 数组支持懒惰，在内存中以与 C 数组完全不同的方式布局。 因此，NativeCall 库提供了更原始的 CArray 类型，如果使用 C 数组，则必须使用该类型。</p>
<p>这是传递 C 数组的示例。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-raku" data-lang="raku"><span class="line"><span class="cl"><span class="k">sub</span> <span class="nf">RenderBarChart</span><span class="p">(</span><span class="kt">Str</span><span class="o">,</span> <span class="kt">int32</span><span class="o">,</span> <span class="kt">CArray</span><span class="o">[</span><span class="kt">Str</span><span class="o">],</span> <span class="kt">CArray</span><span class="o">[</span><span class="kt">num64</span><span class="o">]</span><span class="p">)</span> <span class="k">is</span> <span class="k">native</span><span class="p">(&#34;</span><span class="s2">chart</span><span class="p">&#34;)</span> <span class="p">{</span> <span class="o">*</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k">my</span> <span class="nv">@titles</span> <span class="o">:=</span> <span class="kt">CArray</span><span class="o">[</span><span class="kt">Str</span><span class="o">].</span><span class="nb">new</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="nv">@titles</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span>  <span class="o">=</span> <span class="p">&#39;</span><span class="s1">Me</span><span class="p">&#39;;</span>
</span></span><span class="line"><span class="cl"><span class="nv">@titles</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span>  <span class="o">=</span> <span class="p">&#39;</span><span class="s1">You</span><span class="p">&#39;;</span>
</span></span><span class="line"><span class="cl"><span class="nv">@titles</span><span class="o">[</span><span class="mi">2</span><span class="o">]</span>  <span class="o">=</span> <span class="p">&#39;</span><span class="s1">Hagrid</span><span class="p">&#39;;</span>
</span></span><span class="line"><span class="cl"><span class="k">my</span> <span class="nv">@values</span> <span class="o">:=</span> <span class="kt">CArray</span><span class="o">[</span><span class="kt">num64</span><span class="o">].</span><span class="nb">new</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="nv">@values</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span>  <span class="o">=</span> <span class="mf">59.5e0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="nv">@values</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span>  <span class="o">=</span> <span class="mf">61.2e0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="nv">@values</span><span class="o">[</span><span class="mi">2</span><span class="o">]</span>  <span class="o">=</span> <span class="mf">180.7e0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="nf">RenderBarChart</span><span class="p">(&#39;</span><span class="s1">Weights (kg)</span><span class="p">&#39;</span><span class="o">,</span> <span class="mi">3</span><span class="o">,</span> <span class="nv">@titles</span><span class="o">,</span> <span class="nv">@values</span><span class="p">);</span>
</span></span></code></pre></div><p>注意我们对 <code>@titles</code> 使用了绑定，而不是赋值，如果你使用赋值，则会把值放进 Raku 数组，然后它就不会工作了。如果这令你抓狂，忘记你所知道的关于 <code>@</code> 符号的事情，使用 NativeCall 的时候直接使用 <code>$</code> 吧。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-raku" data-lang="raku"><span class="line"><span class="cl"><span class="k">use</span> <span class="kt">NativeCall</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">my</span> <span class="nv">$titles</span> <span class="o">=</span> <span class="kt">CArray</span><span class="o">[</span><span class="kt">Str</span><span class="o">].</span><span class="nb">new</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="nv">$titles</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span> <span class="o">=</span> <span class="p">&#39;</span><span class="s1">Me</span><span class="p">&#39;;</span>
</span></span><span class="line"><span class="cl"><span class="nv">$titles</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span> <span class="o">=</span> <span class="p">&#39;</span><span class="s1">You</span><span class="p">&#39;;</span>
</span></span><span class="line"><span class="cl"><span class="nv">$titles</span><span class="o">[</span><span class="mi">2</span><span class="o">]</span> <span class="o">=</span> <span class="p">&#39;</span><span class="s1">Hagrid</span><span class="p">&#39;;</span>
</span></span></code></pre></div><p>获取数组的返回值也是一样的。</p>
<p>某些库 API 可能会将数组作为缓冲区，将由 C 函数填充，例如，返回填充的实际项数：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-raku" data-lang="raku"><span class="line"><span class="cl"><span class="k">use</span> <span class="kt">NativeCall</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">sub</span> <span class="nf">get_n_ints</span><span class="p">(</span><span class="kt">CArray</span><span class="o">[</span><span class="kt">int32</span><span class="o">],</span> <span class="kt">int32</span><span class="p">)</span> <span class="k">returns</span> <span class="kt">int32</span> <span class="k">is</span> <span class="k">native</span><span class="p">(&#39;</span><span class="s1">ints</span><span class="p">&#39;)</span> <span class="p">{</span> <span class="o">*</span> <span class="p">}</span>
</span></span></code></pre></div><p>在这些情况下，重要的是 CArray 在将其传递给原生子例程之前至少具有要填充的元素的数量，否则 C 函数可能会遍历 Perl 的内存，从而可能导致不可预测的行为：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-raku" data-lang="raku"><span class="line"><span class="cl"><span class="k">my</span> <span class="nv">$number_of_ints</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">my</span> <span class="nv">$ints</span> <span class="o">=</span> <span class="kt">CArray</span><span class="o">[</span><span class="kt">int32</span><span class="o">].</span><span class="nb">allocate</span><span class="p">(</span><span class="nv">$number_of_ints</span><span class="p">);</span> <span class="c1"># instantiates an array with 10 elements </span>
</span></span><span class="line"><span class="cl"><span class="k">my</span> <span class="nv">$n</span> <span class="o">=</span> <span class="nf">get_n_ints</span><span class="p">(</span><span class="nv">$ints</span><span class="o">,</span> <span class="nv">$number_of_ints</span><span class="p">);</span>
</span></span></code></pre></div><blockquote>
<p>注意：<code>allocate</code> 是在 Rakudo 2018.05 中引入的。 在此之前，你必须使用此机制将数组扩展为许多元素：</p>
</blockquote>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-raku" data-lang="raku"><span class="line"><span class="cl"><span class="k">my</span> <span class="nv">$ints</span> <span class="o">=</span> <span class="kt">CArray</span><span class="o">[</span><span class="kt">int32</span><span class="o">].</span><span class="nb">new</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">my</span> <span class="nv">$number_of_ints</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="nv">$ints</span><span class="o">[</span><span class="nv">$number_of_ints</span> <span class="o">-</span> <span class="mi">1</span><span class="o">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="c1"># extend the array to 10 items </span>
</span></span></code></pre></div><p>数组的内存管理很重要。 当你自己创建一个数组时，可以根据需要为其添加元素，并根据需要为你进行扩展。 但是，这可能会导致元素在内存中移动（但是，对现有元素的赋值永远不会导致这种情况）。 这意味着如果在将数组传递给 C 库之后将数组旋转，你最好知道自己在做什么。</p>
<p>相比之下，当 C 库向你返回一个数组时，内存不能由 NativeCall 管理，并且它不知道数组的结束位置。 据推测，库 API 中的某些东西告诉你这一点（例如，你知道当你看到一个 null 元素时，你应该不再读取）。 请注意，NativeCall 在这里无法为您提供任何保护 - 一旦做错了，你将遇到 segfault 错误或导致内存损坏。 这不是 NativeCall 的缺点，它是原生世界的工作方式。害怕吗？ 还在这里，拥抱一下。 祝好运！</p>
<h2 id="carray-方法">CArray 方法&nbsp;<a class="headline-hash no-text-decoration" href="#carray-方法">#</a> </h2>
<p>除了每个 Raku 实例上可用的常用方法之外，CArray 还提供了以下方法，可以从 Raku 的角度与它进行交互：</p>
<ul>
<li>
<p><code>elems</code> 提供数组中的元素数量;</p>
</li>
<li>
<p><code>AT-POS</code> 在给定位置提供特定元素（从零开始）;</p>
</li>
<li>
<p><code>list</code> 提供了从原生数组迭代器构建它的数组中的元素<a href="https://docs.raku.org/type/List">列表</a>。</p>
</li>
</ul>
<p>例如，请考虑以下简单的代码：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-raku" data-lang="raku"><span class="line"><span class="cl"><span class="k">use</span> <span class="kt">NativeCall</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="k">my</span> <span class="nv">$native-array</span> <span class="o">=</span> <span class="kt">CArray</span><span class="o">[</span><span class="kt">int32</span><span class="o">].</span><span class="nb">new</span><span class="p">(</span> <span class="mi">1</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="mi">3</span><span class="o">,</span> <span class="mi">4</span><span class="o">,</span> <span class="mi">5</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nb">say</span> <span class="p">&#39;</span><span class="s1">Number of elements: </span><span class="p">&#39;</span> <span class="o">~</span> <span class="nv">$native-array</span><span class="o">.</span><span class="nb">elems</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="c1"># walk the array </span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="nv">$native-array</span><span class="o">.</span><span class="nb">list</span> <span class="k">-&gt;</span> <span class="nv">$elem</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nb">say</span> <span class="p">&#34;</span><span class="s2">Current element is: </span><span class="nv">$elem</span><span class="p">&#34;;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="c1"># get every element by its index-based position </span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="mi">0</span><span class="o">..</span><span class="nv">$native-array</span><span class="o">.</span><span class="nb">elems</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">-&gt;</span> <span class="nv">$position</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nb">say</span> <span class="p">&#34;</span><span class="s2">Element at position </span><span class="nv">$position</span><span class="s2"> is </span><span class="p">&#34;</span>
</span></span><span class="line"><span class="cl">          <span class="o">~</span> <span class="nv">$native-array</span><span class="o">.</span><span class="nb">AT-POS</span><span class="p">(</span> <span class="nv">$position</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>产生以下输出：</p>
<pre tabindex="0"><code>Number of elements: 5
Current element is: 1
Current element is: 2
Current element is: 3
Current element is: 4
Current element is: 5
Element at position 0 is 1
Element at position 1 is 2
Element at position 2 is 3
Element at position 3 is 4
Element at position 4 is 5
</code></pre><h2 id="结构体">结构体&nbsp;<a class="headline-hash no-text-decoration" href="#结构体">#</a> </h2>
<p>由于表示多态性，可以声明一个看起来很正常的 Raku 类，实际上，C 编译器将它们放置在类似的结构体定义中以相同的方式存储其属性。 所需要的只是快速使用“repr” trait：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-raku" data-lang="raku"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Point</span> <span class="k">is</span> <span class="k">repr</span><span class="p">(&#39;</span><span class="s1">CStruct</span><span class="p">&#39;)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">has</span> <span class="kt">num64</span> <span class="nv">$.x</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">has</span> <span class="kt">num64</span> <span class="nv">$.y</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>声明的属性只能是 NativeCall 已知的可以转换成结构体字段的类型，目前，结构体中可以包含机器大小的整数，doubles，strings 以及其它 NativeCall 对象（CArrays，还有 CPointer 以及 CStruct reprs）。除此之外，你可以做一些跟类一样的常用的设置，你甚至可以让某些属性来自于角色或者从其它的类继承。当然，方法也完全没有问题，疯狂!</p>
<p>CStruct 对象以引用的形式传递到原生函数，并且原生函数必须返回 CStruct 对象的引用，对于这些引用的内存管理规则跟数组的内存管理规则很像，尽管更简单，因为结构体的大小是不变的。当你创建一个结构体，内存也一并为你分配好，当指向 CStruct 实例的变量的生命期结束，GC 会负责释放内存。当基于 CStruct 的类型作为原生函数的返回类型时，GC 并不帮你管理它的内存。</p>
<p>NativeCall 目前并不把对象成员放到容器里面，所以不能对对象进行赋（使用 =）新值。 相反，你必须将新值绑定到私有成员上：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-raku" data-lang="raku"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">MyStruct</span> <span class="k">is</span> <span class="k">repr</span><span class="p">(&#39;</span><span class="s1">CStruct</span><span class="p">&#39;)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">has</span> <span class="kt">CArray</span><span class="o">[</span><span class="kt">num64</span><span class="o">]</span> <span class="nv">$!arr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">has</span> <span class="kt">Str</span> <span class="nv">$!str</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">has</span> <span class="n">Point</span> <span class="nv">$!point</span><span class="p">;</span> <span class="c1"># Point is a user-defined class </span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">    <span class="k">submethod</span> <span class="nb">TWEAK</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">my</span> <span class="nv">$arr</span> <span class="o">:=</span> <span class="kt">CArray</span><span class="o">[</span><span class="kt">num64</span><span class="o">].</span><span class="nb">new</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$arr</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span> <span class="o">=</span> <span class="mf">0.9e0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$arr</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span> <span class="o">=</span> <span class="mf">0.2e0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$!arr</span> <span class="o">:=</span> <span class="nv">$arr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$!str</span> <span class="o">:=</span> <span class="p">&#39;</span><span class="s1">Raku is fun</span><span class="p">&#39;;</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$!point</span> <span class="o">:=</span> <span class="n">Point</span><span class="o">.</span><span class="nb">new</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>正如你预测的那样，空指针由结构体类型的类型对象表示的。</p>
<h2 id="cunions">CUnions&nbsp;<a class="headline-hash no-text-decoration" href="#cunions">#</a> </h2>
<p>同样地，我们可以声明一个 Raku 类，它的属性拥有和 C 编译器中联合体（<code>union</code>）的相同的内存布局，这可以使用 <code>CUnion</code> 表示：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-raku" data-lang="raku"><span class="line"><span class="cl"><span class="k">use</span> <span class="kt">NativeCall</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">MyUnion</span> <span class="k">is</span> <span class="k">repr</span><span class="p">(&#39;</span><span class="s1">CUnion</span><span class="p">&#39;)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">has</span> <span class="kt">int32</span> <span class="nv">$.flags32</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">has</span> <span class="kt">int64</span> <span class="nv">$.flags64</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="nb">say</span> <span class="nb">nativesizeof</span><span class="p">(</span><span class="n">MyUnion</span><span class="o">.</span><span class="nb">new</span><span class="p">);</span>  <span class="c1"># 8, ie. max(sizeof(MyUnion.flags32), sizeof(MyUnion.flags64)) </span>
</span></span></code></pre></div><h2 id="嵌套的-cstructs-和-cunions">嵌套的 CStructs 和 CUnions&nbsp;<a class="headline-hash no-text-decoration" href="#嵌套的-cstructs-和-cunions">#</a> </h2>
<p>反过来, CStructs 和 CUnions 可以被周围的 CStruct 和 CUnion 引用，或者嵌入到其他的 CStructs 和 CUnions 里面，如果是引用我们则像往常一样使用 <code>has</code> 来声明，如果是嵌入则使用 <code>HAS</code> 代替：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-raku" data-lang="raku"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">MyStruct</span> <span class="k">is</span> <span class="k">repr</span><span class="p">(&#39;</span><span class="s1">CStruct</span><span class="p">&#39;)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">has</span> <span class="n">Point</span> <span class="nv">$.point</span><span class="p">;</span>  <span class="c1"># referenced </span>
</span></span><span class="line"><span class="cl">    <span class="k">has</span> <span class="kt">int32</span> <span class="nv">$.flags</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="nb">say</span> <span class="nb">nativesizeof</span><span class="p">(</span><span class="n">MyStruct</span><span class="o">.</span><span class="nb">new</span><span class="p">);</span>  <span class="c1"># 16, ie. sizeof(struct Point *) + sizeof(int32_t) </span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">MyStruct2</span> <span class="k">is</span> <span class="k">repr</span><span class="p">(&#39;</span><span class="s1">CStruct</span><span class="p">&#39;)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">HAS</span> <span class="n">Point</span> <span class="nv">$.point</span><span class="p">;</span>  <span class="c1"># embedded </span>
</span></span><span class="line"><span class="cl">    <span class="k">has</span> <span class="kt">int32</span> <span class="nv">$.flags</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="nb">say</span> <span class="nb">nativesizeof</span><span class="p">(</span><span class="n">MyStruct2</span><span class="o">.</span><span class="nb">new</span><span class="p">);</span>  <span class="c1"># 24, ie. sizeof(struct Point) + sizeof(int32_t) </span>
</span></span></code></pre></div><h3 id="注意内存管理">注意内存管理&nbsp;<a class="headline-hash no-text-decoration" href="#注意内存管理">#</a> </h3>
<p>分配结构体以用作结构体时，请确保在 C 函数中分配自己的内存。 如果要将结构体传递给需要提前分配的 <code>Str/char*</code> 的C函数，请确保在将结构体传递给函数之前为 <code>Str</code> 类型的变量分配容器。</p>
<h4 id="在你的-raku-代码中">在你的 Raku 代码中&hellip;&nbsp;<a class="headline-hash no-text-decoration" href="#在你的-raku-代码中">#</a> </h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-raku" data-lang="raku"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">AStringAndAnInt</span> <span class="k">is</span> <span class="k">repr</span><span class="p">(&#34;</span><span class="s2">CStruct</span><span class="p">&#34;)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">has</span> <span class="kt">Str</span> <span class="nv">$.a_string</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">has</span> <span class="kt">int32</span> <span class="nv">$.an_int32</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">  <span class="k">sub</span> <span class="nf">init_struct</span><span class="p">(</span><span class="n">AStringAndAnInt</span> <span class="k">is</span> <span class="k">rw</span><span class="o">,</span> <span class="kt">Str</span><span class="o">,</span> <span class="kt">int32</span><span class="p">)</span> <span class="k">is</span> <span class="k">native</span><span class="p">(&#39;</span><span class="s1">simple-struct</span><span class="p">&#39;)</span> <span class="p">{</span> <span class="o">*</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">  <span class="k">submethod</span> <span class="nb">BUILD</span><span class="p">(</span><span class="o">:</span><span class="nv">$a_string</span><span class="o">,</span> <span class="o">:</span><span class="nv">$an_int</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">init_struct</span><span class="p">(</span><span class="nb">self</span><span class="o">,</span> <span class="nv">$a_string</span><span class="o">,</span> <span class="nv">$an_int</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>在此代码中，我们首先设置我们的成员 <code>$.a_string</code> 和 <code>$.an_int32</code>。 之后，我们声明 <code>init_struct()</code> 函数以使 <code>init()</code> 方法包装; 然后从 <code>BUILD</code> 调用此函数以在返回创建的对象之前有效地分配值。</p>
<h4 id="在你的-c-代码中-">在你的 C 代码中 &hellip;&nbsp;<a class="headline-hash no-text-decoration" href="#在你的-c-代码中-">#</a> </h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-raku" data-lang="raku"><span class="line"><span class="cl"><span class="n">typedef</span> <span class="n">struct</span> <span class="n">a_string_and_an_int32_t_</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">char</span> <span class="o">*</span><span class="n">a_string</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">int32_t</span> <span class="n">an_int32</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="n">a_string_and_an_int32_t</span><span class="p">;</span>
</span></span></code></pre></div><p>这是结构体。 注意我们在那里有怎么得到一个 <code>char *</code>。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">init_struct</span><span class="p">(</span><span class="kt">a_string_and_an_int32_t</span> <span class="o">*</span><span class="n">target</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">,</span> <span class="kt">int32_t</span> <span class="n">int32</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">target</span><span class="o">-&gt;</span><span class="n">an_int32</span> <span class="o">=</span> <span class="n">int32</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">target</span><span class="o">-&gt;</span><span class="n">a_string</span> <span class="o">=</span> <span class="nf">strdup</span><span class="p">(</span><span class="n">str</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">  <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>在这个函数中，我们通过按值分配整数并通过引用传递字符串来初始化 C 结构体。 该函数在复制字符串时将 <code>&lt;point * a_string&gt;</code> 指向的内存分配到结构中。 （注意，你还必须管理内存的释放以避免内存泄漏。）</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-raku" data-lang="raku"><span class="line"><span class="cl"><span class="c1"># A long time ago in a galaxy far, far away... </span>
</span></span><span class="line"><span class="cl"><span class="k">my</span> <span class="nv">$foo</span> <span class="o">=</span> <span class="n">AStringAndAnInt</span><span class="o">.</span><span class="nb">new</span><span class="p">(</span><span class="s">a_string</span> <span class="o">=&gt;</span> <span class="p">&#34;</span><span class="s2">str</span><span class="p">&#34;</span><span class="o">,</span> <span class="s">an_int</span> <span class="o">=&gt;</span> <span class="mi">123</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nb">say</span> <span class="p">&#34;</span><span class="s2">foo is </span><span class="p">{</span><span class="nv">$foo</span><span class="o">.</span><span class="nf">a_string</span><span class="p">}</span><span class="s2"> and </span><span class="p">{</span><span class="nv">$foo</span><span class="o">.</span><span class="nf">an_int32</span><span class="p">}&#34;;</span>
</span></span><span class="line"><span class="cl"><span class="c1"># OUTPUT: «foo is str and 123␤» </span>
</span></span></code></pre></div><h2 id="类型指针">类型指针&nbsp;<a class="headline-hash no-text-decoration" href="#类型指针">#</a> </h2>
<p>将 <code>Pointer</code> 作为参数传递时可以类型化你的 <code>Pointer</code>。这不但对原生类型可用，同样适用于 <code>CArray</code> 以及 <code>CStruct</code> 定义类型，NativeCall 将不会显式为他们分配内存，即使在它们身上调用 <code>new</code> 方法也不会。这适用于那种 C 函数返回指针或者 <code>CStruct</code> 中嵌入的指针情况。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-raku" data-lang="raku"><span class="line"><span class="cl"><span class="k">use</span> <span class="kt">NativeCall</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">sub</span> <span class="nf">strdup</span><span class="p">(</span><span class="kt">Str</span> <span class="nv">$s</span> <span class="k">--&gt;</span> <span class="kt">Pointer</span><span class="o">[</span><span class="kt">Str</span><span class="o">]</span><span class="p">)</span> <span class="k">is</span> <span class="k">native</span> <span class="p">{</span><span class="o">*</span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k">my</span> <span class="kt">Pointer</span><span class="o">[</span><span class="kt">Str</span><span class="o">]</span> <span class="nv">$p</span> <span class="o">=</span> <span class="nf">strdup</span><span class="p">(&#34;</span><span class="s2">Success!</span><span class="p">&#34;);</span>
</span></span><span class="line"><span class="cl"><span class="nb">say</span> <span class="nv">$p</span><span class="o">.</span><span class="nf">deref</span><span class="p">;</span>
</span></span></code></pre></div><p>原生函数返回指向元素的数组的指针是很常见的。 可以将类型化指针解引用为数组以获取单个元素。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-raku" data-lang="raku"><span class="line"><span class="cl"><span class="k">my</span> <span class="nv">$n</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="c1"># returns a pointer to an array of length $n </span>
</span></span><span class="line"><span class="cl"><span class="k">my</span> <span class="kt">Pointer</span><span class="o">[</span><span class="n">Point</span><span class="o">]</span> <span class="nv">$plot</span> <span class="o">=</span> <span class="nf">some_other_c_routine</span><span class="p">(</span><span class="nv">$n</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="c1"># display the 5 elements in the array </span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="mi">1</span> <span class="o">..</span> <span class="nv">$n</span> <span class="k">-&gt;</span> <span class="nv">$i</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">my</span> <span class="nv">$x</span> <span class="o">=</span> <span class="nv">$plot</span><span class="o">[</span><span class="nv">$i</span> <span class="o">-</span> <span class="mi">1</span><span class="o">].</span><span class="nb">x</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">my</span> <span class="nv">$y</span> <span class="o">=</span> <span class="nv">$plot</span><span class="o">[</span><span class="nv">$i</span> <span class="o">-</span> <span class="mi">1</span><span class="o">].</span><span class="nf">y</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nb">say</span> <span class="p">&#34;</span><span class="nv">$i:</span><span class="s2"> (</span><span class="nv">$x</span><span class="s2">, </span><span class="nv">$y</span><span class="s2">)</span><span class="p">&#34;;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>指针也可以更新以引用数组中的连续元素：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-raku" data-lang="raku"><span class="line"><span class="cl"><span class="k">my</span> <span class="kt">Pointer</span><span class="o">[</span><span class="n">Point</span><span class="o">]</span> <span class="nv">$elem</span> <span class="o">=</span> <span class="nv">$plot</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="c1"># show differences between successive points </span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="mi">1</span> <span class="o">..^</span> <span class="nv">$n</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">my</span> <span class="n">Point</span> <span class="nv">$lo</span> <span class="o">=</span> <span class="nv">$elem</span><span class="o">.</span><span class="nf">deref</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">++</span><span class="nv">$elem</span><span class="p">;</span> <span class="c1"># equivalent to $elem = $elem.add(1); </span>
</span></span><span class="line"><span class="cl">    <span class="k">my</span> <span class="n">Point</span> <span class="nv">$hi</span> <span class="o">=</span> <span class="p">(</span><span class="o">++</span><span class="nv">$elem</span><span class="p">)</span><span class="o">.</span><span class="nf">deref</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">my</span> <span class="nv">$dx</span> <span class="o">=</span> <span class="nv">$hi</span><span class="o">.</span><span class="nb">x</span> <span class="o">=</span> <span class="nv">$lo</span><span class="o">.</span><span class="nb">x</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">my</span> <span class="nv">$dy</span> <span class="o">=</span> <span class="nv">$hi</span><span class="o">.</span><span class="nf">y</span> <span class="o">=</span> <span class="nv">$lo</span><span class="o">.</span><span class="nf">y</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nb">say</span> <span class="p">&#34;</span><span class="nv">$_:</span><span class="s2"> delta (</span><span class="nv">$dx</span><span class="s2">, </span><span class="nv">$dy</span><span class="s2">)</span><span class="p">&#34;;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>通过声明 <code>Pointer[void]</code> 也可以使用 Void 指针。 有关该主题的更多信息，请参阅<a href="https://docs.raku.org/language/nativetypes#The_void_type">原生类型文档</a>。</p>
<h2 id="字符串">字符串&nbsp;<a class="headline-hash no-text-decoration" href="#字符串">#</a> </h2>
<h3 id="显式内存管理">显式内存管理&nbsp;<a class="headline-hash no-text-decoration" href="#显式内存管理">#</a> </h3>
<h3 id="buffers-and-blobs">Buffers and Blobs&nbsp;<a class="headline-hash no-text-decoration" href="#buffers-and-blobs">#</a> </h3>
<h2 id="函数参数">函数参数&nbsp;<a class="headline-hash no-text-decoration" href="#函数参数">#</a> </h2>
<p>NativeCall 也支持把函数作为原生函数的参数，一个常用的情况就是事件驱动模型中，使用函数指针作为回调。当通过 NativeCall 绑定了这些函数，只需要提供对等的 signature 作为函数参数的约束。</p>
<h1 id="void-setcallbackint-callbackchar-const-">void SetCallBack(int (*callback)(char const *))</h1>
<p>my sub SetCallBack(&amp;callback(Str &ndash;&gt; int32)) is native(&lsquo;mylib&rsquo;) { * }
注意：原生代码负责传递给 Raku 回调的值的内存管理，换句话说，NativeCall 将不会释放传递给回调的字符串占用的内存。</p>
<h2 id="库路径以及名字">库路径以及名字&nbsp;<a class="headline-hash no-text-decoration" href="#库路径以及名字">#</a> </h2>
<p>native trait 接受库的名字或者全路径：</p>
<p>constant LIBMYSQL = &lsquo;mysqlclient&rsquo;;
constant LIBFOO = &lsquo;/usr/lib/libfoo.so.1&rsquo;;</p>
<p>sub mysql_affectied_rows( .. ) returns int32 is native(LIBMYSQL);
sub bar is native(LIBFOO);
你也可以使用相对路径比如&rsquo;./foo&rsquo;，NativeCall 将会自动根据不同的平台添加对应的扩展名。
注意：native trait 和 constant 都是在编译期求值的，constant类型的变量不要依赖动态变量，比如：</p>
<p>constant LIBMYSQL = %*ENV&lt;P6LIB_MYSQLCLIENT&gt; || &lsquo;mysqlclient&rsquo;;
这将在编译期保持给定的值，在一个模块预编译时，LIBMYSQL将会始终保持那个值。</p>
<h3 id="abiapi版本">ABI/API版本&nbsp;<a class="headline-hash no-text-decoration" href="#abiapi版本">#</a> </h3>
<p>假设你写的原生库为native(&lsquo;foo&rsquo;)， 在类Unix系统下，NativeCall 将会搜索&rsquo;libfoo.so&rsquo;（对于OS X是libfoo.dynlib，win32是foo.dll）。在大多数的现代系统上，将会需要你或者模块的使用者安装开发环境包，因为它们总是建议支持动态库的API/ABI的版本控制，所以&rsquo;libfoo.so&rsquo;大多数是一个符号链接，并且只被开发包提供。</p>
<p>sub foo is native(&lsquo;foo&rsquo;, v1);         # 将会查找并加载 libfoo.so.1
sub foo is native(&lsquo;foo&rsquo;, v1.2.3);    # 将会查找并加载 libfoo.so.1.2.3</p>
<p>my List $lib = (&lsquo;foo&rsquo;, &lsquo;v1&rsquo;);
sub foo is native($lib);</p>
<h3 id="例程">例程&nbsp;<a class="headline-hash no-text-decoration" href="#例程">#</a> </h3>
<p>native trait 也可以接受一个Callable作为参数，允许你使用自己的方式指定将会被加载的库文件：</p>
<p>sub foo is native(sub { &rsquo;libfoo.so.42&rsquo; } );
这个函数只会在第一个调用者访问的时候调用。</p>
<h3 id="调用标准库">调用标准库&nbsp;<a class="headline-hash no-text-decoration" href="#调用标准库">#</a> </h3>
<p>如果你想调用一个已经被加载的，或者是标准库或者来自你自己的程序的 C 函数，你可以将 Str 类型对象作为参数传递给is native，这将会是is native(Str)。
比如说，在类UNIX操作系统下，你可以使用下面的代码打印当前用户的home目录：</p>
<p>use NativeCall;
my class PwStruct is repr(&lsquo;CStruct&rsquo;) {
has Str $.pw_name;
has Str $.pw_passwd;
has uint32 $.pw_uid;
has uint32 $.pw_gid;
has Str $.pw_gecos;
has Str $.pw_dir;
has Str $.pw_shell;
}</p>
<p>sub getuid()                returns uint32         is native(Str) { * }
sub getpwuid(uint32 $uid)    returns PwStruct     is native(Str) { * }</p>
<p>say getpwuid(getuid());
不过，使用$*HOME更方便一些 :-)</p>
<h2 id="导出的变量">导出的变量&nbsp;<a class="headline-hash no-text-decoration" href="#导出的变量">#</a> </h2>
<p>一个库导出的变量 &ndash; 也被叫做“全局（global）”或者 “外部（extern）”变量 &ndash; 可以使用cglobal访问。比如：</p>
<p>my $var := cglobal(&rsquo;libc.so.6&rsquo;, &rsquo;error&rsquo;, int32);
这将会为$var绑定一个新的Proxy对象，并且将对它的访问重定向到被“libc.so.6”导出的叫做errno的整数变量。</p>
<h2 id="对c的支持">对C++的支持&nbsp;<a class="headline-hash no-text-decoration" href="#对c的支持">#</a> </h2>
<p>NativeCall 也支持使用来自 c++ 的类以及方法，就像这个例子展示的那样（还有相关的 c++ 文件），注意现阶段还不像 C 一样支持测试和开发。</p>
<h2 id="helper-函数">Helper 函数&nbsp;<a class="headline-hash no-text-decoration" href="#helper-函数">#</a> </h2>
<h3 id="sub-nativecast">sub nativecast&nbsp;<a class="headline-hash no-text-decoration" href="#sub-nativecast">#</a> </h3>
<h3 id="sub-cglobal">sub cglobal&nbsp;<a class="headline-hash no-text-decoration" href="#sub-cglobal">#</a> </h3>
<h3 id="sub-nativesizeof">sub nativesizeof&nbsp;<a class="headline-hash no-text-decoration" href="#sub-nativesizeof">#</a> </h3>
<h3 id="sub-explicitly-manage">sub explicitly-manage&nbsp;<a class="headline-hash no-text-decoration" href="#sub-explicitly-manage">#</a> </h3>
<h2 id="例子">例子&nbsp;<a class="headline-hash no-text-decoration" href="#例子">#</a> </h2>
<p>一些具体示例，以及在特定平台上使用上述示例的说明。</p>
<h3 id="postgresql">PostgreSQL&nbsp;<a class="headline-hash no-text-decoration" href="#postgresql">#</a> </h3>
<p><a href="https://github.com/raku/DBIish/blob/master/examples/pg.p6">DBIish</a> 中的 PostgreSQL 示例使用 NativeCall 库，并且<code>原生使用</code> Windows 中的原生 <code>_putenv</code> 函数调用。</p>
<h3 id="mysql">MySQL&nbsp;<a class="headline-hash no-text-decoration" href="#mysql">#</a> </h3>
<p>注意：请记住，自 Stretch 版本以来，Debian 已经将 MySQL 替换为 MariaDB，因此如果要安装 MySQL，请使用 <a href="https://dev.mysql.com/downloads/repo/apt/">MySQL APT 存储库</a>而不是默认存储库。</p>
<p>要在 <a href="https://github.com/raku/DBIish/blob/master/examples/mysql.p6">DBIish</a> 中使用 MySQL 示例，您需要在本地安装 MySQL 服务器; 在Debian-esque 系统上，它可以安装如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">wget https://dev.mysql.com/get/mysql-apt-config_0.8.10-1_all.deb
</span></span><span class="line"><span class="cl">sudo dpkg -i mysql-apt-config_0.8.10-1_all.deb <span class="c1"># Don&#39;t forget to select 5.6.x </span>
</span></span><span class="line"><span class="cl">sudo apt-get update
</span></span><span class="line"><span class="cl">sudo apt-get install mysql-community-server -y
</span></span><span class="line"><span class="cl">sudo apt-get install libmysqlclient18 -y
</span></span></code></pre></div><p>在尝试示例之前，请按照这些方法准备系统：</p>
<pre tabindex="0"><code>$ mysql -u root -p
SET PASSWORD = PASSWORD(&#39;sa&#39;);
DROP DATABASE test;
CREATE DATABASE test;
</code></pre><h3 id="microsoft-windows">Microsoft Windows&nbsp;<a class="headline-hash no-text-decoration" href="#microsoft-windows">#</a> </h3>
<p>这是一个 Windows API 调用的例子：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-raku" data-lang="raku"><span class="line"><span class="cl"><span class="k">use</span> <span class="kt">NativeCall</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="k">sub</span> <span class="nf">MessageBoxA</span><span class="p">(</span><span class="kt">int32</span><span class="o">,</span> <span class="kt">Str</span><span class="o">,</span> <span class="kt">Str</span><span class="o">,</span> <span class="kt">int32</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">returns</span> <span class="kt">int32</span>
</span></span><span class="line"><span class="cl">    <span class="k">is</span> <span class="k">native</span><span class="p">(&#39;</span><span class="s1">user32</span><span class="p">&#39;)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span> <span class="o">*</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="nf">MessageBoxA</span><span class="p">(</span><span class="mi">0</span><span class="o">,</span> <span class="p">&#34;</span><span class="s2">We have NativeCall</span><span class="p">&#34;</span><span class="o">,</span> <span class="p">&#34;</span><span class="s2">ohai</span><span class="p">&#34;</span><span class="o">,</span> <span class="mi">64</span><span class="p">);</span>
</span></span></code></pre></div><h3 id="关于调用-c-函数的简明指南">关于调用 C 函数的简明指南&nbsp;<a class="headline-hash no-text-decoration" href="#关于调用-c-函数的简明指南">#</a> </h3>
<p>这是一个调用标准函数并在 Raku 程序中使用返回信息的示例。</p>
<p><code>getaddrinfo</code> 是 POSIX 标准函数，用于获取有关网络节点的网络信息，例如 <code>google.com</code>。 这是一个有趣的功能，因为它说明了 NativeCall 的许多元素。</p>
<p>Linux 手册提供了有关 C 可调用函数的以下信息：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">getaddrinfo</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">node</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">service</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">       <span class="k">const</span> <span class="k">struct</span> <span class="n">addrinfo</span> <span class="o">*</span><span class="n">hints</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">       <span class="k">struct</span> <span class="n">addrinfo</span> <span class="o">**</span><span class="n">res</span><span class="p">);</span>
</span></span></code></pre></div><p>该函数返回响应码 0 = 错误，1 = 成功。 数据是从 <code>addrinfo</code> 元素的链表中提取的，第一个元素由 <code>res</code> 指向。</p>
<p>从 NativeCall 类型表我们知道 <code>int</code> 是 <code>int32</code>。 我们也知道 <code>char *</code> 是 C <code>Str</code> 的形式 C 之一，它简单地映射到 Str。 但是 <code>addrinfo</code> 是一个结构体，这意味着我们需要编写自己的 Type 类。 但是，函数声明很简单：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-raku" data-lang="raku"><span class="line"><span class="cl"><span class="k">sub</span> <span class="nf">getaddrinfo</span><span class="p">(</span> <span class="kt">Str</span> <span class="nv">$node</span><span class="o">,</span> <span class="kt">Str</span> <span class="nv">$service</span><span class="o">,</span> <span class="n">Addrinfo</span> <span class="nv">$hints</span><span class="o">,</span> <span class="kt">Pointer</span> <span class="nv">$res</span> <span class="k">is</span> <span class="k">rw</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">returns</span> <span class="kt">int32</span>
</span></span><span class="line"><span class="cl">    <span class="k">is</span> <span class="k">native</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span> <span class="o">*</span> <span class="p">}</span>
</span></span></code></pre></div><p>请注意，<code>$res</code> 将由函数写入，因此必须将其标记为 <code>rw</code>。 由于库是标准 POSIX，因此库名称可以是 Type 定义或 null。</p>
<p>我们现在必须处理结构体 <code>Addrinfo</code>。 Linux 手册提供了以下信息：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">struct</span> <span class="n">addrinfo</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">               <span class="kt">int</span>              <span class="n">ai_flags</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">               <span class="kt">int</span>              <span class="n">ai_family</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">               <span class="kt">int</span>              <span class="n">ai_socktype</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">               <span class="kt">int</span>              <span class="n">ai_protocol</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">               <span class="kt">socklen_t</span>        <span class="n">ai_addrlen</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">               <span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">ai_addr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">               <span class="kt">char</span>            <span class="o">*</span><span class="n">ai_canonname</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">               <span class="k">struct</span> <span class="n">addrinfo</span> <span class="o">*</span><span class="n">ai_next</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">           <span class="p">};</span>
</span></span></code></pre></div><p><code>int</code>，<code>char *</code> 部分很简单。 一些研究表明 <code>socklen_t</code> 可以依赖于架构，但是是一个至少32位的无符号整数。 所以 <code>socklen_t</code> 可以映射到 <code>uint32</code> 类型。</p>
<p>复杂的是 <code>sockaddr</code>，它取决于 <code>ai_socktype</code> 是否是未定义的，INET 还是 INET6（标准的v4 IP 地址或 v6 地址）。</p>
<p>所以我们创建一个 Raku 类来映射到 C <code>struct addrinfo</code>; 当我们在它的时候，我们还为 <code>SockAddr</code> 创建了另一个类。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-raku" data-lang="raku"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">SockAddr</span> <span class="k">is</span> <span class="k">repr</span><span class="p">(&#39;</span><span class="s1">CStruct</span><span class="p">&#39;)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">has</span> <span class="kt">int32</span>    <span class="nv">$.sa_family</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">has</span> <span class="kt">Str</span>      <span class="nv">$.sa_data</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Addrinfo</span> <span class="k">is</span> <span class="k">repr</span><span class="p">(&#39;</span><span class="s1">CStruct</span><span class="p">&#39;)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">has</span> <span class="kt">int32</span>     <span class="nv">$.ai_flags</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">has</span> <span class="kt">int32</span>     <span class="nv">$.ai_family</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">has</span> <span class="kt">int32</span>     <span class="nv">$.ai_socktype</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">has</span> <span class="kt">int32</span>     <span class="nv">$.ai_protocol</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">has</span> <span class="kt">int32</span>     <span class="nv">$.ai_addrlen</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">has</span> <span class="n">SockAddr</span>  <span class="nv">$.ai_addr</span>       <span class="k">is</span> <span class="k">rw</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">has</span> <span class="kt">Str</span>       <span class="nv">$.ai_cannonname</span> <span class="k">is</span> <span class="k">rw</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">has</span> <span class="n">Addrinfo</span>  <span class="nv">$.ai_next</span>       <span class="k">is</span> <span class="k">rw</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>最后三个属性的 <code>is rw</code> 反映了这些在 C 中被定义为指针。</p>
<p>映射到 C <code>Struct</code> 的重要一点是类的状态部分的结构，即属性。 但是，类可以有方法，而 <code>NativeCall</code> 不会“触摸”它们以映射到C.这意味着我们可以向类添加额外的方法以更易读的方式解包属性，例如，</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-raku" data-lang="raku"><span class="line"><span class="cl"><span class="k">method</span> <span class="nf">flags</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nb">do</span> <span class="k">for</span> <span class="n">AddrInfo-Flags</span><span class="o">.</span><span class="nb">enums</span> <span class="p">{</span> <span class="o">.</span><span class="nb">key</span> <span class="k">if</span> <span class="nv">$!ai_flags</span> <span class="o">+&amp;</span> <span class="o">.</span><span class="nb">value</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>通过定义适当的 <code>enum</code>，<code>flags</code> 将返回一串键而不是一个打包的整数。</p>
<p><code>sockaddr</code> 结构中最有用的信息是节点的地址，它取决于 Socket 的族。 因此，我们可以将方法地址添加到 Raku 类中，该类根据族来解释地址。</p>
<p>为了获得人类可读的 IP 地址，有一个 C 函数 <code>inet_ntop</code>，它给出一个带有 <code>addrinfo</code> 的缓冲区的 <code>char *</code>。</p>
<p>将所有这些组合在一起会产生以下程序：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-raku" data-lang="raku"><span class="line"><span class="cl"><span class="ch">#!/usr/bin/env raku </span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="k">use</span> <span class="k">v</span><span class="mi">6</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">use</span> <span class="kt">NativeCall</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="k">constant</span> <span class="nv">\INET_ADDRSTRLEN</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">constant</span> <span class="nv">\INET6_ADDRSTRLEN</span> <span class="o">=</span> <span class="mi">46</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="k">enum</span> <span class="n">AddrInfo-Family</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="s">AF_UNSPEC</span>                   <span class="o">=&gt;</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="s">AF_INET</span>                     <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="s">AF_INET6</span>                    <span class="o">=&gt;</span> <span class="mi">10</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">);</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="k">enum</span> <span class="n">AddrInfo-Socktype</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="s">SOCK_STREAM</span>                 <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="s">SOCK_DGRAM</span>                  <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="s">SOCK_RAW</span>                    <span class="o">=&gt;</span> <span class="mi">3</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="s">SOCK_RDM</span>                    <span class="o">=&gt;</span> <span class="mi">4</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="s">SOCK_SEQPACKET</span>              <span class="o">=&gt;</span> <span class="mi">5</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="s">SOCK_DCCP</span>                   <span class="o">=&gt;</span> <span class="mi">6</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="s">SOCK_PACKET</span>                 <span class="o">=&gt;</span> <span class="mi">10</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">);</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="k">enum</span> <span class="n">AddrInfo-Flags</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="s">AI_PASSIVE</span>                  <span class="o">=&gt;</span> <span class="mh">0x0001</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="s">AI_CANONNAME</span>                <span class="o">=&gt;</span> <span class="mh">0x0002</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="s">AI_NUMERICHOST</span>              <span class="o">=&gt;</span> <span class="mh">0x0004</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="s">AI_V4MAPPED</span>                 <span class="o">=&gt;</span> <span class="mh">0x0008</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="s">AI_ALL</span>                      <span class="o">=&gt;</span> <span class="mh">0x0010</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="s">AI_ADDRCONFIG</span>               <span class="o">=&gt;</span> <span class="mh">0x0020</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="s">AI_IDN</span>                      <span class="o">=&gt;</span> <span class="mh">0x0040</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="s">AI_CANONIDN</span>                 <span class="o">=&gt;</span> <span class="mh">0x0080</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="s">AI_IDN_ALLOW_UNASSIGNED</span>     <span class="o">=&gt;</span> <span class="mh">0x0100</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="s">AI_IDN_USE_STD3_ASCII_RULES</span> <span class="o">=&gt;</span> <span class="mh">0x0200</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="s">AI_NUMERICSERV</span>              <span class="o">=&gt;</span> <span class="mh">0x0400</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">);</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="k">sub</span> <span class="nf">inet_ntop</span><span class="p">(</span><span class="kt">int32</span><span class="o">,</span> <span class="kt">Pointer</span><span class="o">,</span> <span class="kt">Blob</span><span class="o">,</span> <span class="kt">int32</span> <span class="k">--&gt;</span> <span class="kt">Str</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">is</span> <span class="k">native</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">SockAddr</span> <span class="k">is</span> <span class="k">repr</span><span class="p">(&#39;</span><span class="s1">CStruct</span><span class="p">&#39;)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">has</span> <span class="kt">uint16</span> <span class="nv">$.sa_family</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">SockAddr-in</span> <span class="k">is</span> <span class="k">repr</span><span class="p">(&#39;</span><span class="s1">CStruct</span><span class="p">&#39;)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">has</span> <span class="kt">int16</span> <span class="nv">$.sin_family</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">has</span> <span class="kt">uint16</span> <span class="nv">$.sin_port</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">has</span> <span class="kt">uint32</span> <span class="nv">$.sin_addr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">    <span class="k">method</span> <span class="nf">address</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">my</span> <span class="nv">$buf</span> <span class="o">=</span> <span class="n">buf8</span><span class="o">.</span><span class="nb">allocate</span><span class="p">(</span><span class="n">INET_ADDRSTRLEN</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">inet_ntop</span><span class="p">(</span><span class="n">AF_INET</span><span class="o">,</span> <span class="kt">Pointer</span><span class="o">.</span><span class="nb">new</span><span class="p">(</span><span class="nb">nativecast</span><span class="p">(</span><span class="kt">Pointer</span><span class="o">,</span><span class="nb">self</span><span class="p">)</span><span class="o">+</span><span class="mi">4</span><span class="p">)</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$buf</span><span class="o">,</span> <span class="n">INET_ADDRSTRLEN</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">SockAddr-in6</span> <span class="k">is</span> <span class="k">repr</span><span class="p">(&#39;</span><span class="s1">CStruct</span><span class="p">&#39;)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">has</span> <span class="kt">uint16</span> <span class="nv">$.sin6_family</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">has</span> <span class="kt">uint16</span> <span class="nv">$.sin6_port</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">has</span> <span class="kt">uint32</span> <span class="nv">$.sin6_flowinfo</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">has</span> <span class="kt">uint64</span> <span class="nv">$.sin6_addr0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">has</span> <span class="kt">uint64</span> <span class="nv">$.sin6_addr1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">has</span> <span class="kt">uint32</span> <span class="nv">$.sin6_scope_id</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">    <span class="k">method</span> <span class="nf">address</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">my</span> <span class="nv">$buf</span> <span class="o">=</span> <span class="n">buf8</span><span class="o">.</span><span class="nb">allocate</span><span class="p">(</span><span class="n">INET6_ADDRSTRLEN</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">inet_ntop</span><span class="p">(</span><span class="n">AF_INET6</span><span class="o">,</span> <span class="kt">Pointer</span><span class="o">.</span><span class="nb">new</span><span class="p">(</span><span class="nb">nativecast</span><span class="p">(</span><span class="kt">Pointer</span><span class="o">,</span><span class="nb">self</span><span class="p">)</span><span class="o">+</span><span class="mi">8</span><span class="p">)</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$buf</span><span class="o">,</span> <span class="n">INET6_ADDRSTRLEN</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Addrinfo</span> <span class="k">is</span> <span class="k">repr</span><span class="p">(&#39;</span><span class="s1">CStruct</span><span class="p">&#39;)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">has</span> <span class="kt">int32</span> <span class="nv">$.ai_flags</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">has</span> <span class="kt">int32</span> <span class="nv">$.ai_family</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">has</span> <span class="kt">int32</span> <span class="nv">$.ai_socktype</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">has</span> <span class="kt">int32</span> <span class="nv">$.ai_protocol</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">has</span> <span class="kt">uint32</span> <span class="nv">$.ai_addrNativeCalllen</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">has</span> <span class="n">SockAddr</span> <span class="nv">$.ai_addr</span> <span class="k">is</span> <span class="k">rw</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">has</span> <span class="kt">Str</span> <span class="nv">$.ai_cannonname</span> <span class="k">is</span> <span class="k">rw</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">has</span> <span class="n">Addrinfo</span> <span class="nv">$.ai_next</span> <span class="k">is</span> <span class="k">rw</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">    <span class="k">method</span> <span class="nf">flags</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nb">do</span> <span class="k">for</span> <span class="n">AddrInfo-Flags</span><span class="o">.</span><span class="nb">enums</span> <span class="p">{</span> <span class="o">.</span><span class="nb">key</span> <span class="k">if</span> <span class="nv">$!ai_flags</span> <span class="o">+&amp;</span> <span class="o">.</span><span class="nb">value</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">    <span class="k">method</span> <span class="nf">family</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">AddrInfo-Family</span><span class="p">(</span><span class="nv">$!ai_family</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">    <span class="k">method</span> <span class="nf">socktype</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">AddrInfo-Socktype</span><span class="p">(</span><span class="nv">$!ai_socktype</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">    <span class="k">method</span> <span class="nf">address</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">given</span> <span class="nv">$.family</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">when</span> <span class="n">AF_INET</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nb">nativecast</span><span class="p">(</span><span class="n">SockAddr-in</span><span class="o">,</span> <span class="nv">$!ai_addr</span><span class="p">)</span><span class="o">.</span><span class="nf">address</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">when</span> <span class="n">AF_INET6</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nb">nativecast</span><span class="p">(</span><span class="n">SockAddr-in6</span><span class="o">,</span> <span class="nv">$!ai_addr</span><span class="p">)</span><span class="o">.</span><span class="nf">address</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="k">sub</span> <span class="nf">getaddrinfo</span><span class="p">(</span><span class="kt">Str</span> <span class="nv">$node</span><span class="o">,</span> <span class="kt">Str</span> <span class="nv">$service</span><span class="o">,</span> <span class="n">Addrinfo</span> <span class="nv">$hints</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                <span class="kt">Pointer</span> <span class="nv">$res</span> <span class="k">is</span> <span class="k">rw</span> <span class="k">--&gt;</span> <span class="kt">int32</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">is</span> <span class="k">native</span> <span class="p">{};</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="k">sub</span> <span class="nf">freeaddrinfo</span><span class="p">(</span><span class="kt">Pointer</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">is</span> <span class="k">native</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="k">sub</span> <span class="nb">MAIN</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">my</span> <span class="n">Addrinfo</span> <span class="nv">$hint</span> <span class="o">.=</span> <span class="nb">new</span><span class="p">(:</span><span class="s">ai_flags</span><span class="p">(</span><span class="n">AI_CANONNAME</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="k">my</span> <span class="kt">Pointer</span> <span class="nv">$res</span> <span class="o">.=</span> <span class="nb">new</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">my</span> <span class="nv">$rv</span> <span class="o">=</span> <span class="nf">getaddrinfo</span><span class="p">(&#34;</span><span class="s2">google.com</span><span class="p">&#34;</span><span class="o">,</span> <span class="kt">Str</span><span class="o">,</span> <span class="nv">$hint</span><span class="o">,</span> <span class="nv">$res</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nb">say</span> <span class="p">&#34;</span><span class="s2">return val: </span><span class="nv">$rv</span><span class="p">&#34;;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="nv">$rv</span> <span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">my</span> <span class="nv">$addr</span> <span class="o">=</span> <span class="nb">nativecast</span><span class="p">(</span><span class="n">Addrinfo</span><span class="o">,</span> <span class="nv">$res</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">while</span> <span class="nv">$addr</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">with</span> <span class="nv">$addr</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nb">say</span> <span class="p">&#34;</span><span class="s2">Name: </span><span class="p">&#34;</span><span class="o">,</span> <span class="nv">$_</span> <span class="k">with</span> <span class="o">.</span><span class="nf">ai_cannonname</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="nb">say</span> <span class="o">.</span><span class="nf">family</span><span class="o">,</span> <span class="p">&#39;</span><span class="s1"> </span><span class="p">&#39;</span><span class="o">,</span> <span class="o">.</span><span class="nf">socktype</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="nb">say</span> <span class="o">.</span><span class="nf">address</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="nv">$addr</span> <span class="o">=</span> <span class="o">.</span><span class="nf">ai_next</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">freeaddrinfo</span><span class="p">(</span><span class="nv">$res</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>这产生如下输出:</p>
<pre tabindex="0"><code>return val: 0
Name: google.com
AF_INET SOCK_STREAM
216.58.219.206
AF_INET SOCK_DGRAM
216.58.219.206
AF_INET SOCK_RAW
216.58.219.206
AF_INET6 SOCK_STREAM
2607:f8b0:4006:800::200e
AF_INET6 SOCK_DGRAM
2607:f8b0:4006:800::200e
AF_INET6 SOCK_RAW
2607:f8b0:4006:800::200e
</code></pre>

        </div>
    </div>
</article>



                <footer>
                    




<div class="no-text-decoration">
    <div class="jump top"><a href="#" title="Top of this page">⮉</a></div>
    <div class="jump bottom"><a href="#bottom" title="Bottom of this page">⮋</a></div>
</div>


 
    
        <div class="hugotoc no-text-decoration">
            <nav id="TableOfContents">
  <ul>
    <li><a href="#入门指南">入门指南</a></li>
    <li><a href="#改变名字">改变名字</a></li>
    <li><a href="#传递值和返回值">传递值和返回值</a></li>
    <li><a href="#指定原生表示">指定原生表示</a></li>
    <li><a href="#指针的基本使用">指针的基本使用</a></li>
    <li><a href="#函数指针">函数指针</a></li>
    <li><a href="#数组">数组</a></li>
    <li><a href="#carray-方法">CArray 方法</a></li>
    <li><a href="#结构体">结构体</a></li>
    <li><a href="#cunions">CUnions</a></li>
    <li><a href="#嵌套的-cstructs-和-cunions">嵌套的 CStructs 和 CUnions</a>
      <ul>
        <li><a href="#注意内存管理">注意内存管理</a></li>
      </ul>
    </li>
    <li><a href="#类型指针">类型指针</a></li>
    <li><a href="#字符串">字符串</a>
      <ul>
        <li><a href="#显式内存管理">显式内存管理</a></li>
        <li><a href="#buffers-and-blobs">Buffers and Blobs</a></li>
      </ul>
    </li>
    <li><a href="#函数参数">函数参数</a></li>
  </ul>

  <ul>
    <li><a href="#库路径以及名字">库路径以及名字</a>
      <ul>
        <li><a href="#abiapi版本">ABI/API版本</a></li>
        <li><a href="#例程">例程</a></li>
        <li><a href="#调用标准库">调用标准库</a></li>
      </ul>
    </li>
    <li><a href="#导出的变量">导出的变量</a></li>
    <li><a href="#对c的支持">对C++的支持</a></li>
    <li><a href="#helper-函数">Helper 函数</a>
      <ul>
        <li><a href="#sub-nativecast">sub nativecast</a></li>
        <li><a href="#sub-cglobal">sub cglobal</a></li>
        <li><a href="#sub-nativesizeof">sub nativesizeof</a></li>
        <li><a href="#sub-explicitly-manage">sub explicitly-manage</a></li>
      </ul>
    </li>
    <li><a href="#例子">例子</a>
      <ul>
        <li><a href="#postgresql">PostgreSQL</a></li>
        <li><a href="#mysql">MySQL</a></li>
        <li><a href="#microsoft-windows">Microsoft Windows</a></li>
        <li><a href="#关于调用-c-函数的简明指南">关于调用 C 函数的简明指南</a></li>
      </ul>
    </li>
  </ul>
</nav>
            <a href="#" class="back-to-top">Back to top</a>
        </div>
    
    
<script src="/js/libs/jquery/3.3.1/jquery.slim.min.min.22ee3db0c0e99fd0fbce3aee19672bd53d25469daf734bd4c165649f6eaf7d7f.js"></script>

<link rel="preload" href="/js/libs/jquery/3.3.1/jquery.slim.min.min.22ee3db0c0e99fd0fbce3aee19672bd53d25469daf734bd4c165649f6eaf7d7f.js" as="script">

<script type="application/javascript">(function() {
     var $window = $(window);
     if ($window.width() >= 1400) { 
         var $toc = $('#TableOfContents');
         if ($toc.length > 0) {
             function onScroll(){
                 var currentScroll = $window.scrollTop();
                 var h = $('.content h1, .content h2, .content h3, .content h4, .content h5, .content h6, .h-feed h2');
                 var id = "";
                 h.each(function (i, e) {
                     e = $(e);
                     if (e.offset().top - 10 <= currentScroll) {
                         id = e.attr('id');
                     }
                 });
                 var current = $toc.find('a.current');
                 if (current.length == 1 && current.eq(0).attr('href') == '#' + id) return true;

                 current.each(function (i, e) {
                     $(e).removeClass('current').siblings('ul').hide();
                 });
                 $toc.find('a[href="#' + id + '"]').parentsUntil('#TableOfContents').each(function (i, e) {
                     $(e).children('a').addClass('current').siblings('ul').show();
                 });
             }
             $window.on('scroll', onScroll);
             $(document).ready(function() {
                 $toc.find('a').parent('li').find('ul').hide();
                 onScroll();
                 document.getElementsByClassName('hugotoc')[0].style.display = '';
             });}}})();</script>








<div class="backtotop center no-text-decoration">
    <a href="#">back to <span class="top">top</span></a>
</div>


<div class="right">
    <div class="taxo no-text-decoration">
         
            
                <ul class="no-bullets inline categories">
                    
                        
                        
                        
                            
                            
                            
                            
                            
                            <li class="__rakulang__"
                                
                                
                                title="See all 0 posts categorized in ‘rakulang’"
                                
                            >
                                <a class="p-category" href="http://localhost:1313/categories/rakulang/">rakulang</a>
                            </li>
                        
                    
                </ul>
            
         
            
                <ul class="no-bullets inline tags">
                    
                        
                        
                        
                            
                            
                            
                            
                            
                            <li class="__rakulang__"
                                
                                
                                title="See all 0 posts tagged with ‘rakulang’"
                                
                            >
                                <a class="p-category" href="http://localhost:1313/tags/rakulang/">rakulang</a>
                            </li>
                        
                    
                </ul>
            
        
    </div>

</div>
<div class="clear-float"></div>



<div class="prev-next-navigator clear-float">
    
        <span class="prev-post left no-text-decoration">
            <a href="http://localhost:1313/notes/nim/" class="nobr">« Nim</a>
        </span>
    
    
        <span class="next-post right no-text-decoration">
            <a href="http://localhost:1313/notes/codewars/" class="nobr">codewars »</a>
        </span>
    
</div>


<a id="bottom"></a>









                       







                    <ul class="no-bullets feed right inline">
    
        
        
    
</ul>
<div class="clear-float"></div>

                </footer>
                <hr />
            </div>               

            <footer> 
                

<ul class="social no-text-decoration">
    
</ul>










 
    
    



<p class="generated no-text-decoration">
    Generated using  <a href="https://gitlab.com/kaushalmodi/hugo-theme-refined"><code class="nobr">hugo-theme-refined</code></a> + <span class="nobr">Hugo <a href="https://github.com/gohugoio/hugo/commit/312735366b20d64bd61bff8627f593749f86c964">0.123.7</a></span>
</p>

<p>
    
</p>




<div class="badges no-text-decoration">
    
    

    
</div>




<script type="application/javascript">var nav=responsiveNav("#nav");</script>




<script defer src="/js/libs/fragmentions/wrapper.min.e8c468c89edc4f5dccaa8c720c6b220b3088a16cd7b1e4a1e3345985788260c9.js"></script>









            </footer>
        </div> 
    </body>
</html>
