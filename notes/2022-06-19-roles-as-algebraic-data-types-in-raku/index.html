<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-us" lang="en-us">

    <head>
    <link href="https://gmpg.org/xfn/11" rel="profile">
    <meta charset="utf-8">
    
    
    

    
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5">

    
    <meta name="referrer" content="no-referrer">

    <title>
        
            Roles as Algebraic Data Types in Raku ❚ 焉知非鱼
        
    </title>

    
    


    
    
    
    

    
    
    
    

    
    
    

    
    
    
    <style>
     
     
     :root {
         --theme-color: #ac4142;
         --theme-color-light: rgba(172, 65, 66, 0.2);
     }
     
     html {
         line-height: 1.5;
     }
    </style>

    
    

    
    
    
    
    <link rel="stylesheet" href="/css/refined.min.7f6d3ee611034e4ebcbc063f1db3bc042fecdc8901afbedad80ff02bae409204.css">
    
    <link rel="preload" href="/css/refined.min.7f6d3ee611034e4ebcbc063f1db3bc042fecdc8901afbedad80ff02bae409204.css" as="style">

    



    
        <style>
         
         /* Background */ .chroma { background-color: #ffffff }
/* Error */ .chroma .err { color: #a61717; background-color: #e3d2d2 }
/* LineTableTD */ .chroma .lntd { vertical-align: top; padding: 0; margin: 0; border: 0; }
/* LineTable */ .chroma .lntable { border-spacing: 0; padding: 0; margin: 0; border: 0; width: auto; overflow: auto; display: block; }
/* LineHighlight */ .chroma .hl { display: block; width: 100%;background-color: #ffffcc }
/* LineNumbersTable */ .chroma .lnt { margin-right: 0.4em; padding: 0 0.4em 0 0.4em; }
/* LineNumbers */ .chroma .ln { margin-right: 0.4em; padding: 0 0.4em 0 0.4em; }
/* Keyword */ .chroma .k { color: #000000; font-weight: bold }
/* KeywordConstant */ .chroma .kc { color: #000000; font-weight: bold }
/* KeywordDeclaration */ .chroma .kd { color: #000000; font-weight: bold }
/* KeywordNamespace */ .chroma .kn { color: #000000; font-weight: bold }
/* KeywordPseudo */ .chroma .kp { color: #000000; font-weight: bold }
/* KeywordReserved */ .chroma .kr { color: #000000; font-weight: bold }
/* KeywordType */ .chroma .kt { color: #445588; font-weight: bold }
/* NameAttribute */ .chroma .na { color: #008080 }
/* NameBuiltin */ .chroma .nb { color: #0086b3 }
/* NameBuiltinPseudo */ .chroma .bp { color: #999999 }
/* NameClass */ .chroma .nc { color: #445588; font-weight: bold }
/* NameConstant */ .chroma .no { color: #008080 }
/* NameDecorator */ .chroma .nd { color: #3c5d5d; font-weight: bold }
/* NameEntity */ .chroma .ni { color: #800080 }
/* NameException */ .chroma .ne { color: #990000; font-weight: bold }
/* NameFunction */ .chroma .nf { color: #990000; font-weight: bold }
/* NameLabel */ .chroma .nl { color: #990000; font-weight: bold }
/* NameNamespace */ .chroma .nn { color: #555555 }
/* NameTag */ .chroma .nt { color: #000080 }
/* NameVariable */ .chroma .nv { color: #008080 }
/* NameVariableClass */ .chroma .vc { color: #008080 }
/* NameVariableGlobal */ .chroma .vg { color: #008080 }
/* NameVariableInstance */ .chroma .vi { color: #008080 }
/* LiteralString */ .chroma .s { color: #dd1144 }
/* LiteralStringAffix */ .chroma .sa { color: #dd1144 }
/* LiteralStringBacktick */ .chroma .sb { color: #dd1144 }
/* LiteralStringChar */ .chroma .sc { color: #dd1144 }
/* LiteralStringDelimiter */ .chroma .dl { color: #dd1144 }
/* LiteralStringDoc */ .chroma .sd { color: #dd1144 }
/* LiteralStringDouble */ .chroma .s2 { color: #dd1144 }
/* LiteralStringEscape */ .chroma .se { color: #dd1144 }
/* LiteralStringHeredoc */ .chroma .sh { color: #dd1144 }
/* LiteralStringInterpol */ .chroma .si { color: #dd1144 }
/* LiteralStringOther */ .chroma .sx { color: #dd1144 }
/* LiteralStringRegex */ .chroma .sr { color: #009926 }
/* LiteralStringSingle */ .chroma .s1 { color: #dd1144 }
/* LiteralStringSymbol */ .chroma .ss { color: #990073 }
/* LiteralNumber */ .chroma .m { color: #009999 }
/* LiteralNumberBin */ .chroma .mb { color: #009999 }
/* LiteralNumberFloat */ .chroma .mf { color: #009999 }
/* LiteralNumberHex */ .chroma .mh { color: #009999 }
/* LiteralNumberInteger */ .chroma .mi { color: #009999 }
/* LiteralNumberIntegerLong */ .chroma .il { color: #009999 }
/* LiteralNumberOct */ .chroma .mo { color: #009999 }
/* Operator */ .chroma .o { color: #000000; font-weight: bold }
/* OperatorWord */ .chroma .ow { color: #000000; font-weight: bold }
/* Comment */ .chroma .c { color: #999988; font-style: italic }
/* CommentHashbang */ .chroma .ch { color: #999988; font-style: italic }
/* CommentMultiline */ .chroma .cm { color: #999988; font-style: italic }
/* CommentSingle */ .chroma .c1 { color: #999988; font-style: italic }
/* CommentSpecial */ .chroma .cs { color: #999999; font-weight: bold; font-style: italic }
/* CommentPreproc */ .chroma .cp { color: #999999; font-weight: bold; font-style: italic }
/* CommentPreprocFile */ .chroma .cpf { color: #999999; font-weight: bold; font-style: italic }
/* GenericDeleted */ .chroma .gd { color: #000000; background-color: #ffdddd }
/* GenericEmph */ .chroma .ge { color: #000000; font-style: italic }
/* GenericError */ .chroma .gr { color: #aa0000 }
/* GenericHeading */ .chroma .gh { color: #999999 }
/* GenericInserted */ .chroma .gi { color: #000000; background-color: #ddffdd }
/* GenericOutput */ .chroma .go { color: #888888 }
/* GenericPrompt */ .chroma .gp { color: #555555 }
/* GenericStrong */ .chroma .gs { font-weight: bold }
/* GenericSubheading */ .chroma .gu { color: #aaaaaa }
/* GenericTraceback */ .chroma .gt { color: #aa0000 }
/* GenericUnderline */ .chroma .gl { text-decoration: underline }
/* TextWhitespace */ .chroma .w { color: #bbbbbb }

         
         /* Overrides on top of the theme and Chroma CSS */
/* Chroma-based lines highlighting in code blocks */
.chroma .hl {
    background-color: #e8e8e8;
    /* Extend highlight up to 100 characters (assuming that the code blocks never have more than 100 characters in a line) */
    min-width: 100ch;
}
/* GenericHeading */ .chroma .gh { color: #999999; font-weight: bold }
/* GenericSubheading */ .chroma .gu { color: #aaaaaa; font-weight: bold }

         
        </style>
    

    

    
    
    

    
    <script src="/js/responsive-nav-orig.min.e2b5f2a956b488f466da513820636134defdc38b90ed566248960593f2bb4ba5.js"></script>
    
    <link rel="preload" href="/js/responsive-nav-orig.min.e2b5f2a956b488f466da513820636134defdc38b90ed566248960593f2bb4ba5.js" as="script">

    
    
    <script defer src="/js/libs/fa/fontawesome-all.min.08916ac0fd078adfb58edc890460e2c8990729aee02bca7586404b56805f5219.js"></script>
    
    <link rel="preload" href="/js/libs/fa/fontawesome-all.min.08916ac0fd078adfb58edc890460e2c8990729aee02bca7586404b56805f5219.js" as="script">

    

    

    
    
    

    
    
<!-- rel="me" links for IndieAuth -->







    
 
<meta property="og:title" content="Roles as Algebraic Data Types in Raku" />
<meta property="og:description"
      content="Roles as Algebraic Data Types in Raku" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://ohmycloud.github.io/notes/2022-06-19-roles-as-algebraic-data-types-in-raku/" />


    
        <meta property="article:published_time" content="2022-06-19T00:00:00&#43;00:00"/>
    
    
        <meta property="article:modified_time" content="2022-06-19T00:00:00&#43;00:00"/>
    









    




     <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Roles as Algebraic Data Types in Raku"/>
<meta name="twitter:description" content="Roles as Algebraic Data Types in Raku"/>


    
    
    <link rel="alternate" type="application/jf2post+json" href="https://ohmycloud.github.io/notes/2022-06-19-roles-as-algebraic-data-types-in-raku/jf2post.json" title="Jf2post for 焉知非鱼" />
    
     



    
    
    
        
    


     
        
        <meta name="DC.Creator" content="焉知非鱼"/>
    



    
    
    
    <meta name="hugo-build-date" content="2024-03-01T16:16:06Z"/>
    <meta name="hugo-commit-hash" content="312735366b20d64bd61bff8627f593749f86c964"/>
    <meta name="generator" content="Hugo 0.123.7">
</head>


    
        <body lang="en">
    

        
        <div class="border" id="home"></div>

        <div class="wrapper">   
            
<nav id="nav" class="nav-collapse opened" aria-hidden="false">
    <ul class="navbar">
        <li><a class="" href="/">Home</a></li>
        
            
                <li><a class="" href="https://ohmycloud.github.io/posts/">Posts</a></li>
            
        
            
                <li><a class="" href="https://ohmycloud.github.io/notes/">Notes</a></li>
            
        
        
            <li><a class="" href="https://ohmycloud.github.io/search/">Search</a></li>
        
    </ul>
</nav>

            <div class="container">
                <header class="masthead">
                    <div class="masthead-title no-text-decoration">
                        <a href="/">焉知非鱼</a> <span class="blinking-cursor">❚</span>
                    </div>
                    <div class="masthead-tagline">
                        Wait the light to fall
                    </div>
                </header>

                








<article class="post h-entry notes">
    <header>
        <div class="center">
    <div class="taxo no-text-decoration">
         
            
                <ul class="no-bullets inline categories">
                    
                        
                        
                        
                            
                            
                            
                            
                            
                            <li class="__rakulang__"
                                
                                
                                title="See all 0 posts categorized in ‘rakulang’"
                                
                            >
                                <a class="p-category" href="https://ohmycloud.github.io/categories/rakulang/">rakulang</a>
                            </li>
                        
                    
                </ul>
            
         
            
                <ul class="no-bullets inline tags">
                    
                        
                        
                        
                            
                            
                            
                            
                            
                            <li class="__rakulang__"
                                
                                
                                title="See all 0 posts tagged with ‘rakulang’"
                                
                            >
                                <a class="p-category" href="https://ohmycloud.github.io/tags/rakulang/">rakulang</a>
                            </li>
                        
                    
                </ul>
            
        
    </div>

</div>

        <h1 class="post-title p-name">Roles as Algebraic Data Types in Raku</h1>

        
        <data class="u-url" value="https://ohmycloud.github.io/notes/2022-06-19-roles-as-algebraic-data-types-in-raku/"></data>

        <div class="date-syndication">
            


    
    
    <div class="post-date">
        
        <time datetime="2022-06-19T00:00:00+0000" class="dt-published">Sun Jun 19, 2022</time>
        
        
    </div>


            




        </div>
         



    
    
    
        
    


    
        
        <span class="hide">
            &mdash; <a href="https://ohmycloud.github.io/" class="u-author">焉知非鱼</a>
        </span>
    


    </header>

    <div class="content">
        
    <div class="description p-summary">
        
        
        
        
        
            
            
        
        <p>Roles as Algebraic Data Types in Raku</p>
    </div>



        





                       


        <div class="e-content">
            




<h1 id="raku-中作为代数数据类型的-role">Raku 中作为代数数据类型的 Role</h1>
<p>我一直是一个 <a href="https://andrewshitov.com/2015/05/05/interview-with-audrey-tang/">lambdacamel</a>，很长时间以来, 我都喜欢 <a href="https://www.perl.org/">Perl</a> 和函数式编程，特别是 <a href="https://www.haskell.org/">Haskell</a>。我仍然用这两种语言中的任何一种写我的大部分代码。</p>
<p>早在 <a href="https://raku.org/">Raku</a> 被称为 Raku 之前，我就已经是它的粉丝了，但我在现实生活中从未使用过它。最近，我越来越倾向于使用 Raku 来编写我不需要与其他人分享的代码。它是一种可爱的语言，而且它的功能遗产非常强大。因此，对我来说，探索 Raku 类型系统的极限是很自然的。</p>
<h2 id="这篇文章适合你吗">这篇文章适合你吗？&nbsp;<a class="headline-hash no-text-decoration" href="#这篇文章适合你吗">#</a> </h2>
<p>在这篇文章中，我将介绍<a href="https://www.cs.kent.ac.uk/people/staff/dat/miranda/nancypaper.pdf">代数数据类型</a>，这是一种在 Haskell 等函数式语言中使用的静态类型系统，也是一种创建复杂数据结构的强大机制。我将展示一种使用 Role 在 Raku 中实现代数数据类型的方法。你根本不需要知道 Haskell，我只假设你知道一点 Raku（我已经添加了<a href="https://wimvanderbauwhede.github.io/articles/roles-as-adts-in-raku/#raku-intro">一个快速介绍</a>），但我确实假设你熟悉基本的编程。如果你对函数式静态类型感到好奇，或者你希望有一个替代面向对象编程的方法，你可能会发现这篇文章很有趣。</p>
<h2 id="代数数据类型">代数数据类型&nbsp;<a class="headline-hash no-text-decoration" href="#代数数据类型">#</a> </h2>
<p>数据类型（简称类型）只是程序中数值的标签或容器。代数数据类型是复合类型，它们是由其他类型组合而成的。它们被称为代数型，因为它们由类型的替代物（sums，也称为不相交的集合）和记录（积）组成。更多细节见 <a href="https://codewords.recurse.com/issues/three/algebra-and-calculus-of-algebraic-data-types">[1]</a> 或 <a href="https://gist.github.com/gregberns/5e9da0c95a9a8d2b6338afe69310b945">[2]</a>。</p>
<p>为了给 &ldquo;Sum 类型&quot;和&quot;Product 类型&quot;这两个术语提供一个粗略的直觉：在 Raku 中，对于布尔值 <code>$a</code>、<code>$b</code> 和 <code>$c</code>，你可以写出 <code>$a or $b or $c</code>，但你也可以写出 <code>$a+$b+$c</code> 并将其评估为 <code>True</code> 或 <code>False</code>。同样，<code>$a and $b and $c</code> 也可以写成 <code>$a * $b * $c</code>。换句话说，<code>and</code> 和 <code>or</code> 的行为与 <code>+</code> 和 <code>*</code> 是一样的。在一般情况下，代数数据类型系统中的类型可以用类似的规则组成。</p>
<h3 id="几个例子">几个例子&nbsp;<a class="headline-hash no-text-decoration" href="#几个例子">#</a> </h3>
<p>首先让我们举几个代数数据类型的例子。在本节中，我没有使用特定的编程语言语法。相反，我使用一个极简的标记法来说明这些概念。我使用 <code>datatype</code> 关键字来表示下面是代数数据类型的声明；对于和类型，我会用 <code>|</code> 来分隔可供选择的值；对于积类型，我会用空格来分隔各部分。为了声明一个变量属于某种类型，我将在它前面写上类型名称。</p>
<p>我们可以将一个布尔值纯粹定义为一个类型:</p>
<pre><code>datatype Bool =  True | False
</code></pre>
<p>而我们可以将此用作:</p>
<pre><code>Bool ok = True
</code></pre>
<p>这意味着 <code>ok</code> 是一个 <code>Bool</code> 类型的变量，其值为 <code>True</code>。在代数数据类型中，标签被称为&quot;构造函数&rdquo;。所以 <code>True</code> 是一个不接收参数的构造函数。</p>
<p>对于积类型，例如，我们可以为 RGB 颜色三联体创建一个类型:</p>
<pre><code>datatype RGBColour = RGB Int Int Int
</code></pre>
<p>右侧的 <code>RGB</code> 标签是该类型的构造函数。它接收三个 <code>Int</code> 类型的参数:</p>
<pre><code>RGBColour aquamarine = RGB 127 255 212
</code></pre>
<p>所以 <code>aquamarine</code> 是一个 <code>RGBColour</code> 类型的变量，值为 <code>RGB 127 255 212</code>。</p>
<p>构造函数鉴定该类型。假设我们也有一个 HSL 颜色类型:</p>
<pre><code>datatype HSLColour = HSL Int Int Int
</code></pre>
<p>和该类型的变量 <code>chocolate</code>:</p>
<pre><code>HSLColour chocolate = HSL 25 75 47
</code></pre>
<p>那么 <code>RGB</code> 和 <code>HSL</code> 都是 <code>Int</code> 的三联体，但由于类型构造函数不同，它们不是同一类型。</p>
<p>比方说，我们创建一个 RGBPixel 类型:</p>
<pre><code>datatype XYCoord = XY Int Int
datatype RGBPixel  = Pixel RGBColour XYCoord
</code></pre>
<p>那么:</p>
<pre><code>RGBPixel p = Pixel aquamarine (XY 42 24)
</code></pre>
<p>没有问题, 但是:</p>
<pre><code>RGBPixel p = Pixel chocolate (XY 42 24)
</code></pre>
<p>将是一个类型错误，因为 <code>chocolate</code> 的类型是 <code>HSLColour</code>，而不是 <code>RGBColour</code>。</p>
<p>我们可以使用和类型(sum type)同时支持 RGB 和 HSL:</p>
<pre><code>datatype Colour = HSL HSLColour | RGB RGBColour
</code></pre>
<p>然后修改 Pixel 类型的定义:</p>
<pre><code>datatype Pixel = Pixel Colour XYCoord
</code></pre>
<p>而现在我们可以说:</p>
<pre><code>Pixel p_rgb = Pixel (RGB aquamarine) (XY 42 24)
Pixel p_hsl = Pixel (HSL chocolate) (XY 42 24)
</code></pre>
<h3 id="整数和字符串递归和多态">整数和字符串、递归和多态&nbsp;<a class="headline-hash no-text-decoration" href="#整数和字符串递归和多态">#</a> </h3>
<p>我可以听到你说：但是 <code>Int</code> 呢，它没有构造函数吗？那么字符串呢，它怎么可能是一个代数数据类型呢？这些问题很有意思，因为它们让我又引入了两个概念：递归和多态类型。</p>
<h4 id="整数类型和递归类型">整数类型和递归类型&nbsp;<a class="headline-hash no-text-decoration" href="#整数类型和递归类型">#</a> </h4>
<p>从类型的角度来看，你可以从两个方面来看待一个整数：如果它是一个固定大小的整数，那么 <code>Int</code> 类型可以被看作是一个和类型(sum type)。例如，一个 8 位无符号整数的类型可以这样标识:</p>
<pre><code>datatype UInt8 = 0 | 1 | 2 | ... | 255
</code></pre>
<p>换句话说，每个数字实际上都是一个类型构造函数的名称，作为 <code>Bool</code> 类型的泛化。</p>
<p>然而，在数学意义上，整数不是有限的。如果我们考虑自然数的情况，我们可以为它们构造一个如下所示的类型：</p>
<pre><code>datatype Nat = Z | S Nat
</code></pre>
<p><code>Z</code> 代表&quot;零&quot;，<code>S</code> 代表&quot;后继者&quot;。这是一个递归类型，因为 <code>S</code> 构造函数接收一个 <code>Nat</code> 作为参数。有了这个类型，我们现在可以创建任何自然数:</p>
<pre><code>Nat 0 = Z
Nat 1 = S Z
Nat 2 = S (S Z)
Nat 3 = S (S (S Z))
...
</code></pre>
<p>这种构建自然数的方式被称为 <a href="https://www.britannica.com/science/Peano-axioms">Peano 数</a>。</p>
<h4 id="字符串的类型和多态类型">字符串的类型和多态类型&nbsp;<a class="headline-hash no-text-decoration" href="#字符串的类型和多态类型">#</a> </h4>
<p>现在，字符串怎么办？枚举所有可能的任何长度的字符串是不现实的。但是从类型的角度来看，字符串是一个字符列表。那么问题来了：列表的类型是什么？首先，列表必须能够包含任意类型的值。(在代数数据类型的背景下，所有的值都必须是相同的，所以我们的列表更像是 Raku 中的类型数组。) 但这意味着我们需要可以被其他类型参数化的类型。这就是所谓的参数化多态性。所以列表类型必须看起来像这样:</p>
<pre><code>datatype List a = ...
</code></pre>
<p>其中 <code>a</code> 是一个类型变量，也就是说，它可以被一个任意的类型所取代。例如，假设我们简单地通过枚举字母表中的所有字符来定义 <code>Char</code> 类型（当然，因为在机器层面，每个字符都由一个整数表示）。</p>
<pre><code>datatype Char = 'a' | 'b' | 'c' | ... | 'z'
</code></pre>
<p>然后我们可以将我们的字符串输入为:</p>
<pre><code>List Char str = ...
</code></pre>
<p>但是 <code>List</code> 呢？我们使用与上面 <code>Nat</code> 类似的方法，使用一个递归和类型(recursive sum type):</p>
<pre><code>datatype List a = EmptyList | Cons a (List a)
</code></pre>
<p>现在我们可以创建一个任意长度的列表:</p>
<pre><code>List Char str = 
     Cons 'h' 
    (Cons 'e' 
    (Cons 'l' 
    (Cons 'l' 
    (Cons 'o' 
    EmptyList))))
</code></pre>
<p>使用标准的列表语法糖，我们可以将其写成:</p>
<pre><code>List Char str = [ 'h', 'e', 'l', 'l', 'o' ]
</code></pre>
<p>如果我现在为 <code>List Char</code> 发明了一个别名 <code>Str</code>，并使用双引号而不是列表标记法，我就可以写成这样:</p>
<pre><code>Str str = &quot;hello&quot;
</code></pre>
<p>因此，整数和字符串可以被表达为代数数据类型，现在我们已经引入了递归和参数化类型。</p>
<h3 id="代数数据类型有什么用">代数数据类型有什么用？&nbsp;<a class="headline-hash no-text-decoration" href="#代数数据类型有什么用">#</a> </h3>
<p>这些例子可能看起来比较生硬，毕竟像 Raku 这样的语言已经有 <code>Int</code> 和 <code>Str</code> 类型了，工作起来非常好。那么这些代数数据类型的用途是什么呢？当然，静态类型的目的是为了提供类型安全，使调试更容易。但是使用代数数据类型也使得不同的、更有函数式的编程风格成为可能。</p>
<p>一个常见的用例是列表，你想存储不同类型的值：你可以创建一个和类型(sum type)，每种类型都有一个可供选择的值。另一个常见的情况是递归类型，如树。最后，多态性提供了一种创建自定义容器的方便方法。我将在下一节中分别举出这些例子。是时候进入 Raku 了!</p>
<h2 id="raku-中的代数数据类型">Raku 中的代数数据类型&nbsp;<a class="headline-hash no-text-decoration" href="#raku-中的代数数据类型">#</a> </h2>
<p>由于 Raku 不是一种非常知名的语言（迄今为止），这里快速介绍一下你需要了解的功能，以便你能跟得上下面的讨论。</p>
<h3 id="对-raku-的快速介绍">对 Raku 的快速介绍&nbsp;<a class="headline-hash no-text-decoration" href="#对-raku-的快速介绍">#</a> </h3>
<p>在 Raku 走自己的路之前，它的目的是成为 Perl 的下一个迭代版本（因此最初的名字是 Perl 6）。因此，它与 Perl 的相似度要高于其他任何语言。</p>
<p>Raku 在语法上类似于 C/C++、Java 和 JavaScript：以块为基础，语句由分号分隔，块由大括号划分，参数列表放在小括号里，参数由逗号分隔。它与 Perl 共享的主要特征是使用符号（&ldquo;有趣的字符&rdquo;）来识别变量的类型：<code>$</code> 代表标量，<code>@</code> 代表数组，<code>%</code> 代表散列（map），<code>&amp;</code> 代表子程序。变量也有关键词来标识其作用域，我会只用 <code>my</code> 来标记变量的词法作用域。子程序是用 <code>sub</code> 关键字声明的，子程序可以是具名的或匿名的:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-raku" data-lang="raku"><span class="line"><span class="cl"><span class="k">sub</span> <span class="nf">square</span> <span class="p">(</span><span class="nv">$x</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$x</span><span class="o">*</span><span class="nv">$x</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># anonymous subroutine </span>
</span></span><span class="line"><span class="cl"><span class="k">my</span> <span class="nv">$anon_square</span> <span class="o">=</span> <span class="k">sub</span> <span class="p">(</span><span class="nv">$x</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$x</span><span class="o">*</span><span class="nv">$x</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>Raku 也有 <a href="https://docs.raku.org/language/variables#index-entry-Twigil">twigils</a>，即影响变量作用域的二级符号。在这篇文章中，代码中使用的唯一符号是 <code>.</code>，它用于声明一个 Role 或类的属性，并自动生成访问器（比如下面例子中的 <code>$.notes</code>）。</p>
<p>Raku 支持无符号变量，并使用 <code>\</code> 语法来声明这些变量。更多关于普通变量和无符号变量的区别，请参见 <a href="https://docs.raku.org/language/variables#Sigilless_variables">Raku 文档</a>。例如（<code>say</code> 打印其参数，后面是换行符）:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-raku" data-lang="raku"><span class="line"><span class="cl"><span class="k">my</span> <span class="nv">\x</span> <span class="o">=</span> <span class="mi">42</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">my</span> <span class="nv">$y</span> <span class="o">=</span> <span class="mi">43</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="nb">say</span> <span class="nb">x</span> <span class="o">+</span> <span class="nv">$y</span><span class="p">;</span> 
</span></span></code></pre></div><p>Raku 有<a href="https://raku.guide/">渐进式类型</a>：它既允许静态类型又允许动态类型。这是一个好的开始，因为我们需要静态类型化来支持代数数据类型。它也有<a href="https://docs.raku.org/language/variables">不可变变量</a>和<a href="https://raku.guide/#_anonymous_functions">匿名函数</a>，甚至还支持（<a href="https://docs.raku.org/language/list#index-entry-laziness_in_Iterable_objects">有限的</a>）<a href="https://docs.raku.org/language/list#index-entry-laziness_in_Iterable_objects">惰性</a>。当然，<a href="https://raku.guide/#_functional_programming">函数也是一等公民</a>，所以我们拥有纯静态类型的函数式编程所需要的一切。但是 Raku 有代数数据类型吗？</p>
<p>在 Raku 中, <code>enum</code> 是和类型(sum type):</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-raku" data-lang="raku"><span class="line"><span class="cl"><span class="k">enum</span> <span class="kt">Bool</span> <span class="p">&lt;</span><span class="s">False True</span><span class="p">&gt;</span>
</span></span></code></pre></div><p>然而，它们仅限于不接收任何参数的类型构造函数。</p>
<p>类可以被看作是积类型(product type):</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-raku" data-lang="raku"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">BoolAndInt</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">has</span> <span class="kt">Bool</span> <span class="nv">$.bool</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">has</span> <span class="kt">Int</span> <span class="nv">$.int</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>然而，类并不支持参数化多态。</p>
<p>这就是 Role 出现的地方。根据 <a href="https://docs.raku.org/language/objects#Roles">Raku 的文档</a>:</p>
<pre><code>Role 是属性和方法的集合；然而，与类不同，Role 只是为了描述一个对象的部分行为；这就是为什么，一般来说，Role 是为了混合在类和对象中。一般来说，类是用来管理对象的，而 Role 是用来管理对象中的行为和代码重用的。
</code></pre>
<p>Role 在被声明的 Role 名称前使用关键字 <code>role</code>。Role 的混合使用 <code>does</code> 关键字，在被混合的 Role 名称前面。Role 在 Python 和 Ruby 中被称为 mixins。</p>
<p>所以 Role 基本上是你可以用来给其他类添加行为的类，而无需使用继承。下面是一个来自 Raku 文档精简后的例子（<code>has</code> 声明一个属性，<code>method</code> 声明一个方法）。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-raku" data-lang="raku"><span class="line"><span class="cl"><span class="k">role</span> <span class="nc">Notable</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">has</span> <span class="nv">$.notes</span> <span class="k">is</span> <span class="k">rw</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">method</span> <span class="nf">notes</span><span class="p">()</span> <span class="p">{</span> <span class="o">...</span> <span class="p">};</span> 
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Journey</span> <span class="k">does</span> <span class="nc">Notable</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">has</span> <span class="nv">$.origin</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">has</span> <span class="nv">$.destination</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">has</span> <span class="nv">@.travelers</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">method</span> <span class="p">{</span> <span class="o">...</span> <span class="p">&lt;</span><span class="s">implemented using notes()</span><span class="p">&gt;</span> <span class="o">...</span> <span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>特别地，Role 可以混入其他 Role，这是我要利用的关键特性之一。此外，Role 构造函数可以接收参数，而且是参数化的。所以我们拥有创建真正的代数数据类型所需的一切。让我们来看看几个例子。</p>
<h3 id="几个简单的例子">几个简单的例子&nbsp;<a class="headline-hash no-text-decoration" href="#几个简单的例子">#</a> </h3>
<h4 id="an-opinionated-boolean">An opinionated Boolean&nbsp;<a class="headline-hash no-text-decoration" href="#an-opinionated-boolean">#</a> </h4>
<p>这是上面的 Boolean 和类型(sum type)的例子，但用 Role 实现。第一行声明该类型是一个空的 Role ，这与左边的数据类型名称相对应。接下来的几行定义了可供选择的值，每个可供选择的值都使用了 <code>does OpinionatedBool</code>，将其与 <code>OpinionatedBool</code> role 联系起来，该 role 的功能纯粹是作为类型名称。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-raku" data-lang="raku"><span class="line"><span class="cl"><span class="k">role</span> <span class="nc">OpinionatedBool</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl"><span class="k">role</span> <span class="nc">AbsolutelyTrue</span> <span class="k">does</span> <span class="nc">OpinionatedBool</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl"><span class="k">role</span> <span class="nc">TotallyFalse</span> <span class="k">does</span> <span class="nc">OpinionatedBool</span> <span class="p">{}</span>
</span></span></code></pre></div><p>在 Raku 中，类型就是值；对于一个具有空主体的 Role，你不需要调用 <code>.new</code> 构造函数。在一个和类型(sum type)中，可供选择的值通常是标记为值的容器，但它们也可以是空容器。在这种情况下，没有必要为它们创建单独的实例，因为只有一种方法可以拥有一个空容器。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-raku" data-lang="raku"><span class="line"><span class="cl"><span class="k">my</span> <span class="n">OpinionatedBool</span> \<span class="n">bt</span> <span class="o">=</span> <span class="n">AbsolutelyTrue</span><span class="p">;</span>
</span></span></code></pre></div><p>和类型(sum type)可以与 Raku 的 <code>multi sub</code> 结合使用。Raku 允许你为一个函数提供多个定义，名称相同但签名不同。有了 <code>multi sub</code>，我们可以在类型上做所谓的模式匹配:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-raku" data-lang="raku"><span class="line"><span class="cl"><span class="k">multi</span> <span class="k">sub</span> <span class="nf">p</span><span class="p">(</span><span class="n">AbsolutelyTrue</span> <span class="nv">$b</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nb">say</span> <span class="p">&#39;</span><span class="s1">True</span><span class="p">&#39;;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k">multi</span> <span class="k">sub</span> <span class="nf">p</span><span class="p">(</span><span class="n">TotallyFalse</span> <span class="nv">$b</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nb">say</span> <span class="p">&#39;</span><span class="s1">False</span><span class="p">&#39;;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Trying it out:</span>
</span></span><span class="line"><span class="cl"><span class="nf">p</span><span class="p">(</span><span class="n">bt</span><span class="p">);</span> <span class="c1"># prints True</span>
</span></span></code></pre></div><p>因为我们使用一个类型作为值，要测试一个值是 <code>AbsolutelyTrue</code> 还是 <code>TotallyFalse</code>，我们可以使用智能匹配 <code>~~</code>，容器（类型）标识 <code>=:=</code> 或者值（实例）标识 <code>===</code> 来测试（如果右边是一个类型，智能匹配操作符的行为就像 <code>=:=</code>，如果是一个对象实例，则像 <code>===</code>）。如果我们要创建一个像 <code>AbsolutelyTrue.new</code> 这样的实例，就不会出现这种情况。更多细节请参见<a href="https://github.com/wimvanderbauwhede/raku-examples/blob/master/roles_types_and_instances.raku">代码示例</a>。</p>
<h4 id="colourxycoord-和-pixel-类型">Colour、XYCoord 和 Pixel 类型&nbsp;<a class="headline-hash no-text-decoration" href="#colourxycoord-和-pixel-类型">#</a> </h4>
<p>下面是上面的 <code>Colour</code>、<code>XYCoord</code> 和 <code>Pixel</code> 类型的实现。<code>RGBColour</code> 类型是一个积类型(product type)的例子。与我上面的标记法有两处不同。</p>
<pre tabindex="0"><code>datatype RGBColour = RGB Int Int Int
</code></pre><pre><code>1. 因为这个 Role 既是类型（`RGBColour`）又是实例构造函数（`RGB`），它们必须有相同的名字。我只是以不同的方式命名它们，使它们更容易区分，所以这不是一个问题。
2. 组成每个字段的类型必须在 Role 的参数列表中用唯一的名字命名，并且需要声明相应的属性。这又不是一个真正的限制，因为记录类型字段的访问器是很方便的。所以它看起来像:
</code></pre>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-raku" data-lang="raku"><span class="line"><span class="cl"><span class="k">role</span> <span class="nc">RGBColour</span><span class="o">[</span><span class="kt">Int</span> \<span class="nb">r</span><span class="o">,</span> <span class="kt">Int</span> \<span class="n">g</span><span class="o">,</span> <span class="kt">Int</span> \<span class="n">b</span><span class="o">]</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">has</span> <span class="kt">Int</span> <span class="nv">$.r</span> <span class="o">=</span> <span class="nb">r</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">has</span> <span class="kt">Int</span> <span class="nv">$.g</span> <span class="o">=</span> <span class="n">g</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">has</span> <span class="kt">Int</span> <span class="nv">$.b</span> <span class="o">=</span> <span class="n">b</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>(Role 的参数在方括号内)</p>
<p>然后我们像这样创建 <code>aquamarine</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-raku" data-lang="raku"><span class="line"><span class="cl"><span class="k">my</span> <span class="n">RGBColour</span> \<span class="n">aquamarine</span> <span class="o">=</span> <span class="n">RGBColour</span><span class="o">[</span> <span class="mi">127</span><span class="o">,</span> <span class="mi">255</span><span class="o">,</span> <span class="mi">212</span><span class="o">].</span><span class="nb">new</span><span class="p">;</span>
</span></span></code></pre></div><p><code>HSLColour</code> 和 <code>XYCoord</code> 的定义是类似的，你可以在<a href="https://github.com/wimvanderbauwhede/raku-examples/blob/master/role_as_adt_colour_example.raku">代码示例</a>中找到它们。让我们来看看结合 RGB 和 HSL 颜色类型的和类型(sum type)。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-raku" data-lang="raku"><span class="line"><span class="cl"><span class="k">role</span> <span class="nc">Colour</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl"><span class="k">role</span> <span class="nc">HSL</span><span class="o">[</span> <span class="n">HSLColour</span> \<span class="n">hsl</span><span class="o">]</span> <span class="k">does</span> <span class="nc">Colour</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">has</span> <span class="n">HSLColour</span> <span class="nv">$.hsl</span> <span class="o">=</span> <span class="n">hsl</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">role</span> <span class="nc">RGB</span><span class="o">[</span> <span class="n">RGBColour</span> \<span class="n">rgb</span><span class="o">]</span> <span class="k">does</span> <span class="nc">Colour</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">has</span> <span class="n">RGBColour</span> <span class="nv">$.rgb</span> <span class="o">=</span> <span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>这与 opinionated Boolean 方法基本相同，但我们没有空 role：<code>HSL</code> 可供选择的值需要一个 <code>HSLColour</code> 类型的参数，而 <code>RGB</code> 可供选择的值需要一个 <code>RGBColour</code> 类型的参数。就像在积类型(product type)中一样，我们使用 role 作为一个容器来保存数值。上面的 <code>Pixel</code> 类型看起来像:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-raku" data-lang="raku"><span class="line"><span class="cl"><span class="k">role</span> <span class="nc">Pixel</span><span class="o">[</span> <span class="n">Colour</span> \<span class="n">c</span><span class="o">,</span> <span class="n">XYCoord</span> \<span class="n">xy</span> <span class="o">]</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">has</span> <span class="n">Colour</span> <span class="nv">$.c</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">has</span> <span class="n">XYCoord</span> <span class="nv">$.xy</span> <span class="o">=</span> <span class="n">xy</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>而现在我们可以用 RGB 和 HSL 颜色创建 <strong>Pixel</strong>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-raku" data-lang="raku"><span class="line"><span class="cl"><span class="k">my</span> <span class="n">Pixel</span> \<span class="n">p_rgb</span> <span class="o">=</span> <span class="n">Pixel</span><span class="o">[</span> <span class="n">RGB</span><span class="o">[</span> <span class="n">aquamarine</span><span class="o">].</span><span class="nb">new</span> <span class="o">,</span> <span class="n">XYCoord</span><span class="o">[</span> <span class="mi">42</span><span class="o">,</span> <span class="mi">24</span><span class="o">].</span><span class="nb">new</span> <span class="o">].</span><span class="nb">new</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">my</span> <span class="n">Pixel</span> \<span class="n">p_hsl</span> <span class="o">=</span> <span class="n">Pixel</span><span class="o">[</span> <span class="n">HSL</span><span class="o">[</span> <span class="n">chocolate</span> <span class="o">].</span><span class="nb">new</span> <span class="o">,</span> <span class="n">XYCoord</span><span class="o">[</span> <span class="mi">42</span><span class="o">,</span> <span class="mi">24</span><span class="o">].</span><span class="nb">new</span> <span class="o">].</span><span class="nb">new</span><span class="p">;</span>
</span></span></code></pre></div><h4 id="递归和多态">递归和多态&nbsp;<a class="headline-hash no-text-decoration" href="#递归和多态">#</a> </h4>
<p>上面，我展示了 Peano 数字类型来说明类型级的递归。这在 Raku 的 role 中也能正常工作。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-raku" data-lang="raku"><span class="line"><span class="cl"><span class="k">role</span> <span class="nc">Nat</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl"><span class="k">role</span> <span class="nc">Z</span> <span class="k">does</span> <span class="nc">Nat</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl"><span class="k">role</span> <span class="k">S</span><span class="p">[</span><span class="sr">Nat </span><span class="nv">$n</span><span class="p">]</span> <span class="k">does</span> <span class="nc">Nat</span> <span class="p">{}</span>
</span></span></code></pre></div><p>而我们可以像在列表的例子中那样，将其与类型参数结合起来。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-raku" data-lang="raku"><span class="line"><span class="cl"><span class="k">role</span> <span class="kt">List</span><span class="o">[:</span><span class="p">:</span><span class="s">a</span><span class="o">]</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl"><span class="k">role</span> <span class="nc">EmptyList</span><span class="o">[:</span><span class="p">:</span><span class="s">a</span><span class="o">]</span> <span class="k">does</span> <span class="kt">List</span><span class="o">[</span><span class="n">a</span><span class="o">]</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl"><span class="k">role</span> <span class="nc">Cons</span><span class="o">[</span> <span class="o">:</span><span class="p">:</span><span class="s">a</span> \<span class="n">elt</span><span class="o">,</span> <span class="kt">List</span> \<span class="n">lst</span> <span class="o">]</span> <span class="k">does</span> <span class="kt">List</span><span class="o">[</span><span class="n">a</span><span class="o">]</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">has</span> <span class="nv">$.elt</span> <span class="o">=</span> <span class="n">elt</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">has</span> <span class="nv">$.lst</span> <span class="o">=</span> <span class="n">lst</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>(前缀 <code>::</code> 是 Raku 的语法，用于声明类型变量)</p>
<p><strong>当前 raku 的问题</strong></p>
<p>这里有一些问题。</p>
<ul>
<li><code>EmptyList</code> 可供选择的值必须像上面那样，用一个类型参数来声明，或者作为:</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-raku" data-lang="raku"><span class="line"><span class="cl"><span class="k">role</span> <span class="nc">EmptyList</span> <span class="k">does</span> <span class="kt">List</span> <span class="p">{}</span>
</span></span></code></pre></div><p>其中的类型也不接收类型变量。我们不能这样写:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-raku" data-lang="raku"><span class="line"><span class="cl"><span class="k">role</span> <span class="nc">EmptyList</span> <span class="k">does</span> <span class="kt">List</span><span class="o">[:</span><span class="p">:</span><span class="s">a</span><span class="o">]</span> <span class="p">{}</span>
</span></span></code></pre></div><p>当然这只是一个小问题，只是导致了一些冗余。</p>
<pre><code>- 一个更严重的问题是，`lst` 的类型必须是 `List`（或 `List[]`），而不是 `List[a]`。这实际上是一个问题，因为它削弱了类型检查的力度。所以这一定是当前版本的 `raku`（2020.01）的一个错误。当我提供 `List[a]` 时，我得到以下错误:

Could not instantiate role 'Cons':
Internal error: inconsistent bind result
in any protect at gen/moar/stage2/NQPCORE.setting line 1216
in block &lt;unit&gt; at list-adt.raku line 12
</code></pre>
<h3 id="几个比较有用的例子">几个比较有用的例子&nbsp;<a class="headline-hash no-text-decoration" href="#几个比较有用的例子">#</a> </h3>
<h4 id="一个-multi-type-数组">一个 multi-type 数组&nbsp;<a class="headline-hash no-text-decoration" href="#一个-multi-type-数组">#</a> </h4>
<p>对于第一个例子，我想在一个类型化的数组中存储不同类型的值。它们的元素可以是字符串，标记的字符串列表，或未定义。我把这个类型称为 <code>Matches</code>。使用上面的标记法，它将是:</p>
<pre tabindex="0"><code>datatype Matches = 
      Match Str 
    | TaggedMatches Str (List Matches) 
    | UndefinedMatch
</code></pre><p>在 Raku 中，它的定义如下:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-raku" data-lang="raku"><span class="line"><span class="cl"><span class="k">role</span> <span class="nc">Matches</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl"><span class="k">role</span> <span class="nc">UndefinedMatch</span> <span class="k">does</span> <span class="nc">Matches</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl"><span class="k">role</span> <span class="kt">Match</span><span class="o">[</span><span class="kt">Str</span> <span class="nv">$str</span><span class="o">]</span> <span class="k">does</span> <span class="nc">Matches</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">has</span> <span class="kt">Str</span> <span class="nv">$.match</span><span class="o">=</span><span class="nv">$str</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k">role</span> <span class="nc">TaggedMatches</span><span class="o">[</span><span class="kt">Str</span> <span class="nv">$tag</span><span class="o">,</span> <span class="n">Matches</span> <span class="nv">@ms</span><span class="o">]</span> <span class="k">does</span> <span class="nc">Matches</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">has</span> <span class="kt">Str</span> <span class="nv">$.tag</span> <span class="o">=</span> <span class="nv">$tag</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">has</span> <span class="n">Matches</span> <span class="nv">@.matches</span> <span class="o">=</span> <span class="nv">@ms</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>这个类型使用的类型构造函数有 0(<code>UndefinedMatch</code>)、1(<code>Match</code>) 和 2(<code>TaggedMatches</code>)参数，后者是一个递归类型：第二个参数是一个 <code>Matches</code> 的列表。有了这个定义，我们可以像这样创建一个匹配数组:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-raku" data-lang="raku"><span class="line"><span class="cl"> <span class="k">my</span> <span class="n">Matches</span> <span class="nv">@ms</span> <span class="o">=</span> <span class="kt">Array</span><span class="o">[</span><span class="n">Matches</span><span class="o">].</span><span class="nb">new</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">     <span class="kt">Match</span><span class="o">[</span><span class="p">&#34;</span><span class="s2">hello</span><span class="p">&#34;</span><span class="o">].</span><span class="nb">new</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">     <span class="n">TaggedMatches</span><span class="o">[</span>
</span></span><span class="line"><span class="cl">         <span class="p">&#34;</span><span class="s2">Adjectives</span><span class="p">&#34;</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">         <span class="kt">Array</span><span class="o">[</span><span class="n">Matches</span><span class="o">].</span><span class="nb">new</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">             <span class="kt">Match</span><span class="o">[</span><span class="p">&#34;</span><span class="s2">brave</span><span class="p">&#34;</span><span class="o">].</span><span class="nb">new</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">             <span class="kt">Match</span><span class="o">[</span><span class="p">&#34;</span><span class="s2">new</span><span class="p">&#34;</span><span class="o">].</span><span class="nb">new</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">             <span class="o">].</span><span class="nb">new</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">     <span class="kt">Match</span><span class="o">[</span><span class="p">&#34;</span><span class="s2">world</span><span class="p">&#34;</span><span class="o">].</span><span class="nb">new</span>
</span></span><span class="line"><span class="cl">     <span class="p">);</span>
</span></span></code></pre></div><p>正如你所看到的，类型化的值实际上是通过调用 <code>.new</code> 来构建的。创建构造函数是比较好的，一旦 Raku 有一个更发达的宏系统，我们也许可以自动生成这些函数。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-raku" data-lang="raku"><span class="line"><span class="cl"><span class="k">my</span> <span class="n">Matches</span> <span class="nv">@ms</span> <span class="o">=</span> <span class="nf">mkMatches</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">mkMatch</span> <span class="p">&#34;</span><span class="s2">hello</span><span class="p">&#34;</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">    <span class="nf">mkTaggedMatches</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="p">&#34;</span><span class="s2">Adjectives</span><span class="p">&#34;</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">        <span class="nf">mkMatches</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">mkMatch</span> <span class="p">&#34;</span><span class="s2">brave</span><span class="p">&#34;</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">mkMatch</span> <span class="p">&#34;</span><span class="s2">new</span><span class="p">&#34;</span> 
</span></span><span class="line"><span class="cl">            <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">mkMatch</span> <span class="p">&#34;</span><span class="s2">world)
</span></span></span><span class="line"><span class="cl"><span class="s2">    );
</span></span></span></code></pre></div><p><a href="https://github.com/wimvanderbauwhede/raku-examples/blob/master/roles_as_types.raku">这个例子的代码</a></p>
<h4 id="一个通用元组">一个通用元组&nbsp;<a class="headline-hash no-text-decoration" href="#一个通用元组">#</a> </h4>
<p>对于下一个例子，我想定义一个叫做 <code>Either</code> 的类型。这是一个有两个参数的参数化和类型(sum type)，所以是一种通用元组:</p>
<pre tabindex="0"><code>datatype Either a b = Left a | Right b
</code></pre><p>在 Raku，这可以通过使用类型变量作为 role 的参数来实现:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-raku" data-lang="raku"><span class="line"><span class="cl"><span class="k">role</span> <span class="nc">Either</span><span class="o">[:</span><span class="p">:</span><span class="s">a</span><span class="o">,</span> <span class="o">:</span><span class="p">:</span><span class="s">b</span><span class="o">]</span> <span class="p">{</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k">role</span> <span class="nc">Left</span><span class="o">[:</span><span class="p">:</span><span class="s">a</span> \<span class="nb">l</span><span class="o">,</span> <span class="o">:</span><span class="p">:</span><span class="s">b</span><span class="o">]</span> <span class="k">does</span> <span class="nc">Either</span><span class="o">[</span><span class="n">a</span><span class="o">,</span><span class="n">b</span><span class="o">]</span> <span class="p">{</span> 
</span></span><span class="line"><span class="cl">    <span class="k">has</span> <span class="n">a</span> <span class="nv">$.left</span> <span class="o">=</span> <span class="nb">l</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k">role</span> <span class="nc">Right</span><span class="o">[:</span><span class="p">:</span><span class="s">a</span><span class="o">,</span> <span class="o">:</span><span class="p">:</span><span class="s">b</span> \<span class="nb">r</span><span class="o">]</span> <span class="k">does</span> <span class="nc">Either</span><span class="o">[</span><span class="n">a</span><span class="o">,</span><span class="n">b</span><span class="o">]</span> <span class="p">{</span> 
</span></span><span class="line"><span class="cl">    <span class="k">has</span> <span class="n">b</span> <span class="nv">$.right</span> <span class="o">=</span> <span class="nb">r</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>因为 Raku 希望两个类型的变量都在每个构造函数中被声明，所以它比我的更抽象的标记法要差一点。我们可以用一个 <code>multi sub</code> 对这个类型进行模式匹配:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-raku" data-lang="raku"><span class="line"><span class="cl"><span class="k">multi</span> <span class="k">sub</span> <span class="nf">test</span> <span class="p">(</span><span class="n">Left</span><span class="o">[</span><span class="kt">Int</span><span class="o">,</span> <span class="kt">Str</span><span class="o">]</span> <span class="nv">$v</span><span class="p">)</span> <span class="p">{</span> <span class="nb">say</span> <span class="p">&#39;</span><span class="s1">Left: </span><span class="p">&#39;</span><span class="o">~</span><span class="nv">$v</span><span class="o">.</span><span class="nf">left</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k">multi</span> <span class="k">sub</span> <span class="nf">test</span> <span class="p">(</span><span class="n">Right</span><span class="o">[</span><span class="kt">Int</span><span class="o">,</span> <span class="kt">Str</span><span class="o">]</span> <span class="nv">$v</span><span class="p">)</span> <span class="p">{</span><span class="nb">say</span> <span class="p">&#39;</span><span class="s1">Right: </span><span class="p">&#39;</span><span class="o">~</span><span class="nv">$v</span><span class="o">.</span><span class="nb">right</span> <span class="p">}</span>
</span></span></code></pre></div><p>所以我们可以写成:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-raku" data-lang="raku"><span class="line"><span class="cl"><span class="k">my</span> <span class="n">Either</span><span class="o">[</span><span class="kt">Int</span><span class="o">,</span> <span class="kt">Str</span><span class="o">]</span> \<span class="n">iv</span> <span class="o">=</span> <span class="n">Left</span><span class="o">[</span><span class="mi">42</span><span class="o">,</span> <span class="kt">Str</span><span class="o">].</span><span class="nb">new</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">my</span> <span class="n">Either</span><span class="o">[</span><span class="kt">Int</span><span class="o">,</span> <span class="kt">Str</span><span class="o">]</span> \<span class="n">sv</span> <span class="o">=</span> <span class="n">Right</span><span class="o">[</span><span class="kt">Int</span><span class="o">,</span> <span class="p">&#39;</span><span class="s1">forty-two</span><span class="p">&#39;</span><span class="o">].</span><span class="nb">new</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">test</span><span class="p">(</span><span class="n">iv</span><span class="p">);</span> <span class="c1"># prints &#39;Left: 42&#39;</span>
</span></span><span class="line"><span class="cl"><span class="nf">test</span><span class="p">(</span><span class="n">sv</span><span class="p">);</span> <span class="c1"># prints &#39;Right: forty-two&#39;</span>
</span></span></code></pre></div><p><a href="https://github.com/wimvanderbauwhede/raku-examples/blob/master/either.raku">这个例子的代码</a></p>
<h4 id="一个参数化的二叉树">一个参数化的二叉树&nbsp;<a class="headline-hash no-text-decoration" href="#一个参数化的二叉树">#</a> </h4>
<p>作为最后一个例子，这里有一个简单的二叉树。首先，让我们看看一个使用 <a href="https://docs.raku.org/language/objects#index-entry-Parameterized_Roles">Raku 文档</a>中的 Role 实现的例子。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-raku" data-lang="raku"><span class="line"><span class="cl"><span class="k">role</span> <span class="nc">BinaryTree</span><span class="o">[:</span><span class="p">:</span><span class="s">Type</span><span class="o">]</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">has</span> <span class="n">BinaryTree</span><span class="o">[</span><span class="n">Type</span><span class="o">]</span> <span class="nv">$.left</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">has</span> <span class="n">BinaryTree</span><span class="o">[</span><span class="n">Type</span><span class="o">]</span> <span class="nv">$.right</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">has</span> <span class="n">Type</span> <span class="nv">$.node</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">method</span> <span class="nf">visit-preorder</span><span class="p">(</span><span class="nv">&amp;cb</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">cb</span> <span class="nv">$.node</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="nv">$.left</span><span class="o">,</span> <span class="nv">$.right</span> <span class="k">-&gt;</span> <span class="nv">$branch</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$branch</span><span class="o">.</span><span class="nf">visit-preorder</span><span class="p">(</span><span class="nv">&amp;cb</span><span class="p">)</span> <span class="k">if</span> <span class="nb">defined</span> <span class="nv">$branch</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">method</span> <span class="nf">visit-postorder</span><span class="p">(</span><span class="nv">&amp;cb</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="nv">$.left</span><span class="o">,</span> <span class="nv">$.right</span> <span class="k">-&gt;</span> <span class="nv">$branch</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$branch</span><span class="o">.</span><span class="nf">visit-postorder</span><span class="p">(</span><span class="nv">&amp;cb</span><span class="p">)</span> <span class="k">if</span> <span class="nb">defined</span> <span class="nv">$branch</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">cb</span> <span class="nv">$.node</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">method</span> <span class="nf">new-from-list</span><span class="p">(</span><span class="vg">::?CLASS:U</span><span class="o">:</span> <span class="o">*</span><span class="nv">@el</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">my</span> <span class="nv">$middle-index</span> <span class="o">=</span> <span class="nv">@el</span><span class="o">.</span><span class="nb">elems</span> <span class="ow">div</span> <span class="mi">2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">my</span> <span class="nv">@left</span>         <span class="o">=</span> <span class="nv">@el</span><span class="o">[</span><span class="mi">0</span> <span class="o">..</span> <span class="nv">$middle-index</span> <span class="o">-</span> <span class="mi">1</span><span class="o">]</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">my</span> <span class="nv">$middle</span>       <span class="o">=</span> <span class="nv">@el</span><span class="o">[</span><span class="nv">$middle-index</span><span class="o">]</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">my</span> <span class="nv">@right</span>        <span class="o">=</span> <span class="nv">@el</span><span class="o">[</span><span class="nv">$middle-index</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">..</span> <span class="o">*]</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nb">self</span><span class="o">.</span><span class="nb">new</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="s">node</span>    <span class="o">=&gt;</span> <span class="nv">$middle</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">            <span class="s">left</span>    <span class="o">=&gt;</span> <span class="nv">@left</span>  <span class="o">??</span> <span class="nb">self</span><span class="o">.</span><span class="nf">new-from-list</span><span class="p">(</span><span class="nv">@left</span><span class="p">)</span>  <span class="o">!!</span> <span class="nb">self</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">            <span class="s">right</span>   <span class="o">=&gt;</span> <span class="nv">@right</span> <span class="o">??</span> <span class="nb">self</span><span class="o">.</span><span class="nf">new-from-list</span><span class="p">(</span><span class="nv">@right</span><span class="p">)</span> <span class="o">!!</span> <span class="nb">self</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">my</span> <span class="nv">$t</span> <span class="o">=</span> <span class="n">BinaryTree</span><span class="o">[</span><span class="kt">Int</span><span class="o">].</span><span class="nf">new-from-list</span><span class="p">(</span><span class="mi">4</span><span class="o">,</span> <span class="mi">5</span><span class="o">,</span> <span class="mi">6</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nv">$t</span><span class="o">.</span><span class="nf">visit-preorder</span><span class="p">(</span><span class="nv">&amp;say</span><span class="p">);</span>    <span class="c1"># OUTPUT: «5␤4␤6␤» </span>
</span></span><span class="line"><span class="cl"><span class="nv">$t</span><span class="o">.</span><span class="nf">visit-postorder</span><span class="p">(</span><span class="nv">&amp;say</span><span class="p">);</span>   <span class="c1"># OUTPUT: «4␤6␤5␤» </span>
</span></span></code></pre></div><p>这个例子包含相当多的 Raku 语法。</p>
<pre><code>- Raku 允许在名字中使用破折号。
- `-&gt;` 语法是一个 foreach 循环，在前面的列表中迭代所有元素。
- `..` 是数组切片。
- `::?CLASS` 是一个编译时类型变量，填充了你所在的类，而 `:U` 是一个类型约束，指定它应该被解释为一个类型对象。最后，`:` 标记其左边的参数为调用者。换句话说，它允许我们写 `BinaryTree[Int].new-from-list(4, 5, 6)`，其中 `BinaryTree[Int]` 是 `:?CLASS` 的值。这就是创建自定义构造函数的 Raku 方式。
- `new-from-list` 的 `@el` 参数前面的 `*` 使其成为一个变量函数(variadic function)，其中 `@el` 包含所有参数。
- `=&gt;` 语法允许按名称而不是按位置分配参数。
- `?? ... !! ...` 是 Raku 对 C 语言的三元组 `? ... : ...` 的语法。
</code></pre>
<p>这个例子是用 Raku 的面向对象风格写的，方法作用于 Role 的属性。让我们看看如何用函数式写这个例子。</p>
<p>这个二叉树的代数数据类型是这样的:</p>
<pre tabindex="0"><code>datatype BinaryTree a = 
      Node (BinaryTree a) (BinaryTree a) a 
    | Tip
</code></pre><p><code>Tip</code> 的可供选择的值是针对树的空叶子节点，在上面的例子中，这些叶子节点没有被定义。在 Raku 中，我们可以将这种类型实现为:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-raku" data-lang="raku"><span class="line"><span class="cl"><span class="k">role</span> <span class="nc">BinaryTree</span><span class="o">[:</span><span class="p">:</span><span class="s">Type</span><span class="o">]</span> <span class="p">{</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k">role</span> <span class="nc">Node</span><span class="o">[:</span><span class="p">:</span><span class="s">Type</span><span class="o">,</span>  \<span class="nb">l</span><span class="o">,</span>  \<span class="nb">r</span><span class="o">,</span> \<span class="n">n</span><span class="o">]</span> <span class="k">does</span> <span class="nc">BinaryTree</span><span class="o">[</span><span class="n">Type</span><span class="o">]</span> <span class="p">{</span> 
</span></span><span class="line"><span class="cl">    <span class="k">has</span> <span class="n">BinaryTree</span><span class="o">[</span><span class="n">Type</span><span class="o">]</span> <span class="nv">$.left</span> <span class="o">=</span> <span class="nb">l</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">has</span> <span class="n">BinaryTree</span><span class="o">[</span><span class="n">Type</span><span class="o">]</span> <span class="nv">$.right</span> <span class="o">=</span> <span class="nb">r</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">has</span> <span class="n">Type</span> <span class="nv">$.node</span> <span class="o">=</span> <span class="n">n</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k">role</span> <span class="nc">Tip</span><span class="o">[:</span><span class="p">:</span><span class="s">Type</span><span class="o">]</span> <span class="k">does</span> <span class="nc">BinaryTree</span><span class="o">[</span><span class="n">Type</span><span class="o">]</span> <span class="p">{</span> <span class="p">}</span>
</span></span></code></pre></div><p>我们使用函数来代替方法，以 <code>multi sub</code> 的形式实现。大部分的代码当然是相同的，但是不需要条件式来检查是否已经到达了一个叶子节点。我还使用了无符号的不可变变量。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-raku" data-lang="raku"><span class="line"><span class="cl"><span class="k">multi</span> <span class="k">sub</span> <span class="nf">visit-preorder</span><span class="p">(</span><span class="n">Node</span> \<span class="n">n</span><span class="o">,</span><span class="nv">&amp;cb</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">cb</span> <span class="n">n</span><span class="o">.</span><span class="nf">node</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">n</span><span class="o">.</span><span class="nf">left</span><span class="o">,</span> <span class="n">n</span><span class="o">.</span><span class="nb">right</span> <span class="k">-&gt;</span> \<span class="n">branch</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">visit-preorder</span><span class="p">(</span><span class="n">branch</span><span class="o">,</span><span class="nv">&amp;cb</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k">multi</span> <span class="k">sub</span> <span class="nf">visit-preorder</span><span class="p">(</span><span class="n">Tip</span><span class="o">,</span><span class="nv">&amp;cb</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">multi</span> <span class="k">sub</span> <span class="nf">visit-postorder</span><span class="p">(</span><span class="n">Node</span> \<span class="n">n</span><span class="o">,</span><span class="nv">&amp;cb</span><span class="p">)</span> <span class="p">{</span>    
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">n</span><span class="o">.</span><span class="nf">left</span><span class="o">,</span> <span class="n">n</span><span class="o">.</span><span class="nb">right</span> <span class="k">-&gt;</span> \<span class="n">branch</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">visit-postorder</span><span class="p">(</span><span class="n">branch</span><span class="o">,</span><span class="nv">&amp;cb</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">cb</span> <span class="n">n</span><span class="o">.</span><span class="nf">node</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k">multi</span> <span class="k">sub</span> <span class="nf">visit-postorder</span><span class="p">(</span><span class="n">Tip</span><span class="o">,</span><span class="nv">&amp;cb</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">multi</span> <span class="k">sub</span> <span class="nf">new-from-list</span><span class="p">(</span><span class="o">:</span><span class="p">:</span><span class="s">T</span><span class="o">,[]</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Tip</span><span class="o">[</span><span class="kt">Int</span><span class="o">].</span><span class="nb">new</span>    
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k">multi</span> <span class="k">sub</span> <span class="nf">new-from-list</span><span class="p">(</span><span class="o">:</span><span class="p">:</span><span class="s">T</span><span class="o">,</span>\<span class="n">el</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">my</span> <span class="nv">\middle-index</span> <span class="o">=</span> <span class="n">el</span><span class="o">.</span><span class="nb">elems</span> <span class="ow">div</span> <span class="mi">2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">my</span> <span class="nv">\left</span>         <span class="o">=</span> <span class="n">el</span><span class="o">[</span><span class="mi">0</span> <span class="o">..</span> <span class="n">middle-index</span> <span class="o">-</span> <span class="mi">1</span><span class="o">]</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">my</span> <span class="nv">\middle</span>       <span class="o">=</span> <span class="n">el</span><span class="o">[</span><span class="n">middle-index</span><span class="o">]</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">my</span> <span class="nv">\right</span>        <span class="o">=</span> <span class="n">el</span><span class="o">[</span><span class="n">middle-index</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">..</span> <span class="o">*]</span><span class="p">;</span>    
</span></span><span class="line"><span class="cl">    <span class="n">Node</span><span class="o">[</span><span class="nb">T</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">        <span class="nf">new-from-list</span><span class="p">(</span><span class="nb">T</span><span class="o">,</span><span class="n">left</span><span class="p">)</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">        <span class="nf">new-from-list</span><span class="p">(</span><span class="nb">T</span><span class="o">,</span><span class="nb">right</span><span class="p">)</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">middle</span>            
</span></span><span class="line"><span class="cl">    <span class="o">].</span><span class="nb">new</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">my</span> <span class="n">BinaryTree</span><span class="o">[</span><span class="kt">Int</span><span class="o">]</span> \<span class="nb">t</span> <span class="o">=</span> <span class="nf">new-from-list</span><span class="p">(</span><span class="kt">Int</span><span class="o">,[</span><span class="mi">4</span><span class="o">,</span> <span class="mi">5</span><span class="o">,</span> <span class="mi">6</span><span class="o">]</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nf">visit-preorder</span><span class="p">(</span><span class="nb">t</span><span class="o">,</span><span class="nv">&amp;say</span><span class="p">);</span>    <span class="c1"># OUTPUT: «5␤4␤6␤» </span>
</span></span><span class="line"><span class="cl"><span class="nf">visit-postorder</span><span class="p">(</span><span class="nb">t</span><span class="o">,</span><span class="nv">&amp;say</span><span class="p">);</span>   <span class="c1"># OUTPUT: «4␤6␤5␤» </span>
</span></span></code></pre></div><p>有一点需要注意的是，在 <code>multi sub</code> 系统中，我们不必与完整的类型相匹配，例如在 <code>visit-preorder</code> 中，我们与 <code>Tip</code> 和 <code>Node</code> 相匹配，而不是与完整的 <code>Tip[a]</code> 和 <code>Node[:a,BinaryTree[a],BinaryTree[a],a]</code> 匹配。</p>
<p><a href="https://github.com/wimvanderbauwhede/raku-examples/blob/master/binary_tree_2.p6">这个例子的代码</a></p>
<h2 id="总结">总结&nbsp;<a class="headline-hash no-text-decoration" href="#总结">#</a> </h2>
<p>用 Raku 的 Role 创建代数数据类型是非常直接的。任何积类型(product type)都只是一个带有一些类型属性的 Role。和类型(sum type)的关键思想是创建一个空的 Role，并将其与其他 Role 混合在一起，成为你的可供选择的值的类型构造函数。因为 Role 接收类型参数，我们可以有参数化的多态性。因为 Role 可以有它自己类型的属性，所以我们也有递归类型。结合 Raku 的其他函数式编程特性，这使得在 Raku 中编写纯粹的、静态类型的函数式代码非常有趣。</p>
<h2 id="参考文献">参考文献&nbsp;<a class="headline-hash no-text-decoration" href="#参考文献">#</a> </h2>
<p>[1] <a href="https://codewords.recurse.com/issues/three/algebra-and-calculus-of-algebraic-data-types">&ldquo;代数数据类型的代数(和微积分!)&quot;，作者 Joel Burget</a>
[2] <a href="https://gist.github.com/gregberns/5e9da0c95a9a8d2b6338afe69310b945">&ldquo;代数数据类型的代数，第一部分&rdquo;，作者：Chris Taylor</a></p>
<p>原文链接: <a href="https://wimvanderbauwhede.github.io/articles/roles-as-adts-in-raku/">https://wimvanderbauwhede.github.io/articles/roles-as-adts-in-raku/</a></p>


        </div>
    </div>
</article>



                <footer>
                    




<div class="no-text-decoration">
    <div class="jump top"><a href="#" title="Top of this page">⮉</a></div>
    <div class="jump bottom"><a href="#bottom" title="Bottom of this page">⮋</a></div>
</div>


 
    
        <div class="hugotoc no-text-decoration">
            <nav id="TableOfContents">
  <ul>
    <li><a href="#这篇文章适合你吗">这篇文章适合你吗？</a></li>
    <li><a href="#代数数据类型">代数数据类型</a>
      <ul>
        <li><a href="#几个例子">几个例子</a></li>
        <li><a href="#整数和字符串递归和多态">整数和字符串、递归和多态</a></li>
        <li><a href="#代数数据类型有什么用">代数数据类型有什么用？</a></li>
      </ul>
    </li>
    <li><a href="#raku-中的代数数据类型">Raku 中的代数数据类型</a>
      <ul>
        <li><a href="#对-raku-的快速介绍">对 Raku 的快速介绍</a></li>
        <li><a href="#几个简单的例子">几个简单的例子</a></li>
        <li><a href="#几个比较有用的例子">几个比较有用的例子</a></li>
      </ul>
    </li>
    <li><a href="#总结">总结</a></li>
    <li><a href="#参考文献">参考文献</a></li>
  </ul>
</nav>
            <a href="#" class="back-to-top">Back to top</a>
        </div>
    
    
<script src="/js/libs/jquery/3.3.1/jquery.slim.min.min.22ee3db0c0e99fd0fbce3aee19672bd53d25469daf734bd4c165649f6eaf7d7f.js"></script>

<link rel="preload" href="/js/libs/jquery/3.3.1/jquery.slim.min.min.22ee3db0c0e99fd0fbce3aee19672bd53d25469daf734bd4c165649f6eaf7d7f.js" as="script">

<script type="application/javascript">(function() {
     var $window = $(window);
     if ($window.width() >= 1400) { 
         var $toc = $('#TableOfContents');
         if ($toc.length > 0) {
             function onScroll(){
                 var currentScroll = $window.scrollTop();
                 var h = $('.content h1, .content h2, .content h3, .content h4, .content h5, .content h6, .h-feed h2');
                 var id = "";
                 h.each(function (i, e) {
                     e = $(e);
                     if (e.offset().top - 10 <= currentScroll) {
                         id = e.attr('id');
                     }
                 });
                 var current = $toc.find('a.current');
                 if (current.length == 1 && current.eq(0).attr('href') == '#' + id) return true;

                 current.each(function (i, e) {
                     $(e).removeClass('current').siblings('ul').hide();
                 });
                 $toc.find('a[href="#' + id + '"]').parentsUntil('#TableOfContents').each(function (i, e) {
                     $(e).children('a').addClass('current').siblings('ul').show();
                 });
             }
             $window.on('scroll', onScroll);
             $(document).ready(function() {
                 $toc.find('a').parent('li').find('ul').hide();
                 onScroll();
                 document.getElementsByClassName('hugotoc')[0].style.display = '';
             });}}})();</script>








<div class="backtotop center no-text-decoration">
    <a href="#">back to <span class="top">top</span></a>
</div>


<div class="right">
    <div class="taxo no-text-decoration">
         
            
                <ul class="no-bullets inline categories">
                    
                        
                        
                        
                            
                            
                            
                            
                            
                            <li class="__rakulang__"
                                
                                
                                title="See all 0 posts categorized in ‘rakulang’"
                                
                            >
                                <a class="p-category" href="https://ohmycloud.github.io/categories/rakulang/">rakulang</a>
                            </li>
                        
                    
                </ul>
            
         
            
                <ul class="no-bullets inline tags">
                    
                        
                        
                        
                            
                            
                            
                            
                            
                            <li class="__rakulang__"
                                
                                
                                title="See all 0 posts tagged with ‘rakulang’"
                                
                            >
                                <a class="p-category" href="https://ohmycloud.github.io/tags/rakulang/">rakulang</a>
                            </li>
                        
                    
                </ul>
            
        
    </div>

</div>
<div class="clear-float"></div>



<div class="prev-next-navigator clear-float">
    
        <span class="prev-post left no-text-decoration">
            <a href="https://ohmycloud.github.io/notes/2022-12-27-querying-parquet-with-millisecond-latency/" class="nobr">« Querying Parquet With Millisecond Latency</a>
        </span>
    
    
        <span class="next-post right no-text-decoration">
            <a href="https://ohmycloud.github.io/notes/2022-06-04-raku-and-rust-ffi/" class="nobr">Raku and Rust Ffi »</a>
        </span>
    
</div>


<a id="bottom"></a>









                       







                    <ul class="no-bullets feed right inline">
    
        
        
    
</ul>
<div class="clear-float"></div>

                </footer>
                <hr />
            </div>               

            <footer> 
                

<ul class="social no-text-decoration">
    
</ul>










 
    
    



<p class="generated no-text-decoration">
    Generated using  <a href="https://gitlab.com/kaushalmodi/hugo-theme-refined"><code class="nobr">hugo-theme-refined</code></a> + <span class="nobr">Hugo <a href="https://github.com/gohugoio/hugo/commit/312735366b20d64bd61bff8627f593749f86c964">0.123.7</a></span>
</p>

<p>
    
</p>




<div class="badges no-text-decoration">
    
    

    
</div>




<script type="application/javascript">var nav=responsiveNav("#nav");</script>




<script defer src="/js/libs/fragmentions/wrapper.min.e8c468c89edc4f5dccaa8c720c6b220b3088a16cd7b1e4a1e3345985788260c9.js"></script>









            </footer>
        </div> 
    </body>
</html>
