{"author":{"name":null,"type":"card","url":"https://ohmyweekly.github.io/"},"content":{"html":"\u003cp\u003e在我过去写的一些博客中, 我经常遇到 Raku 不能如我所愿的情况。这是件小事儿, 但是像许多其它的小事儿一样, 它不经常发生但确一直刺激到我。\u003c/p\u003e\n\u003cp\u003e在我之前写的东西中, 我使用了一些 Raku 代码完美地阐述了这一点。我需要为 \u003ccode\u003e@values\u003c/code\u003e 数组中的每个值创建一个对象, 如果 \u003ccode\u003e@values\u003c/code\u003e 为空, 则创建一个特殊的对象:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-raku\" data-lang=\"raku\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"nv\"\u003e@values\u003c/span\u003e \u003cspan class=\"ow\"\u003eZ\u003c/span\u003e \u003cspan class=\"nv\"\u003e$label\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026#34;\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e,*\u003c/span\u003e \u003cspan class=\"k\"\u003e-\u0026gt;\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nv\"\u003e$value\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e \u003cspan class=\"nv\"\u003e$label\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"n\"\u003eResult\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"nb\"\u003enew\u003c/span\u003e\u003cspan class=\"o\"\u003e:\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"s\"\u003edesc\u003c/span\u003e  \u003cspan class=\"o\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"nv\"\u003e$label\u003c/span\u003e\u003cspan class=\"s2\"\u003e (\u003c/span\u003e\u003cspan class=\"nv\"\u003e$param\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003ename\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\u003cspan class=\"s2\"\u003e = \u003c/span\u003e\u003cspan class=\"nv\"\u003e$value\u003c/span\u003e\u003cspan class=\"s2\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"s\"\u003evalue\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003etimed\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"nv\"\u003e$block\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nv\"\u003e$value\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"s\"\u003echeck\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"nb\"\u003elast\u003c/span\u003e \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003etiming\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003eTIMEOUT\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"o\"\u003e!\u003c/span\u003e\u003cspan class=\"nv\"\u003e@values\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"n\"\u003eResult\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"nb\"\u003enew\u003c/span\u003e\u003cspan class=\"o\"\u003e:\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"s\"\u003edesc\u003c/span\u003e  \u003cspan class=\"o\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"nv\"\u003e$label\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"s\"\u003evalue\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003etimed\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"nv\"\u003e$block\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eEmpty\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e几乎在同一时间, 在其它我所写的代码中(不在博客里的), 我需要完全相同的结构\u0026hellip;处理数组中的每个元素, 如果数组中没有元素, 则做一些不同的处理:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-raku\" data-lang=\"raku\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"nv\"\u003e@errors\u003c/span\u003e \u003cspan class=\"k\"\u003e-\u0026gt;\u003c/span\u003e \u003cspan class=\"nv\"\u003e$error\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nb\"\u003enote\u003c/span\u003e \u003cspan class=\"nv\"\u003e$error\u003c/span\u003e \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"n\"\u003eDEBUG\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"k\"\u003eLAST\u003c/span\u003e \u003cspan class=\"nb\"\u003edie\u003c/span\u003e \u003cspan class=\"ne\"\u003eX::CompilationFailed\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"nb\"\u003enew\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e \u003cspan class=\"o\"\u003e:\u003c/span\u003e\u003cspan class=\"nv\"\u003e@errors\u003c/span\u003e \u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"o\"\u003e!\u003c/span\u003e\u003cspan class=\"nv\"\u003e@errors\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nb\"\u003enote\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"s1\"\u003eCompilation complete\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026#39;\u003c/span\u003e \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"n\"\u003eDEBUG\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"nv\"\u003e$compilation\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e这只是两个令人惊讶的常见情况的例子：需要在一个列表中迭代\u0026hellip;或者如果列表为空，就做一些特殊的事情。换句话说：如果循环不迭代，就做这个代替。\u003c/p\u003e\n\u003cp\u003e我还可以用其他几种方法来写这些循环。例如，我可以在 \u003ccode\u003efor\u003c/code\u003e 的前面加上 \u003ccode\u003edo\u003c/code\u003e，从而将循环转换成一个表达式。然后我可以附加一个 \u003ccode\u003eor\u003c/code\u003e 和特殊情况代码，这样如果第一个 \u003ccode\u003edo\u003c/code\u003e 是 \u003ccode\u003efalse\u003c/code\u003e，代码就会被执行，如果循环根本不迭代，就会发生这种情况:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-raku\" data-lang=\"raku\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nb\"\u003edo\u003c/span\u003e \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"nv\"\u003e@values\u003c/span\u003e \u003cspan class=\"ow\"\u003eZ\u003c/span\u003e \u003cspan class=\"nv\"\u003e$label\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026#34;\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e,*\u003c/span\u003e \u003cspan class=\"k\"\u003e-\u0026gt;\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nv\"\u003e$value\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e \u003cspan class=\"nv\"\u003e$label\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"n\"\u003eResult\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"nb\"\u003enew\u003c/span\u003e\u003cspan class=\"o\"\u003e:\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"s\"\u003edesc\u003c/span\u003e  \u003cspan class=\"o\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"nv\"\u003e$label\u003c/span\u003e\u003cspan class=\"s2\"\u003e (\u003c/span\u003e\u003cspan class=\"nv\"\u003e$param\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003ename\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\u003cspan class=\"s2\"\u003e = \u003c/span\u003e\u003cspan class=\"nv\"\u003e$value\u003c/span\u003e\u003cspan class=\"s2\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"s\"\u003evalue\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003etimed\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"nv\"\u003e$block\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nv\"\u003e$value\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"s\"\u003echeck\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"nb\"\u003elast\u003c/span\u003e \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003etiming\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003eTIMEOUT\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e \u003cspan class=\"ow\"\u003eor\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"n\"\u003eResult\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"nb\"\u003enew\u003c/span\u003e\u003cspan class=\"o\"\u003e:\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"s\"\u003edesc\u003c/span\u003e  \u003cspan class=\"o\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"nv\"\u003e$label\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"s\"\u003evalue\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003etimed\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"nv\"\u003e$block\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eEmpty\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e};\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nb\"\u003edo\u003c/span\u003e \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"nv\"\u003e@errors\u003c/span\u003e \u003cspan class=\"k\"\u003e-\u0026gt;\u003c/span\u003e \u003cspan class=\"nv\"\u003e$error\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nb\"\u003enote\u003c/span\u003e \u003cspan class=\"nv\"\u003e$error\u003c/span\u003e \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"n\"\u003eDEBUG\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"k\"\u003eLAST\u003c/span\u003e \u003cspan class=\"nb\"\u003edie\u003c/span\u003e \u003cspan class=\"ne\"\u003eX::CompilationFailed\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"nb\"\u003enew\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e \u003cspan class=\"o\"\u003e:\u003c/span\u003e\u003cspan class=\"nv\"\u003e@errors\u003c/span\u003e \u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e \u003cspan class=\"ow\"\u003eor\u003c/span\u003e \u003cspan class=\"nb\"\u003edo\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nb\"\u003enote\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"s1\"\u003eCompilation complete\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026#39;\u003c/span\u003e \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"n\"\u003eDEBUG\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"nv\"\u003e$compilation\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e它确实有效。并且它消除了 \u003ccode\u003e@values\u003c/code\u003e 或 \u003ccode\u003e@errors\u003c/code\u003e 的重复测试, 但是它除了使代码的可读性变差之外, 还不够美观。\u003c/p\u003e\n\u003cp\u003e我可以通过把 \u0026ldquo;if-there-were-no-iterable-values\u0026rdquo; 测试提到顶部来提高程序的可读性, 像这样:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-raku\" data-lang=\"raku\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"nv\"\u003e@values\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"nv\"\u003e@values\u003c/span\u003e \u003cspan class=\"ow\"\u003eZ\u003c/span\u003e \u003cspan class=\"nv\"\u003e$label\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026#34;\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e,*\u003c/span\u003e \u003cspan class=\"k\"\u003e-\u0026gt;\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nv\"\u003e$value\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e \u003cspan class=\"nv\"\u003e$label\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"n\"\u003eResult\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"nb\"\u003enew\u003c/span\u003e\u003cspan class=\"o\"\u003e:\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            \u003cspan class=\"s\"\u003edesc\u003c/span\u003e  \u003cspan class=\"o\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"nv\"\u003e$label\u003c/span\u003e\u003cspan class=\"s2\"\u003e (\u003c/span\u003e\u003cspan class=\"nv\"\u003e$param\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003ename\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\u003cspan class=\"s2\"\u003e = \u003c/span\u003e\u003cspan class=\"nv\"\u003e$value\u003c/span\u003e\u003cspan class=\"s2\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            \u003cspan class=\"s\"\u003evalue\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003etimed\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"nv\"\u003e$block\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nv\"\u003e$value\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            \u003cspan class=\"s\"\u003echeck\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"nb\"\u003elast\u003c/span\u003e \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003etiming\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003eTIMEOUT\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003eelse\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"n\"\u003eResult\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"nb\"\u003enew\u003c/span\u003e\u003cspan class=\"o\"\u003e:\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"s\"\u003edesc\u003c/span\u003e  \u003cspan class=\"o\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"nv\"\u003e$label\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"s\"\u003evalue\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003etimed\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"nv\"\u003e$block\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eEmpty\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"nv\"\u003e@errors\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"nv\"\u003e@errors\u003c/span\u003e \u003cspan class=\"k\"\u003e-\u0026gt;\u003c/span\u003e \u003cspan class=\"nv\"\u003e$error\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"nb\"\u003enote\u003c/span\u003e \u003cspan class=\"nv\"\u003e$error\u003c/span\u003e \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"n\"\u003eDEBUG\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"k\"\u003eLAST\u003c/span\u003e \u003cspan class=\"nb\"\u003edie\u003c/span\u003e \u003cspan class=\"ne\"\u003eX::CompilationFailed\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"nb\"\u003enew\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e \u003cspan class=\"o\"\u003e:\u003c/span\u003e\u003cspan class=\"nv\"\u003e@errors\u003c/span\u003e \u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003eelse\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nb\"\u003enote\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"s1\"\u003eCompilation complete\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026#39;\u003c/span\u003e \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"n\"\u003eDEBUG\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"nv\"\u003e$compilation\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u0026hellip;但这只是强调了需要在前两行中两次测试迭代数组的状态的荒谬性。\u003c/p\u003e\n\u003cp\u003e然而，它确实提出了一个更简洁的解决方案：一个消除重复的解决方案，并最大化可读性。这个解决方案的唯一缺点是在标准的 Raku 中是不可能的。\u003c/p\u003e\n\u003cp\u003e这个解决方案是：\u003ccode\u003efor\u003c/code\u003e 循环应该能够有一个 \u003ccode\u003eelse\u003c/code\u003e 块!\u003c/p\u003e\n\u003cp\u003e当前面的 \u003ccode\u003eif\u003c/code\u003e 或 \u003ccode\u003ewhen\u003c/code\u003e 块不执行时，一个 \u003ccode\u003eelse\u003c/code\u003e 块就会执行。同样地，应该可以在 \u003ccode\u003efor\u003c/code\u003e 循环中附加一个 \u003ccode\u003eelse\u003c/code\u003e 块，这样当前面的循环块不执行时，\u003ccode\u003eelse\u003c/code\u003e 块就会执行。\u003c/p\u003e\n\u003cp\u003e如果在 Raku 中可以做到这一点，那么我的两段代码就可以简化为:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-raku\" data-lang=\"raku\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"nv\"\u003e@values\u003c/span\u003e \u003cspan class=\"ow\"\u003eZ\u003c/span\u003e \u003cspan class=\"nv\"\u003e$label\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026#34;\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e,*\u003c/span\u003e \u003cspan class=\"k\"\u003e-\u0026gt;\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nv\"\u003e$value\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e \u003cspan class=\"nv\"\u003e$label\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"n\"\u003eResult\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"nb\"\u003enew\u003c/span\u003e\u003cspan class=\"o\"\u003e:\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"s\"\u003edesc\u003c/span\u003e  \u003cspan class=\"o\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"nv\"\u003e$label\u003c/span\u003e\u003cspan class=\"s2\"\u003e (\u003c/span\u003e\u003cspan class=\"nv\"\u003e$param\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003ename\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\u003cspan class=\"s2\"\u003e = \u003c/span\u003e\u003cspan class=\"nv\"\u003e$value\u003c/span\u003e\u003cspan class=\"s2\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"s\"\u003evalue\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003etimed\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"nv\"\u003e$block\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nv\"\u003e$value\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"s\"\u003echeck\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"nb\"\u003elast\u003c/span\u003e \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003etiming\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003eTIMEOUT\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003eelse\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"n\"\u003eResult\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"nb\"\u003enew\u003c/span\u003e\u003cspan class=\"o\"\u003e:\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"s\"\u003edesc\u003c/span\u003e  \u003cspan class=\"o\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"nv\"\u003e$label\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"s\"\u003evalue\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003etimed\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"nv\"\u003e$block\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eEmpty\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"nv\"\u003e@errors\u003c/span\u003e \u003cspan class=\"k\"\u003e-\u0026gt;\u003c/span\u003e \u003cspan class=\"nv\"\u003e$error\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nb\"\u003enote\u003c/span\u003e \u003cspan class=\"nv\"\u003e$error\u003c/span\u003e \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"n\"\u003eDEBUG\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"k\"\u003eLAST\u003c/span\u003e \u003cspan class=\"nb\"\u003edie\u003c/span\u003e \u003cspan class=\"ne\"\u003eX::CompilationFailed\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"nb\"\u003enew\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e \u003cspan class=\"o\"\u003e:\u003c/span\u003e\u003cspan class=\"nv\"\u003e@errors\u003c/span\u003e \u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003eelse\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nb\"\u003enote\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"s1\"\u003eCompilation complete\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026#39;\u003c/span\u003e \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"n\"\u003eDEBUG\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"nv\"\u003e$compilation\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e虽然 \u003ccode\u003efor ... else\u003c/code\u003e  不是合法的 Raku 语法(或语义), 但那只是个非常小的问题。\u003c/p\u003e\n\u003cp\u003e但是, 就像平时那样, 这在 Raku 中就不算事儿。\u003c/p\u003e\n\u003cp\u003e为了解决这个问题, 我们仅需要重新定义 \u003ccode\u003efor\u003c/code\u003e 关键字\u0026hellip;\u0026hellip;\u003c/p\u003e\n\u003cp\u003e为了替换 \u003ccode\u003efor\u003c/code\u003e 的标准定义，我们需要告诉编译器两件事：新的定义是什么样的，以及它如何工作。换句话说，我们需要定义如何识别新的 \u003ccode\u003efor\u003c/code\u003e 语法，以及如何将新的语法转换成编译器可以优化和执行的操作码的\u0026quot;抽象语法树\u0026quot;。当然，我们还需要告诉编译器使用这些新组件而不是标准组件。\u003c/p\u003e\n\u003cp\u003e在 Raku 中，我们用来解释代码的任何部分的语法和语义被称为\u0026quot;子语言\u0026quot;，简称\u0026quot;slang\u0026quot;，一个典型的 Raku 程序由许多方言编织而成：主 Raku 子语言、Pod 文档子语言、字符串子语言、regex 子语言等。实现这些不同的活动子语言的对象可以通过一个编译时变量：\u003ccode\u003e$*LANG\u003c/code\u003e 获得。\u003c/p\u003e\n\u003cp\u003e在这个例子中，我们需要增强主乐俚语，所以我们为扩展的 \u003ccode\u003efor\u003c/code\u003e 语法创建了一个带有新语法规则的角色，然后将该新语法混入现有语法中。同样，我们需要扩展编译器在遇到新语法时采取的动作，所以我们创建第二个角色，指定这些动作，之后将其混入现有的动作中。\u003c/p\u003e\n\u003cp\u003e新的 grammar 规则的最简单的形式看起来像这样:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-raku\" data-lang=\"raku\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 在可组合角色中封装一个新的 grammar 组件...\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003erole\u003c/span\u003e \u003cspan class=\"nc\"\u003eForElse::Grammar\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"c1\"\u003e# 替换 \u0026#39;for\u0026#39; 语法...\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"k\"\u003erule\u003c/span\u003e \u003cspan class=\"nf\"\u003estatement_control\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"na\"\u003esym\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"s\"\u003efor\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"sr\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"sr\"\u003e          \u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"nf\"\u003esym\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e\u003cspan class=\"sr\"\u003e   \u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"nf\"\u003exblock\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u0026gt;\u003c/span\u003e\u003cspan class=\"sr\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"sr\"\u003e        \u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"sr\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"s1\"\u003eelse\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"sr\"\u003e  \u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"nf\"\u003epblock\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u0026gt;\u003c/span\u003e\u003cspan class=\"sr\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e\u003cspan class=\"o\"\u003e?\u003c/span\u003e\u003cspan class=\"sr\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"sr\"\u003e    \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e我们声明将包含新语法规则的角色 \u003ccode\u003eForElse::Grammar\u003c/code\u003e，然后声明规则本身。该规则的名称是： \u003ccode\u003estatement_control:sym\u0026lt;for\u0026gt;\u003c/code\u003e， 它告诉编译器它是一个语句级的控制结构，由符号 \u003ccode\u003efor\u003c/code\u003e 引入。在规则的正文中，我们首先匹配该符号 \u003ccode\u003e\u0026lt;sym\u0026gt;\u003c/code\u003e，然后是一个\u0026quot;表达式块\u0026quot;(\u003ccode\u003e\u0026lt;xblock(2)\u0026gt;\u003c/code\u003e)。表达式块只是匹配一个非选项表达式的简写，后面是一个非选项块。传入调用 \u003ccode\u003exblock\u003c/code\u003e 的 2 告诉子规则，它所匹配的块必须包含某种主题变量（因为 \u003ccode\u003efor\u003c/code\u003e 循环总是设置一个主题变量，我们不妨在解析源代码时强制执行）。\u003c/p\u003e\n\u003cp\u003e在解析完 \u003ccode\u003efor\u003c/code\u003e 组件后，我们现在要允许一个可选的 \u003ccode\u003eelse\u003c/code\u003e，所以我们将其指定为一个字面(\u003ccode\u003e'else'\u003c/code\u003e)，之后我们期待一个参数化的块(\u003ccode\u003e\u0026lt;pblock(0)\u0026gt;\u003c/code\u003e)。零参数告诉子规则，不期望 \u003ccode\u003eelse\u003c/code\u003e 块有一个主题变量。然后我们将整个 \u003ccode\u003eelse\u003c/code\u003e 语法用非捕获括号（\u003ccode\u003e[...]\u003c/code\u003e）包裹起来，并使其成为可选的（\u003ccode\u003e?\u003c/code\u003e)。\u003c/p\u003e\n\u003cp\u003e请注意，我们不需要为 \u003ccode\u003e\u0026lt;xblock\u0026gt;\u003c/code\u003e 和 \u003ccode\u003e\u0026lt;pblock\u0026gt;\u003c/code\u003e 指定规则。它们的规则已经在标准的 Raku 语法中定义了，我们最终会在其中添加新的 \u003ccode\u003estatement_control:sym\u0026lt;for\u0026gt;\u003c/code\u003e 规则。\u003c/p\u003e\n\u003cp\u003e这条两行规则足以解析每一个有效的 \u003ccode\u003efor...else\u003c/code\u003e，但它也会成功解析其他几个无效的构造。所以我们接下来加入少量的额外组件来防止这种情况的发生。该规则的扩展版本是这样的。\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-raku\" data-lang=\"raku\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003erule\u003c/span\u003e \u003cspan class=\"nf\"\u003estatement_control\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"na\"\u003esym\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"s\"\u003efor\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"sr\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"sr\"\u003e    \u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"nf\"\u003esym\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u0026lt;\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003ekok\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e\u003cspan class=\"sr\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{}\u003c/span\u003e\u003cspan class=\"sr\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"sr\"\u003e    \u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003evetPerl5Syntax\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e\u003cspan class=\"sr\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"sr\"\u003e    \u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"nf\"\u003exblock\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u0026gt;\u003c/span\u003e\u003cspan class=\"sr\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{}\u003c/span\u003e\u003cspan class=\"sr\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"sr\"\u003e    \u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"sr\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"s1\"\u003eelse\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"sr\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"nv\"\u003eelseblock\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"nf\"\u003epblock\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e\u003cspan class=\"sr\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e\u003cspan class=\"o\"\u003e?\u003c/span\u003e\u003cspan class=\"sr\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"sr\"\u003e\u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003erule\u003c/span\u003e \u003cspan class=\"nf\"\u003evetPerl5Syntax\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"sr\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"sr\"\u003e    \u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"sr\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"o\"\u003e?\u003c/span\u003e\u003cspan class=\"ow\"\u003ebefore\u003c/span\u003e\u003cspan class=\"sr\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"s1\"\u003emy\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"o\"\u003e?\u003c/span\u003e\u003cspan class=\"sr\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"s1\"\u003e$\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"se\"\u003e\\w\u003c/span\u003e\u003cspan class=\"o\"\u003e+\u003c/span\u003e\u003cspan class=\"se\"\u003e\\s\u003c/span\u003e\u003cspan class=\"o\"\u003e+\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"s1\"\u003e(\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"sr\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e\u003cspan class=\"sr\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"sr\"\u003e        \u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003etyped_panic\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"s1\"\u003eX::Syntax::P5\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026#39;\u0026gt;\u003c/span\u003e\u003cspan class=\"sr\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e\u003cspan class=\"o\"\u003e?\u003c/span\u003e\u003cspan class=\"sr\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"sr\"\u003e    \u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"sr\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"o\"\u003e?\u003c/span\u003e\u003cspan class=\"ow\"\u003ebefore\u003c/span\u003e\u003cspan class=\"sr\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"s1\"\u003e(\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"sr\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eEXPR\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e\u003cspan class=\"o\"\u003e?\u003c/span\u003e\u003cspan class=\"sr\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"s1\"\u003e;\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"sr\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eEXPR\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e\u003cspan class=\"o\"\u003e?\u003c/span\u003e\u003cspan class=\"sr\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"s1\"\u003e;\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"sr\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eEXPR\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e\u003cspan class=\"o\"\u003e?\u003c/span\u003e\u003cspan class=\"sr\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"s1\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"sr\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e\u003cspan class=\"sr\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"sr\"\u003e        \u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eobs\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u0026#39;\u003c/span\u003e\u003cspan class=\"s1\"\u003eC-style \u0026#34;for (;;)\u0026#34; loop\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#34;loop (;;)\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026#39;)\u0026gt;\u003c/span\u003e\u003cspan class=\"sr\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e\u003cspan class=\"o\"\u003e?\u003c/span\u003e\u003cspan class=\"sr\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"sr\"\u003e\u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e对 \u003ccode\u003e\u0026lt;.kok\u0026gt;\u003c/code\u003e 子规则的调用是用来检查，在匹配了最初的 \u003ccode\u003e'for'\u003c/code\u003e 之后，这三个字符是否真的构成了一个可以的关键字。例如，如果 \u003ccode\u003e'for'\u003c/code\u003e 后面跟着一个 \u003ccode\u003e=\u0026gt;\u003c/code\u003e，那么它就不是 \u003ccode\u003efor\u003c/code\u003e 循环的开始，而是一个对的关键字。同样，如果 \u003ccode\u003e'for'\u003c/code\u003e 后面紧跟着一个开头的小括号，那么它就不是一个 \u003ccode\u003efor\u003c/code\u003e 循环的开始，而是对某个名为 \u003ccode\u003e\u0026amp;for\u003c/code\u003e 的函数的调用。\u003ccode\u003e\u0026lt;.kok\u0026gt;\u003c/code\u003e 子规则(再次从标准的 Raku 语法中继承)做了各种 \u003ccode\u003elookaheads\u003c/code\u003e 来检查这些情况和其他边缘情况，如果发现任何情况就会失败。\u003c/p\u003e\n\u003cp\u003e调用 \u003ccode\u003e\u0026lt;.kok\u0026gt;\u003c/code\u003e 后的空括号 (\u003ccode\u003e{}\u003c/code\u003e) 是为了表示该部分规则中最长标记匹配的结束。这里的问题是，其他人可能会定义其他语句控制符号，想要修改代码，而语法需要知道，如果其中有两个或多个符号匹配，应该选择哪个符号。一般来说，当考虑一个regex或规则中的一组备选方案时，Raku 会选择匹配最长子串的备选方案（而不是像 Perl 5 中那样，选择第一个匹配的备选方案）。这就是所谓的\u0026quot;最长标记匹配\u0026quot;或简称 LTM。\u003c/p\u003e\n\u003cp\u003e当语法试图在我们的新 \u003ccode\u003efor...other\u003c/code\u003e 语法和（比如）别人的 \u003ccode\u003efor...other\u003c/code\u003e 语法之间做出决定时，我们不希望它仅仅因为我们的语法匹配的字符数多而选择我们的语法。我们希望它选择哪种语法更合适。所以我们需要阻止 LTM 评估器考虑整个匹配，而只考虑关键字。有几种方法可以发出 \u0026ldquo;LTM结束\u0026quot;的信号，但最短和最简单的方法就是在规则中插入一个空代码块（即 \u003ccode\u003e{}\u003c/code\u003e）。这就是我们在这里所做的。\u003c/p\u003e\n\u003cp\u003e规则的下一个补充是对 \u003ccode\u003e\u0026lt;.vetPerl5Syntax\u0026gt;\u003c/code\u003e 子规则的调用。\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-raku\" data-lang=\"raku\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003erule\u003c/span\u003e \u003cspan class=\"nf\"\u003evetPerl5Syntax\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"sr\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"sr\"\u003e    \u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"sr\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"o\"\u003e?\u003c/span\u003e\u003cspan class=\"ow\"\u003ebefore\u003c/span\u003e\u003cspan class=\"sr\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"s1\"\u003emy\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"o\"\u003e?\u003c/span\u003e\u003cspan class=\"sr\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"s1\"\u003e$\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"se\"\u003e\\w\u003c/span\u003e\u003cspan class=\"o\"\u003e+\u003c/span\u003e\u003cspan class=\"se\"\u003e\\s\u003c/span\u003e\u003cspan class=\"o\"\u003e+\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"s1\"\u003e(\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"sr\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e\u003cspan class=\"sr\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"sr\"\u003e        \u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003etyped_panic\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"s1\"\u003eX::Syntax::P5\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026#39;\u0026gt;\u003c/span\u003e\u003cspan class=\"sr\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e\u003cspan class=\"o\"\u003e?\u003c/span\u003e\u003cspan class=\"sr\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"sr\"\u003e    \u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"sr\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"o\"\u003e?\u003c/span\u003e\u003cspan class=\"ow\"\u003ebefore\u003c/span\u003e\u003cspan class=\"sr\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"s1\"\u003e(\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"sr\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eEXPR\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e\u003cspan class=\"o\"\u003e?\u003c/span\u003e\u003cspan class=\"sr\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"s1\"\u003e;\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"sr\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eEXPR\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e\u003cspan class=\"o\"\u003e?\u003c/span\u003e\u003cspan class=\"sr\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"s1\"\u003e;\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"sr\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eEXPR\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e\u003cspan class=\"o\"\u003e?\u003c/span\u003e\u003cspan class=\"sr\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"s1\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"sr\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e\u003cspan class=\"sr\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"sr\"\u003e        \u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eobs\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u0026#39;\u003c/span\u003e\u003cspan class=\"s1\"\u003eC-style \u0026#34;for (;;)\u0026#34; loop\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#34;loop (;;)\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026#39;)\u003c/span\u003e\u003cspan class=\"sr\"\u003e\u0026gt; \u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e\u003cspan class=\"o\"\u003e?\u003c/span\u003e\u003cspan class=\"sr\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"sr\"\u003e\u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e添加这个调用是因为标准的 Raku 语法总是特别仔细地观察 \u003ccode\u003efor\u003c/code\u003e 循环，以确保有人没有不小心误用了两种旧的 Perl 5 语法中的一种。如果子规则向前看，发现在 \u003ccode\u003efor\u003c/code\u003e 循环之后紧接着有一个 \u003ccode\u003emy\u003c/code\u003e 和/或一个变量，然后开括号\u003ccode\u003e(\u0026lt;?before 'my'? '$'\\w+ \\s+ '(' \u0026gt;)\u003c/code\u003e，它就会断定它看到的是一个 Perl 5 for，并抛出一个\u003ccode\u003eX::Syntax::P5\u003c/code\u003e 异常。如果它往前看，发现一对括号，其中包含三个由分号分隔的表达式 \u003ccode\u003e(\u0026lt;?before '(' \u0026lt;.EXPR\u0026gt;? ';' \u0026lt;.EXPR\u0026gt;? ';' \u0026lt;.EXPR\u0026gt;? ')' \u0026gt;)\u003c/code\u003e，它的结论是，它看到的是一个Perl 5 C-style 的 \u003ccode\u003efor\u003c/code\u003e 循环，并警告用户用一个循环来代替它。\u003c/p\u003e\n\u003cp\u003e最后，我们修改对 \u003ccode\u003e\u0026lt;pblock(0)\u0026gt;\u003c/code\u003e 的调用，像这样。\u003ccode\u003e\u0026lt;elseblock=.pblock(0)\u0026gt;\u003c/code\u003e。这将导致由 \u003ccode\u003e\u0026lt;pblock(0)\u0026gt;\u003c/code\u003e 调用的任何匹配都被存储在 \u0026rsquo;elsblock\u0026rsquo; 键下，而不是 \u0026lsquo;pblock\u0026rsquo; 键下。这将随后改善我们的 \u003ccode\u003eelse\u003c/code\u003e 处理代码的可读性。\u003c/p\u003e\n\u003cp\u003e一旦这些额外的检查和平衡到位，我们的 \u003ccode\u003estatement_control:sym\u0026lt;for\u0026gt;\u003c/code\u003e 规则就可以添加到当前的俚语中了。如果我们这样做，编译器现在就能识别 \u003ccode\u003efor...else\u003c/code\u003e 构造，但我们不会看到它这样做的有用效果。这是因为我们还没有告诉它如何将新的 \u003ccode\u003efor...else\u003c/code\u003e 语法转换成可执行的操作码。\u003c/p\u003e\n\u003cp\u003e为了告诉它这些，我们声明了第二个角色（这样我们以后就可以把它混入现有的编译器动作中）。在这个角色中，我们指定了一个适当名称的方法，然后编译器将在每次使用我们新的 \u003ccode\u003estatement_control:sym\u0026lt;for\u0026gt;\u003c/code\u003e 规则成功解析时自动调用这个方法。\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-raku\" data-lang=\"raku\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# Encapsulate new actions for new \u0026#39;for\u0026#39; syntax...\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003erole\u003c/span\u003e \u003cspan class=\"nc\"\u003eForElse::Actions\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"k\"\u003euse\u003c/span\u003e \u003cspan class=\"kt\"\u003enqp\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"k\"\u003euse\u003c/span\u003e \u003cspan class=\"nn\"\u003eQAST:from\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"c1\"\u003e# Utility function...\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"k\"\u003esub\u003c/span\u003e \u003cspan class=\"nb\"\u003elookup\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eMu\u003c/span\u003e \\\u003cspan class=\"nb\"\u003ematch\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e \\\u003cspan class=\"nb\"\u003ekey\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"nf\"\u003enqp::atkey\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            \u003cspan class=\"nf\"\u003enqp::findmethod\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003ematch\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"s1\"\u003ehash\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026#39;)(\u003c/span\u003e\u003cspan class=\"nb\"\u003ematch\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            \u003cspan class=\"nb\"\u003ekey\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"o\"\u003e.?\u003c/span\u003e\u003cspan class=\"nb\"\u003east\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"c1\"\u003e# New actions when a \u0026#39;for\u0026#39; is parsed...\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"k\"\u003emethod\u003c/span\u003e \u003cspan class=\"nf\"\u003estatement_control:sym\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eMu\u003c/span\u003e \u003cspan class=\"nv\"\u003e$match\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"k\"\u003emy\u003c/span\u003e \u003cspan class=\"nv\"\u003e$forloop\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"nb\"\u003ecallsame\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"nb\"\u003elookup\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nv\"\u003e$match\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"s1\"\u003eelseblock\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026#39;)\u003c/span\u003e \u003cspan class=\"k\"\u003e-\u0026gt;\u003c/span\u003e \u003cspan class=\"nv\"\u003e$elseblock\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            \u003cspan class=\"nb\"\u003ematch\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"nb\"\u003emake\u003c/span\u003e\u003cspan class=\"o\"\u003e:\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                \u003cspan class=\"n\"\u003eQAST::Op\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"nb\"\u003enew\u003c/span\u003e\u003cspan class=\"o\"\u003e:\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"s\"\u003eop\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"s\"\u003eunless\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e \u003cspan class=\"nv\"\u003e$forloop\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                \u003cspan class=\"n\"\u003eQAST::Op\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"nb\"\u003enew\u003c/span\u003e\u003cspan class=\"o\"\u003e:\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"s\"\u003eop\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"s\"\u003ecall\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e   \u003cspan class=\"nv\"\u003e$elseblock\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e在我们的新动作角色中，我们要做的第一件事就是加载 nqp 和 QAST 模块的设施。NQP 是 Raku 的 \u0026ldquo;Not Quite Perl\u0026quot;子集，大部分的 Raku 编译器都是用它编写的。QAST 是 \u0026ldquo;Quisquous 抽象语法树\u0026rdquo;，表示操作码和参数，所有的 Raku 代码都是在编译器中被还原的。由于我们正在有效地升级编译器以处理我们的新语法，我们将需要通过 NQP 命令来访问这些语法组件。而且，为了实现我们的新行为，我们需要建立一个合适的 QAST 结构。\u003c/p\u003e\n\u003cp\u003e首先，我们建立一个简单的实用函数（\u003ccode\u003elookup\u003c/code\u003e），它从语法中获取一个模式匹配，并试图从该匹配中检索特定命名子匹配的抽象语法树。请注意，因为这段代码将被插入到编译器中，所以它不能依赖于通常的 Raku 数据结构和访问方法。相反，我们需要使用底层的 NQP 访问函数。在这种情况下，实用程序首先定位提取匹配对象的哈希类成分的函数(\u003ccode\u003enqp::findmethod(match, 'hash')\u003c/code\u003e)，然后在匹配数据结构((\u003ccode\u003ematch\u003c/code\u003e))上调用该哈希提取函数，然后对产生的哈希进行键查找(\u003ccode\u003enqp::atkey(..., key)\u003c/code\u003e)，然后尝试检索与该匹配相关的抽象语法树(\u003ccode\u003e...?ast\u003c/code\u003e)。\u003c/p\u003e\n\u003cp\u003e一旦我们有了这种从语法匹配中提取特定成分的能力，我们就可以写一个方法，把 \u003ccode\u003efor.. else\u003c/code\u003e 匹配的各个部分拉出来，并把它们重新排列成一个合适的 QAST 表示。这个方法必须与它所处理的匹配规则同名，所以我们声明:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-raku\" data-lang=\"raku\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003emethod\u003c/span\u003e \u003cspan class=\"nf\"\u003estatement_control\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"na\"\u003esym\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"s\"\u003efor\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eMu\u003c/span\u003e \u003cspan class=\"nv\"\u003e$match\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"o\"\u003e...\u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e该方法将相应语法规则产生的匹配对象作为唯一的参数。我们声明该参数的类型为 \u003ccode\u003eMu\u003c/code\u003e（整个 Raku 层次结构的根类型），因为它是一个 NQP 对象，而且 Raku 类型系统不会以其他方式传递它。请注意，我们不能从 \u003ccode\u003e$match\u003c/code\u003e 参数中省略类型声明，因为那样的话，它将默认为类型为 Any，这在这种情况下就太特殊了。\u003c/p\u003e\n\u003cp\u003e一旦我们有了 \u003ccode\u003ematch\u003c/code\u003e 对象，为了把解析后的 \u003ccode\u003ematch\u003c/code\u003e 变成合适的 QAST 对象，我们需要做的第一件事就是转换 \u003ccode\u003efor\u003c/code\u003e 组件。但是标准的 Raku 解析器已经知道如何做到这一点，所以我们可以通过调用 \u003ccode\u003ecallsame\u003c/code\u003e 告诉它回到以前的行为。\u003c/p\u003e\n\u003cp\u003e那个重发的调用将返回一个代表 \u003ccode\u003efor\u003c/code\u003e 循环的 QAST 对象，并且还将安装同一个 QAST 对象作为 \u003ccode\u003e$match\u003c/code\u003e 对象的新抽象语法树。由于我们可能需要覆盖该行为（如果涉及到一个 \u003ccode\u003eelse\u003c/code\u003e），我们保留 \u003ccode\u003efor\u003c/code\u003e 循环的 \u003ccode\u003eQAST\u003c/code\u003e 对象，通过将其别名为  \u003ccode\u003e$forloop\u003c/code\u003e。\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-raku\" data-lang=\"raku\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003emy\u003c/span\u003e \u003cspan class=\"nv\"\u003e$forloop\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"nb\"\u003ecallsame\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e然后我们需要发现解析器是否真的找到了一个 \u003ccode\u003eelse\u003c/code\u003e 块，我们通过使用 \u003ccode\u003e$match object(lookup($match, 'elseblock'))\u003c/code\u003e 来寻找一个名为 \u0026rsquo;elseblock\u0026rsquo; 的捕获。如果在 \u003ccode\u003efor\u003c/code\u003e 之后有一个 \u003ccode\u003eelse\u003c/code\u003e，我们需要建立一个 QAST 结构，只有在 \u003ccode\u003efor\u003c/code\u003e 循环没有执行的情况下才执行 \u003ccode\u003eelse\u003c/code\u003e 块。用伪代码来说，就是:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-raku\" data-lang=\"raku\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003eunless\u003c/span\u003e \u003cspan class=\"n\"\u003eforloop\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"n\"\u003ecall\u003c/span\u003e \u003cspan class=\"n\"\u003eelseblock\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e而在QAST中也完全一样:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-raku\" data-lang=\"raku\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"n\"\u003eQAST::Op\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"nb\"\u003enew\u003c/span\u003e\u003cspan class=\"o\"\u003e:\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"s\"\u003eop\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"s\"\u003eunless\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e \u003cspan class=\"nv\"\u003e$forloop\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"n\"\u003eQAST::Op\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"nb\"\u003enew\u003c/span\u003e\u003cspan class=\"o\"\u003e:\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"s\"\u003eop\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"s\"\u003ecall\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e   \u003cspan class=\"nv\"\u003e$elseblock\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e也就是说，我们建立一个新的 QAST \u003ccode\u003eunless\u003c/code\u003e 操作(\u003ccode\u003eQAST::Op.new::op\u0026lt;unless\u0026gt;\u003c/code\u003e)，并传递给它两个必要的操作数。\u003c/p\u003e\n\u003cp\u003e一个 QAST 对象，代表要测试的条件。\u003c/p\u003e\n\u003cp\u003e一个 QAST 对象，表示如果该条件为 false，该怎么做。\u003c/p\u003e\n\u003cp\u003e在这种情况下，第一个参数（条件）是我们从 \u003ccode\u003ecallsame\u003c/code\u003e 得到的 QAST 对象；实现整个 \u003ccode\u003efor\u003c/code\u003e 循环的 QAST 对象（即\u003ccode\u003e$forloop\u003c/code\u003e）。\n第二个参数（要做什么）是一个新的QAST对象，实现了对 \u003ccode\u003eelse\u003c/code\u003e 块的调用（即 \u003ccode\u003eQAST::Op.new::op\u0026lt;call\u0026gt;\u003c/code\u003e, \u003ccode\u003e$elseblock\u003c/code\u003e）。\u003c/p\u003e\n\u003cp\u003e一旦我们建立了那个 QAST 结构，我们只需将它安装为原始匹配的抽象语法树（\u003ccode\u003e$match.make:...\u003c/code\u003e）。\u003c/p\u003e\n\u003cp\u003e就这样了。当扩展语法中新的 \u003ccode\u003estatement_control:syn\u0026lt;for\u0026gt;\u003c/code\u003e 规则成功匹配时，编译器将调用扩展动作中等价的 \u003ccode\u003estatement_control:syn\u0026lt;for\u0026gt;\u003c/code\u003e 方法，将解析后的语法转换为实现扩展行为的 QAST。\u003c/p\u003e\n\u003cp\u003e当然，前提是我们真的扩展了语法和它的动作。这一点我们还没有做到。\u003c/p\u003e\n\u003cp\u003e但是，就像 Raku 中的大多数事情一样，实际扩展语法和它的行为并不难做到。我们的目标是拥有一个模块（我们称它为： \u003ccode\u003eSlang::ForElse\u003c/code\u003e），它可以将我们的新方言安装到任何使用它的词法范围内。\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-raku\" data-lang=\"raku\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"k\"\u003euse\u003c/span\u003e \u003cspan class=\"nn\"\u003eSlang::ForElse\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"nv\"\u003e@values\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"nb\"\u003esay\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"k\"\u003eelse\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"nb\"\u003esay\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"s1\"\u003eNo values\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026#39;;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e该模块需要修改 \u003ccode\u003e$*LANG\u003c/code\u003e 对象来安装一个增强的主语法和相应的扩展动作。具体来说，该模块需要调用 \u003ccode\u003e$*LANG\u003c/code\u003e 对象的 \u003ccode\u003e.define_slang\u003c/code\u003e 方法，向其传递要修改的俚语的名称（在本例中：\u0026ldquo;MAIN\u0026rdquo; 方言），以及要为该方言安装的新语法和动作。\u003c/p\u003e\n\u003cp\u003e我们需要在每次使用该模块时调用 \u003ccode\u003e.define_slang\u003c/code\u003e 方法。所以我们应该把调用放在模块的 \u003ccode\u003eEXPORT\u003c/code\u003e 子程序中。像这样:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-raku\" data-lang=\"raku\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003esub\u003c/span\u003e \u003cspan class=\"nf\"\u003eEXPORT\u003c/span\u003e \u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"vg\"\u003e$*LANG\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003edefine_slang\u003c/span\u003e\u003cspan class=\"o\"\u003e:\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"p\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"s2\"\u003eMAIN\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"vg\"\u003e$*LANG\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eslangs\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"s\"\u003eMAIN\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e         \u003cspan class=\"k\"\u003ebut\u003c/span\u003e \u003cspan class=\"nc\"\u003eForElse::Grammar\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"vg\"\u003e$*LANG\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eslangs\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"s\"\u003eMAIN-actions\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"k\"\u003ebut\u003c/span\u003e \u003cspan class=\"nc\"\u003eForElse::Actions\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"nb\"\u003ehash\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e这个子程序调用 \u003ccode\u003e$*LANG\u003c/code\u003e 对象的 \u003ccode\u003e.define_slang\u003c/code\u003e 方法，要求它更新 \u0026ldquo;MAIN\u0026rdquo; 方言的定义。第二个参数是要安装的语法，它只是当前的 \u0026ldquo;MAIN\u0026quot;语法(\u003ccode\u003e$*LANG.slangs\u0026lt;MAIN\u0026gt;\u003c/code\u003e)，但其中混入了新的 \u003ccode\u003efor..else\u003c/code\u003e 语法(\u003ccode\u003ebut ForElse::Grammar\u003c/code\u003e)。第三个参数是要安装的 actions 对象，它只是当前的 \u0026ldquo;MAIN-actions\u0026rdquo; 对象 (\u003ccode\u003e$*LANG.slangs\u0026lt;MAIN-actions\u0026gt;\u003c/code\u003e)，但其中混入了我们新的 \u003ccode\u003efor..else\u003c/code\u003e actions。\u003c/p\u003e\n\u003cp\u003e混合在一起 (\u003ccode\u003ebut ForElse::Actions\u003c/code\u003e)。\u003c/p\u003e\n\u003cp\u003e最后，我们必须确保 \u003ccode\u003eEXPORT\u003c/code\u003e 子程序返回一个空的哈希值 (\u003ccode\u003ehash()\u003c/code\u003e)，以告诉编译器我们实际上并没有导出任何东西。\u003c/p\u003e\n\u003cp\u003e这就是我们的工作。在不到 25 行的时间里，我们修改了 Raku 的语法和语义，增加了一个\u0026quot;缺失\u0026quot;的结构。用其他方式扩展或修改语言来挠其他的痒痒，也就不难了。而且因为每一次扩展或修改都是以词汇的方式进行的，通过将新的行为混合到现有的slangs中，这些额外的功能很可能会相互很好地发挥。\u003c/p\u003e\n\u003cp\u003e例如，我们可以同时加载 \u003ccode\u003eSlang::ForElse\u003c/code\u003e 和 \u003ccode\u003eSlang::SQL\u003c/code\u003e，然后写:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-raku\" data-lang=\"raku\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003euse\u003c/span\u003e \u003cspan class=\"nn\"\u003eSlang::ForElse\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003euse\u003c/span\u003e \u003cspan class=\"nn\"\u003eSlang::SQL\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"n\"\u003esql\u003c/span\u003e \u003cspan class=\"n\"\u003edrop\u003c/span\u003e \u003cspan class=\"n\"\u003etable\u003c/span\u003e \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"n\"\u003eexists\u003c/span\u003e \u003cspan class=\"n\"\u003estuff\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"n\"\u003esql\u003c/span\u003e \u003cspan class=\"n\"\u003ecreate\u003c/span\u003e \u003cspan class=\"n\"\u003etable\u003c/span\u003e \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"nb\"\u003enot\u003c/span\u003e \u003cspan class=\"n\"\u003eexists\u003c/span\u003e \u003cspan class=\"n\"\u003estuff\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nb\"\u003eid\u003c/span\u003e  \u003cspan class=\"n\"\u003einteger\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"n\"\u003esid\u003c/span\u003e \u003cspan class=\"nf\"\u003evarchar\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e32\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"nv\"\u003e@ids\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"n\"\u003esql\u003c/span\u003e \u003cspan class=\"n\"\u003einsert\u003c/span\u003e \u003cspan class=\"n\"\u003einto\u003c/span\u003e \u003cspan class=\"n\"\u003estuff\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003eid\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003esid\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"nb\"\u003evalues\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e?,\u003c/span\u003e \u003cspan class=\"o\"\u003e?\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e \u003cspan class=\"k\"\u003ewith\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nv\"\u003e$_\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u0026#39;\u003c/span\u003e\u003cspan class=\"s1\"\u003eg\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"o\"\u003e..\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"s1\"\u003eZ\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026#39;)\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"nb\"\u003epick\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e16\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"nb\"\u003ejoin\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003eelse\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"n\"\u003esql\u003c/span\u003e \u003cspan class=\"n\"\u003einsert\u003c/span\u003e \u003cspan class=\"n\"\u003einto\u003c/span\u003e \u003cspan class=\"n\"\u003estuff\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003eid\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003esid\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"nb\"\u003evalues\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e?,\u003c/span\u003e \u003cspan class=\"o\"\u003e?\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e \u003cspan class=\"k\"\u003ewith\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e99\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"s1\"\u003edefault\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026#39;);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"n\"\u003esql\u003c/span\u003e \u003cspan class=\"n\"\u003eselect\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"nb\"\u003efrom\u003c/span\u003e \u003cspan class=\"n\"\u003estuff\u003c/span\u003e \u003cspan class=\"n\"\u003eorder\u003c/span\u003e \u003cspan class=\"n\"\u003eby\u003c/span\u003e \u003cspan class=\"nb\"\u003eid\u003c/span\u003e \u003cspan class=\"n\"\u003easc\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"nb\"\u003edo\u003c/span\u003e \u003cspan class=\"k\"\u003e-\u0026gt;\u003c/span\u003e \u003cspan class=\"nv\"\u003e$row\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"p\"\u003e\u0026#34;{\u003c/span\u003e\u003cspan class=\"nv\"\u003e$row\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"s\"\u003eid\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;}\u003c/span\u003e\u003cspan class=\"se\"\u003e\\t\u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"nv\"\u003e$row\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"s\"\u003esid\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;}\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"nb\"\u003esay\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e};\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e定义和部署词法范围的 slangs 的能力使 Raku 具有高度的未来性。任何我们在最初的设计中忘记添加到 Raku 中的东西(比如 \u003ccode\u003efor..else\u003c/code\u003e!）都可以在以后需要时轻松添加。\u003c/p\u003e\n\u003cp\u003e而且 slangs 也有可能使 Raku 与其他工具高度互操作。例如，Raku 有可能成为最终的\u0026quot;胶水语言\u0026rdquo;，通过允许我们切换到那些看起来很像其他编程语言的 slangs，只要这些语言可能更方便编码:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-raku\" data-lang=\"raku\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"nv\"\u003e@values\u003c/span\u003e \u003cspan class=\"k\"\u003e-\u0026gt;\u003c/span\u003e \\\u003cspan class=\"nb\"\u003evalue\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"k\"\u003euse\u003c/span\u003e \u003cspan class=\"nn\"\u003eSlang::Python\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nb\"\u003efrom\u003c/span\u003e \u003cspan class=\"n\"\u003emath\u003c/span\u003e \u003cspan class=\"k\"\u003eimport\u003c/span\u003e \u003cspan class=\"nb\"\u003efloor\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e \u003cspan class=\"nb\"\u003esqrt\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"n\"\u003edef\u003c/span\u003e \u003cspan class=\"nf\"\u003efac\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003en\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"o\"\u003e:\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"n\"\u003estep\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"nf\"\u003elambda\u003c/span\u003e \u003cspan class=\"nb\"\u003ex\u003c/span\u003e\u003cspan class=\"o\"\u003e:\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003ex\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u0026lt;\u003c/span\u003e\u003cspan class=\"s2\"\u003e2) - ((x\u0026gt;\u0026gt;1)\u0026lt;\u0026lt;1)\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s2\"\u003e        maxq = long(floor(sqrt(n)))\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s2\"\u003e        d = 1\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s2\"\u003e        q = n % 2 == 0 and 2 or 3\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s2\"\u003e        while q \u0026lt;= maxq and n % q != 0:\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s2\"\u003e            q = step(d)\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s2\"\u003e            d += 1\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s2\"\u003e        return q \u0026lt;= maxq and [q] + fac(n//q) or [n]\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s2\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s2\"\u003e    print(fac(value)))\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s2\"\u003e}\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s2\"\u003eelse \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"k\"\u003euse\u003c/span\u003e \u003cspan class=\"nn\"\u003eSlang::Ruby\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"k\"\u003erequire\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"s1\"\u003eio/console\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026#39;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nb\"\u003eprint\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"s2\"\u003eNo values. Continue?\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"k\"\u003eloop\u003c/span\u003e \u003cspan class=\"nb\"\u003edo\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"n\"\u003ecase\u003c/span\u003e \u003cspan class=\"nv\"\u003e$stdin\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003egetch\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            \u003cspan class=\"k\"\u003ewhen\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"s2\"\u003eY\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026#34;\u003c/span\u003e \u003cspan class=\"nb\"\u003ethen\u003c/span\u003e \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            \u003cspan class=\"k\"\u003ewhen\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"s2\"\u003eN\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026#34;\u003c/span\u003e \u003cspan class=\"nb\"\u003ethen\u003c/span\u003e \u003cspan class=\"nb\"\u003ebreak\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            \u003cspan class=\"k\"\u003eelse\u003c/span\u003e \u003cspan class=\"nb\"\u003eprint\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"se\"\u003e\\r\u003c/span\u003e\u003cspan class=\"s2\"\u003eNo values. Continue? [YN]\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"nb\"\u003eend\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nb\"\u003eend\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"s2\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e不幸的是，这些特殊的方言模块还不存在，但是 Python 和 Ruby (以及Perl 5和Lua、Scheme、Go和C)的全功能 Raku 接口已经存在，所以为它们中的每一个编写完全集成的方言将只是一个简单的元编程问题。)\u003c/p\u003e\n\u003cp\u003eDamian\u003c/p\u003e\n","text":"在我过去写的一些博客中, 我经常遇到 Raku 不能如我所愿的情况。这是件小事儿, 但是像许多其它的小事儿一样, 它不经常发生但确一直刺激到我。\n在我之前写的东西中, 我使用了一些 Raku 代码完美地阐述了这一点。我需要为 @values 数组中的每个值创建一个对象, 如果 @values 为空, 则创建一个特殊的对象:\nfor @values Z $label,\u0026#34;\u0026#34;,* -\u0026gt; ($value, $label) { Result.new: desc =\u0026gt; \u0026#34;$label ($param.name() = $value)\u0026#34;, value =\u0026gt; timed { $block($value) }, check =\u0026gt; { last if .timing \u0026gt; TIMEOUT } } if !@values { Result.new: desc =\u0026gt; $label, value =\u0026gt; timed { $block(Empty) } } 几乎在同一时间, 在其它我所写的代码中(不在博客里的), 我需要完全相同的结构\u0026hellip;处理数组中的每个元素, 如果数组中没有元素, 则做一些不同的处理:\nfor @errors -\u0026gt; $error { note $error if DEBUG; LAST die X::CompilationFailed.new( :@errors ); } if !@errors { note \u0026#39;Compilation complete\u0026#39; if DEBUG; return $compilation; } 这只是两个令人惊讶的常见情况的例子：需要在一个列表中迭代\u0026hellip;或者如果列表为空，就做一些特殊的事情。换句话说：如果循环不迭代，就做这个代替。\n我还可以用其他几种方法来写这些循环。例如，我可以在 for 的前面加上 do，从而将循环转换成一个表达式。然后我可以附加一个 or 和特殊情况代码，这样如果第一个 do 是 false，代码就会被执行，如果循环根本不迭代，就会发生这种情况:\ndo for @values Z $label,\u0026#34;\u0026#34;,* -\u0026gt; ($value, $label) { Result.new: desc =\u0026gt; \u0026#34;$label ($param.name() = $value)\u0026#34;, value =\u0026gt; timed { $block($value) }, check =\u0026gt; { last if .timing \u0026gt; TIMEOUT } } or Result.new: desc =\u0026gt; $label, value =\u0026gt; timed { $block(Empty) }; do for @errors -\u0026gt; $error { note $error if DEBUG; LAST die X::CompilationFailed.new( :@errors ); } or do { note \u0026#39;Compilation complete\u0026#39; if DEBUG; return $compilation; } 它确实有效。并且它消除了 @values 或 @errors 的重复测试, 但是它除了使代码的可读性变差之外, 还不够美观。\n我可以通过把 \u0026ldquo;if-there-were-no-iterable-values\u0026rdquo; 测试提到顶部来提高程序的可读性, 像这样:\nif @values { for @values Z $label,\u0026#34;\u0026#34;,* -\u0026gt; ($value, $label) { Result.new: desc =\u0026gt; \u0026#34;$label ($param.name() = $value)\u0026#34;, value =\u0026gt; timed { $block($value) }, check =\u0026gt; { last if .timing \u0026gt; TIMEOUT } } } else { Result.new: desc =\u0026gt; $label, value =\u0026gt; timed { $block(Empty) } } if @errors { for @errors -\u0026gt; $error { note $error if DEBUG; LAST die X::CompilationFailed.new( :@errors ); } } else { note \u0026#39;Compilation complete\u0026#39; if DEBUG; return $compilation; } \u0026hellip;但这只是强调了需要在前两行中两次测试迭代数组的状态的荒谬性。\n然而，它确实提出了一个更简洁的解决方案：一个消除重复的解决方案，并最大化可读性。这个解决方案的唯一缺点是在标准的 Raku 中是不可能的。\n这个解决方案是：for 循环应该能够有一个 else 块!\n当前面的 if 或 when 块不执行时，一个 else 块就会执行。同样地，应该可以在 for 循环中附加一个 else 块，这样当前面的循环块不执行时，else 块就会执行。\n如果在 Raku 中可以做到这一点，那么我的两段代码就可以简化为:\nfor @values Z $label,\u0026#34;\u0026#34;,* -\u0026gt; ($value, $label) { Result.new: desc =\u0026gt; \u0026#34;$label ($param.name() = $value)\u0026#34;, value =\u0026gt; timed { $block($value) }, check =\u0026gt; { last if .timing \u0026gt; TIMEOUT } } else { Result.new: desc =\u0026gt; $label, value =\u0026gt; timed { $block(Empty) } } for @errors -\u0026gt; $error { note $error if DEBUG; LAST die X::CompilationFailed.new( :@errors ); } else { note \u0026#39;Compilation complete\u0026#39; if DEBUG; return $compilation; } 虽然 for ... else 不是合法的 Raku 语法(或语义), 但那只是个非常小的问题。\n但是, 就像平时那样, 这在 Raku 中就不算事儿。\n为了解决这个问题, 我们仅需要重新定义 for 关键字\u0026hellip;\u0026hellip;\n为了替换 for 的标准定义，我们需要告诉编译器两件事：新的定义是什么样的，以及它如何工作。换句话说，我们需要定义如何识别新的 for 语法，以及如何将新的语法转换成编译器可以优化和执行的操作码的\u0026quot;抽象语法树\u0026quot;。当然，我们还需要告诉编译器使用这些新组件而不是标准组件。\n在 Raku 中，我们用来解释代码的任何部分的语法和语义被称为\u0026quot;子语言\u0026quot;，简称\u0026quot;slang\u0026quot;，一个典型的 Raku 程序由许多方言编织而成：主 Raku 子语言、Pod 文档子语言、字符串子语言、regex 子语言等。实现这些不同的活动子语言的对象可以通过一个编译时变量：$*LANG 获得。\n在这个例子中，我们需要增强主乐俚语，所以我们为扩展的 for 语法创建了一个带有新语法规则的角色，然后将该新语法混入现有语法中。同样，我们需要扩展编译器在遇到新语法时采取的动作，所以我们创建第二个角色，指定这些动作，之后将其混入现有的动作中。\n新的 grammar 规则的最简单的形式看起来像这样:\n# 在可组合角色中封装一个新的 grammar 组件... role ForElse::Grammar { # 替换 \u0026#39;for\u0026#39; 语法... rule statement_control:sym\u0026lt;for\u0026gt; { \u0026lt;sym\u0026gt; \u0026lt;xblock(2)\u0026gt; [ \u0026#39;else\u0026#39; \u0026lt;pblock(0)\u0026gt; ]? } } 我们声明将包含新语法规则的角色 ForElse::Grammar，然后声明规则本身。该规则的名称是： statement_control:sym\u0026lt;for\u0026gt;， 它告诉编译器它是一个语句级的控制结构，由符号 for 引入。在规则的正文中，我们首先匹配该符号 \u0026lt;sym\u0026gt;，然后是一个\u0026quot;表达式块\u0026quot;(\u0026lt;xblock(2)\u0026gt;)。表达式块只是匹配一个非选项表达式的简写，后面是一个非选项块。传入调用 xblock 的 2 告诉子规则，它所匹配的块必须包含某种主题变量（因为 for 循环总是设置一个主题变量，我们不妨在解析源代码时强制执行）。\n在解析完 for 组件后，我们现在要允许一个可选的 else，所以我们将其指定为一个字面('else')，之后我们期待一个参数化的块(\u0026lt;pblock(0)\u0026gt;)。零参数告诉子规则，不期望 else 块有一个主题变量。然后我们将整个 else 语法用非捕获括号（[...]）包裹起来，并使其成为可选的（?)。\n请注意，我们不需要为 \u0026lt;xblock\u0026gt; 和 \u0026lt;pblock\u0026gt; 指定规则。它们的规则已经在标准的 Raku 语法中定义了，我们最终会在其中添加新的 statement_control:sym\u0026lt;for\u0026gt; 规则。\n这条两行规则足以解析每一个有效的 for...else，但它也会成功解析其他几个无效的构造。所以我们接下来加入少量的额外组件来防止这种情况的发生。该规则的扩展版本是这样的。\nrule statement_control:sym\u0026lt;for\u0026gt; { \u0026lt;sym\u0026gt;\u0026lt;.kok\u0026gt; {} \u0026lt;.vetPerl5Syntax\u0026gt; \u0026lt;xblock(2)\u0026gt; {} [ \u0026#39;else\u0026#39; \u0026lt;elseblock=pblock\u0026gt; ]? } rule vetPerl5Syntax { [ \u0026lt;?before \u0026#39;my\u0026#39;? \u0026#39;$\u0026#39;\\w+\\s+\u0026#39;(\u0026#39; \u0026gt; \u0026lt;.typed_panic: \u0026#39;X::Syntax::P5\u0026#39;\u0026gt; ]? [ \u0026lt;?before \u0026#39;(\u0026#39; \u0026lt;.EXPR\u0026gt;? \u0026#39;;\u0026#39; \u0026lt;.EXPR\u0026gt;? \u0026#39;;\u0026#39; \u0026lt;.EXPR\u0026gt;? \u0026#39;)\u0026#39; \u0026gt; \u0026lt;.obs(\u0026#39;C-style \u0026#34;for (;;)\u0026#34; loop\u0026#39;, \u0026#39;\u0026#34;loop (;;)\u0026#34;\u0026#39;)\u0026gt; ]? } 对 \u0026lt;.kok\u0026gt; 子规则的调用是用来检查，在匹配了最初的 'for' 之后，这三个字符是否真的构成了一个可以的关键字。例如，如果 'for' 后面跟着一个 =\u0026gt;，那么它就不是 for 循环的开始，而是一个对的关键字。同样，如果 'for' 后面紧跟着一个开头的小括号，那么它就不是一个 for 循环的开始，而是对某个名为 \u0026amp;for 的函数的调用。\u0026lt;.kok\u0026gt; 子规则(再次从标准的 Raku 语法中继承)做了各种 lookaheads 来检查这些情况和其他边缘情况，如果发现任何情况就会失败。\n调用 \u0026lt;.kok\u0026gt; 后的空括号 ({}) 是为了表示该部分规则中最长标记匹配的结束。这里的问题是，其他人可能会定义其他语句控制符号，想要修改代码，而语法需要知道，如果其中有两个或多个符号匹配，应该选择哪个符号。一般来说，当考虑一个regex或规则中的一组备选方案时，Raku 会选择匹配最长子串的备选方案（而不是像 Perl 5 中那样，选择第一个匹配的备选方案）。这就是所谓的\u0026quot;最长标记匹配\u0026quot;或简称 LTM。\n当语法试图在我们的新 for...other 语法和（比如）别人的 for...other 语法之间做出决定时，我们不希望它仅仅因为我们的语法匹配的字符数多而选择我们的语法。我们希望它选择哪种语法更合适。所以我们需要阻止 LTM 评估器考虑整个匹配，而只考虑关键字。有几种方法可以发出 \u0026ldquo;LTM结束\u0026quot;的信号，但最短和最简单的方法就是在规则中插入一个空代码块（即 {}）。这就是我们在这里所做的。\n规则的下一个补充是对 \u0026lt;.vetPerl5Syntax\u0026gt; 子规则的调用。\nrule vetPerl5Syntax { [ \u0026lt;?before \u0026#39;my\u0026#39;? \u0026#39;$\u0026#39;\\w+\\s+\u0026#39;(\u0026#39; \u0026gt; \u0026lt;.typed_panic: \u0026#39;X::Syntax::P5\u0026#39;\u0026gt; ]? [ \u0026lt;?before \u0026#39;(\u0026#39; \u0026lt;.EXPR\u0026gt;? \u0026#39;;\u0026#39; \u0026lt;.EXPR\u0026gt;? \u0026#39;;\u0026#39; \u0026lt;.EXPR\u0026gt;? \u0026#39;)\u0026#39; \u0026gt; \u0026lt;.obs(\u0026#39;C-style \u0026#34;for (;;)\u0026#34; loop\u0026#39;, \u0026#39;\u0026#34;loop (;;)\u0026#34;\u0026#39;)\u0026gt; ]? } 添加这个调用是因为标准的 Raku 语法总是特别仔细地观察 for 循环，以确保有人没有不小心误用了两种旧的 Perl 5 语法中的一种。如果子规则向前看，发现在 for 循环之后紧接着有一个 my 和/或一个变量，然后开括号(\u0026lt;?before 'my'? '$'\\w+ \\s+ '(' \u0026gt;)，它就会断定它看到的是一个 Perl 5 for，并抛出一个X::Syntax::P5 异常。如果它往前看，发现一对括号，其中包含三个由分号分隔的表达式 (\u0026lt;?before '(' \u0026lt;.EXPR\u0026gt;? ';' \u0026lt;.EXPR\u0026gt;? ';' \u0026lt;.EXPR\u0026gt;? ')' \u0026gt;)，它的结论是，它看到的是一个Perl 5 C-style 的 for 循环，并警告用户用一个循环来代替它。\n最后，我们修改对 \u0026lt;pblock(0)\u0026gt; 的调用，像这样。\u0026lt;elseblock=.pblock(0)\u0026gt;。这将导致由 \u0026lt;pblock(0)\u0026gt; 调用的任何匹配都被存储在 \u0026rsquo;elsblock\u0026rsquo; 键下，而不是 \u0026lsquo;pblock\u0026rsquo; 键下。这将随后改善我们的 else 处理代码的可读性。\n一旦这些额外的检查和平衡到位，我们的 statement_control:sym\u0026lt;for\u0026gt; 规则就可以添加到当前的俚语中了。如果我们这样做，编译器现在就能识别 for...else 构造，但我们不会看到它这样做的有用效果。这是因为我们还没有告诉它如何将新的 for...else 语法转换成可执行的操作码。\n为了告诉它这些，我们声明了第二个角色（这样我们以后就可以把它混入现有的编译器动作中）。在这个角色中，我们指定了一个适当名称的方法，然后编译器将在每次使用我们新的 statement_control:sym\u0026lt;for\u0026gt; 规则成功解析时自动调用这个方法。\n# Encapsulate new actions for new \u0026#39;for\u0026#39; syntax... role ForElse::Actions { use nqp; use QAST:from; # Utility function... sub lookup(Mu \\match, \\key) { nqp::atkey( nqp::findmethod(match, \u0026#39;hash\u0026#39;)(match), key ).?ast } # New actions when a \u0026#39;for\u0026#39; is parsed... method statement_control:sym (Mu $match) { my $forloop := callsame; if lookup($match, \u0026#39;elseblock\u0026#39;) -\u0026gt; $elseblock { match.make: QAST::Op.new: :op\u0026lt;unless\u0026gt;, $forloop, QAST::Op.new: :op\u0026lt;call\u0026gt;, $elseblock } } } 在我们的新动作角色中，我们要做的第一件事就是加载 nqp 和 QAST 模块的设施。NQP 是 Raku 的 \u0026ldquo;Not Quite Perl\u0026quot;子集，大部分的 Raku 编译器都是用它编写的。QAST 是 \u0026ldquo;Quisquous 抽象语法树\u0026rdquo;，表示操作码和参数，所有的 Raku 代码都是在编译器中被还原的。由于我们正在有效地升级编译器以处理我们的新语法，我们将需要通过 NQP 命令来访问这些语法组件。而且，为了实现我们的新行为，我们需要建立一个合适的 QAST 结构。\n首先，我们建立一个简单的实用函数（lookup），它从语法中获取一个模式匹配，并试图从该匹配中检索特定命名子匹配的抽象语法树。请注意，因为这段代码将被插入到编译器中，所以它不能依赖于通常的 Raku 数据结构和访问方法。相反，我们需要使用底层的 NQP 访问函数。在这种情况下，实用程序首先定位提取匹配对象的哈希类成分的函数(nqp::findmethod(match, 'hash'))，然后在匹配数据结构((match))上调用该哈希提取函数，然后对产生的哈希进行键查找(nqp::atkey(..., key))，然后尝试检索与该匹配相关的抽象语法树(...?ast)。\n一旦我们有了这种从语法匹配中提取特定成分的能力，我们就可以写一个方法，把 for.. else 匹配的各个部分拉出来，并把它们重新排列成一个合适的 QAST 表示。这个方法必须与它所处理的匹配规则同名，所以我们声明:\nmethod statement_control:sym\u0026lt;for\u0026gt; (Mu $match) {...} 该方法将相应语法规则产生的匹配对象作为唯一的参数。我们声明该参数的类型为 Mu（整个 Raku 层次结构的根类型），因为它是一个 NQP 对象，而且 Raku 类型系统不会以其他方式传递它。请注意，我们不能从 $match 参数中省略类型声明，因为那样的话，它将默认为类型为 Any，这在这种情况下就太特殊了。\n一旦我们有了 match 对象，为了把解析后的 match 变成合适的 QAST 对象，我们需要做的第一件事就是转换 for 组件。但是标准的 Raku 解析器已经知道如何做到这一点，所以我们可以通过调用 callsame 告诉它回到以前的行为。\n那个重发的调用将返回一个代表 for 循环的 QAST 对象，并且还将安装同一个 QAST 对象作为 $match 对象的新抽象语法树。由于我们可能需要覆盖该行为（如果涉及到一个 else），我们保留 for 循环的 QAST 对象，通过将其别名为 $forloop。\nmy $forloop := callsame; 然后我们需要发现解析器是否真的找到了一个 else 块，我们通过使用 $match object(lookup($match, 'elseblock')) 来寻找一个名为 \u0026rsquo;elseblock\u0026rsquo; 的捕获。如果在 for 之后有一个 else，我们需要建立一个 QAST 结构，只有在 for 循环没有执行的情况下才执行 else 块。用伪代码来说，就是:\nunless forloop call elseblock 而在QAST中也完全一样:\nQAST::Op.new: :op\u0026lt;unless\u0026gt;, $forloop, QAST::Op.new: :op\u0026lt;call\u0026gt;, $elseblock 也就是说，我们建立一个新的 QAST unless 操作(QAST::Op.new::op\u0026lt;unless\u0026gt;)，并传递给它两个必要的操作数。\n一个 QAST 对象，代表要测试的条件。\n一个 QAST 对象，表示如果该条件为 false，该怎么做。\n在这种情况下，第一个参数（条件）是我们从 callsame 得到的 QAST 对象；实现整个 for 循环的 QAST 对象（即$forloop）。 第二个参数（要做什么）是一个新的QAST对象，实现了对 else 块的调用（即 QAST::Op.new::op\u0026lt;call\u0026gt;, $elseblock）。\n一旦我们建立了那个 QAST 结构，我们只需将它安装为原始匹配的抽象语法树（$match.make:...）。\n就这样了。当扩展语法中新的 statement_control:syn\u0026lt;for\u0026gt; 规则成功匹配时，编译器将调用扩展动作中等价的 statement_control:syn\u0026lt;for\u0026gt; 方法，将解析后的语法转换为实现扩展行为的 QAST。\n当然，前提是我们真的扩展了语法和它的动作。这一点我们还没有做到。\n但是，就像 Raku 中的大多数事情一样，实际扩展语法和它的行为并不难做到。我们的目标是拥有一个模块（我们称它为： Slang::ForElse），它可以将我们的新方言安装到任何使用它的词法范围内。\n{ use Slang::ForElse; for @values { .say; } else { say \u0026#39;No values\u0026#39;; } } 该模块需要修改 $*LANG 对象来安装一个增强的主语法和相应的扩展动作。具体来说，该模块需要调用 $*LANG 对象的 .define_slang 方法，向其传递要修改的俚语的名称（在本例中：\u0026ldquo;MAIN\u0026rdquo; 方言），以及要为该方言安装的新语法和动作。\n我们需要在每次使用该模块时调用 .define_slang 方法。所以我们应该把调用放在模块的 EXPORT 子程序中。像这样:\nsub EXPORT () { $*LANG.define_slang: \u0026#34;MAIN\u0026#34;, $*LANG.slangs\u0026lt;MAIN\u0026gt; but ForElse::Grammar, $*LANG.slangs\u0026lt;MAIN-actions\u0026gt; but ForElse::Actions; return hash(); } 这个子程序调用 $*LANG 对象的 .define_slang 方法，要求它更新 \u0026ldquo;MAIN\u0026rdquo; 方言的定义。第二个参数是要安装的语法，它只是当前的 \u0026ldquo;MAIN\u0026quot;语法($*LANG.slangs\u0026lt;MAIN\u0026gt;)，但其中混入了新的 for..else 语法(but ForElse::Grammar)。第三个参数是要安装的 actions 对象，它只是当前的 \u0026ldquo;MAIN-actions\u0026rdquo; 对象 ($*LANG.slangs\u0026lt;MAIN-actions\u0026gt;)，但其中混入了我们新的 for..else actions。\n混合在一起 (but ForElse::Actions)。\n最后，我们必须确保 EXPORT 子程序返回一个空的哈希值 (hash())，以告诉编译器我们实际上并没有导出任何东西。\n这就是我们的工作。在不到 25 行的时间里，我们修改了 Raku 的语法和语义，增加了一个\u0026quot;缺失\u0026quot;的结构。用其他方式扩展或修改语言来挠其他的痒痒，也就不难了。而且因为每一次扩展或修改都是以词汇的方式进行的，通过将新的行为混合到现有的slangs中，这些额外的功能很可能会相互很好地发挥。\n例如，我们可以同时加载 Slang::ForElse 和 Slang::SQL，然后写:\nuse Slang::ForElse; use Slang::SQL; sql drop table if exists stuff; sql create table if not exists stuff ( id integer, sid varchar(32) ); for @ids { sql insert into stuff (id, sid) values (?, ?); with ($_, (\u0026#39;g\u0026#39;..\u0026#39;Z\u0026#39;).pick(16).join); } else { sql insert into stuff (id, sid) values (?, ?); with (99, \u0026#39;default\u0026#39;); } sql select * from stuff order by id asc; do -\u0026gt; $row { \u0026#34;{$row\u0026lt;id\u0026gt;}\\t{$row\u0026lt;sid\u0026gt;}\u0026#34;.say; }; 定义和部署词法范围的 slangs 的能力使 Raku 具有高度的未来性。任何我们在最初的设计中忘记添加到 Raku 中的东西(比如 for..else!）都可以在以后需要时轻松添加。\n而且 slangs 也有可能使 Raku 与其他工具高度互操作。例如，Raku 有可能成为最终的\u0026quot;胶水语言\u0026rdquo;，通过允许我们切换到那些看起来很像其他编程语言的 slangs，只要这些语言可能更方便编码:\nfor @values -\u0026gt; \\value { use Slang::Python; from math import floor, sqrt def fac(n): step = lambda x: 1 + (x\u0026lt;\u0026lt;2) - ((x\u0026gt;\u0026gt;1)\u0026lt;\u0026lt;1) maxq = long(floor(sqrt(n))) d = 1 q = n % 2 == 0 and 2 or 3 while q \u0026lt;= maxq and n % q != 0: q = step(d) d += 1 return q \u0026lt;= maxq and [q] + fac(n//q) or [n] print(fac(value))) } else { use Slang::Ruby; require \u0026#39;io/console\u0026#39; print \u0026#34;No values. Continue?\u0026#34; loop do case $stdin.getch when \u0026#34;Y\u0026#34; then return when \u0026#34;N\u0026#34; then break else print \u0026#34;\\rNo values. Continue? [YN]\u0026#34; end end } 不幸的是，这些特殊的方言模块还不存在，但是 Python 和 Ruby (以及Perl 5和Lua、Scheme、Go和C)的全功能 Raku 接口已经存在，所以为它们中的每一个编写完全集成的方言将只是一个简单的元编程问题。)\nDamian\n"},"name":"itch-scratch","published":"2019-09-18T23:04:01Z","summary":"在我过去写的一些博客中, 我经常遇到 Raku 不能如我所愿的情况。这是件小事儿, 但是像许多其它的小事儿一样, 它不经常发生但确一直刺激到我。\n在我之前写的东西中, 我使用了一些 Raku 代码完美地阐述了这一点。我需要为 @values 数组中的每个值创建一个对象, 如果 @values 为空, 则创建一个特殊的对象:\nfor @values Z $label,\u0026#34;\u0026#34;,* -\u0026gt; ($value, $label) { Result.new: desc =\u0026gt; \u0026#34;$label ($param.name() = $value)\u0026#34;, value =\u0026gt; timed { $block($value) }, check =\u0026gt; { last if .timing \u0026gt; TIMEOUT } } if !@values { Result.new: desc =\u0026gt; $label, value =\u0026gt; timed { $block(Empty) } } 几乎在同一时间, 在其它我所写的代码中(不在博客里的), 我需要完全相同的结构\u0026hellip;处理数组中的每个元素, 如果数组中没有元素, 则做一些不同的处理:\nfor @errors -\u0026gt; $error { note $error if DEBUG; LAST die X::CompilationFailed.","type":"entry","url":"https://ohmyweekly.github.io/notes/itch-scratch/"}