{"author":{"name":null,"type":"card","url":"https://ohmycloud.github.io/"},"content":{"html":"\u003ch2 id=\"编译-shc\"\u003e编译 SHC\u003c/h2\u003e\n\u003cp\u003e截至目前, Structured Streaming 中的 Sink 还不支持 HBase! Stackoverflow 上有一个解决方案是用第三方的 \u003ca href=\"https://github.com/hortonworks-spark/shc\"\u003eshc\u003c/a\u003e\u003ca href=\"https://stackoverflow.com/questions/47152015/spark-structured-streaming-with-hbase-integration\"\u003e自定义自己的 HBase Sink\u003c/a\u003e。有人按照第二个答案说搞不出来, 我也照着做了一遍, 发现是真的! 继续往下翻, 发现 \u003ca href=\"https://github.com/hortonworks-spark/shc/issues/205#issuecomment-429525553\"\u003egithub\u003c/a\u003e 上有个人做了一丢丢的修改, 于是我照抄了过来:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-scala\" data-lang=\"scala\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003epackage\u003c/span\u003e \u003cspan class=\"nn\"\u003eorg.apache.spark.sql.execution.datasources.hbase\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003eimport\u003c/span\u003e \u003cspan class=\"nn\"\u003eorg.apache.spark.sql.\u003c/span\u003e\u003cspan class=\"o\"\u003e{\u003c/span\u003e\u003cspan class=\"nc\"\u003eDataFrame\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e \u003cspan class=\"nc\"\u003eSQLContext\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e \u003cspan class=\"nc\"\u003eRow\u003c/span\u003e\u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003eimport\u003c/span\u003e \u003cspan class=\"nn\"\u003eorg.apache.spark.sql.execution.streaming.Sink\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003eimport\u003c/span\u003e \u003cspan class=\"nn\"\u003eorg.apache.spark.sql.sources.\u003c/span\u003e\u003cspan class=\"o\"\u003e{\u003c/span\u003e\u003cspan class=\"nc\"\u003eDataSourceRegister\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e \u003cspan class=\"nc\"\u003eStreamSinkProvider\u003c/span\u003e\u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003eimport\u003c/span\u003e \u003cspan class=\"nn\"\u003eorg.apache.spark.sql.streaming.OutputMode\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003eimport\u003c/span\u003e \u003cspan class=\"nn\"\u003eorg.apache.spark.sql.catalyst.CatalystTypeConverters\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eHBaseSink\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eoptions\u003c/span\u003e\u003cspan class=\"k\"\u003e:\u003c/span\u003e \u003cspan class=\"kt\"\u003eMap\u003c/span\u003e\u003cspan class=\"o\"\u003e[\u003c/span\u003e\u003cspan class=\"kt\"\u003eString\u003c/span\u003e, \u003cspan class=\"kt\"\u003eString\u003c/span\u003e\u003cspan class=\"o\"\u003e])\u003c/span\u003e \u003cspan class=\"k\"\u003eextends\u003c/span\u003e \u003cspan class=\"nc\"\u003eSink\u003c/span\u003e \u003cspan class=\"k\"\u003ewith\u003c/span\u003e \u003cspan class=\"nc\"\u003eLogging\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"c1\"\u003e// String with HBaseTableCatalog.tableCatalog\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e  \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003eval\u003c/span\u003e \u003cspan class=\"n\"\u003ehBaseCatalog\u003c/span\u003e \u003cspan class=\"k\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eoptions\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eget\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;hbasecat\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e).\u003c/span\u003e\u003cspan class=\"n\"\u003emap\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003e_\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003etoString\u003c/span\u003e\u003cspan class=\"o\"\u003e).\u003c/span\u003e\u003cspan class=\"n\"\u003egetOrElse\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"k\"\u003eoverride\u003c/span\u003e \u003cspan class=\"k\"\u003edef\u003c/span\u003e \u003cspan class=\"n\"\u003eaddBatch\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ebatchId\u003c/span\u003e\u003cspan class=\"k\"\u003e:\u003c/span\u003e \u003cspan class=\"kt\"\u003eLong\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003edata\u003c/span\u003e\u003cspan class=\"k\"\u003e:\u003c/span\u003e \u003cspan class=\"kt\"\u003eDataFrame\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"k\"\u003e:\u003c/span\u003e \u003cspan class=\"kt\"\u003eUnit\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003esynchronized\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"k\"\u003eval\u003c/span\u003e \u003cspan class=\"n\"\u003eschema\u003c/span\u003e \u003cspan class=\"k\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003edata\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eschema\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"k\"\u003eval\u003c/span\u003e \u003cspan class=\"n\"\u003eres\u003c/span\u003e \u003cspan class=\"k\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003edata\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003equeryExecution\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003etoRdd\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003emapPartitions\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e \u003cspan class=\"n\"\u003erows\u003c/span\u003e \u003cspan class=\"k\"\u003e=\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"k\"\u003eval\u003c/span\u003e \u003cspan class=\"n\"\u003econverter\u003c/span\u003e \u003cspan class=\"k\"\u003e=\u003c/span\u003e \u003cspan class=\"nc\"\u003eCatalystTypeConverters\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ecreateToScalaConverter\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eschema\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"n\"\u003erows\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003emap\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003econverter\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003e_\u003c/span\u003e\u003cspan class=\"o\"\u003e).\u003c/span\u003e\u003cspan class=\"n\"\u003easInstanceOf\u003c/span\u003e\u003cspan class=\"o\"\u003e[\u003c/span\u003e\u003cspan class=\"kt\"\u003eRow\u003c/span\u003e\u003cspan class=\"o\"\u003e])\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"k\"\u003eval\u003c/span\u003e \u003cspan class=\"n\"\u003edf\u003c/span\u003e \u003cspan class=\"k\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003edata\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003esparkSession\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ecreateDataFrame\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eres\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eschema\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"n\"\u003edf\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ewrite\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eoptions\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"nc\"\u003eMap\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"nc\"\u003eHBaseTableCatalog\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003etableCatalog\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003ehBaseCatalog\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"nc\"\u003eHBaseTableCatalog\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003enewTable\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34;5\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eformat\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;org.apache.spark.sql.execution.datasources.hbase\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e).\u003c/span\u003e\u003cspan class=\"n\"\u003esave\u003c/span\u003e\u003cspan class=\"o\"\u003e()\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eHBaseSinkProvider\u003c/span\u003e \u003cspan class=\"k\"\u003eextends\u003c/span\u003e \u003cspan class=\"nc\"\u003eStreamSinkProvider\u003c/span\u003e \u003cspan class=\"k\"\u003ewith\u003c/span\u003e \u003cspan class=\"nc\"\u003eDataSourceRegister\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"k\"\u003edef\u003c/span\u003e \u003cspan class=\"n\"\u003ecreateSink\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                  \u003cspan class=\"n\"\u003esqlContext\u003c/span\u003e\u003cspan class=\"k\"\u003e:\u003c/span\u003e \u003cspan class=\"kt\"\u003eSQLContext\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                  \u003cspan class=\"n\"\u003eparameters\u003c/span\u003e\u003cspan class=\"k\"\u003e:\u003c/span\u003e \u003cspan class=\"kt\"\u003eMap\u003c/span\u003e\u003cspan class=\"o\"\u003e[\u003c/span\u003e\u003cspan class=\"kt\"\u003eString\u003c/span\u003e, \u003cspan class=\"kt\"\u003eString\u003c/span\u003e\u003cspan class=\"o\"\u003e],\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                  \u003cspan class=\"n\"\u003epartitionColumns\u003c/span\u003e\u003cspan class=\"k\"\u003e:\u003c/span\u003e \u003cspan class=\"kt\"\u003eSeq\u003c/span\u003e\u003cspan class=\"o\"\u003e[\u003c/span\u003e\u003cspan class=\"kt\"\u003eString\u003c/span\u003e\u003cspan class=\"o\"\u003e],\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                  \u003cspan class=\"n\"\u003eoutputMode\u003c/span\u003e\u003cspan class=\"k\"\u003e:\u003c/span\u003e \u003cspan class=\"kt\"\u003eOutputMode\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"k\"\u003e:\u003c/span\u003e \u003cspan class=\"kt\"\u003eSink\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nc\"\u003eHBaseSink\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eparameters\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"k\"\u003edef\u003c/span\u003e \u003cspan class=\"n\"\u003eshortName\u003c/span\u003e\u003cspan class=\"o\"\u003e()\u003c/span\u003e\u003cspan class=\"k\"\u003e:\u003c/span\u003e \u003cspan class=\"kt\"\u003eString\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34;hbase\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e把上面的代码起个名字叫 \u003ccode\u003eHBaseSinkProvider.scala\u003c/code\u003e, 放在 \u003ccode\u003eshc/core/src/main/scala/org/apache/spark/sql/execution/datasources/hbase\u003c/code\u003e 目录下：\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"http://photo.fanfou.com/v1/mss_3d027b52ec5a4d589e68050845611e68/ff/n0/0g/qt/er_381775.jpg@596w_1l.jpg\" alt=\"img\"\u003e\u003c/p\u003e\n\u003cp\u003e这个 SHC 也是大坑,\u003c/p\u003e\n\u003cpre tabindex=\"0\"\u003e\u003ccode\u003egit clone https://github.com/hortonworks-spark/shc.git\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e下载完这货用 IDEA 打开之后, 到处都是红色的波浪线。pom 文件也红色感叹号！但是它就是能够编译起来：\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e编译\u003c/li\u003e\n\u003c/ul\u003e\n\u003cpre tabindex=\"0\"\u003e\u003ccode\u003emvn package -DskipTests\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e甚至运行 test：\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e运行 Tests 和 Examples\u003c/li\u003e\n\u003c/ul\u003e\n\u003cpre tabindex=\"0\"\u003e\u003ccode\u003emvn clean package test\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e按照\u003ca href=\"https://github.com/hortonworks-spark/shc\"\u003e文档\u003c/a\u003e 果然没错, 虽然编译测试用了 8 分钟。pom 文件我只该了一处, 就是 spark 的版本号, 我本地是 2.3.2, shc 它 bump 到了最新 2.4.0, 好像不改还不行!\u003c/p\u003e\n\u003cp\u003e按照 \u003ca href=\"https://stackoverflow.com/questions/47152015/spark-structured-streaming-with-hbase-integration/49450254#49450254\"\u003estackoverflow\u003c/a\u003e 这个答案所说, 结合 \u003ca href=\"https://github.com/hortonworks-spark/shc/issues/205#issuecomment-429525553\"\u003e这个补充答案\u003c/a\u003e, 我重新编译了 shc。\u003c/p\u003e\n\u003ch2 id=\"hbase-配置\"\u003eHBase 配置\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003e版本\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e注意我们上面编译 SHC 的时候, pom 文件里面的 HBase 版本是 2.0.2, 所以我们也下载这个\u003ca href=\"http://archive.apache.org/dist/hbase/2.0.2/\"\u003e版本\u003c/a\u003e, 那其它的版本可以吗? 我不知道, 我只知道我使用了 1.2.0, 1.2.8 的都有问题：找不到某个类了, 类没有定义拉之类的。为了少惹麻烦, 我们还是用 2.0.2, 和 SHC 里面的保持一致。\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e配置\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e在 \u003ccode\u003ehbase-env.sh\u003c/code\u003e 中导出 \u003cstrong\u003eJAVA_HOME\u003c/strong\u003e\u003c/p\u003e\n\u003cpre tabindex=\"0\"\u003e\u003ccode\u003eexport JAVA_HOME=/Library/Java/JavaVirtualMachines/jdk1.8.0_144.jdk/Contents/Home\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e在 \u003ccode\u003ehbase-site.xml\u003c/code\u003e 中添加/修改配置如下:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-xml\" data-lang=\"xml\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nt\"\u003e\u0026lt;configuration\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"nt\"\u003e\u0026lt;property\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t  \u003cspan class=\"nt\"\u003e\u0026lt;name\u0026gt;\u003c/span\u003ezookeeper.znode.parent\u003cspan class=\"nt\"\u003e\u0026lt;/name\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t  \u003cspan class=\"nt\"\u003e\u0026lt;value\u0026gt;\u003c/span\u003e/hbase\u003cspan class=\"nt\"\u003e\u0026lt;/value\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"nt\"\u003e\u0026lt;/property\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"nt\"\u003e\u0026lt;property\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nt\"\u003e\u0026lt;name\u0026gt;\u003c/span\u003ehbase.rootdir\u003cspan class=\"nt\"\u003e\u0026lt;/name\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nt\"\u003e\u0026lt;value\u0026gt;\u003c/span\u003e/Users/ohmycloud/opt/tmp/myhbase\u003cspan class=\"nt\"\u003e\u0026lt;/value\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"nt\"\u003e\u0026lt;/property\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"nt\"\u003e\u0026lt;property\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nt\"\u003e\u0026lt;name\u0026gt;\u003c/span\u003ehbase.zookeeper.quorum\u003cspan class=\"nt\"\u003e\u0026lt;/name\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nt\"\u003e\u0026lt;value\u0026gt;\u003c/span\u003elocalhost\u003cspan class=\"nt\"\u003e\u0026lt;/value\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"nt\"\u003e\u0026lt;/property\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"nt\"\u003e\u0026lt;property\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nt\"\u003e\u0026lt;name\u0026gt;\u003c/span\u003ehbase.zookeeper.property.dataDir\u003cspan class=\"nt\"\u003e\u0026lt;/name\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nt\"\u003e\u0026lt;value\u0026gt;\u003c/span\u003e/Users/ohmycloud/opt/tmp/myhbase/zookeeper\u003cspan class=\"nt\"\u003e\u0026lt;/value\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"nt\"\u003e\u0026lt;/property\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"nt\"\u003e\u0026lt;property\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nt\"\u003e\u0026lt;name\u0026gt;\u003c/span\u003ehbase.zookeeper.property.clientPort\u003cspan class=\"nt\"\u003e\u0026lt;/name\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nt\"\u003e\u0026lt;value\u0026gt;\u003c/span\u003e2181\u003cspan class=\"nt\"\u003e\u0026lt;/value\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"nt\"\u003e\u0026lt;/property\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nt\"\u003e\u0026lt;/configuration\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cul\u003e\n\u003cli\u003eZooKeeper\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e写 HBase 的时候, 总是遇到一个报错:\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003eThe node /hbase is not in ZooKeeper. It should have been written by the master. Check the value configured in \u0026lsquo;zookeeper.znode.parent\u0026rsquo;.\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003e原因是 ZooKeeper 里面没有 \u003ccode\u003ehbase\u003c/code\u003e 这个节点！由于我用的是 zookeeper 是用 docker 启的, 所以要查看这个 zookeeper 里面是不是有 \u003ccode\u003ehbase\u003c/code\u003e 节点, 还得多费点电:\u003c/p\u003e\n\u003cpre tabindex=\"0\"\u003e\u003ccode\u003e docker container ls\nCONTAINER ID        IMAGE                    COMMAND                  CREATED             STATUS              PORTS                                                NAMES\n561180d16b55        wurstmeister/kafka       \u0026#34;start-kafka.sh\u0026#34;         About an hour ago   Up About an hour    0.0.0.0:9092-\u0026gt;9092/tcp                               docker_kafka_1\n61a36418ea7f        wurstmeister/zookeeper   \u0026#34;/bin/sh -c \u0026#39;/usr/sb…\u0026#34;   About an hour ago   Up About an hour    22/tcp, 2888/tcp, 3888/tcp, 0.0.0.0:2181-\u0026gt;2181/tcp   docker_zookeeper_1\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e看到 zookeeper 的 container id 为 \u003cstrong\u003e61a36418ea7f\u003c/strong\u003e, 我们直接进入到这个容器中:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-shell\" data-lang=\"shell\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003edocker \u003cspan class=\"nb\"\u003eexec\u003c/span\u003e -it 61a36418ea7f bash \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eroot@61a36418ea7f:/opt/zookeeper-3.4.9# \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e发现可吧, shell 界面变了, 我们进入了 zookeeper 容器中。\u003c/p\u003e\n\u003cp\u003e启动 zookeeper 命令行：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-shell\" data-lang=\"shell\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e./bin/zkCli.sh \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003ccode\u003els\u003c/code\u003e 一下, 列出里面的节点：\u003c/p\u003e\n\u003cpre tabindex=\"0\"\u003e\u003ccode\u003e[log_dir_event_notification, isr_change_notification, zookeeper, admin, consumers, cluster, config, latest_producer_id_block, controller, brokers, controller_epoch]\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e发现没有 \u003ccode\u003ehbase\u003c/code\u003e! 那我们就手动创建一个, 还是在 zookeeper 命令行界面里面:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-shell\" data-lang=\"shell\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ecreate /hbase ohmyhbase\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e然后重启 hbase：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-shell\" data-lang=\"shell\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003esudo ./stop-hbase.sh\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003esudo ./start-hbase.sh\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e然后简单地创建一个测试表：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-shell\" data-lang=\"shell\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ecreate \u003cspan class=\"s2\"\u003e\u0026#34;ohmytest\u0026#34;\u003c/span\u003e, \u003cspan class=\"o\"\u003e{\u003c/span\u003e\u003cspan class=\"nv\"\u003eNAME\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u0026gt;\u003cspan class=\"s1\"\u003e\u0026#39;info\u0026#39;\u003c/span\u003e\u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2 id=\"structurd-streaming-程序\"\u003eStructurd Streaming 程序\u003c/h2\u003e\n\u003cp\u003e这个程序就是个测试用的, 它读取本地的 Parquet 文件, 选取部分字段写到 HBase:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-scala\" data-lang=\"scala\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003epackage\u003c/span\u003e \u003cspan class=\"nn\"\u003eohmysummer.utils\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003eimport\u003c/span\u003e \u003cspan class=\"nn\"\u003eohmysummer.pipeline.schema.ParquetSchema\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003eimport\u003c/span\u003e \u003cspan class=\"nn\"\u003eorg.apache.spark.sql._\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003eimport\u003c/span\u003e \u003cspan class=\"nn\"\u003eorg.apache.spark.sql.streaming.\u003c/span\u003e\u003cspan class=\"o\"\u003e{\u003c/span\u003e\u003cspan class=\"nc\"\u003eOutputMode\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e \u003cspan class=\"nc\"\u003eTrigger\u003c/span\u003e\u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cm\"\u003e/**\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cm\"\u003e  * 读取 parquet 文件写到 HBase\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cm\"\u003e  */\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003eobject\u003c/span\u003e \u003cspan class=\"nc\"\u003eWriteParquet2Hbase\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"k\"\u003edef\u003c/span\u003e \u003cspan class=\"n\"\u003emain\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eargs\u003c/span\u003e\u003cspan class=\"k\"\u003e:\u003c/span\u003e \u003cspan class=\"kt\"\u003eArray\u003c/span\u003e\u003cspan class=\"o\"\u003e[\u003c/span\u003e\u003cspan class=\"kt\"\u003eString\u003c/span\u003e\u003cspan class=\"o\"\u003e])\u003c/span\u003e\u003cspan class=\"k\"\u003e:\u003c/span\u003e \u003cspan class=\"kt\"\u003eUnit\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"k\"\u003eval\u003c/span\u003e \u003cspan class=\"n\"\u003espark\u003c/span\u003e\u003cspan class=\"k\"\u003e:\u003c/span\u003e \u003cspan class=\"kt\"\u003eSparkSession\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"nc\"\u003eSparkSession\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ebuilder\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003emaster\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;local[2]\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eappName\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;Write Parquet to HBase using Structured Streaming\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003econfig\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;spark.driver.host\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34;localhost\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003egetOrCreate\u003c/span\u003e\u003cspan class=\"o\"\u003e()\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"k\"\u003eval\u003c/span\u003e \u003cspan class=\"n\"\u003eparquetSchema\u003c/span\u003e \u003cspan class=\"k\"\u003e=\u003c/span\u003e \u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nc\"\u003eParquetSchema\u003c/span\u003e\u003cspan class=\"o\"\u003e).\u003c/span\u003e\u003cspan class=\"n\"\u003eschema\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"k\"\u003eval\u003c/span\u003e \u003cspan class=\"n\"\u003eds\u003c/span\u003e\u003cspan class=\"k\"\u003e:\u003c/span\u003e \u003cspan class=\"kt\"\u003eDataFrame\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003espark\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ereadStream\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eschema\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eparquetSchema\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eparquet\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;/Users/ohmycloud/work/cihon/gac/data/decoded/vintype=A5HEVAVNT/d=20180825\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"k\"\u003eimport\u003c/span\u003e \u003cspan class=\"nn\"\u003espark.implicits._\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"k\"\u003eval\u003c/span\u003e \u003cspan class=\"n\"\u003edf2\u003c/span\u003e\u003cspan class=\"k\"\u003e:\u003c/span\u003e \u003cspan class=\"kt\"\u003eDataFrame\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eds\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eselect\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"n\"\u003e$\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;vin\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"n\"\u003e$\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;veh_spd\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"n\"\u003e$\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;veh_soc\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"n\"\u003e$\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;loc_lon84\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"n\"\u003e$\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;loc_lat84\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"k\"\u003edef\u003c/span\u003e \u003cspan class=\"n\"\u003ecatalog\u003c/span\u003e \u003cspan class=\"k\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003es\u0026#34;\u0026#34;\u0026#34;{\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e                     |\u0026#34;table\u0026#34;:{\u0026#34;namespace\u0026#34;:\u0026#34;default\u0026#34;, \u0026#34;name\u0026#34;:\u0026#34;ohmytest\u0026#34;},\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e                     |\u0026#34;rowkey\u0026#34;:\u0026#34;vin\u0026#34;,\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e                     |\u0026#34;columns\u0026#34;:{\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e                     |\u0026#34;vin\u0026#34;:{\u0026#34;cf\u0026#34;:\u0026#34;rowkey\u0026#34;, \u0026#34;col\u0026#34;:\u0026#34;vin\u0026#34;, \u0026#34;type\u0026#34;:\u0026#34;string\u0026#34;},\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e                     |\u0026#34;veh_spd\u0026#34;:{\u0026#34;cf\u0026#34;:\u0026#34;info\u0026#34;, \u0026#34;col\u0026#34;:\u0026#34;veh_spd\u0026#34;, \u0026#34;type\u0026#34;:\u0026#34;string\u0026#34;},\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e                     |\u0026#34;veh_soc\u0026#34;:{\u0026#34;cf\u0026#34;:\u0026#34;info\u0026#34;, \u0026#34;col\u0026#34;:\u0026#34;veh_soc\u0026#34;, \u0026#34;type\u0026#34;:\u0026#34;string\u0026#34;},\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e                     |\u0026#34;loc_lon84\u0026#34;:{\u0026#34;cf\u0026#34;:\u0026#34;info\u0026#34;, \u0026#34;col\u0026#34;:\u0026#34;loc_lon84\u0026#34;, \u0026#34;type\u0026#34;:\u0026#34;string\u0026#34;},\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e                     |\u0026#34;loc_lat84\u0026#34;:{\u0026#34;cf\u0026#34;:\u0026#34;info\u0026#34;, \u0026#34;col\u0026#34;:\u0026#34;loc_lat84\u0026#34;, \u0026#34;type\u0026#34;:\u0026#34;string\u0026#34;}\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e                     |}\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e                     |}\u0026#34;\u0026#34;\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003estripMargin\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"k\"\u003eval\u003c/span\u003e \u003cspan class=\"n\"\u003eddf\u003c/span\u003e \u003cspan class=\"k\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003edf2\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ewriteStream\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003equeryName\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;hbase writer\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eformat\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;org.apache.spark.sql.execution.datasources.hbase.HBaseSinkProvider\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eoption\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;checkpointLocation\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34;/tmp/gac\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eoption\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;hbasecat\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ecatalog\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eoutputMode\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"nc\"\u003eOutputMode\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"nc\"\u003eAppend\u003c/span\u003e\u003cspan class=\"o\"\u003e())\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003etrigger\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"nc\"\u003eTrigger\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"nc\"\u003eProcessingTime\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;30 seconds\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003estart\u003c/span\u003e\u003cspan class=\"o\"\u003e()\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"n\"\u003eddf\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eawaitTermination\u003c/span\u003e\u003cspan class=\"o\"\u003e()\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e提交命令：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-shell\" data-lang=\"shell\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003espark-submit \u003cspan class=\"se\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"se\"\u003e\u003c/span\u003e--class ohmysummer.utils.WriteParquet2Hbase \u003cspan class=\"se\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"se\"\u003e\u003c/span\u003e--jars /Users/ohmycloud/Downloads/shc/core/target/shc-core-1.1.3-2.3-s_2.11.jar \u003cspan class=\"se\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"se\"\u003e\u003c/span\u003e--master local\u003cspan class=\"o\"\u003e[\u003c/span\u003e2\u003cspan class=\"o\"\u003e]\u003c/span\u003e  \u003cspan class=\"se\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"se\"\u003e\u003c/span\u003e--driver-memory 2g \u003cspan class=\"se\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"se\"\u003e\u003c/span\u003e--driver-cores \u003cspan class=\"m\"\u003e2\u003c/span\u003e \u003cspan class=\"se\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"se\"\u003e\u003c/span\u003e--executor-memory 2g \u003cspan class=\"se\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"se\"\u003e\u003c/span\u003e--executor-cores \u003cspan class=\"m\"\u003e2\u003c/span\u003e \u003cspan class=\"se\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"se\"\u003e\u003c/span\u003e--num-executors \u003cspan class=\"m\"\u003e2\u003c/span\u003e \u003cspan class=\"se\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"se\"\u003e\u003c/span\u003e--files /Users/ohmycloud/opt/hbase-2.0.2/conf/hbase-site.xml  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003etarget/socket-structured-streaming-1.0-SNAPSHOT.jar\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e这一小段我运行了几十次, 每次都失败了, 就在半个小时前, 终于修复好了, 能写到 HBase 了, 因为它打印了一段这样的信息, 我就知道有普了：\u003c/p\u003e\n\u003cpre tabindex=\"0\"\u003e\u003ccode\u003e2018-12-11 17:19:30 INFO  MicroBatchExecution:54 - Streaming query made progress: {\n  \u0026#34;id\u0026#34; : \u0026#34;eb3f8490-eecb-407e-879f-c1e2404e9590\u0026#34;,\n  \u0026#34;runId\u0026#34; : \u0026#34;b81a766e-3c8a-44eb-979d-9988c8af6f1a\u0026#34;,\n  \u0026#34;name\u0026#34; : \u0026#34;hbase writer\u0026#34;,\n  \u0026#34;timestamp\u0026#34; : \u0026#34;2018-12-11T09:19:30.002Z\u0026#34;,\n  \u0026#34;batchId\u0026#34; : 1,\n  \u0026#34;numInputRows\u0026#34; : 0,\n  \u0026#34;inputRowsPerSecond\u0026#34; : 0.0,\n  \u0026#34;processedRowsPerSecond\u0026#34; : 0.0,\n  \u0026#34;durationMs\u0026#34; : {\n    \u0026#34;getOffset\u0026#34; : 6,\n    \u0026#34;triggerExecution\u0026#34; : 7\n  },\n  \u0026#34;stateOperators\u0026#34; : [ ],\n  \u0026#34;sources\u0026#34; : [ {\n    \u0026#34;description\u0026#34; : \u0026#34;FileStreamSource[file:/Users/ohmycloud/work/cihon/gac/data/decoded/vintype=A5HEVAVNT/d=20180825]\u0026#34;,\n    \u0026#34;startOffset\u0026#34; : {\n      \u0026#34;logOffset\u0026#34; : 0\n    },\n    \u0026#34;endOffset\u0026#34; : {\n      \u0026#34;logOffset\u0026#34; : 0\n    },\n    \u0026#34;numInputRows\u0026#34; : 0,\n    \u0026#34;inputRowsPerSecond\u0026#34; : 0.0,\n    \u0026#34;processedRowsPerSecond\u0026#34; : 0.0\n  } ],\n  \u0026#34;sink\u0026#34; : {\n    \u0026#34;description\u0026#34; : \u0026#34;org.apache.spark.sql.execution.datasources.hbase.HBaseSink@5ab0cadb\u0026#34;\n  }\n}\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e到 hbase shell 中 scan 一下, 看到结果了：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-shell\" data-lang=\"shell\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ehbase\u003cspan class=\"o\"\u003e(\u003c/span\u003emain\u003cspan class=\"o\"\u003e)\u003c/span\u003e:016:0\u0026gt; scan \u003cspan class=\"s1\"\u003e\u0026#39;ohmytest\u0026#39;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eROW                                                  COLUMN+CELL                                                                                                                                            \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e LMWHP1S88J1S00013                                   \u003cspan class=\"nv\"\u003ecolumn\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003einfo:loc_lat84, \u003cspan class=\"nv\"\u003etimestamp\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e1544517115189, \u003cspan class=\"nv\"\u003evalue\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e@7\u003cspan class=\"se\"\u003e\\x\u003c/span\u003e1A\u003cspan class=\"se\"\u003e\\x\u003c/span\u003eF5U\u003cspan class=\"se\"\u003e\\x\u003c/span\u003e82\u003cspan class=\"se\"\u003e\\x\u003c/span\u003e12\u003cspan class=\"se\"\u003e\\x\u003c/span\u003e\u003cspan class=\"m\"\u003e94\u003c/span\u003e                                                                          \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e LMWHP1S88J1S00013                                   \u003cspan class=\"nv\"\u003ecolumn\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003einfo:loc_lon84, \u003cspan class=\"nv\"\u003etimestamp\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e1544517115189, \u003cspan class=\"nv\"\u003evalue\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e@\u003cspan class=\"se\"\u003e\\x\u003c/span\u003e5C\u003cspan class=\"se\"\u003e\\x\u003c/span\u003e5C\u003cspan class=\"se\"\u003e\\x\u003c/span\u003e87L\u003cspan class=\"se\"\u003e\\x\u003c/span\u003e8F\u003cspan class=\"se\"\u003e\\x\u003c/span\u003eFB\u003cspan class=\"se\"\u003e\\x\u003c/span\u003e8B                                                                       \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e LMWHP1S88J1S00013                                   \u003cspan class=\"nv\"\u003ecolumn\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003einfo:veh_soc, \u003cspan class=\"nv\"\u003etimestamp\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e1544517115189, \u003cspan class=\"nv\"\u003evalue\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"se\"\u003e\\x\u003c/span\u003e00\u003cspan class=\"se\"\u003e\\x\u003c/span\u003e00\u003cspan class=\"se\"\u003e\\x\u003c/span\u003e00U                                                                                      \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e LMWHP1S88J1S00013                                   \u003cspan class=\"nv\"\u003ecolumn\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003einfo:veh_spd, \u003cspan class=\"nv\"\u003etimestamp\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e1544517115189, \u003cspan class=\"nv\"\u003evalue\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"se\"\u003e\\x\u003c/span\u003e00\u003cspan class=\"se\"\u003e\\x\u003c/span\u003e00\u003cspan class=\"se\"\u003e\\x\u003c/span\u003e00\u003cspan class=\"se\"\u003e\\x\u003c/span\u003e00\u003cspan class=\"se\"\u003e\\x\u003c/span\u003e00\u003cspan class=\"se\"\u003e\\x\u003c/span\u003e00\u003cspan class=\"se\"\u003e\\x\u003c/span\u003e00\u003cspan class=\"se\"\u003e\\x\u003c/span\u003e\u003cspan class=\"m\"\u003e00\u003c/span\u003e                                                                                                                                                                                                                                                          \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ehbase\u003cspan class=\"o\"\u003e(\u003c/span\u003emain\u003cspan class=\"o\"\u003e)\u003c/span\u003e:017:0\u0026gt; \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2 id=\"pom-文件\"\u003epom 文件\u003c/h2\u003e\n\u003cp\u003e主要是 hbase 的依赖：\u003c/p\u003e\n\u003cpre tabindex=\"0\"\u003e\u003ccode\u003e\n        \u0026lt;!-- https://mvnrepository.com/artifact/org.apache.hbase/hbase --\u0026gt;\n        \u0026lt;dependency\u0026gt;\n            \u0026lt;groupId\u0026gt;org.apache.hbase\u0026lt;/groupId\u0026gt;\n            \u0026lt;artifactId\u0026gt;hbase\u0026lt;/artifactId\u0026gt;\n            \u0026lt;version\u0026gt;${hbase.version}\u0026lt;/version\u0026gt;\n            \u0026lt;type\u0026gt;pom\u0026lt;/type\u0026gt;\n        \u0026lt;/dependency\u0026gt;\n\n        \u0026lt;!-- https://mvnrepository.com/artifact/org.apache.hbase/hbase-server --\u0026gt;\n        \u0026lt;dependency\u0026gt;\n            \u0026lt;groupId\u0026gt;org.apache.hbase\u0026lt;/groupId\u0026gt;\n            \u0026lt;artifactId\u0026gt;hbase-server\u0026lt;/artifactId\u0026gt;\n            \u0026lt;version\u0026gt;${hbase.version}\u0026lt;/version\u0026gt;\n        \u0026lt;/dependency\u0026gt;\n\n        \u0026lt;!-- https://mvnrepository.com/artifact/org.apache.hbase/hbase-client --\u0026gt;\n        \u0026lt;dependency\u0026gt;\n            \u0026lt;groupId\u0026gt;org.apache.hbase\u0026lt;/groupId\u0026gt;\n            \u0026lt;artifactId\u0026gt;hbase-client\u0026lt;/artifactId\u0026gt;\n            \u0026lt;version\u0026gt;${hbase.version}\u0026lt;/version\u0026gt;\n        \u0026lt;/dependency\u0026gt;\n\n        \u0026lt;!-- https://mvnrepository.com/artifact/org.apache.hbase/hbase-common --\u0026gt;\n        \u0026lt;dependency\u0026gt;\n            \u0026lt;groupId\u0026gt;org.apache.hbase\u0026lt;/groupId\u0026gt;\n            \u0026lt;artifactId\u0026gt;hbase-common\u0026lt;/artifactId\u0026gt;\n            \u0026lt;version\u0026gt;${hbase.version}\u0026lt;/version\u0026gt;\n        \u0026lt;/dependency\u0026gt;\n\n        \u0026lt;!-- https://mvnrepository.com/artifact/org.apache.hbase/hbase-mapreduce --\u0026gt;\n        \u0026lt;dependency\u0026gt;\n            \u0026lt;groupId\u0026gt;org.apache.hbase\u0026lt;/groupId\u0026gt;\n            \u0026lt;artifactId\u0026gt;hbase-mapreduce\u0026lt;/artifactId\u0026gt;\n            \u0026lt;version\u0026gt;${hbase.version}\u0026lt;/version\u0026gt;\n        \u0026lt;/dependency\u0026gt;\n\u003c/code\u003e\u003c/pre\u003e","text":"编译 SHC 截至目前, Structured Streaming 中的 Sink 还不支持 HBase! Stackoverflow 上有一个解决方案是用第三方的 shc自定义自己的 HBase Sink。有人按照第二个答案说搞不出来, 我也照着做了一遍, 发现是真的! 继续往下翻, 发现 github 上有个人做了一丢丢的修改, 于是我照抄了过来:\npackage org.apache.spark.sql.execution.datasources.hbase import org.apache.spark.sql.{DataFrame, SQLContext, Row} import org.apache.spark.sql.execution.streaming.Sink import org.apache.spark.sql.sources.{DataSourceRegister, StreamSinkProvider} import org.apache.spark.sql.streaming.OutputMode import org.apache.spark.sql.catalyst.CatalystTypeConverters class HBaseSink(options: Map[String, String]) extends Sink with Logging { // String with HBaseTableCatalog.tableCatalog private val hBaseCatalog = options.get(\u0026#34;hbasecat\u0026#34;).map(_.toString).getOrElse(\u0026#34;\u0026#34;) override def addBatch(batchId: Long, data: DataFrame): Unit = synchronized { val schema = data.schema val res = data.queryExecution.toRdd.mapPartitions { rows =\u0026gt; val converter = CatalystTypeConverters.createToScalaConverter(schema) rows.map(converter(_).asInstanceOf[Row]) } val df = data.sparkSession.createDataFrame(res, schema) df.write .options(Map(HBaseTableCatalog.tableCatalog-\u0026gt;hBaseCatalog, HBaseTableCatalog.newTable -\u0026gt; \u0026#34;5\u0026#34;)) .format(\u0026#34;org.apache.spark.sql.execution.datasources.hbase\u0026#34;).save() } } class HBaseSinkProvider extends StreamSinkProvider with DataSourceRegister { def createSink( sqlContext: SQLContext, parameters: Map[String, String], partitionColumns: Seq[String], outputMode: OutputMode): Sink = { new HBaseSink(parameters) } def shortName(): String = \u0026#34;hbase\u0026#34; } 把上面的代码起个名字叫 HBaseSinkProvider.scala, 放在 shc/core/src/main/scala/org/apache/spark/sql/execution/datasources/hbase 目录下：\n这个 SHC 也是大坑,\ngit clone https://github.com/hortonworks-spark/shc.git 下载完这货用 IDEA 打开之后, 到处都是红色的波浪线。pom 文件也红色感叹号！但是它就是能够编译起来：\n编译 mvn package -DskipTests 甚至运行 test：\n运行 Tests 和 Examples mvn clean package test 按照文档 果然没错, 虽然编译测试用了 8 分钟。pom 文件我只该了一处, 就是 spark 的版本号, 我本地是 2.3.2, shc 它 bump 到了最新 2.4.0, 好像不改还不行!\n按照 stackoverflow 这个答案所说, 结合 这个补充答案, 我重新编译了 shc。\nHBase 配置 版本 注意我们上面编译 SHC 的时候, pom 文件里面的 HBase 版本是 2.0.2, 所以我们也下载这个版本, 那其它的版本可以吗? 我不知道, 我只知道我使用了 1.2.0, 1.2.8 的都有问题：找不到某个类了, 类没有定义拉之类的。为了少惹麻烦, 我们还是用 2.0.2, 和 SHC 里面的保持一致。\n配置 在 hbase-env.sh 中导出 JAVA_HOME\nexport JAVA_HOME=/Library/Java/JavaVirtualMachines/jdk1.8.0_144.jdk/Contents/Home 在 hbase-site.xml 中添加/修改配置如下:\n\u0026lt;configuration\u0026gt; \u0026lt;property\u0026gt; \u0026lt;name\u0026gt;zookeeper.znode.parent\u0026lt;/name\u0026gt; \u0026lt;value\u0026gt;/hbase\u0026lt;/value\u0026gt; \u0026lt;/property\u0026gt; \u0026lt;property\u0026gt; \u0026lt;name\u0026gt;hbase.rootdir\u0026lt;/name\u0026gt; \u0026lt;value\u0026gt;/Users/ohmycloud/opt/tmp/myhbase\u0026lt;/value\u0026gt; \u0026lt;/property\u0026gt; \u0026lt;property\u0026gt; \u0026lt;name\u0026gt;hbase.zookeeper.quorum\u0026lt;/name\u0026gt; \u0026lt;value\u0026gt;localhost\u0026lt;/value\u0026gt; \u0026lt;/property\u0026gt; \u0026lt;property\u0026gt; \u0026lt;name\u0026gt;hbase.zookeeper.property.dataDir\u0026lt;/name\u0026gt; \u0026lt;value\u0026gt;/Users/ohmycloud/opt/tmp/myhbase/zookeeper\u0026lt;/value\u0026gt; \u0026lt;/property\u0026gt; \u0026lt;property\u0026gt; \u0026lt;name\u0026gt;hbase.zookeeper.property.clientPort\u0026lt;/name\u0026gt; \u0026lt;value\u0026gt;2181\u0026lt;/value\u0026gt; \u0026lt;/property\u0026gt; \u0026lt;/configuration\u0026gt; ZooKeeper 写 HBase 的时候, 总是遇到一个报错:\nThe node /hbase is not in ZooKeeper. It should have been written by the master. Check the value configured in \u0026lsquo;zookeeper.znode.parent\u0026rsquo;.\n原因是 ZooKeeper 里面没有 hbase 这个节点！由于我用的是 zookeeper 是用 docker 启的, 所以要查看这个 zookeeper 里面是不是有 hbase 节点, 还得多费点电:\ndocker container ls CONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES 561180d16b55 wurstmeister/kafka \u0026#34;start-kafka.sh\u0026#34; About an hour ago Up About an hour 0.0.0.0:9092-\u0026gt;9092/tcp docker_kafka_1 61a36418ea7f wurstmeister/zookeeper \u0026#34;/bin/sh -c \u0026#39;/usr/sb…\u0026#34; About an hour ago Up About an hour 22/tcp, 2888/tcp, 3888/tcp, 0.0.0.0:2181-\u0026gt;2181/tcp docker_zookeeper_1 看到 zookeeper 的 container id 为 61a36418ea7f, 我们直接进入到这个容器中:\ndocker exec -it 61a36418ea7f bash root@61a36418ea7f:/opt/zookeeper-3.4.9# 发现可吧, shell 界面变了, 我们进入了 zookeeper 容器中。\n启动 zookeeper 命令行：\n./bin/zkCli.sh ls 一下, 列出里面的节点：\n[log_dir_event_notification, isr_change_notification, zookeeper, admin, consumers, cluster, config, latest_producer_id_block, controller, brokers, controller_epoch] 发现没有 hbase! 那我们就手动创建一个, 还是在 zookeeper 命令行界面里面:\ncreate /hbase ohmyhbase 然后重启 hbase：\nsudo ./stop-hbase.sh sudo ./start-hbase.sh 然后简单地创建一个测试表：\ncreate \u0026#34;ohmytest\u0026#34;, {NAME=\u0026gt;\u0026#39;info\u0026#39;} Structurd Streaming 程序 这个程序就是个测试用的, 它读取本地的 Parquet 文件, 选取部分字段写到 HBase:\npackage ohmysummer.utils import ohmysummer.pipeline.schema.ParquetSchema import org.apache.spark.sql._ import org.apache.spark.sql.streaming.{OutputMode, Trigger} /** * 读取 parquet 文件写到 HBase */ object WriteParquet2Hbase { def main(args: Array[String]): Unit = { val spark: SparkSession = SparkSession .builder .master(\u0026#34;local[2]\u0026#34;) .appName(\u0026#34;Write Parquet to HBase using Structured Streaming\u0026#34;) .config(\u0026#34;spark.driver.host\u0026#34;, \u0026#34;localhost\u0026#34;) .getOrCreate() val parquetSchema = (new ParquetSchema).schema val ds: DataFrame = spark.readStream .schema(parquetSchema) .parquet(\u0026#34;/Users/ohmycloud/work/cihon/gac/data/decoded/vintype=A5HEVAVNT/d=20180825\u0026#34;) import spark.implicits._ val df2: DataFrame = ds.select( $\u0026#34;vin\u0026#34;, $\u0026#34;veh_spd\u0026#34;, $\u0026#34;veh_soc\u0026#34;, $\u0026#34;loc_lon84\u0026#34;, $\u0026#34;loc_lat84\u0026#34; ) def catalog = s\u0026#34;\u0026#34;\u0026#34;{ |\u0026#34;table\u0026#34;:{\u0026#34;namespace\u0026#34;:\u0026#34;default\u0026#34;, \u0026#34;name\u0026#34;:\u0026#34;ohmytest\u0026#34;}, |\u0026#34;rowkey\u0026#34;:\u0026#34;vin\u0026#34;, |\u0026#34;columns\u0026#34;:{ |\u0026#34;vin\u0026#34;:{\u0026#34;cf\u0026#34;:\u0026#34;rowkey\u0026#34;, \u0026#34;col\u0026#34;:\u0026#34;vin\u0026#34;, \u0026#34;type\u0026#34;:\u0026#34;string\u0026#34;}, |\u0026#34;veh_spd\u0026#34;:{\u0026#34;cf\u0026#34;:\u0026#34;info\u0026#34;, \u0026#34;col\u0026#34;:\u0026#34;veh_spd\u0026#34;, \u0026#34;type\u0026#34;:\u0026#34;string\u0026#34;}, |\u0026#34;veh_soc\u0026#34;:{\u0026#34;cf\u0026#34;:\u0026#34;info\u0026#34;, \u0026#34;col\u0026#34;:\u0026#34;veh_soc\u0026#34;, \u0026#34;type\u0026#34;:\u0026#34;string\u0026#34;}, |\u0026#34;loc_lon84\u0026#34;:{\u0026#34;cf\u0026#34;:\u0026#34;info\u0026#34;, \u0026#34;col\u0026#34;:\u0026#34;loc_lon84\u0026#34;, \u0026#34;type\u0026#34;:\u0026#34;string\u0026#34;}, |\u0026#34;loc_lat84\u0026#34;:{\u0026#34;cf\u0026#34;:\u0026#34;info\u0026#34;, \u0026#34;col\u0026#34;:\u0026#34;loc_lat84\u0026#34;, \u0026#34;type\u0026#34;:\u0026#34;string\u0026#34;} |} |}\u0026#34;\u0026#34;\u0026#34;.stripMargin val ddf = df2.writeStream .queryName(\u0026#34;hbase writer\u0026#34;) .format(\u0026#34;org.apache.spark.sql.execution.datasources.hbase.HBaseSinkProvider\u0026#34;) .option(\u0026#34;checkpointLocation\u0026#34;, \u0026#34;/tmp/gac\u0026#34;) .option(\u0026#34;hbasecat\u0026#34;, catalog) .outputMode(OutputMode.Append()) .trigger(Trigger.ProcessingTime(\u0026#34;30 seconds\u0026#34;)) .start() ddf.awaitTermination() } } 提交命令：\nspark-submit \\ --class ohmysummer.utils.WriteParquet2Hbase \\ --jars /Users/ohmycloud/Downloads/shc/core/target/shc-core-1.1.3-2.3-s_2.11.jar \\ --master local[2] \\ --driver-memory 2g \\ --driver-cores 2 \\ --executor-memory 2g \\ --executor-cores 2 \\ --num-executors 2 \\ --files /Users/ohmycloud/opt/hbase-2.0.2/conf/hbase-site.xml target/socket-structured-streaming-1.0-SNAPSHOT.jar 这一小段我运行了几十次, 每次都失败了, 就在半个小时前, 终于修复好了, 能写到 HBase 了, 因为它打印了一段这样的信息, 我就知道有普了：\n2018-12-11 17:19:30 INFO MicroBatchExecution:54 - Streaming query made progress: { \u0026#34;id\u0026#34; : \u0026#34;eb3f8490-eecb-407e-879f-c1e2404e9590\u0026#34;, \u0026#34;runId\u0026#34; : \u0026#34;b81a766e-3c8a-44eb-979d-9988c8af6f1a\u0026#34;, \u0026#34;name\u0026#34; : \u0026#34;hbase writer\u0026#34;, \u0026#34;timestamp\u0026#34; : \u0026#34;2018-12-11T09:19:30.002Z\u0026#34;, \u0026#34;batchId\u0026#34; : 1, \u0026#34;numInputRows\u0026#34; : 0, \u0026#34;inputRowsPerSecond\u0026#34; : 0.0, \u0026#34;processedRowsPerSecond\u0026#34; : 0.0, \u0026#34;durationMs\u0026#34; : { \u0026#34;getOffset\u0026#34; : 6, \u0026#34;triggerExecution\u0026#34; : 7 }, \u0026#34;stateOperators\u0026#34; : [ ], \u0026#34;sources\u0026#34; : [ { \u0026#34;description\u0026#34; : \u0026#34;FileStreamSource[file:/Users/ohmycloud/work/cihon/gac/data/decoded/vintype=A5HEVAVNT/d=20180825]\u0026#34;, \u0026#34;startOffset\u0026#34; : { \u0026#34;logOffset\u0026#34; : 0 }, \u0026#34;endOffset\u0026#34; : { \u0026#34;logOffset\u0026#34; : 0 }, \u0026#34;numInputRows\u0026#34; : 0, \u0026#34;inputRowsPerSecond\u0026#34; : 0.0, \u0026#34;processedRowsPerSecond\u0026#34; : 0.0 } ], \u0026#34;sink\u0026#34; : { \u0026#34;description\u0026#34; : \u0026#34;org.apache.spark.sql.execution.datasources.hbase.HBaseSink@5ab0cadb\u0026#34; } } 到 hbase shell 中 scan 一下, 看到结果了：\nhbase(main):016:0\u0026gt; scan \u0026#39;ohmytest\u0026#39; ROW COLUMN+CELL LMWHP1S88J1S00013 column=info:loc_lat84, timestamp=1544517115189, value=@7\\x1A\\xF5U\\x82\\x12\\x94 LMWHP1S88J1S00013 column=info:loc_lon84, timestamp=1544517115189, value=@\\x5C\\x5C\\x87L\\x8F\\xFB\\x8B LMWHP1S88J1S00013 column=info:veh_soc, timestamp=1544517115189, value=\\x00\\x00\\x00U LMWHP1S88J1S00013 column=info:veh_spd, timestamp=1544517115189, value=\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00 hbase(main):017:0\u0026gt; pom 文件 主要是 hbase 的依赖：\n\u0026lt;!-- https://mvnrepository.com/artifact/org.apache.hbase/hbase --\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.apache.hbase\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;hbase\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;${hbase.version}\u0026lt;/version\u0026gt; \u0026lt;type\u0026gt;pom\u0026lt;/type\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;!-- https://mvnrepository.com/artifact/org.apache.hbase/hbase-server --\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.apache.hbase\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;hbase-server\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;${hbase.version}\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;!-- https://mvnrepository.com/artifact/org.apache.hbase/hbase-client --\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.apache.hbase\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;hbase-client\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;${hbase.version}\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;!-- https://mvnrepository.com/artifact/org.apache.hbase/hbase-common --\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.apache.hbase\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;hbase-common\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;${hbase.version}\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;!-- https://mvnrepository.com/artifact/org.apache.hbase/hbase-mapreduce --\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.apache.hbase\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;hbase-mapreduce\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;${hbase.version}\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; "},"name":"使用 Spark Structured Streaming 落数据到 HBase 中","published":"2018-11-20T16:33:58Z","summary":"编译 SHC 截至目前, Structured Streaming 中的 Sink 还不支持 HBase! Stackoverflow 上有一个解决方案是用第三方的 shc自定义自己的 HBase Sink。有人按照第二个答案说搞不出来, 我也照着做了一遍, 发现是真的! 继续往下翻, 发现 github 上有个人做了一丢丢的修改, 于是我照抄了过来:\npackage org.apache.spark.sql.execution.datasources.hbase import org.apache.spark.sql.{DataFrame, SQLContext, Row} import org.apache.spark.sql.execution.streaming.Sink import org.apache.spark.sql.sources.{DataSourceRegister, StreamSinkProvider} import org.apache.spark.sql.streaming.OutputMode import org.apache.spark.sql.catalyst.CatalystTypeConverters class HBaseSink(options: Map[String, String]) extends Sink with Logging { // String with HBaseTableCatalog.tableCatalog private val hBaseCatalog = options.get(\u0026#34;hbasecat\u0026#34;).map(_.toString).getOrElse(\u0026#34;\u0026#34;) override def addBatch(batchId: Long, data: DataFrame): Unit = synchronized { val schema = data.schema val res = data.","type":"entry","url":"https://ohmycloud.github.io/notes/sink-to-hbase-using-structured-streaming/"}