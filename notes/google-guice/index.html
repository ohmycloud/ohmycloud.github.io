<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-us" lang="en-us">

    <head>
    <link href="https://gmpg.org/xfn/11" rel="profile">
    <meta charset="utf-8">
    
    
    

    
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5">

    
    <meta name="referrer" content="no-referrer">

    <title>
        
            Google Guice - 依赖注入 ❚ 焉知非鱼
        
    </title>

    
    


    
    
    
    

    
    
    
    

    
    
    

    
    
    
    <style>
     
     
     :root {
         --theme-color: #ac4142;
         --theme-color-light: rgba(172, 65, 66, 0.2);
     }
     
     html {
         line-height: 1.5;
     }
    </style>

    
    

    
    
    
    
    <link rel="stylesheet" href="/css/refined.min.7f6d3ee611034e4ebcbc063f1db3bc042fecdc8901afbedad80ff02bae409204.css">
    
    <link rel="preload" href="/css/refined.min.7f6d3ee611034e4ebcbc063f1db3bc042fecdc8901afbedad80ff02bae409204.css" as="style">

    



    
        <style>
         
         /* Background */ .chroma { background-color: #ffffff }
/* Error */ .chroma .err { color: #a61717; background-color: #e3d2d2 }
/* LineTableTD */ .chroma .lntd { vertical-align: top; padding: 0; margin: 0; border: 0; }
/* LineTable */ .chroma .lntable { border-spacing: 0; padding: 0; margin: 0; border: 0; width: auto; overflow: auto; display: block; }
/* LineHighlight */ .chroma .hl { display: block; width: 100%;background-color: #ffffcc }
/* LineNumbersTable */ .chroma .lnt { margin-right: 0.4em; padding: 0 0.4em 0 0.4em; }
/* LineNumbers */ .chroma .ln { margin-right: 0.4em; padding: 0 0.4em 0 0.4em; }
/* Keyword */ .chroma .k { color: #000000; font-weight: bold }
/* KeywordConstant */ .chroma .kc { color: #000000; font-weight: bold }
/* KeywordDeclaration */ .chroma .kd { color: #000000; font-weight: bold }
/* KeywordNamespace */ .chroma .kn { color: #000000; font-weight: bold }
/* KeywordPseudo */ .chroma .kp { color: #000000; font-weight: bold }
/* KeywordReserved */ .chroma .kr { color: #000000; font-weight: bold }
/* KeywordType */ .chroma .kt { color: #445588; font-weight: bold }
/* NameAttribute */ .chroma .na { color: #008080 }
/* NameBuiltin */ .chroma .nb { color: #0086b3 }
/* NameBuiltinPseudo */ .chroma .bp { color: #999999 }
/* NameClass */ .chroma .nc { color: #445588; font-weight: bold }
/* NameConstant */ .chroma .no { color: #008080 }
/* NameDecorator */ .chroma .nd { color: #3c5d5d; font-weight: bold }
/* NameEntity */ .chroma .ni { color: #800080 }
/* NameException */ .chroma .ne { color: #990000; font-weight: bold }
/* NameFunction */ .chroma .nf { color: #990000; font-weight: bold }
/* NameLabel */ .chroma .nl { color: #990000; font-weight: bold }
/* NameNamespace */ .chroma .nn { color: #555555 }
/* NameTag */ .chroma .nt { color: #000080 }
/* NameVariable */ .chroma .nv { color: #008080 }
/* NameVariableClass */ .chroma .vc { color: #008080 }
/* NameVariableGlobal */ .chroma .vg { color: #008080 }
/* NameVariableInstance */ .chroma .vi { color: #008080 }
/* LiteralString */ .chroma .s { color: #dd1144 }
/* LiteralStringAffix */ .chroma .sa { color: #dd1144 }
/* LiteralStringBacktick */ .chroma .sb { color: #dd1144 }
/* LiteralStringChar */ .chroma .sc { color: #dd1144 }
/* LiteralStringDelimiter */ .chroma .dl { color: #dd1144 }
/* LiteralStringDoc */ .chroma .sd { color: #dd1144 }
/* LiteralStringDouble */ .chroma .s2 { color: #dd1144 }
/* LiteralStringEscape */ .chroma .se { color: #dd1144 }
/* LiteralStringHeredoc */ .chroma .sh { color: #dd1144 }
/* LiteralStringInterpol */ .chroma .si { color: #dd1144 }
/* LiteralStringOther */ .chroma .sx { color: #dd1144 }
/* LiteralStringRegex */ .chroma .sr { color: #009926 }
/* LiteralStringSingle */ .chroma .s1 { color: #dd1144 }
/* LiteralStringSymbol */ .chroma .ss { color: #990073 }
/* LiteralNumber */ .chroma .m { color: #009999 }
/* LiteralNumberBin */ .chroma .mb { color: #009999 }
/* LiteralNumberFloat */ .chroma .mf { color: #009999 }
/* LiteralNumberHex */ .chroma .mh { color: #009999 }
/* LiteralNumberInteger */ .chroma .mi { color: #009999 }
/* LiteralNumberIntegerLong */ .chroma .il { color: #009999 }
/* LiteralNumberOct */ .chroma .mo { color: #009999 }
/* Operator */ .chroma .o { color: #000000; font-weight: bold }
/* OperatorWord */ .chroma .ow { color: #000000; font-weight: bold }
/* Comment */ .chroma .c { color: #999988; font-style: italic }
/* CommentHashbang */ .chroma .ch { color: #999988; font-style: italic }
/* CommentMultiline */ .chroma .cm { color: #999988; font-style: italic }
/* CommentSingle */ .chroma .c1 { color: #999988; font-style: italic }
/* CommentSpecial */ .chroma .cs { color: #999999; font-weight: bold; font-style: italic }
/* CommentPreproc */ .chroma .cp { color: #999999; font-weight: bold; font-style: italic }
/* CommentPreprocFile */ .chroma .cpf { color: #999999; font-weight: bold; font-style: italic }
/* GenericDeleted */ .chroma .gd { color: #000000; background-color: #ffdddd }
/* GenericEmph */ .chroma .ge { color: #000000; font-style: italic }
/* GenericError */ .chroma .gr { color: #aa0000 }
/* GenericHeading */ .chroma .gh { color: #999999 }
/* GenericInserted */ .chroma .gi { color: #000000; background-color: #ddffdd }
/* GenericOutput */ .chroma .go { color: #888888 }
/* GenericPrompt */ .chroma .gp { color: #555555 }
/* GenericStrong */ .chroma .gs { font-weight: bold }
/* GenericSubheading */ .chroma .gu { color: #aaaaaa }
/* GenericTraceback */ .chroma .gt { color: #aa0000 }
/* GenericUnderline */ .chroma .gl { text-decoration: underline }
/* TextWhitespace */ .chroma .w { color: #bbbbbb }

         
         /* Overrides on top of the theme and Chroma CSS */
/* Chroma-based lines highlighting in code blocks */
.chroma .hl {
    background-color: #e8e8e8;
    /* Extend highlight up to 100 characters (assuming that the code blocks never have more than 100 characters in a line) */
    min-width: 100ch;
}
/* GenericHeading */ .chroma .gh { color: #999999; font-weight: bold }
/* GenericSubheading */ .chroma .gu { color: #aaaaaa; font-weight: bold }

         
        </style>
    

    

    
    
    

    
    <script src="/js/responsive-nav-orig.min.e2b5f2a956b488f466da513820636134defdc38b90ed566248960593f2bb4ba5.js"></script>
    
    <link rel="preload" href="/js/responsive-nav-orig.min.e2b5f2a956b488f466da513820636134defdc38b90ed566248960593f2bb4ba5.js" as="script">

    
    
    <script defer src="/js/libs/fa/fontawesome-all.min.08916ac0fd078adfb58edc890460e2c8990729aee02bca7586404b56805f5219.js"></script>
    
    <link rel="preload" href="/js/libs/fa/fontawesome-all.min.08916ac0fd078adfb58edc890460e2c8990729aee02bca7586404b56805f5219.js" as="script">

    

    

    
    
    

    
    
<!-- rel="me" links for IndieAuth -->







    
 
<meta property="og:title" content="Google Guice - 依赖注入" />
<meta property="og:description"
      content=" " />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://ohmyweekly.github.io/notes/google-guice/" />


    
        <meta property="article:published_time" content="2019-07-02T15:19:52&#43;00:00"/>
    
    
        <meta property="article:modified_time" content="2019-07-02T15:19:52&#43;00:00"/>
    









    




     <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Google Guice - 依赖注入"/>
<meta name="twitter:description" content=" "/>


    
    
    <link rel="alternate" type="application/jf2post+json" href="https://ohmyweekly.github.io/notes/google-guice/jf2post.json" title="Jf2post for 焉知非鱼" />
    
     



    
    
    
        
    


     
        
        <meta name="DC.Creator" content="焉知非鱼"/>
    



    
    
    
    <meta name="hugo-build-date" content="2024-03-01T16:16:06Z"/>
    <meta name="hugo-commit-hash" content="312735366b20d64bd61bff8627f593749f86c964"/>
    <meta name="generator" content="Hugo 0.123.7">
</head>


    
        <body lang="en">
    

        
        <div class="border" id="home"></div>

        <div class="wrapper">   
            
<nav id="nav" class="nav-collapse opened" aria-hidden="false">
    <ul class="navbar">
        <li><a class="" href="/">Home</a></li>
        
            
                <li><a class="" href="https://ohmyweekly.github.io/posts/">Posts</a></li>
            
        
            
                <li><a class="" href="https://ohmyweekly.github.io/notes/">Notes</a></li>
            
        
        
            <li><a class="" href="https://ohmyweekly.github.io/search/">Search</a></li>
        
    </ul>
</nav>

            <div class="container">
                <header class="masthead">
                    <div class="masthead-title no-text-decoration">
                        <a href="/">焉知非鱼</a> <span class="blinking-cursor">❚</span>
                    </div>
                    <div class="masthead-tagline">
                        Wait the light to fall
                    </div>
                </header>

                








<article class="post h-entry notes">
    <header>
        <div class="center">
    <div class="taxo no-text-decoration">
         
            
                <ul class="no-bullets inline categories">
                    
                        
                        
                        
                            
                            
                            
                            
                            
                            <li class="__rakulang__"
                                
                                
                                title="See all 0 posts categorized in ‘rakulang’"
                                
                            >
                                <a class="p-category" href="https://ohmyweekly.github.io/categories/rakulang/">rakulang</a>
                            </li>
                        
                    
                </ul>
            
         
            
                <ul class="no-bullets inline tags">
                    
                        
                        
                        
                            
                            
                            
                            
                            
                            <li class="__rakulang__"
                                
                                
                                title="See all 0 posts tagged with ‘rakulang’"
                                
                            >
                                <a class="p-category" href="https://ohmyweekly.github.io/tags/rakulang/">rakulang</a>
                            </li>
                        
                    
                </ul>
            
        
    </div>

</div>

        <h1 class="post-title p-name">Google Guice - 依赖注入</h1>

        
        <data class="u-url" value="https://ohmyweekly.github.io/notes/google-guice/"></data>

        <div class="date-syndication">
            


    
    
    <div class="post-date">
        
        <time datetime="2019-07-02T15:19:52+0000" class="dt-published">Tue Jul 2, 2019</time>
        
        
    </div>


            




        </div>
         



    
    
    
        
    


    
        
        <span class="hide">
            &mdash; <a href="https://ohmyweekly.github.io/" class="u-author">焉知非鱼</a>
        </span>
    


    </header>

    <div class="content">
        


        





                       


        <div class="e-content">
            




<h2 id="动机">动机&nbsp;<a class="headline-hash no-text-decoration" href="#动机">#</a> </h2>
<p>将所有内容连接在一起是应用程序开发的一个单调乏味的部分。有几种方法可以将数据、服务和表示类相互连接起来。为了对比这些方法，我们将为披萨订购网站编写支付代码：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">interface</span> <span class="nc">BillingService</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">   * Attempts to charge the order to the credit card. Both successful and
</span></span></span><span class="line"><span class="cl"><span class="cm">   * failed transactions will be recorded.
</span></span></span><span class="line"><span class="cl"><span class="cm">   *
</span></span></span><span class="line"><span class="cl"><span class="cm">   * @return a receipt of the transaction. If the charge was successful, the
</span></span></span><span class="line"><span class="cl"><span class="cm">   *      receipt will be successful. Otherwise, the receipt will contain a
</span></span></span><span class="line"><span class="cl"><span class="cm">   *      decline note describing why the charge failed.
</span></span></span><span class="line"><span class="cl"><span class="cm">   */</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">Receipt</span><span class="w"> </span><span class="nf">chargeOrder</span><span class="p">(</span><span class="n">PizzaOrder</span><span class="w"> </span><span class="n">order</span><span class="p">,</span><span class="w"> </span><span class="n">CreditCard</span><span class="w"> </span><span class="n">creditCard</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>伴随着实现，我们会给我们的代码写单元测试。在测试中，我们需要一个 <code>FakeCreditCardProcessor</code> 来避免支付到真实的信用卡。</p>
<h3 id="直接构造函数调用">直接构造函数调用&nbsp;<a class="headline-hash no-text-decoration" href="#直接构造函数调用">#</a> </h3>
<p>以下是我们刚刚刷新信用卡处理器和事务记录器时代码的样子：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">RealBillingService</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">BillingService</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="n">Receipt</span><span class="w"> </span><span class="nf">chargeOrder</span><span class="p">(</span><span class="n">PizzaOrder</span><span class="w"> </span><span class="n">order</span><span class="p">,</span><span class="w"> </span><span class="n">CreditCard</span><span class="w"> </span><span class="n">creditCard</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">CreditCardProcessor</span><span class="w"> </span><span class="n">processor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">PaypalCreditCardProcessor</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">TransactionLog</span><span class="w"> </span><span class="n">transactionLog</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">DatabaseTransactionLog</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">ChargeResult</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">processor</span><span class="p">.</span><span class="na">charge</span><span class="p">(</span><span class="n">creditCard</span><span class="p">,</span><span class="w"> </span><span class="n">order</span><span class="p">.</span><span class="na">getAmount</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">transactionLog</span><span class="p">.</span><span class="na">logChargeResult</span><span class="p">(</span><span class="n">result</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">result</span><span class="p">.</span><span class="na">wasSuccessful</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="o">?</span><span class="w"> </span><span class="n">Receipt</span><span class="p">.</span><span class="na">forSuccessfulCharge</span><span class="p">(</span><span class="n">order</span><span class="p">.</span><span class="na">getAmount</span><span class="p">())</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="p">:</span><span class="w"> </span><span class="n">Receipt</span><span class="p">.</span><span class="na">forDeclinedCharge</span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="na">getDeclineMessage</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">UnreachableException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">transactionLog</span><span class="p">.</span><span class="na">logConnectException</span><span class="p">(</span><span class="n">e</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">Receipt</span><span class="p">.</span><span class="na">forSystemFailure</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="na">getMessage</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>该代码给模块化和可测试性带来了问题。对真实信用卡处理器的直接编译时依赖意味着测试代码将收取信用卡费用！测试当收费被拒绝或服务不可用时会发生什么也很尴尬。</p>
<h3 id="工厂">工厂&nbsp;<a class="headline-hash no-text-decoration" href="#工厂">#</a> </h3>
<p>工厂类将客户端和实现类分离。一个简单的工厂使用静态方法来获取和设置接口的模拟实现。工厂使用一些样板代码实现：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">CreditCardProcessorFactory</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">CreditCardProcessor</span><span class="w"> </span><span class="n">instance</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">setInstance</span><span class="p">(</span><span class="n">CreditCardProcessor</span><span class="w"> </span><span class="n">processor</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">instance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">processor</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">CreditCardProcessor</span><span class="w"> </span><span class="nf">getInstance</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">instance</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">SquareCreditCardProcessor</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">instance</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>在我们的客户端代码中，我们只是用工厂查找替换对 <code>new</code> 的调用：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">RealBillingService</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">BillingService</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="n">Receipt</span><span class="w"> </span><span class="nf">chargeOrder</span><span class="p">(</span><span class="n">PizzaOrder</span><span class="w"> </span><span class="n">order</span><span class="p">,</span><span class="w"> </span><span class="n">CreditCard</span><span class="w"> </span><span class="n">creditCard</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">CreditCardProcessor</span><span class="w"> </span><span class="n">processor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CreditCardProcessorFactory</span><span class="p">.</span><span class="na">getInstance</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">TransactionLog</span><span class="w"> </span><span class="n">transactionLog</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TransactionLogFactory</span><span class="p">.</span><span class="na">getInstance</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">ChargeResult</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">processor</span><span class="p">.</span><span class="na">charge</span><span class="p">(</span><span class="n">creditCard</span><span class="p">,</span><span class="w"> </span><span class="n">order</span><span class="p">.</span><span class="na">getAmount</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">transactionLog</span><span class="p">.</span><span class="na">logChargeResult</span><span class="p">(</span><span class="n">result</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">result</span><span class="p">.</span><span class="na">wasSuccessful</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="o">?</span><span class="w"> </span><span class="n">Receipt</span><span class="p">.</span><span class="na">forSuccessfulCharge</span><span class="p">(</span><span class="n">order</span><span class="p">.</span><span class="na">getAmount</span><span class="p">())</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="p">:</span><span class="w"> </span><span class="n">Receipt</span><span class="p">.</span><span class="na">forDeclinedCharge</span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="na">getDeclineMessage</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">UnreachableException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">transactionLog</span><span class="p">.</span><span class="na">logConnectException</span><span class="p">(</span><span class="n">e</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">Receipt</span><span class="p">.</span><span class="na">forSystemFailure</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="na">getMessage</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>工厂可以编写合适的单元测试：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">RealBillingServiceTest</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">TestCase</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">PizzaOrder</span><span class="w"> </span><span class="n">order</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">PizzaOrder</span><span class="p">(</span><span class="n">100</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">CreditCard</span><span class="w"> </span><span class="n">creditCard</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">CreditCard</span><span class="p">(</span><span class="s">&#34;1234&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">11</span><span class="p">,</span><span class="w"> </span><span class="n">2010</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">InMemoryTransactionLog</span><span class="w"> </span><span class="n">transactionLog</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">InMemoryTransactionLog</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">FakeCreditCardProcessor</span><span class="w"> </span><span class="n">processor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">FakeCreditCardProcessor</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nd">@Override</span><span class="w"> </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">setUp</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">TransactionLogFactory</span><span class="p">.</span><span class="na">setInstance</span><span class="p">(</span><span class="n">transactionLog</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">CreditCardProcessorFactory</span><span class="p">.</span><span class="na">setInstance</span><span class="p">(</span><span class="n">processor</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nd">@Override</span><span class="w"> </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">tearDown</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">TransactionLogFactory</span><span class="p">.</span><span class="na">setInstance</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">CreditCardProcessorFactory</span><span class="p">.</span><span class="na">setInstance</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">testSuccessfulCharge</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">RealBillingService</span><span class="w"> </span><span class="n">billingService</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RealBillingService</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Receipt</span><span class="w"> </span><span class="n">receipt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">billingService</span><span class="p">.</span><span class="na">chargeOrder</span><span class="p">(</span><span class="n">order</span><span class="p">,</span><span class="w"> </span><span class="n">creditCard</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">assertTrue</span><span class="p">(</span><span class="n">receipt</span><span class="p">.</span><span class="na">hasSuccessfulCharge</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">assertEquals</span><span class="p">(</span><span class="n">100</span><span class="p">,</span><span class="w"> </span><span class="n">receipt</span><span class="p">.</span><span class="na">getAmountOfCharge</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">assertEquals</span><span class="p">(</span><span class="n">creditCard</span><span class="p">,</span><span class="w"> </span><span class="n">processor</span><span class="p">.</span><span class="na">getCardOfOnlyCharge</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">assertEquals</span><span class="p">(</span><span class="n">100</span><span class="p">,</span><span class="w"> </span><span class="n">processor</span><span class="p">.</span><span class="na">getAmountOfOnlyCharge</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">assertTrue</span><span class="p">(</span><span class="n">transactionLog</span><span class="p">.</span><span class="na">wasSuccessLogged</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>这段代码很笨拙。全局变量保存模拟(mock)实现，因此我们需要小心设置它并将其删除。如果 <code>tearDown</code> 失败，全局变量将继续指向我们的测试实例。这可能会导致其他测试出现问题。它还阻止我们并行运行多个测试。</p>
<p>但最大的问题是依赖关系隐藏在代码中。如果我们在 <code>CreditCardFraudTracker</code> 上添加依赖项，我们必须重新运行测试以找出哪些会破坏。如果我们忘记为生产服务初始化工厂，我们在尝试收费之前不会发现。随着应用程序的增长，保姆工厂的生产力日益增加。</p>
<p>QA 或验收测试将捕获质量问题。这可能就足够了，但我们当然可以做得更好。</p>
<h3 id="依赖注入">依赖注入&nbsp;<a class="headline-hash no-text-decoration" href="#依赖注入">#</a> </h3>
<p>像工厂一样，依赖注入只是一种设计模式。核心原则是将行为与依赖性解析分开。在我们的示例中，<code>RealBillingService</code> 不负责查找 <code>TransactionLog</code> 和 <code>CreditCardProcessor</code>。相反，它们作为构造函数参数传入：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">RealBillingService</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">BillingService</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">CreditCardProcessor</span><span class="w"> </span><span class="n">processor</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">TransactionLog</span><span class="w"> </span><span class="n">transactionLog</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="nf">RealBillingService</span><span class="p">(</span><span class="n">CreditCardProcessor</span><span class="w"> </span><span class="n">processor</span><span class="p">,</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">TransactionLog</span><span class="w"> </span><span class="n">transactionLog</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="na">processor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">processor</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="na">transactionLog</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">transactionLog</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="n">Receipt</span><span class="w"> </span><span class="nf">chargeOrder</span><span class="p">(</span><span class="n">PizzaOrder</span><span class="w"> </span><span class="n">order</span><span class="p">,</span><span class="w"> </span><span class="n">CreditCard</span><span class="w"> </span><span class="n">creditCard</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">ChargeResult</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">processor</span><span class="p">.</span><span class="na">charge</span><span class="p">(</span><span class="n">creditCard</span><span class="p">,</span><span class="w"> </span><span class="n">order</span><span class="p">.</span><span class="na">getAmount</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">transactionLog</span><span class="p">.</span><span class="na">logChargeResult</span><span class="p">(</span><span class="n">result</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">result</span><span class="p">.</span><span class="na">wasSuccessful</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="o">?</span><span class="w"> </span><span class="n">Receipt</span><span class="p">.</span><span class="na">forSuccessfulCharge</span><span class="p">(</span><span class="n">order</span><span class="p">.</span><span class="na">getAmount</span><span class="p">())</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="p">:</span><span class="w"> </span><span class="n">Receipt</span><span class="p">.</span><span class="na">forDeclinedCharge</span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="na">getDeclineMessage</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">UnreachableException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">transactionLog</span><span class="p">.</span><span class="na">logConnectException</span><span class="p">(</span><span class="n">e</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">Receipt</span><span class="p">.</span><span class="na">forSystemFailure</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="na">getMessage</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>我们不需要任何工厂，我们可以通过删除 <code>setUp</code> 和 <code>tearDown</code> 样板来简化测试用例：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">RealBillingServiceTest</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">TestCase</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">PizzaOrder</span><span class="w"> </span><span class="n">order</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">PizzaOrder</span><span class="p">(</span><span class="n">100</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">CreditCard</span><span class="w"> </span><span class="n">creditCard</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">CreditCard</span><span class="p">(</span><span class="s">&#34;1234&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">11</span><span class="p">,</span><span class="w"> </span><span class="n">2010</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">InMemoryTransactionLog</span><span class="w"> </span><span class="n">transactionLog</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">InMemoryTransactionLog</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">FakeCreditCardProcessor</span><span class="w"> </span><span class="n">processor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">FakeCreditCardProcessor</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">testSuccessfulCharge</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">RealBillingService</span><span class="w"> </span><span class="n">billingService</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RealBillingService</span><span class="p">(</span><span class="n">processor</span><span class="p">,</span><span class="w"> </span><span class="n">transactionLog</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Receipt</span><span class="w"> </span><span class="n">receipt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">billingService</span><span class="p">.</span><span class="na">chargeOrder</span><span class="p">(</span><span class="n">order</span><span class="p">,</span><span class="w"> </span><span class="n">creditCard</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">assertTrue</span><span class="p">(</span><span class="n">receipt</span><span class="p">.</span><span class="na">hasSuccessfulCharge</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">assertEquals</span><span class="p">(</span><span class="n">100</span><span class="p">,</span><span class="w"> </span><span class="n">receipt</span><span class="p">.</span><span class="na">getAmountOfCharge</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">assertEquals</span><span class="p">(</span><span class="n">creditCard</span><span class="p">,</span><span class="w"> </span><span class="n">processor</span><span class="p">.</span><span class="na">getCardOfOnlyCharge</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">assertEquals</span><span class="p">(</span><span class="n">100</span><span class="p">,</span><span class="w"> </span><span class="n">processor</span><span class="p">.</span><span class="na">getAmountOfOnlyCharge</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">assertTrue</span><span class="p">(</span><span class="n">transactionLog</span><span class="p">.</span><span class="na">wasSuccessLogged</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>现在，每当我们添加或删除依赖项时，编译器都会提醒我们需要修复哪些测试。依赖关系在 API 签名中公开。</p>
<p>不幸的是，现在 <code>BillingService</code> 的客户端需要查找其依赖项。我们可以通过再次应用模式来解决其中一些问题！依赖它的类可以在它们的构造函数中接受 <code>BillingService</code>。对于顶级类，拥有一个框架很有用。否则，当需要使用服务时，您需要递归地构造依赖项：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">CreditCardProcessor</span><span class="w"> </span><span class="n">processor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">PaypalCreditCardProcessor</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">TransactionLog</span><span class="w"> </span><span class="n">transactionLog</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">DatabaseTransactionLog</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">BillingService</span><span class="w"> </span><span class="n">billingService</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RealBillingService</span><span class="p">(</span><span class="n">processor</span><span class="p">,</span><span class="w"> </span><span class="n">transactionLog</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><h3 id="用-guice-进行依赖注入">用 Guice 进行依赖注入&nbsp;<a class="headline-hash no-text-decoration" href="#用-guice-进行依赖注入">#</a> </h3>
<p>依赖注入模式导致代码模块化和可测试，而 Guice 使编写变得容易。要在我们的结算示例中使用 Guice，我们首先需要告诉它如何将接口映射到它们的实现。此配置在 Guice 模块中完成，该模块是实现 <code>Module</code> 接口的任何 Java 类：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">BillingModule</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">AbstractModule</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nd">@Override</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kd">protected</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">configure</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">bind</span><span class="p">(</span><span class="n">TransactionLog</span><span class="p">.</span><span class="na">class</span><span class="p">).</span><span class="na">to</span><span class="p">(</span><span class="n">DatabaseTransactionLog</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">bind</span><span class="p">(</span><span class="n">CreditCardProcessor</span><span class="p">.</span><span class="na">class</span><span class="p">).</span><span class="na">to</span><span class="p">(</span><span class="n">PaypalCreditCardProcessor</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">bind</span><span class="p">(</span><span class="n">BillingService</span><span class="p">.</span><span class="na">class</span><span class="p">).</span><span class="na">to</span><span class="p">(</span><span class="n">RealBillingService</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>我们将 <code>@Inject</code> 添加到 <code>RealBillingService</code> 的构造函数中，该构造函数指示 Guice 使用它。 Guice 将检查带注释的构造函数，并查找每个参数的值。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">RealBillingService</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">BillingService</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">CreditCardProcessor</span><span class="w"> </span><span class="n">processor</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">TransactionLog</span><span class="w"> </span><span class="n">transactionLog</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nd">@Inject</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="nf">RealBillingService</span><span class="p">(</span><span class="n">CreditCardProcessor</span><span class="w"> </span><span class="n">processor</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">TransactionLog</span><span class="w"> </span><span class="n">transactionLog</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="na">processor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">processor</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="na">transactionLog</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">transactionLog</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="n">Receipt</span><span class="w"> </span><span class="nf">chargeOrder</span><span class="p">(</span><span class="n">PizzaOrder</span><span class="w"> </span><span class="n">order</span><span class="p">,</span><span class="w"> </span><span class="n">CreditCard</span><span class="w"> </span><span class="n">creditCard</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">ChargeResult</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">processor</span><span class="p">.</span><span class="na">charge</span><span class="p">(</span><span class="n">creditCard</span><span class="p">,</span><span class="w"> </span><span class="n">order</span><span class="p">.</span><span class="na">getAmount</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">transactionLog</span><span class="p">.</span><span class="na">logChargeResult</span><span class="p">(</span><span class="n">result</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">result</span><span class="p">.</span><span class="na">wasSuccessful</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="o">?</span><span class="w"> </span><span class="n">Receipt</span><span class="p">.</span><span class="na">forSuccessfulCharge</span><span class="p">(</span><span class="n">order</span><span class="p">.</span><span class="na">getAmount</span><span class="p">())</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="p">:</span><span class="w"> </span><span class="n">Receipt</span><span class="p">.</span><span class="na">forDeclinedCharge</span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="na">getDeclineMessage</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">UnreachableException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">transactionLog</span><span class="p">.</span><span class="na">logConnectException</span><span class="p">(</span><span class="n">e</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">Receipt</span><span class="p">.</span><span class="na">forSystemFailure</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="na">getMessage</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>最后，我们可以把它们放在一起。 <code>Injector</code> 可用于获取任何绑定类的实例。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="w"> </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Injector</span><span class="w"> </span><span class="n">injector</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Guice</span><span class="p">.</span><span class="na">createInjector</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">BillingModule</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">BillingService</span><span class="w"> </span><span class="n">billingService</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">injector</span><span class="p">.</span><span class="na">getInstance</span><span class="p">(</span><span class="n">BillingService</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p><a href="https://github.com/google/guice/wiki/GettingStarted">入门指南</a>解释了这一切是如何工作的。</p>
<h2 id="入门">入门&nbsp;<a class="headline-hash no-text-decoration" href="#入门">#</a> </h2>
<p>如何开始使用 Guice 进行依赖注入。</p>
<h3 id="开始">开始&nbsp;<a class="headline-hash no-text-decoration" href="#开始">#</a> </h3>
<p>通过依赖注入，对象接受其构造函数中的依赖项。要构造对象，首先要构建其依赖项。但是要构建每个依赖项，您需要它的依赖项，依此类推。因此，在构建对象时，您确实需要构建对象图。</p>
<p>手动构建对象图是劳动密集型，容易出错，并且使测试变得困难。相反，Guice 可以为您构建对象图。但首先，Guice 需要配置为完全按照您的意愿构建图形。</p>
<p>为了说明，我们将启动 <code>BillingService</code> 类，该类在其构造函数中接受其依赖接口 <code>CreditCardProcessor</code> 和 <code>TransactionLog</code>。为了明确说明 Guice 调用 <code>BillingService</code> 构造函数，我们添加 <code>@Inject</code> 注解:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">BillingService</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">CreditCardProcessor</span><span class="w"> </span><span class="n">processor</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">TransactionLog</span><span class="w"> </span><span class="n">transactionLog</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nd">@Inject</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">BillingService</span><span class="p">(</span><span class="n">CreditCardProcessor</span><span class="w"> </span><span class="n">processor</span><span class="p">,</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">TransactionLog</span><span class="w"> </span><span class="n">transactionLog</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="na">processor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">processor</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="na">transactionLog</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">transactionLog</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="n">Receipt</span><span class="w"> </span><span class="nf">chargeOrder</span><span class="p">(</span><span class="n">PizzaOrder</span><span class="w"> </span><span class="n">order</span><span class="p">,</span><span class="w"> </span><span class="n">CreditCard</span><span class="w"> </span><span class="n">creditCard</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>我们想使用 <code>PaypalCreditCardProcessor</code> 和 <code>DatabaseTransactionLog</code> 构建 <code>BillingService</code>。 Guice 使用绑定​​将类型映射到它们的实现。模块是使用流畅的类似英语的方法调用指定的绑定集合:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">BillingModule</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">AbstractModule</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nd">@Override</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kd">protected</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">configure</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">      * This tells Guice that whenever it sees a dependency on a TransactionLog,
</span></span></span><span class="line"><span class="cl"><span class="cm">      * it should satisfy the dependency using a DatabaseTransactionLog.
</span></span></span><span class="line"><span class="cl"><span class="cm">      */</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">bind</span><span class="p">(</span><span class="n">TransactionLog</span><span class="p">.</span><span class="na">class</span><span class="p">).</span><span class="na">to</span><span class="p">(</span><span class="n">DatabaseTransactionLog</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">      * Similarly, this binding tells Guice that when CreditCardProcessor is used in
</span></span></span><span class="line"><span class="cl"><span class="cm">      * a dependency, that should be satisfied with a PaypalCreditCardProcessor.
</span></span></span><span class="line"><span class="cl"><span class="cm">      */</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">bind</span><span class="p">(</span><span class="n">CreditCardProcessor</span><span class="p">.</span><span class="na">class</span><span class="p">).</span><span class="na">to</span><span class="p">(</span><span class="n">PaypalCreditCardProcessor</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>模块是注入器的构建块，它是 Guice 的对象图构建器。首先我们创建注入器，然后我们可以使用它来构建 <code>BillingService</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Guice.createInjector() takes your Modules, and returns a new Injector
</span></span></span><span class="line"><span class="cl"><span class="cm">     * instance. Most applications will call this method exactly once, in their
</span></span></span><span class="line"><span class="cl"><span class="cm">     * main() method.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Injector</span><span class="w"> </span><span class="n">injector</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Guice</span><span class="p">.</span><span class="na">createInjector</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">BillingModule</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Now that we&#39;ve got the injector, we can build objects.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">BillingService</span><span class="w"> </span><span class="n">billingService</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">injector</span><span class="p">.</span><span class="na">getInstance</span><span class="p">(</span><span class="n">BillingService</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>通过构建 <code>billingService</code>，我们使用 Guice 构建了一个小对象图。该图包含计费服务及其相关的信用卡处理器和事务日志。</p>
<p><a href="https://github.com/google/guice/wiki/">https://github.com/google/guice/wiki/</a> 是谷歌出的依赖注入。</p>
<h2 id="绑定">绑定&nbsp;<a class="headline-hash no-text-decoration" href="#绑定">#</a> </h2>
<p>注入器(injector)的工作是组装对象图。你请求一个给定类型的实例，它会确定要构建的内容，解析依赖关系，并将所有内容连接在一起。要指定如何解析依赖关系，请使用绑定配置该注入器。</p>
<h3 id="创建绑定">创建绑定&nbsp;<a class="headline-hash no-text-decoration" href="#创建绑定">#</a> </h3>
<p>要创建绑定，请扩展 <code>AbstractModule</code> 并重写其 <code>configure</code> 方法。在方法体中，调用 <code>bind()</code> 来指定每个绑定。这些方法是带有类型检查的，因此如果使用错误的类型，编译器可以报告错误。创建模块后，将它们作为参数传递给 <code>Guice.createInjector()</code> 以构建注入器。</p>
<p>使用模块来创建 <a href="https://github.com/google/guice/wiki/LinkedBindings">linked bindings</a>, <a href="https://github.com/google/guice/wiki/InstanceBindings">instance bindings</a>, <a href="https://github.com/google/guice/wiki/ProvidesMethods">@Provides methods</a>, <a href="https://github.com/google/guice/wiki/ProviderBindings">provider bindings</a>, <a href="https://github.com/google/guice/wiki/ToConstructorBindings">constructor bindings</a> 和 <a href="https://github.com/google/guice/wiki/UntargettedBindings">untargetted bindings</a>.</p>
<h3 id="更多绑定">更多绑定&nbsp;<a class="headline-hash no-text-decoration" href="#更多绑定">#</a> </h3>
<p>除了您指定的绑定外，注入器还包含<a href="https://github.com/google/guice/wiki/BuiltInBindings">内置绑定</a>。当请求的依赖项未找到时，它会尝试创建<a href="https://github.com/google/guice/wiki/JustInTimeBindings">即时绑定</a>。注入器还包括用于其他绑定的<a href="https://github.com/google/guice/wiki/InjectingProviders">providers</a>的绑定。</p>
<h3 id="关联绑定">关联绑定&nbsp;<a class="headline-hash no-text-decoration" href="#关联绑定">#</a> </h3>
<p>关联绑定(Linked Bindings)将类型映射到它的实现上。这个例子将接口 <code>TransactionLog</code> 映射到 <code>DatabaseTransactionLog</code> 实现上：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">BillingModule</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">AbstractModule</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nd">@Override</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kd">protected</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">configure</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">bind</span><span class="p">(</span><span class="n">TransactionLog</span><span class="p">.</span><span class="na">class</span><span class="p">).</span><span class="na">to</span><span class="p">(</span><span class="n">DatabaseTransactionLog</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>现在, 当你调用  <code>injector.getInstance(TransactionLog.class)</code> 时, 或者当注入器遇到对 <code>TransactionLog</code> 的依赖时, 它就会使用 <code>DatabaseTransactionLog</code>。从一个类型关联到它的子类型中的任何一个, 例如实现类或扩展类。你甚至可以将具体的 <code>DatabaseTransactionLog</code> 类关联到子类上：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">bind</span><span class="p">(</span><span class="n">DatabaseTransactionLog</span><span class="p">.</span><span class="na">class</span><span class="p">).</span><span class="na">to</span><span class="p">(</span><span class="n">MySqlDatabaseTransactionLog</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></div><p>关联绑定还可以链接到一块儿：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">BillingModule</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">AbstractModule</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nd">@Override</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kd">protected</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">configure</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">bind</span><span class="p">(</span><span class="n">TransactionLog</span><span class="p">.</span><span class="na">class</span><span class="p">).</span><span class="na">to</span><span class="p">(</span><span class="n">DatabaseTransactionLog</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">bind</span><span class="p">(</span><span class="n">DatabaseTransactionLog</span><span class="p">.</span><span class="na">class</span><span class="p">).</span><span class="na">to</span><span class="p">(</span><span class="n">MySqlDatabaseTransactionLog</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>在这个情况下, 当要求 <code>TransactionLog</code> 时, 注入器会返回 <code>MySqlDatabaseTransactionLog</code>。</p>
<h3 id="绑定注解">绑定注解&nbsp;<a class="headline-hash no-text-decoration" href="#绑定注解">#</a> </h3>
<p>有时您会想要同一类型的多个绑定。例如，您可能需要 PayPal 信用卡处理器和 Google Checkout 处理器。要启用此功能，绑定支持可选的绑定注释。注释和类型一起唯一标识绑定。这个对儿被称为钥匙(key)。</p>
<p>定义绑定注释需要两行代码和多个导入。将它放在它自己的 <code>.java</code> 文件中或在它注释的类型中。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span><span class="w"> </span><span class="nn">example.pizza</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">com.google.inject.BindingAnnotation</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.lang.annotation.Target</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.lang.annotation.Retention</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import static</span><span class="w"> </span><span class="nn">java.lang.annotation.RetentionPolicy.RUNTIME</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import static</span><span class="w"> </span><span class="nn">java.lang.annotation.ElementType.PARAMETER</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import static</span><span class="w"> </span><span class="nn">java.lang.annotation.ElementType.FIELD</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import static</span><span class="w"> </span><span class="nn">java.lang.annotation.ElementType.METHOD</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nd">@BindingAnnotation</span><span class="w"> </span><span class="nd">@Target</span><span class="p">({</span><span class="w"> </span><span class="n">FIELD</span><span class="p">,</span><span class="w"> </span><span class="n">PARAMETER</span><span class="p">,</span><span class="w"> </span><span class="n">METHOD</span><span class="w"> </span><span class="p">})</span><span class="w"> </span><span class="nd">@Retention</span><span class="p">(</span><span class="n">RUNTIME</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="nd">@interface</span><span class="w"> </span><span class="n">PayPal</span><span class="w"> </span><span class="p">{}</span><span class="w">
</span></span></span></code></pre></div><p>您不需要了解所有这些元注释，但如果您感到好奇：</p>
<ul>
<li><code>@BindingAnnotation</code> 告诉 Guice 这是一个绑定注释。如果多个绑定注释应用于同一成员，Guice 将产生错误。</li>
<li><code>@Target({FIELD, PARAMETER, METHOD})</code> 是对用户的优惠。它可以防止 <code>@PayPal</code> 意外地被应用于无用的地方。</li>
<li><code>@Retention(RUNTIME)</code> 使注释在运行时可用。</li>
</ul>
<p>要依赖带注释的绑定，请将注释应用于注入的参数：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">RealBillingService</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">BillingService</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nd">@Inject</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="nf">RealBillingService</span><span class="p">(</span><span class="nd">@PayPal</span><span class="w"> </span><span class="n">CreditCardProcessor</span><span class="w"> </span><span class="n">processor</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">TransactionLog</span><span class="w"> </span><span class="n">transactionLog</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>最后，我们创建一个使用注释的绑定。这使用 <code>bind()</code> 语句中的可选 <code>annotatedWith</code> 子句：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="w"> </span><span class="n">bind</span><span class="p">(</span><span class="n">CreditCardProcessor</span><span class="p">.</span><span class="na">class</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">.</span><span class="na">annotatedWith</span><span class="p">(</span><span class="n">PayPal</span><span class="p">.</span><span class="na">class</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">.</span><span class="na">to</span><span class="p">(</span><span class="n">PayPalCreditCardProcessor</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></div><h4 id="named">@Named&nbsp;<a class="headline-hash no-text-decoration" href="#named">#</a> </h4>
<p>Guice 带有一个内置的绑定注释 <code>@Named</code>，它带有一个字符串：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">RealBillingService</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">BillingService</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nd">@Inject</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="nf">RealBillingService</span><span class="p">(</span><span class="nd">@Named</span><span class="p">(</span><span class="s">&#34;Checkout&#34;</span><span class="p">)</span><span class="w"> </span><span class="n">CreditCardProcessor</span><span class="w"> </span><span class="n">processor</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">TransactionLog</span><span class="w"> </span><span class="n">transactionLog</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>要绑定特定名称，请使用 <code>Names.named()</code> 创建要传递给 <code>annotatedWith</code> 的实例：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">bind</span><span class="p">(</span><span class="n">CreditCardProcessor</span><span class="p">.</span><span class="na">class</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">.</span><span class="na">annotatedWith</span><span class="p">(</span><span class="n">Names</span><span class="p">.</span><span class="na">named</span><span class="p">(</span><span class="s">&#34;Checkout&#34;</span><span class="p">))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">.</span><span class="na">to</span><span class="p">(</span><span class="n">CheckoutCreditCardProcessor</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></div><p>由于编译器无法检查字符串，我们建议谨慎使用 <code>@Named</code>。定义您自己的专用注释可提供更好的类型安全性</p>
<h4 id="绑定注释与属性">绑定注释与属性&nbsp;<a class="headline-hash no-text-decoration" href="#绑定注释与属性">#</a> </h4>
<p>Guice 支持绑定具有属性值的注释（如 <code>@Named</code>）。在极少数情况下，您需要这样的注释（并且不能使用 <code>@Provides</code> 方法），我们建议您使用 Auto/Value 项目中的 <a href="https://github.com/google/auto/blob/master/value/userguide/howto.md#annotation">@AutoAnnotation</a>，因为正确实现注释很容易出错。如果您决定手动创建自定义实现，请确保正确实现 <a href="https://docs.oracle.com/javase/8/docs/api/java/lang/annotation/Annotation.html">Annotation Javadoc</a> 中详述的 <code>equals()</code> 和 <code>hashCode()</code> 规范。将此类的实例传递给 <code>annotatedWith()</code> 绑定子句。</p>
<h3 id="实例绑定">实例绑定&nbsp;<a class="headline-hash no-text-decoration" href="#实例绑定">#</a> </h3>
<p>您可以将类型绑定到该类型的特定实例上。这通常仅适用于不具有自己的依赖关系的对象，例如值对象：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">bind</span><span class="p">(</span><span class="n">String</span><span class="p">.</span><span class="na">class</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">.</span><span class="na">annotatedWith</span><span class="p">(</span><span class="n">Names</span><span class="p">.</span><span class="na">named</span><span class="p">(</span><span class="s">&#34;JDBC URL&#34;</span><span class="p">))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">.</span><span class="na">toInstance</span><span class="p">(</span><span class="s">&#34;jdbc:mysql://localhost/pizza&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">bind</span><span class="p">(</span><span class="n">Integer</span><span class="p">.</span><span class="na">class</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">.</span><span class="na">annotatedWith</span><span class="p">(</span><span class="n">Names</span><span class="p">.</span><span class="na">named</span><span class="p">(</span><span class="s">&#34;login timeout seconds&#34;</span><span class="p">))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">.</span><span class="na">toInstance</span><span class="p">(</span><span class="n">10</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></div><p>避免将 <code>.toInstance</code> 用于创建复杂的对象，因为它会减慢应用程序的启动速度。您可以改为使用@ <code>Provides</code> 方法。</p>
<h3 id="provides-方法">@Provides 方法&nbsp;<a class="headline-hash no-text-decoration" href="#provides-方法">#</a> </h3>
<p>当你需要代码来创建一个对象时，使用 <code>@Provides</code> 方法。该方法必须在模块中定义，并且必须具有 <code>@Provides</code> 注解。该方法的返回类型是绑定类型。只要注入器需要该类型的实例，它就会调用该方法。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">BillingModule</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">AbstractModule</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kd">protected</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">configure</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nd">@Provides</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">TransactionLog</span><span class="w"> </span><span class="nf">provideTransactionLog</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">DatabaseTransactionLog</span><span class="w"> </span><span class="n">transactionLog</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">DatabaseTransactionLog</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">transactionLog</span><span class="p">.</span><span class="na">setJdbcUrl</span><span class="p">(</span><span class="s">&#34;jdbc:mysql://localhost/pizza&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">transactionLog</span><span class="p">.</span><span class="na">setThreadPoolSize</span><span class="p">(</span><span class="n">30</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">transactionLog</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>如果 <code>@Provides</code> 方法具有像 <code>@PayPal</code> 或 <code>@Named(&quot;Checkout&quot;)</code>这样的绑定注释，Guice 绑定注释类型。依赖关系可以作为参数传递给方法。在调用该方法之前，注射器将为每个注入器执行绑定。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="w"> </span><span class="nd">@Provides</span><span class="w"> </span><span class="nd">@PayPal</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">CreditCardProcessor</span><span class="w"> </span><span class="nf">providePayPalCreditCardProcessor</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nd">@Named</span><span class="p">(</span><span class="s">&#34;PayPal API key&#34;</span><span class="p">)</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">apiKey</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">PayPalCreditCardProcessor</span><span class="w"> </span><span class="n">processor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">PayPalCreditCardProcessor</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">processor</span><span class="p">.</span><span class="na">setApiKey</span><span class="p">(</span><span class="n">apiKey</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">processor</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><h4 id="抛出异常">抛出异常&nbsp;<a class="headline-hash no-text-decoration" href="#抛出异常">#</a> </h4>
<p>Guice 不允许从 Providers 抛出异常。 <code>@Provides</code> 方法引发的异常将被包装在 <code>ProvisionException</code> 中。允许从 <code>@Provides</code> 方法抛出任何类型的异常（运行时或检查）是不好的做法。如果由于某种原因需要抛出异常，则可能需要使用 <a href="https://github.com/google/guice/wiki/ThrowingProviders">ThrowingProviders 扩展</a> 的 <code>@CheckedProvides</code> 方法。</p>
<h3 id="provider-绑定">Provider 绑定&nbsp;<a class="headline-hash no-text-decoration" href="#provider-绑定">#</a> </h3>
<p>当你的 <code>@Provides</code> 方法开始变得复杂时, 你可以考虑将它们移动到自己的类中。provider 类实现了 Guice 的 <code>Provider</code> 接口，这是一个用于提供值的简单通用接口：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">interface</span> <span class="nc">Provider</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">T</span><span class="w"> </span><span class="nf">get</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>我们的 provider 实现类具有自己的依赖关系，它通过 <code>@Inject</code>-annotated 构造函数接收。它实现了 <code>Provider</code> 接口，用于定义具有完整类型安全性的返回内容：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">DatabaseTransactionLogProvider</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">Provider</span><span class="o">&lt;</span><span class="n">TransactionLog</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Connection</span><span class="w"> </span><span class="n">connection</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nd">@Inject</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="nf">DatabaseTransactionLogProvider</span><span class="p">(</span><span class="n">Connection</span><span class="w"> </span><span class="n">connection</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="na">connection</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">connection</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="n">TransactionLog</span><span class="w"> </span><span class="nf">get</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">DatabaseTransactionLog</span><span class="w"> </span><span class="n">transactionLog</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">DatabaseTransactionLog</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">transactionLog</span><span class="p">.</span><span class="na">setConnection</span><span class="p">(</span><span class="n">connection</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">transactionLog</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>最后，我们使用 <code>.toProvider</code> 子句绑定到提供者(provider)：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">BillingModule</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">AbstractModule</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kd">protected</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">configure</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">bind</span><span class="p">(</span><span class="n">TransactionLog</span><span class="p">.</span><span class="na">class</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">.</span><span class="na">toProvider</span><span class="p">(</span><span class="n">DatabaseTransactionLogProvider</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>如果你的 providers 很复杂，请务必测试它们！</p>
<h3 id="无目标绑定">无目标绑定&nbsp;<a class="headline-hash no-text-decoration" href="#无目标绑定">#</a> </h3>
<p>创建没有目标的绑定。</p>
<p>你可以在不指定目标的情况下创建绑定。这对于由 <code>@ImplementedBy</code> 或 <code>@ProvidedBy</code> 注解的具体类和类型最有用。无目标绑定通知注入器有关类型的信息，因此它可能会急切地准备依赖关系。 无目标绑定没有子句，如下所示：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">bind</span><span class="p">(</span><span class="n">MyConcreteClass</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">bind</span><span class="p">(</span><span class="n">AnotherConcreteClass</span><span class="p">.</span><span class="na">class</span><span class="p">).</span><span class="na">in</span><span class="p">(</span><span class="n">Singleton</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></div><p>指定绑定注解时，你仍必须添加目标绑定，即使它是相同的具体类。例如：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="w">    </span><span class="n">bind</span><span class="p">(</span><span class="n">MyConcreteClass</span><span class="p">.</span><span class="na">class</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">.</span><span class="na">annotatedWith</span><span class="p">(</span><span class="n">Names</span><span class="p">.</span><span class="na">named</span><span class="p">(</span><span class="s">&#34;foo&#34;</span><span class="p">))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">.</span><span class="na">to</span><span class="p">(</span><span class="n">MyConcreteClass</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">bind</span><span class="p">(</span><span class="n">AnotherConcreteClass</span><span class="p">.</span><span class="na">class</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">.</span><span class="na">annotatedWith</span><span class="p">(</span><span class="n">Names</span><span class="p">.</span><span class="na">named</span><span class="p">(</span><span class="s">&#34;foo&#34;</span><span class="p">))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">.</span><span class="na">to</span><span class="p">(</span><span class="n">AnotherConcreteClass</span><span class="p">.</span><span class="na">class</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">.</span><span class="na">in</span><span class="p">(</span><span class="n">Singleton</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></div><h3 id="构造函数绑定">构造函数绑定&nbsp;<a class="headline-hash no-text-decoration" href="#构造函数绑定">#</a> </h3>
<p>Guice 3.0中的新功能</p>
<p>偶尔有必要将类型绑定到任意构造函数。当 <code>@Inject</code> 注释无法应用于目标构造函数时会出现这种情况：要么是因为它是第三方类，要么是因为参与依赖注入的多个构造函数。 <a href="https://github.com/google/guice/wiki/ProvidesMethods">@Provides</a> 方法为这个问题提供了最佳解决方案！通过显式调用目标构造函数，您不需要反射及其相关的陷阱。但是这种方法存在局限性：手动构造的实例不参与 <a href="https://github.com/google/guice/wiki/AOP">AOP</a>。</p>
<p>为了解决这个问题，Guice 必须使用 <code>Constructor()</code> 绑定。它们要求您反射性地选择目标构造函数并处理异常（如果找不到该构造函数）：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">BillingModule</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">AbstractModule</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nd">@Override</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kd">protected</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">configure</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">bind</span><span class="p">(</span><span class="n">TransactionLog</span><span class="p">.</span><span class="na">class</span><span class="p">).</span><span class="na">toConstructor</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="n">DatabaseTransactionLog</span><span class="p">.</span><span class="na">class</span><span class="p">.</span><span class="na">getConstructor</span><span class="p">(</span><span class="n">DatabaseConnection</span><span class="p">.</span><span class="na">class</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">NoSuchMethodException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">addError</span><span class="p">(</span><span class="n">e</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>在此示例中，<code>DatabaseTransactionLog</code> 必须具有一个构造函数，该构造函数接受单个 <code>DatabaseConnection</code> 参数。该构造函数不需要 <code>@Inject</code> 批注。 Guice 将调用该构造函数来满足绑定。</p>
<p>每个 <code>toConstructor()</code> 绑定都是独立的范围。如果创建多个以相同构造函数为目标的单例绑定，则每个绑定都会生成自己的实例。</p>
<h3 id="内置绑定">内置绑定&nbsp;<a class="headline-hash no-text-decoration" href="#内置绑定">#</a> </h3>
<p>您可以使用的更多绑定。</p>
<h4 id="内置绑定-1">内置绑定&nbsp;<a class="headline-hash no-text-decoration" href="#内置绑定-1">#</a> </h4>
<p>除了显式和<a href="https://github.com/google/guice/wiki/JustInTimeBindings">即时绑定</a>外，其他绑定也会自动包含在注入器中。只有注入器可以创建这些绑定并尝试自己绑定它们是一个错误。</p>
<h4 id="loggers">Loggers&nbsp;<a class="headline-hash no-text-decoration" href="#loggers">#</a> </h4>
<p>Guice 有一个 <code>java.util.logging.Logger</code> 的内置绑定，用于保存一些样板。绑定自动将记录器的名称设置为注入 <code>Logger</code> 的类的名称。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Singleton</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">ConsoleTransactionLog</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">TransactionLog</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Logger</span><span class="w"> </span><span class="n">logger</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nd">@Inject</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="nf">ConsoleTransactionLog</span><span class="p">(</span><span class="n">Logger</span><span class="w"> </span><span class="n">logger</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="na">logger</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">logger</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">logConnectException</span><span class="p">(</span><span class="n">UnreachableException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="cm">/* the message is logged to the &#34;ConsoleTransacitonLog&#34; logger */</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">logger</span><span class="p">.</span><span class="na">warning</span><span class="p">(</span><span class="s">&#34;Connect exception failed, &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="na">getMessage</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><h4 id="注射器">注射器&nbsp;<a class="headline-hash no-text-decoration" href="#注射器">#</a> </h4>
<p>在框架代码中，有时您在运行时之前不知道所需的类型。在这种罕见的情况下，您应该注射注射器。注入注入器的代码不会自我记录其依赖关系，因此这种方法应该谨慎进行。</p>
<h4 id="providers">Providers&nbsp;<a class="headline-hash no-text-decoration" href="#providers">#</a> </h4>
<p>对于 Guice 所知道的每种类型，它也可以注入该类型的 Provider。<a href="https://github.com/google/guice/wiki/InjectingProviders">Injecting Providers</a>详细描述了这一点。</p>
<h4 id="typeliterals">TypeLiterals&nbsp;<a class="headline-hash no-text-decoration" href="#typeliterals">#</a> </h4>
<p>Guice 为其注入的所有内容提供完整的类型信息。如果您正在注入参数化类型，则可以注入 <code>TypeLiteral&lt;T&gt;</code> 以反射性地告诉您元素类型。</p>
<h4 id="the-stage">The Stage&nbsp;<a class="headline-hash no-text-decoration" href="#the-stage">#</a> </h4>
<p>Guice 支持阶段(stage)枚举，以区分开发和生产运行。</p>
<h4 id="membersinjectors">MembersInjectors&nbsp;<a class="headline-hash no-text-decoration" href="#membersinjectors">#</a> </h4>
<p>绑定到提供程序或编写扩展时，您可能希望Guice将依赖项注入您自己构造的对象中。为此，在 <code>MembersInjector&lt;T&gt;</code>（其中T是您的对象的类型）上添加依赖项，然后调用 <code>membersInjector.injectMembers(myNewObject)</code>。</p>
<h3 id="即时绑定">即时绑定&nbsp;<a class="headline-hash no-text-decoration" href="#即时绑定">#</a> </h3>
<p>由 Guice 自动创建的绑定。</p>
<h4 id="即时捆绑">即时捆绑&nbsp;<a class="headline-hash no-text-decoration" href="#即时捆绑">#</a> </h4>
<p>当注入器需要类型的实例时，它需要绑定。模块中的绑定称为显式绑定，只要可用，注入器就会使用它们。如果需要类型但没有显式绑定，则注入器将尝试创建实时绑定。这些也称为 JIT 绑定和隐式绑定。</p>
<h4 id="合格的构造函数">合格的构造函数&nbsp;<a class="headline-hash no-text-decoration" href="#合格的构造函数">#</a> </h4>
<p>Guice 可以使用类型的 injectable 构造函数为具体类型创建绑定。这可以是非私有的，无参数的构造函数，也可以是带有 <code>@Inject</code> 批注的构造函数：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">PayPalCreditCardProcessor</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">CreditCardProcessor</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">apiKey</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nd">@Inject</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="nf">PayPalCreditCardProcessor</span><span class="p">(</span><span class="nd">@Named</span><span class="p">(</span><span class="s">&#34;PayPal API key&#34;</span><span class="p">)</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">apiKey</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="na">apiKey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">apiKey</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>Guice 不会构造嵌套类，除非它们具有 <code>static</code> 修饰符。内部类具有对其无法注入的封闭类的隐式引用。</p>
<h4 id="implementedby">@ImplementedBy&nbsp;<a class="headline-hash no-text-decoration" href="#implementedby">#</a> </h4>
<p>注释类型告诉注入器它们的默认实现类型是什么。 @ImplementedBy 注释的作用类似于链接绑定，指定构建类型时要使用的子类型。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@ImplementedBy</span><span class="p">(</span><span class="n">PayPalCreditCardProcessor</span><span class="p">.</span><span class="na">class</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">interface</span> <span class="nc">CreditCardProcessor</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">ChargeResult</span><span class="w"> </span><span class="nf">charge</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">amount</span><span class="p">,</span><span class="w"> </span><span class="n">CreditCard</span><span class="w"> </span><span class="n">creditCard</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="kd">throws</span><span class="w"> </span><span class="n">UnreachableException</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>上面的注释等效于以下 <code>bind()</code> 语句：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">bind</span><span class="p">(</span><span class="n">CreditCardProcessor</span><span class="p">.</span><span class="na">class</span><span class="p">).</span><span class="na">to</span><span class="p">(</span><span class="n">PayPalCreditCardProcessor</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></div><p>如果类型同时包含 <code>bind()</code> 语句（作为第一个参数）并且具有 <code>@ImplementedBy</code> 注释，则使用 <code>bind()</code> 语句。注释建议可以使用绑定覆盖默认实现。小心使用 <code>@ImplementedBy</code>; 它从接口向其实现添加了编译时依赖项。</p>
<h4 id="providedby">@ProvidedBy&nbsp;<a class="headline-hash no-text-decoration" href="#providedby">#</a> </h4>
<p><code>@ProvidedBy</code> 告诉注入器有关生成实例的 <code>Provider</code> 类：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@ProvidedBy</span><span class="p">(</span><span class="n">DatabaseTransactionLogProvider</span><span class="p">.</span><span class="na">class</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">interface</span> <span class="nc">TransactionLog</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="nf">logConnectException</span><span class="p">(</span><span class="n">UnreachableException</span><span class="w"> </span><span class="n">e</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="nf">logChargeResult</span><span class="p">(</span><span class="n">ChargeResult</span><span class="w"> </span><span class="n">result</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>注释等效于 <code>toProvider()</code> 绑定：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">bind</span><span class="p">(</span><span class="n">TransactionLog</span><span class="p">.</span><span class="na">class</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">.</span><span class="na">toProvider</span><span class="p">(</span><span class="n">DatabaseTransactionLogProvider</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></div><p>与 <code>@ImplementedBy</code> 一样，如果类型在 <code>bind()</code> 语句中注释并使用，则将使用 <code>bind()</code> 语句。</p>
<h2 id="作用域">作用域&nbsp;<a class="headline-hash no-text-decoration" href="#作用域">#</a> </h2>
<h3 id="作用域-1">作用域&nbsp;<a class="headline-hash no-text-decoration" href="#作用域-1">#</a> </h3>
<p>默认情况下，Guice 每次提供一个值时都会返回一个新实例。此行为可通过<em>作用域进行</em>配置。范围允许您重用实例：应用程序的生命周期（<code>@Singleton</code>），会话（<code>@SessionScoped</code>）或请求（<code>@RequestScoped</code>）。Guice包含一个servlet扩展，用于定义Web应用程序的范围。可以为其他类型的应用程序编写<a href="https://github.com/google/guice/wiki/CustomScopes">自定义作用域</a>。</p>
<h3 id="应用范围">应用范围&nbsp;<a class="headline-hash no-text-decoration" href="#应用范围">#</a> </h3>
<p>Guice 使用注释来标识范围。通过将范围注释应用于实现类来指定类型的范围。除了功能性之外，此注释还可用作文档。例如，<code>@Singleton</code> 表示该类旨在是线程安全的。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Singleton</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">InMemoryTransactionLog</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">TransactionLog</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="cm">/* everything here should be threadsafe! */</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>范围也可以在<code>bind</code>语句中配置：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="w">  </span><span class="n">bind</span><span class="p">(</span><span class="n">TransactionLog</span><span class="p">.</span><span class="na">class</span><span class="p">).</span><span class="na">to</span><span class="p">(</span><span class="n">InMemoryTransactionLog</span><span class="p">.</span><span class="na">class</span><span class="p">).</span><span class="na">in</span><span class="p">(</span><span class="n">Singleton</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></div><p>并通过注释<code>@Provides</code>方法：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="w"> </span><span class="nd">@Provides</span><span class="w"> </span><span class="nd">@Singleton</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">TransactionLog</span><span class="w"> </span><span class="nf">provideTransactionLog</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>如果类型和语句中的作用域存在冲突<code>bind()</code>，则将使用<code>bind()</code>语句的作用域。如果使用您不想要的范围注释类型，请将其绑定到<code>Scopes.NO_SCOPE</code>。</p>
<p>在链接的绑定中，范围适用于绑定源，而不是绑定目标。假设我们有一个<code>Applebees</code>实现两者<code>Bar</code>和<code>Grill</code>接口的类。这些绑定允许该类型的<em>两个</em>实例，一个用于<code>Bar</code>s，另一个用于<code>Grill</code>s：</p>
<pre tabindex="0"><code> bind(Bar.class).to(Applebees.class).in(Singleton.class);
 bind(Grill.class).to(Applebees.class).in(Singleton.class);
</code></pre><p>这是因为范围适用于绑定类型（<code>Bar</code>，<code>Grill</code>），而不是满足该绑定（<code>Applebees</code>）的类型。要仅允许创建单个实例，请在<code>@Singleton</code>该类的声明上使用注释。或者添加另一个绑定：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="w"> </span><span class="n">bind</span><span class="p">(</span><span class="n">Applebees</span><span class="p">.</span><span class="na">class</span><span class="p">).</span><span class="na">in</span><span class="p">(</span><span class="n">Singleton</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></div><p>这种绑定使得<code>.in(Singleton.class)</code>上面的其他两个条款变得不必要。</p>
<p>该<code>in()</code>子句既可以接受范围注释<code>RequestScoped.class</code>，也可以接受以下<code>Scope</code>实例<code>ServletScopes.REQUEST</code>：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="w">  </span><span class="n">bind</span><span class="p">(</span><span class="n">UserPreferences</span><span class="p">.</span><span class="na">class</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">.</span><span class="na">toProvider</span><span class="p">(</span><span class="n">UserPreferencesProvider</span><span class="p">.</span><span class="na">class</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">.</span><span class="na">in</span><span class="p">(</span><span class="n">ServletScopes</span><span class="p">.</span><span class="na">REQUEST</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></div><p>注释是首选，因为它允许模块在不同类型的应用程序中重用。例如，<code>@RequestScoped</code>对象可以作用于Web应用程序中的HTTP请求，也可以作用于API服务器中的RPC。</p>
<h3 id="eager-singletons">Eager Singletons&nbsp;<a class="headline-hash no-text-decoration" href="#eager-singletons">#</a> </h3>
<p>Guice有特殊的语法来定义可以热切构造的单例：</p>
<pre tabindex="0"><code> bind(TransactionLog.class).to(InMemoryTransactionLog.class).asEagerSingleton();
</code></pre><p>Eager singletons 可以更快地揭示初始化问题，并确保最终用户获得一致，快捷的体验。懒惰的单例可以实现更快的编辑 - 编译 - 运行开发周期。使用<code>Stage</code>枚举指定应使用的策略。</p>
<table>
<thead>
<tr>
<th></th>
<th>生产</th>
<th>发展</th>
</tr>
</thead>
<tbody>
<tr>
<td>.asEagerSingleton()</td>
<td>eager</td>
<td>eager</td>
</tr>
<tr>
<td>.in(Singleton.class)</td>
<td>eager</td>
<td>lazy</td>
</tr>
<tr>
<td>.in(Scopes.SINGLETON)</td>
<td>eager</td>
<td>lazy</td>
</tr>
<tr>
<td>@Singleton</td>
<td>eager*</td>
<td>lazy</td>
</tr>
</tbody>
</table>
<p>* Guice只会热切地为他们所知道的类型建立单例。这些是模块中提到的类型，以及这些类型的传递依赖性。</p>
<h3 id="选择范围">选择范围&nbsp;<a class="headline-hash no-text-decoration" href="#选择范围">#</a> </h3>
<p>如果对象是<em>有状态的</em>，则范围应该是显而易见的。每个应用程序是<code>@Singleton</code>，每个请求是<code>@RequestScoped</code>，等等。如果对象是<em>无状态</em>且<em>创建成本低</em>，则不需要确定范围。保留未绑定的绑定，Guice将根据需要创建新实例。</p>
<p>单例在Java应用程序中很流行，但它们没有提供太多价值，特别是在涉及依赖注入时。虽然单例保存对象创建（以及后来的垃圾收集），但单例的初始化需要同步; 获取单个初始化实例的句柄只需要读取volatile。单身人士最适合：</p>
<ul>
<li>有状态对象，例如配置或计数器</li>
<li>构造或查找昂贵的对象</li>
<li>占用资源的对象，例如数据库连接池。</li>
</ul>
<h3 id="范围和并发">范围和并发&nbsp;<a class="headline-hash no-text-decoration" href="#范围和并发">#</a> </h3>
<p>注释的类<code>@Singleton</code>，<code>@SessionScoped</code> <em>必须是线程安全的</em>。注入这些类的所有东西也必须是线程安全的。<a href="https://github.com/google/guice/wiki/MinimizeMutability">最小化可变性</a>以限制需要并发保护的状态量。</p>
<p><code>@RequestScoped</code>对象不需要是线程安全的。对象<code>@Singleton</code>或<code>@SessionScoped</code>对象依赖于一个通常是错误的<code>@RequestScoped</code>。如果您需要较窄范围内的对象，请注入<code>Provider</code>该对象。</p>
<p><em>Guice如何初始化您的对象</em></p>
<h3 id="注射">注射&nbsp;<a class="headline-hash no-text-decoration" href="#注射">#</a> </h3>
<p>依赖注入模式将行为与依赖性解析分开。该模式不是直接查找依赖项或从工厂查找依赖项，而是建议传入依赖项。将依赖项设置为对象的过程称为<em>注入</em>。</p>
<h4 id="构造函数注入">构造函数注入&nbsp;<a class="headline-hash no-text-decoration" href="#构造函数注入">#</a> </h4>
<p>构造函数注入将实例化与注入相结合。要使用它，请使用注释注释构造函数<code>@Inject</code>。此构造函数应接受类依赖项作为参数。然后，大多数构造函数将参数分配给最终字段。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">RealBillingService</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">BillingService</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">CreditCardProcessor</span><span class="w"> </span><span class="n">processorProvider</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">TransactionLog</span><span class="w"> </span><span class="n">transactionLogProvider</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nd">@Inject</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="nf">RealBillingService</span><span class="p">(</span><span class="n">CreditCardProcessor</span><span class="w"> </span><span class="n">processorProvider</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">TransactionLog</span><span class="w"> </span><span class="n">transactionLogProvider</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="na">processorProvider</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">processorProvider</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="na">transactionLogProvider</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">transactionLogProvider</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>如果您的类没有<code>@Inject</code>注释构造函数，Guice将使用public，no-arguments构造函数（如果存在）。首选注释，该类型参与依赖注入的文档。</p>
<p>构造函数注入与单元测试很好地协同工作。如果您的类在单个构造函数中接受其所有依赖项，则不会意外忘记设置依赖项。当引入新的依赖项时，所有的调用代码都会方便地中断！修复编译错误，您可以确信所有内容都已正确连接。</p>
<h4 id="方法注入">方法注入&nbsp;<a class="headline-hash no-text-decoration" href="#方法注入">#</a> </h4>
<p>Guice可以注入具有<code>@Inject</code>注释的方法。依赖关系采用参数的形式，在调用方法之前，注入器会解析这些参数。注入的方法可以具有任意数量的参数，并且方法名称不会影响注入。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">PayPalCreditCardProcessor</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">CreditCardProcessor</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">DEFAULT_API_KEY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;development-use-only&#34;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">apiKey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DEFAULT_API_KEY</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nd">@Inject</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">setApiKey</span><span class="p">(</span><span class="nd">@Named</span><span class="p">(</span><span class="s">&#34;PayPal API key&#34;</span><span class="p">)</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">apiKey</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="na">apiKey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">apiKey</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><h4 id="字段注射">字段注射&nbsp;<a class="headline-hash no-text-decoration" href="#字段注射">#</a> </h4>
<p>Guice使用<code>@Inject</code>注释注入字段。这是最简洁的注射剂，但是最不可测试的。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">DatabaseTransactionLogProvider</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">Provider</span><span class="o">&lt;</span><span class="n">TransactionLog</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nd">@Inject</span><span class="w"> </span><span class="n">Connection</span><span class="w"> </span><span class="n">connection</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="n">TransactionLog</span><span class="w"> </span><span class="nf">get</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">DatabaseTransactionLog</span><span class="p">(</span><span class="n">connection</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>避免使用<code>final</code>具有<a href="http://java.sun.com/javase/6/docs/api/java/lang/reflect/Field.html#set(java.lang.Object,%20java.lang.Object)">弱语义的</a>字段的字段注入。</p>
<h4 id="可选注射">可选注射&nbsp;<a class="headline-hash no-text-decoration" href="#可选注射">#</a> </h4>
<p>有时候，当它存在时使用依赖是很方便的，当它没有依赖时它会回退到默认值。方法和字段注入可以是可选的，这会导致Guice在依赖项不可用时以静默方式忽略它们。要使用可选注入，请应用<code>@Inject(optional=true)</code>注释：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">PayPalCreditCardProcessor</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">CreditCardProcessor</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">SANDBOX_API_KEY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;development-use-only&#34;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">apiKey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SANDBOX_API_KEY</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nd">@Inject</span><span class="p">(</span><span class="n">optional</span><span class="o">=</span><span class="kc">true</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">setApiKey</span><span class="p">(</span><span class="nd">@Named</span><span class="p">(</span><span class="s">&#34;PayPal API key&#34;</span><span class="p">)</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">apiKey</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="na">apiKey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">apiKey</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>混合可选注射和即时结合可能会产生令人惊讶的结果。例如，即使<code>Date</code>未明确绑定，也始终注入以下字段。这是因为<code>Date</code>有一个公共的无参数构造函数，它有资格进行实时绑定。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="w">  </span><span class="nd">@Inject</span><span class="p">(</span><span class="n">optional</span><span class="o">=</span><span class="kc">true</span><span class="p">)</span><span class="w"> </span><span class="n">Date</span><span class="w"> </span><span class="n">launchDate</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><h3 id="按需注射">按需注射&nbsp;<a class="headline-hash no-text-decoration" href="#按需注射">#</a> </h3>
<p>方法和字段注入可用于初始化现有实例。您可以使用<code>Injector.injectMembers</code>API：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Injector</span><span class="w"> </span><span class="n">injector</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Guice</span><span class="p">.</span><span class="na">createInjector</span><span class="p">(...);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">CreditCardProcessor</span><span class="w"> </span><span class="n">creditCardProcessor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">PayPalCreditCardProcessor</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">injector</span><span class="p">.</span><span class="na">injectMembers</span><span class="p">(</span><span class="n">creditCardProcessor</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></div><h3 id="静态注射">静态注射&nbsp;<a class="headline-hash no-text-decoration" href="#静态注射">#</a> </h3>
<p>当<a href="http://publicobject.com/2007/07/guice-patterns-1-horrible-static-code.html">迁移应用程序</a>从静态工厂吉斯，可以逐步改变。静电注射是一个有用的拐杖。通过获取对注入类型的访问而不自己注入，它使对象可以<em>部分地</em>参与依赖注入。<code>requestStaticInjection()</code>在模块中使用以指定在注入器创建时注入的类：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="w">  </span><span class="nd">@Override</span><span class="w"> </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">configure</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">requestStaticInjection</span><span class="p">(</span><span class="n">ProcessorFactory</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>Guice将注入具有<code>@Inject</code>注释的类的静态成员：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">ProcessorFactory</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nd">@Inject</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">Provider</span><span class="o">&lt;</span><span class="n">Processor</span><span class="o">&gt;</span><span class="w"> </span><span class="n">processorProvider</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">   * @deprecated prefer to inject your processor instead.
</span></span></span><span class="line"><span class="cl"><span class="cm">   */</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nd">@Deprecated</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">Processor</span><span class="w"> </span><span class="nf">getInstance</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">processorProvider</span><span class="p">.</span><span class="na">get</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>静态成员不会在实例注入时注入。建议不要将此API用于一般用途，因为它遇到许多与静态工厂相同的问题：测试时笨拙，依赖性不透明，依赖于全局状态。</p>
<h3 id="自动注射">自动注射&nbsp;<a class="headline-hash no-text-decoration" href="#自动注射">#</a> </h3>
<p>Guice自动注入以下所有内容：</p>
<ul>
<li>实例传递给<code>toInstance()</code>绑定语句</li>
<li><code>toProvider()</code>在绑定语句中传递给的实例将在创建注入器本身时注入对象。如果他们需要满足其他初始注射，Guice会在使用前注射它们。</li>
</ul>
<h2 id="aop">AOP&nbsp;<a class="headline-hash no-text-decoration" href="#aop">#</a> </h2>
<p><em>用Guice拦截方法</em></p>
<h3 id="面向方面编程">面向方面编程&nbsp;<a class="headline-hash no-text-decoration" href="#面向方面编程">#</a> </h3>
<p>为了补充依赖注入，Guice支持<em>方法拦截</em>。此功能使您可以编写每次调用<em>匹配</em>方法时执行的代码。它适用于交叉问题（“方面”），例如交易，安全性和日志记录。因为拦截器将问题分为方面而不是对象，所以它们的使用称为面向方面编程（AOP）。</p>
<p>大多数开发人员不会直接编写方法拦截器; 但他们可能会看到它们在<a href="http://www.wideplay.com/guicewebextensions2">Warp Persist</a>等集成库中的使用。那些需要选择匹配方法，创建拦截器，并在模块中配置它们。</p>
<p><a href="http://google.github.io/guice/api-docs/latest/javadoc/com/google/inject/matcher/Matcher.html">Matcher</a>是一个接受或拒绝值的简单接口。对于Guice AOP，您需要两个匹配器：一个用于定义哪些类参与，另一个用于这些类的方法。为了简化这一过程，有<a href="http://google.github.io/guice/api-docs/latest/javadoc/com/google/inject/matcher/Matchers.html">工厂类</a>可以满足常见的情况。</p>
<p>只要调用匹配方法，就会执行<a href="http://aopalliance.sourceforge.net/doc/org/aopalliance/intercept/MethodInterceptor.html">MethodInterceptors</a>。他们有机会检查调用：方法，参数和接收实例。他们可以执行他们的交叉逻辑，然后委托给底层方法。最后，他们可以检查返回值或异常并返回。由于拦截器可以应用于许多方法并且将接收许多调用，因此它们的实现应该是有效且不引人注目的。</p>
<h3 id="示例周末禁止方法调用">示例：周末禁止方法调用&nbsp;<a class="headline-hash no-text-decoration" href="#示例周末禁止方法调用">#</a> </h3>
<p>为了说明方法拦截器如何与Guice协同工作，我们将在周末禁止拨打我们的披萨计费系统。送货员只在星期一到星期五工作，所以我们会防止披萨无法送达！此示例在结构上类似于使用AOP进行授权。</p>
<p>要将选择方法标记为仅工作日，我们定义注释：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Retention</span><span class="p">(</span><span class="n">RetentionPolicy</span><span class="p">.</span><span class="na">RUNTIME</span><span class="p">)</span><span class="w"> </span><span class="nd">@Target</span><span class="p">(</span><span class="n">ElementType</span><span class="p">.</span><span class="na">METHOD</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nd">@interface</span><span class="w"> </span><span class="n">NotOnWeekends</span><span class="w"> </span><span class="p">{}</span><span class="w">
</span></span></span></code></pre></div><p>&hellip;并将其应用于需要截获的方法：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">RealBillingService</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">BillingService</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nd">@NotOnWeekends</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="n">Receipt</span><span class="w"> </span><span class="nf">chargeOrder</span><span class="p">(</span><span class="n">PizzaOrder</span><span class="w"> </span><span class="n">order</span><span class="p">,</span><span class="w"> </span><span class="n">CreditCard</span><span class="w"> </span><span class="n">creditCard</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>接下来，我们通过实现<code>org.aopalliance.intercept.MethodInterceptor</code>接口来定义拦截器。当我们需要调用底层方法时，我们通过调用<code>invocation.proceed()</code>：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">WeekendBlocker</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">MethodInterceptor</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="n">Object</span><span class="w"> </span><span class="nf">invoke</span><span class="p">(</span><span class="n">MethodInvocation</span><span class="w"> </span><span class="n">invocation</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Throwable</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Calendar</span><span class="w"> </span><span class="n">today</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">GregorianCalendar</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">today</span><span class="p">.</span><span class="na">getDisplayName</span><span class="p">(</span><span class="n">DAY_OF_WEEK</span><span class="p">,</span><span class="w"> </span><span class="n">LONG</span><span class="p">,</span><span class="w"> </span><span class="n">ENGLISH</span><span class="p">).</span><span class="na">startsWith</span><span class="p">(</span><span class="s">&#34;S&#34;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">IllegalStateException</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="n">invocation</span><span class="p">.</span><span class="na">getMethod</span><span class="p">().</span><span class="na">getName</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&#34; not allowed on weekends!&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">invocation</span><span class="p">.</span><span class="na">proceed</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>最后，我们配置一切。这是我们为要拦截的类和方法创建匹配器的地方。在这种情况下，我们匹配任何类，但只匹配带有我们<code>@NotOnWeekends</code>注释的方法：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">NotOnWeekendsModule</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">AbstractModule</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kd">protected</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">configure</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">bindInterceptor</span><span class="p">(</span><span class="n">Matchers</span><span class="p">.</span><span class="na">any</span><span class="p">(),</span><span class="w"> </span><span class="n">Matchers</span><span class="p">.</span><span class="na">annotatedWith</span><span class="p">(</span><span class="n">NotOnWeekends</span><span class="p">.</span><span class="na">class</span><span class="p">),</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">new</span><span class="w"> </span><span class="n">WeekendBlocker</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>把它们放在一起，（并等到星期六），我们看到该方法被截获，我们的订单被拒绝：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">Exception</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="n">thread</span><span class="w"> </span><span class="s">&#34;main&#34;</span><span class="w"> </span><span class="n">java</span><span class="p">.</span><span class="na">lang</span><span class="p">.</span><span class="na">IllegalStateException</span><span class="p">:</span><span class="w"> </span><span class="n">chargeOrder</span><span class="w"> </span><span class="n">not</span><span class="w"> </span><span class="n">allowed</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">weekends</span><span class="o">!</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="n">at</span><span class="w"> </span><span class="n">com</span><span class="p">.</span><span class="na">publicobject</span><span class="p">.</span><span class="na">pizza</span><span class="p">.</span><span class="na">WeekendBlocker</span><span class="p">.</span><span class="na">invoke</span><span class="p">(</span><span class="n">WeekendBlocker</span><span class="p">.</span><span class="na">java</span><span class="p">:</span><span class="n">65</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="n">at</span><span class="w"> </span><span class="n">com</span><span class="p">.</span><span class="na">google</span><span class="p">.</span><span class="na">inject</span><span class="p">.</span><span class="na">internal</span><span class="p">.</span><span class="na">InterceptorStackCallback</span><span class="p">.</span><span class="na">intercept</span><span class="p">(...)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="n">at</span><span class="w"> </span><span class="n">com</span><span class="p">.</span><span class="na">publicobject</span><span class="p">.</span><span class="na">pizza</span><span class="p">.</span><span class="na">RealBillingService$$EnhancerByGuice$$49ed77ce</span><span class="p">.</span><span class="na">chargeOrder</span><span class="p">(</span><span class="o">&lt;</span><span class="n">generated</span><span class="o">&gt;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="n">at</span><span class="w"> </span><span class="n">com</span><span class="p">.</span><span class="na">publicobject</span><span class="p">.</span><span class="na">pizza</span><span class="p">.</span><span class="na">WeekendExample</span><span class="p">.</span><span class="na">main</span><span class="p">(</span><span class="n">WeekendExample</span><span class="p">.</span><span class="na">java</span><span class="p">:</span><span class="n">47</span><span class="p">)</span><span class="w">
</span></span></span></code></pre></div><h3 id="限制">限制&nbsp;<a class="headline-hash no-text-decoration" href="#限制">#</a> </h3>
<p>在幕后，通过在运行时生成字节码来实现方法拦截。Guice动态创建一个子类，通过重写方法来应用拦截器。如果您使用的是不支持字节码生成的平台（例如Android），则应使用<a href="https://github.com/google/guice/wiki/OptionalAOP">Guice而不支持AOP</a>。</p>
<p>这种方法对可拦截的类和方法施加了限制：</p>
<ul>
<li>类必须是公共的或包私有的。</li>
<li>课程必须是非最终的</li>
<li>方法必须是公共的，包私有的或受保护的</li>
<li>方法必须是非最终的</li>
<li>实例必须由Guice通过<code>@Inject</code>-annotated或no-argument构造函数创建。不可能对非Guice构造的实例使用方法拦截。</li>
</ul>
<h3 id="注入拦截器">注入拦截器&nbsp;<a class="headline-hash no-text-decoration" href="#注入拦截器">#</a> </h3>
<p>如果需要将依赖项注入拦截器，请使用<code>requestInjection</code>API。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">NotOnWeekendsModule</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">AbstractModule</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kd">protected</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">configure</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">WeekendBlocker</span><span class="w"> </span><span class="n">weekendBlocker</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">WeekendBlocker</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">requestInjection</span><span class="p">(</span><span class="n">weekendBlocker</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">bindInterceptor</span><span class="p">(</span><span class="n">Matchers</span><span class="p">.</span><span class="na">any</span><span class="p">(),</span><span class="w"> </span><span class="n">Matchers</span><span class="p">.</span><span class="na">annotatedWith</span><span class="p">(</span><span class="n">NotOnWeekends</span><span class="p">.</span><span class="na">class</span><span class="p">),</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">       </span><span class="n">weekendBlocker</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>另一个选择是使用Binder.getProvider并在拦截器的构造函数中传递依赖项。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">NotOnWeekendsModule</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">AbstractModule</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kd">protected</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">configure</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">bindInterceptor</span><span class="p">(</span><span class="n">any</span><span class="p">(),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">annotatedWith</span><span class="p">(</span><span class="n">NotOnWeekends</span><span class="p">.</span><span class="na">class</span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="k">new</span><span class="w"> </span><span class="n">WeekendBlocker</span><span class="p">(</span><span class="n">getProvider</span><span class="p">(</span><span class="n">Calendar</span><span class="p">.</span><span class="na">class</span><span class="p">)));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>注入拦截器时要小心。如果您的拦截器调用它本身正在拦截的方法，您可能会收到<code>StackOverflowException</code>由于无休止的递归。</p>
<h3 id="aop联盟">AOP联盟&nbsp;<a class="headline-hash no-text-decoration" href="#aop联盟">#</a> </h3>
<p>Guice实现的方法拦截器API是名为<a href="http://aopalliance.sourceforge.net/">AOP Alliance</a>的公共规范的一部分。这使得可以在各种框架中使用相同的拦截器。</p>
<h2 id="最佳实践">最佳实践&nbsp;<a class="headline-hash no-text-decoration" href="#最佳实践">#</a> </h2>
<h3 id="尽量减少可变性">尽量减少可变性&nbsp;<a class="headline-hash no-text-decoration" href="#尽量减少可变性">#</a> </h3>
<p>尽可能使用构造函数注入来创建不可变对象。不可变对象简单，可共享，并且可以组合。按照此模式定义您的注射类型：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">RealPaymentService</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">PaymentService</span><span class="w"> </span><span class="p">{</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">PaymentQueue</span><span class="w"> </span><span class="n">paymentQueue</span><span class="p">;</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Notifier</span><span class="w"> </span><span class="n">notifier</span><span class="p">;</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="nd">@Inject</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="n">RealPaymentRequestService</span><span class="p">(</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">       </span><span class="n">PaymentQueue</span><span class="w"> </span><span class="n">paymentQueue</span><span class="p">,</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">       </span><span class="n">Notifier</span><span class="w"> </span><span class="n">notifier</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="k">this</span><span class="p">.</span><span class="na">paymentQueue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">paymentQueue</span><span class="p">;</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="k">this</span><span class="p">.</span><span class="na">notifier</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">notifier</span><span class="p">;</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="p">...</span><span class="w">
</span></span></span></code></pre></div><p>此类的所有字段都是final，并由单个<code>@Inject</code>注释的构造函数初始化。<a href="http://www.amazon.com/Effective-Java-Edition-Joshua-Bloch/dp/0321356683">Effective Java</a>讨论了不可变性的其他好处。</p>
<h4 id="注入方法和字段">注入方法和字段&nbsp;<a class="headline-hash no-text-decoration" href="#注入方法和字段">#</a> </h4>
<p><em>构造函数注入</em>有一些限制：</p>
<ul>
<li>注入的构造函数可能不是可选的。</li>
<li>除非Guice创建对象，否则不能使用它。这是某些框架的破解者。</li>
<li>子类必须调用<code>super()</code>所有依赖项。这使构造函数注入变得麻烦，尤其是当注入的基类发生变化时。</li>
</ul>
<p>当您需要初始化非Guice构造的实例时，<em>方法注入</em>最有用。像<a href="https://github.com/google/guice/wiki/AssistedInject">AssistedInject</a>和Multibinder 这样的扩展使用方法注入来初始化绑定对象。</p>
<p><em>场注入</em>具有最紧凑的语法，因此它经常出现在幻灯片和示例中。它既不是封装也不是可测试的。决不注入<a href="https://github.com/google/guice/issues/245">最终场</a> ; JVM不保证注入的值对所有线程都可见。</p>
<h3 id="仅注入直接依赖项">仅注入直接依赖项&nbsp;<a class="headline-hash no-text-decoration" href="#仅注入直接依赖项">#</a> </h3>
<p>避免仅将对象注入作为获取另一个对象的手段。例如，不要注入<code>Customer</code>一个方法来获取<code>Account</code>：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">ShowBudgets</span><span class="w"> </span><span class="p">{</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Account</span><span class="w"> </span><span class="n">account</span><span class="p">;</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="nd">@Inject</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="n">ShowBudgets</span><span class="p">(</span><span class="n">Customer</span><span class="w"> </span><span class="n">customer</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="n">account</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">customer</span><span class="p">.</span><span class="na">getPurchasingAccount</span><span class="p">();</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="p">}</span><span class="w"> 
</span></span></span></code></pre></div><p>相反，直接注入依赖项。这使测试更容易; 测试用例不需要关心客户。使用<code>@Provides</code>您的方法<code>Module</code>创建绑定<code>Account</code>，使用绑定<code>Customer</code>：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">CustomersModule</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">AbstractModule</span><span class="w"> </span><span class="p">{</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nd">@Override</span><span class="w"> </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">configure</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nd">@Provides</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">Account</span><span class="w"> </span><span class="nf">providePurchasingAccount</span><span class="p">(</span><span class="n">Customer</span><span class="w"> </span><span class="n">customer</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">customer</span><span class="p">.</span><span class="na">getPurchasingAccount</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>通过直接注入依赖项，我们的代码更简单。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">ShowBudgets</span><span class="w"> </span><span class="p">{</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Account</span><span class="w"> </span><span class="n">account</span><span class="p">;</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="nd">@Inject</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="n">ShowBudgets</span><span class="p">(</span><span class="n">Account</span><span class="w"> </span><span class="n">account</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="k">this</span><span class="p">.</span><span class="na">account</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">account</span><span class="p">;</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="p">}</span><span class="w"> 
</span></span></span></code></pre></div><h3 id="解决循环依赖关系">解决循环依赖关系&nbsp;<a class="headline-hash no-text-decoration" href="#解决循环依赖关系">#</a> </h3>
<p>假设您的应用程序有几个类，包括Store，Boss和Clerk。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Store</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  	</span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Boss</span><span class="w"> </span><span class="n">boss</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  	</span><span class="c1">//...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="nd">@Inject</span><span class="w"> </span><span class="kd">public</span><span class="w"> </span><span class="nf">Store</span><span class="p">(</span><span class="n">Boss</span><span class="w"> </span><span class="n">boss</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> 		</span><span class="k">this</span><span class="p">.</span><span class="na">boss</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">boss</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> 		</span><span class="c1">//...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">incomingCustomer</span><span class="p">(</span><span class="n">Customer</span><span class="w"> </span><span class="n">customer</span><span class="p">)</span><span class="w"> </span><span class="p">{...}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="kd">public</span><span class="w"> </span><span class="n">Customer</span><span class="w"> </span><span class="nf">getNextCustomer</span><span class="p">()</span><span class="w"> </span><span class="p">{...}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Boss</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Clerk</span><span class="w"> </span><span class="n">Clerk</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="nd">@Inject</span><span class="w"> </span><span class="kd">public</span><span class="w"> </span><span class="nf">Boss</span><span class="p">(</span><span class="n">Clerk</span><span class="w"> </span><span class="n">Clerk</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="k">this</span><span class="p">.</span><span class="na">Clerk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Clerk</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Clerk</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="c1">// Nothing interesting here</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>现在，依赖链一切都很好：构建一个Store导致构建一个Boss，这导致构建一个Clerk。但是，为了让秘书让客户进行销售，他需要参考商店来获取这些客户</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Store</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  	</span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Boss</span><span class="w"> </span><span class="n">boss</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  	</span><span class="c1">//...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="nd">@Inject</span><span class="w"> </span><span class="kd">public</span><span class="w"> </span><span class="nf">Store</span><span class="p">(</span><span class="n">Boss</span><span class="w"> </span><span class="n">boss</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> 		</span><span class="k">this</span><span class="p">.</span><span class="na">boss</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">boss</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> 		</span><span class="c1">//...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">incomingCustomer</span><span class="p">(</span><span class="n">Customer</span><span class="w"> </span><span class="n">customer</span><span class="p">)</span><span class="w"> </span><span class="p">{...}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="kd">public</span><span class="w"> </span><span class="n">Customer</span><span class="w"> </span><span class="nf">getNextCustomer</span><span class="p">()</span><span class="w"> </span><span class="p">{...}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Boss</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Clerk</span><span class="w"> </span><span class="n">clerk</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="nd">@Inject</span><span class="w"> </span><span class="kd">public</span><span class="w"> </span><span class="nf">Boss</span><span class="p">(</span><span class="n">Clerk</span><span class="w"> </span><span class="n">clerk</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="k">this</span><span class="p">.</span><span class="na">clerk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">clerk</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Clerk</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Store</span><span class="w"> </span><span class="n">shop</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="nd">@Inject</span><span class="w"> </span><span class="n">Clerk</span><span class="p">(</span><span class="n">Store</span><span class="w"> </span><span class="n">shop</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="k">this</span><span class="p">.</span><span class="na">shop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">shop</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="kt">void</span><span class="w"> </span><span class="nf">doSale</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="n">Customer</span><span class="w"> </span><span class="n">sucker</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">shop</span><span class="p">.</span><span class="na">getNextCustomer</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="c1">//...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>这导致了一个周期：职员 - &gt;商店 - &gt;老板 - &gt;职员。在尝试建造一个职员时，将建造一个商店，这需要一个Boss，这需要一个职员！</p>
<p>有几种方法可以解决此循环：</p>
<h3 id="消除循环推荐">消除循环（推荐）&nbsp;<a class="headline-hash no-text-decoration" href="#消除循环推荐">#</a> </h3>
<p>循环通常反映不充分的颗粒分解。要消除此类周期，请将Dependency Case提取到单独的类中。</p>
<p>在这个例子中，管理传入客户的工作可以被提取到另一个类中，例如<code>CustomerLine</code>，可以注入到文员和商店。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Store</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  	</span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Boss</span><span class="w"> </span><span class="n">boss</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  	</span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">CustomerLine</span><span class="w"> </span><span class="n">line</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  	</span><span class="c1">//...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="nd">@Inject</span><span class="w"> </span><span class="kd">public</span><span class="w"> </span><span class="nf">Store</span><span class="p">(</span><span class="n">Boss</span><span class="w"> </span><span class="n">boss</span><span class="p">,</span><span class="w"> </span><span class="n">CustomerLine</span><span class="w"> </span><span class="n">line</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> 		</span><span class="k">this</span><span class="p">.</span><span class="na">boss</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">boss</span><span class="p">;</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"> 		</span><span class="k">this</span><span class="p">.</span><span class="na">line</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">line</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> 		</span><span class="c1">//...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">incomingCustomer</span><span class="p">(</span><span class="n">Customer</span><span class="w"> </span><span class="n">customer</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">line</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">customer</span><span class="p">);</span><span class="w"> </span><span class="p">}</span><span class="w">	
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Clerk</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">CustomerLine</span><span class="w"> </span><span class="n">line</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="nd">@Inject</span><span class="w"> </span><span class="n">Clerk</span><span class="p">(</span><span class="n">CustomerLine</span><span class="w"> </span><span class="n">line</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="k">this</span><span class="p">.</span><span class="na">line</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">line</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="kt">void</span><span class="w"> </span><span class="nf">doSale</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="n">Customer</span><span class="w"> </span><span class="n">sucker</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">line</span><span class="p">.</span><span class="na">getNextCustomer</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="c1">//...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>虽然Store和Clerk都依赖于CustomerLine，但依赖关系图中没有循环（尽管您可能希望确保Store和Clerk都使用相同的CustomerLine实例）。这也意味着当您的商店有大型帐篷销售时，您的文员将能够销售汽车：只需注入不同的CustomerLine。</p>
<h3 id="与提供商打破周期">与提供商打破周期&nbsp;<a class="headline-hash no-text-decoration" href="#与提供商打破周期">#</a> </h3>
<p><a href="https://github.com/google/guice/wiki/InjectingProviders">注入Guice提供程序</a>将允许您在依赖关系图中添加一个<em>接缝</em>。店员仍然会依赖商店，但是在他需要商店之前，店员不会看商店。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Clerk</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Provider</span><span class="o">&lt;</span><span class="n">Store</span><span class="o">&gt;</span><span class="w"> </span><span class="n">shopProvider</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="nd">@Inject</span><span class="w"> </span><span class="n">Clerk</span><span class="p">(</span><span class="n">Provider</span><span class="o">&lt;</span><span class="n">Store</span><span class="o">&gt;</span><span class="w"> </span><span class="n">shopProvider</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="k">this</span><span class="p">.</span><span class="na">shopProvider</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">shopProvider</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="kt">void</span><span class="w"> </span><span class="nf">doSale</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="n">Customer</span><span class="w"> </span><span class="n">sucker</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">shopProvider</span><span class="p">.</span><span class="na">get</span><span class="p">().</span><span class="na">getNextCustomer</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="c1">//...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>请注意，除非将Store绑定为Singleton或在其他范围内重复使用，<code>shopProvider.get()</code>否则调用将最终构建一个新的Store，它将构建一个新的Boss，它将再次构建一个新的Clerk！</p>
<h4 id="工厂方法将两个对象绑在一起">工厂方法将两个对象绑在一起&nbsp;<a class="headline-hash no-text-decoration" href="#工厂方法将两个对象绑在一起">#</a> </h4>
<p>当你的依赖关系紧密联系在一起时，用上述方法解开它们是行不通的。当使用类似View / Presenter范例的东西时，会出现这样的情况：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">FooPresenter</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="nd">@Inject</span><span class="w"> </span><span class="kd">public</span><span class="w"> </span><span class="nf">FooPresenter</span><span class="p">(</span><span class="n">FooView</span><span class="w"> </span><span class="n">view</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="c1">//...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">doSomething</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="n">view</span><span class="p">.</span><span class="na">doSomethingCool</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">FooView</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="nd">@Inject</span><span class="w"> </span><span class="kd">public</span><span class="w"> </span><span class="nf">FooView</span><span class="p">(</span><span class="n">FooPresenter</span><span class="w"> </span><span class="n">presenter</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="c1">//...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">userDidSomething</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="n">presenter</span><span class="p">.</span><span class="na">theyDidSomething</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="c1">//...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>每个对象都需要另一个对象。在这里，您可以使用<a href="https://github.com/google/guice/wiki/AssistedInject">AssistedInject</a>来解决它：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">FooPresenter</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">FooView</span><span class="w"> </span><span class="n">view</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="nd">@Inject</span><span class="w"> </span><span class="kd">public</span><span class="w"> </span><span class="nf">FooPresenter</span><span class="p">(</span><span class="n">FooView</span><span class="p">.</span><span class="na">Factory</span><span class="w"> </span><span class="n">viewMaker</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="n">view</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">viewMaker</span><span class="p">.</span><span class="na">create</span><span class="p">(</span><span class="k">this</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">doSomething</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="c1">//...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="n">view</span><span class="p">.</span><span class="na">doSomethingCool</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">FooView</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="nd">@Inject</span><span class="w"> </span><span class="kd">public</span><span class="w"> </span><span class="nf">FooView</span><span class="p">(</span><span class="nd">@Assisted</span><span class="w"> </span><span class="n">FooPresenter</span><span class="w"> </span><span class="n">presenter</span><span class="p">)</span><span class="w"> </span><span class="p">{...}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">userDidSomething</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="n">presenter</span><span class="p">.</span><span class="na">theyDidSomething</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">interface</span> <span class="nc">Factory</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="n">FooView</span><span class="w"> </span><span class="nf">create</span><span class="p">(</span><span class="n">FooPresenter</span><span class="w"> </span><span class="n">presenter</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>当尝试使用Guice来表示业务对象模型时，也会出现这种情况，业务对象模型可能具有反映不同类型关系的周期。 <a href="https://github.com/google/guice/wiki/AssistedInject">AssistedInject</a>对于这种情况也相当不错。</p>
<h3 id="避免静态状态">避免静态状态&nbsp;<a class="headline-hash no-text-decoration" href="#避免静态状态">#</a> </h3>
<p>静态和可测试性是敌人。您的测试应该快速且无副作用。但静态字段所持有的非常量值是一种难以管理的问题。可靠地拆除由测试模拟的静态单体是很棘手的，这会干扰其他测试。</p>
<p><code>requestStaticInjection()</code>是一个<em>拐杖</em>。Guice包含此API，以便于从静态配置的应用程序迁移到依赖注入的应用程序。使用Guice开发的新应用程序不应使用此API。</p>
<p>虽然<em>静态状态</em>不好，但static <em>关键字</em>没有任何问题。静态类是可以的（首选甚至！）和纯函数（排序，数学等），静态就好了。</p>
<h3 id="使用nullable">使用@Nullable&nbsp;<a class="headline-hash no-text-decoration" href="#使用nullable">#</a> </h3>
<p>要<code>NullPointerExceptions</code>在代码库中消除，必须遵守空引用的规定。我们通过遵循并执行一个简单的规则来成功： <em>除非明确指定，否则每个参数都是非空的。</em> 该<a href="http://code.google.com/p/guava-libraries/">番石榴：谷歌核心库的Java</a>和<a href="https://github.com/amaembo/jsr-305">JSR-305</a>拥有简单的API得到控制一空。<code>Preconditions.checkNotNull</code>如果找到空引用，则可用于快速失败，<code>@Nullable</code>并可用于注释允许该<code>null</code>值的参数：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">import static</span><span class="w"> </span><span class="nn">com.google.common.base.Preconditions.checkNotNull</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">javax.annotation.Nullable</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Person</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="nf">Person</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">firstName</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">lastName</span><span class="p">,</span><span class="w"> </span><span class="nd">@Nullable</span><span class="w"> </span><span class="n">Phone</span><span class="w"> </span><span class="n">phone</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="na">firstName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">checkNotNull</span><span class="p">(</span><span class="n">firstName</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;firstName&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="na">lastName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">checkNotNull</span><span class="p">(</span><span class="n">lastName</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;lastName&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="na">phone</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">phone</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>*Guice 默认禁止 null。*它会拒绝注入 <code>null</code>，<code>ProvisionException</code>而是拒绝注入。如果<code>null</code>您的班级允许，您可以使用注释字段或参数<code>@Nullable</code>。Guice识别任何<code>@Nullable</code>注释，例如<a href="http://findbugs.sourceforge.net/api/edu/umd/cs/findbugs/annotations/Nullable.html">edu.umd.cs.findbugs.annotations.Nullable</a>或<a href="https://github.com/amaembo/jsr-305/blob/master/ri/src/main/java/javax/annotation/Nullable.java">javax.annotation.Nullable</a>。</p>
<h3 id="模块应该快速且无副作用">模块应该快速且无副作用&nbsp;<a class="headline-hash no-text-decoration" href="#模块应该快速且无副作用">#</a> </h3>
<p>Guice模块不是使用外部XML文件进行配置，而是使用常规Java代码编写。Java很熟悉，可以与IDE一起使用，并且可以在重构后继续使用。</p>
<p>但是Java语言的全部功能都需要付出代价：在模块中很容易做得<em>太多</em>。很容易连接到数据库连接或在Guice模块中启动HTTP服务器。不要这样做！在模块中进行繁重的工作会产生问题：</p>
<ul>
<li>**模块启动，但它们不会关闭。**如果您在模块中打开数据库连接，则不会有任何挂钩来关闭它。</li>
<li>**应该测试模块。**如果模块打开数据库作为执行过程，则很难为其编写单元测试。</li>
<li>**模块可以被覆盖。**Guice模块支持<a href="http://google.github.io/guice/api-docs/latest/javadoc/com/google/inject/util/Modules.html#override(com.google.inject.Module...)">覆盖</a>，允许生产服务替换为轻量级或测试服务。当生产服务作为模块执行的一部分创建时，此类覆盖无效。</li>
</ul>
<p>而不是在模块本身中工作，定义一个可以在适当的抽象级别上完成工作的接口。在我们的应用中，我们使用此接口：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">interface</span> <span class="nc">Service</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">   * Starts the service. This method blocks until the service has completely started.
</span></span></span><span class="line"><span class="cl"><span class="cm">   */</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="nf">start</span><span class="p">()</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">   * Stops the service. This method blocks until the service has completely shut down.
</span></span></span><span class="line"><span class="cl"><span class="cm">   */</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="nf">stop</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>在创建Injector之后，我们通过启动其服务来完成引导我们的应用程序。我们还添加了关闭挂钩，以便在应用程序停止时干净地释放资源。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Injector</span><span class="w"> </span><span class="n">injector</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Guice</span><span class="p">.</span><span class="na">createInjector</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">new</span><span class="w"> </span><span class="n">DatabaseModule</span><span class="p">(),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">new</span><span class="w"> </span><span class="n">WebserverModule</span><span class="p">(),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Service</span><span class="w"> </span><span class="n">databaseConnectionPool</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">injector</span><span class="p">.</span><span class="na">getInstance</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Key</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">Service</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="w"> </span><span class="n">DatabaseService</span><span class="p">.</span><span class="na">class</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">databaseConnectionPool</span><span class="p">.</span><span class="na">start</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">addShutdownHook</span><span class="p">(</span><span class="n">databaseConnectionPool</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Service</span><span class="w"> </span><span class="n">webserver</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">injector</span><span class="p">.</span><span class="na">getInstance</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Key</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">Service</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="w"> </span><span class="n">WebserverService</span><span class="p">.</span><span class="na">class</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">webserver</span><span class="p">.</span><span class="na">start</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">addShutdownHook</span><span class="p">(</span><span class="n">webserver</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><h3 id="注意-provider-的-io">注意 Provider 的 I/O.&nbsp;<a class="headline-hash no-text-decoration" href="#注意-provider-的-io">#</a> </h3>
<p>该<code>Provider</code>接口方便调用者，但缺少语义：</p>
<ul>
<li>**提供者不声明已检查的例外。**如果您正在编写需要从特定类型的故障中恢复的代码，则无法捕获<code>TransactionRolledbackException</code>。<code>ProvisionException</code>允许您从常规配置故障中恢复，并且您可以<a href="http://google.github.io/guice/api-docs/latest/javadoc/com/google/inject/ProvisionException.html#getErrorMessages()">迭代其原因</a>，但您无法指定这些原因可能是什么。</li>
<li><strong>提供商不支持超时。</strong></li>
<li>**提供商没有定义重试策略。**当值不可用时，<code>get()</code>多次调用可能会导致多个失败的条款。</li>
</ul>
<p><a href="https://github.com/google/guice/wiki/ThrowingProviders">ThrowingProviders</a>是一个Guice扩展，它实现了一个抛出异常的提供者。它允许失败作为范围，因此每个请求或会话只发生一次失败的查找。</p>
<p><a href="https://blog.csdn.net/xtayfjpk/article/details/40657781">https://blog.csdn.net/xtayfjpk/article/details/40657781</a></p>
<h3 id="避免模块中的条件逻辑">避免模块中的条件逻辑&nbsp;<a class="headline-hash no-text-decoration" href="#避免模块中的条件逻辑">#</a> </h3>
<p>创建具有移动部件的模块很有诱惑力，并且可以配置为针对不同环境以不同方式运行：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">FooModule</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">AbstractModule</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">fooServer</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="nf">FooModule</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">this</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="nf">FooModule</span><span class="p">(</span><span class="nd">@Nullable</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">fooServer</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="na">fooServer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fooServer</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nd">@Override</span><span class="w"> </span><span class="kd">protected</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">configure</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">fooServer</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">bind</span><span class="p">(</span><span class="n">String</span><span class="p">.</span><span class="na">class</span><span class="p">).</span><span class="na">annotatedWith</span><span class="p">(</span><span class="n">named</span><span class="p">(</span><span class="s">&#34;fooServer&#34;</span><span class="p">)).</span><span class="na">toInstance</span><span class="p">(</span><span class="n">fooServer</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">bind</span><span class="p">(</span><span class="n">FooService</span><span class="p">.</span><span class="na">class</span><span class="p">).</span><span class="na">to</span><span class="p">(</span><span class="n">RemoteFooService</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">bind</span><span class="p">(</span><span class="n">FooService</span><span class="p">.</span><span class="na">class</span><span class="p">).</span><span class="na">to</span><span class="p">(</span><span class="n">InMemoryFooService</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>条件逻辑本身并不算太糟糕。但是配置未经测试时会出现问题。在此示例中，<code>InMemoryFooService</code>它用于开发并<code>RemoteFooService</code>用于生产。但是，如果不对此特定情况进行测试，则无法确定它是否<code>RemoteFooService</code>适用于集成应用程序。</p>
<p>要解决此问题，请<strong>尽量减少</strong>应用程序<strong>中不同配置的数量</strong>。如果将生产和开发拆分为不同的模块，则更容易确保测试整个生产代码路径。在这种情况下，我们分成<code>FooModule</code>了<code>RemoteFooModule</code>和<code>InMemoryFooModule</code>。这也会阻止生产类对测试代码具有编译时依赖性。</p>
<h3 id="保持guice实例化类的构造函数尽可能隐藏">保持Guice实例化类的构造函数尽可能隐藏。&nbsp;<a class="headline-hash no-text-decoration" href="#保持guice实例化类的构造函数尽可能隐藏">#</a> </h3>
<p>考虑这个简单的界面：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">interface</span> <span class="nc">DataReader</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">Data</span><span class="w"> </span><span class="nf">readData</span><span class="p">(</span><span class="n">DataSource</span><span class="w"> </span><span class="n">dataSource</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>使用公共类实现此接口是一种常见的反射：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">DatabaseDataReader</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">DataReader</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">ConnectionManager</span><span class="w"> </span><span class="n">connectionManager</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="nd">@Inject</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="kd">public</span><span class="w"> </span><span class="nf">DatabaseDataReader</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">ConnectionManager</span><span class="w"> </span><span class="n">connectionManager</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="k">this</span><span class="p">.</span><span class="na">connectionManager</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">connectionManager</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="kd">public</span><span class="w"> </span><span class="n">Data</span><span class="w"> </span><span class="nf">readData</span><span class="p">(</span><span class="n">DataSource</span><span class="w"> </span><span class="n">dataSource</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="c1">// ... read data from the database</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">Data</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">readInData</span><span class="p">,</span><span class="w"> </span><span class="n">someMetaData</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>快速检查此代码可以发现此实现没有任何错误。不幸的是，这种检查排除了时间维度和无人看守的代码库随时间变得更紧密耦合的必然性。</p>
<p>类似于旧的公理，<a href="http://www.google.com/webhp#hl=en&amp;q=nothing+good+happens+after+midnight">午夜之后没有任何好处发生</a>，我们也知道在构造函数公开后没有任何好处发生：公共构造函数<em>将</em>在代码库中引入非法用法。这些用途必然会：</p>
<ul>
<li>使重构更加困难。</li>
<li>打破接口实现抽象障碍。</li>
<li>在代码库中引入更紧密的耦合。</li>
</ul>
<p>也许最糟糕的是，任何直接使用构造函数都会绕过Guice的对象实例化。</p>
<p>作为更正，只需限制实现类及其构造函数的可见性。通常，包私有是两者的首选，因为这有利于：</p>
<ul>
<li>将类绑定<code>Module</code>在同一个包中</li>
<li>通过直接实例化对单元进行单元测试</li>
</ul>
<p>作为一个简单的，记忆记得<code>public</code>和<code>@Inject</code>像<a href="http://en.wikipedia.org/wiki/Dwarf_(Middle-earth)">精灵和矮人</a>：他们<em>可以</em>一起工作，但在一个理想的世界，他们将独立并存。</p>
<h1 id="避免注入可关闭的资源">避免注入可关闭的资源</h1>
<p>如果<a href="https://docs.oracle.com/javase/7/docs/api/java/io/Closeable.html"><code>Closable</code></a>通过依赖注入提供资源，则可能难以有效地管理Closable的生命周期：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">MyModule</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="nf">AbstractModule</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nd">@Provides</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">FileOutputStream</span><span class="w"> </span><span class="nf">provideFileStream</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">FileOutputStream</span><span class="p">(</span><span class="s">&#34;/tmp/outfile&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">class</span> <span class="nc">Client</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">FileOutputStream</span><span class="w"> </span><span class="n">fos</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nd">@Inject</span><span class="w"> </span><span class="n">Client</span><span class="p">(</span><span class="n">FileOutputStream</span><span class="w"> </span><span class="n">fos</span><span class="p">,</span><span class="w"> </span><span class="n">OtherDependency</span><span class="w"> </span><span class="n">other</span><span class="p">,</span><span class="w"> </span><span class="p">...)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="k">this</span><span class="p">.</span><span class="na">fos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fos</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="nf">doSomething</span><span class="p">()</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">IOException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">fos</span><span class="p">.</span><span class="na">write</span><span class="p">(</span><span class="s">&#34;hello!&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>这种方法存在许多问题，因为它与资源管理有关：</p>
<ul>
<li>
<p>如果构造了多个Client类，则会针对同一文件打开多个输出流，并且对该文件的写入可能会相互冲突。</p>
</li>
<li>
<p>目前尚不清楚哪个班级有责任关闭</p>
<pre tabindex="0"><code>FileOutputStream
</code></pre><p>资源：</p>
<ul>
<li>如果资源是为唯一所有权创建的<code>Client</code>，那么客户端关闭它是有意义的。</li>
<li>但是，如果资源是作用域的（例如：您添加<code>@Singleton</code>到<code>@Provides</code>方法中），那么突然<em>没有</em><code>Client</code>关闭资源的责任。如果<code>Client</code>关闭流，则该流的所有其他用户将处理已关闭的资源。需要有一些其他“资源管理器”对象也可以获取该流，并且其关闭功能在正确的位置调用。这样做可能很棘手。</li>
</ul>
</li>
<li>
<p>例如，如果其他依赖关系的构造<code>Client</code>失败（导致a <code>ProvisionException</code>），则<code>FileOutputStream</code>可能已构造泄漏并且未正确关闭，即使<code>Client</code>通常正确地关闭其资源。</p>
</li>
</ul>
<p>首选的解决方案是不注入可关闭的资源，而是注入可以暴露必要时使用的短期可关闭资源的对象。以下示例使用Guava的<a href="https://github.com/google/guava/wiki/IOExplained#sources-and-sinks">CharSource</a>作为资源管理器对象：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">MyModule</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="nf">AbstractModule</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nd">@Provides</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">CharSink</span><span class="w"> </span><span class="nf">provideCharSink</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">Files</span><span class="p">.</span><span class="na">asCharSink</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">File</span><span class="p">(</span><span class="s">&#34;/tmp/outfile&#34;</span><span class="p">),</span><span class="w"> </span><span class="n">StandardCharsets</span><span class="p">.</span><span class="na">UTF_8</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">class</span> <span class="nc">Client</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">CharSink</span><span class="w"> </span><span class="n">sink</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nd">@Inject</span><span class="w"> </span><span class="n">Client</span><span class="p">(</span><span class="n">CharSink</span><span class="w"> </span><span class="n">sink</span><span class="p">,</span><span class="w"> </span><span class="n">OtherDependency</span><span class="w"> </span><span class="n">other</span><span class="p">,</span><span class="w"> </span><span class="p">...)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="k">this</span><span class="p">.</span><span class="na">sink</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sink</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="nf">doSomething</span><span class="p">()</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">IOException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">sink</span><span class="p">.</span><span class="na">write</span><span class="p">(</span><span class="s">&#34;hello!&#34;</span><span class="p">);</span><span class="w"> </span><span class="c1">// Opens the file at this point, and closes once its done.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>如果没有类似的非可关闭资源，您可以编写一个简单的包装器：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">ResourceManager</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nd">@Inject</span><span class="w"> </span><span class="n">ResourceManager</span><span class="p">(</span><span class="nd">@Config</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">configs</span><span class="p">,</span><span class="w"> </span><span class="p">...)</span><span class="w"> </span><span class="p">{}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">   * Returns a new thing for you to use and dispose of
</span></span></span><span class="line"><span class="cl"><span class="cm">   */</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">OutputStream</span><span class="w"> </span><span class="nf">provideInstance</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="p">...();</span><span class="w"> </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">class</span> <span class="nc">Client</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">ResourceManager</span><span class="w"> </span><span class="n">resource</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nd">@Inject</span><span class="w"> </span><span class="n">Client</span><span class="p">(</span><span class="n">ResourceManager</span><span class="w"> </span><span class="n">resource</span><span class="p">,</span><span class="w"> </span><span class="n">OtherDependency</span><span class="w"> </span><span class="n">other</span><span class="p">,</span><span class="w"> </span><span class="p">...)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="k">this</span><span class="p">.</span><span class="na">resource</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">resource</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="nf">doSomething</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">(</span><span class="n">OutputStream</span><span class="w"> </span><span class="n">actualStream</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">resource</span><span class="p">.</span><span class="na">provideInstance</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="c1">// write to actualStream, closing with try-with-resources</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>此模式可以扩展到其他资源：与直接注入数据库连接句柄相反，注入连接池对象，这些对象要求您的对象在需要时请求这些连接对象并安全地关闭它们。</p>
<h2 id="faq">FAQ&nbsp;<a class="headline-hash no-text-decoration" href="#faq">#</a> </h2>
<h3 id="经常问的问题">经常问的问题&nbsp;<a class="headline-hash no-text-decoration" href="#经常问的问题">#</a> </h3>
<h5 id="如何注入配置参数">如何注入配置参数？&nbsp;<a class="headline-hash no-text-decoration" href="#如何注入配置参数">#</a> </h5>
<p>您需要一个绑定注释来标识您的参数。创建一个定义参数的注释类：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * Annotates the URL of the foo server.
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nd">@Retention</span><span class="p">(</span><span class="n">RetentionPolicy</span><span class="p">.</span><span class="na">RUNTIME</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nd">@Target</span><span class="p">({</span><span class="n">ElementType</span><span class="p">.</span><span class="na">FIELD</span><span class="p">,</span><span class="w"> </span><span class="n">ElementType</span><span class="p">.</span><span class="na">PARAMETER</span><span class="p">})</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nd">@BindingAnnotation</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="nd">@interface</span><span class="w"> </span><span class="n">FooServerAddress</span><span class="w"> </span><span class="p">{}</span><span class="w">
</span></span></span></code></pre></div><p>将注释绑定到模块中的值：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">FooModule</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">AbstractModule</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">fooServerAddress</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">   * @param fooServerAddress the URL of the foo server.
</span></span></span><span class="line"><span class="cl"><span class="cm">   */</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="nf">FooModule</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">fooServerAddress</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="na">fooServerAddress</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fooServerAddress</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nd">@Override</span><span class="w"> </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">configure</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">bindConstant</span><span class="p">().</span><span class="na">annotatedWith</span><span class="p">(</span><span class="n">FooServerAddress</span><span class="p">.</span><span class="na">class</span><span class="p">).</span><span class="na">to</span><span class="p">(</span><span class="n">fooServerAddress</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>最后，将它注入你的类：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">FooClient</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nd">@Inject</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">FooClient</span><span class="p">(</span><span class="nd">@FooServerAddress</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">fooServerAddress</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>您可以使用Guice的内置<code>@Named</code>绑定注释来保存一些击键，而不是创建自己的击键。</p>
<h5 id="如何加载配置属性">如何加载配置属性？&nbsp;<a class="headline-hash no-text-decoration" href="#如何加载配置属性">#</a> </h5>
<p>使用<a href="http://google.github.io/guice/api-docs/latest/javadoc/com/google/inject/name/Names.html#bindProperties(com.google.inject.Binder,%20java.util.Properties)">Names.bindProperties（）</a>为配置文件中的每个属性创建绑定。</p>
<h5 id="如何通过guice创建对象时传递参数">如何通过Guice创建对象时传递参数？&nbsp;<a class="headline-hash no-text-decoration" href="#如何通过guice创建对象时传递参数">#</a> </h5>
<p>您不能直接将参数传递给注入值。但是你可以使用Guice创建一个<code>Factory</code>，并使用该工厂来创建你的对象。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Thing</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c1">// note: no @Inject annotation here</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="nf">Thing</span><span class="p">(</span><span class="n">A</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">B</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Factory</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Inject</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="nf">Factory</span><span class="p">(</span><span class="n">A</span><span class="w"> </span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">...</span><span class="w"> </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Thing</span><span class="w"> </span><span class="nf">make</span><span class="p">(</span><span class="n">B</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">...</span><span class="w"> </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Example</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nd">@Inject</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="nf">Example</span><span class="p">(</span><span class="n">Thing</span><span class="p">.</span><span class="na">Factory</span><span class="w"> </span><span class="n">factory</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">...</span><span class="w"> </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>请参阅<a href="https://github.com/google/guice/wiki/AssistedInject">AssistedInject</a>，它可用于删除工厂样板。</p>
<h5 id="如何构建两个相似但略有不同的对象树">如何构建两个相似但略有不同的对象树？&nbsp;<a class="headline-hash no-text-decoration" href="#如何构建两个相似但略有不同的对象树">#</a> </h5>
<p>这通常被称为“机器人腿”问题：如何创建一个具有两个<code>Leg</code>对象的机器人，左边一个注入一个<code>LeftFoot</code>，右边一个注入一个<code>RightFoot</code>。但只有一个<code>Leg</code>类在两个上下文中都被重用。</p>
<p>有一个<a href="http://docs.google.com/Doc?id=dhfm3hw2_51d2tmv6pc">PrivateModules解决方案</a>。它使用两个独立的私有模块，<code>@Left</code>一个和<code>@Right</code>一个。每个人都有对未注释的绑定<code>Foot.class</code>和<code>Leg.class</code>，并公开了注解绑定<code>Leg.class</code>：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="w"> </span><span class="kd">class</span> <span class="nc">LegModule</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">PrivateModule</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Class</span><span class="o">&lt;?</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">Annotation</span><span class="o">&gt;</span><span class="w"> </span><span class="n">annotation</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">LegModule</span><span class="p">(</span><span class="n">Class</span><span class="o">&lt;?</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">Annotation</span><span class="o">&gt;</span><span class="w"> </span><span class="n">annotation</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="na">annotation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">annotation</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nd">@Override</span><span class="w"> </span><span class="kd">protected</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">configure</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">bind</span><span class="p">(</span><span class="n">Leg</span><span class="p">.</span><span class="na">class</span><span class="p">).</span><span class="na">annotatedWith</span><span class="p">(</span><span class="n">annotation</span><span class="p">).</span><span class="na">to</span><span class="p">(</span><span class="n">Leg</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">expose</span><span class="p">(</span><span class="n">Leg</span><span class="p">.</span><span class="na">class</span><span class="p">).</span><span class="na">annotatedWith</span><span class="p">(</span><span class="n">annotation</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">bindFoot</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kd">abstract</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">bindFoot</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Injector</span><span class="w"> </span><span class="n">injector</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Guice</span><span class="p">.</span><span class="na">createInjector</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">new</span><span class="w"> </span><span class="n">LegModule</span><span class="p">(</span><span class="n">Left</span><span class="p">.</span><span class="na">class</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nd">@Override</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">bindFoot</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">bind</span><span class="p">(</span><span class="n">Foot</span><span class="p">.</span><span class="na">class</span><span class="p">).</span><span class="na">toInstance</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">Foot</span><span class="p">(</span><span class="s">&#34;leftie&#34;</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">},</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">new</span><span class="w"> </span><span class="n">LegModule</span><span class="p">(</span><span class="n">Right</span><span class="p">.</span><span class="na">class</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nd">@Override</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">bindFoot</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">bind</span><span class="p">(</span><span class="n">Foot</span><span class="p">.</span><span class="na">class</span><span class="p">).</span><span class="na">toInstance</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">Foot</span><span class="p">(</span><span class="s">&#34;righty&#34;</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">});</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>另见<a href="https://github.com/google/guice/issues/1045#issuecomment-255610231">Alen Vrecko更完整的例子</a>。</p>
<h5 id="我怎样才能注入一个内部类">我怎样才能注入一个内部类？&nbsp;<a class="headline-hash no-text-decoration" href="#我怎样才能注入一个内部类">#</a> </h5>
<p>Guice不支持这一点。但是，您可以注入<em>嵌套</em>类（有时称为“静态内部类”）：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">Outer</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kd">static</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Nested</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><h5 id="如何使用泛型类型注入类">如何使用泛型类型注入类？&nbsp;<a class="headline-hash no-text-decoration" href="#如何使用泛型类型注入类">#</a> </h5>
<p>您可能需要注入一个参数化类型的类，如<code>List&lt;String&gt;</code>：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">Example</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nd">@Inject</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="nf">setList</span><span class="p">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">list</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>您可以使用<a href="http://google.github.io/guice/api-docs/latest/javadoc/com/google/inject/TypeLiteral.html">TypeLiteral</a>创建绑定。<code>TypeLiteral</code>是一个特殊的类，允许您指定完整的参数化类型。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="w">  </span><span class="nd">@Override</span><span class="w"> </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">configure</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">bind</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">TypeLiteral</span><span class="o">&lt;</span><span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;&gt;</span><span class="p">()</span><span class="w"> </span><span class="p">{}).</span><span class="na">toInstance</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>或者，您可以使用@Provides方法。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="w"> </span><span class="nd">@Provides</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">providesListOfString</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><h5 id="如何将可选参数注入构造函数">如何将可选参数注入构造函数？&nbsp;<a class="headline-hash no-text-decoration" href="#如何将可选参数注入构造函数">#</a> </h5>
<p>构造函数和<code>@Provides</code>方法都不支持可选注入。要解决此问题，您可以创建一个包含可选值的内部类：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">Car</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Engine</span><span class="w"> </span><span class="n">engine</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">AirConditioner</span><span class="w"> </span><span class="n">airConditioner</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nd">@Inject</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="nf">Car</span><span class="p">(</span><span class="n">Engine</span><span class="w"> </span><span class="n">engine</span><span class="p">,</span><span class="w"> </span><span class="n">AirConditionerHolder</span><span class="w"> </span><span class="n">airConditionerHolder</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="na">engine</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">engine</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="na">airConditioner</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">airConditionerHolder</span><span class="p">.</span><span class="na">value</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kd">static</span><span class="w"> </span><span class="kd">class</span> <span class="nc">AirConditionerHolder</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Inject</span><span class="p">(</span><span class="n">optional</span><span class="o">=</span><span class="kc">true</span><span class="p">)</span><span class="w"> </span><span class="n">AirConditioner</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">NoOpAirconditioner</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>这也允许可选参数的默认值。</p>
<h5 id="如何注入方法拦截器">如何注入方法拦截器？&nbsp;<a class="headline-hash no-text-decoration" href="#如何注入方法拦截器">#</a> </h5>
<p>为了在AOP中注入依赖项<code>MethodInterceptor</code>，请<code>requestInjection()</code>与标准<code>bindInterceptor()</code>调用一起使用。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">NotOnWeekendsModule</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">AbstractModule</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kd">protected</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">configure</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">MethodInterceptor</span><span class="w"> </span><span class="n">interceptor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">WeekendBlocker</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">requestInjection</span><span class="p">(</span><span class="n">interceptor</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">bindInterceptor</span><span class="p">(</span><span class="n">any</span><span class="p">(),</span><span class="w"> </span><span class="n">annotatedWith</span><span class="p">(</span><span class="n">NotOnWeekends</span><span class="p">.</span><span class="na">class</span><span class="p">),</span><span class="w"> </span><span class="n">interceptor</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>另一个选择是使用Binder.getProvider并在拦截器的构造函数中传递依赖项。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">NotOnWeekendsModule</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">AbstractModule</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kd">protected</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">configure</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">bindInterceptor</span><span class="p">(</span><span class="n">any</span><span class="p">(),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">annotatedWith</span><span class="p">(</span><span class="n">NotOnWeekends</span><span class="p">.</span><span class="na">class</span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="k">new</span><span class="w"> </span><span class="n">WeekendBlocker</span><span class="p">(</span><span class="n">getProvider</span><span class="p">(</span><span class="n">Calendar</span><span class="p">.</span><span class="na">class</span><span class="p">)));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><h5 id="我怎样才能回答其他问题">我怎样才能回答其他问题？&nbsp;<a class="headline-hash no-text-decoration" href="#我怎样才能回答其他问题">#</a> </h5>
<p>请发布到<a href="http://groups.google.com/group/google-guice">google-guice</a>讨论组。</p>
<h1 id="学习-guice一第一个-guice-应用">学习 Guice（一）：第一个 Guice 应用</h1>
<p>原文在：http://dyingbleed.com/guice-1/, <a href="http://dyingbleed.com/guice-2/">http://dyingbleed.com/guice-2/</a>, <a href="http://dyingbleed.com/guice-3/">http://dyingbleed.com/guice-3/</a>, 这儿照搬下来, 放在一块</p>
<p>Guice 是 Google 开发并开源的轻量级 DI （依赖注入）框架</p>
<p>GitHub 地址：<a href="https://github.com/google/guice">https://github.com/google/guice</a></p>
<h2 id="依赖">依赖&nbsp;<a class="headline-hash no-text-decoration" href="#依赖">#</a> </h2>
<p>编辑 pom.xml 文件, 添加依赖:</p>
<pre tabindex="0"><code>&lt;dependency&gt;  
    &lt;groupId&gt;com.google.inject&lt;/groupId&gt;
    &lt;artifactId&gt;guice&lt;/artifactId&gt;
    &lt;version&gt;4.1.0&lt;/version&gt;
&lt;/dependency&gt;  
</code></pre><h2 id="绑定-1">绑定&nbsp;<a class="headline-hash no-text-decoration" href="#绑定-1">#</a> </h2>
<p>定义模块类, 继承 <code>com.google.inject.AbstractModule</code> 抽象类, 实现 <code>configure</code> 方法。在 configure 方法内部, 绑定(调用 bind 方法)接口到实现类(调用 to 方法)。例子：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">ApplicationModule</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">AbstractModule</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">protected</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">configure</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">bind</span><span class="p">(</span><span class="n">UserService</span><span class="p">.</span><span class="na">class</span><span class="p">).</span><span class="na">to</span><span class="p">(</span><span class="n">UserServiceImpl</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>从名字可以看出, Impl 就是 Implement, <code>bind(UserService.class).to(UserServiceImpl.class);</code> 这句的意思就是把接口和实现绑定到一块。</p>
<h2 id="注入">注入&nbsp;<a class="headline-hash no-text-decoration" href="#注入">#</a> </h2>
<p>使用 👆 配置的 ApplicationModule 模块创建 Injector 注入器, 之后, 即可通过注入器获取实例:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">Injector</span><span class="w"> </span><span class="n">injector</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Guice</span><span class="p">.</span><span class="na">createInjector</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">ApplicationModule</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">Application</span><span class="w"> </span><span class="n">app</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">injector</span><span class="p">.</span><span class="na">getInstance</span><span class="p">(</span><span class="n">Application</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></div><p>通过 <code>@Inject</code> 注解, 注入绑定到 UserService 接口的实现类 UserServiceImpl</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Inject</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">private</span><span class="w"> </span><span class="n">UserService</span><span class="w"> </span><span class="n">userService</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><p>完整的例子：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Application</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@inject</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">UserService</span><span class="w"> </span><span class="n">userService</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Injector</span><span class="w"> </span><span class="n">injector</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Guice</span><span class="p">.</span><span class="na">createInjector</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">ApplicationModule</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Application</span><span class="w"> </span><span class="n">app</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">injector</span><span class="p">.</span><span class="na">getInstance</span><span class="p">(</span><span class="n">Application</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">app</span><span class="p">.</span><span class="na">run</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">run</span><span class="p">()</span><span class="w">  </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// use userService do something </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><h1 id="学习-guice二spark-依赖注入">学习 Guice（二）：Spark 依赖注入</h1>
<h2 id="绑定-2">绑定&nbsp;<a class="headline-hash no-text-decoration" href="#绑定-2">#</a> </h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-scala" data-lang="scala"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">ApplicationModule</span><span class="o">(</span><span class="n">spark</span><span class="k">:</span> <span class="kt">SparkSession</span><span class="o">,</span> <span class="n">date</span><span class="k">:</span> <span class="kt">LocalDate</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">AbstractModule</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">override</span> <span class="k">def</span> <span class="n">configure</span><span class="o">()</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">bind</span><span class="o">(</span><span class="n">classOf</span><span class="o">[</span><span class="kt">SparkSession</span><span class="o">]).</span><span class="n">toInstance</span><span class="o">(</span><span class="n">spark</span><span class="o">)</span> <span class="c1">// ①
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">bind</span><span class="o">(</span><span class="n">classOf</span><span class="o">[</span><span class="kt">Source</span><span class="o">]).</span><span class="n">to</span><span class="o">(</span><span class="n">classOf</span><span class="o">[</span><span class="kt">SourceImpl</span><span class="o">])</span> <span class="c1">// ②
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">bind</span><span class="o">(</span><span class="n">classOf</span><span class="o">[</span><span class="kt">Sink</span><span class="o">]).</span><span class="n">to</span><span class="o">(</span><span class="n">classOf</span><span class="o">[</span><span class="kt">SinkImpl</span><span class="o">])</span>     <span class="c1">// ③
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>① 绑定 SparkSession 实例到 SparkSession 类。</p>
<p>② 绑定 SourceImpl 实现类到 Source 接口。</p>
<p>③ 绑定 SinkImpl 实现类到 Sink 接口。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-raku" data-lang="raku"><span class="line"><span class="cl"><span class="o">&gt;</span> <span class="p">&#39;</span><span class="s1">②</span><span class="p">&#39;</span><span class="o">.</span><span class="nb">uniname</span>                    <span class="c1"># CIRCLED DIGIT TWO</span>
</span></span><span class="line"><span class="cl"><span class="o">&gt;</span> <span class="nb">say</span> <span class="p">&#34;</span><span class="se">\c</span><span class="p">[</span><span class="s">CIRCLED DIGIT THREE</span><span class="p">]&#34;</span>   <span class="c1"># ③</span>
</span></span></code></pre></div><h2 id="定义接口与实现">定义接口与实现&nbsp;<a class="headline-hash no-text-decoration" href="#定义接口与实现">#</a> </h2>
<p>接口定义举例：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-scala" data-lang="scala"><span class="line"><span class="cl"><span class="k">trait</span> <span class="nc">Source</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="n">userDF</span><span class="k">:</span> <span class="kt">DataFrame</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>实现类举例：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-scala" data-lang="scala"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">SourceImpl</span> <span class="nd">@Inject</span><span class="o">()(</span><span class="n">spark</span><span class="k">:</span> <span class="kt">SparkSession</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">Source</span> <span class="o">{</span> <span class="c1">// 注入 SparkSession 实例
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">override</span> <span class="k">def</span> <span class="n">userDF</span><span class="k">:</span> <span class="kt">DataFrame</span> <span class="o">=</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">spark</span><span class="o">.</span><span class="n">table</span><span class="o">(</span><span class="s">&#34;dw.user&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><h2 id="应用入口">应用入口&nbsp;<a class="headline-hash no-text-decoration" href="#应用入口">#</a> </h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-scala" data-lang="scala"><span class="line"><span class="cl"><span class="k">val</span> <span class="n">injector</span> <span class="k">=</span> <span class="nc">Guice</span><span class="o">.</span><span class="n">createInjector</span><span class="o">(</span><span class="k">new</span> <span class="nc">ApplicationModule</span><span class="o">(</span><span class="n">spark</span><span class="o">))</span> <span class="c1">// ①
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">injector</span><span class="o">.</span><span class="n">getInstance</span><span class="o">(</span><span class="n">classOf</span><span class="o">[</span><span class="kt">Application</span><span class="o">]).</span><span class="n">run</span><span class="o">()</span>                  <span class="c1">// ②
</span></span></span></code></pre></div><p>① 创建 Injector 实例
② 运行</p>
<p>👇 是应用程序的骨架：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-scala" data-lang="scala"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Application</span> <span class="nd">@Inject</span><span class="o">()</span> <span class="o">(</span><span class="n">spark</span><span class="k">:</span> <span class="kt">SparkSession</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Inject</span>
</span></span><span class="line"><span class="cl">    <span class="k">var</span> <span class="n">source</span><span class="k">:</span> <span class="kt">Source</span> <span class="o">=</span> <span class="k">_</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Inject</span>
</span></span><span class="line"><span class="cl">    <span class="k">var</span> <span class="n">sink</span><span class="k">:</span> <span class="kt">Sink</span> <span class="o">=</span> <span class="k">_</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="n">run</span><span class="o">()</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 处理逻辑
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><h1 id="学习-guice三spark-切面编程实践">学习 Guice（三）：Spark 切面编程实践</h1>
<h2 id="定义注解">定义注解&nbsp;<a class="headline-hash no-text-decoration" href="#定义注解">#</a> </h2>
<p>用于标注需要启用测量 Spark 指标的方法。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Retention</span><span class="p">(</span><span class="n">RetentionPolicy</span><span class="p">.</span><span class="na">RUNTIME</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nd">@Target</span><span class="p">(</span><span class="n">ElementType</span><span class="p">.</span><span class="na">METHOD</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">pubic</span><span class="w"> </span><span class="nd">@interface</span><span class="w"> </span><span class="n">EnableMeasure</span><span class="w"> </span><span class="p">{}</span><span class="w">
</span></span></span></code></pre></div><h2 id="定义方法拦截器">定义方法拦截器&nbsp;<a class="headline-hash no-text-decoration" href="#定义方法拦截器">#</a> </h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-scala" data-lang="scala"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">MeasureInterceptor</span> <span class="k">extends</span> <span class="nc">MethodInterceptor</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Inject</span>
</span></span><span class="line"><span class="cl">    <span class="k">private</span> <span class="k">var</span> <span class="n">spark</span><span class="k">:</span> <span class="kt">SparkSession</span> <span class="o">=</span> <span class="k">_</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">override</span> <span class="k">def</span> <span class="n">invoke</span><span class="o">(</span><span class="n">invocation</span><span class="k">:</span> <span class="kt">MethodInvocation</span><span class="o">)</span><span class="k">:</span> <span class="kt">AnyRef</span> <span class="o">=</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">val</span> <span class="n">listener</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">MeasureSparkListener</span>
</span></span><span class="line"><span class="cl">        <span class="n">spark</span><span class="o">.</span><span class="n">sparkContext</span><span class="o">.</span><span class="n">addSparkListener</span><span class="o">(</span><span class="n">listener</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">val</span> <span class="n">ret</span> <span class="k">=</span> <span class="n">invocation</span><span class="o">.</span><span class="n">proceed</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">ret</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><h2 id="绑定-3">绑定&nbsp;<a class="headline-hash no-text-decoration" href="#绑定-3">#</a> </h2>
<p>在 Module 的 configure 方法中, 将拦截器与注解进行绑定：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-scala" data-lang="scala"><span class="line"><span class="cl"><span class="k">val</span> <span class="n">measureInterceptor</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">MeasureInterceptor</span>
</span></span><span class="line"><span class="cl"><span class="n">requestInjection</span><span class="o">(</span><span class="n">measureInterceptor</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="n">bindInterceptor</span><span class="o">(</span><span class="nc">Matchers</span><span class="o">.</span><span class="n">any</span><span class="o">,</span> <span class="nc">Matchers</span><span class="o">.</span><span class="n">annotatedWith</span><span class="o">(</span><span class="n">classOf</span><span class="o">[</span><span class="kt">EnableMeasure</span><span class="o">]),</span> <span class="n">measureInterceptor</span> <span class="o">)</span> <span class="c1">// 绑定注解
</span></span></span></code></pre></div><h2 id="使用">使用&nbsp;<a class="headline-hash no-text-decoration" href="#使用">#</a> </h2>
<p>注入依赖</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-scala" data-lang="scala"><span class="line"><span class="cl"><span class="k">val</span> <span class="n">injector</span> <span class="k">=</span> <span class="nc">Guice</span><span class="o">.</span><span class="n">createInjector</span><span class="o">(</span><span class="n">module</span><span class="o">,</span> <span class="k">new</span> <span class="nc">ApplicationModule</span><span class="o">)</span>  <span class="c1">//  ① 创建注入器
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">injector</span><span class="o">.</span><span class="n">getInstance</span><span class="o">(</span><span class="n">classOf</span><span class="o">[</span><span class="kt">Application</span><span class="o">]).</span><span class="n">run</span><span class="o">()</span>                    <span class="c1">//  ② 获取程序实例并运行
</span></span></span></code></pre></div><p>启用：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-scala" data-lang="scala"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Application</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@EnableMeasure</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="n">run</span><span class="o">()</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// TODO
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div>

        </div>
    </div>
</article>



                <footer>
                    




<div class="no-text-decoration">
    <div class="jump top"><a href="#" title="Top of this page">⮉</a></div>
    <div class="jump bottom"><a href="#bottom" title="Bottom of this page">⮋</a></div>
</div>


 
    
        <div class="hugotoc no-text-decoration">
            <nav id="TableOfContents">
  <ul>
    <li><a href="#动机">动机</a>
      <ul>
        <li><a href="#直接构造函数调用">直接构造函数调用</a></li>
        <li><a href="#工厂">工厂</a></li>
        <li><a href="#依赖注入">依赖注入</a></li>
        <li><a href="#用-guice-进行依赖注入">用 Guice 进行依赖注入</a></li>
      </ul>
    </li>
    <li><a href="#入门">入门</a>
      <ul>
        <li><a href="#开始">开始</a></li>
      </ul>
    </li>
    <li><a href="#绑定">绑定</a>
      <ul>
        <li><a href="#创建绑定">创建绑定</a></li>
        <li><a href="#更多绑定">更多绑定</a></li>
        <li><a href="#关联绑定">关联绑定</a></li>
        <li><a href="#绑定注解">绑定注解</a></li>
        <li><a href="#实例绑定">实例绑定</a></li>
        <li><a href="#provides-方法">@Provides 方法</a></li>
        <li><a href="#provider-绑定">Provider 绑定</a></li>
        <li><a href="#无目标绑定">无目标绑定</a></li>
        <li><a href="#构造函数绑定">构造函数绑定</a></li>
        <li><a href="#内置绑定">内置绑定</a></li>
        <li><a href="#即时绑定">即时绑定</a></li>
      </ul>
    </li>
    <li><a href="#作用域">作用域</a>
      <ul>
        <li><a href="#作用域-1">作用域</a></li>
        <li><a href="#应用范围">应用范围</a></li>
        <li><a href="#eager-singletons">Eager Singletons</a></li>
        <li><a href="#选择范围">选择范围</a></li>
        <li><a href="#范围和并发">范围和并发</a></li>
        <li><a href="#注射">注射</a></li>
        <li><a href="#按需注射">按需注射</a></li>
        <li><a href="#静态注射">静态注射</a></li>
        <li><a href="#自动注射">自动注射</a></li>
      </ul>
    </li>
    <li><a href="#aop">AOP</a>
      <ul>
        <li><a href="#面向方面编程">面向方面编程</a></li>
        <li><a href="#示例周末禁止方法调用">示例：周末禁止方法调用</a></li>
        <li><a href="#限制">限制</a></li>
        <li><a href="#注入拦截器">注入拦截器</a></li>
        <li><a href="#aop联盟">AOP联盟</a></li>
      </ul>
    </li>
    <li><a href="#最佳实践">最佳实践</a>
      <ul>
        <li><a href="#尽量减少可变性">尽量减少可变性</a></li>
        <li><a href="#仅注入直接依赖项">仅注入直接依赖项</a></li>
        <li><a href="#解决循环依赖关系">解决循环依赖关系</a></li>
        <li><a href="#消除循环推荐">消除循环（推荐）</a></li>
        <li><a href="#与提供商打破周期">与提供商打破周期</a></li>
        <li><a href="#避免静态状态">避免静态状态</a></li>
        <li><a href="#使用nullable">使用@Nullable</a></li>
        <li><a href="#模块应该快速且无副作用">模块应该快速且无副作用</a></li>
        <li><a href="#注意-provider-的-io">注意 Provider 的 I/O.</a></li>
        <li><a href="#避免模块中的条件逻辑">避免模块中的条件逻辑</a></li>
        <li><a href="#保持guice实例化类的构造函数尽可能隐藏">保持Guice实例化类的构造函数尽可能隐藏。</a></li>
      </ul>
    </li>
  </ul>

  <ul>
    <li><a href="#faq">FAQ</a>
      <ul>
        <li><a href="#经常问的问题">经常问的问题</a></li>
      </ul>
    </li>
  </ul>

  <ul>
    <li><a href="#依赖">依赖</a></li>
    <li><a href="#绑定-1">绑定</a></li>
    <li><a href="#注入">注入</a></li>
  </ul>

  <ul>
    <li><a href="#绑定-2">绑定</a></li>
    <li><a href="#定义接口与实现">定义接口与实现</a></li>
    <li><a href="#应用入口">应用入口</a></li>
  </ul>

  <ul>
    <li><a href="#定义注解">定义注解</a></li>
    <li><a href="#定义方法拦截器">定义方法拦截器</a></li>
    <li><a href="#绑定-3">绑定</a></li>
    <li><a href="#使用">使用</a></li>
  </ul>
</nav>
            <a href="#" class="back-to-top">Back to top</a>
        </div>
    
    
<script src="/js/libs/jquery/3.3.1/jquery.slim.min.min.22ee3db0c0e99fd0fbce3aee19672bd53d25469daf734bd4c165649f6eaf7d7f.js"></script>

<link rel="preload" href="/js/libs/jquery/3.3.1/jquery.slim.min.min.22ee3db0c0e99fd0fbce3aee19672bd53d25469daf734bd4c165649f6eaf7d7f.js" as="script">

<script type="application/javascript">(function() {
     var $window = $(window);
     if ($window.width() >= 1400) { 
         var $toc = $('#TableOfContents');
         if ($toc.length > 0) {
             function onScroll(){
                 var currentScroll = $window.scrollTop();
                 var h = $('.content h1, .content h2, .content h3, .content h4, .content h5, .content h6, .h-feed h2');
                 var id = "";
                 h.each(function (i, e) {
                     e = $(e);
                     if (e.offset().top - 10 <= currentScroll) {
                         id = e.attr('id');
                     }
                 });
                 var current = $toc.find('a.current');
                 if (current.length == 1 && current.eq(0).attr('href') == '#' + id) return true;

                 current.each(function (i, e) {
                     $(e).removeClass('current').siblings('ul').hide();
                 });
                 $toc.find('a[href="#' + id + '"]').parentsUntil('#TableOfContents').each(function (i, e) {
                     $(e).children('a').addClass('current').siblings('ul').show();
                 });
             }
             $window.on('scroll', onScroll);
             $(document).ready(function() {
                 $toc.find('a').parent('li').find('ul').hide();
                 onScroll();
                 document.getElementsByClassName('hugotoc')[0].style.display = '';
             });}}})();</script>








<div class="backtotop center no-text-decoration">
    <a href="#">back to <span class="top">top</span></a>
</div>


<div class="right">
    <div class="taxo no-text-decoration">
         
            
                <ul class="no-bullets inline categories">
                    
                        
                        
                        
                            
                            
                            
                            
                            
                            <li class="__rakulang__"
                                
                                
                                title="See all 0 posts categorized in ‘rakulang’"
                                
                            >
                                <a class="p-category" href="https://ohmyweekly.github.io/categories/rakulang/">rakulang</a>
                            </li>
                        
                    
                </ul>
            
         
            
                <ul class="no-bullets inline tags">
                    
                        
                        
                        
                            
                            
                            
                            
                            
                            <li class="__rakulang__"
                                
                                
                                title="See all 0 posts tagged with ‘rakulang’"
                                
                            >
                                <a class="p-category" href="https://ohmyweekly.github.io/tags/rakulang/">rakulang</a>
                            </li>
                        
                    
                </ul>
            
        
    </div>

</div>
<div class="clear-float"></div>



<div class="prev-next-navigator clear-float">
    
        <span class="prev-post left no-text-decoration">
            <a href="https://ohmyweekly.github.io/notes/udaf/" class="nobr">« 用户自定义聚合函数</a>
        </span>
    
    
        <span class="next-post right no-text-decoration">
            <a href="https://ohmyweekly.github.io/notes/running-raku-on-my-phone/" class="nobr">使用 Termux 在手机中运行 Raku »</a>
        </span>
    
</div>


<a id="bottom"></a>









                       







                    <ul class="no-bullets feed right inline">
    
        
        
    
</ul>
<div class="clear-float"></div>

                </footer>
                <hr />
            </div>               

            <footer> 
                

<ul class="social no-text-decoration">
    
</ul>










 
    
    



<p class="generated no-text-decoration">
    Generated using  <a href="https://gitlab.com/kaushalmodi/hugo-theme-refined"><code class="nobr">hugo-theme-refined</code></a> + <span class="nobr">Hugo <a href="https://github.com/gohugoio/hugo/commit/312735366b20d64bd61bff8627f593749f86c964">0.123.7</a></span>
</p>

<p>
    
</p>




<div class="badges no-text-decoration">
    
    

    
</div>




<script type="application/javascript">var nav=responsiveNav("#nav");</script>




<script defer src="/js/libs/fragmentions/wrapper.min.e8c468c89edc4f5dccaa8c720c6b220b3088a16cd7b1e4a1e3345985788260c9.js"></script>









            </footer>
        </div> 
    </body>
</html>
