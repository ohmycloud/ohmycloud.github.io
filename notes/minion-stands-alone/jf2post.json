{"author":{"name":null,"type":"card","url":"https://ohmyweekly.github.io/"},"content":{"html":"\u003cp\u003e\u003ca href=\"https://mojolicious.org/perldoc/Minion\"\u003eMinion 作业队列\u003c/a\u003e是一个非常有用的工具，但有时我需要将它用于非 Web 项目。那么，如何在不需要 \u003ca href=\"http://mojolicious.org/\"\u003eMojolicious\u003c/a\u003e Web 应用程序的情况下使用 Minion？\u003c/p\u003e\n\u003cp\u003e如果我没有足够大的工作需要 \u003ca href=\"https://metacpan.org/pod/Beam::Minion\"\u003eBeam::Minion\u003c/a\u003e 提供的任务组织，虽然 Minion 可以用作\u003ca href=\"https://mojolicious.org/perldoc/Minion#SYNOPSIS\"\u003e完全独立的库\u003c/a\u003e，但最简单的解决方案就是构建一个 Mojolicious 应用程序。幸运的是，一个 Mojolicious 应用程序可以只有2行：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-perl\" data-lang=\"perl\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003euse\u003c/span\u003e \u003cspan class=\"nn\"\u003eMojolicious::Lite\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nn\"\u003eapp\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003estart\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e现在，如果我从未运行过 web 守护进程，那么这绝不会是一个网站。那么，如果没有人使用网络浏览器访问它，这可以称为 Web 应用程序吗？🤔\u003c/p\u003e\n\u003ch2 id=\"add-minion\"\u003eAdd Minion\u003c/h2\u003e\n\u003cp\u003e要使用 Minion，请将 Minion 插件添加到应用程序。对于这个例子，我将使用 \u003ca href=\"https://metacpan.org/pod/Minion::Backend::SQLite\"\u003eSQLite Minion 后端\u003c/a\u003e，这样我就不需要运行单独的数据库进程，但如果你有一个接受远程连接的数据库，Minion 可以在多台机器上工作。\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-perl\" data-lang=\"perl\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"n\"\u003eplugin\u003c/span\u003e \u003cspan class=\"n\"\u003eMinion\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"n\"\u003eSQLite\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#39;sqlite:\u0026#39;\u003c/span\u003e \u003cspan class=\"o\"\u003e.\u003c/span\u003e \u003cspan class=\"nn\"\u003eapp\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"nn\"\u003ehome\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003echild\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#39;minion.db\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e};\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e加载 Minion 插件后，我的应用程序获得了一些新功能：\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e我可以使用 \u003ca href=\"https://mojolicious.org/perldoc/Minion#add_task\"\u003eminion.add_task\u003c/a\u003e 助手程序添加 Minion 任务（可运行的代码）\u003c/li\u003e\n\u003cli\u003e我可以通过多种方式排队工作：\n\u003cul\u003e\n\u003cli\u003e从命令行使用 \u003ca href=\"https://mojolicious.org/perldoc/Minion/Command/minion/job\"\u003eminion job\u003c/a\u003e 命令\u003c/li\u003e\n\u003cli\u003e从应用程序内部使用 \u003ca href=\"https://mojolicious.org/perldoc/Minion#enqueue1\"\u003eminion.enqueue\u003c/a\u003e 助手程序\u003c/li\u003e\n\u003cli\u003e从任何 Perl 脚本加载 Minion 并使用 \u003ca href=\"https://mojolicious.org/perldoc/Minion#enqueue1\"\u003eenqueue\u003c/a\u003e 方法\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e我可以使用 \u003ca href=\"https://mojolicious.org/perldoc/Minion/Command/minion/worker\"\u003eminion worker\u003c/a\u003e 命令运行一个 Minion worker，它将执行任何排队的作业\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2 id=\"create-a-task\"\u003eCreate a Task\u003c/h2\u003e\n\u003cp\u003e我将创建一个名为 \u003ccode\u003echeck_url\u003c/code\u003e 的任务来检查下载 URL 所需的时间。 \u003ca href=\"https://perldoc.perl.org/Time/HiRes.html\"\u003eTime::HiRes\u003c/a\u003e 核心模块将为我提供高分辨率时间。\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-perl\" data-lang=\"perl\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"ch\"\u003e#!/usr/bin/env perl\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003euse\u003c/span\u003e \u003cspan class=\"nn\"\u003ev5\u003c/span\u003e\u003cspan class=\"mf\"\u003e.28\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003euse\u003c/span\u003e \u003cspan class=\"nn\"\u003eMojolicious::Lite\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003euse\u003c/span\u003e \u003cspan class=\"nn\"\u003eexperimental\u003c/span\u003e \u003cspan class=\"sx\"\u003eqw( signatures )\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003euse\u003c/span\u003e \u003cspan class=\"nn\"\u003eTime::HiRes\u003c/span\u003e \u003cspan class=\"sx\"\u003eqw( time )\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"n\"\u003eplugin\u003c/span\u003e \u003cspan class=\"n\"\u003eMinion\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"n\"\u003eSQLite\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#39;sqlite:\u0026#39;\u003c/span\u003e \u003cspan class=\"o\"\u003e.\u003c/span\u003e \u003cspan class=\"nn\"\u003eapp\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"nn\"\u003ehome\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003echild\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#39;minion.db\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e};\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nn\"\u003eapp\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"nn\"\u003eminion\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003eadd_task\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"n\"\u003echeck_url\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003esub\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e \u003cspan class=\"nv\"\u003e$job\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nv\"\u003e$url\u003c/span\u003e \u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"k\"\u003emy\u003c/span\u003e \u003cspan class=\"nv\"\u003e$start\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"nb\"\u003etime\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"k\"\u003emy\u003c/span\u003e \u003cspan class=\"nv\"\u003e$tx\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"nv\"\u003e$job\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"nn\"\u003eapp\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"nn\"\u003eua\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003ehead\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e \u003cspan class=\"nv\"\u003e$url\u003c/span\u003e \u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"k\"\u003emy\u003c/span\u003e \u003cspan class=\"nv\"\u003e$elapsed\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"nb\"\u003etime\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e \u003cspan class=\"nv\"\u003e$start\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"nv\"\u003e$job\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"nn\"\u003eapp\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"nb\"\u003elog\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003einfo\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            \u003cspan class=\"nb\"\u003esprintf\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#39;Fetching %s took %.3f seconds\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nv\"\u003e$url\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nv\"\u003e$elapsed\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"c1\"\u003e# If there\u0026#39;s an error loading the web page, fail the job\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e \u003cspan class=\"nv\"\u003e$tx\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003eerror\u003c/span\u003e \u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            \u003cspan class=\"nv\"\u003e$job\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"nn\"\u003eapp\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"nb\"\u003elog\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003eerror\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                \u003cspan class=\"nb\"\u003esprintf\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#39;Error loading URL (%s): %s (%s)\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                    \u003cspan class=\"nv\"\u003e$url\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nv\"\u003e@\u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"nv\"\u003e$tx\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003eerror\u003c/span\u003e \u003cspan class=\"p\"\u003e}{\u003c/span\u003e\u003cspan class=\"sx\"\u003eqw( code message )\u003c/span\u003e\u003cspan class=\"p\"\u003e},\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            \u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"nv\"\u003e$job\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003efail\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                \u003cspan class=\"nb\"\u003esprintf\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#39;%s: %s\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nv\"\u003e@\u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"nv\"\u003e$tx\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003eerror\u003c/span\u003e \u003cspan class=\"p\"\u003e}{\u003c/span\u003e\u003cspan class=\"sx\"\u003eqw( code message )\u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            \u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"nv\"\u003e$job\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003efinish\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e \u003cspan class=\"nv\"\u003e$elapsed\u003c/span\u003e \u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"p\"\u003e},\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nn\"\u003eapp\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003estart\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2 id=\"enqueuing-jobs\"\u003eEnqueuing Jobs\u003c/h2\u003e\n\u003cp\u003e现在我有一个任务，我可以排队一些工作。我可以使用 \u003ca href=\"https://mojolicious.org/perldoc/Minion/Command/minion/job\"\u003eminion job\u003c/a\u003e 命令添加作业：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-shell\" data-lang=\"shell\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e$ perl myapp.pl minion job -e check_url -a \u003cspan class=\"s1\"\u003e\u0026#39;[\u0026#34;http://mojolicious.org\u0026#34;]\u0026#39;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e或者通过加载Minion并使用 \u003ca href=\"https://mojolicious.org/perldoc/Minion#enqueue1\"\u003eenqueue 方法\u003c/a\u003e 从另一个 Perl 脚本内部：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-perl\" data-lang=\"perl\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"ch\"\u003e#!/usr/bin/env perl\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003euse\u003c/span\u003e \u003cspan class=\"nn\"\u003eMinion\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003emy\u003c/span\u003e \u003cspan class=\"nv\"\u003e$minion\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"nn\"\u003eMinion\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"n\"\u003eSQLite\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#39;sqlite:minion.db\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"c1\"\u003e# The same database as the worker\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003e$minion\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003eenqueue\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"n\"\u003echeck_url\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#39;http://mojolicious.org\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e],\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2 id=\"running-a-worker\"\u003eRunning a Worker\u003c/h2\u003e\n\u003cp\u003e我已经排队了工作，但没有发生任何事情，直到我使用 \u003ca href=\"https://mojolicious.org/perldoc/Minion/Command/minion/worker\"\u003eminion worker\u003c/a\u003e 命令运行一个 worker 才会发生任何事情：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-shell\" data-lang=\"shell\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e$ perl myapp.pl minion worker\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e一旦工人启动，它将立即开始处理我告诉它运行的工作。\u003c/p\u003e\n\u003cp\u003e就是这样！我在没有 Mojolicious Web 应用程序的情况下使用 Minion。查看 \u003ca href=\"https://mojolicious.io/blog/2018/12/10/minion-stands-alone/minion.pl\"\u003eMinion 应用程序\u003c/a\u003e的源代码和 \u003ca href=\"https://mojolicious.io/blog/2018/12/10/minion-stands-alone/enqueue.pl\"\u003eenqueue.pl 脚本\u003c/a\u003e。\u003c/p\u003e\n","text":"Minion 作业队列是一个非常有用的工具，但有时我需要将它用于非 Web 项目。那么，如何在不需要 Mojolicious Web 应用程序的情况下使用 Minion？\n如果我没有足够大的工作需要 Beam::Minion 提供的任务组织，虽然 Minion 可以用作完全独立的库，但最简单的解决方案就是构建一个 Mojolicious 应用程序。幸运的是，一个 Mojolicious 应用程序可以只有2行：\nuse Mojolicious::Lite; app-\u0026gt;start; 现在，如果我从未运行过 web 守护进程，那么这绝不会是一个网站。那么，如果没有人使用网络浏览器访问它，这可以称为 Web 应用程序吗？🤔\nAdd Minion 要使用 Minion，请将 Minion 插件添加到应用程序。对于这个例子，我将使用 SQLite Minion 后端，这样我就不需要运行单独的数据库进程，但如果你有一个接受远程连接的数据库，Minion 可以在多台机器上工作。\nplugin Minion =\u0026gt; { SQLite =\u0026gt; \u0026#39;sqlite:\u0026#39; . app-\u0026gt;home-\u0026gt;child(\u0026#39;minion.db\u0026#39;), }; 加载 Minion 插件后，我的应用程序获得了一些新功能：\n我可以使用 minion.add_task 助手程序添加 Minion 任务（可运行的代码） 我可以通过多种方式排队工作： 从命令行使用 minion job 命令 从应用程序内部使用 minion.enqueue 助手程序 从任何 Perl 脚本加载 Minion 并使用 enqueue 方法 我可以使用 minion worker 命令运行一个 Minion worker，它将执行任何排队的作业 Create a Task 我将创建一个名为 check_url 的任务来检查下载 URL 所需的时间。 Time::HiRes 核心模块将为我提供高分辨率时间。\n#!/usr/bin/env perl use v5.28; use Mojolicious::Lite; use experimental qw( signatures ); use Time::HiRes qw( time ); plugin Minion =\u0026gt; { SQLite =\u0026gt; \u0026#39;sqlite:\u0026#39; . app-\u0026gt;home-\u0026gt;child(\u0026#39;minion.db\u0026#39;), }; app-\u0026gt;minion-\u0026gt;add_task( check_url =\u0026gt; sub( $job, $url ) { my $start = time; my $tx = $job-\u0026gt;app-\u0026gt;ua-\u0026gt;head( $url ); my $elapsed = time - $start; $job-\u0026gt;app-\u0026gt;log-\u0026gt;info( sprintf \u0026#39;Fetching %s took %.3f seconds\u0026#39;, $url, $elapsed ); # If there\u0026#39;s an error loading the web page, fail the job if ( $tx-\u0026gt;error ) { $job-\u0026gt;app-\u0026gt;log-\u0026gt;error( sprintf \u0026#39;Error loading URL (%s): %s (%s)\u0026#39;, $url, @{ $tx-\u0026gt;error }{qw( code message )}, ); return $job-\u0026gt;fail( sprintf \u0026#39;%s: %s\u0026#39;, @{ $tx-\u0026gt;error }{qw( code message )} ); } $job-\u0026gt;finish( $elapsed ); }, ); app-\u0026gt;start; Enqueuing Jobs 现在我有一个任务，我可以排队一些工作。我可以使用 minion job 命令添加作业：\n$ perl myapp.pl minion job -e check_url -a \u0026#39;[\u0026#34;http://mojolicious.org\u0026#34;]\u0026#39; 或者通过加载Minion并使用 enqueue 方法 从另一个 Perl 脚本内部：\n#!/usr/bin/env perl use Minion; my $minion = Minion-\u0026gt;new( SQLite =\u0026gt; \u0026#39;sqlite:minion.db\u0026#39;, # The same database as the worker ); $minion-\u0026gt;enqueue( check_url =\u0026gt; [\u0026#39;http://mojolicious.org\u0026#39;], ); Running a Worker 我已经排队了工作，但没有发生任何事情，直到我使用 minion worker 命令运行一个 worker 才会发生任何事情：\n$ perl myapp.pl minion worker 一旦工人启动，它将立即开始处理我告诉它运行的工作。\n就是这样！我在没有 Mojolicious Web 应用程序的情况下使用 Minion。查看 Minion 应用程序的源代码和 enqueue.pl 脚本。\n"},"name":"第十天 - Minion Stands Alone","published":"2018-12-10T22:49:38Z","summary":"Minion 作业队列是一个非常有用的工具，但有时我需要将它用于非 Web 项目。那么，如何在不需要 Mojolicious Web 应用程序的情况下使用 Minion？\n如果我没有足够大的工作需要 Beam::Minion 提供的任务组织，虽然 Minion 可以用作完全独立的库，但最简单的解决方案就是构建一个 Mojolicious 应用程序。幸运的是，一个 Mojolicious 应用程序可以只有2行：\nuse Mojolicious::Lite; app-\u0026gt;start; 现在，如果我从未运行过 web 守护进程，那么这绝不会是一个网站。那么，如果没有人使用网络浏览器访问它，这可以称为 Web 应用程序吗？🤔\nAdd Minion 要使用 Minion，请将 Minion 插件添加到应用程序。对于这个例子，我将使用 SQLite Minion 后端，这样我就不需要运行单独的数据库进程，但如果你有一个接受远程连接的数据库，Minion 可以在多台机器上工作。\nplugin Minion =\u0026gt; { SQLite =\u0026gt; \u0026#39;sqlite:\u0026#39; . app-\u0026gt;home-\u0026gt;child(\u0026#39;minion.db\u0026#39;), }; 加载 Minion 插件后，我的应用程序获得了一些新功能：\n我可以使用 minion.add_task 助手程序添加 Minion 任务（可运行的代码） 我可以通过多种方式排队工作： 从命令行使用 minion job 命令 从应用程序内部使用 minion.enqueue 助手程序 从任何 Perl 脚本加载 Minion 并使用 enqueue 方法 我可以使用 minion worker 命令运行一个 Minion worker，它将执行任何排队的作业 Create a Task 我将创建一个名为 check_url 的任务来检查下载 URL 所需的时间。 Time::HiRes 核心模块将为我提供高分辨率时间。","type":"entry","url":"https://ohmyweekly.github.io/notes/minion-stands-alone/"}