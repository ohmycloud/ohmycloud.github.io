<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-us" lang="en-us">

    <head>
    <link href="https://gmpg.org/xfn/11" rel="profile">
    <meta charset="utf-8">
    
    
    

    
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5">

    
    <meta name="referrer" content="no-referrer">

    <title>
        
            五个用于提取和探索复杂数据类型的 Spark SQL Helper 实用程序函数 ❚ 焉知非鱼
        
    </title>

    
    


    
    
    
    

    
    
    
    

    
    
    

    
    
    
    <style>
     
     
     :root {
         --theme-color: #ac4142;
         --theme-color-light: rgba(172, 65, 66, 0.2);
     }
     
     html {
         line-height: 1.5;
     }
    </style>

    
    

    
    
    
    
    <link rel="stylesheet" href="/css/refined.min.7f6d3ee611034e4ebcbc063f1db3bc042fecdc8901afbedad80ff02bae409204.css">
    
    <link rel="preload" href="/css/refined.min.7f6d3ee611034e4ebcbc063f1db3bc042fecdc8901afbedad80ff02bae409204.css" as="style">

    



    
        <style>
         
         /* Background */ .chroma { background-color: #ffffff }
/* Error */ .chroma .err { color: #a61717; background-color: #e3d2d2 }
/* LineTableTD */ .chroma .lntd { vertical-align: top; padding: 0; margin: 0; border: 0; }
/* LineTable */ .chroma .lntable { border-spacing: 0; padding: 0; margin: 0; border: 0; width: auto; overflow: auto; display: block; }
/* LineHighlight */ .chroma .hl { display: block; width: 100%;background-color: #ffffcc }
/* LineNumbersTable */ .chroma .lnt { margin-right: 0.4em; padding: 0 0.4em 0 0.4em; }
/* LineNumbers */ .chroma .ln { margin-right: 0.4em; padding: 0 0.4em 0 0.4em; }
/* Keyword */ .chroma .k { color: #000000; font-weight: bold }
/* KeywordConstant */ .chroma .kc { color: #000000; font-weight: bold }
/* KeywordDeclaration */ .chroma .kd { color: #000000; font-weight: bold }
/* KeywordNamespace */ .chroma .kn { color: #000000; font-weight: bold }
/* KeywordPseudo */ .chroma .kp { color: #000000; font-weight: bold }
/* KeywordReserved */ .chroma .kr { color: #000000; font-weight: bold }
/* KeywordType */ .chroma .kt { color: #445588; font-weight: bold }
/* NameAttribute */ .chroma .na { color: #008080 }
/* NameBuiltin */ .chroma .nb { color: #0086b3 }
/* NameBuiltinPseudo */ .chroma .bp { color: #999999 }
/* NameClass */ .chroma .nc { color: #445588; font-weight: bold }
/* NameConstant */ .chroma .no { color: #008080 }
/* NameDecorator */ .chroma .nd { color: #3c5d5d; font-weight: bold }
/* NameEntity */ .chroma .ni { color: #800080 }
/* NameException */ .chroma .ne { color: #990000; font-weight: bold }
/* NameFunction */ .chroma .nf { color: #990000; font-weight: bold }
/* NameLabel */ .chroma .nl { color: #990000; font-weight: bold }
/* NameNamespace */ .chroma .nn { color: #555555 }
/* NameTag */ .chroma .nt { color: #000080 }
/* NameVariable */ .chroma .nv { color: #008080 }
/* NameVariableClass */ .chroma .vc { color: #008080 }
/* NameVariableGlobal */ .chroma .vg { color: #008080 }
/* NameVariableInstance */ .chroma .vi { color: #008080 }
/* LiteralString */ .chroma .s { color: #dd1144 }
/* LiteralStringAffix */ .chroma .sa { color: #dd1144 }
/* LiteralStringBacktick */ .chroma .sb { color: #dd1144 }
/* LiteralStringChar */ .chroma .sc { color: #dd1144 }
/* LiteralStringDelimiter */ .chroma .dl { color: #dd1144 }
/* LiteralStringDoc */ .chroma .sd { color: #dd1144 }
/* LiteralStringDouble */ .chroma .s2 { color: #dd1144 }
/* LiteralStringEscape */ .chroma .se { color: #dd1144 }
/* LiteralStringHeredoc */ .chroma .sh { color: #dd1144 }
/* LiteralStringInterpol */ .chroma .si { color: #dd1144 }
/* LiteralStringOther */ .chroma .sx { color: #dd1144 }
/* LiteralStringRegex */ .chroma .sr { color: #009926 }
/* LiteralStringSingle */ .chroma .s1 { color: #dd1144 }
/* LiteralStringSymbol */ .chroma .ss { color: #990073 }
/* LiteralNumber */ .chroma .m { color: #009999 }
/* LiteralNumberBin */ .chroma .mb { color: #009999 }
/* LiteralNumberFloat */ .chroma .mf { color: #009999 }
/* LiteralNumberHex */ .chroma .mh { color: #009999 }
/* LiteralNumberInteger */ .chroma .mi { color: #009999 }
/* LiteralNumberIntegerLong */ .chroma .il { color: #009999 }
/* LiteralNumberOct */ .chroma .mo { color: #009999 }
/* Operator */ .chroma .o { color: #000000; font-weight: bold }
/* OperatorWord */ .chroma .ow { color: #000000; font-weight: bold }
/* Comment */ .chroma .c { color: #999988; font-style: italic }
/* CommentHashbang */ .chroma .ch { color: #999988; font-style: italic }
/* CommentMultiline */ .chroma .cm { color: #999988; font-style: italic }
/* CommentSingle */ .chroma .c1 { color: #999988; font-style: italic }
/* CommentSpecial */ .chroma .cs { color: #999999; font-weight: bold; font-style: italic }
/* CommentPreproc */ .chroma .cp { color: #999999; font-weight: bold; font-style: italic }
/* CommentPreprocFile */ .chroma .cpf { color: #999999; font-weight: bold; font-style: italic }
/* GenericDeleted */ .chroma .gd { color: #000000; background-color: #ffdddd }
/* GenericEmph */ .chroma .ge { color: #000000; font-style: italic }
/* GenericError */ .chroma .gr { color: #aa0000 }
/* GenericHeading */ .chroma .gh { color: #999999 }
/* GenericInserted */ .chroma .gi { color: #000000; background-color: #ddffdd }
/* GenericOutput */ .chroma .go { color: #888888 }
/* GenericPrompt */ .chroma .gp { color: #555555 }
/* GenericStrong */ .chroma .gs { font-weight: bold }
/* GenericSubheading */ .chroma .gu { color: #aaaaaa }
/* GenericTraceback */ .chroma .gt { color: #aa0000 }
/* GenericUnderline */ .chroma .gl { text-decoration: underline }
/* TextWhitespace */ .chroma .w { color: #bbbbbb }

         
         /* Overrides on top of the theme and Chroma CSS */
/* Chroma-based lines highlighting in code blocks */
.chroma .hl {
    background-color: #e8e8e8;
    /* Extend highlight up to 100 characters (assuming that the code blocks never have more than 100 characters in a line) */
    min-width: 100ch;
}
/* GenericHeading */ .chroma .gh { color: #999999; font-weight: bold }
/* GenericSubheading */ .chroma .gu { color: #aaaaaa; font-weight: bold }

         
        </style>
    

    

    
    
    

    
    <script src="/js/responsive-nav-orig.min.e2b5f2a956b488f466da513820636134defdc38b90ed566248960593f2bb4ba5.js"></script>
    
    <link rel="preload" href="/js/responsive-nav-orig.min.e2b5f2a956b488f466da513820636134defdc38b90ed566248960593f2bb4ba5.js" as="script">

    
    
    <script defer src="/js/libs/fa/fontawesome-all.min.08916ac0fd078adfb58edc890460e2c8990729aee02bca7586404b56805f5219.js"></script>
    
    <link rel="preload" href="/js/libs/fa/fontawesome-all.min.08916ac0fd078adfb58edc890460e2c8990729aee02bca7586404b56805f5219.js" as="script">

    

    

    
    
    

    
    
<!-- rel="me" links for IndieAuth -->







    
 
<meta property="og:title" content="五个用于提取和探索复杂数据类型的 Spark SQL Helper 实用程序函数" />
<meta property="og:description"
      content=" " />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://ohmycloud.github.io/notes/five-spark-sql-helper-utility-functions-to-extract-and-explore-complex-data-types/" />


    
        <meta property="article:published_time" content="2018-12-12T11:26:52&#43;00:00"/>
    
    
        <meta property="article:modified_time" content="2018-12-12T11:26:52&#43;00:00"/>
    









    




     <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="五个用于提取和探索复杂数据类型的 Spark SQL Helper 实用程序函数"/>
<meta name="twitter:description" content=" "/>


    
    
    <link rel="alternate" type="application/jf2post+json" href="https://ohmycloud.github.io/notes/five-spark-sql-helper-utility-functions-to-extract-and-explore-complex-data-types/jf2post.json" title="Jf2post for 焉知非鱼" />
    
     



    
    
    
        
    


     
        
        <meta name="DC.Creator" content="焉知非鱼"/>
    



    
    
    
    <meta name="hugo-build-date" content="2024-03-01T16:16:06Z"/>
    <meta name="hugo-commit-hash" content="312735366b20d64bd61bff8627f593749f86c964"/>
    <meta name="generator" content="Hugo 0.123.7">
</head>


    
        <body lang="en">
    

        
        <div class="border" id="home"></div>

        <div class="wrapper">   
            
<nav id="nav" class="nav-collapse opened" aria-hidden="false">
    <ul class="navbar">
        <li><a class="" href="/">Home</a></li>
        
            
                <li><a class="" href="https://ohmycloud.github.io/posts/">Posts</a></li>
            
        
            
                <li><a class="" href="https://ohmycloud.github.io/notes/">Notes</a></li>
            
        
        
            <li><a class="" href="https://ohmycloud.github.io/search/">Search</a></li>
        
    </ul>
</nav>

            <div class="container">
                <header class="masthead">
                    <div class="masthead-title no-text-decoration">
                        <a href="/">焉知非鱼</a> <span class="blinking-cursor">❚</span>
                    </div>
                    <div class="masthead-tagline">
                        Wait the light to fall
                    </div>
                </header>

                








<article class="post h-entry notes">
    <header>
        <div class="center">
    <div class="taxo no-text-decoration">
         
            
                <ul class="no-bullets inline categories">
                    
                        
                        
                        
                            
                            
                            
                            
                            
                            <li class="__rakulang__"
                                
                                
                                title="See all 0 posts categorized in ‘rakulang’"
                                
                            >
                                <a class="p-category" href="https://ohmycloud.github.io/categories/rakulang/">rakulang</a>
                            </li>
                        
                    
                </ul>
            
         
            
                <ul class="no-bullets inline tags">
                    
                        
                        
                        
                            
                            
                            
                            
                            
                            <li class="__rakulang__"
                                
                                
                                title="See all 0 posts tagged with ‘rakulang’"
                                
                            >
                                <a class="p-category" href="https://ohmycloud.github.io/tags/rakulang/">rakulang</a>
                            </li>
                        
                    
                </ul>
            
        
    </div>

</div>

        <h1 class="post-title p-name">五个用于提取和探索复杂数据类型的 Spark SQL Helper 实用程序函数</h1>

        
        <data class="u-url" value="https://ohmycloud.github.io/notes/five-spark-sql-helper-utility-functions-to-extract-and-explore-complex-data-types/"></data>

        <div class="date-syndication">
            


    
    
    <div class="post-date">
        
        <time datetime="2018-12-12T11:26:52+0000" class="dt-published">Wed Dec 12, 2018</time>
        
        
    </div>


            




        </div>
         



    
    
    
        
    


    
        
        <span class="hide">
            &mdash; <a href="https://ohmycloud.github.io/" class="u-author">焉知非鱼</a>
        </span>
    


    </header>

    <div class="content">
        


        





                       


        <div class="e-content">
            




<p><a href="https://docs.databricks.com/_static/notebooks/complex-nested-structured.html">https://docs.databricks.com/_static/notebooks/complex-nested-structured.html</a></p>
<p>虽然<a href="https://databricks.com/blog/2017/02/23/working-complex-data-formats-structured-streaming-apache-spark-2-1.html">这个深入的博客列出并解释了处理和处理复杂数据类型和格式的概念和动机</a>，但这个笔记本示例通过几个具体示例检查了如何将它们应用于您在使用中可能遇到的数据类型案例。这个简短的笔记本教程展示了一些方法，您可以在其中探索和使用许多新的帮助程序 Spark SQL 实用程序函数和 API 作为<code>org.apache.spark.sql.functions</code> 包的一部分。特别是，它们在执行 Streaming ETL 时派上用场，其中数据是具有复杂和嵌套结构的 JSON 对象：嵌入为 JSON 的 Map 和 Structs：</p>
<p>_ get_json_object()<br>
_ from_json()<br>
_ to_json()<br>
_ explode()<br>
_ selectExpr()</p>
<p>本简短教程的内容是使用 Spark SQL 实用程序函数对嵌套 JSON 结构进行切片和切块的无数方法。</p>
<p>让我们创建一个带有属性和值的简单 JSON 模式，而不使用任何嵌套结构。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-scala" data-lang="scala"><span class="line"><span class="cl"><span class="k">import</span> <span class="nn">org.apache.spark.sql.types._</span>                         <span class="c1">// include the Spark Types to define our schema
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">import</span> <span class="nn">org.apache.spark.sql.functions._</span>                     <span class="c1">// include the Spark helper functions
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="k">val</span> <span class="n">jsonSchema</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">StructType</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">        <span class="o">.</span><span class="n">add</span><span class="o">(</span><span class="s">&#34;battery_level&#34;</span><span class="o">,</span> <span class="nc">LongType</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">        <span class="o">.</span><span class="n">add</span><span class="o">(</span><span class="s">&#34;c02_level&#34;</span><span class="o">,</span> <span class="nc">LongType</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">        <span class="o">.</span><span class="n">add</span><span class="o">(</span><span class="s">&#34;cca3&#34;</span><span class="o">,</span><span class="nc">StringType</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">        <span class="o">.</span><span class="n">add</span><span class="o">(</span><span class="s">&#34;cn&#34;</span><span class="o">,</span> <span class="nc">StringType</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">        <span class="o">.</span><span class="n">add</span><span class="o">(</span><span class="s">&#34;device_id&#34;</span><span class="o">,</span> <span class="nc">LongType</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">        <span class="o">.</span><span class="n">add</span><span class="o">(</span><span class="s">&#34;device_type&#34;</span><span class="o">,</span> <span class="nc">StringType</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">        <span class="o">.</span><span class="n">add</span><span class="o">(</span><span class="s">&#34;signal&#34;</span><span class="o">,</span> <span class="nc">LongType</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">        <span class="o">.</span><span class="n">add</span><span class="o">(</span><span class="s">&#34;ip&#34;</span><span class="o">,</span> <span class="nc">StringType</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">        <span class="o">.</span><span class="n">add</span><span class="o">(</span><span class="s">&#34;temp&#34;</span><span class="o">,</span> <span class="nc">LongType</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">        <span class="o">.</span><span class="n">add</span><span class="o">(</span><span class="s">&#34;timestamp&#34;</span><span class="o">,</span> <span class="nc">TimestampType</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">import</span> <span class="nn">org.apache.spark.sql.types._</span>
</span></span><span class="line"><span class="cl"><span class="k">import</span> <span class="nn">org.apache.spark.sql.functions._</span>
</span></span><span class="line"><span class="cl"><span class="n">jsonSchema</span><span class="k">:</span> <span class="kt">org.apache.spark.sql.</span><span class="k">type</span><span class="kt">s.StructType</span> <span class="o">=</span> <span class="nc">StructType</span><span class="o">(</span><span class="nc">StructField</span><span class="o">(</span><span class="n">battery_level</span><span class="o">,</span><span class="nc">LongType</span><span class="o">,</span><span class="kc">true</span><span class="o">),</span> <span class="nc">StructField</span><span class="o">(</span><span class="n">c02_level</span><span class="o">,</span><span class="nc">LongType</span><span class="o">,</span><span class="kc">true</span><span class="o">),</span> <span class="nc">StructField</span><span class="o">(</span><span class="n">cca3</span><span class="o">,</span><span class="nc">StringType</span><span class="o">,</span><span class="kc">true</span><span class="o">),</span> <span class="nc">StructField</span><span class="o">(</span><span class="n">cn</span><span class="o">,</span><span class="nc">StringType</span><span class="o">,</span><span class="kc">true</span><span class="o">),</span> <span class="nc">StructField</span><span class="o">(</span><span class="n">device_id</span><span class="o">,</span><span class="nc">LongType</span><span class="o">,</span><span class="kc">true</span><span class="o">),</span> <span class="nc">StructField</span><span class="o">(</span><span class="n">device_type</span><span class="o">,</span><span class="nc">StringType</span><span class="o">,</span><span class="kc">true</span><span class="o">),</span> <span class="nc">StructField</span><span class="o">(</span><span class="n">signal</span><span class="o">,</span><span class="nc">LongType</span><span class="o">,</span><span class="kc">true</span><span class="o">),</span> <span class="nc">StructField</span><span class="o">(</span><span class="n">ip</span><span class="o">,</span><span class="nc">StringType</span><span class="o">,</span><span class="kc">true</span><span class="o">),</span> <span class="nc">StructField</span><span class="o">(</span><span class="n">temp</span><span class="o">,</span><span class="nc">LongType</span><span class="o">,</span><span class="kc">true</span><span class="o">),</span> <span class="nc">StructField</span><span class="o">(</span><span class="n">timestamp</span><span class="o">,</span><span class="nc">TimestampType</span><span class="o">,</span><span class="kc">true</span><span class="o">))</span>
</span></span></code></pre></div><p>使用上面的模式，创建一个表示为 Scala case 类的 Dataset，并生成与之关联的一些 JSON 数据。很可能，这个 JSON 也可能是从 Kafka 主题读取的设备事件流。请注意，case 类有两个字段：integer（作为设备ID）和 string（作为表示设备事件的 JSON 字符串）。</p>
<h2 id="从上面的-schema-创建-dataset">从上面的 schema 创建 Dataset&nbsp;<a class="headline-hash no-text-decoration" href="#从上面的-schema-创建-dataset">#</a> </h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-scala" data-lang="scala"><span class="line"><span class="cl"><span class="c1">// define a case class
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">case</span> <span class="k">class</span> <span class="nc">DeviceData</span> <span class="o">(</span><span class="n">id</span><span class="k">:</span> <span class="kt">Int</span><span class="o">,</span> <span class="n">device</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">// create some sample data
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">val</span> <span class="n">eventsDS</span> <span class="k">=</span> <span class="nc">Seq</span> <span class="o">(</span>
</span></span><span class="line"><span class="cl"> <span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="s">&#34;&#34;&#34;{&#34;device_id&#34;: 0, &#34;device_type&#34;: &#34;sensor-ipad&#34;, &#34;ip&#34;: &#34;68.161.225.1&#34;, &#34;cca3&#34;: &#34;USA&#34;, &#34;cn&#34;: &#34;United States&#34;, &#34;temp&#34;: 25, &#34;signal&#34;: 23, &#34;battery_level&#34;: 8, &#34;c02_level&#34;: 917, &#34;timestamp&#34; :1475600496 }&#34;&#34;&#34;</span><span class="o">),</span>
</span></span><span class="line"><span class="cl"> <span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="s">&#34;&#34;&#34;{&#34;device_id&#34;: 1, &#34;device_type&#34;: &#34;sensor-igauge&#34;, &#34;ip&#34;: &#34;213.161.254.1&#34;, &#34;cca3&#34;: &#34;NOR&#34;, &#34;cn&#34;: &#34;Norway&#34;, &#34;temp&#34;: 30, &#34;signal&#34;: 18, &#34;battery_level&#34;: 6, &#34;c02_level&#34;: 1413, &#34;timestamp&#34; :1475600498 }&#34;&#34;&#34;</span><span class="o">),</span>
</span></span><span class="line"><span class="cl"> <span class="o">(</span><span class="mi">2</span><span class="o">,</span> <span class="s">&#34;&#34;&#34;{&#34;device_id&#34;: 2, &#34;device_type&#34;: &#34;sensor-ipad&#34;, &#34;ip&#34;: &#34;88.36.5.1&#34;, &#34;cca3&#34;: &#34;ITA&#34;, &#34;cn&#34;: &#34;Italy&#34;, &#34;temp&#34;: 18, &#34;signal&#34;: 25, &#34;battery_level&#34;: 5, &#34;c02_level&#34;: 1372, &#34;timestamp&#34; :1475600500 }&#34;&#34;&#34;</span><span class="o">),</span>
</span></span><span class="line"><span class="cl"> <span class="o">(</span><span class="mi">3</span><span class="o">,</span> <span class="s">&#34;&#34;&#34;{&#34;device_id&#34;: 3, &#34;device_type&#34;: &#34;sensor-inest&#34;, &#34;ip&#34;: &#34;66.39.173.154&#34;, &#34;cca3&#34;: &#34;USA&#34;, &#34;cn&#34;: &#34;United States&#34;, &#34;temp&#34;: 47, &#34;signal&#34;: 12, &#34;battery_level&#34;: 1, &#34;c02_level&#34;: 1447, &#34;timestamp&#34; :1475600502 }&#34;&#34;&#34;</span><span class="o">),</span>
</span></span><span class="line"><span class="cl"><span class="o">(</span><span class="mi">4</span><span class="o">,</span> <span class="s">&#34;&#34;&#34;{&#34;device_id&#34;: 4, &#34;device_type&#34;: &#34;sensor-ipad&#34;, &#34;ip&#34;: &#34;203.82.41.9&#34;, &#34;cca3&#34;: &#34;PHL&#34;, &#34;cn&#34;: &#34;Philippines&#34;, &#34;temp&#34;: 29, &#34;signal&#34;: 11, &#34;battery_level&#34;: 0, &#34;c02_level&#34;: 983, &#34;timestamp&#34; :1475600504 }&#34;&#34;&#34;</span><span class="o">),</span>
</span></span><span class="line"><span class="cl"><span class="o">(</span><span class="mi">5</span><span class="o">,</span> <span class="s">&#34;&#34;&#34;{&#34;device_id&#34;: 5, &#34;device_type&#34;: &#34;sensor-istick&#34;, &#34;ip&#34;: &#34;204.116.105.67&#34;, &#34;cca3&#34;: &#34;USA&#34;, &#34;cn&#34;: &#34;United States&#34;, &#34;temp&#34;: 50, &#34;signal&#34;: 16, &#34;battery_level&#34;: 8, &#34;c02_level&#34;: 1574, &#34;timestamp&#34; :1475600506 }&#34;&#34;&#34;</span><span class="o">),</span>
</span></span><span class="line"><span class="cl"><span class="o">(</span><span class="mi">6</span><span class="o">,</span> <span class="s">&#34;&#34;&#34;{&#34;device_id&#34;: 6, &#34;device_type&#34;: &#34;sensor-ipad&#34;, &#34;ip&#34;: &#34;220.173.179.1&#34;, &#34;cca3&#34;: &#34;CHN&#34;, &#34;cn&#34;: &#34;China&#34;, &#34;temp&#34;: 21, &#34;signal&#34;: 18, &#34;battery_level&#34;: 9, &#34;c02_level&#34;: 1249, &#34;timestamp&#34; :1475600508 }&#34;&#34;&#34;</span><span class="o">),</span>
</span></span><span class="line"><span class="cl"><span class="o">(</span><span class="mi">7</span><span class="o">,</span> <span class="s">&#34;&#34;&#34;{&#34;device_id&#34;: 7, &#34;device_type&#34;: &#34;sensor-ipad&#34;, &#34;ip&#34;: &#34;118.23.68.227&#34;, &#34;cca3&#34;: &#34;JPN&#34;, &#34;cn&#34;: &#34;Japan&#34;, &#34;temp&#34;: 27, &#34;signal&#34;: 15, &#34;battery_level&#34;: 0, &#34;c02_level&#34;: 1531, &#34;timestamp&#34; :1475600512 }&#34;&#34;&#34;</span><span class="o">),</span>
</span></span><span class="line"><span class="cl"><span class="o">(</span><span class="mi">8</span> <span class="o">,</span><span class="s">&#34;&#34;&#34; {&#34;device_id&#34;: 8, &#34;device_type&#34;: &#34;sensor-inest&#34;, &#34;ip&#34;: &#34;208.109.163.218&#34;, &#34;cca3&#34;: &#34;USA&#34;, &#34;cn&#34;: &#34;United States&#34;, &#34;temp&#34;: 40, &#34;signal&#34;: 16, &#34;battery_level&#34;: 9, &#34;c02_level&#34;: 1208, &#34;timestamp&#34; :1475600514 }&#34;&#34;&#34;</span><span class="o">),</span>
</span></span><span class="line"><span class="cl"><span class="o">(</span><span class="mi">9</span><span class="o">,</span><span class="s">&#34;&#34;&#34;{&#34;device_id&#34;: 9, &#34;device_type&#34;: &#34;sensor-ipad&#34;, &#34;ip&#34;: &#34;88.213.191.34&#34;, &#34;cca3&#34;: &#34;ITA&#34;, &#34;cn&#34;: &#34;Italy&#34;, &#34;temp&#34;: 19, &#34;signal&#34;: 11, &#34;battery_level&#34;: 0, &#34;c02_level&#34;: 1171, &#34;timestamp&#34; :1475600516 }&#34;&#34;&#34;</span><span class="o">),</span>
</span></span><span class="line"><span class="cl"><span class="o">(</span><span class="mi">10</span><span class="o">,</span><span class="s">&#34;&#34;&#34;{&#34;device_id&#34;: 10, &#34;device_type&#34;: &#34;sensor-igauge&#34;, &#34;ip&#34;: &#34;68.28.91.22&#34;, &#34;cca3&#34;: &#34;USA&#34;, &#34;cn&#34;: &#34;United States&#34;, &#34;temp&#34;: 32, &#34;signal&#34;: 26, &#34;battery_level&#34;: 7, &#34;c02_level&#34;: 886, &#34;timestamp&#34; :1475600518 }&#34;&#34;&#34;</span><span class="o">),</span>
</span></span><span class="line"><span class="cl"><span class="o">(</span><span class="mi">11</span><span class="o">,</span><span class="s">&#34;&#34;&#34;{&#34;device_id&#34;: 11, &#34;device_type&#34;: &#34;sensor-ipad&#34;, &#34;ip&#34;: &#34;59.144.114.250&#34;, &#34;cca3&#34;: &#34;IND&#34;, &#34;cn&#34;: &#34;India&#34;, &#34;temp&#34;: 46, &#34;signal&#34;: 25, &#34;battery_level&#34;: 4, &#34;c02_level&#34;: 863, &#34;timestamp&#34; :1475600520 }&#34;&#34;&#34;</span><span class="o">),</span>
</span></span><span class="line"><span class="cl"><span class="o">(</span><span class="mi">12</span><span class="o">,</span> <span class="s">&#34;&#34;&#34;{&#34;device_id&#34;: 12, &#34;device_type&#34;: &#34;sensor-igauge&#34;, &#34;ip&#34;: &#34;193.156.90.200&#34;, &#34;cca3&#34;: &#34;NOR&#34;, &#34;cn&#34;: &#34;Norway&#34;, &#34;temp&#34;: 18, &#34;signal&#34;: 26, &#34;battery_level&#34;: 8, &#34;c02_level&#34;: 1220, &#34;timestamp&#34; :1475600522 }&#34;&#34;&#34;</span><span class="o">),</span>
</span></span><span class="line"><span class="cl"><span class="o">(</span><span class="mi">13</span><span class="o">,</span> <span class="s">&#34;&#34;&#34;{&#34;device_id&#34;: 13, &#34;device_type&#34;: &#34;sensor-ipad&#34;, &#34;ip&#34;: &#34;67.185.72.1&#34;, &#34;cca3&#34;: &#34;USA&#34;, &#34;cn&#34;: &#34;United States&#34;, &#34;temp&#34;: 34, &#34;signal&#34;: 20, &#34;battery_level&#34;: 8, &#34;c02_level&#34;: 1504, &#34;timestamp&#34; :1475600524 }&#34;&#34;&#34;</span><span class="o">),</span>
</span></span><span class="line"><span class="cl"><span class="o">(</span><span class="mi">14</span><span class="o">,</span> <span class="s">&#34;&#34;&#34;{&#34;device_id&#34;: 14, &#34;device_type&#34;: &#34;sensor-inest&#34;, &#34;ip&#34;: &#34;68.85.85.106&#34;, &#34;cca3&#34;: &#34;USA&#34;, &#34;cn&#34;: &#34;United States&#34;, &#34;temp&#34;: 39, &#34;signal&#34;: 17, &#34;battery_level&#34;: 8, &#34;c02_level&#34;: 831, &#34;timestamp&#34; :1475600526 }&#34;&#34;&#34;</span><span class="o">),</span>
</span></span><span class="line"><span class="cl"><span class="o">(</span><span class="mi">15</span><span class="o">,</span> <span class="s">&#34;&#34;&#34;{&#34;device_id&#34;: 15, &#34;device_type&#34;: &#34;sensor-ipad&#34;, &#34;ip&#34;: &#34;161.188.212.254&#34;, &#34;cca3&#34;: &#34;USA&#34;, &#34;cn&#34;: &#34;United States&#34;, &#34;temp&#34;: 27, &#34;signal&#34;: 26, &#34;battery_level&#34;: 5, &#34;c02_level&#34;: 1378, &#34;timestamp&#34; :1475600528 }&#34;&#34;&#34;</span><span class="o">),</span>
</span></span><span class="line"><span class="cl"><span class="o">(</span><span class="mi">16</span><span class="o">,</span> <span class="s">&#34;&#34;&#34;{&#34;device_id&#34;: 16, &#34;device_type&#34;: &#34;sensor-igauge&#34;, &#34;ip&#34;: &#34;221.3.128.242&#34;, &#34;cca3&#34;: &#34;CHN&#34;, &#34;cn&#34;: &#34;China&#34;, &#34;temp&#34;: 10, &#34;signal&#34;: 24, &#34;battery_level&#34;: 6, &#34;c02_level&#34;: 1423, &#34;timestamp&#34; :1475600530 }&#34;&#34;&#34;</span><span class="o">),</span>
</span></span><span class="line"><span class="cl"><span class="o">(</span><span class="mi">17</span><span class="o">,</span> <span class="s">&#34;&#34;&#34;{&#34;device_id&#34;: 17, &#34;device_type&#34;: &#34;sensor-ipad&#34;, &#34;ip&#34;: &#34;64.124.180.215&#34;, &#34;cca3&#34;: &#34;USA&#34;, &#34;cn&#34;: &#34;United States&#34;, &#34;temp&#34;: 38, &#34;signal&#34;: 17, &#34;battery_level&#34;: 9, &#34;c02_level&#34;: 1304, &#34;timestamp&#34; :1475600532 }&#34;&#34;&#34;</span><span class="o">),</span>
</span></span><span class="line"><span class="cl"><span class="o">(</span><span class="mi">18</span><span class="o">,</span> <span class="s">&#34;&#34;&#34;{&#34;device_id&#34;: 18, &#34;device_type&#34;: &#34;sensor-igauge&#34;, &#34;ip&#34;: &#34;66.153.162.66&#34;, &#34;cca3&#34;: &#34;USA&#34;, &#34;cn&#34;: &#34;United States&#34;, &#34;temp&#34;: 26, &#34;signal&#34;: 10, &#34;battery_level&#34;: 0, &#34;c02_level&#34;: 902, &#34;timestamp&#34; :1475600534 }&#34;&#34;&#34;</span><span class="o">),</span>
</span></span><span class="line"><span class="cl"><span class="o">(</span><span class="mi">19</span><span class="o">,</span> <span class="s">&#34;&#34;&#34;{&#34;device_id&#34;: 19, &#34;device_type&#34;: &#34;sensor-ipad&#34;, &#34;ip&#34;: &#34;193.200.142.254&#34;, &#34;cca3&#34;: &#34;AUT&#34;, &#34;cn&#34;: &#34;Austria&#34;, &#34;temp&#34;: 32, &#34;signal&#34;: 27, &#34;battery_level&#34;: 5, &#34;c02_level&#34;: 1282, &#34;timestamp&#34; :1475600536 }&#34;&#34;&#34;</span><span class="o">)).</span><span class="n">toDF</span><span class="o">(</span><span class="s">&#34;id&#34;</span><span class="o">,</span> <span class="s">&#34;device&#34;</span><span class="o">).</span><span class="n">as</span><span class="o">[</span><span class="kt">DeviceData</span><span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="n">defined</span> <span class="k">class</span> <span class="nc">DeviceData</span>
</span></span><span class="line"><span class="cl"><span class="n">eventsDS</span><span class="k">:</span> <span class="kt">org.apache.spark.sql.Dataset</span><span class="o">[</span><span class="kt">DeviceData</span><span class="o">]</span> <span class="k">=</span> <span class="o">[</span><span class="kt">id:</span> <span class="kt">int</span>, <span class="kt">device:</span> <span class="kt">string</span><span class="o">]</span>
</span></span></code></pre></div><p>我们的 Dataset 是 Scala case 类的集合，当显示为 DataFrame 时，有两列 (id, string)</p>
<pre tabindex="0"><code>display(eventsDS)
</code></pre><table>
<thead>
<tr>
<th style="text-align:left">id</th>
<th style="text-align:left">device</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">0</td>
<td style="text-align:left">{&ldquo;device_id&rdquo;: 0, &ldquo;device_type&rdquo;: &ldquo;sensor-ipad&rdquo;, &ldquo;ip&rdquo;: &ldquo;68.161.225.1&rdquo;, &ldquo;cca3&rdquo;: &ldquo;USA&rdquo;, &ldquo;cn&rdquo;: &ldquo;United States&rdquo;, &ldquo;temp&rdquo;: 25, &ldquo;signal&rdquo;: 23, &ldquo;battery_level&rdquo;: 8, &ldquo;c02_level&rdquo;: 917, &ldquo;timestamp&rdquo; :1475600496 }</td>
</tr>
<tr>
<td style="text-align:left">1</td>
<td style="text-align:left">{&ldquo;device_id&rdquo;: 1, &ldquo;device_type&rdquo;: &ldquo;sensor-igauge&rdquo;, &ldquo;ip&rdquo;: &ldquo;213.161.254.1&rdquo;, &ldquo;cca3&rdquo;: &ldquo;NOR&rdquo;, &ldquo;cn&rdquo;: &ldquo;Norway&rdquo;, &ldquo;temp&rdquo;: 30, &ldquo;signal&rdquo;: 18, &ldquo;battery_level&rdquo;: 6, &ldquo;c02_level&rdquo;: 1413, &ldquo;timestamp&rdquo; :1475600498 }</td>
</tr>
<tr>
<td style="text-align:left">2</td>
<td style="text-align:left">{&ldquo;device_id&rdquo;: 2, &ldquo;device_type&rdquo;: &ldquo;sensor-ipad&rdquo;, &ldquo;ip&rdquo;: &ldquo;88.36.5.1&rdquo;, &ldquo;cca3&rdquo;: &ldquo;ITA&rdquo;, &ldquo;cn&rdquo;: &ldquo;Italy&rdquo;, &ldquo;temp&rdquo;: 18, &ldquo;signal&rdquo;: 25, &ldquo;battery_level&rdquo;: 5, &ldquo;c02_level&rdquo;: 1372, &ldquo;timestamp&rdquo; :1475600500 }</td>
</tr>
<tr>
<td style="text-align:left">3</td>
<td style="text-align:left">{&ldquo;device_id&rdquo;: 3, &ldquo;device_type&rdquo;: &ldquo;sensor-inest&rdquo;, &ldquo;ip&rdquo;: &ldquo;66.39.173.154&rdquo;, &ldquo;cca3&rdquo;: &ldquo;USA&rdquo;, &ldquo;cn&rdquo;: &ldquo;United States&rdquo;, &ldquo;temp&rdquo;: 47, &ldquo;signal&rdquo;: 12, &ldquo;battery_level&rdquo;: 1, &ldquo;c02_level&rdquo;: 1447, &ldquo;timestamp&rdquo; :1475600502 }</td>
</tr>
<tr>
<td style="text-align:left">4</td>
<td style="text-align:left">{&ldquo;device_id&rdquo;: 4, &ldquo;device_type&rdquo;: &ldquo;sensor-ipad&rdquo;, &ldquo;ip&rdquo;: &ldquo;203.82.41.9&rdquo;, &ldquo;cca3&rdquo;: &ldquo;PHL&rdquo;, &ldquo;cn&rdquo;: &ldquo;Philippines&rdquo;, &ldquo;temp&rdquo;: 29, &ldquo;signal&rdquo;: 11, &ldquo;battery_level&rdquo;: 0, &ldquo;c02_level&rdquo;: 983, &ldquo;timestamp&rdquo; :1475600504 }</td>
</tr>
<tr>
<td style="text-align:left">5</td>
<td style="text-align:left">{&ldquo;device_id&rdquo;: 5, &ldquo;device_type&rdquo;: &ldquo;sensor-istick&rdquo;, &ldquo;ip&rdquo;: &ldquo;204.116.105.67&rdquo;, &ldquo;cca3&rdquo;: &ldquo;USA&rdquo;, &ldquo;cn&rdquo;: &ldquo;United States&rdquo;, &ldquo;temp&rdquo;: 50, &ldquo;signal&rdquo;: 16, &ldquo;battery_level&rdquo;: 8, &ldquo;c02_level&rdquo;: 1574, &ldquo;timestamp&rdquo; :1475600506 }</td>
</tr>
<tr>
<td style="text-align:left">6</td>
<td style="text-align:left">{&ldquo;device_id&rdquo;: 6, &ldquo;device_type&rdquo;: &ldquo;sensor-ipad&rdquo;, &ldquo;ip&rdquo;: &ldquo;220.173.179.1&rdquo;, &ldquo;cca3&rdquo;: &ldquo;CHN&rdquo;, &ldquo;cn&rdquo;: &ldquo;China&rdquo;, &ldquo;temp&rdquo;: 21, &ldquo;signal&rdquo;: 18, &ldquo;battery_level&rdquo;: 9, &ldquo;c02_level&rdquo;: 1249, &ldquo;timestamp&rdquo; :1475600508 }</td>
</tr>
<tr>
<td style="text-align:left">7</td>
<td style="text-align:left">{&ldquo;device_id&rdquo;: 7, &ldquo;device_type&rdquo;: &ldquo;sensor-ipad&rdquo;, &ldquo;ip&rdquo;: &ldquo;118.23.68.227&rdquo;, &ldquo;cca3&rdquo;: &ldquo;JPN&rdquo;, &ldquo;cn&rdquo;: &ldquo;Japan&rdquo;, &ldquo;temp&rdquo;: 27, &ldquo;signal&rdquo;: 15, &ldquo;battery_level&rdquo;: 0, &ldquo;c02_level&rdquo;: 1531, &ldquo;timestamp&rdquo; :1475600512 }</td>
</tr>
<tr>
<td style="text-align:left">8</td>
<td style="text-align:left">{&ldquo;device_id&rdquo;: 8, &ldquo;device_type&rdquo;: &ldquo;sensor-inest&rdquo;, &ldquo;ip&rdquo;: &ldquo;208.109.163.218&rdquo;, &ldquo;cca3&rdquo;: &ldquo;USA&rdquo;, &ldquo;cn&rdquo;: &ldquo;United States&rdquo;, &ldquo;temp&rdquo;: 40, &ldquo;signal&rdquo;: 16, &ldquo;battery_level&rdquo;: 9, &ldquo;c02_level&rdquo;: 1208, &ldquo;timestamp&rdquo; :1475600514 }</td>
</tr>
<tr>
<td style="text-align:left">9</td>
<td style="text-align:left">{&ldquo;device_id&rdquo;: 9, &ldquo;device_type&rdquo;: &ldquo;sensor-ipad&rdquo;, &ldquo;ip&rdquo;: &ldquo;88.213.191.34&rdquo;, &ldquo;cca3&rdquo;: &ldquo;ITA&rdquo;, &ldquo;cn&rdquo;: &ldquo;Italy&rdquo;, &ldquo;temp&rdquo;: 19, &ldquo;signal&rdquo;: 11, &ldquo;battery_level&rdquo;: 0, &ldquo;c02_level&rdquo;: 1171, &ldquo;timestamp&rdquo; :1475600516 }</td>
</tr>
<tr>
<td style="text-align:left">10</td>
<td style="text-align:left">{&ldquo;device_id&rdquo;: 10, &ldquo;device_type&rdquo;: &ldquo;sensor-igauge&rdquo;, &ldquo;ip&rdquo;: &ldquo;68.28.91.22&rdquo;, &ldquo;cca3&rdquo;: &ldquo;USA&rdquo;, &ldquo;cn&rdquo;: &ldquo;United States&rdquo;, &ldquo;temp&rdquo;: 32, &ldquo;signal&rdquo;: 26, &ldquo;battery_level&rdquo;: 7, &ldquo;c02_level&rdquo;: 886, &ldquo;timestamp&rdquo; :1475600518 }</td>
</tr>
<tr>
<td style="text-align:left">11</td>
<td style="text-align:left">{&ldquo;device_id&rdquo;: 11, &ldquo;device_type&rdquo;: &ldquo;sensor-ipad&rdquo;, &ldquo;ip&rdquo;: &ldquo;59.144.114.250&rdquo;, &ldquo;cca3&rdquo;: &ldquo;IND&rdquo;, &ldquo;cn&rdquo;: &ldquo;India&rdquo;, &ldquo;temp&rdquo;: 46, &ldquo;signal&rdquo;: 25, &ldquo;battery_level&rdquo;: 4, &ldquo;c02_level&rdquo;: 863, &ldquo;timestamp&rdquo; :1475600520 }</td>
</tr>
<tr>
<td style="text-align:left">12</td>
<td style="text-align:left">{&ldquo;device_id&rdquo;: 12, &ldquo;device_type&rdquo;: &ldquo;sensor-igauge&rdquo;, &ldquo;ip&rdquo;: &ldquo;193.156.90.200&rdquo;, &ldquo;cca3&rdquo;: &ldquo;NOR&rdquo;, &ldquo;cn&rdquo;: &ldquo;Norway&rdquo;, &ldquo;temp&rdquo;: 18, &ldquo;signal&rdquo;: 26, &ldquo;battery_level&rdquo;: 8, &ldquo;c02_level&rdquo;: 1220, &ldquo;timestamp&rdquo; :1475600522 }</td>
</tr>
<tr>
<td style="text-align:left">13</td>
<td style="text-align:left">{&ldquo;device_id&rdquo;: 13, &ldquo;device_type&rdquo;: &ldquo;sensor-ipad&rdquo;, &ldquo;ip&rdquo;: &ldquo;67.185.72.1&rdquo;, &ldquo;cca3&rdquo;: &ldquo;USA&rdquo;, &ldquo;cn&rdquo;: &ldquo;United States&rdquo;, &ldquo;temp&rdquo;: 34, &ldquo;signal&rdquo;: 20, &ldquo;battery_level&rdquo;: 8, &ldquo;c02_level&rdquo;: 1504, &ldquo;timestamp&rdquo; :1475600524 }</td>
</tr>
<tr>
<td style="text-align:left">14</td>
<td style="text-align:left">{&ldquo;device_id&rdquo;: 14, &ldquo;device_type&rdquo;: &ldquo;sensor-inest&rdquo;, &ldquo;ip&rdquo;: &ldquo;68.85.85.106&rdquo;, &ldquo;cca3&rdquo;: &ldquo;USA&rdquo;, &ldquo;cn&rdquo;: &ldquo;United States&rdquo;, &ldquo;temp&rdquo;: 39, &ldquo;signal&rdquo;: 17, &ldquo;battery_level&rdquo;: 8, &ldquo;c02_level&rdquo;: 831, &ldquo;timestamp&rdquo; :1475600526 }</td>
</tr>
<tr>
<td style="text-align:left">15</td>
<td style="text-align:left">{&ldquo;device_id&rdquo;: 15, &ldquo;device_type&rdquo;: &ldquo;sensor-ipad&rdquo;, &ldquo;ip&rdquo;: &ldquo;161.188.212.254&rdquo;, &ldquo;cca3&rdquo;: &ldquo;USA&rdquo;, &ldquo;cn&rdquo;: &ldquo;United States&rdquo;, &ldquo;temp&rdquo;: 27, &ldquo;signal&rdquo;: 26, &ldquo;battery_level&rdquo;: 5, &ldquo;c02_level&rdquo;: 1378, &ldquo;timestamp&rdquo; :1475600528 }</td>
</tr>
<tr>
<td style="text-align:left">16</td>
<td style="text-align:left">{&ldquo;device_id&rdquo;: 16, &ldquo;device_type&rdquo;: &ldquo;sensor-igauge&rdquo;, &ldquo;ip&rdquo;: &ldquo;221.3.128.242&rdquo;, &ldquo;cca3&rdquo;: &ldquo;CHN&rdquo;, &ldquo;cn&rdquo;: &ldquo;China&rdquo;, &ldquo;temp&rdquo;: 10, &ldquo;signal&rdquo;: 24, &ldquo;battery_level&rdquo;: 6, &ldquo;c02_level&rdquo;: 1423, &ldquo;timestamp&rdquo; :1475600530 }</td>
</tr>
<tr>
<td style="text-align:left">17</td>
<td style="text-align:left">{&ldquo;device_id&rdquo;: 17, &ldquo;device_type&rdquo;: &ldquo;sensor-ipad&rdquo;, &ldquo;ip&rdquo;: &ldquo;64.124.180.215&rdquo;, &ldquo;cca3&rdquo;: &ldquo;USA&rdquo;, &ldquo;cn&rdquo;: &ldquo;United States&rdquo;, &ldquo;temp&rdquo;: 38, &ldquo;signal&rdquo;: 17, &ldquo;battery_level&rdquo;: 9, &ldquo;c02_level&rdquo;: 1304, &ldquo;timestamp&rdquo; :1475600532 }</td>
</tr>
<tr>
<td style="text-align:left">18</td>
<td style="text-align:left">{&ldquo;device_id&rdquo;: 18, &ldquo;device_type&rdquo;: &ldquo;sensor-igauge&rdquo;, &ldquo;ip&rdquo;: &ldquo;66.153.162.66&rdquo;, &ldquo;cca3&rdquo;: &ldquo;USA&rdquo;, &ldquo;cn&rdquo;: &ldquo;United States&rdquo;, &ldquo;temp&rdquo;: 26, &ldquo;signal&rdquo;: 10, &ldquo;battery_level&rdquo;: 0, &ldquo;c02_level&rdquo;: 902, &ldquo;timestamp&rdquo; :1475600534 }</td>
</tr>
<tr>
<td style="text-align:left">19</td>
<td style="text-align:left">{&ldquo;device_id&rdquo;: 19, &ldquo;device_type&rdquo;: &ldquo;sensor-ipad&rdquo;, &ldquo;ip&rdquo;: &ldquo;193.200.142.254&rdquo;, &ldquo;cca3&rdquo;: &ldquo;AUT&rdquo;, &ldquo;cn&rdquo;: &ldquo;Austria&rdquo;, &ldquo;temp&rdquo;: 32, &ldquo;signal&rdquo;: 27, &ldquo;battery_level&rdquo;: 5, &ldquo;c02_level&rdquo;: 1282, &ldquo;timestamp&rdquo; :1475600536 }</td>
</tr>
</tbody>
</table>
<p>打印 schema 将测试为两列，类型为 <code>integer</code> 和 <code>string</code>，反映了 Scala case 类。</p>
<pre tabindex="0"><code>eventsDS.printSchema
root
 |-- id: integer (nullable = false)
 |-- device: string (nullable = true)
</code></pre><h2 id="如何使用-get_json_object">如何使用 get_json_object()&nbsp;<a class="headline-hash no-text-decoration" href="#如何使用-get_json_object">#</a> </h2>
<p>此方法基于指定的 JSON 路径从 JSON 字符串中提取 JSON 对象，并返回 JSON 字符串作为提取的 JSON 对象。以上面 Dataset 的小例子为例，我们希望从中提取构成 JSON 对象字符串的数据值部分。假设您只想提取 id，device_type，ip 和 CCA3 代码。这是使用 <code>get_json_object()</code> 快速完成的方法。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-scala" data-lang="scala"><span class="line"><span class="cl"><span class="k">val</span> <span class="n">eventsFromJSONDF</span> <span class="k">=</span> <span class="nc">Seq</span> <span class="o">(</span>
</span></span><span class="line"><span class="cl"> <span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="s">&#34;&#34;&#34;{&#34;device_id&#34;: 0, &#34;device_type&#34;: &#34;sensor-ipad&#34;, &#34;ip&#34;: &#34;68.161.225.1&#34;, &#34;cca3&#34;: &#34;USA&#34;, &#34;cn&#34;: &#34;United States&#34;, &#34;temp&#34;: 25, &#34;signal&#34;: 23, &#34;battery_level&#34;: 8, &#34;c02_level&#34;: 917, &#34;timestamp&#34; :1475600496 }&#34;&#34;&#34;</span><span class="o">),</span>
</span></span><span class="line"><span class="cl"> <span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="s">&#34;&#34;&#34;{&#34;device_id&#34;: 1, &#34;device_type&#34;: &#34;sensor-igauge&#34;, &#34;ip&#34;: &#34;213.161.254.1&#34;, &#34;cca3&#34;: &#34;NOR&#34;, &#34;cn&#34;: &#34;Norway&#34;, &#34;temp&#34;: 30, &#34;signal&#34;: 18, &#34;battery_level&#34;: 6, &#34;c02_level&#34;: 1413, &#34;timestamp&#34; :1475600498 }&#34;&#34;&#34;</span><span class="o">),</span>
</span></span><span class="line"><span class="cl"> <span class="o">(</span><span class="mi">2</span><span class="o">,</span> <span class="s">&#34;&#34;&#34;{&#34;device_id&#34;: 2, &#34;device_type&#34;: &#34;sensor-ipad&#34;, &#34;ip&#34;: &#34;88.36.5.1&#34;, &#34;cca3&#34;: &#34;ITA&#34;, &#34;cn&#34;: &#34;Italy&#34;, &#34;temp&#34;: 18, &#34;signal&#34;: 25, &#34;battery_level&#34;: 5, &#34;c02_level&#34;: 1372, &#34;timestamp&#34; :1475600500 }&#34;&#34;&#34;</span><span class="o">),</span>
</span></span><span class="line"><span class="cl"> <span class="o">(</span><span class="mi">3</span><span class="o">,</span> <span class="s">&#34;&#34;&#34;{&#34;device_id&#34;: 3, &#34;device_type&#34;: &#34;sensor-inest&#34;, &#34;ip&#34;: &#34;66.39.173.154&#34;, &#34;cca3&#34;: &#34;USA&#34;, &#34;cn&#34;: &#34;United States&#34;, &#34;temp&#34;: 47, &#34;signal&#34;: 12, &#34;battery_level&#34;: 1, &#34;c02_level&#34;: 1447, &#34;timestamp&#34; :1475600502 }&#34;&#34;&#34;</span><span class="o">),</span>
</span></span><span class="line"><span class="cl"><span class="o">(</span><span class="mi">4</span><span class="o">,</span> <span class="s">&#34;&#34;&#34;{&#34;device_id&#34;: 4, &#34;device_type&#34;: &#34;sensor-ipad&#34;, &#34;ip&#34;: &#34;203.82.41.9&#34;, &#34;cca3&#34;: &#34;PHL&#34;, &#34;cn&#34;: &#34;Philippines&#34;, &#34;temp&#34;: 29, &#34;signal&#34;: 11, &#34;battery_level&#34;: 0, &#34;c02_level&#34;: 983, &#34;timestamp&#34; :1475600504 }&#34;&#34;&#34;</span><span class="o">),</span>
</span></span><span class="line"><span class="cl"><span class="o">(</span><span class="mi">5</span><span class="o">,</span> <span class="s">&#34;&#34;&#34;{&#34;device_id&#34;: 5, &#34;device_type&#34;: &#34;sensor-istick&#34;, &#34;ip&#34;: &#34;204.116.105.67&#34;, &#34;cca3&#34;: &#34;USA&#34;, &#34;cn&#34;: &#34;United States&#34;, &#34;temp&#34;: 50, &#34;signal&#34;: 16, &#34;battery_level&#34;: 8, &#34;c02_level&#34;: 1574, &#34;timestamp&#34; :1475600506 }&#34;&#34;&#34;</span><span class="o">),</span>
</span></span><span class="line"><span class="cl"><span class="o">(</span><span class="mi">6</span><span class="o">,</span> <span class="s">&#34;&#34;&#34;{&#34;device_id&#34;: 6, &#34;device_type&#34;: &#34;sensor-ipad&#34;, &#34;ip&#34;: &#34;220.173.179.1&#34;, &#34;cca3&#34;: &#34;CHN&#34;, &#34;cn&#34;: &#34;China&#34;, &#34;temp&#34;: 21, &#34;signal&#34;: 18, &#34;battery_level&#34;: 9, &#34;c02_level&#34;: 1249, &#34;timestamp&#34; :1475600508 }&#34;&#34;&#34;</span><span class="o">),</span>
</span></span><span class="line"><span class="cl"><span class="o">(</span><span class="mi">7</span><span class="o">,</span> <span class="s">&#34;&#34;&#34;{&#34;device_id&#34;: 7, &#34;device_type&#34;: &#34;sensor-ipad&#34;, &#34;ip&#34;: &#34;118.23.68.227&#34;, &#34;cca3&#34;: &#34;JPN&#34;, &#34;cn&#34;: &#34;Japan&#34;, &#34;temp&#34;: 27, &#34;signal&#34;: 15, &#34;battery_level&#34;: 0, &#34;c02_level&#34;: 1531, &#34;timestamp&#34; :1475600512 }&#34;&#34;&#34;</span><span class="o">),</span>
</span></span><span class="line"><span class="cl"><span class="o">(</span><span class="mi">8</span> <span class="o">,</span><span class="s">&#34;&#34;&#34; {&#34;device_id&#34;: 8, &#34;device_type&#34;: &#34;sensor-inest&#34;, &#34;ip&#34;: &#34;208.109.163.218&#34;, &#34;cca3&#34;: &#34;USA&#34;, &#34;cn&#34;: &#34;United States&#34;, &#34;temp&#34;: 40, &#34;signal&#34;: 16, &#34;battery_level&#34;: 9, &#34;c02_level&#34;: 1208, &#34;timestamp&#34; :1475600514 }&#34;&#34;&#34;</span><span class="o">),</span>
</span></span><span class="line"><span class="cl"><span class="o">(</span><span class="mi">9</span><span class="o">,</span><span class="s">&#34;&#34;&#34;{&#34;device_id&#34;: 9, &#34;device_type&#34;: &#34;sensor-ipad&#34;, &#34;ip&#34;: &#34;88.213.191.34&#34;, &#34;cca3&#34;: &#34;ITA&#34;, &#34;cn&#34;: &#34;Italy&#34;, &#34;temp&#34;: 19, &#34;signal&#34;: 11, &#34;battery_level&#34;: 0, &#34;c02_level&#34;: 1171, &#34;timestamp&#34; :1475600516 }&#34;&#34;&#34;</span><span class="o">)).</span><span class="n">toDF</span><span class="o">(</span><span class="s">&#34;id&#34;</span><span class="o">,</span> <span class="s">&#34;json&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">eventsFromJSONDF</span><span class="k">:</span> <span class="kt">org.apache.spark.sql.DataFrame</span> <span class="o">=</span> <span class="o">[</span><span class="kt">id:</span> <span class="kt">int</span>, <span class="kt">json:</span> <span class="kt">string</span><span class="o">]</span>
</span></span></code></pre></div><pre tabindex="0"><code>display(eventsFromJSONDF)
</code></pre><table>
<thead>
<tr>
<th style="text-align:left">id</th>
<th style="text-align:left">json</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">0</td>
<td style="text-align:left">{&ldquo;device_id&rdquo;: 0, &ldquo;device_type&rdquo;: &ldquo;sensor-ipad&rdquo;, &ldquo;ip&rdquo;: &ldquo;68.161.225.1&rdquo;, &ldquo;cca3&rdquo;: &ldquo;USA&rdquo;, &ldquo;cn&rdquo;: &ldquo;United States&rdquo;, &ldquo;temp&rdquo;: 25, &ldquo;signal&rdquo;: 23, &ldquo;battery_level&rdquo;: 8, &ldquo;c02_level&rdquo;: 917, &ldquo;timestamp&rdquo; :1475600496 }</td>
</tr>
<tr>
<td style="text-align:left">1</td>
<td style="text-align:left">{&ldquo;device_id&rdquo;: 1, &ldquo;device_type&rdquo;: &ldquo;sensor-igauge&rdquo;, &ldquo;ip&rdquo;: &ldquo;213.161.254.1&rdquo;, &ldquo;cca3&rdquo;: &ldquo;NOR&rdquo;, &ldquo;cn&rdquo;: &ldquo;Norway&rdquo;, &ldquo;temp&rdquo;: 30, &ldquo;signal&rdquo;: 18, &ldquo;battery_level&rdquo;: 6, &ldquo;c02_level&rdquo;: 1413, &ldquo;timestamp&rdquo; :1475600498 }</td>
</tr>
<tr>
<td style="text-align:left">2</td>
<td style="text-align:left">{&ldquo;device_id&rdquo;: 2, &ldquo;device_type&rdquo;: &ldquo;sensor-ipad&rdquo;, &ldquo;ip&rdquo;: &ldquo;88.36.5.1&rdquo;, &ldquo;cca3&rdquo;: &ldquo;ITA&rdquo;, &ldquo;cn&rdquo;: &ldquo;Italy&rdquo;, &ldquo;temp&rdquo;: 18, &ldquo;signal&rdquo;: 25, &ldquo;battery_level&rdquo;: 5, &ldquo;c02_level&rdquo;: 1372, &ldquo;timestamp&rdquo; :1475600500 }</td>
</tr>
<tr>
<td style="text-align:left">3</td>
<td style="text-align:left">{&ldquo;device_id&rdquo;: 3, &ldquo;device_type&rdquo;: &ldquo;sensor-inest&rdquo;, &ldquo;ip&rdquo;: &ldquo;66.39.173.154&rdquo;, &ldquo;cca3&rdquo;: &ldquo;USA&rdquo;, &ldquo;cn&rdquo;: &ldquo;United States&rdquo;, &ldquo;temp&rdquo;: 47, &ldquo;signal&rdquo;: 12, &ldquo;battery_level&rdquo;: 1, &ldquo;c02_level&rdquo;: 1447, &ldquo;timestamp&rdquo; :1475600502 }</td>
</tr>
<tr>
<td style="text-align:left">4</td>
<td style="text-align:left">{&ldquo;device_id&rdquo;: 4, &ldquo;device_type&rdquo;: &ldquo;sensor-ipad&rdquo;, &ldquo;ip&rdquo;: &ldquo;203.82.41.9&rdquo;, &ldquo;cca3&rdquo;: &ldquo;PHL&rdquo;, &ldquo;cn&rdquo;: &ldquo;Philippines&rdquo;, &ldquo;temp&rdquo;: 29, &ldquo;signal&rdquo;: 11, &ldquo;battery_level&rdquo;: 0, &ldquo;c02_level&rdquo;: 983, &ldquo;timestamp&rdquo; :1475600504 }</td>
</tr>
<tr>
<td style="text-align:left">5</td>
<td style="text-align:left">{&ldquo;device_id&rdquo;: 5, &ldquo;device_type&rdquo;: &ldquo;sensor-istick&rdquo;, &ldquo;ip&rdquo;: &ldquo;204.116.105.67&rdquo;, &ldquo;cca3&rdquo;: &ldquo;USA&rdquo;, &ldquo;cn&rdquo;: &ldquo;United States&rdquo;, &ldquo;temp&rdquo;: 50, &ldquo;signal&rdquo;: 16, &ldquo;battery_level&rdquo;: 8, &ldquo;c02_level&rdquo;: 1574, &ldquo;timestamp&rdquo; :1475600506 }</td>
</tr>
<tr>
<td style="text-align:left">6</td>
<td style="text-align:left">{&ldquo;device_id&rdquo;: 6, &ldquo;device_type&rdquo;: &ldquo;sensor-ipad&rdquo;, &ldquo;ip&rdquo;: &ldquo;220.173.179.1&rdquo;, &ldquo;cca3&rdquo;: &ldquo;CHN&rdquo;, &ldquo;cn&rdquo;: &ldquo;China&rdquo;, &ldquo;temp&rdquo;: 21, &ldquo;signal&rdquo;: 18, &ldquo;battery_level&rdquo;: 9, &ldquo;c02_level&rdquo;: 1249, &ldquo;timestamp&rdquo; :1475600508 }</td>
</tr>
<tr>
<td style="text-align:left">7</td>
<td style="text-align:left">{&ldquo;device_id&rdquo;: 7, &ldquo;device_type&rdquo;: &ldquo;sensor-ipad&rdquo;, &ldquo;ip&rdquo;: &ldquo;118.23.68.227&rdquo;, &ldquo;cca3&rdquo;: &ldquo;JPN&rdquo;, &ldquo;cn&rdquo;: &ldquo;Japan&rdquo;, &ldquo;temp&rdquo;: 27, &ldquo;signal&rdquo;: 15, &ldquo;battery_level&rdquo;: 0, &ldquo;c02_level&rdquo;: 1531, &ldquo;timestamp&rdquo; :1475600512 }</td>
</tr>
<tr>
<td style="text-align:left">8</td>
<td style="text-align:left">{&ldquo;device_id&rdquo;: 8, &ldquo;device_type&rdquo;: &ldquo;sensor-inest&rdquo;, &ldquo;ip&rdquo;: &ldquo;208.109.163.218&rdquo;, &ldquo;cca3&rdquo;: &ldquo;USA&rdquo;, &ldquo;cn&rdquo;: &ldquo;United States&rdquo;, &ldquo;temp&rdquo;: 40, &ldquo;signal&rdquo;: 16, &ldquo;battery_level&rdquo;: 9, &ldquo;c02_level&rdquo;: 1208, &ldquo;timestamp&rdquo; :1475600514 }</td>
</tr>
<tr>
<td style="text-align:left">9</td>
<td style="text-align:left">{&ldquo;device_id&rdquo;: 9, &ldquo;device_type&rdquo;: &ldquo;sensor-ipad&rdquo;, &ldquo;ip&rdquo;: &ldquo;88.213.191.34&rdquo;, &ldquo;cca3&rdquo;: &ldquo;ITA&rdquo;, &ldquo;cn&rdquo;: &ldquo;Italy&rdquo;, &ldquo;temp&rdquo;: 19, &ldquo;signal&rdquo;: 11, &ldquo;battery_level&rdquo;: 0, &ldquo;c02_level&rdquo;: 1171, &ldquo;timestamp&rdquo; :1475600516 }</td>
</tr>
</tbody>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-scala" data-lang="scala"><span class="line"><span class="cl"><span class="k">val</span> <span class="n">jsDF</span> <span class="k">=</span> <span class="n">eventsFromJSONDF</span><span class="o">.</span><span class="n">select</span><span class="o">(</span><span class="n">$</span><span class="s">&#34;id&#34;</span><span class="o">,</span> <span class="n">get_json_object</span><span class="o">(</span><span class="n">$</span><span class="s">&#34;json&#34;</span><span class="o">,</span> <span class="s">&#34;$.device_type&#34;</span><span class="o">).</span><span class="n">alias</span><span class="o">(</span><span class="s">&#34;device_type&#34;</span><span class="o">),</span>
</span></span><span class="line"><span class="cl">                                          <span class="n">get_json_object</span><span class="o">(</span><span class="n">$</span><span class="s">&#34;json&#34;</span><span class="o">,</span> <span class="s">&#34;$.ip&#34;</span><span class="o">).</span><span class="n">alias</span><span class="o">(</span><span class="s">&#34;ip&#34;</span><span class="o">),</span>
</span></span><span class="line"><span class="cl">                                         <span class="n">get_json_object</span><span class="o">(</span><span class="n">$</span><span class="s">&#34;json&#34;</span><span class="o">,</span> <span class="s">&#34;$.cca3&#34;</span><span class="o">).</span><span class="n">alias</span><span class="o">(</span><span class="s">&#34;cca3&#34;</span><span class="o">))</span>
</span></span><span class="line"><span class="cl"><span class="n">jsDF</span><span class="k">:</span> <span class="kt">org.apache.spark.sql.DataFrame</span> <span class="o">=</span> <span class="o">[</span><span class="kt">id:</span> <span class="kt">int</span>, <span class="kt">device_type:</span> <span class="kt">string</span> <span class="kt">...</span> <span class="err">2</span> <span class="kt">more</span> <span class="kt">fields</span><span class="o">]</span>
</span></span></code></pre></div><pre tabindex="0"><code>display(jsDF)
</code></pre><table>
<thead>
<tr>
<th style="text-align:left">id</th>
<th style="text-align:left">device_type</th>
<th style="text-align:center">ip</th>
<th style="text-align:left">cca3</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">0</td>
<td style="text-align:left">sensor-ipad</td>
<td style="text-align:center">68.161.225.1</td>
<td style="text-align:left">USA</td>
</tr>
<tr>
<td style="text-align:left">1</td>
<td style="text-align:left">sensor-igauge</td>
<td style="text-align:center">213.161.254.1</td>
<td style="text-align:left">NOR</td>
</tr>
<tr>
<td style="text-align:left">2</td>
<td style="text-align:left">sensor-ipad</td>
<td style="text-align:center">88.36.5.1</td>
<td style="text-align:left">ITA</td>
</tr>
<tr>
<td style="text-align:left">3</td>
<td style="text-align:left">sensor-inest</td>
<td style="text-align:center">66.39.173.154</td>
<td style="text-align:left">USA</td>
</tr>
<tr>
<td style="text-align:left">4</td>
<td style="text-align:left">sensor-ipad</td>
<td style="text-align:center">203.82.41.9</td>
<td style="text-align:left">PHL</td>
</tr>
<tr>
<td style="text-align:left">5</td>
<td style="text-align:left">sensor-istick</td>
<td style="text-align:center">204.116.105.67</td>
<td style="text-align:left">USA</td>
</tr>
<tr>
<td style="text-align:left">6</td>
<td style="text-align:left">sensor-ipad</td>
<td style="text-align:center">220.173.179.1</td>
<td style="text-align:left">CHN</td>
</tr>
<tr>
<td style="text-align:left">7</td>
<td style="text-align:left">sensor-ipad</td>
<td style="text-align:center">118.23.68.227</td>
<td style="text-align:left">JPN</td>
</tr>
<tr>
<td style="text-align:left">8</td>
<td style="text-align:left">sensor-inest</td>
<td style="text-align:center">208.109.163.218</td>
<td style="text-align:left">USA</td>
</tr>
<tr>
<td style="text-align:left">9</td>
<td style="text-align:left">sensor-ipad</td>
<td style="text-align:center">88.213.191.34</td>
<td style="text-align:left">ITA</td>
</tr>
</tbody>
</table>
<h2 id="如何使用-from_json">如何使用 from_json()&nbsp;<a class="headline-hash no-text-decoration" href="#如何使用-from_json">#</a> </h2>
<p><code>get_json_object()</code> 的变体，此函数使用 schema 提取单个列。在 <code>select()</code> Dataset API 调用中使用 <a href="https://spark.apache.org/docs/latest/api/scala/index.html#org.apache.spark.sql.functions$">from_json()</a> 辅助函数，我可以将数据的属性和值从 JSON 字符串提取或解码为 DataFrame 作为列，由 schema 指定。在使用 schema 时，我将此 JSON 中所有关联的属性和值归为一类，以表示为实体设备。因此，您不仅可以使用 <code>device.attribute</code> 来检索其各自的值，还可以使用 <code>*</code> 表示法检索所有值。</p>
<p>在下面的例子中：</p>
<ul>
<li>使用上面的 schema 从 JSON 字符串中提取属性和值，并将它们表示为单个列作为 <code>devices</code> 的一部分</li>
<li><code>select()</code> 所有列</li>
<li>使用 <code>.</code> 记号过滤所需的属性</li>
</ul>
<p>将 JSON 字符串中的数据提取到其各自的 DataFrame 列后，您可以应用 DataFrame/Dataset API 调用来选择，过滤和后续显示，令您满意。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-scala" data-lang="scala"><span class="line"><span class="cl"><span class="k">val</span> <span class="n">devicesDF</span> <span class="k">=</span> <span class="n">eventsDS</span><span class="o">.</span><span class="n">select</span><span class="o">(</span><span class="n">from_json</span><span class="o">(</span><span class="n">$</span><span class="s">&#34;device&#34;</span><span class="o">,</span> <span class="n">jsonSchema</span><span class="o">)</span> <span class="n">as</span> <span class="s">&#34;devices&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="o">.</span><span class="n">select</span><span class="o">(</span><span class="n">$</span><span class="s">&#34;devices.*&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="o">.</span><span class="n">filter</span><span class="o">(</span><span class="n">$</span><span class="s">&#34;devices.temp&#34;</span> <span class="o">&gt;</span> <span class="mi">10</span> <span class="n">and</span> <span class="n">$</span><span class="s">&#34;devices.signal&#34;</span> <span class="o">&gt;</span> <span class="mi">15</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="n">devicesDF</span><span class="k">:</span> <span class="kt">org.apache.spark.sql.Dataset</span><span class="o">[</span><span class="kt">org.apache.spark.sql.Row</span><span class="o">]</span> <span class="k">=</span> <span class="o">[</span><span class="kt">battery_level:</span> <span class="kt">bigint</span>, <span class="kt">c02_level:</span> <span class="kt">bigint</span> <span class="kt">...</span> <span class="err">8</span> <span class="kt">more</span> <span class="kt">fields</span><span class="o">]</span>
</span></span></code></pre></div><pre tabindex="0"><code>display(devicesDF)
</code></pre><p>todo</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-scala" data-lang="scala"><span class="line"><span class="cl"><span class="k">val</span> <span class="n">devicesUSDF</span> <span class="k">=</span> <span class="n">devicesDF</span><span class="o">.</span><span class="n">select</span><span class="o">(</span><span class="n">$</span><span class="s">&#34;*&#34;</span><span class="o">).</span><span class="n">where</span><span class="o">(</span><span class="n">$</span><span class="s">&#34;cca3&#34;</span> <span class="o">===</span> <span class="s">&#34;USA&#34;</span><span class="o">).</span><span class="n">orderBy</span><span class="o">(</span><span class="n">$</span><span class="s">&#34;signal&#34;</span><span class="o">.</span><span class="n">desc</span><span class="o">,</span> <span class="n">$</span><span class="s">&#34;temp&#34;</span><span class="o">.</span><span class="n">desc</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="n">devicesUSDF</span><span class="k">:</span> <span class="kt">org.apache.spark.sql.Dataset</span><span class="o">[</span><span class="kt">org.apache.spark.sql.Row</span><span class="o">]</span> <span class="k">=</span> <span class="o">[</span><span class="kt">battery_level:</span> <span class="kt">bigint</span>, <span class="kt">c02_level:</span> <span class="kt">bigint</span> <span class="kt">...</span> <span class="err">8</span> <span class="kt">more</span> <span class="kt">fields</span><span class="o">]</span>
</span></span></code></pre></div><pre tabindex="0"><code>display(devicesUSDF)
</code></pre><h2 id="如何使用-to_json">如何使用 to_json()&nbsp;<a class="headline-hash no-text-decoration" href="#如何使用-to_json">#</a> </h2>
<p>现在，让我们反过来：您可以使用 <code>to_json()</code> 将我们过滤的设备转换或编码为 JSON 字符串。也就是说，将 JSON 结构转换为字符串。结果可以重新发布到例如 Kafka 或作为 parquet 文件保存在磁盘上。要了解如何写入 Kafka 和其他接收器，请阅读<a href="https://databricks.com/blog/2017/04/04/real-time-end-to-end-integration-with-apache-kafka-in-apache-sparks-structured-streaming.html">此博客</a>和我们关于<a href="https://databricks.com/blog/2017/01/19/real-time-streaming-etl-structured-streaming-apache-spark-2-1.html">结构化流博客</a>的系列。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-scala" data-lang="scala"><span class="line"><span class="cl"><span class="k">val</span> <span class="n">stringJsonDF</span> <span class="k">=</span> <span class="n">eventsDS</span><span class="o">.</span><span class="n">select</span><span class="o">(</span><span class="n">to_json</span><span class="o">(</span><span class="n">struct</span><span class="o">(</span><span class="n">$</span><span class="s">&#34;*&#34;</span><span class="o">))).</span><span class="n">toDF</span><span class="o">(</span><span class="s">&#34;devices&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="n">stringJsonDF</span><span class="k">:</span> <span class="kt">org.apache.spark.sql.DataFrame</span> <span class="o">=</span> <span class="o">[</span><span class="kt">devices:</span> <span class="kt">string</span><span class="o">]</span>
</span></span></code></pre></div><pre tabindex="0"><code>display(stringJsonDF)
</code></pre><table>
<thead>
<tr>
<th style="text-align:left">devices</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">{&ldquo;id&rdquo;:0,&ldquo;device&rdquo;:&quot;{&quot;device_id&quot;: 0, &quot;device_type&quot;: &quot;sensor-ipad&quot;, &quot;ip&quot;: &quot;68.161.225.1&quot;, &quot;cca3&quot;: &quot;USA&quot;, &quot;cn&quot;: &quot;United States&quot;, &quot;temp&quot;: 25, &quot;signal&quot;: 23, &quot;battery_level&quot;: 8, &quot;c02_level&quot;: 917, &quot;timestamp&quot; :1475600496 }&quot;}</td>
</tr>
<tr>
<td style="text-align:left">{&ldquo;id&rdquo;:1,&ldquo;device&rdquo;:&quot;{&quot;device_id&quot;: 1, &quot;device_type&quot;: &quot;sensor-igauge&quot;, &quot;ip&quot;: &quot;213.161.254.1&quot;, &quot;cca3&quot;: &quot;NOR&quot;, &quot;cn&quot;: &quot;Norway&quot;, &quot;temp&quot;: 30, &quot;signal&quot;: 18, &quot;battery_level&quot;: 6, &quot;c02_level&quot;: 1413, &quot;timestamp&quot; :1475600498 }&quot;}</td>
</tr>
<tr>
<td style="text-align:left">{&ldquo;id&rdquo;:2,&ldquo;device&rdquo;:&quot;{&quot;device_id&quot;: 2, &quot;device_type&quot;: &quot;sensor-ipad&quot;, &quot;ip&quot;: &quot;88.36.5.1&quot;, &quot;cca3&quot;: &quot;ITA&quot;, &quot;cn&quot;: &quot;Italy&quot;, &quot;temp&quot;: 18, &quot;signal&quot;: 25, &quot;battery_level&quot;: 5, &quot;c02_level&quot;: 1372, &quot;timestamp&quot; :1475600500 }&quot;}</td>
</tr>
<tr>
<td style="text-align:left">{&ldquo;id&rdquo;:3,&ldquo;device&rdquo;:&quot;{&quot;device_id&quot;: 3, &quot;device_type&quot;: &quot;sensor-inest&quot;, &quot;ip&quot;: &quot;66.39.173.154&quot;, &quot;cca3&quot;: &quot;USA&quot;, &quot;cn&quot;: &quot;United States&quot;, &quot;temp&quot;: 47, &quot;signal&quot;: 12, &quot;battery_level&quot;: 1, &quot;c02_level&quot;: 1447, &quot;timestamp&quot; :1475600502 }&quot;}</td>
</tr>
<tr>
<td style="text-align:left">{&ldquo;id&rdquo;:4,&ldquo;device&rdquo;:&quot;{&quot;device_id&quot;: 4, &quot;device_type&quot;: &quot;sensor-ipad&quot;, &quot;ip&quot;: &quot;203.82.41.9&quot;, &quot;cca3&quot;: &quot;PHL&quot;, &quot;cn&quot;: &quot;Philippines&quot;, &quot;temp&quot;: 29, &quot;signal&quot;: 11, &quot;battery_level&quot;: 0, &quot;c02_level&quot;: 983, &quot;timestamp&quot; :1475600504 }&quot;}</td>
</tr>
<tr>
<td style="text-align:left">{&ldquo;id&rdquo;:5,&ldquo;device&rdquo;:&quot;{&quot;device_id&quot;: 5, &quot;device_type&quot;: &quot;sensor-istick&quot;, &quot;ip&quot;: &quot;204.116.105.67&quot;, &quot;cca3&quot;: &quot;USA&quot;, &quot;cn&quot;: &quot;United States&quot;, &quot;temp&quot;: 50, &quot;signal&quot;: 16, &quot;battery_level&quot;: 8, &quot;c02_level&quot;: 1574, &quot;timestamp&quot; :1475600506 }&quot;}</td>
</tr>
<tr>
<td style="text-align:left">{&ldquo;id&rdquo;:6,&ldquo;device&rdquo;:&quot;{&quot;device_id&quot;: 6, &quot;device_type&quot;: &quot;sensor-ipad&quot;, &quot;ip&quot;: &quot;220.173.179.1&quot;, &quot;cca3&quot;: &quot;CHN&quot;, &quot;cn&quot;: &quot;China&quot;, &quot;temp&quot;: 21, &quot;signal&quot;: 18, &quot;battery_level&quot;: 9, &quot;c02_level&quot;: 1249, &quot;timestamp&quot; :1475600508 }&quot;}</td>
</tr>
<tr>
<td style="text-align:left">{&ldquo;id&rdquo;:7,&ldquo;device&rdquo;:&quot;{&quot;device_id&quot;: 7, &quot;device_type&quot;: &quot;sensor-ipad&quot;, &quot;ip&quot;: &quot;118.23.68.227&quot;, &quot;cca3&quot;: &quot;JPN&quot;, &quot;cn&quot;: &quot;Japan&quot;, &quot;temp&quot;: 27, &quot;signal&quot;: 15, &quot;battery_level&quot;: 0, &quot;c02_level&quot;: 1531, &quot;timestamp&quot; :1475600512 }&quot;}</td>
</tr>
<tr>
<td style="text-align:left">{&ldquo;id&rdquo;:8,&ldquo;device&rdquo;:&quot; {&quot;device_id&quot;: 8, &quot;device_type&quot;: &quot;sensor-inest&quot;, &quot;ip&quot;: &quot;208.109.163.218&quot;, &quot;cca3&quot;: &quot;USA&quot;, &quot;cn&quot;: &quot;United States&quot;, &quot;temp&quot;: 40, &quot;signal&quot;: 16, &quot;battery_level&quot;: 9, &quot;c02_level&quot;: 1208, &quot;timestamp&quot; :1475600514 }&quot;}</td>
</tr>
<tr>
<td style="text-align:left">{&ldquo;id&rdquo;:9,&ldquo;device&rdquo;:&quot;{&quot;device_id&quot;: 9, &quot;device_type&quot;: &quot;sensor-ipad&quot;, &quot;ip&quot;: &quot;88.213.191.34&quot;, &quot;cca3&quot;: &quot;ITA&quot;, &quot;cn&quot;: &quot;Italy&quot;, &quot;temp&quot;: 19, &quot;signal&quot;: 11, &quot;battery_level&quot;: 0, &quot;c02_level&quot;: 1171, &quot;timestamp&quot; :1475600516 }&quot;}</td>
</tr>
<tr>
<td style="text-align:left">{&ldquo;id&rdquo;:10,&ldquo;device&rdquo;:&quot;{&quot;device_id&quot;: 10, &quot;device_type&quot;: &quot;sensor-igauge&quot;, &quot;ip&quot;: &quot;68.28.91.22&quot;, &quot;cca3&quot;: &quot;USA&quot;, &quot;cn&quot;: &quot;United States&quot;, &quot;temp&quot;: 32, &quot;signal&quot;: 26, &quot;battery_level&quot;: 7, &quot;c02_level&quot;: 886, &quot;timestamp&quot; :1475600518 }&quot;}</td>
</tr>
<tr>
<td style="text-align:left">{&ldquo;id&rdquo;:11,&ldquo;device&rdquo;:&quot;{&quot;device_id&quot;: 11, &quot;device_type&quot;: &quot;sensor-ipad&quot;, &quot;ip&quot;: &quot;59.144.114.250&quot;, &quot;cca3&quot;: &quot;IND&quot;, &quot;cn&quot;: &quot;India&quot;, &quot;temp&quot;: 46, &quot;signal&quot;: 25, &quot;battery_level&quot;: 4, &quot;c02_level&quot;: 863, &quot;timestamp&quot; :1475600520 }&quot;}</td>
</tr>
<tr>
<td style="text-align:left">{&ldquo;id&rdquo;:12,&ldquo;device&rdquo;:&quot;{&quot;device_id&quot;: 12, &quot;device_type&quot;: &quot;sensor-igauge&quot;, &quot;ip&quot;: &quot;193.156.90.200&quot;, &quot;cca3&quot;: &quot;NOR&quot;, &quot;cn&quot;: &quot;Norway&quot;, &quot;temp&quot;: 18, &quot;signal&quot;: 26, &quot;battery_level&quot;: 8, &quot;c02_level&quot;: 1220, &quot;timestamp&quot; :1475600522 }&quot;}</td>
</tr>
<tr>
<td style="text-align:left">{&ldquo;id&rdquo;:13,&ldquo;device&rdquo;:&quot;{&quot;device_id&quot;: 13, &quot;device_type&quot;: &quot;sensor-ipad&quot;, &quot;ip&quot;: &quot;67.185.72.1&quot;, &quot;cca3&quot;: &quot;USA&quot;, &quot;cn&quot;: &quot;United States&quot;, &quot;temp&quot;: 34, &quot;signal&quot;: 20, &quot;battery_level&quot;: 8, &quot;c02_level&quot;: 1504, &quot;timestamp&quot; :1475600524 }&quot;}</td>
</tr>
<tr>
<td style="text-align:left">{&ldquo;id&rdquo;:14,&ldquo;device&rdquo;:&quot;{&quot;device_id&quot;: 14, &quot;device_type&quot;: &quot;sensor-inest&quot;, &quot;ip&quot;: &quot;68.85.85.106&quot;, &quot;cca3&quot;: &quot;USA&quot;, &quot;cn&quot;: &quot;United States&quot;, &quot;temp&quot;: 39, &quot;signal&quot;: 17, &quot;battery_level&quot;: 8, &quot;c02_level&quot;: 831, &quot;timestamp&quot; :1475600526 }&quot;}</td>
</tr>
<tr>
<td style="text-align:left">{&ldquo;id&rdquo;:15,&ldquo;device&rdquo;:&quot;{&quot;device_id&quot;: 15, &quot;device_type&quot;: &quot;sensor-ipad&quot;, &quot;ip&quot;: &quot;161.188.212.254&quot;, &quot;cca3&quot;: &quot;USA&quot;, &quot;cn&quot;: &quot;United States&quot;, &quot;temp&quot;: 27, &quot;signal&quot;: 26, &quot;battery_level&quot;: 5, &quot;c02_level&quot;: 1378, &quot;timestamp&quot; :1475600528 }&quot;}</td>
</tr>
<tr>
<td style="text-align:left">{&ldquo;id&rdquo;:16,&ldquo;device&rdquo;:&quot;{&quot;device_id&quot;: 16, &quot;device_type&quot;: &quot;sensor-igauge&quot;, &quot;ip&quot;: &quot;221.3.128.242&quot;, &quot;cca3&quot;: &quot;CHN&quot;, &quot;cn&quot;: &quot;China&quot;, &quot;temp&quot;: 10, &quot;signal&quot;: 24, &quot;battery_level&quot;: 6, &quot;c02_level&quot;: 1423, &quot;timestamp&quot; :1475600530 }&quot;}</td>
</tr>
<tr>
<td style="text-align:left">{&ldquo;id&rdquo;:17,&ldquo;device&rdquo;:&quot;{&quot;device_id&quot;: 17, &quot;device_type&quot;: &quot;sensor-ipad&quot;, &quot;ip&quot;: &quot;64.124.180.215&quot;, &quot;cca3&quot;: &quot;USA&quot;, &quot;cn&quot;: &quot;United States&quot;, &quot;temp&quot;: 38, &quot;signal&quot;: 17, &quot;battery_level&quot;: 9, &quot;c02_level&quot;: 1304, &quot;timestamp&quot; :1475600532 }&quot;}</td>
</tr>
<tr>
<td style="text-align:left">{&ldquo;id&rdquo;:18,&ldquo;device&rdquo;:&quot;{&quot;device_id&quot;: 18, &quot;device_type&quot;: &quot;sensor-igauge&quot;, &quot;ip&quot;: &quot;66.153.162.66&quot;, &quot;cca3&quot;: &quot;USA&quot;, &quot;cn&quot;: &quot;United States&quot;, &quot;temp&quot;: 26, &quot;signal&quot;: 10, &quot;battery_level&quot;: 0, &quot;c02_level&quot;: 902, &quot;timestamp&quot; :1475600534 }&quot;}</td>
</tr>
<tr>
<td style="text-align:left">{&ldquo;id&rdquo;:19,&ldquo;device&rdquo;:&quot;{&quot;device_id&quot;: 19, &quot;device_type&quot;: &quot;sensor-ipad&quot;, &quot;ip&quot;: &quot;193.200.142.254&quot;, &quot;cca3&quot;: &quot;AUT&quot;, &quot;cn&quot;: &quot;Austria&quot;, &quot;temp&quot;: 32, &quot;signal&quot;: 27, &quot;battery_level&quot;: 5, &quot;c02_level&quot;: 1282, &quot;timestamp&quot; :1475600536 }&quot;}</td>
</tr>
</tbody>
</table>
<p>假设你有一个在指定端口运行的 Kafka 集群和相应的主题，让我们写一下 Kafka 主题。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-scala" data-lang="scala"><span class="line"><span class="cl"><span class="n">stringJsonDF</span><span class="o">.</span><span class="n">write</span>
</span></span><span class="line"><span class="cl">            <span class="o">.</span><span class="n">format</span><span class="o">(</span><span class="s">&#34;kafka&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">            <span class="o">.</span><span class="n">option</span><span class="o">(</span><span class="s">&#34;kafka.bootstrap.servers&#34;</span><span class="o">,</span> <span class="s">&#34;your_host_name:9092&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">            <span class="o">.</span><span class="n">option</span><span class="o">(</span><span class="s">&#34;topic&#34;</span><span class="o">,</span> <span class="s">&#34;iot-devices&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">            <span class="o">.</span><span class="n">save</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">org</span><span class="o">.</span><span class="n">apache</span><span class="o">.</span><span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="o">.</span><span class="nc">AnalysisException</span><span class="k">:</span> <span class="kt">Required</span> <span class="kt">attribute</span> <span class="err">&#39;</span><span class="kt">value</span><span class="err">&#39;</span> <span class="kt">not</span> <span class="kt">found</span><span class="o">;</span>
</span></span></code></pre></div><h2 id="如何使用-selectexpr">如何使用 selectExpr()&nbsp;<a class="headline-hash no-text-decoration" href="#如何使用-selectexpr">#</a> </h2>
<p>将列转换或编码为 JSON 对象作为字符串的另一种方法是使用 <code>selectExpr()</code> 实用程序函数。例如，我可以将 DataFrame 的 “device” 列从上面转换为 JSON 字符串</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-scala" data-lang="scala"><span class="line"><span class="cl"><span class="k">val</span> <span class="n">stringsDF</span> <span class="k">=</span> <span class="n">eventsDS</span><span class="o">.</span><span class="n">selectExpr</span><span class="o">(</span><span class="s">&#34;CAST(id AS INT)&#34;</span><span class="o">,</span> <span class="s">&#34;CAST(device AS STRING)&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="n">stringsDF</span><span class="k">:</span> <span class="kt">org.apache.spark.sql.DataFrame</span> <span class="o">=</span> <span class="o">[</span><span class="kt">id:</span> <span class="kt">int</span>, <span class="kt">device:</span> <span class="kt">string</span><span class="o">]</span>
</span></span></code></pre></div><pre tabindex="0"><code>stringsDF.printSchema
root
 |-- id: integer (nullable = false)
 |-- device: string (nullable = true)
</code></pre><pre tabindex="0"><code>display(stringsDF)
</code></pre><table>
<thead>
<tr>
<th style="text-align:left">id</th>
<th style="text-align:left">device</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">0</td>
<td style="text-align:left">{&ldquo;device_id&rdquo;: 0, &ldquo;device_type&rdquo;: &ldquo;sensor-ipad&rdquo;, &ldquo;ip&rdquo;: &ldquo;68.161.225.1&rdquo;, &ldquo;cca3&rdquo;: &ldquo;USA&rdquo;, &ldquo;cn&rdquo;: &ldquo;United States&rdquo;, &ldquo;temp&rdquo;: 25, &ldquo;signal&rdquo;: 23, &ldquo;battery_level&rdquo;: 8, &ldquo;c02_level&rdquo;: 917, &ldquo;timestamp&rdquo; :1475600496 }</td>
</tr>
<tr>
<td style="text-align:left">1</td>
<td style="text-align:left">{&ldquo;device_id&rdquo;: 1, &ldquo;device_type&rdquo;: &ldquo;sensor-igauge&rdquo;, &ldquo;ip&rdquo;: &ldquo;213.161.254.1&rdquo;, &ldquo;cca3&rdquo;: &ldquo;NOR&rdquo;, &ldquo;cn&rdquo;: &ldquo;Norway&rdquo;, &ldquo;temp&rdquo;: 30, &ldquo;signal&rdquo;: 18, &ldquo;battery_level&rdquo;: 6, &ldquo;c02_level&rdquo;: 1413, &ldquo;timestamp&rdquo; :1475600498 }</td>
</tr>
<tr>
<td style="text-align:left">2</td>
<td style="text-align:left">{&ldquo;device_id&rdquo;: 2, &ldquo;device_type&rdquo;: &ldquo;sensor-ipad&rdquo;, &ldquo;ip&rdquo;: &ldquo;88.36.5.1&rdquo;, &ldquo;cca3&rdquo;: &ldquo;ITA&rdquo;, &ldquo;cn&rdquo;: &ldquo;Italy&rdquo;, &ldquo;temp&rdquo;: 18, &ldquo;signal&rdquo;: 25, &ldquo;battery_level&rdquo;: 5, &ldquo;c02_level&rdquo;: 1372, &ldquo;timestamp&rdquo; :1475600500 }</td>
</tr>
<tr>
<td style="text-align:left">3</td>
<td style="text-align:left">{&ldquo;device_id&rdquo;: 3, &ldquo;device_type&rdquo;: &ldquo;sensor-inest&rdquo;, &ldquo;ip&rdquo;: &ldquo;66.39.173.154&rdquo;, &ldquo;cca3&rdquo;: &ldquo;USA&rdquo;, &ldquo;cn&rdquo;: &ldquo;United States&rdquo;, &ldquo;temp&rdquo;: 47, &ldquo;signal&rdquo;: 12, &ldquo;battery_level&rdquo;: 1, &ldquo;c02_level&rdquo;: 1447, &ldquo;timestamp&rdquo; :1475600502 }</td>
</tr>
<tr>
<td style="text-align:left">4</td>
<td style="text-align:left">{&ldquo;device_id&rdquo;: 4, &ldquo;device_type&rdquo;: &ldquo;sensor-ipad&rdquo;, &ldquo;ip&rdquo;: &ldquo;203.82.41.9&rdquo;, &ldquo;cca3&rdquo;: &ldquo;PHL&rdquo;, &ldquo;cn&rdquo;: &ldquo;Philippines&rdquo;, &ldquo;temp&rdquo;: 29, &ldquo;signal&rdquo;: 11, &ldquo;battery_level&rdquo;: 0, &ldquo;c02_level&rdquo;: 983, &ldquo;timestamp&rdquo; :1475600504 }</td>
</tr>
<tr>
<td style="text-align:left">5</td>
<td style="text-align:left">{&ldquo;device_id&rdquo;: 5, &ldquo;device_type&rdquo;: &ldquo;sensor-istick&rdquo;, &ldquo;ip&rdquo;: &ldquo;204.116.105.67&rdquo;, &ldquo;cca3&rdquo;: &ldquo;USA&rdquo;, &ldquo;cn&rdquo;: &ldquo;United States&rdquo;, &ldquo;temp&rdquo;: 50, &ldquo;signal&rdquo;: 16, &ldquo;battery_level&rdquo;: 8, &ldquo;c02_level&rdquo;: 1574, &ldquo;timestamp&rdquo; :1475600506 }</td>
</tr>
<tr>
<td style="text-align:left">6</td>
<td style="text-align:left">{&ldquo;device_id&rdquo;: 6, &ldquo;device_type&rdquo;: &ldquo;sensor-ipad&rdquo;, &ldquo;ip&rdquo;: &ldquo;220.173.179.1&rdquo;, &ldquo;cca3&rdquo;: &ldquo;CHN&rdquo;, &ldquo;cn&rdquo;: &ldquo;China&rdquo;, &ldquo;temp&rdquo;: 21, &ldquo;signal&rdquo;: 18, &ldquo;battery_level&rdquo;: 9, &ldquo;c02_level&rdquo;: 1249, &ldquo;timestamp&rdquo; :1475600508 }</td>
</tr>
<tr>
<td style="text-align:left">7</td>
<td style="text-align:left">{&ldquo;device_id&rdquo;: 7, &ldquo;device_type&rdquo;: &ldquo;sensor-ipad&rdquo;, &ldquo;ip&rdquo;: &ldquo;118.23.68.227&rdquo;, &ldquo;cca3&rdquo;: &ldquo;JPN&rdquo;, &ldquo;cn&rdquo;: &ldquo;Japan&rdquo;, &ldquo;temp&rdquo;: 27, &ldquo;signal&rdquo;: 15, &ldquo;battery_level&rdquo;: 0, &ldquo;c02_level&rdquo;: 1531, &ldquo;timestamp&rdquo; :1475600512 }</td>
</tr>
<tr>
<td style="text-align:left">8</td>
<td style="text-align:left">{&ldquo;device_id&rdquo;: 8, &ldquo;device_type&rdquo;: &ldquo;sensor-inest&rdquo;, &ldquo;ip&rdquo;: &ldquo;208.109.163.218&rdquo;, &ldquo;cca3&rdquo;: &ldquo;USA&rdquo;, &ldquo;cn&rdquo;: &ldquo;United States&rdquo;, &ldquo;temp&rdquo;: 40, &ldquo;signal&rdquo;: 16, &ldquo;battery_level&rdquo;: 9, &ldquo;c02_level&rdquo;: 1208, &ldquo;timestamp&rdquo; :1475600514 }</td>
</tr>
<tr>
<td style="text-align:left">9</td>
<td style="text-align:left">{&ldquo;device_id&rdquo;: 9, &ldquo;device_type&rdquo;: &ldquo;sensor-ipad&rdquo;, &ldquo;ip&rdquo;: &ldquo;88.213.191.34&rdquo;, &ldquo;cca3&rdquo;: &ldquo;ITA&rdquo;, &ldquo;cn&rdquo;: &ldquo;Italy&rdquo;, &ldquo;temp&rdquo;: 19, &ldquo;signal&rdquo;: 11, &ldquo;battery_level&rdquo;: 0, &ldquo;c02_level&rdquo;: 1171, &ldquo;timestamp&rdquo; :1475600516 }</td>
</tr>
<tr>
<td style="text-align:left">10</td>
<td style="text-align:left">{&ldquo;device_id&rdquo;: 10, &ldquo;device_type&rdquo;: &ldquo;sensor-igauge&rdquo;, &ldquo;ip&rdquo;: &ldquo;68.28.91.22&rdquo;, &ldquo;cca3&rdquo;: &ldquo;USA&rdquo;, &ldquo;cn&rdquo;: &ldquo;United States&rdquo;, &ldquo;temp&rdquo;: 32, &ldquo;signal&rdquo;: 26, &ldquo;battery_level&rdquo;: 7, &ldquo;c02_level&rdquo;: 886, &ldquo;timestamp&rdquo; :1475600518 }</td>
</tr>
<tr>
<td style="text-align:left">11</td>
<td style="text-align:left">{&ldquo;device_id&rdquo;: 11, &ldquo;device_type&rdquo;: &ldquo;sensor-ipad&rdquo;, &ldquo;ip&rdquo;: &ldquo;59.144.114.250&rdquo;, &ldquo;cca3&rdquo;: &ldquo;IND&rdquo;, &ldquo;cn&rdquo;: &ldquo;India&rdquo;, &ldquo;temp&rdquo;: 46, &ldquo;signal&rdquo;: 25, &ldquo;battery_level&rdquo;: 4, &ldquo;c02_level&rdquo;: 863, &ldquo;timestamp&rdquo; :1475600520 }</td>
</tr>
<tr>
<td style="text-align:left">12</td>
<td style="text-align:left">{&ldquo;device_id&rdquo;: 12, &ldquo;device_type&rdquo;: &ldquo;sensor-igauge&rdquo;, &ldquo;ip&rdquo;: &ldquo;193.156.90.200&rdquo;, &ldquo;cca3&rdquo;: &ldquo;NOR&rdquo;, &ldquo;cn&rdquo;: &ldquo;Norway&rdquo;, &ldquo;temp&rdquo;: 18, &ldquo;signal&rdquo;: 26, &ldquo;battery_level&rdquo;: 8, &ldquo;c02_level&rdquo;: 1220, &ldquo;timestamp&rdquo; :1475600522 }</td>
</tr>
<tr>
<td style="text-align:left">13</td>
<td style="text-align:left">{&ldquo;device_id&rdquo;: 13, &ldquo;device_type&rdquo;: &ldquo;sensor-ipad&rdquo;, &ldquo;ip&rdquo;: &ldquo;67.185.72.1&rdquo;, &ldquo;cca3&rdquo;: &ldquo;USA&rdquo;, &ldquo;cn&rdquo;: &ldquo;United States&rdquo;, &ldquo;temp&rdquo;: 34, &ldquo;signal&rdquo;: 20, &ldquo;battery_level&rdquo;: 8, &ldquo;c02_level&rdquo;: 1504, &ldquo;timestamp&rdquo; :1475600524 }</td>
</tr>
<tr>
<td style="text-align:left">14</td>
<td style="text-align:left">{&ldquo;device_id&rdquo;: 14, &ldquo;device_type&rdquo;: &ldquo;sensor-inest&rdquo;, &ldquo;ip&rdquo;: &ldquo;68.85.85.106&rdquo;, &ldquo;cca3&rdquo;: &ldquo;USA&rdquo;, &ldquo;cn&rdquo;: &ldquo;United States&rdquo;, &ldquo;temp&rdquo;: 39, &ldquo;signal&rdquo;: 17, &ldquo;battery_level&rdquo;: 8, &ldquo;c02_level&rdquo;: 831, &ldquo;timestamp&rdquo; :1475600526 }</td>
</tr>
<tr>
<td style="text-align:left">15</td>
<td style="text-align:left">{&ldquo;device_id&rdquo;: 15, &ldquo;device_type&rdquo;: &ldquo;sensor-ipad&rdquo;, &ldquo;ip&rdquo;: &ldquo;161.188.212.254&rdquo;, &ldquo;cca3&rdquo;: &ldquo;USA&rdquo;, &ldquo;cn&rdquo;: &ldquo;United States&rdquo;, &ldquo;temp&rdquo;: 27, &ldquo;signal&rdquo;: 26, &ldquo;battery_level&rdquo;: 5, &ldquo;c02_level&rdquo;: 1378, &ldquo;timestamp&rdquo; :1475600528 }</td>
</tr>
<tr>
<td style="text-align:left">16</td>
<td style="text-align:left">{&ldquo;device_id&rdquo;: 16, &ldquo;device_type&rdquo;: &ldquo;sensor-igauge&rdquo;, &ldquo;ip&rdquo;: &ldquo;221.3.128.242&rdquo;, &ldquo;cca3&rdquo;: &ldquo;CHN&rdquo;, &ldquo;cn&rdquo;: &ldquo;China&rdquo;, &ldquo;temp&rdquo;: 10, &ldquo;signal&rdquo;: 24, &ldquo;battery_level&rdquo;: 6, &ldquo;c02_level&rdquo;: 1423, &ldquo;timestamp&rdquo; :1475600530 }</td>
</tr>
<tr>
<td style="text-align:left">17</td>
<td style="text-align:left">{&ldquo;device_id&rdquo;: 17, &ldquo;device_type&rdquo;: &ldquo;sensor-ipad&rdquo;, &ldquo;ip&rdquo;: &ldquo;64.124.180.215&rdquo;, &ldquo;cca3&rdquo;: &ldquo;USA&rdquo;, &ldquo;cn&rdquo;: &ldquo;United States&rdquo;, &ldquo;temp&rdquo;: 38, &ldquo;signal&rdquo;: 17, &ldquo;battery_level&rdquo;: 9, &ldquo;c02_level&rdquo;: 1304, &ldquo;timestamp&rdquo; :1475600532 }</td>
</tr>
<tr>
<td style="text-align:left">18</td>
<td style="text-align:left">{&ldquo;device_id&rdquo;: 18, &ldquo;device_type&rdquo;: &ldquo;sensor-igauge&rdquo;, &ldquo;ip&rdquo;: &ldquo;66.153.162.66&rdquo;, &ldquo;cca3&rdquo;: &ldquo;USA&rdquo;, &ldquo;cn&rdquo;: &ldquo;United States&rdquo;, &ldquo;temp&rdquo;: 26, &ldquo;signal&rdquo;: 10, &ldquo;battery_level&rdquo;: 0, &ldquo;c02_level&rdquo;: 902, &ldquo;timestamp&rdquo; :1475600534 }</td>
</tr>
<tr>
<td style="text-align:left">19</td>
<td style="text-align:left">{&ldquo;device_id&rdquo;: 19, &ldquo;device_type&rdquo;: &ldquo;sensor-ipad&rdquo;, &ldquo;ip&rdquo;: &ldquo;193.200.142.254&rdquo;, &ldquo;cca3&rdquo;: &ldquo;AUT&rdquo;, &ldquo;cn&rdquo;: &ldquo;Austria&rdquo;, &ldquo;temp&rdquo;: 32, &ldquo;signal&rdquo;: 27, &ldquo;battery_level&rdquo;: 5, &ldquo;c02_level&rdquo;: 1282, &ldquo;timestamp&rdquo; :1475600536 }</td>
</tr>
</tbody>
</table>
<p><code>selectExpr()</code> 的另一个用途是它的功能，正如函数名所示，它将表达式作为参数并将它们转换为相应的列。例如，假设我想表达c02水平和温度比。</p>
<pre tabindex="0"><code>display(devicesDF.selectExpr(&#34;c02_level&#34;, &#34;round(c02_level/temp) as ratio_c02_temperature&#34;).orderBy($&#34;ratio_c02_temperature&#34; desc))
</code></pre><table>
<thead>
<tr>
<th style="text-align:left">c02_level</th>
<th style="text-align:left">ratio_c02_temperature</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">1372</td>
<td style="text-align:left">76</td>
</tr>
<tr>
<td style="text-align:left">1220</td>
<td style="text-align:left">68</td>
</tr>
<tr>
<td style="text-align:left">1249</td>
<td style="text-align:left">59</td>
</tr>
<tr>
<td style="text-align:left">1378</td>
<td style="text-align:left">51</td>
</tr>
<tr>
<td style="text-align:left">1413</td>
<td style="text-align:left">47</td>
</tr>
<tr>
<td style="text-align:left">1504</td>
<td style="text-align:left">44</td>
</tr>
<tr>
<td style="text-align:left">1282</td>
<td style="text-align:left">40</td>
</tr>
<tr>
<td style="text-align:left">917</td>
<td style="text-align:left">37</td>
</tr>
<tr>
<td style="text-align:left">1304</td>
<td style="text-align:left">34</td>
</tr>
<tr>
<td style="text-align:left">1574</td>
<td style="text-align:left">31</td>
</tr>
<tr>
<td style="text-align:left">1208</td>
<td style="text-align:left">30</td>
</tr>
<tr>
<td style="text-align:left">886</td>
<td style="text-align:left">28</td>
</tr>
<tr>
<td style="text-align:left">831</td>
<td style="text-align:left">21</td>
</tr>
<tr>
<td style="text-align:left">863</td>
<td style="text-align:left">19</td>
</tr>
</tbody>
</table>
<p>上述查询可以像在 DataFrame API 中一样在 Spark SQL 中轻松表达。 <code>selectExpr()</code> 的强大之处在于处理或处理数值。让我们尝试创建一个临时视图并表达相同的查询，除了这次我们使用 SQL。</p>
<pre tabindex="0"><code>devicesDF.createOrReplaceTempView(&#34;devicesDFT&#34;)
</code></pre><p>请注意，<strong>cmd 42</strong> 的输出与 <strong>cmd</strong> 38 没有区别。两者都使用相同的 Spark SQL 引擎的 Catalyst 并生成等效的底层紧凑代码。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="o">%</span><span class="k">sql</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="n">c02_level</span><span class="p">,</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">round</span><span class="p">(</span><span class="n">c02_level</span><span class="o">/</span><span class="n">temp</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">ratio_c02_temperature</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">from</span><span class="w"> </span><span class="n">devicesDFT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">ratio_c02_temperature</span><span class="w"> </span><span class="k">desc</span><span class="w">
</span></span></span></code></pre></div><table>
<thead>
<tr>
<th style="text-align:left">c02_level</th>
<th style="text-align:left">ratio_c02_temperature</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">1372</td>
<td style="text-align:left">76</td>
</tr>
<tr>
<td style="text-align:left">1220</td>
<td style="text-align:left">68</td>
</tr>
<tr>
<td style="text-align:left">1249</td>
<td style="text-align:left">59</td>
</tr>
<tr>
<td style="text-align:left">1378</td>
<td style="text-align:left">51</td>
</tr>
<tr>
<td style="text-align:left">1413</td>
<td style="text-align:left">47</td>
</tr>
<tr>
<td style="text-align:left">1504</td>
<td style="text-align:left">44</td>
</tr>
<tr>
<td style="text-align:left">1282</td>
<td style="text-align:left">40</td>
</tr>
<tr>
<td style="text-align:left">917</td>
<td style="text-align:left">37</td>
</tr>
<tr>
<td style="text-align:left">1304</td>
<td style="text-align:left">34</td>
</tr>
<tr>
<td style="text-align:left">1574</td>
<td style="text-align:left">31</td>
</tr>
<tr>
<td style="text-align:left">1208</td>
<td style="text-align:left">30</td>
</tr>
<tr>
<td style="text-align:left">886</td>
<td style="text-align:left">28</td>
</tr>
<tr>
<td style="text-align:left">831</td>
<td style="text-align:left">21</td>
</tr>
<tr>
<td style="text-align:left">863</td>
<td style="text-align:left">19</td>
</tr>
</tbody>
</table>
<blockquote>
<p>要验证所有字符串转换是否保留在上面的 DataFrame <code>stringJsonDF</code> 中，让我们将其保存为 blob 存储为 Parquet。</p>
</blockquote>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-scala" data-lang="scala"><span class="line"><span class="cl"><span class="n">stringJsonDF</span>
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="n">write</span>
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="n">mode</span><span class="o">(</span><span class="s">&#34;overwrite&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="n">format</span><span class="o">(</span><span class="s">&#34;parquet&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="n">save</span><span class="o">(</span><span class="s">&#34;/tmp/iot&#34;</span><span class="o">)</span>
</span></span></code></pre></div><p>检查是否所有文件都已写入。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">%fs ls /tmp/iot
</span></span></code></pre></div><table>
<thead>
<tr>
<th style="text-align:left">path</th>
<th style="text-align:left">name</th>
<th style="text-align:left">size</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">dbfs:/tmp/iot/_SUCCESS</td>
<td style="text-align:left">_SUCCESS</td>
<td style="text-align:left">0</td>
</tr>
<tr>
<td style="text-align:left">dbfs:/tmp/iot/part-00000-5ad82ac7-eea2-4439-9635-0dac9279a742.gz.parquet,part-00000-5ad82ac7-eea2-4439-9635-0dac9279a742.gz.parquet,1567</td>
<td></td>
<td></td>
</tr>
<tr>
<td style="text-align:left">dbfs:/tmp/iot/part-00001-5ad82ac7-eea2-4439-9635-0dac9279a742.gz.parquet,part-00001-5ad82ac7-eea2-4439-9635-0dac9279a742.gz.parquet,1598</td>
<td></td>
<td></td>
</tr>
<tr>
<td style="text-align:left">dbfs:/tmp/iot/part-00002-5ad82ac7-eea2-4439-9635-0dac9279a742.gz.parquet,part-00002-5ad82ac7-eea2-4439-9635-0dac9279a742.gz.parquet,1576</td>
<td></td>
<td></td>
</tr>
<tr>
<td style="text-align:left">dbfs:/tmp/iot/part-00003-5ad82ac7-eea2-4439-9635-0dac9279a742.gz.parquet,part-00003-5ad82ac7-eea2-4439-9635-0dac9279a742.gz.parquet,1602</td>
<td></td>
<td></td>
</tr>
<tr>
<td style="text-align:left">dbfs:/tmp/iot/part-00004-5ad82ac7-eea2-4439-9635-0dac9279a742.gz.parquet,part-00004-5ad82ac7-eea2-4439-9635-0dac9279a742.gz.parquet,1574</td>
<td></td>
<td></td>
</tr>
<tr>
<td style="text-align:left">dbfs:/tmp/iot/part-00005-5ad82ac7-eea2-4439-9635-0dac9279a742.gz.parquet,part-00005-5ad82ac7-eea2-4439-9635-0dac9279a742.gz.parquet,1618</td>
<td></td>
<td></td>
</tr>
<tr>
<td style="text-align:left">dbfs:/tmp/iot/part-00006-5ad82ac7-eea2-4439-9635-0dac9279a742.gz.parquet,part-00006-5ad82ac7-eea2-4439-9635-0dac9279a742.gz.parquet,1589</td>
<td></td>
<td></td>
</tr>
<tr>
<td style="text-align:left">dbfs:/tmp/iot/part-00007-5ad82ac7-eea2-4439-9635-0dac9279a742.gz.parquet,part-00007-5ad82ac7-eea2-4439-9635-0dac9279a742.gz.parquet,1624</td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<p>现在让我们验证保存设备是什么，因为从上面编码的每个字符串都是实际的字符串。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-scala" data-lang="scala"><span class="line"><span class="cl"><span class="k">val</span> <span class="n">parquetDF</span> <span class="k">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">parquet</span><span class="o">(</span><span class="s">&#34;/tmp/iot&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="n">parquetDF</span><span class="k">:</span> <span class="kt">org.apache.spark.sql.DataFrame</span> <span class="o">=</span> <span class="o">[</span><span class="kt">devices:</span> <span class="kt">string</span><span class="o">]</span>
</span></span></code></pre></div><p>让我们检查一下模式，以确保所写的内容与读取的内容没有什么不同，即JSON字符串。</p>
<pre tabindex="0"><code>parquetDF.printSchema
root
 |-- devices: string (nullable = true)
</code></pre><table>
<thead>
<tr>
<th style="text-align:left">devices</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">&ldquo;{&ldquo;&ldquo;id&rdquo;&quot;:17,&ldquo;&ldquo;device&rdquo;&rdquo;:&rdquo;&rdquo;{&quot;&ldquo;device_id&quot;&rdquo;: 17, &quot;&ldquo;device_type&quot;&rdquo;: &quot;&ldquo;sensor-ipad&quot;&rdquo;, &quot;&ldquo;ip&quot;&rdquo;: &quot;&ldquo;64.124.180.215&quot;&rdquo;, &quot;&ldquo;cca3&quot;&rdquo;: &quot;&ldquo;USA&quot;&rdquo;, &quot;&ldquo;cn&quot;&rdquo;: &quot;&ldquo;United States&quot;&rdquo;, &quot;&ldquo;temp&quot;&rdquo;: 38, &quot;&ldquo;signal&quot;&rdquo;: 17, &quot;&ldquo;battery_level&quot;&rdquo;: 9, &quot;&ldquo;c02_level&quot;&rdquo;: 1304, &quot;&ldquo;timestamp&quot;&rdquo; :1475600532 }&quot;&quot;}&quot;</td>
</tr>
<tr>
<td style="text-align:left">&ldquo;{&ldquo;&ldquo;id&rdquo;&quot;:18,&ldquo;&ldquo;device&rdquo;&rdquo;:&rdquo;&rdquo;{&quot;&ldquo;device_id&quot;&rdquo;: 18, &quot;&ldquo;device_type&quot;&rdquo;: &quot;&ldquo;sensor-igauge&quot;&rdquo;, &quot;&ldquo;ip&quot;&rdquo;: &quot;&ldquo;66.153.162.66&quot;&rdquo;, &quot;&ldquo;cca3&quot;&rdquo;: &quot;&ldquo;USA&quot;&rdquo;, &quot;&ldquo;cn&quot;&rdquo;: &quot;&ldquo;United States&quot;&rdquo;, &quot;&ldquo;temp&quot;&rdquo;: 26, &quot;&ldquo;signal&quot;&rdquo;: 10, &quot;&ldquo;battery_level&quot;&rdquo;: 0, &quot;&ldquo;c02_level&quot;&rdquo;: 902, &quot;&ldquo;timestamp&quot;&rdquo; :1475600534 }&quot;&quot;}&quot;</td>
</tr>
<tr>
<td style="text-align:left">&ldquo;{&ldquo;&ldquo;id&rdquo;&quot;:19,&ldquo;&ldquo;device&rdquo;&rdquo;:&rdquo;&rdquo;{&quot;&ldquo;device_id&quot;&rdquo;: 19, &quot;&ldquo;device_type&quot;&rdquo;: &quot;&ldquo;sensor-ipad&quot;&rdquo;, &quot;&ldquo;ip&quot;&rdquo;: &quot;&ldquo;193.200.142.254&quot;&rdquo;, &quot;&ldquo;cca3&quot;&rdquo;: &quot;&ldquo;AUT&quot;&rdquo;, &quot;&ldquo;cn&quot;&rdquo;: &quot;&ldquo;Austria&quot;&rdquo;, &quot;&ldquo;temp&quot;&rdquo;: 32, &quot;&ldquo;signal&quot;&rdquo;: 27, &quot;&ldquo;battery_level&quot;&rdquo;: 5, &quot;&ldquo;c02_level&quot;&rdquo;: 1282, &quot;&ldquo;timestamp&quot;&rdquo; :1475600536 }&quot;&quot;}&quot;</td>
</tr>
<tr>
<td style="text-align:left">&ldquo;{&ldquo;&ldquo;id&rdquo;&quot;:12,&ldquo;&ldquo;device&rdquo;&rdquo;:&rdquo;&rdquo;{&quot;&ldquo;device_id&quot;&rdquo;: 12, &quot;&ldquo;device_type&quot;&rdquo;: &quot;&ldquo;sensor-igauge&quot;&rdquo;, &quot;&ldquo;ip&quot;&rdquo;: &quot;&ldquo;193.156.90.200&quot;&rdquo;, &quot;&ldquo;cca3&quot;&rdquo;: &quot;&ldquo;NOR&quot;&rdquo;, &quot;&ldquo;cn&quot;&rdquo;: &quot;&ldquo;Norway&quot;&rdquo;, &quot;&ldquo;temp&quot;&rdquo;: 18, &quot;&ldquo;signal&quot;&rdquo;: 26, &quot;&ldquo;battery_level&quot;&rdquo;: 8, &quot;&ldquo;c02_level&quot;&rdquo;: 1220, &quot;&ldquo;timestamp&quot;&rdquo; :1475600522 }&quot;&quot;}&quot;</td>
</tr>
<tr>
<td style="text-align:left">&ldquo;{&ldquo;&ldquo;id&rdquo;&quot;:13,&ldquo;&ldquo;device&rdquo;&rdquo;:&rdquo;&rdquo;{&quot;&ldquo;device_id&quot;&rdquo;: 13, &quot;&ldquo;device_type&quot;&rdquo;: &quot;&ldquo;sensor-ipad&quot;&rdquo;, &quot;&ldquo;ip&quot;&rdquo;: &quot;&ldquo;67.185.72.1&quot;&rdquo;, &quot;&ldquo;cca3&quot;&rdquo;: &quot;&ldquo;USA&quot;&rdquo;, &quot;&ldquo;cn&quot;&rdquo;: &quot;&ldquo;United States&quot;&rdquo;, &quot;&ldquo;temp&quot;&rdquo;: 34, &quot;&ldquo;signal&quot;&rdquo;: 20, &quot;&ldquo;battery_level&quot;&rdquo;: 8, &quot;&ldquo;c02_level&quot;&rdquo;: 1504, &quot;&ldquo;timestamp&quot;&rdquo; :1475600524 }&quot;&quot;}&quot;</td>
</tr>
<tr>
<td style="text-align:left">&ldquo;{&ldquo;&ldquo;id&rdquo;&quot;:14,&ldquo;&ldquo;device&rdquo;&rdquo;:&rdquo;&rdquo;{&quot;&ldquo;device_id&quot;&rdquo;: 14, &quot;&ldquo;device_type&quot;&rdquo;: &quot;&ldquo;sensor-inest&quot;&rdquo;, &quot;&ldquo;ip&quot;&rdquo;: &quot;&ldquo;68.85.85.106&quot;&rdquo;, &quot;&ldquo;cca3&quot;&rdquo;: &quot;&ldquo;USA&quot;&rdquo;, &quot;&ldquo;cn&quot;&rdquo;: &quot;&ldquo;United States&quot;&rdquo;, &quot;&ldquo;temp&quot;&rdquo;: 39, &quot;&ldquo;signal&quot;&rdquo;: 17, &quot;&ldquo;battery_level&quot;&rdquo;: 8, &quot;&ldquo;c02_level&quot;&rdquo;: 831, &quot;&ldquo;timestamp&quot;&rdquo; :1475600526 }&quot;&quot;}&quot;</td>
</tr>
<tr>
<td style="text-align:left">&ldquo;{&ldquo;&ldquo;id&rdquo;&quot;:7,&ldquo;&ldquo;device&rdquo;&rdquo;:&rdquo;&rdquo;{&quot;&ldquo;device_id&quot;&rdquo;: 7, &quot;&ldquo;device_type&quot;&rdquo;: &quot;&ldquo;sensor-ipad&quot;&rdquo;, &quot;&ldquo;ip&quot;&rdquo;: &quot;&ldquo;118.23.68.227&quot;&rdquo;, &quot;&ldquo;cca3&quot;&rdquo;: &quot;&ldquo;JPN&quot;&rdquo;, &quot;&ldquo;cn&quot;&rdquo;: &quot;&ldquo;Japan&quot;&rdquo;, &quot;&ldquo;temp&quot;&rdquo;: 27, &quot;&ldquo;signal&quot;&rdquo;: 15, &quot;&ldquo;battery_level&quot;&rdquo;: 0, &quot;&ldquo;c02_level&quot;&rdquo;: 1531, &quot;&ldquo;timestamp&quot;&rdquo; :1475600512 }&quot;&quot;}&quot;</td>
</tr>
<tr>
<td style="text-align:left">&ldquo;{&ldquo;&ldquo;id&rdquo;&quot;:8,&ldquo;&ldquo;device&rdquo;&rdquo;:&rdquo;&rdquo; {&quot;&ldquo;device_id&quot;&rdquo;: 8, &quot;&ldquo;device_type&quot;&rdquo;: &quot;&ldquo;sensor-inest&quot;&rdquo;, &quot;&ldquo;ip&quot;&rdquo;: &quot;&ldquo;208.109.163.218&quot;&rdquo;, &quot;&ldquo;cca3&quot;&rdquo;: &quot;&ldquo;USA&quot;&rdquo;, &quot;&ldquo;cn&quot;&rdquo;: &quot;&ldquo;United States&quot;&rdquo;, &quot;&ldquo;temp&quot;&rdquo;: 40, &quot;&ldquo;signal&quot;&rdquo;: 16, &quot;&ldquo;battery_level&quot;&rdquo;: 9, &quot;&ldquo;c02_level&quot;&rdquo;: 1208, &quot;&ldquo;timestamp&quot;&rdquo; :1475600514 }&quot;&quot;}&quot;</td>
</tr>
<tr>
<td style="text-align:left">&ldquo;{&ldquo;&ldquo;id&rdquo;&quot;:9,&ldquo;&ldquo;device&rdquo;&rdquo;:&rdquo;&rdquo;{&quot;&ldquo;device_id&quot;&rdquo;: 9, &quot;&ldquo;device_type&quot;&rdquo;: &quot;&ldquo;sensor-ipad&quot;&rdquo;, &quot;&ldquo;ip&quot;&rdquo;: &quot;&ldquo;88.213.191.34&quot;&rdquo;, &quot;&ldquo;cca3&quot;&rdquo;: &quot;&ldquo;ITA&quot;&rdquo;, &quot;&ldquo;cn&quot;&rdquo;: &quot;&ldquo;Italy&quot;&rdquo;, &quot;&ldquo;temp&quot;&rdquo;: 19, &quot;&ldquo;signal&quot;&rdquo;: 11, &quot;&ldquo;battery_level&quot;&rdquo;: 0, &quot;&ldquo;c02_level&quot;&rdquo;: 1171, &quot;&ldquo;timestamp&quot;&rdquo; :1475600516 }&quot;&quot;}&quot;</td>
</tr>
<tr>
<td style="text-align:left">&ldquo;{&ldquo;&ldquo;id&rdquo;&quot;:2,&ldquo;&ldquo;device&rdquo;&rdquo;:&rdquo;&rdquo;{&quot;&ldquo;device_id&quot;&rdquo;: 2, &quot;&ldquo;device_type&quot;&rdquo;: &quot;&ldquo;sensor-ipad&quot;&rdquo;, &quot;&ldquo;ip&quot;&rdquo;: &quot;&ldquo;88.36.5.1&quot;&rdquo;, &quot;&ldquo;cca3&quot;&rdquo;: &quot;&ldquo;ITA&quot;&rdquo;, &quot;&ldquo;cn&quot;&rdquo;: &quot;&ldquo;Italy&quot;&rdquo;, &quot;&ldquo;temp&quot;&rdquo;: 18, &quot;&ldquo;signal&quot;&rdquo;: 25, &quot;&ldquo;battery_level&quot;&rdquo;: 5, &quot;&ldquo;c02_level&quot;&rdquo;: 1372, &quot;&ldquo;timestamp&quot;&rdquo; :1475600500 }&quot;&quot;}&quot;</td>
</tr>
<tr>
<td style="text-align:left">&ldquo;{&ldquo;&ldquo;id&rdquo;&quot;:3,&ldquo;&ldquo;device&rdquo;&rdquo;:&rdquo;&rdquo;{&quot;&ldquo;device_id&quot;&rdquo;: 3, &quot;&ldquo;device_type&quot;&rdquo;: &quot;&ldquo;sensor-inest&quot;&rdquo;, &quot;&ldquo;ip&quot;&rdquo;: &quot;&ldquo;66.39.173.154&quot;&rdquo;, &quot;&ldquo;cca3&quot;&rdquo;: &quot;&ldquo;USA&quot;&rdquo;, &quot;&ldquo;cn&quot;&rdquo;: &quot;&ldquo;United States&quot;&rdquo;, &quot;&ldquo;temp&quot;&rdquo;: 47, &quot;&ldquo;signal&quot;&rdquo;: 12, &quot;&ldquo;battery_level&quot;&rdquo;: 1, &quot;&ldquo;c02_level&quot;&rdquo;: 1447, &quot;&ldquo;timestamp&quot;&rdquo; :1475600502 }&quot;&quot;}&quot;</td>
</tr>
<tr>
<td style="text-align:left">&ldquo;{&ldquo;&ldquo;id&rdquo;&quot;:4,&ldquo;&ldquo;device&rdquo;&rdquo;:&rdquo;&rdquo;{&quot;&ldquo;device_id&quot;&rdquo;: 4, &quot;&ldquo;device_type&quot;&rdquo;: &quot;&ldquo;sensor-ipad&quot;&rdquo;, &quot;&ldquo;ip&quot;&rdquo;: &quot;&ldquo;203.82.41.9&quot;&rdquo;, &quot;&ldquo;cca3&quot;&rdquo;: &quot;&ldquo;PHL&quot;&rdquo;, &quot;&ldquo;cn&quot;&rdquo;: &quot;&ldquo;Philippines&quot;&rdquo;, &quot;&ldquo;temp&quot;&rdquo;: 29, &quot;&ldquo;signal&quot;&rdquo;: 11, &quot;&ldquo;battery_level&quot;&rdquo;: 0, &quot;&ldquo;c02_level&quot;&rdquo;: 983, &quot;&ldquo;timestamp&quot;&rdquo; :1475600504 }&quot;&quot;}&quot;</td>
</tr>
<tr>
<td style="text-align:left">&ldquo;{&ldquo;&ldquo;id&rdquo;&quot;:15,&ldquo;&ldquo;device&rdquo;&rdquo;:&rdquo;&rdquo;{&quot;&ldquo;device_id&quot;&rdquo;: 15, &quot;&ldquo;device_type&quot;&rdquo;: &quot;&ldquo;sensor-ipad&quot;&rdquo;, &quot;&ldquo;ip&quot;&rdquo;: &quot;&ldquo;161.188.212.254&quot;&rdquo;, &quot;&ldquo;cca3&quot;&rdquo;: &quot;&ldquo;USA&quot;&rdquo;, &quot;&ldquo;cn&quot;&rdquo;: &quot;&ldquo;United States&quot;&rdquo;, &quot;&ldquo;temp&quot;&rdquo;: 27, &quot;&ldquo;signal&quot;&rdquo;: 26, &quot;&ldquo;battery_level&quot;&rdquo;: 5, &quot;&ldquo;c02_level&quot;&rdquo;: 1378, &quot;&ldquo;timestamp&quot;&rdquo; :1475600528 }&quot;&quot;}&quot;</td>
</tr>
<tr>
<td style="text-align:left">&ldquo;{&ldquo;&ldquo;id&rdquo;&quot;:16,&ldquo;&ldquo;device&rdquo;&rdquo;:&rdquo;&rdquo;{&quot;&ldquo;device_id&quot;&rdquo;: 16, &quot;&ldquo;device_type&quot;&rdquo;: &quot;&ldquo;sensor-igauge&quot;&rdquo;, &quot;&ldquo;ip&quot;&rdquo;: &quot;&ldquo;221.3.128.242&quot;&rdquo;, &quot;&ldquo;cca3&quot;&rdquo;: &quot;&ldquo;CHN&quot;&rdquo;, &quot;&ldquo;cn&quot;&rdquo;: &quot;&ldquo;China&quot;&rdquo;, &quot;&ldquo;temp&quot;&rdquo;: 10, &quot;&ldquo;signal&quot;&rdquo;: 24, &quot;&ldquo;battery_level&quot;&rdquo;: 6, &quot;&ldquo;c02_level&quot;&rdquo;: 1423, &quot;&ldquo;timestamp&quot;&rdquo; :1475600530 }&quot;&quot;}&quot;</td>
</tr>
<tr>
<td style="text-align:left">&ldquo;{&ldquo;&ldquo;id&rdquo;&quot;:5,&ldquo;&ldquo;device&rdquo;&rdquo;:&rdquo;&rdquo;{&quot;&ldquo;device_id&quot;&rdquo;: 5, &quot;&ldquo;device_type&quot;&rdquo;: &quot;&ldquo;sensor-istick&quot;&rdquo;, &quot;&ldquo;ip&quot;&rdquo;: &quot;&ldquo;204.116.105.67&quot;&rdquo;, &quot;&ldquo;cca3&quot;&rdquo;: &quot;&ldquo;USA&quot;&rdquo;, &quot;&ldquo;cn&quot;&rdquo;: &quot;&ldquo;United States&quot;&rdquo;, &quot;&ldquo;temp&quot;&rdquo;: 50, &quot;&ldquo;signal&quot;&rdquo;: 16, &quot;&ldquo;battery_level&quot;&rdquo;: 8, &quot;&ldquo;c02_level&quot;&rdquo;: 1574, &quot;&ldquo;timestamp&quot;&rdquo; :1475600506 }&quot;&quot;}&quot;</td>
</tr>
<tr>
<td style="text-align:left">&ldquo;{&ldquo;&ldquo;id&rdquo;&quot;:6,&ldquo;&ldquo;device&rdquo;&rdquo;:&rdquo;&rdquo;{&quot;&ldquo;device_id&quot;&rdquo;: 6, &quot;&ldquo;device_type&quot;&rdquo;: &quot;&ldquo;sensor-ipad&quot;&rdquo;, &quot;&ldquo;ip&quot;&rdquo;: &quot;&ldquo;220.173.179.1&quot;&rdquo;, &quot;&ldquo;cca3&quot;&rdquo;: &quot;&ldquo;CHN&quot;&rdquo;, &quot;&ldquo;cn&quot;&rdquo;: &quot;&ldquo;China&quot;&rdquo;, &quot;&ldquo;temp&quot;&rdquo;: 21, &quot;&ldquo;signal&quot;&rdquo;: 18, &quot;&ldquo;battery_level&quot;&rdquo;: 9, &quot;&ldquo;c02_level&quot;&rdquo;: 1249, &quot;&ldquo;timestamp&quot;&rdquo; :1475600508 }&quot;&quot;}&quot;</td>
</tr>
<tr>
<td style="text-align:left">&ldquo;{&ldquo;&ldquo;id&rdquo;&quot;:10,&ldquo;&ldquo;device&rdquo;&rdquo;:&rdquo;&rdquo;{&quot;&ldquo;device_id&quot;&rdquo;: 10, &quot;&ldquo;device_type&quot;&rdquo;: &quot;&ldquo;sensor-igauge&quot;&rdquo;, &quot;&ldquo;ip&quot;&rdquo;: &quot;&ldquo;68.28.91.22&quot;&rdquo;, &quot;&ldquo;cca3&quot;&rdquo;: &quot;&ldquo;USA&quot;&rdquo;, &quot;&ldquo;cn&quot;&rdquo;: &quot;&ldquo;United States&quot;&rdquo;, &quot;&ldquo;temp&quot;&rdquo;: 32, &quot;&ldquo;signal&quot;&rdquo;: 26, &quot;&ldquo;battery_level&quot;&rdquo;: 7, &quot;&ldquo;c02_level&quot;&rdquo;: 886, &quot;&ldquo;timestamp&quot;&rdquo; :1475600518 }&quot;&quot;}&quot;</td>
</tr>
<tr>
<td style="text-align:left">&ldquo;{&ldquo;&ldquo;id&rdquo;&quot;:11,&ldquo;&ldquo;device&rdquo;&rdquo;:&rdquo;&rdquo;{&quot;&ldquo;device_id&quot;&rdquo;: 11, &quot;&ldquo;device_type&quot;&rdquo;: &quot;&ldquo;sensor-ipad&quot;&rdquo;, &quot;&ldquo;ip&quot;&rdquo;: &quot;&ldquo;59.144.114.250&quot;&rdquo;, &quot;&ldquo;cca3&quot;&rdquo;: &quot;&ldquo;IND&quot;&rdquo;, &quot;&ldquo;cn&quot;&rdquo;: &quot;&ldquo;India&quot;&rdquo;, &quot;&ldquo;temp&quot;&rdquo;: 46, &quot;&ldquo;signal&quot;&rdquo;: 25, &quot;&ldquo;battery_level&quot;&rdquo;: 4, &quot;&ldquo;c02_level&quot;&rdquo;: 863, &quot;&ldquo;timestamp&quot;&rdquo; :1475600520 }&quot;&quot;}&quot;</td>
</tr>
<tr>
<td style="text-align:left">&ldquo;{&ldquo;&ldquo;id&rdquo;&quot;:0,&ldquo;&ldquo;device&rdquo;&rdquo;:&rdquo;&rdquo;{&quot;&ldquo;device_id&quot;&rdquo;: 0, &quot;&ldquo;device_type&quot;&rdquo;: &quot;&ldquo;sensor-ipad&quot;&rdquo;, &quot;&ldquo;ip&quot;&rdquo;: &quot;&ldquo;68.161.225.1&quot;&rdquo;, &quot;&ldquo;cca3&quot;&rdquo;: &quot;&ldquo;USA&quot;&rdquo;, &quot;&ldquo;cn&quot;&rdquo;: &quot;&ldquo;United States&quot;&rdquo;, &quot;&ldquo;temp&quot;&rdquo;: 25, &quot;&ldquo;signal&quot;&rdquo;: 23, &quot;&ldquo;battery_level&quot;&rdquo;: 8, &quot;&ldquo;c02_level&quot;&rdquo;: 917, &quot;&ldquo;timestamp&quot;&rdquo; :1475600496 }&quot;&quot;}&quot;</td>
</tr>
<tr>
<td style="text-align:left">&ldquo;{&ldquo;&ldquo;id&rdquo;&quot;:1,&ldquo;&ldquo;device&rdquo;&rdquo;:&rdquo;&rdquo;{&quot;&ldquo;device_id&quot;&rdquo;: 1, &quot;&ldquo;device_type&quot;&rdquo;: &quot;&ldquo;sensor-igauge&quot;&rdquo;, &quot;&ldquo;ip&quot;&rdquo;: &quot;&ldquo;213.161.254.1&quot;&rdquo;, &quot;&ldquo;cca3&quot;&rdquo;: &quot;&ldquo;NOR&quot;&rdquo;, &quot;&ldquo;cn&quot;&rdquo;: &quot;&ldquo;Norway&quot;&rdquo;, &quot;&ldquo;temp&quot;&rdquo;: 30, &quot;&ldquo;signal&quot;&rdquo;: 18, &quot;&ldquo;battery_level&quot;&rdquo;: 6, &quot;&ldquo;c02_level&quot;&rdquo;: 1413, &quot;&ldquo;timestamp&quot;&rdquo; :1475600498 }&quot;&quot;}&quot;</td>
</tr>
</tbody>
</table>
<p>到目前为止，本教程已探索了使用 <code>get_json_object()</code>，<code>from_json()</code>，<code>to_json()</code>，<code>selectExpr()</code> 和 <code>explode()</code> 辅助函数处理不太复杂的 JSON 对象的方法。</p>
<p>让我们将焦点转向更嵌套的结构，并检查应用于复杂 JSON 的这些相同 API 如何简单。</p>
<h2 id="嵌套结构">嵌套结构&nbsp;<a class="headline-hash no-text-decoration" href="#嵌套结构">#</a> </h2>
<p>假设您的 JSON 嵌套结构可能包含 Maps 以及嵌套 JSON，这并不是不合理的。为了说明，我们使用由复杂和嵌套数据类型组成的单个字符串，包括 Map。在现实生活中，这可能是设备事件的读数，具有危险的二氧化碳排放水平或高温读数，需要网络运营中心（NOC）通知某些立即行动。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-scala" data-lang="scala"><span class="line"><span class="cl"><span class="k">import</span> <span class="nn">org.apache.spark.sql.types._</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">val</span> <span class="n">schema</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">StructType</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="n">add</span><span class="o">(</span><span class="s">&#34;dc_id&#34;</span><span class="o">,</span> <span class="nc">StringType</span><span class="o">)</span>                               <span class="c1">// data center where data was posted to Kafka cluster
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="o">.</span><span class="n">add</span><span class="o">(</span><span class="s">&#34;source&#34;</span><span class="o">,</span>                                          <span class="c1">// info about the source of alarm
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nc">MapType</span><span class="o">(</span>                                              <span class="c1">// define this as a Map(Key-&gt;value)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="nc">StringType</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">      <span class="k">new</span> <span class="nc">StructType</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">      <span class="o">.</span><span class="n">add</span><span class="o">(</span><span class="s">&#34;description&#34;</span><span class="o">,</span> <span class="nc">StringType</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">      <span class="o">.</span><span class="n">add</span><span class="o">(</span><span class="s">&#34;ip&#34;</span><span class="o">,</span> <span class="nc">StringType</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">      <span class="o">.</span><span class="n">add</span><span class="o">(</span><span class="s">&#34;id&#34;</span><span class="o">,</span> <span class="nc">LongType</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">      <span class="o">.</span><span class="n">add</span><span class="o">(</span><span class="s">&#34;temp&#34;</span><span class="o">,</span> <span class="nc">LongType</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">      <span class="o">.</span><span class="n">add</span><span class="o">(</span><span class="s">&#34;c02_level&#34;</span><span class="o">,</span> <span class="nc">LongType</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">      <span class="o">.</span><span class="n">add</span><span class="o">(</span><span class="s">&#34;geo&#34;</span><span class="o">,</span> 
</span></span><span class="line"><span class="cl">         <span class="k">new</span> <span class="nc">StructType</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">          <span class="o">.</span><span class="n">add</span><span class="o">(</span><span class="s">&#34;lat&#34;</span><span class="o">,</span> <span class="nc">DoubleType</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">          <span class="o">.</span><span class="n">add</span><span class="o">(</span><span class="s">&#34;long&#34;</span><span class="o">,</span> <span class="nc">DoubleType</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">        <span class="o">)</span>
</span></span><span class="line"><span class="cl">      <span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="k">import</span> <span class="nn">org.apache.spark.sql.types._</span>
</span></span><span class="line"><span class="cl"><span class="n">schema</span><span class="k">:</span> <span class="kt">org.apache.spark.sql.</span><span class="k">type</span><span class="kt">s.StructType</span> <span class="o">=</span> <span class="nc">StructType</span><span class="o">(</span><span class="nc">StructField</span><span class="o">(</span><span class="n">dc_id</span><span class="o">,</span><span class="nc">StringType</span><span class="o">,</span><span class="kc">true</span><span class="o">),</span> <span class="nc">StructField</span><span class="o">(</span><span class="n">source</span><span class="o">,</span><span class="nc">MapType</span><span class="o">(</span><span class="nc">StringType</span><span class="o">,</span><span class="nc">StructType</span><span class="o">(</span><span class="nc">StructField</span><span class="o">(</span><span class="n">description</span><span class="o">,</span><span class="nc">StringType</span><span class="o">,</span><span class="kc">true</span><span class="o">),</span> <span class="nc">StructField</span><span class="o">(</span><span class="n">ip</span><span class="o">,</span><span class="nc">StringType</span><span class="o">,</span><span class="kc">true</span><span class="o">),</span> <span class="nc">StructField</span><span class="o">(</span><span class="n">id</span><span class="o">,</span><span class="nc">LongType</span><span class="o">,</span><span class="kc">true</span><span class="o">),</span> <span class="nc">StructField</span><span class="o">(</span><span class="n">temp</span><span class="o">,</span><span class="nc">LongType</span><span class="o">,</span><span class="kc">true</span><span class="o">),</span> <span class="nc">StructField</span><span class="o">(</span><span class="n">c02_level</span><span class="o">,</span><span class="nc">LongType</span><span class="o">,</span><span class="kc">true</span><span class="o">),</span> <span class="nc">StructField</span><span class="o">(</span><span class="n">geo</span><span class="o">,</span><span class="nc">StructType</span><span class="o">(</span><span class="nc">StructField</span><span class="o">(</span><span class="n">lat</span><span class="o">,</span><span class="nc">DoubleType</span><span class="o">,</span><span class="kc">true</span><span class="o">),</span> <span class="nc">StructField</span><span class="o">(</span><span class="n">long</span><span class="o">,</span><span class="nc">DoubleType</span><span class="o">,</span><span class="kc">true</span><span class="o">)),</span><span class="kc">true</span><span class="o">)),</span><span class="kc">true</span><span class="o">),</span><span class="kc">true</span><span class="o">))</span>
</span></span></code></pre></div><p>让我们创建一个复杂数据类型的复杂 JSON。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-scala" data-lang="scala"><span class="line"><span class="cl"><span class="c1">//create a single entry with id and its complex and nested data types
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="k">val</span> <span class="n">dataDS</span> <span class="k">=</span> <span class="nc">Seq</span><span class="o">(</span><span class="s">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">{
</span></span></span><span class="line"><span class="cl"><span class="s">&#34;dc_id&#34;: &#34;dc-101&#34;,
</span></span></span><span class="line"><span class="cl"><span class="s">&#34;source&#34;: {
</span></span></span><span class="line"><span class="cl"><span class="s">    &#34;sensor-igauge&#34;: {
</span></span></span><span class="line"><span class="cl"><span class="s">      &#34;id&#34;: 10,
</span></span></span><span class="line"><span class="cl"><span class="s">      &#34;ip&#34;: &#34;68.28.91.22&#34;,
</span></span></span><span class="line"><span class="cl"><span class="s">      &#34;description&#34;: &#34;Sensor attached to the container ceilings&#34;,
</span></span></span><span class="line"><span class="cl"><span class="s">      &#34;temp&#34;:35,
</span></span></span><span class="line"><span class="cl"><span class="s">      &#34;c02_level&#34;: 1475,
</span></span></span><span class="line"><span class="cl"><span class="s">      &#34;geo&#34;: {&#34;lat&#34;:38.00, &#34;long&#34;:97.00}                        
</span></span></span><span class="line"><span class="cl"><span class="s">    },
</span></span></span><span class="line"><span class="cl"><span class="s">    &#34;sensor-ipad&#34;: {
</span></span></span><span class="line"><span class="cl"><span class="s">      &#34;id&#34;: 13,
</span></span></span><span class="line"><span class="cl"><span class="s">      &#34;ip&#34;: &#34;67.185.72.1&#34;,
</span></span></span><span class="line"><span class="cl"><span class="s">      &#34;description&#34;: &#34;Sensor ipad attached to carbon cylinders&#34;,
</span></span></span><span class="line"><span class="cl"><span class="s">      &#34;temp&#34;: 34,
</span></span></span><span class="line"><span class="cl"><span class="s">      &#34;c02_level&#34;: 1370,
</span></span></span><span class="line"><span class="cl"><span class="s">      &#34;geo&#34;: {&#34;lat&#34;:47.41, &#34;long&#34;:-122.00}
</span></span></span><span class="line"><span class="cl"><span class="s">    },
</span></span></span><span class="line"><span class="cl"><span class="s">    &#34;sensor-inest&#34;: {
</span></span></span><span class="line"><span class="cl"><span class="s">      &#34;id&#34;: 8,
</span></span></span><span class="line"><span class="cl"><span class="s">      &#34;ip&#34;: &#34;208.109.163.218&#34;,
</span></span></span><span class="line"><span class="cl"><span class="s">      &#34;description&#34;: &#34;Sensor attached to the factory ceilings&#34;,
</span></span></span><span class="line"><span class="cl"><span class="s">      &#34;temp&#34;: 40,
</span></span></span><span class="line"><span class="cl"><span class="s">      &#34;c02_level&#34;: 1346,
</span></span></span><span class="line"><span class="cl"><span class="s">      &#34;geo&#34;: {&#34;lat&#34;:33.61, &#34;long&#34;:-111.89}
</span></span></span><span class="line"><span class="cl"><span class="s">    },
</span></span></span><span class="line"><span class="cl"><span class="s">    &#34;sensor-istick&#34;: {
</span></span></span><span class="line"><span class="cl"><span class="s">      &#34;id&#34;: 5,
</span></span></span><span class="line"><span class="cl"><span class="s">      &#34;ip&#34;: &#34;204.116.105.67&#34;,
</span></span></span><span class="line"><span class="cl"><span class="s">      &#34;description&#34;: &#34;Sensor embedded in exhaust pipes in the ceilings&#34;,
</span></span></span><span class="line"><span class="cl"><span class="s">      &#34;temp&#34;: 40,
</span></span></span><span class="line"><span class="cl"><span class="s">      &#34;c02_level&#34;: 1574,
</span></span></span><span class="line"><span class="cl"><span class="s">      &#34;geo&#34;: {&#34;lat&#34;:35.93, &#34;long&#34;:-85.46}
</span></span></span><span class="line"><span class="cl"><span class="s">    }
</span></span></span><span class="line"><span class="cl"><span class="s">  }
</span></span></span><span class="line"><span class="cl"><span class="s">}&#34;&#34;&#34;</span><span class="o">).</span><span class="n">toDS</span><span class="o">()</span>
</span></span><span class="line"><span class="cl"><span class="c1">// should only be one item
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">dataDS</span><span class="o">.</span><span class="n">count</span><span class="o">()</span>
</span></span><span class="line"><span class="cl"><span class="n">dataDS</span><span class="k">:</span> <span class="kt">org.apache.spark.sql.Dataset</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="k">=</span> <span class="o">[</span><span class="kt">value:</span> <span class="kt">string</span><span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="n">res15</span><span class="k">:</span> <span class="kt">Long</span> <span class="o">=</span> <span class="mi">1</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="nt">&#34;dc_id&#34;</span><span class="p">:</span> <span class="s2">&#34;dc-101&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="nt">&#34;source&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;sensor-igauge&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;id&#34;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;ip&#34;</span><span class="p">:</span> <span class="s2">&#34;68.28.91.22&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;description&#34;</span><span class="p">:</span> <span class="s2">&#34;Sensor attached to the container ceilings&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;temp&#34;</span><span class="p">:</span><span class="mi">35</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;c02_level&#34;</span><span class="p">:</span> <span class="mi">1475</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;geo&#34;</span><span class="p">:</span> <span class="p">{</span><span class="nt">&#34;lat&#34;</span><span class="p">:</span><span class="mf">38.00</span><span class="p">,</span> <span class="nt">&#34;long&#34;</span><span class="p">:</span><span class="mf">97.00</span><span class="p">}</span>                        
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;sensor-ipad&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;id&#34;</span><span class="p">:</span> <span class="mi">13</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;ip&#34;</span><span class="p">:</span> <span class="s2">&#34;67.185.72.1&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;description&#34;</span><span class="p">:</span> <span class="s2">&#34;Sensor ipad attached to carbon cylinders&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;temp&#34;</span><span class="p">:</span> <span class="mi">34</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;c02_level&#34;</span><span class="p">:</span> <span class="mi">1370</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;geo&#34;</span><span class="p">:</span> <span class="p">{</span><span class="nt">&#34;lat&#34;</span><span class="p">:</span><span class="mf">47.41</span><span class="p">,</span> <span class="nt">&#34;long&#34;</span><span class="p">:</span><span class="mf">-122.00</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;sensor-inest&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;id&#34;</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;ip&#34;</span><span class="p">:</span> <span class="s2">&#34;208.109.163.218&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;description&#34;</span><span class="p">:</span> <span class="s2">&#34;Sensor attached to the factory ceilings&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;temp&#34;</span><span class="p">:</span> <span class="mi">40</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;c02_level&#34;</span><span class="p">:</span> <span class="mi">1346</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;geo&#34;</span><span class="p">:</span> <span class="p">{</span><span class="nt">&#34;lat&#34;</span><span class="p">:</span><span class="mf">33.61</span><span class="p">,</span> <span class="nt">&#34;long&#34;</span><span class="p">:</span><span class="mf">-111.89</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;sensor-istick&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;id&#34;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;ip&#34;</span><span class="p">:</span> <span class="s2">&#34;204.116.105.67&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;description&#34;</span><span class="p">:</span> <span class="s2">&#34;Sensor embedded in exhaust pipes in the ceilings&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;temp&#34;</span><span class="p">:</span> <span class="mi">40</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;c02_level&#34;</span><span class="p">:</span> <span class="mi">1574</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;geo&#34;</span><span class="p">:</span> <span class="p">{</span><span class="nt">&#34;lat&#34;</span><span class="p">:</span><span class="mf">35.93</span><span class="p">,</span> <span class="nt">&#34;long&#34;</span><span class="p">:</span><span class="mf">-85.46</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>我们来处理吧。请注意，我们有嵌套结构 <code>geo</code>。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-scala" data-lang="scala"><span class="line"><span class="cl"><span class="k">val</span> <span class="n">df</span> <span class="k">=</span> <span class="n">spark</span>                  <span class="c1">// spark session 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">.</span><span class="n">read</span>                           <span class="c1">// get DataFrameReader
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">.</span><span class="n">schema</span><span class="o">(</span><span class="n">schema</span><span class="o">)</span>                 <span class="c1">// use the defined schema above and read format as JSON
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">.</span><span class="n">json</span><span class="o">(</span><span class="n">dataDS</span><span class="o">.</span><span class="n">rdd</span><span class="o">)</span>               <span class="c1">// RDD[String]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">df</span><span class="k">:</span> <span class="kt">org.apache.spark.sql.DataFrame</span> <span class="o">=</span> <span class="o">[</span><span class="kt">dc_id:</span> <span class="kt">string</span>, <span class="kt">source:</span> <span class="kt">map&lt;string</span>,<span class="kt">struct&lt;description:string</span>,<span class="kt">ip:string</span>,<span class="kt">id:bigint</span>,<span class="kt">temp:bigint</span>,<span class="kt">c02_level:bigint</span>,<span class="kt">geo:struct&lt;lat:double</span>,<span class="kt">long:double&gt;&gt;&gt;</span><span class="o">]</span>
</span></span></code></pre></div><p>我们来看看它的嵌套和复杂 schema。</p>
<pre tabindex="0"><code>df.printSchema
root
 |-- dc_id: string (nullable = true)
 |-- source: map (nullable = true)
 |    |-- key: string
 |    |-- value: struct (valueContainsNull = true)
 |    |    |-- description: string (nullable = true)
 |    |    |-- ip: string (nullable = true)
 |    |    |-- id: long (nullable = true)
 |    |    |-- temp: long (nullable = true)
 |    |    |-- c02_level: long (nullable = true)
 |    |    |-- geo: struct (nullable = true)
 |    |    |    |-- lat: double (nullable = true)
 |    |    |    |-- long: double (nullable = true)
</code></pre><pre tabindex="0"><code>dc_id, source
dc-101,{&#34;sensor-igauge&#34;:{&#34;description&#34;:&#34;Sensor attached to the container ceilings&#34;,&#34;ip&#34;:&#34;68.28.91.22&#34;,&#34;id&#34;:&#34;10&#34;,&#34;temp&#34;:&#34;35&#34;,&#34;c02_level&#34;:&#34;1475&#34;,&#34;geo&#34;:{&#34;lat&#34;:38,&#34;long&#34;:97}},&#34;sensor-ipad&#34;:{&#34;description&#34;:&#34;Sensor ipad attached to carbon cylinders&#34;,&#34;ip&#34;:&#34;67.185.72.1&#34;,&#34;id&#34;:&#34;13&#34;,&#34;temp&#34;:&#34;34&#34;,&#34;c02_level&#34;:&#34;1370&#34;,&#34;geo&#34;:{&#34;lat&#34;:47.41,&#34;long&#34;:-122}},&#34;sensor-inest&#34;:{&#34;description&#34;:&#34;Sensor attached to the factory ceilings&#34;,&#34;ip&#34;:&#34;208.109.163.218&#34;,&#34;id&#34;:&#34;8&#34;,&#34;temp&#34;:&#34;40&#34;,&#34;c02_level&#34;:&#34;1346&#34;,&#34;geo&#34;:{&#34;lat&#34;:33.61,&#34;long&#34;:-111.89}},&#34;sensor-istick&#34;:{&#34;description&#34;:&#34;Sensor embedded in exhaust pipes in the ceilings&#34;,&#34;ip&#34;:&#34;204.116.105.67&#34;,&#34;id&#34;:&#34;5&#34;,&#34;temp&#34;:&#34;40&#34;,&#34;c02_level&#34;:&#34;1574&#34;,&#34;geo&#34;:{&#34;lat&#34;:35.93,&#34;long&#34;:-85.46}}}
</code></pre><h2 id="如何使用-explode">如何使用 explode()&nbsp;<a class="headline-hash no-text-decoration" href="#如何使用-explode">#</a> </h2>
<p><code>explode()</code> 函数用于显示如何提取嵌套结构。另外，当我们从复杂的 JSON 结构中提取属性和值时，我们看到它与 <code>to_json()</code> 和 <code>from_json()</code> 函数一起工作时会有更多的亮点。所以偶尔，你会想要使用 <code>explode()</code>，以及 <code>to_json()</code> 和 <code>from_json()</code> 函数。这是我们做的一个案例。
<code>explode()</code> 函数为给定 map 列中的每个元素创建一个新行。在这种情况下，map 列是 <code>source</code>。请注意，对于 map 中的每个键值，您都有一个相应的行，在本例中为四个。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-scala" data-lang="scala"><span class="line"><span class="cl"><span class="c1">// select from DataFrame with a single entry, and explode its column source, which is Map, with nested structure.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">val</span> <span class="n">explodedDF</span> <span class="k">=</span> <span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="o">(</span><span class="n">$</span><span class="s">&#34;dc_id&#34;</span><span class="o">,</span> <span class="n">explode</span><span class="o">(</span><span class="n">$</span><span class="s">&#34;source&#34;</span><span class="o">))</span>
</span></span><span class="line"><span class="cl"><span class="n">display</span><span class="o">(</span><span class="n">explodedDF</span><span class="o">)</span>
</span></span></code></pre></div><table>
<thead>
<tr>
<th style="text-align:left">dc_id</th>
<th style="text-align:left">key</th>
<th style="text-align:left">value</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">dc-101</td>
<td style="text-align:left">sensor-igauge</td>
<td style="text-align:left">{&ldquo;description&rdquo;:&ldquo;Sensor attached to the container ceilings&rdquo;,&ldquo;ip&rdquo;:&ldquo;68.28.91.22&rdquo;,&ldquo;id&rdquo;:&ldquo;10&rdquo;,&ldquo;temp&rdquo;:&ldquo;35&rdquo;,&ldquo;c02_level&rdquo;:&ldquo;1475&rdquo;,&ldquo;geo&rdquo;:{&ldquo;lat&rdquo;:38,&ldquo;long&rdquo;:97}}</td>
</tr>
<tr>
<td style="text-align:left">dc-101</td>
<td style="text-align:left">sensor-ipad</td>
<td style="text-align:left">{&ldquo;description&rdquo;:&ldquo;Sensor ipad attached to carbon cylinders&rdquo;,&ldquo;ip&rdquo;:&ldquo;67.185.72.1&rdquo;,&ldquo;id&rdquo;:&ldquo;13&rdquo;,&ldquo;temp&rdquo;:&ldquo;34&rdquo;,&ldquo;c02_level&rdquo;:&ldquo;1370&rdquo;,&ldquo;geo&rdquo;:{&ldquo;lat&rdquo;:47.41,&ldquo;long&rdquo;:-122}}</td>
</tr>
<tr>
<td style="text-align:left">dc-101</td>
<td style="text-align:left">sensor-inest</td>
<td style="text-align:left">{&ldquo;description&rdquo;:&ldquo;Sensor attached to the factory ceilings&rdquo;,&ldquo;ip&rdquo;:&ldquo;208.109.163.218&rdquo;,&ldquo;id&rdquo;:&ldquo;8&rdquo;,&ldquo;temp&rdquo;:&ldquo;40&rdquo;,&ldquo;c02_level&rdquo;:&ldquo;1346&rdquo;,&ldquo;geo&rdquo;:{&ldquo;lat&rdquo;:33.61,&ldquo;long&rdquo;:-111.89}}</td>
</tr>
<tr>
<td style="text-align:left">dc-101</td>
<td style="text-align:left">sensor-istick</td>
<td style="text-align:left">{&ldquo;description&rdquo;:&ldquo;Sensor embedded in exhaust pipes in the ceilings&rdquo;,&ldquo;ip&rdquo;:&ldquo;204.116.105.67&rdquo;,&ldquo;id&rdquo;:&ldquo;5&rdquo;,&ldquo;temp&rdquo;:&ldquo;40&rdquo;,&ldquo;c02_level&rdquo;:&ldquo;1574&rdquo;,&ldquo;geo&rdquo;:{&ldquo;lat&rdquo;:35.93,&ldquo;long&rdquo;:-85.46}}</td>
</tr>
</tbody>
</table>
<p>查看架构时，请注意现在已扩展 <code>source</code>。</p>
<pre tabindex="0"><code>explodedDF.printSchema
root
 |-- dc_id: string (nullable = true)
 |-- key: string (nullable = false)
 |-- value: struct (nullable = true)
 |    |-- description: string (nullable = true)
 |    |-- ip: string (nullable = true)
 |    |-- id: long (nullable = true)
 |    |-- temp: long (nullable = true)
 |    |-- c02_level: long (nullable = true)
 |    |-- geo: struct (nullable = true)
 |    |    |-- lat: double (nullable = true)
 |    |    |-- long: double (nullable = true)
</code></pre><p>与复杂数据类型聚合的单个字符串，包括 Map。这可能是需要网络运营中心（NOC）注意行动的记录，因为温度和二氧化碳水平都是惊人的。</p>
<p>让我们使用 Map 访问我们的爆炸数据中的数据。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-scala" data-lang="scala"><span class="line"><span class="cl"><span class="c1">//case class to denote our desired Scala object
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">case</span> <span class="k">class</span> <span class="nc">DeviceAlert</span><span class="o">(</span><span class="n">dcId</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">deviceType</span><span class="k">:</span><span class="kt">String</span><span class="o">,</span> <span class="n">ip</span><span class="k">:</span><span class="kt">String</span><span class="o">,</span> <span class="n">deviceId</span><span class="k">:</span><span class="kt">Long</span><span class="o">,</span> <span class="n">temp</span><span class="k">:</span><span class="kt">Long</span><span class="o">,</span> <span class="n">c02_level</span><span class="k">:</span> <span class="kt">Long</span><span class="o">,</span> <span class="n">lat</span><span class="k">:</span> <span class="kt">Double</span><span class="o">,</span> <span class="n">lon</span><span class="k">:</span> <span class="kt">Double</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">//access all values using getItem() method on value, by providing the &#34;key,&#34; which is attribute in our JSON object.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">val</span> <span class="n">notifydevicesDS</span> <span class="k">=</span> <span class="n">explodedDF</span><span class="o">.</span><span class="n">select</span><span class="o">(</span> <span class="n">$</span><span class="s">&#34;dc_id&#34;</span> <span class="n">as</span> <span class="s">&#34;dcId&#34;</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                        <span class="n">$</span><span class="s">&#34;key&#34;</span> <span class="n">as</span> <span class="s">&#34;deviceType&#34;</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                        &#39;value<span class="o">.</span><span class="n">getItem</span><span class="o">(</span><span class="s">&#34;ip&#34;</span><span class="o">)</span> <span class="n">as</span> &#39;ip<span class="o">,</span>
</span></span><span class="line"><span class="cl">                        &#39;value<span class="o">.</span><span class="n">getItem</span><span class="o">(</span><span class="s">&#34;id&#34;</span><span class="o">)</span> <span class="n">as</span> &#39;deviceId<span class="o">,</span>
</span></span><span class="line"><span class="cl">                        &#39;value<span class="o">.</span><span class="n">getItem</span><span class="o">(</span><span class="s">&#34;c02_level&#34;</span><span class="o">)</span> <span class="n">as</span> &#39;c02_level<span class="o">,</span>
</span></span><span class="line"><span class="cl">                        &#39;value<span class="o">.</span><span class="n">getItem</span><span class="o">(</span><span class="s">&#34;temp&#34;</span><span class="o">)</span> <span class="n">as</span> &#39;temp<span class="o">,</span>
</span></span><span class="line"><span class="cl">                        &#39;value<span class="o">.</span><span class="n">getItem</span><span class="o">(</span><span class="s">&#34;geo&#34;</span><span class="o">).</span><span class="n">getItem</span><span class="o">(</span><span class="s">&#34;lat&#34;</span><span class="o">)</span> <span class="n">as</span> &#39;lat<span class="o">,</span>                <span class="c1">//note embedded level requires yet another level of fetching.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        &#39;value<span class="o">.</span><span class="n">getItem</span><span class="o">(</span><span class="s">&#34;geo&#34;</span><span class="o">).</span><span class="n">getItem</span><span class="o">(</span><span class="s">&#34;long&#34;</span><span class="o">)</span> <span class="n">as</span> &#39;lon<span class="o">)</span>
</span></span><span class="line"><span class="cl">                        <span class="o">.</span><span class="n">as</span><span class="o">[</span><span class="kt">DeviceAlert</span><span class="o">]</span>  <span class="c1">// return as a Dataset
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">defined</span> <span class="k">class</span> <span class="nc">DeviceAlert</span>
</span></span><span class="line"><span class="cl"><span class="n">notifydevicesDS</span><span class="k">:</span> <span class="kt">org.apache.spark.sql.Dataset</span><span class="o">[</span><span class="kt">DeviceAlert</span><span class="o">]</span> <span class="k">=</span> <span class="o">[</span><span class="kt">dcId:</span> <span class="kt">string</span>, <span class="kt">deviceType:</span> <span class="kt">string</span> <span class="kt">...</span> <span class="err">6</span> <span class="kt">more</span> <span class="kt">fields</span><span class="o">]</span>
</span></span></code></pre></div><pre tabindex="0"><code>notifydevicesDS.printSchema
root
 |-- dcId: string (nullable = true)
 |-- deviceType: string (nullable = false)
 |-- ip: string (nullable = true)
 |-- deviceId: long (nullable = true)
 |-- c02_level: long (nullable = true)
 |-- temp: long (nullable = true)
 |-- lat: double (nullable = true)
 |-- lon: double (nullable = true)
</code></pre><p>假设作为 ETL 的一部分，您需要根据某些警报条件通知或发送警报。一种方法是在迭代过滤数据集上编写用户功能并发送单独的通知。在其他情况下，您可以将消息作为附加选项发送到 Kafka 主题。
将嵌套的 JSON 分解为简单的 case 类之后，我们就可以向 NOC 发送警报以进行操作。在这方面是使用 <code>foreach()</code> DataFrame方法。但要做到这一点，我们需要一个高级功能;给定一个 case 类，它可以提取其警报属性来发出警报。虽然这个简单的示例写入 stdout，但在实际场景中，您需要通过 SNMP 或 HTTP POST 或某些 API 向 PagerAlert 发送警报。</p>
<h2 id="警报通知功能">警报通知功能&nbsp;<a class="headline-hash no-text-decoration" href="#警报通知功能">#</a> </h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-scala" data-lang="scala"><span class="line"><span class="cl"><span class="c1">// define a Scala Notification Object
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">object</span> <span class="nc">DeviceNOCAlerts</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">def</span> <span class="n">sendTwilio</span><span class="o">(</span><span class="n">message</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//TODO: fill as necessary
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">println</span><span class="o">(</span><span class="s">&#34;Twilio:&#34;</span> <span class="o">+</span> <span class="n">message</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">def</span> <span class="n">sendSNMP</span><span class="o">(</span><span class="n">message</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//TODO: fill as necessary
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">println</span><span class="o">(</span><span class="s">&#34;SNMP:&#34;</span> <span class="o">+</span> <span class="n">message</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  <span class="k">def</span> <span class="n">sendKafka</span><span class="o">(</span><span class="n">message</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//TODO: fill as necessary
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>     <span class="n">println</span><span class="o">(</span><span class="s">&#34;KAFKA:&#34;</span> <span class="o">+</span> <span class="n">message</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="n">logAlerts</span><span class="o">(</span><span class="n">log</span><span class="k">:</span> <span class="kt">java.io.PrintStream</span> <span class="o">=</span> <span class="nc">Console</span><span class="o">.</span><span class="n">out</span><span class="o">,</span> <span class="n">deviceAlert</span><span class="k">:</span> <span class="kt">DeviceAlert</span><span class="o">,</span> <span class="n">alert</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">notify</span><span class="k">:</span> <span class="kt">String</span> <span class="o">=</span><span class="s">&#34;twilio&#34;</span><span class="o">)</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl"><span class="k">val</span> <span class="n">message</span> <span class="k">=</span> <span class="s">&#34;[***ALERT***: %s; data_center: %s, device_name: %s, temperature: %d; device_id: %d ; ip: %s ; c02: %d]&#34;</span> <span class="n">format</span><span class="o">(</span><span class="n">alert</span><span class="o">,</span> <span class="n">deviceAlert</span><span class="o">.</span><span class="n">dcId</span><span class="o">,</span> <span class="n">deviceAlert</span><span class="o">.</span><span class="n">deviceType</span><span class="o">,</span><span class="n">deviceAlert</span><span class="o">.</span><span class="n">temp</span><span class="o">,</span> <span class="n">deviceAlert</span><span class="o">.</span><span class="n">deviceId</span><span class="o">,</span> <span class="n">deviceAlert</span><span class="o">.</span><span class="n">ip</span><span class="o">,</span> <span class="n">deviceAlert</span><span class="o">.</span><span class="n">c02_level</span><span class="o">)</span>                                                                                                                                                                                                                                                            
</span></span><span class="line"><span class="cl">  <span class="c1">//default log to Stderr/Stdout
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">log</span><span class="o">.</span><span class="n">println</span><span class="o">(</span><span class="n">message</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// use an appropriate notification method
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">val</span> <span class="n">notifyFunc</span> <span class="k">=</span> <span class="n">notify</span> <span class="k">match</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">case</span> <span class="s">&#34;twilio&#34;</span> <span class="k">=&gt;</span> <span class="nc">DeviceNOCAlerts</span><span class="o">.</span><span class="n">sendTwilio</span> <span class="k">_</span>
</span></span><span class="line"><span class="cl">      <span class="k">case</span> <span class="s">&#34;snmp&#34;</span> <span class="k">=&gt;</span> <span class="nc">DeviceNOCAlerts</span><span class="o">.</span><span class="n">sendSNMP</span> <span class="k">_</span>
</span></span><span class="line"><span class="cl">      <span class="k">case</span> <span class="s">&#34;kafka&#34;</span> <span class="k">=&gt;</span> <span class="nc">DeviceNOCAlerts</span><span class="o">.</span><span class="n">sendKafka</span> <span class="k">_</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//send the appropriate alert
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">notifyFunc</span><span class="o">(</span><span class="n">message</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="n">defined</span> <span class="k">object</span> <span class="nc">DeviceNOCAlerts</span>
</span></span><span class="line"><span class="cl"><span class="n">logAlerts</span><span class="k">:</span> <span class="o">(</span><span class="kt">log:</span> <span class="kt">java.io.PrintStream</span><span class="o">,</span> <span class="kt">deviceAlert:</span> <span class="kt">DeviceAlert</span><span class="o">,</span> <span class="n">alert</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">notify</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span><span class="nc">Unit</span>
</span></span></code></pre></div><h2 id="迭代警报设备并采取行动">迭代警报设备并采取行动&nbsp;<a class="headline-hash no-text-decoration" href="#迭代警报设备并采取行动">#</a> </h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-scala" data-lang="scala"><span class="line"><span class="cl"><span class="n">notifydevicesDS</span><span class="o">.</span><span class="n">foreach</span><span class="o">(</span><span class="n">d</span> <span class="k">=&gt;</span> <span class="n">logAlerts</span><span class="o">(</span><span class="nc">Console</span><span class="o">.</span><span class="n">err</span><span class="o">,</span> <span class="n">d</span><span class="o">,</span> <span class="s">&#34;ACTION NEED! HIGH TEPERATURE AND C02 LEVLES&#34;</span><span class="o">,</span> <span class="s">&#34;kafka&#34;</span><span class="o">))</span>
</span></span></code></pre></div><p>要查看消息的记录位置，请转到“<strong>集群</strong>” - &gt;“<strong>Spark</strong>” - &gt;“<strong>日志</strong>”。</p>
<h2 id="将警报作为-json-发送到-apache-kafka-主题">将警报作为 JSON 发送到 Apache Kafka 主题&nbsp;<a class="headline-hash no-text-decoration" href="#将警报作为-json-发送到-apache-kafka-主题">#</a> </h2>
<p>如果您想将这些设备的警报写入 Kafka 主题，监视订阅者正在等待事件采取行动，该怎么办？</p>
<p>这是一个关于 Kafka 主题的 nofity 监听器的简单方法：“device_alerts”。要进一步阅读如何使用 Apache Kafka 详细介绍 Structured Streaming，请阅读我们关于 Structure Streaming 的博客系列的第3部分。
注意：请参阅上面我们探讨的 <code>selectExpr()</code> 函数的另一种用法。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-scala" data-lang="scala"><span class="line"><span class="cl"><span class="k">val</span> <span class="n">deviceAlertQuery</span> <span class="k">=</span> <span class="n">notifydevicesDS</span>
</span></span><span class="line"><span class="cl">                       <span class="o">.</span><span class="n">selectExpr</span><span class="o">(</span><span class="s">&#34;CAST(dcId AS STRING) AS key&#34;</span><span class="o">,</span> <span class="s">&#34;to_json(struct(*)) AS value&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                       <span class="o">.</span><span class="n">writeStream</span>
</span></span><span class="line"><span class="cl">                       <span class="o">.</span><span class="n">format</span><span class="o">(</span><span class="s">&#34;kafka&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                       <span class="o">.</span><span class="n">option</span><span class="o">(</span><span class="s">&#34;kafka.bootstrap.servers&#34;</span><span class="o">,</span> <span class="s">&#34;host1:port1,host2:port2&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                       <span class="o">.</span><span class="n">option</span><span class="o">(</span><span class="s">&#34;toipic&#34;</span><span class="o">,</span> <span class="s">&#34;device_alerts&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                       <span class="o">.</span><span class="n">start</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">                       
</span></span><span class="line"><span class="cl"><span class="n">org</span><span class="o">.</span><span class="n">apache</span><span class="o">.</span><span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="o">.</span><span class="nc">AnalysisException</span><span class="k">:</span> <span class="kt">Undefined</span> <span class="kt">function:</span> <span class="err">&#39;</span><span class="kt">to_json</span><span class="err">&#39;</span><span class="kt">.</span> <span class="kt">This</span> <span class="kt">function</span> <span class="kt">is</span> <span class="kt">neither</span> <span class="kt">a</span> <span class="kt">registered</span> <span class="kt">temporary</span> <span class="kt">function</span> <span class="kt">nor</span> <span class="kt">a</span> <span class="kt">permanent</span> <span class="kt">function</span> <span class="kt">registered</span> <span class="kt">in</span> <span class="kt">the</span> <span class="kt">database</span> <span class="err">&#39;</span><span class="kt">default</span><span class="err">&#39;</span><span class="kt">.</span><span class="o">;</span> <span class="n">line</span> <span class="mi">1</span> <span class="n">pos</span> <span class="mi">0</span>
</span></span></code></pre></div><h2 id="嵌套的设备数据">嵌套的设备数据&nbsp;<a class="headline-hash no-text-decoration" href="#嵌套的设备数据">#</a> </h2>
<p>让我们看看 Nest 的读数中另一个复杂的现实数据。 Nest 设备向其收集器发出许多 JSON 事件。该收集器可以位于附近的数据中心，邻域中央数据收集器或聚合器，或者它可以是安装在家中的设备，其定期将设备读数发送到通过安全的互联网连接连接的中央数据中心。对于幻觉，我已经限制了一些属性，但它仍然显示了如何处理复杂数据 - 以及提取相关属性。</p>
<p>让我们先定义它复杂的模式。仔细观察，您会发现它与我们上面定义的模式没有什么不同，除了它不是一个  map 而是三个 map：恒温器，摄像头和烟雾警报器。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-scala" data-lang="scala"><span class="line"><span class="cl"><span class="k">import</span> <span class="nn">org.apache.spark.sql.types._</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// a bit longish, nested, and convuloted JSON schema :)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">val</span> <span class="n">nestSchema2</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">StructType</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">      <span class="o">.</span><span class="n">add</span><span class="o">(</span><span class="s">&#34;devices&#34;</span><span class="o">,</span> 
</span></span><span class="line"><span class="cl">        <span class="k">new</span> <span class="nc">StructType</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">          <span class="o">.</span><span class="n">add</span><span class="o">(</span><span class="s">&#34;thermostats&#34;</span><span class="o">,</span> <span class="nc">MapType</span><span class="o">(</span><span class="nc">StringType</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">            <span class="k">new</span> <span class="nc">StructType</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">              <span class="o">.</span><span class="n">add</span><span class="o">(</span><span class="s">&#34;device_id&#34;</span><span class="o">,</span> <span class="nc">StringType</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">              <span class="o">.</span><span class="n">add</span><span class="o">(</span><span class="s">&#34;locale&#34;</span><span class="o">,</span> <span class="nc">StringType</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">              <span class="o">.</span><span class="n">add</span><span class="o">(</span><span class="s">&#34;software_version&#34;</span><span class="o">,</span> <span class="nc">StringType</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">              <span class="o">.</span><span class="n">add</span><span class="o">(</span><span class="s">&#34;structure_id&#34;</span><span class="o">,</span> <span class="nc">StringType</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">              <span class="o">.</span><span class="n">add</span><span class="o">(</span><span class="s">&#34;where_name&#34;</span><span class="o">,</span> <span class="nc">StringType</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">              <span class="o">.</span><span class="n">add</span><span class="o">(</span><span class="s">&#34;last_connection&#34;</span><span class="o">,</span> <span class="nc">StringType</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">              <span class="o">.</span><span class="n">add</span><span class="o">(</span><span class="s">&#34;is_online&#34;</span><span class="o">,</span> <span class="nc">BooleanType</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">              <span class="o">.</span><span class="n">add</span><span class="o">(</span><span class="s">&#34;can_cool&#34;</span><span class="o">,</span> <span class="nc">BooleanType</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">              <span class="o">.</span><span class="n">add</span><span class="o">(</span><span class="s">&#34;can_heat&#34;</span><span class="o">,</span> <span class="nc">BooleanType</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">              <span class="o">.</span><span class="n">add</span><span class="o">(</span><span class="s">&#34;is_using_emergency_heat&#34;</span><span class="o">,</span> <span class="nc">BooleanType</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">              <span class="o">.</span><span class="n">add</span><span class="o">(</span><span class="s">&#34;has_fan&#34;</span><span class="o">,</span> <span class="nc">BooleanType</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">              <span class="o">.</span><span class="n">add</span><span class="o">(</span><span class="s">&#34;fan_timer_active&#34;</span><span class="o">,</span> <span class="nc">BooleanType</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">              <span class="o">.</span><span class="n">add</span><span class="o">(</span><span class="s">&#34;fan_timer_timeout&#34;</span><span class="o">,</span> <span class="nc">StringType</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">              <span class="o">.</span><span class="n">add</span><span class="o">(</span><span class="s">&#34;temperature_scale&#34;</span><span class="o">,</span> <span class="nc">StringType</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">              <span class="o">.</span><span class="n">add</span><span class="o">(</span><span class="s">&#34;target_temperature_f&#34;</span><span class="o">,</span> <span class="nc">DoubleType</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">              <span class="o">.</span><span class="n">add</span><span class="o">(</span><span class="s">&#34;target_temperature_high_f&#34;</span><span class="o">,</span> <span class="nc">DoubleType</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">              <span class="o">.</span><span class="n">add</span><span class="o">(</span><span class="s">&#34;target_temperature_low_f&#34;</span><span class="o">,</span> <span class="nc">DoubleType</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">              <span class="o">.</span><span class="n">add</span><span class="o">(</span><span class="s">&#34;eco_temperature_high_f&#34;</span><span class="o">,</span> <span class="nc">DoubleType</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">              <span class="o">.</span><span class="n">add</span><span class="o">(</span><span class="s">&#34;eco_temperature_low_f&#34;</span><span class="o">,</span> <span class="nc">DoubleType</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">              <span class="o">.</span><span class="n">add</span><span class="o">(</span><span class="s">&#34;away_temperature_high_f&#34;</span><span class="o">,</span> <span class="nc">DoubleType</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">              <span class="o">.</span><span class="n">add</span><span class="o">(</span><span class="s">&#34;away_temperature_low_f&#34;</span><span class="o">,</span> <span class="nc">DoubleType</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">              <span class="o">.</span><span class="n">add</span><span class="o">(</span><span class="s">&#34;hvac_mode&#34;</span><span class="o">,</span> <span class="nc">StringType</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">              <span class="o">.</span><span class="n">add</span><span class="o">(</span><span class="s">&#34;humidity&#34;</span><span class="o">,</span> <span class="nc">LongType</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">              <span class="o">.</span><span class="n">add</span><span class="o">(</span><span class="s">&#34;hvac_state&#34;</span><span class="o">,</span> <span class="nc">StringType</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">              <span class="o">.</span><span class="n">add</span><span class="o">(</span><span class="s">&#34;is_locked&#34;</span><span class="o">,</span> <span class="nc">StringType</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">              <span class="o">.</span><span class="n">add</span><span class="o">(</span><span class="s">&#34;locked_temp_min_f&#34;</span><span class="o">,</span> <span class="nc">DoubleType</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">              <span class="o">.</span><span class="n">add</span><span class="o">(</span><span class="s">&#34;locked_temp_max_f&#34;</span><span class="o">,</span> <span class="nc">DoubleType</span><span class="o">)))</span>
</span></span><span class="line"><span class="cl">           <span class="o">.</span><span class="n">add</span><span class="o">(</span><span class="s">&#34;smoke_co_alarms&#34;</span><span class="o">,</span> <span class="nc">MapType</span><span class="o">(</span><span class="nc">StringType</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">             <span class="k">new</span> <span class="nc">StructType</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">             <span class="o">.</span><span class="n">add</span><span class="o">(</span><span class="s">&#34;device_id&#34;</span><span class="o">,</span> <span class="nc">StringType</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">             <span class="o">.</span><span class="n">add</span><span class="o">(</span><span class="s">&#34;locale&#34;</span><span class="o">,</span> <span class="nc">StringType</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">             <span class="o">.</span><span class="n">add</span><span class="o">(</span><span class="s">&#34;software_version&#34;</span><span class="o">,</span> <span class="nc">StringType</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">             <span class="o">.</span><span class="n">add</span><span class="o">(</span><span class="s">&#34;structure_id&#34;</span><span class="o">,</span> <span class="nc">StringType</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">             <span class="o">.</span><span class="n">add</span><span class="o">(</span><span class="s">&#34;where_name&#34;</span><span class="o">,</span> <span class="nc">StringType</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">             <span class="o">.</span><span class="n">add</span><span class="o">(</span><span class="s">&#34;last_connection&#34;</span><span class="o">,</span> <span class="nc">StringType</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">             <span class="o">.</span><span class="n">add</span><span class="o">(</span><span class="s">&#34;is_online&#34;</span><span class="o">,</span> <span class="nc">BooleanType</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">             <span class="o">.</span><span class="n">add</span><span class="o">(</span><span class="s">&#34;battery_health&#34;</span><span class="o">,</span> <span class="nc">StringType</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">             <span class="o">.</span><span class="n">add</span><span class="o">(</span><span class="s">&#34;co_alarm_state&#34;</span><span class="o">,</span> <span class="nc">StringType</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">             <span class="o">.</span><span class="n">add</span><span class="o">(</span><span class="s">&#34;smoke_alarm_state&#34;</span><span class="o">,</span> <span class="nc">StringType</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">             <span class="o">.</span><span class="n">add</span><span class="o">(</span><span class="s">&#34;is_manual_test_active&#34;</span><span class="o">,</span> <span class="nc">BooleanType</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">             <span class="o">.</span><span class="n">add</span><span class="o">(</span><span class="s">&#34;last_manual_test_time&#34;</span><span class="o">,</span> <span class="nc">StringType</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">             <span class="o">.</span><span class="n">add</span><span class="o">(</span><span class="s">&#34;ui_color_state&#34;</span><span class="o">,</span> <span class="nc">StringType</span><span class="o">)))</span>
</span></span><span class="line"><span class="cl">           <span class="o">.</span><span class="n">add</span><span class="o">(</span><span class="s">&#34;cameras&#34;</span><span class="o">,</span> <span class="nc">MapType</span><span class="o">(</span><span class="nc">StringType</span><span class="o">,</span> 
</span></span><span class="line"><span class="cl">               <span class="k">new</span> <span class="nc">StructType</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="n">add</span><span class="o">(</span><span class="s">&#34;device_id&#34;</span><span class="o">,</span> <span class="nc">StringType</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="n">add</span><span class="o">(</span><span class="s">&#34;software_version&#34;</span><span class="o">,</span> <span class="nc">StringType</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="n">add</span><span class="o">(</span><span class="s">&#34;structure_id&#34;</span><span class="o">,</span> <span class="nc">StringType</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="n">add</span><span class="o">(</span><span class="s">&#34;where_name&#34;</span><span class="o">,</span> <span class="nc">StringType</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="n">add</span><span class="o">(</span><span class="s">&#34;is_online&#34;</span><span class="o">,</span> <span class="nc">BooleanType</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="n">add</span><span class="o">(</span><span class="s">&#34;is_streaming&#34;</span><span class="o">,</span> <span class="nc">BooleanType</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="n">add</span><span class="o">(</span><span class="s">&#34;is_audio_input_enabled&#34;</span><span class="o">,</span> <span class="nc">BooleanType</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="n">add</span><span class="o">(</span><span class="s">&#34;last_is_online_change&#34;</span><span class="o">,</span> <span class="nc">StringType</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="n">add</span><span class="o">(</span><span class="s">&#34;is_video_history_enabled&#34;</span><span class="o">,</span> <span class="nc">BooleanType</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="n">add</span><span class="o">(</span><span class="s">&#34;web_url&#34;</span><span class="o">,</span> <span class="nc">StringType</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="n">add</span><span class="o">(</span><span class="s">&#34;app_url&#34;</span><span class="o">,</span> <span class="nc">StringType</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="n">add</span><span class="o">(</span><span class="s">&#34;is_public_share_enabled&#34;</span><span class="o">,</span> <span class="nc">BooleanType</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="n">add</span><span class="o">(</span><span class="s">&#34;activity_zones&#34;</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                  <span class="k">new</span> <span class="nc">StructType</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">                    <span class="o">.</span><span class="n">add</span><span class="o">(</span><span class="s">&#34;name&#34;</span><span class="o">,</span> <span class="nc">StringType</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                    <span class="o">.</span><span class="n">add</span><span class="o">(</span><span class="s">&#34;id&#34;</span><span class="o">,</span> <span class="nc">LongType</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="n">add</span><span class="o">(</span><span class="s">&#34;last_event&#34;</span><span class="o">,</span> <span class="nc">StringType</span><span class="o">))))</span>
</span></span><span class="line"><span class="cl"><span class="k">import</span> <span class="nn">org.apache.spark.sql.types._</span>
</span></span><span class="line"><span class="cl"><span class="n">nestSchema2</span><span class="k">:</span> <span class="kt">org.apache.spark.sql.</span><span class="k">type</span><span class="kt">s.StructType</span> <span class="o">=</span> <span class="nc">StructType</span><span class="o">(</span><span class="nc">StructField</span><span class="o">(</span><span class="n">devices</span><span class="o">,</span><span class="nc">StructType</span><span class="o">(</span><span class="nc">StructField</span><span class="o">(</span><span class="n">thermostats</span><span class="o">,</span><span class="nc">MapType</span><span class="o">(</span><span class="nc">StringType</span><span class="o">,</span><span class="nc">StructType</span><span class="o">(</span><span class="nc">StructField</span><span class="o">(</span><span class="n">device_id</span><span class="o">,</span><span class="nc">StringType</span><span class="o">,</span><span class="kc">true</span><span class="o">),</span> <span class="nc">StructField</span><span class="o">(</span><span class="n">locale</span><span class="o">,</span><span class="nc">StringType</span><span class="o">,</span><span class="kc">true</span><span class="o">),</span> <span class="nc">StructField</span><span class="o">(</span><span class="n">software_version</span><span class="o">,</span><span class="nc">StringType</span><span class="o">,</span><span class="kc">true</span><span class="o">),</span> <span class="nc">StructField</span><span class="o">(</span><span class="n">structure_id</span><span class="o">,</span><span class="nc">StringType</span><span class="o">,</span><span class="kc">true</span><span class="o">),</span> <span class="nc">StructField</span><span class="o">(</span><span class="n">where_name</span><span class="o">,</span><span class="nc">StringType</span><span class="o">,</span><span class="kc">true</span><span class="o">),</span> <span class="nc">StructField</span><span class="o">(</span><span class="n">last_connection</span><span class="o">,</span><span class="nc">StringType</span><span class="o">,</span><span class="kc">true</span><span class="o">),</span> <span class="nc">StructField</span><span class="o">(</span><span class="n">is_online</span><span class="o">,</span><span class="nc">BooleanType</span><span class="o">,</span><span class="kc">true</span><span class="o">),</span> <span class="nc">StructField</span><span class="o">(</span><span class="n">can_cool</span><span class="o">,</span><span class="nc">BooleanType</span><span class="o">,</span><span class="kc">true</span><span class="o">),</span> <span class="nc">StructField</span><span class="o">(</span><span class="n">can_heat</span><span class="o">,</span><span class="nc">BooleanType</span><span class="o">,</span><span class="kc">true</span><span class="o">),</span> <span class="nc">StructField</span><span class="o">(</span><span class="n">is_using_emergency_heat</span><span class="o">,</span><span class="nc">BooleanType</span><span class="o">,</span><span class="kc">true</span><span class="o">),</span> <span class="nc">StructField</span><span class="o">(</span><span class="n">has_fan</span><span class="o">,</span><span class="nc">BooleanType</span><span class="o">,</span><span class="kc">true</span><span class="o">),</span> <span class="nc">StructField</span><span class="o">(</span><span class="n">fan_timer_active</span><span class="o">,</span><span class="nc">BooleanType</span><span class="o">,</span><span class="kc">true</span><span class="o">),</span> <span class="nc">StructField</span><span class="o">(</span><span class="n">fan_timer_timeout</span><span class="o">,</span><span class="nc">StringType</span><span class="o">,</span><span class="kc">true</span><span class="o">),</span> <span class="nc">StructField</span><span class="o">(</span><span class="n">temperature_scale</span><span class="o">,</span><span class="nc">StringType</span><span class="o">,</span><span class="kc">true</span><span class="o">),</span> <span class="nc">StructField</span><span class="o">(</span><span class="n">target_temperature_f</span><span class="o">,</span><span class="nc">DoubleType</span><span class="o">,</span><span class="kc">true</span><span class="o">),</span> <span class="nc">StructField</span><span class="o">(</span><span class="n">target_temperature_high_f</span><span class="o">,</span><span class="nc">DoubleType</span><span class="o">,</span><span class="kc">true</span><span class="o">),</span> <span class="nc">StructField</span><span class="o">(</span><span class="n">target_temperature_low_f</span><span class="o">,</span><span class="nc">DoubleType</span><span class="o">,</span><span class="kc">true</span><span class="o">),</span> <span class="nc">StructField</span><span class="o">(</span><span class="n">eco_temperature_high_f</span><span class="o">,</span><span class="nc">DoubleType</span><span class="o">,</span><span class="kc">true</span><span class="o">),</span> <span class="nc">StructField</span><span class="o">(</span><span class="n">eco_temperature_low_f</span><span class="o">,</span><span class="nc">DoubleType</span><span class="o">,</span><span class="kc">true</span><span class="o">),</span> <span class="nc">StructField</span><span class="o">(</span><span class="n">away_temperature_high_f</span><span class="o">,</span><span class="nc">DoubleType</span><span class="o">,</span><span class="kc">true</span><span class="o">),</span> <span class="nc">StructField</span><span class="o">(</span><span class="n">away_temperature_low_f</span><span class="o">,</span><span class="nc">DoubleType</span><span class="o">,</span><span class="kc">true</span><span class="o">),</span> <span class="nc">StructField</span><span class="o">(</span><span class="n">hvac_mode</span><span class="o">,</span><span class="nc">StringType</span><span class="o">,</span><span class="kc">true</span><span class="o">),</span> <span class="nc">StructField</span><span class="o">(</span><span class="n">humidity</span><span class="o">,</span><span class="nc">LongType</span><span class="o">,</span><span class="kc">true</span><span class="o">),</span> <span class="nc">StructField</span><span class="o">(</span><span class="n">hvac_state</span><span class="o">,</span><span class="nc">StringType</span><span class="o">,</span><span class="kc">true</span><span class="o">),</span> <span class="nc">StructField</span><span class="o">(</span><span class="n">is_locked</span><span class="o">,</span><span class="nc">StringType</span><span class="o">,</span><span class="kc">true</span><span class="o">),</span> <span class="nc">StructField</span><span class="o">(</span><span class="n">locked_temp_min_f</span><span class="o">,</span><span class="nc">DoubleType</span><span class="o">,</span><span class="kc">true</span><span class="o">),</span> <span class="nc">StructField</span><span class="o">(</span><span class="n">locked_temp_max_f</span><span class="o">,</span><span class="nc">DoubleType</span><span class="o">,</span><span class="kc">true</span><span class="o">)),</span><span class="kc">true</span><span class="o">),</span><span class="kc">true</span><span class="o">),</span> <span class="nc">StructField</span><span class="o">(</span><span class="n">smoke_co_alarms</span><span class="o">,</span><span class="nc">MapType</span><span class="o">(</span><span class="nc">StringType</span><span class="o">,</span><span class="nc">StructType</span><span class="o">(</span><span class="nc">StructField</span><span class="o">(</span><span class="n">device_id</span><span class="o">,</span><span class="nc">StringType</span><span class="o">,</span><span class="kc">true</span><span class="o">),</span> <span class="nc">StructField</span><span class="o">(</span><span class="n">locale</span><span class="o">,</span><span class="nc">StringType</span><span class="o">,</span><span class="kc">true</span><span class="o">),</span> <span class="nc">StructField</span><span class="o">(</span><span class="n">software_version</span><span class="o">,</span><span class="nc">StringType</span><span class="o">,</span><span class="kc">true</span><span class="o">),</span> <span class="nc">StructField</span><span class="o">(</span><span class="n">structure_id</span><span class="o">,</span><span class="nc">StringType</span><span class="o">,</span><span class="kc">true</span><span class="o">),</span> <span class="nc">StructField</span><span class="o">(</span><span class="n">where_name</span><span class="o">,</span><span class="nc">StringType</span><span class="o">,</span><span class="kc">true</span><span class="o">),</span> <span class="nc">StructField</span><span class="o">(</span><span class="n">last_connection</span><span class="o">,</span><span class="nc">StringType</span><span class="o">,</span><span class="kc">true</span><span class="o">),</span> <span class="nc">StructField</span><span class="o">(</span><span class="n">is_online</span><span class="o">,</span><span class="nc">BooleanType</span><span class="o">,</span><span class="kc">true</span><span class="o">),</span> <span class="nc">StructField</span><span class="o">(</span><span class="n">battery_health</span><span class="o">,</span><span class="nc">StringType</span><span class="o">,</span><span class="kc">true</span><span class="o">),</span> <span class="nc">StructField</span><span class="o">(</span><span class="n">co_alarm_state</span><span class="o">,</span><span class="nc">StringType</span><span class="o">,</span><span class="kc">true</span><span class="o">),</span> <span class="nc">StructField</span><span class="o">(</span><span class="n">smoke_alarm_state</span><span class="o">,</span><span class="nc">StringType</span><span class="o">,</span><span class="kc">true</span><span class="o">),</span> <span class="nc">StructField</span><span class="o">(</span><span class="n">is_manual_test_active</span><span class="o">,</span><span class="nc">BooleanType</span><span class="o">,</span><span class="kc">true</span><span class="o">),</span> <span class="nc">StructField</span><span class="o">(</span><span class="n">last_manual_test_time</span><span class="o">,</span><span class="nc">StringType</span><span class="o">,</span><span class="kc">true</span><span class="o">),</span> <span class="nc">StructField</span><span class="o">(</span><span class="n">ui_color_state</span><span class="o">,</span><span class="nc">StringType</span><span class="o">,</span><span class="kc">true</span><span class="o">)),</span><span class="kc">true</span><span class="o">),</span><span class="kc">true</span><span class="o">),</span> <span class="nc">StructField</span><span class="o">(</span><span class="n">cameras</span><span class="o">,</span><span class="nc">MapType</span><span class="o">(</span><span class="nc">StringType</span><span class="o">,</span><span class="nc">StructType</span><span class="o">(</span><span class="nc">StructField</span><span class="o">(</span><span class="n">device_id</span><span class="o">,</span><span class="nc">StringType</span><span class="o">,</span><span class="kc">true</span><span class="o">),</span> <span class="nc">StructField</span><span class="o">(</span><span class="n">software_version</span><span class="o">,</span><span class="nc">StringType</span><span class="o">,</span><span class="kc">true</span><span class="o">),</span> <span class="nc">StructField</span><span class="o">(</span><span class="n">structure_id</span><span class="o">,</span><span class="nc">StringType</span><span class="o">,</span><span class="kc">true</span><span class="o">),</span> <span class="nc">StructField</span><span class="o">(</span><span class="n">where_name</span><span class="o">,</span><span class="nc">StringType</span><span class="o">,</span><span class="kc">true</span><span class="o">),</span> <span class="nc">StructField</span><span class="o">(</span><span class="n">is_online</span><span class="o">,</span><span class="nc">BooleanType</span><span class="o">,</span><span class="kc">true</span><span class="o">),</span> <span class="nc">StructField</span><span class="o">(</span><span class="n">is_streaming</span><span class="o">,</span><span class="nc">BooleanType</span><span class="o">,</span><span class="kc">true</span><span class="o">),</span> <span class="nc">StructField</span><span class="o">(</span><span class="n">is_audio_input_enabled</span><span class="o">,</span><span class="nc">BooleanType</span><span class="o">,</span><span class="kc">true</span><span class="o">),</span> <span class="nc">StructField</span><span class="o">(</span><span class="n">last_is_online_change</span><span class="o">,</span><span class="nc">StringType</span><span class="o">,</span><span class="kc">true</span><span class="o">),</span> <span class="nc">StructField</span><span class="o">(</span><span class="n">is_video_history_enabled</span><span class="o">,</span><span class="nc">BooleanType</span><span class="o">,</span><span class="kc">true</span><span class="o">),</span> <span class="nc">StructField</span><span class="o">(</span><span class="n">web_url</span><span class="o">,</span><span class="nc">StringType</span><span class="o">,</span><span class="kc">true</span><span class="o">),</span> <span class="nc">StructField</span><span class="o">(</span><span class="n">app_url</span><span class="o">,</span><span class="nc">StringType</span><span class="o">,</span><span class="kc">true</span><span class="o">),</span> <span class="nc">StructField</span><span class="o">(</span><span class="n">is_public_share_enabled</span><span class="o">,</span><span class="nc">BooleanType</span><span class="o">,</span><span class="kc">true</span><span class="o">),</span> <span class="nc">StructField</span><span class="o">(</span><span class="n">activity_zones</span><span class="o">,</span><span class="nc">StructType</span><span class="o">(</span><span class="nc">StructField</span><span class="o">(</span><span class="n">name</span><span class="o">,</span><span class="nc">StringType</span><span class="o">,</span><span class="kc">true</span><span class="o">),</span> <span class="nc">StructField</span><span class="o">(</span><span class="n">id</span><span class="o">,</span><span class="nc">LongType</span><span class="o">,</span><span class="kc">true</span><span class="o">)),</span><span class="kc">true</span><span class="o">),</span> <span class="nc">StructField</span><span class="o">(</span><span class="n">last_event</span><span class="o">,</span><span class="nc">StringType</span><span class="o">,</span><span class="kc">true</span><span class="o">)),</span><span class="kc">true</span><span class="o">),</span><span class="kc">true</span><span class="o">)),</span><span class="kc">true</span><span class="o">))</span>
</span></span></code></pre></div><p>通过创建一个简单的数据集，您可以使用所有数据集方法来执行 ETL，使用上面的实用程序函数：<code>from_json()</code>，<code>to_json()</code>，<code>explode()</code> 和 <code>selectExpr()</code>。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-scala" data-lang="scala"><span class="line"><span class="cl"><span class="k">val</span> <span class="n">nestDataDS2</span> <span class="k">=</span> <span class="nc">Seq</span><span class="o">(</span><span class="s">&#34;&#34;&#34;{
</span></span></span><span class="line"><span class="cl"><span class="s">    &#34;devices&#34;: {
</span></span></span><span class="line"><span class="cl"><span class="s">       &#34;thermostats&#34;: {
</span></span></span><span class="line"><span class="cl"><span class="s">          &#34;peyiJNo0IldT2YlIVtYaGQ&#34;: {
</span></span></span><span class="line"><span class="cl"><span class="s">            &#34;device_id&#34;: &#34;peyiJNo0IldT2YlIVtYaGQ&#34;,
</span></span></span><span class="line"><span class="cl"><span class="s">            &#34;locale&#34;: &#34;en-US&#34;,
</span></span></span><span class="line"><span class="cl"><span class="s">            &#34;software_version&#34;: &#34;4.0&#34;,
</span></span></span><span class="line"><span class="cl"><span class="s">            &#34;structure_id&#34;: &#34;VqFabWH21nwVyd4RWgJgNb292wa7hG_dUwo2i2SG7j3-BOLY0BA4sw&#34;,
</span></span></span><span class="line"><span class="cl"><span class="s">            &#34;where_name&#34;: &#34;Hallway Upstairs&#34;,
</span></span></span><span class="line"><span class="cl"><span class="s">            &#34;last_connection&#34;: &#34;2016-10-31T23:59:59.000Z&#34;,
</span></span></span><span class="line"><span class="cl"><span class="s">            &#34;is_online&#34;: true,
</span></span></span><span class="line"><span class="cl"><span class="s">            &#34;can_cool&#34;: true,
</span></span></span><span class="line"><span class="cl"><span class="s">            &#34;can_heat&#34;: true,
</span></span></span><span class="line"><span class="cl"><span class="s">            &#34;is_using_emergency_heat&#34;: true,
</span></span></span><span class="line"><span class="cl"><span class="s">            &#34;has_fan&#34;: true,
</span></span></span><span class="line"><span class="cl"><span class="s">            &#34;fan_timer_active&#34;: true,
</span></span></span><span class="line"><span class="cl"><span class="s">            &#34;fan_timer_timeout&#34;: &#34;2016-10-31T23:59:59.000Z&#34;,
</span></span></span><span class="line"><span class="cl"><span class="s">            &#34;temperature_scale&#34;: &#34;F&#34;,
</span></span></span><span class="line"><span class="cl"><span class="s">            &#34;target_temperature_f&#34;: 72,
</span></span></span><span class="line"><span class="cl"><span class="s">            &#34;target_temperature_high_f&#34;: 80,
</span></span></span><span class="line"><span class="cl"><span class="s">            &#34;target_temperature_low_f&#34;: 65,
</span></span></span><span class="line"><span class="cl"><span class="s">            &#34;eco_temperature_high_f&#34;: 80,
</span></span></span><span class="line"><span class="cl"><span class="s">            &#34;eco_temperature_low_f&#34;: 65,
</span></span></span><span class="line"><span class="cl"><span class="s">            &#34;away_temperature_high_f&#34;: 80,
</span></span></span><span class="line"><span class="cl"><span class="s">            &#34;away_temperature_low_f&#34;: 65,
</span></span></span><span class="line"><span class="cl"><span class="s">            &#34;hvac_mode&#34;: &#34;heat&#34;,
</span></span></span><span class="line"><span class="cl"><span class="s">            &#34;humidity&#34;: 40,
</span></span></span><span class="line"><span class="cl"><span class="s">            &#34;hvac_state&#34;: &#34;heating&#34;,
</span></span></span><span class="line"><span class="cl"><span class="s">            &#34;is_locked&#34;: true,
</span></span></span><span class="line"><span class="cl"><span class="s">            &#34;locked_temp_min_f&#34;: 65,
</span></span></span><span class="line"><span class="cl"><span class="s">            &#34;locked_temp_max_f&#34;: 80
</span></span></span><span class="line"><span class="cl"><span class="s">            }
</span></span></span><span class="line"><span class="cl"><span class="s">          },
</span></span></span><span class="line"><span class="cl"><span class="s">          &#34;smoke_co_alarms&#34;: {
</span></span></span><span class="line"><span class="cl"><span class="s">            &#34;RTMTKxsQTCxzVcsySOHPxKoF4OyCifrs&#34;: {
</span></span></span><span class="line"><span class="cl"><span class="s">              &#34;device_id&#34;: &#34;RTMTKxsQTCxzVcsySOHPxKoF4OyCifrs&#34;,
</span></span></span><span class="line"><span class="cl"><span class="s">              &#34;locale&#34;: &#34;en-US&#34;,
</span></span></span><span class="line"><span class="cl"><span class="s">              &#34;software_version&#34;: &#34;1.01&#34;,
</span></span></span><span class="line"><span class="cl"><span class="s">              &#34;structure_id&#34;: &#34;VqFabWH21nwVyd4RWgJgNb292wa7hG_dUwo2i2SG7j3-BOLY0BA4sw&#34;,
</span></span></span><span class="line"><span class="cl"><span class="s">              &#34;where_name&#34;: &#34;Jane&#39;s Room&#34;,
</span></span></span><span class="line"><span class="cl"><span class="s">              &#34;last_connection&#34;: &#34;2016-10-31T23:59:59.000Z&#34;,
</span></span></span><span class="line"><span class="cl"><span class="s">              &#34;is_online&#34;: true,
</span></span></span><span class="line"><span class="cl"><span class="s">              &#34;battery_health&#34;: &#34;ok&#34;,
</span></span></span><span class="line"><span class="cl"><span class="s">              &#34;co_alarm_state&#34;: &#34;ok&#34;,
</span></span></span><span class="line"><span class="cl"><span class="s">              &#34;smoke_alarm_state&#34;: &#34;ok&#34;,
</span></span></span><span class="line"><span class="cl"><span class="s">              &#34;is_manual_test_active&#34;: true,
</span></span></span><span class="line"><span class="cl"><span class="s">              &#34;last_manual_test_time&#34;: &#34;2016-10-31T23:59:59.000Z&#34;,
</span></span></span><span class="line"><span class="cl"><span class="s">              &#34;ui_color_state&#34;: &#34;gray&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">              }
</span></span></span><span class="line"><span class="cl"><span class="s">            },
</span></span></span><span class="line"><span class="cl"><span class="s">         &#34;cameras&#34;: {
</span></span></span><span class="line"><span class="cl"><span class="s">          &#34;awJo6rH0IldT2YlIVtYaGQ&#34;: {
</span></span></span><span class="line"><span class="cl"><span class="s">            &#34;device_id&#34;: &#34;awJo6rH&#34;,
</span></span></span><span class="line"><span class="cl"><span class="s">            &#34;software_version&#34;: &#34;4.0&#34;,
</span></span></span><span class="line"><span class="cl"><span class="s">            &#34;structure_id&#34;: &#34;VqFabWH21nwVyd4RWgJgNb292wa7hG_dUwo2i2SG7j3-BOLY0BA4sw&#34;,
</span></span></span><span class="line"><span class="cl"><span class="s">            &#34;where_name&#34;: &#34;Foyer&#34;,
</span></span></span><span class="line"><span class="cl"><span class="s">            &#34;is_online&#34;: true,
</span></span></span><span class="line"><span class="cl"><span class="s">            &#34;is_streaming&#34;: true,
</span></span></span><span class="line"><span class="cl"><span class="s">            &#34;is_audio_input_enabled&#34;: true,
</span></span></span><span class="line"><span class="cl"><span class="s">            &#34;last_is_online_change&#34;: &#34;2016-12-29T18:42:00.000Z&#34;,
</span></span></span><span class="line"><span class="cl"><span class="s">            &#34;is_video_history_enabled&#34;: true,
</span></span></span><span class="line"><span class="cl"><span class="s">            &#34;web_url&#34;: &#34;https://home.nest.com/cameras/device_id?auth=access_token&#34;,
</span></span></span><span class="line"><span class="cl"><span class="s">            &#34;app_url&#34;: &#34;nestmobile://cameras/device_id?auth=access_token&#34;,
</span></span></span><span class="line"><span class="cl"><span class="s">            &#34;is_public_share_enabled&#34;: true,
</span></span></span><span class="line"><span class="cl"><span class="s">            &#34;activity_zones&#34;: { &#34;name&#34;: &#34;Walkway&#34;, &#34;id&#34;: 244083 },
</span></span></span><span class="line"><span class="cl"><span class="s">            &#34;last_event&#34;: &#34;2016-10-31T23:59:59.000Z&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">            }
</span></span></span><span class="line"><span class="cl"><span class="s">          }
</span></span></span><span class="line"><span class="cl"><span class="s">        }
</span></span></span><span class="line"><span class="cl"><span class="s">       }&#34;&#34;&#34;</span><span class="o">).</span><span class="n">toDS</span>
</span></span><span class="line"><span class="cl"><span class="n">nestDataDS2</span><span class="k">:</span> <span class="kt">org.apache.spark.sql.Dataset</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="k">=</span> <span class="o">[</span><span class="kt">value:</span> <span class="kt">string</span><span class="o">]</span>
</span></span></code></pre></div><p>让我们从这个单一的嵌套结构创建一个 DataFrame，并使用上述所有实用程序函数来处理和提取相关属性</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-scala" data-lang="scala"><span class="line"><span class="cl"><span class="k">val</span> <span class="n">nestDF2</span> <span class="k">=</span> <span class="n">spark</span>                            <span class="c1">// spark session 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="o">.</span><span class="n">read</span>                             <span class="c1">//  get DataFrameReader
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="o">.</span><span class="n">schema</span><span class="o">(</span><span class="n">nestSchema2</span><span class="o">)</span>             <span class="c1">//  use the defined schema above and read format as JSON
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="o">.</span><span class="n">json</span><span class="o">(</span><span class="n">nestDataDS2</span><span class="o">.</span><span class="n">rdd</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="n">nestDF2</span><span class="k">:</span> <span class="kt">org.apache.spark.sql.DataFrame</span> <span class="o">=</span> <span class="o">[</span><span class="kt">devices:</span> <span class="kt">struct&lt;thermostats:</span> <span class="kt">map&lt;string</span>,<span class="kt">struct&lt;device_id:string</span>,<span class="kt">locale:string</span>,<span class="kt">software_version:string</span>,<span class="kt">structure_id:string</span>,<span class="kt">where_name:string</span>,<span class="kt">last_connection:string</span>,<span class="kt">is_online:boolean</span>,<span class="kt">can_cool:boolean</span>,<span class="kt">can_heat:boolean</span>,<span class="kt">is_using_emergency_heat:boolean</span>,<span class="kt">has_fan:boolean</span>,<span class="kt">fan_timer_active:boolean</span>,<span class="kt">fan_timer_timeout:string</span>,<span class="kt">temperature_scale:string</span>,<span class="kt">target_temperature_f:double</span>,<span class="kt">target_temperature_high_f:double</span>,<span class="kt">target_temperature_low_f:double</span>,<span class="kt">eco_temperature_high_f:double</span>,<span class="kt">eco_temperature_low_f:double</span>,<span class="kt">away_temperature_high_f:double</span>,<span class="kt">away_temperature_low_f:double</span>,<span class="kt">hvac_mode:string</span>,<span class="kt">humidity:bigint</span>,<span class="kt">hvac_state:string</span>,<span class="kt">...</span> <span class="err">3</span> <span class="kt">more</span> <span class="kt">fields&gt;&gt;</span>, <span class="kt">smoke_co_alarms:</span> <span class="kt">map&lt;string</span>,<span class="kt">struct&lt;device_id:string</span>,<span class="kt">locale:string</span>,<span class="kt">software_version:string</span>,<span class="kt">structure_id:string</span>,<span class="kt">where_name:string</span>,<span class="kt">last_connection:string</span>,<span class="kt">is_online:boolean</span>,<span class="kt">battery_health:string</span>,<span class="kt">co_alarm_state:string</span>,<span class="kt">smoke_alarm_state:string</span>,<span class="kt">is_manual_test_active:boolean</span>,<span class="kt">last_manual_test_time:string</span>,<span class="kt">ui_color_state:string&gt;&gt;</span> <span class="kt">...</span> <span class="err">1</span> <span class="kt">more</span> <span class="kt">field&gt;</span><span class="o">]</span>
</span></span></code></pre></div><pre tabindex="0"><code>{&#34;thermostats&#34;:{&#34;peyiJNo0IldT2YlIVtYaGQ&#34;:{&#34;device_id&#34;:&#34;peyiJNo0IldT2YlIVtYaGQ&#34;,&#34;locale&#34;:&#34;en-US&#34;,&#34;software_version&#34;:&#34;4.0&#34;,&#34;structure_id&#34;:&#34;VqFabWH21nwVyd4RWgJgNb292wa7hG_dUwo2i2SG7j3-BOLY0BA4sw&#34;,&#34;where_name&#34;:&#34;Hallway Upstairs&#34;,&#34;last_connection&#34;:&#34;2016-10-31T23:59:59.000Z&#34;,&#34;is_online&#34;:true,&#34;can_cool&#34;:true,&#34;can_heat&#34;:true,&#34;is_using_emergency_heat&#34;:true,&#34;has_fan&#34;:true,&#34;fan_timer_active&#34;:true,&#34;fan_timer_timeout&#34;:&#34;2016-10-31T23:59:59.000Z&#34;,&#34;temperature_scale&#34;:&#34;F&#34;,&#34;target_temperature_f&#34;:72,&#34;target_temperature_high_f&#34;:80,&#34;target_temperature_low_f&#34;:65,&#34;eco_temperature_high_f&#34;:80,&#34;eco_temperature_low_f&#34;:65,&#34;away_temperature_high_f&#34;:80,&#34;away_temperature_low_f&#34;:65,&#34;hvac_mode&#34;:&#34;heat&#34;,&#34;humidity&#34;:&#34;40&#34;,&#34;hvac_state&#34;:&#34;heating&#34;,&#34;is_locked&#34;:&#34;true&#34;,&#34;locked_temp_min_f&#34;:65,&#34;locked_temp_max_f&#34;:80}},&#34;smoke_co_alarms&#34;:{&#34;RTMTKxsQTCxzVcsySOHPxKoF4OyCifrs&#34;:{&#34;device_id&#34;:&#34;RTMTKxsQTCxzVcsySOHPxKoF4OyCifrs&#34;,&#34;locale&#34;:&#34;en-US&#34;,&#34;software_version&#34;:&#34;1.01&#34;,&#34;structure_id&#34;:&#34;VqFabWH21nwVyd4RWgJgNb292wa7hG_dUwo2i2SG7j3-BOLY0BA4sw&#34;,&#34;where_name&#34;:&#34;Jane&#39;s Room&#34;,&#34;last_connection&#34;:&#34;2016-10-31T23:59:59.000Z&#34;,&#34;is_online&#34;:true,&#34;battery_health&#34;:&#34;ok&#34;,&#34;co_alarm_state&#34;:&#34;ok&#34;,&#34;smoke_alarm_state&#34;:&#34;ok&#34;,&#34;is_manual_test_active&#34;:true,&#34;last_manual_test_time&#34;:&#34;2016-10-31T23:59:59.000Z&#34;,&#34;ui_color_state&#34;:&#34;gray&#34;}},&#34;cameras&#34;:{&#34;awJo6rH0IldT2YlIVtYaGQ&#34;:{&#34;device_id&#34;:&#34;awJo6rH&#34;,&#34;software_version&#34;:&#34;4.0&#34;,&#34;structure_id&#34;:&#34;VqFabWH21nwVyd4RWgJgNb292wa7hG_dUwo2i2SG7j3-BOLY0BA4sw&#34;,&#34;where_name&#34;:&#34;Foyer&#34;,&#34;is_online&#34;:true,&#34;is_streaming&#34;:true,&#34;is_audio_input_enabled&#34;:true,&#34;last_is_online_change&#34;:&#34;2016-12-29T18:42:00.000Z&#34;,&#34;is_video_history_enabled&#34;:true,&#34;web_url&#34;:&#34;https://home.nest.com/cameras/device_id?auth=access_token&#34;,&#34;app_url&#34;:&#34;nestmobile://cameras/device_id?auth=access_token&#34;,&#34;is_public_share_enabled&#34;:true,&#34;activity_zones&#34;:{&#34;name&#34;:&#34;Walkway&#34;,&#34;id&#34;:&#34;244083&#34;},&#34;last_event&#34;:&#34;2016-10-31T23:59:59.000Z&#34;}}}
</code></pre><p>如上所述将上面的整个 JSON 对象转换为 JSON 字符串。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-scala" data-lang="scala"><span class="line"><span class="cl"><span class="k">val</span> <span class="n">stringJsonDF</span> <span class="k">=</span> <span class="n">nestDF2</span><span class="o">.</span><span class="n">select</span><span class="o">(</span><span class="n">to_json</span><span class="o">(</span><span class="n">struct</span><span class="o">(</span><span class="n">$</span><span class="s">&#34;*&#34;</span><span class="o">))).</span><span class="n">toDF</span><span class="o">(</span><span class="s">&#34;nestDevice&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="n">stringJsonDF</span><span class="k">:</span> <span class="kt">org.apache.spark.sql.DataFrame</span> <span class="o">=</span> <span class="o">[</span><span class="kt">nestDevice:</span> <span class="kt">string</span><span class="o">]</span>
</span></span></code></pre></div><pre tabindex="0"><code>stringJsonDF.printSchema
root
 |-- nestDevice: string (nullable = true)
</code></pre><pre tabindex="0"><code>display(stringJsonDF)
{&#34;devices&#34;:{&#34;thermostats&#34;:{&#34;peyiJNo0IldT2YlIVtYaGQ&#34;:{&#34;device_id&#34;:&#34;peyiJNo0IldT2YlIVtYaGQ&#34;,&#34;locale&#34;:&#34;en-US&#34;,&#34;software_version&#34;:&#34;4.0&#34;,&#34;structure_id&#34;:&#34;VqFabWH21nwVyd4RWgJgNb292wa7hG_dUwo2i2SG7j3-BOLY0BA4sw&#34;,&#34;where_name&#34;:&#34;Hallway Upstairs&#34;,&#34;last_connection&#34;:&#34;2016-10-31T23:59:59.000Z&#34;,&#34;is_online&#34;:true,&#34;can_cool&#34;:true,&#34;can_heat&#34;:true,&#34;is_using_emergency_heat&#34;:true,&#34;has_fan&#34;:true,&#34;fan_timer_active&#34;:true,&#34;fan_timer_timeout&#34;:&#34;2016-10-31T23:59:59.000Z&#34;,&#34;temperature_scale&#34;:&#34;F&#34;,&#34;target_temperature_f&#34;:72.0,&#34;target_temperature_high_f&#34;:80.0,&#34;target_temperature_low_f&#34;:65.0,&#34;eco_temperature_high_f&#34;:80.0,&#34;eco_temperature_low_f&#34;:65.0,&#34;away_temperature_high_f&#34;:80.0,&#34;away_temperature_low_f&#34;:65.0,&#34;hvac_mode&#34;:&#34;heat&#34;,&#34;humidity&#34;:40,&#34;hvac_state&#34;:&#34;heating&#34;,&#34;is_locked&#34;:&#34;true&#34;,&#34;locked_temp_min_f&#34;:65.0,&#34;locked_temp_max_f&#34;:80.0}},&#34;smoke_co_alarms&#34;:{&#34;RTMTKxsQTCxzVcsySOHPxKoF4OyCifrs&#34;:{&#34;device_id&#34;:&#34;RTMTKxsQTCxzVcsySOHPxKoF4OyCifrs&#34;,&#34;locale&#34;:&#34;en-US&#34;,&#34;software_version&#34;:&#34;1.01&#34;,&#34;structure_id&#34;:&#34;VqFabWH21nwVyd4RWgJgNb292wa7...
</code></pre><p>给定具有三个映射的嵌套 JSON 对象，您可以获取单个映射作为 columnn，然后使用 <code>explode()</code> 访问它的属性。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-scala" data-lang="scala"><span class="line"><span class="cl"><span class="k">val</span> <span class="n">mapColumnsDF</span> <span class="k">=</span> <span class="n">nestDF2</span><span class="o">.</span><span class="n">select</span><span class="o">(</span><span class="n">$</span><span class="s">&#34;devices&#34;</span><span class="o">.</span><span class="n">getItem</span><span class="o">(</span><span class="s">&#34;smoke_co_alarms&#34;</span><span class="o">).</span><span class="n">alias</span> <span class="o">(</span><span class="s">&#34;smoke_alarms&#34;</span><span class="o">),</span>
</span></span><span class="line"><span class="cl">                                  <span class="n">$</span><span class="s">&#34;devices&#34;</span><span class="o">.</span><span class="n">getItem</span><span class="o">(</span><span class="s">&#34;cameras&#34;</span><span class="o">).</span><span class="n">alias</span> <span class="o">(</span><span class="s">&#34;cameras&#34;</span><span class="o">),</span>
</span></span><span class="line"><span class="cl">                                  <span class="n">$</span><span class="s">&#34;devices&#34;</span><span class="o">.</span><span class="n">getItem</span><span class="o">(</span><span class="s">&#34;thermostats&#34;</span><span class="o">).</span><span class="n">alias</span> <span class="o">(</span><span class="s">&#34;thermostats&#34;</span><span class="o">))</span>
</span></span><span class="line"><span class="cl"><span class="n">mapColumnsDF</span><span class="k">:</span> <span class="kt">org.apache.spark.sql.DataFrame</span> <span class="o">=</span> <span class="o">[</span><span class="kt">smoke_alarms:</span> <span class="kt">map&lt;string</span>,<span class="kt">struct&lt;device_id:string</span>,<span class="kt">locale:string</span>,<span class="kt">software_version:string</span>,<span class="kt">structure_id:string</span>,<span class="kt">where_name:string</span>,<span class="kt">last_connection:string</span>,<span class="kt">is_online:boolean</span>,<span class="kt">battery_health:string</span>,<span class="kt">co_alarm_state:string</span>,<span class="kt">smoke_alarm_state:string</span>,<span class="kt">is_manual_test_active:boolean</span>,<span class="kt">last_manual_test_time:string</span>,<span class="kt">ui_color_state:string&gt;&gt;</span>, <span class="kt">cameras:</span> <span class="kt">map&lt;string</span>,<span class="kt">struct&lt;device_id:string</span>,<span class="kt">software_version:string</span>,<span class="kt">structure_id:string</span>,<span class="kt">where_name:string</span>,<span class="kt">is_online:boolean</span>,<span class="kt">is_streaming:boolean</span>,<span class="kt">is_audio_input_enabled:boolean</span>,<span class="kt">last_is_online_change:string</span>,<span class="kt">is_video_history_enabled:boolean</span>,<span class="kt">web_url:string</span>,<span class="kt">app_url:string</span>,<span class="kt">is_public_share_enabled:boolean</span>,<span class="kt">activity_zones:struct&lt;name:string</span>,<span class="kt">id:bigint&gt;</span>,<span class="kt">last_event:string&gt;&gt;</span> <span class="kt">...</span> <span class="err">1</span> <span class="kt">more</span> <span class="kt">field</span><span class="o">]</span>
</span></span></code></pre></div><table>
<thead>
<tr>
<th style="text-align:left">smoke_alarms</th>
<th style="text-align:left">cameras</th>
<th style="text-align:left">thermostats</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">{&ldquo;RTMTKxsQTCxzVcsySOHPxKoF4OyCifrs&rdquo;:{&ldquo;device_id&rdquo;:&ldquo;RTMTKxsQTCxzVcsySOHPxKoF4OyCifrs&rdquo;,&ldquo;locale&rdquo;:&ldquo;en-US&rdquo;,&ldquo;software_version&rdquo;:&ldquo;1.01&rdquo;,&ldquo;structure_id&rdquo;:&ldquo;VqFabWH21nwVyd4RWgJgNb292wa7hG_dUwo2i2SG7j3-BOLY0BA4sw&rdquo;,&ldquo;where_name&rdquo;:&ldquo;Jane&rsquo;s Room&rdquo;,&ldquo;last_connection&rdquo;:&ldquo;2016-10-31T23:59:59.000Z&rdquo;,&ldquo;is_online&rdquo;:true,&ldquo;battery_health&rdquo;:&ldquo;ok&rdquo;,&ldquo;co_alarm_state&rdquo;:&ldquo;ok&rdquo;,&ldquo;smoke_alarm_state&rdquo;:&ldquo;ok&rdquo;,&ldquo;is_manual_test_active&rdquo;:true,&ldquo;last_manual_test_time&rdquo;:&ldquo;2016-10-31T23:59:59.000Z&rdquo;,&ldquo;ui_color_state&rdquo;:&ldquo;gray&rdquo;}}&quot;</td>
<td style="text-align:left">&ldquo;{&ldquo;awJo6rH0IldT2YlIVtYaGQ&rdquo;:{&ldquo;device_id&rdquo;:&ldquo;awJo6rH&rdquo;,&ldquo;software_version&rdquo;:&ldquo;4.0&rdquo;,&ldquo;structure_id&rdquo;:&ldquo;VqFabWH21nwVyd4RWgJgNb292wa7hG_dUwo2i2SG7j3-BOLY0BA4sw&rdquo;,&ldquo;where_name&rdquo;:&ldquo;Foyer&rdquo;,&ldquo;is_online&rdquo;:true,&ldquo;is_streaming&rdquo;:true,&ldquo;is_audio_input_enabled&rdquo;:true,&ldquo;last_is_online_change&rdquo;:&ldquo;2016-12-29T18:42:00.000Z&rdquo;,&ldquo;is_video_history_enabled&rdquo;:true,&ldquo;web_url&rdquo;:&ldquo;<a href="https://home.nest.com/cameras/device_id?auth=access_token%22,%22app_url%22:%22nestmobile://cameras/device_id?auth=access_token%22,%22is_public_share_enabled%22:true,%22activity_zones%22:%7B%22name%22:%22Walkway%22,%22id%22:%22244083%22%7D,%22last_event%22:%222016-10-31T23:59:59.000Z%22%7D%7D%22">https://home.nest.com/cameras/device_id?auth=access_token&quot;,&quot;app_url&quot;:&quot;nestmobile://cameras/device_id?auth=access_token&quot;,&quot;is_public_share_enabled&quot;:true,&quot;activity_zones&quot;:{&quot;name&quot;:&quot;Walkway&quot;,&quot;id&quot;:&quot;244083&quot;},&quot;last_event&quot;:&quot;2016-10-31T23:59:59.000Z&quot;}}&quot;</a></td>
<td style="text-align:left">&ldquo;{&ldquo;peyiJNo0IldT2YlIVtYaGQ&rdquo;:{&ldquo;device_id&rdquo;:&ldquo;peyiJNo0IldT2YlIVtYaGQ&rdquo;,&ldquo;locale&rdquo;:&ldquo;en-US&rdquo;,&ldquo;software_version&rdquo;:&ldquo;4.0&rdquo;,&ldquo;structure_id&rdquo;:&ldquo;VqFabWH21nwVyd4RWgJgNb292wa7hG_dUwo2i2SG7j3-BOLY0BA4sw&rdquo;,&ldquo;where_name&rdquo;:&ldquo;Hallway Upstairs&rdquo;,&ldquo;last_connection&rdquo;:&ldquo;2016-10-31T23:59:59.000Z&rdquo;,&ldquo;is_online&rdquo;:true,&ldquo;can_cool&rdquo;:true,&ldquo;can_heat&rdquo;:true,&ldquo;is_using_emergency_heat&rdquo;:true,&ldquo;has_fan&rdquo;:true,&ldquo;fan_timer_active&rdquo;:true,&ldquo;fan_timer_timeout&rdquo;:&ldquo;2016-10-31T23:59:59.000Z&rdquo;,&ldquo;temperature_scale&rdquo;:&ldquo;F&rdquo;,&ldquo;target_temperature_f&rdquo;:72,&ldquo;target_temperature_high_f&rdquo;:80,&ldquo;target_temperature_low_f&rdquo;:65,&ldquo;eco_temperature_high_f&rdquo;:80,&ldquo;eco_temperature_low_f&rdquo;:65,&ldquo;away_temperature_high_f&rdquo;:80,&ldquo;away_temperature_low_f&rdquo;:65,&ldquo;hvac_mode&rdquo;:&ldquo;heat&rdquo;,&ldquo;humidity&rdquo;:&ldquo;40&rdquo;,&ldquo;hvac_state&rdquo;:&ldquo;heating&rdquo;,&ldquo;is_locked&rdquo;:&ldquo;true&rdquo;,&ldquo;locked_temp_min_f&rdquo;:65,&ldquo;locked_temp_max_f&rdquo;:80}}</td>
</tr>
</tbody>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-scala" data-lang="scala"><span class="line"><span class="cl"><span class="k">val</span> <span class="n">explodedThermostatsDF</span> <span class="k">=</span> <span class="n">mapColumnsDF</span><span class="o">.</span><span class="n">select</span><span class="o">(</span><span class="n">explode</span><span class="o">(</span><span class="n">$</span><span class="s">&#34;thermostats&#34;</span><span class="o">))</span>
</span></span><span class="line"><span class="cl"><span class="k">val</span> <span class="n">explodedCamerasDF</span> <span class="k">=</span> <span class="n">mapColumnsDF</span><span class="o">.</span><span class="n">select</span><span class="o">(</span><span class="n">explode</span><span class="o">(</span><span class="n">$</span><span class="s">&#34;cameras&#34;</span><span class="o">))</span>
</span></span><span class="line"><span class="cl"><span class="c1">//or you could use the original nestDF2 and use the devices.X notation
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">val</span> <span class="n">explodedSmokedAlarmsDF</span> <span class="k">=</span>  <span class="n">nestDF2</span><span class="o">.</span><span class="n">select</span><span class="o">(</span><span class="n">explode</span><span class="o">(</span><span class="n">$</span><span class="s">&#34;devices.smoke_co_alarms&#34;</span><span class="o">))</span>
</span></span><span class="line"><span class="cl"><span class="n">explodedThermostatsDF</span><span class="k">:</span> <span class="kt">org.apache.spark.sql.DataFrame</span> <span class="o">=</span> <span class="o">[</span><span class="kt">key:</span> <span class="kt">string</span>, <span class="kt">value:</span> <span class="kt">struct&lt;device_id:</span> <span class="kt">string</span>, <span class="kt">locale:</span> <span class="kt">string</span> <span class="kt">...</span> <span class="err">25</span> <span class="kt">more</span> <span class="kt">fields&gt;</span><span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="n">explodedCamerasDF</span><span class="k">:</span> <span class="kt">org.apache.spark.sql.DataFrame</span> <span class="o">=</span> <span class="o">[</span><span class="kt">key:</span> <span class="kt">string</span>, <span class="kt">value:</span> <span class="kt">struct&lt;device_id:</span> <span class="kt">string</span>, <span class="kt">software_version:</span> <span class="kt">string</span> <span class="kt">...</span> <span class="err">12</span> <span class="kt">more</span> <span class="kt">fields&gt;</span><span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="n">explodedSmokedAlarmsDF</span><span class="k">:</span> <span class="kt">org.apache.spark.sql.DataFrame</span> <span class="o">=</span> <span class="o">[</span><span class="kt">key:</span> <span class="kt">string</span>, <span class="kt">value:</span> <span class="kt">struct&lt;device_id:</span> <span class="kt">string</span>, <span class="kt">locale:</span> <span class="kt">string</span> <span class="kt">...</span> <span class="err">11</span> <span class="kt">more</span> <span class="kt">fields&gt;</span><span class="o">]</span>
</span></span></code></pre></div><table>
<thead>
<tr>
<th style="text-align:left">key</th>
<th style="text-align:left">value</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">peyiJNo0IldT2YlIVtYaGQ</td>
<td style="text-align:left">{&ldquo;device_id&rdquo;:&ldquo;peyiJNo0IldT2YlIVtYaGQ&rdquo;,&ldquo;locale&rdquo;:&ldquo;en-US&rdquo;,&ldquo;software_version&rdquo;:&ldquo;4.0&rdquo;,&ldquo;structure_id&rdquo;:&ldquo;VqFabWH21nwVyd4RWgJgNb292wa7hG_dUwo2i2SG7j3-BOLY0BA4sw&rdquo;,&ldquo;where_name&rdquo;:&ldquo;Hallway Upstairs&rdquo;,&ldquo;last_connection&rdquo;:&ldquo;2016-10-31T23:59:59.000Z&rdquo;,&ldquo;is_online&rdquo;:true,&ldquo;can_cool&rdquo;:true,&ldquo;can_heat&rdquo;:true,&ldquo;is_using_emergency_heat&rdquo;:true,&ldquo;has_fan&rdquo;:true,&ldquo;fan_timer_active&rdquo;:true,&ldquo;fan_timer_timeout&rdquo;:&ldquo;2016-10-31T23:59:59.000Z&rdquo;,&ldquo;temperature_scale&rdquo;:&ldquo;F&rdquo;,&ldquo;target_temperature_f&rdquo;:72,&ldquo;target_temperature_high_f&rdquo;:80,&ldquo;target_temperature_low_f&rdquo;:65,&ldquo;eco_temperature_high_f&rdquo;:80,&ldquo;eco_temperature_low_f&rdquo;:65,&ldquo;away_temperature_high_f&rdquo;:80,&ldquo;away_temperature_low_f&rdquo;:65,&ldquo;hvac_mode&rdquo;:&ldquo;heat&rdquo;,&ldquo;humidity&rdquo;:&ldquo;40&rdquo;,&ldquo;hvac_state&rdquo;:&ldquo;heating&rdquo;,&ldquo;is_locked&rdquo;:&ldquo;true&rdquo;,&ldquo;locked_temp_min_f&rdquo;:65,&ldquo;locked_temp_max_f&rdquo;:80}</td>
</tr>
</tbody>
</table>
<p>要从 map 中提取特定的单个字段，可以使用 <code>getItem()</code> 方法。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-scala" data-lang="scala"><span class="line"><span class="cl"><span class="k">val</span> <span class="n">thermostateDF</span> <span class="k">=</span> <span class="n">explodedThermostatsDF</span><span class="o">.</span><span class="n">select</span><span class="o">(</span><span class="n">$</span><span class="s">&#34;value&#34;</span><span class="o">.</span><span class="n">getItem</span><span class="o">(</span><span class="s">&#34;device_id&#34;</span><span class="o">).</span><span class="n">alias</span><span class="o">(</span><span class="s">&#34;device_id&#34;</span><span class="o">),</span> 
</span></span><span class="line"><span class="cl">                                                 <span class="n">$</span><span class="s">&#34;value&#34;</span><span class="o">.</span><span class="n">getItem</span><span class="o">(</span><span class="s">&#34;locale&#34;</span><span class="o">).</span><span class="n">alias</span><span class="o">(</span><span class="s">&#34;locale&#34;</span><span class="o">),</span>
</span></span><span class="line"><span class="cl">                                                 <span class="n">$</span><span class="s">&#34;value&#34;</span><span class="o">.</span><span class="n">getItem</span><span class="o">(</span><span class="s">&#34;where_name&#34;</span><span class="o">).</span><span class="n">alias</span><span class="o">(</span><span class="s">&#34;location&#34;</span><span class="o">),</span>
</span></span><span class="line"><span class="cl">                                                 <span class="n">$</span><span class="s">&#34;value&#34;</span><span class="o">.</span><span class="n">getItem</span><span class="o">(</span><span class="s">&#34;last_connection&#34;</span><span class="o">).</span><span class="n">alias</span><span class="o">(</span><span class="s">&#34;last_connected&#34;</span><span class="o">),</span>
</span></span><span class="line"><span class="cl">                                                 <span class="n">$</span><span class="s">&#34;value&#34;</span><span class="o">.</span><span class="n">getItem</span><span class="o">(</span><span class="s">&#34;humidity&#34;</span><span class="o">).</span><span class="n">alias</span><span class="o">(</span><span class="s">&#34;humidity&#34;</span><span class="o">),</span>
</span></span><span class="line"><span class="cl">                                                 <span class="n">$</span><span class="s">&#34;value&#34;</span><span class="o">.</span><span class="n">getItem</span><span class="o">(</span><span class="s">&#34;target_temperature_f&#34;</span><span class="o">).</span><span class="n">alias</span><span class="o">(</span><span class="s">&#34;target_temperature_f&#34;</span><span class="o">),</span>
</span></span><span class="line"><span class="cl">                                                 <span class="n">$</span><span class="s">&#34;value&#34;</span><span class="o">.</span><span class="n">getItem</span><span class="o">(</span><span class="s">&#34;hvac_mode&#34;</span><span class="o">).</span><span class="n">alias</span><span class="o">(</span><span class="s">&#34;mode&#34;</span><span class="o">),</span>
</span></span><span class="line"><span class="cl">                                                 <span class="n">$</span><span class="s">&#34;value&#34;</span><span class="o">.</span><span class="n">getItem</span><span class="o">(</span><span class="s">&#34;software_version&#34;</span><span class="o">).</span><span class="n">alias</span><span class="o">(</span><span class="s">&#34;version&#34;</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">val</span> <span class="n">cameraDF</span> <span class="k">=</span> <span class="n">explodedCamerasDF</span><span class="o">.</span><span class="n">select</span><span class="o">(</span><span class="n">$</span><span class="s">&#34;value&#34;</span><span class="o">.</span><span class="n">getItem</span><span class="o">(</span><span class="s">&#34;device_id&#34;</span><span class="o">).</span><span class="n">alias</span><span class="o">(</span><span class="s">&#34;device_id&#34;</span><span class="o">),</span>
</span></span><span class="line"><span class="cl">                                        <span class="n">$</span><span class="s">&#34;value&#34;</span><span class="o">.</span><span class="n">getItem</span><span class="o">(</span><span class="s">&#34;where_name&#34;</span><span class="o">).</span><span class="n">alias</span><span class="o">(</span><span class="s">&#34;location&#34;</span><span class="o">),</span>
</span></span><span class="line"><span class="cl">                                        <span class="n">$</span><span class="s">&#34;value&#34;</span><span class="o">.</span><span class="n">getItem</span><span class="o">(</span><span class="s">&#34;software_version&#34;</span><span class="o">).</span><span class="n">alias</span><span class="o">(</span><span class="s">&#34;version&#34;</span><span class="o">),</span>
</span></span><span class="line"><span class="cl">                                        <span class="n">$</span><span class="s">&#34;value&#34;</span><span class="o">.</span><span class="n">getItem</span><span class="o">(</span><span class="s">&#34;activity_zones&#34;</span><span class="o">).</span><span class="n">getItem</span><span class="o">(</span><span class="s">&#34;name&#34;</span><span class="o">).</span><span class="n">alias</span><span class="o">(</span><span class="s">&#34;name&#34;</span><span class="o">),</span>
</span></span><span class="line"><span class="cl">                                        <span class="n">$</span><span class="s">&#34;value&#34;</span><span class="o">.</span><span class="n">getItem</span><span class="o">(</span><span class="s">&#34;activity_zones&#34;</span><span class="o">).</span><span class="n">getItem</span><span class="o">(</span><span class="s">&#34;id&#34;</span><span class="o">).</span><span class="n">alias</span><span class="o">(</span><span class="s">&#34;id&#34;</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">                                         
</span></span><span class="line"><span class="cl"><span class="k">val</span> <span class="n">smokedAlarmsDF</span> <span class="k">=</span> <span class="n">explodedSmokedAlarmsDF</span><span class="o">.</span><span class="n">select</span><span class="o">(</span><span class="n">$</span><span class="s">&#34;value&#34;</span><span class="o">.</span><span class="n">getItem</span><span class="o">(</span><span class="s">&#34;device_id&#34;</span><span class="o">).</span><span class="n">alias</span><span class="o">(</span><span class="s">&#34;device_id&#34;</span><span class="o">),</span>
</span></span><span class="line"><span class="cl">                                                   <span class="n">$</span><span class="s">&#34;value&#34;</span><span class="o">.</span><span class="n">getItem</span><span class="o">(</span><span class="s">&#34;where_name&#34;</span><span class="o">).</span><span class="n">alias</span><span class="o">(</span><span class="s">&#34;location&#34;</span><span class="o">),</span>
</span></span><span class="line"><span class="cl">                                                   <span class="n">$</span><span class="s">&#34;value&#34;</span><span class="o">.</span><span class="n">getItem</span><span class="o">(</span><span class="s">&#34;software_version&#34;</span><span class="o">).</span><span class="n">alias</span><span class="o">(</span><span class="s">&#34;version&#34;</span><span class="o">),</span>
</span></span><span class="line"><span class="cl">                                                   <span class="n">$</span><span class="s">&#34;value&#34;</span><span class="o">.</span><span class="n">getItem</span><span class="o">(</span><span class="s">&#34;last_connection&#34;</span><span class="o">).</span><span class="n">alias</span><span class="o">(</span><span class="s">&#34;last_connected&#34;</span><span class="o">),</span>
</span></span><span class="line"><span class="cl">                                                   <span class="n">$</span><span class="s">&#34;value&#34;</span><span class="o">.</span><span class="n">getItem</span><span class="o">(</span><span class="s">&#34;battery_health&#34;</span><span class="o">).</span><span class="n">alias</span><span class="o">(</span><span class="s">&#34;battery_health&#34;</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">                                                  
</span></span><span class="line"><span class="cl">                                        
</span></span><span class="line"><span class="cl"><span class="n">thermostateDF</span><span class="k">:</span> <span class="kt">org.apache.spark.sql.DataFrame</span> <span class="o">=</span> <span class="o">[</span><span class="kt">device_id:</span> <span class="kt">string</span>, <span class="kt">locale:</span> <span class="kt">string</span> <span class="kt">...</span> <span class="err">6</span> <span class="kt">more</span> <span class="kt">fields</span><span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="n">cameraDF</span><span class="k">:</span> <span class="kt">org.apache.spark.sql.DataFrame</span> <span class="o">=</span> <span class="o">[</span><span class="kt">device_id:</span> <span class="kt">string</span>, <span class="kt">location:</span> <span class="kt">string</span> <span class="kt">...</span> <span class="err">3</span> <span class="kt">more</span> <span class="kt">fields</span><span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="n">smokedAlarmsDF</span><span class="k">:</span> <span class="kt">org.apache.spark.sql.DataFrame</span> <span class="o">=</span> <span class="o">[</span><span class="kt">device_id:</span> <span class="kt">string</span>, <span class="kt">location:</span> <span class="kt">string</span> <span class="kt">...</span> <span class="err">3</span> <span class="kt">more</span> <span class="kt">fields</span><span class="o">]</span>
</span></span></code></pre></div><ul>
<li>display(thermostateDF)</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:left">device_id</th>
<th style="text-align:left">locale</th>
<th style="text-align:left">location</th>
<th style="text-align:left">last_connected</th>
<th style="text-align:left">humidity</th>
<th style="text-align:left">target_temperature_f</th>
<th style="text-align:left">mode</th>
<th style="text-align:left">version</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">peyiJNo0IldT2YlIVtYaGQ</td>
<td style="text-align:left">en-US</td>
<td style="text-align:left">Hallway Upstairs</td>
<td style="text-align:left">2016-10-31T23:59:59.000Z</td>
<td style="text-align:left">40</td>
<td style="text-align:left">72</td>
<td style="text-align:left">heat</td>
<td style="text-align:left">4.0</td>
</tr>
</tbody>
</table>
<ul>
<li>display(cameraDF)</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:left">device_id</th>
<th style="text-align:left">location</th>
<th style="text-align:left">version</th>
<th style="text-align:left">name</th>
<th style="text-align:left">id</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">awJo6rH</td>
<td style="text-align:left">Foyer</td>
<td style="text-align:left">4.0</td>
<td style="text-align:left">Walkway</td>
<td style="text-align:left">244083</td>
</tr>
</tbody>
</table>
<ul>
<li>display(smokedAlarmsDF)</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:left">device_id</th>
<th style="text-align:left">location</th>
<th style="text-align:left">version</th>
<th style="text-align:left">last_connected</th>
<th style="text-align:left">battery_health</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">RTMTKxsQTCxzVcsySOHPxKoF4OyCifrs</td>
<td style="text-align:left">Jane&rsquo;s Room</td>
<td style="text-align:left">1.01</td>
<td style="text-align:left">2016-10-31T23:59:59.000Z</td>
<td style="text-align:left">ok</td>
</tr>
</tbody>
</table>
<p>让我们在列版本上 join 两个 DataFrame。</p>
<ul>
<li>display(joineDFs)</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-scala" data-lang="scala"><span class="line"><span class="cl"><span class="k">val</span> <span class="n">joineDFs</span> <span class="k">=</span> <span class="n">thermostateDF</span><span class="o">.</span><span class="n">join</span><span class="o">(</span><span class="n">cameraDF</span><span class="o">,</span> <span class="s">&#34;version&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">joineDFs</span><span class="k">:</span> <span class="kt">org.apache.spark.sql.DataFrame</span> <span class="o">=</span> <span class="o">[</span><span class="kt">version:</span> <span class="kt">string</span>, <span class="kt">device_id:</span> <span class="kt">string</span> <span class="kt">...</span> <span class="err">10</span> <span class="kt">more</span> <span class="kt">fields</span><span class="o">]</span>
</span></span></code></pre></div><table>
<thead>
<tr>
<th style="text-align:left">version</th>
<th style="text-align:left">device_id</th>
<th style="text-align:left">locale</th>
<th style="text-align:left">location</th>
<th style="text-align:left">last_connected</th>
<th style="text-align:left">humidity</th>
<th style="text-align:left">target_temperature_f</th>
<th style="text-align:left">mode</th>
<th style="text-align:left">device_id</th>
<th style="text-align:left">location</th>
<th style="text-align:left">name</th>
<th style="text-align:left">id</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">4.0</td>
<td style="text-align:left">peyiJNo0IldT2YlIVtYaGQ</td>
<td style="text-align:left">en-US</td>
<td style="text-align:left">Hallway Upstairs</td>
<td style="text-align:left">2016-10-31T23:59:59.000Z</td>
<td style="text-align:left">40</td>
<td style="text-align:left">72</td>
<td style="text-align:left">heat</td>
<td style="text-align:left">awJo6rH</td>
<td style="text-align:left">Foyer</td>
<td style="text-align:left">Walkway</td>
<td style="text-align:left">244083</td>
</tr>
</tbody>
</table>
<h2 id="总结">总结&nbsp;<a class="headline-hash no-text-decoration" href="#总结">#</a> </h2>
<p>这个简短教程的重点是演示如何轻松使用实用程序函数从复杂的嵌套结构中提取 JSON 属性。一旦您将所需的值展开或展平或解析到相应的数据框或数据集中，您就可以像使用相应的 API 一样轻松地提取和查询它们，就像使用任何DataFrame 或 Dataset 一样。查看我们的<a href="https://databricks.com/blog/2017/04/26/processing-data-in-apache-kafka-with-structured-streaming-in-apache-spark-2-2.html">结构化流体系列第3部分</a>，其中展示了如何从 Apache Kafka 读取 Nest 设备日志并对其进行一些 ETL。</p>


        </div>
    </div>
</article>



                <footer>
                    




<div class="no-text-decoration">
    <div class="jump top"><a href="#" title="Top of this page">⮉</a></div>
    <div class="jump bottom"><a href="#bottom" title="Bottom of this page">⮋</a></div>
</div>


 
    
        <div class="hugotoc no-text-decoration">
            <nav id="TableOfContents">
  <ul>
    <li><a href="#从上面的-schema-创建-dataset">从上面的 schema 创建 Dataset</a></li>
    <li><a href="#如何使用-get_json_object">如何使用 get_json_object()</a></li>
    <li><a href="#如何使用-from_json">如何使用 from_json()</a></li>
    <li><a href="#如何使用-to_json">如何使用 to_json()</a></li>
    <li><a href="#如何使用-selectexpr">如何使用 selectExpr()</a></li>
    <li><a href="#嵌套结构">嵌套结构</a></li>
    <li><a href="#如何使用-explode">如何使用 explode()</a></li>
    <li><a href="#警报通知功能">警报通知功能</a></li>
    <li><a href="#迭代警报设备并采取行动">迭代警报设备并采取行动</a></li>
    <li><a href="#将警报作为-json-发送到-apache-kafka-主题">将警报作为 JSON 发送到 Apache Kafka 主题</a></li>
    <li><a href="#嵌套的设备数据">嵌套的设备数据</a></li>
    <li><a href="#总结">总结</a></li>
  </ul>
</nav>
            <a href="#" class="back-to-top">Back to top</a>
        </div>
    
    
<script src="/js/libs/jquery/3.3.1/jquery.slim.min.min.22ee3db0c0e99fd0fbce3aee19672bd53d25469daf734bd4c165649f6eaf7d7f.js"></script>

<link rel="preload" href="/js/libs/jquery/3.3.1/jquery.slim.min.min.22ee3db0c0e99fd0fbce3aee19672bd53d25469daf734bd4c165649f6eaf7d7f.js" as="script">

<script type="application/javascript">(function() {
     var $window = $(window);
     if ($window.width() >= 1400) { 
         var $toc = $('#TableOfContents');
         if ($toc.length > 0) {
             function onScroll(){
                 var currentScroll = $window.scrollTop();
                 var h = $('.content h1, .content h2, .content h3, .content h4, .content h5, .content h6, .h-feed h2');
                 var id = "";
                 h.each(function (i, e) {
                     e = $(e);
                     if (e.offset().top - 10 <= currentScroll) {
                         id = e.attr('id');
                     }
                 });
                 var current = $toc.find('a.current');
                 if (current.length == 1 && current.eq(0).attr('href') == '#' + id) return true;

                 current.each(function (i, e) {
                     $(e).removeClass('current').siblings('ul').hide();
                 });
                 $toc.find('a[href="#' + id + '"]').parentsUntil('#TableOfContents').each(function (i, e) {
                     $(e).children('a').addClass('current').siblings('ul').show();
                 });
             }
             $window.on('scroll', onScroll);
             $(document).ready(function() {
                 $toc.find('a').parent('li').find('ul').hide();
                 onScroll();
                 document.getElementsByClassName('hugotoc')[0].style.display = '';
             });}}})();</script>








<div class="backtotop center no-text-decoration">
    <a href="#">back to <span class="top">top</span></a>
</div>


<div class="right">
    <div class="taxo no-text-decoration">
         
            
                <ul class="no-bullets inline categories">
                    
                        
                        
                        
                            
                            
                            
                            
                            
                            <li class="__rakulang__"
                                
                                
                                title="See all 0 posts categorized in ‘rakulang’"
                                
                            >
                                <a class="p-category" href="https://ohmycloud.github.io/categories/rakulang/">rakulang</a>
                            </li>
                        
                    
                </ul>
            
         
            
                <ul class="no-bullets inline tags">
                    
                        
                        
                        
                            
                            
                            
                            
                            
                            <li class="__rakulang__"
                                
                                
                                title="See all 0 posts tagged with ‘rakulang’"
                                
                            >
                                <a class="p-category" href="https://ohmycloud.github.io/tags/rakulang/">rakulang</a>
                            </li>
                        
                    
                </ul>
            
        
    </div>

</div>
<div class="clear-float"></div>



<div class="prev-next-navigator clear-float">
    
        <span class="prev-post left no-text-decoration">
            <a href="https://ohmycloud.github.io/notes/using-minion-in-dancer-apps/" class="nobr">« 第十二天 - 在 Dancer 应用程序中使用 Minion</a>
        </span>
    
    
        <span class="next-post right no-text-decoration">
            <a href="https://ohmycloud.github.io/notes/whats-behind-0-dot-1-plus-0-dot2-in-perl6/" class="nobr">🎄 12/25. 在 Raku 中, 0.1 &#43; 0.2 背后的东西 »</a>
        </span>
    
</div>


<a id="bottom"></a>









                       







                    <ul class="no-bullets feed right inline">
    
        
        
    
</ul>
<div class="clear-float"></div>

                </footer>
                <hr />
            </div>               

            <footer> 
                

<ul class="social no-text-decoration">
    
</ul>










 
    
    



<p class="generated no-text-decoration">
    Generated using  <a href="https://gitlab.com/kaushalmodi/hugo-theme-refined"><code class="nobr">hugo-theme-refined</code></a> + <span class="nobr">Hugo <a href="https://github.com/gohugoio/hugo/commit/312735366b20d64bd61bff8627f593749f86c964">0.123.7</a></span>
</p>

<p>
    
</p>




<div class="badges no-text-decoration">
    
    

    
</div>




<script type="application/javascript">var nav=responsiveNav("#nav");</script>




<script defer src="/js/libs/fragmentions/wrapper.min.e8c468c89edc4f5dccaa8c720c6b220b3088a16cd7b1e4a1e3345985788260c9.js"></script>









            </footer>
        </div> 
    </body>
</html>
