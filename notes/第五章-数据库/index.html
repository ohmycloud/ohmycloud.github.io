<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-us" lang="en-us">

    <head>
    <link href="https://gmpg.org/xfn/11" rel="profile">
    <meta charset="utf-8">
    
    
    

    
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5">

    
    <meta name="referrer" content="no-referrer">

    <title>
        
            Flask 入门 - 数据库 ❚ 焉知非鱼
        
    </title>

    
    


    
    
    
    

    
    
    
    

    
    
    

    
    
    
    <style>
     
     
     :root {
         --theme-color: #ac4142;
         --theme-color-light: rgba(172, 65, 66, 0.2);
     }
     
     html {
         line-height: 1.5;
     }
    </style>

    
    

    
    
    
    
    <link rel="stylesheet" href="/css/refined.min.7f6d3ee611034e4ebcbc063f1db3bc042fecdc8901afbedad80ff02bae409204.css">
    
    <link rel="preload" href="/css/refined.min.7f6d3ee611034e4ebcbc063f1db3bc042fecdc8901afbedad80ff02bae409204.css" as="style">

    



    
        <style>
         
         /* Background */ .chroma { background-color: #ffffff }
/* Error */ .chroma .err { color: #a61717; background-color: #e3d2d2 }
/* LineTableTD */ .chroma .lntd { vertical-align: top; padding: 0; margin: 0; border: 0; }
/* LineTable */ .chroma .lntable { border-spacing: 0; padding: 0; margin: 0; border: 0; width: auto; overflow: auto; display: block; }
/* LineHighlight */ .chroma .hl { display: block; width: 100%;background-color: #ffffcc }
/* LineNumbersTable */ .chroma .lnt { margin-right: 0.4em; padding: 0 0.4em 0 0.4em; }
/* LineNumbers */ .chroma .ln { margin-right: 0.4em; padding: 0 0.4em 0 0.4em; }
/* Keyword */ .chroma .k { color: #000000; font-weight: bold }
/* KeywordConstant */ .chroma .kc { color: #000000; font-weight: bold }
/* KeywordDeclaration */ .chroma .kd { color: #000000; font-weight: bold }
/* KeywordNamespace */ .chroma .kn { color: #000000; font-weight: bold }
/* KeywordPseudo */ .chroma .kp { color: #000000; font-weight: bold }
/* KeywordReserved */ .chroma .kr { color: #000000; font-weight: bold }
/* KeywordType */ .chroma .kt { color: #445588; font-weight: bold }
/* NameAttribute */ .chroma .na { color: #008080 }
/* NameBuiltin */ .chroma .nb { color: #0086b3 }
/* NameBuiltinPseudo */ .chroma .bp { color: #999999 }
/* NameClass */ .chroma .nc { color: #445588; font-weight: bold }
/* NameConstant */ .chroma .no { color: #008080 }
/* NameDecorator */ .chroma .nd { color: #3c5d5d; font-weight: bold }
/* NameEntity */ .chroma .ni { color: #800080 }
/* NameException */ .chroma .ne { color: #990000; font-weight: bold }
/* NameFunction */ .chroma .nf { color: #990000; font-weight: bold }
/* NameLabel */ .chroma .nl { color: #990000; font-weight: bold }
/* NameNamespace */ .chroma .nn { color: #555555 }
/* NameTag */ .chroma .nt { color: #000080 }
/* NameVariable */ .chroma .nv { color: #008080 }
/* NameVariableClass */ .chroma .vc { color: #008080 }
/* NameVariableGlobal */ .chroma .vg { color: #008080 }
/* NameVariableInstance */ .chroma .vi { color: #008080 }
/* LiteralString */ .chroma .s { color: #dd1144 }
/* LiteralStringAffix */ .chroma .sa { color: #dd1144 }
/* LiteralStringBacktick */ .chroma .sb { color: #dd1144 }
/* LiteralStringChar */ .chroma .sc { color: #dd1144 }
/* LiteralStringDelimiter */ .chroma .dl { color: #dd1144 }
/* LiteralStringDoc */ .chroma .sd { color: #dd1144 }
/* LiteralStringDouble */ .chroma .s2 { color: #dd1144 }
/* LiteralStringEscape */ .chroma .se { color: #dd1144 }
/* LiteralStringHeredoc */ .chroma .sh { color: #dd1144 }
/* LiteralStringInterpol */ .chroma .si { color: #dd1144 }
/* LiteralStringOther */ .chroma .sx { color: #dd1144 }
/* LiteralStringRegex */ .chroma .sr { color: #009926 }
/* LiteralStringSingle */ .chroma .s1 { color: #dd1144 }
/* LiteralStringSymbol */ .chroma .ss { color: #990073 }
/* LiteralNumber */ .chroma .m { color: #009999 }
/* LiteralNumberBin */ .chroma .mb { color: #009999 }
/* LiteralNumberFloat */ .chroma .mf { color: #009999 }
/* LiteralNumberHex */ .chroma .mh { color: #009999 }
/* LiteralNumberInteger */ .chroma .mi { color: #009999 }
/* LiteralNumberIntegerLong */ .chroma .il { color: #009999 }
/* LiteralNumberOct */ .chroma .mo { color: #009999 }
/* Operator */ .chroma .o { color: #000000; font-weight: bold }
/* OperatorWord */ .chroma .ow { color: #000000; font-weight: bold }
/* Comment */ .chroma .c { color: #999988; font-style: italic }
/* CommentHashbang */ .chroma .ch { color: #999988; font-style: italic }
/* CommentMultiline */ .chroma .cm { color: #999988; font-style: italic }
/* CommentSingle */ .chroma .c1 { color: #999988; font-style: italic }
/* CommentSpecial */ .chroma .cs { color: #999999; font-weight: bold; font-style: italic }
/* CommentPreproc */ .chroma .cp { color: #999999; font-weight: bold; font-style: italic }
/* CommentPreprocFile */ .chroma .cpf { color: #999999; font-weight: bold; font-style: italic }
/* GenericDeleted */ .chroma .gd { color: #000000; background-color: #ffdddd }
/* GenericEmph */ .chroma .ge { color: #000000; font-style: italic }
/* GenericError */ .chroma .gr { color: #aa0000 }
/* GenericHeading */ .chroma .gh { color: #999999 }
/* GenericInserted */ .chroma .gi { color: #000000; background-color: #ddffdd }
/* GenericOutput */ .chroma .go { color: #888888 }
/* GenericPrompt */ .chroma .gp { color: #555555 }
/* GenericStrong */ .chroma .gs { font-weight: bold }
/* GenericSubheading */ .chroma .gu { color: #aaaaaa }
/* GenericTraceback */ .chroma .gt { color: #aa0000 }
/* GenericUnderline */ .chroma .gl { text-decoration: underline }
/* TextWhitespace */ .chroma .w { color: #bbbbbb }

         
         /* Overrides on top of the theme and Chroma CSS */
/* Chroma-based lines highlighting in code blocks */
.chroma .hl {
    background-color: #e8e8e8;
    /* Extend highlight up to 100 characters (assuming that the code blocks never have more than 100 characters in a line) */
    min-width: 100ch;
}
/* GenericHeading */ .chroma .gh { color: #999999; font-weight: bold }
/* GenericSubheading */ .chroma .gu { color: #aaaaaa; font-weight: bold }

         
        </style>
    

    

    
    
    

    
    <script src="/js/responsive-nav-orig.min.e2b5f2a956b488f466da513820636134defdc38b90ed566248960593f2bb4ba5.js"></script>
    
    <link rel="preload" href="/js/responsive-nav-orig.min.e2b5f2a956b488f466da513820636134defdc38b90ed566248960593f2bb4ba5.js" as="script">

    
    
    <script defer src="/js/libs/fa/fontawesome-all.min.08916ac0fd078adfb58edc890460e2c8990729aee02bca7586404b56805f5219.js"></script>
    
    <link rel="preload" href="/js/libs/fa/fontawesome-all.min.08916ac0fd078adfb58edc890460e2c8990729aee02bca7586404b56805f5219.js" as="script">

    

    

    
    
    

    
    
<!-- rel="me" links for IndieAuth -->







    
 
<meta property="og:title" content="Flask 入门 - 数据库" />
<meta property="og:description"
      content="Learning Flask" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://ohmycloud.github.io/notes/%E7%AC%AC%E4%BA%94%E7%AB%A0-%E6%95%B0%E6%8D%AE%E5%BA%93/" />


    
        <meta property="article:published_time" content="2017-01-09T16:16:21&#43;00:00"/>
    
    
        <meta property="article:modified_time" content="2017-01-09T16:16:21&#43;00:00"/>
    









    




     <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Flask 入门 - 数据库"/>
<meta name="twitter:description" content="Learning Flask"/>


    
    
    <link rel="alternate" type="application/jf2post+json" href="https://ohmycloud.github.io/notes/%E7%AC%AC%E4%BA%94%E7%AB%A0-%E6%95%B0%E6%8D%AE%E5%BA%93/jf2post.json" title="Jf2post for 焉知非鱼" />
    
     



    
    
    
        
    


     
        
        <meta name="DC.Creator" content="焉知非鱼"/>
    



    
    
    
    <meta name="hugo-build-date" content="2024-03-01T16:16:06Z"/>
    <meta name="hugo-commit-hash" content="312735366b20d64bd61bff8627f593749f86c964"/>
    <meta name="generator" content="Hugo 0.123.7">
</head>


    
        <body lang="en">
    

        
        <div class="border" id="home"></div>

        <div class="wrapper">   
            
<nav id="nav" class="nav-collapse opened" aria-hidden="false">
    <ul class="navbar">
        <li><a class="" href="/">Home</a></li>
        
            
                <li><a class="" href="https://ohmycloud.github.io/posts/">Posts</a></li>
            
        
            
                <li><a class="" href="https://ohmycloud.github.io/notes/">Notes</a></li>
            
        
        
            <li><a class="" href="https://ohmycloud.github.io/search/">Search</a></li>
        
    </ul>
</nav>

            <div class="container">
                <header class="masthead">
                    <div class="masthead-title no-text-decoration">
                        <a href="/">焉知非鱼</a> <span class="blinking-cursor">❚</span>
                    </div>
                    <div class="masthead-tagline">
                        Wait the light to fall
                    </div>
                </header>

                








<article class="post h-entry notes">
    <header>
        <div class="center">
    <div class="taxo no-text-decoration">
         
            
                <ul class="no-bullets inline categories">
                    
                        
                        
                        
                            
                            
                            
                            
                            
                            <li class="__rakulang__"
                                
                                
                                title="See all 0 posts categorized in ‘rakulang’"
                                
                            >
                                <a class="p-category" href="https://ohmycloud.github.io/categories/rakulang/">rakulang</a>
                            </li>
                        
                    
                </ul>
            
         
            
                <ul class="no-bullets inline tags">
                    
                        
                        
                        
                            
                            
                            
                            
                            
                            <li class="__rakulang__"
                                
                                
                                title="See all 0 posts tagged with ‘rakulang’"
                                
                            >
                                <a class="p-category" href="https://ohmycloud.github.io/tags/rakulang/">rakulang</a>
                            </li>
                        
                    
                </ul>
            
        
    </div>

</div>

        <h1 class="post-title p-name">Flask 入门 - 数据库</h1>

        
        <data class="u-url" value="https://ohmycloud.github.io/notes/%E7%AC%AC%E4%BA%94%E7%AB%A0-%E6%95%B0%E6%8D%AE%E5%BA%93/"></data>

        <div class="date-syndication">
            


    
    
    <div class="post-date">
        
        <time datetime="2017-01-09T16:16:21+0000" class="dt-published">Mon Jan 9, 2017</time>
        
        
    </div>


            




        </div>
         



    
    
    
        
    


    
        
        <span class="hide">
            &mdash; <a href="https://ohmycloud.github.io/" class="u-author">焉知非鱼</a>
        </span>
    


    </header>

    <div class="content">
        
    <div class="description p-summary">
        
        
        
        
        
            
            
        
        <p>Learning Flask</p>
    </div>



        





                       


        <div class="e-content">
            




<p>文档数据库和键值对数据库这两种数据库合称 <code>NoSQL</code> 数据库。</p>
<h2 id="sql-数据库">SQL 数据库&nbsp;<a class="headline-hash no-text-decoration" href="#sql-数据库">#</a> </h2>
<p>表中有个特殊的列，称为主键，其值为表中各行的唯一标识符。表中还可以有称为外键的列，引用同一个表或不同表中某行的主键。行之间的这种联系称为关系，这是关系型数据库模型的基础。</p>
<h2 id="nosql-数据库">NoSQL 数据库&nbsp;<a class="headline-hash no-text-decoration" href="#nosql-数据库">#</a> </h2>
<p>NoSQL 数据库一般使用集合代替表，使用文档代替记录。NoSQL 数据库采用的设计方式使联结变得困难，所以大多数数据库根本不支持这种操作。</p>
<h2 id="使用sql还是nosql">使用SQL还是NoSQL&nbsp;<a class="headline-hash no-text-decoration" href="#使用sql还是nosql">#</a> </h2>
<p>SQL 数据库擅于用高效且紧凑的形式存储结构化数据。这种数据库需要花费大量精力保证数据的一致性。NoSQL 数据库放宽了对这种一致性的要求，从而获得性能上的优势。</p>
<h2 id="python-数据库框架-flask-sqlalchemy">Python 数据库框架 Flask-SQLAlchemy&nbsp;<a class="headline-hash no-text-decoration" href="#python-数据库框架-flask-sqlalchemy">#</a> </h2>
<p>Flask-SQLAlchemy 是一个 Flask 扩展，简化了在 Flask 程序中使用 SQLAlchemy 的操作。SQLAlchemy 是一个很强大的关系型数据库框架，支持多种数据库后台。SQLAlchemy 提供了高层 ORM（Object-Relational Mapper，对象关系映射），也提供了使用数据库原生 SQL 的低层功能。</p>
<pre tabindex="0"><code>(venv) $ pip install flask-sqlalchemy
</code></pre><p>在 Flask-SQLAlchemy 中, 数据库使用 URL 指定。
表 5-1 Flask-SQLAlchemy 数据库 URL</p>
<table>
<thead>
<tr>
<th style="text-align:left">数据库引擎</th>
<th style="text-align:left">URL</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">MySQL</td>
<td style="text-align:left">mysql://username:password@hostname/database</td>
</tr>
<tr>
<td style="text-align:left">Postgres</td>
<td style="text-align:left">postgresql://username:password@hostname/database</td>
</tr>
<tr>
<td style="text-align:left">SQLite（Unix）</td>
<td style="text-align:left">sqlite:////absolute/path/to/database</td>
</tr>
<tr>
<td style="text-align:left">SQLite（Windows）</td>
<td style="text-align:left">sqlite:///c:/absolute/path/to/database</td>
</tr>
</tbody>
</table>
<p>在这些 URL 中，hostname 表示 MySQL 服务所在的主机，可以是本地主机（localhost），也可以是远程服务器。数据库服务器上可以托管多个数据库，因此 database 表示要使用的数据库名。如果数据库需要进行认证，username 和 password 表示数据库用户密令。</p>
<blockquote>
<p>SQLite 数据库不需要使用服务器，因此不用指定 hostname、username 和 password。URL 中的 database 是硬盘上文件的文件名。</p>
</blockquote>
<p>程序使用的数据库 URL 必须保存到 Flask 配置对象的 <code>SQLALCHEMY_DATABASE_URI</code> 键中。配
置对象中还有一个很有用的选项，即 <code>SQLALCHEMY_COMMIT_ON_TEARDOWN</code> 键，将其设为 True 时，每次请求结束后都会自动提交数据库中的变动。示例 5-1 展示了如何初始化及配置一个简单的 SQLite 数据库。</p>
<p>示例 5-1 hello.py: 配置数据库</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">flask_sqlalchemy</span> <span class="kn">import</span> <span class="n">SQLAlchemy</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">basedir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;SQLALCHEMY_DATABASE_URI&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;sqlite:///&#39;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">basedir</span><span class="p">,</span> <span class="s1">&#39;data.sqlite&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;SQLALCHEMY_COMMIT_ON_TEARDOWN&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">db</span> <span class="o">=</span> <span class="n">SQLAlchemy</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
</span></span></code></pre></div><p>db 对象是 SQLAlchemy 类的实例, 表示程序使用的数据库。data.sqlite 是数据库的名字, 上面使用 + 号拼接了数据库的绝对路径。</p>
<h2 id="定义模型">定义模型&nbsp;<a class="headline-hash no-text-decoration" href="#定义模型">#</a> </h2>
<p>模型表示程序使用的<strong>持久化</strong>化的实体。在 ORM(对象关系映射)中, 模型一般是一个 Python 类, 类中的<strong>属性</strong>对应着数据库表中的<strong>列</strong>。</p>
<p>Flask-SQLAlchemy 创建的数据库实例(例如 db)为模型提供了一个基类以及一系列辅助类和辅助函数, 可以用于定义模型的结构。下面把数据库中的  roles 表和 users 表定义为 模型 Role 和模型 User。</p>
<p>示例 5-2 hello.py: 定义 Role 和 User 模型</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Role</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;roles&#39;</span>
</span></span><span class="line"><span class="cl">    <span class="nb">id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">name</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">64</span><span class="p">),</span> <span class="n">unique</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="s1">&#39;&lt;Role </span><span class="si">%r</span><span class="s1">&gt;&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;users&#39;</span>
</span></span><span class="line"><span class="cl">    <span class="nb">id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">username</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">64</span><span class="p">),</span> <span class="n">unique</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="s1">&#39;&lt;User </span><span class="si">%r</span><span class="s1">&gt;&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">username</span>
</span></span></code></pre></div><p><strong>类变量</strong><code>__tablename__</code>定义在数据库中使用的表名。如果没有定义 <code>__tablename__</code> , Flask-SQLAlchemy 会使用一个默认名字。<code>id</code>/<code>name</code>/<code>username</code> 都是模型中的属性,  被定义为 db.Column 类的实例, 代表数据库中的<strong>列</strong>。</p>
<p><code>db.Column</code> 类构造函数的第一个参数是数据库列和模型属性的<strong>类型</strong>。表 5-2 列出了一些可用的・<strong>列类型</strong>以及在模型中使用的 Python 类型。</p>
<p>表5-2 最常用的SQLAlchemy 列类型</p>
<table>
<thead>
<tr>
<th style="text-align:center">类型名</th>
<th style="text-align:center">Python类型</th>
<th style="text-align:left">说  明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">Integer</td>
<td style="text-align:center">int</td>
<td style="text-align:left">普通整数，一般是 32 位</td>
</tr>
<tr>
<td style="text-align:center">SmallInteger</td>
<td style="text-align:center">int</td>
<td style="text-align:left">取值范围小的整数，一般是 16 位</td>
</tr>
<tr>
<td style="text-align:center">BigInteger</td>
<td style="text-align:center">int 或 long</td>
<td style="text-align:left">不限制精度的整数</td>
</tr>
<tr>
<td style="text-align:center">Float</td>
<td style="text-align:center">float</td>
<td style="text-align:left">浮点数</td>
</tr>
<tr>
<td style="text-align:center">Numeric</td>
<td style="text-align:center">decimal.Decimal</td>
<td style="text-align:left">定点数</td>
</tr>
<tr>
<td style="text-align:center">String</td>
<td style="text-align:center">str</td>
<td style="text-align:left">变长字符串</td>
</tr>
<tr>
<td style="text-align:center">Text</td>
<td style="text-align:center">str</td>
<td style="text-align:left">变长字符串，对较长或不限长度的字符串做了优化</td>
</tr>
<tr>
<td style="text-align:center">Unicode</td>
<td style="text-align:center">unicode</td>
<td style="text-align:left">变长 Unicode 字符串</td>
</tr>
<tr>
<td style="text-align:center">UnicodeText</td>
<td style="text-align:center">unicode</td>
<td style="text-align:left">变长 Unicode 字符串，对较长或不限长度的字符串做了优化</td>
</tr>
<tr>
<td style="text-align:center">Boolean</td>
<td style="text-align:center">bool</td>
<td style="text-align:left">布尔值</td>
</tr>
<tr>
<td style="text-align:center">Date</td>
<td style="text-align:center">datetime.date</td>
<td style="text-align:left">日期</td>
</tr>
<tr>
<td style="text-align:center">Time</td>
<td style="text-align:center">datetime.time</td>
<td style="text-align:left">时间</td>
</tr>
<tr>
<td style="text-align:center">DateTime</td>
<td style="text-align:center">datetime.datetime</td>
<td style="text-align:left">日期和时间</td>
</tr>
<tr>
<td style="text-align:center">Interval</td>
<td style="text-align:center">datetime.timedelta</td>
<td style="text-align:left">时间间隔</td>
</tr>
<tr>
<td style="text-align:center">Enum</td>
<td style="text-align:center">str</td>
<td style="text-align:left">一组字符串</td>
</tr>
<tr>
<td style="text-align:center">PickleType</td>
<td style="text-align:center">任何 Python 对象</td>
<td style="text-align:left">自动使用 Pickle 序列化</td>
</tr>
<tr>
<td style="text-align:center">LargeBinary</td>
<td style="text-align:center">str</td>
<td style="text-align:left">二进制文件</td>
</tr>
</tbody>
</table>
<p>db.Column 中其余的参数指定属性的配置选项。表 5-3 列出了一些可用选项。</p>
<p>表5-3 最常用的 SQLAlchemy 列选项</p>
<table>
<thead>
<tr>
<th style="text-align:center">选项名</th>
<th style="text-align:left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">primary_key</td>
<td style="text-align:left">如果设为 True ，这列就是表的主键</td>
</tr>
<tr>
<td style="text-align:center">unique</td>
<td style="text-align:left">如果设为 True ，这列不允许出现重复的值</td>
</tr>
<tr>
<td style="text-align:center">index</td>
<td style="text-align:left">如果设为 True ，为这列创建索引，提升查询效率</td>
</tr>
<tr>
<td style="text-align:center">nullable</td>
<td style="text-align:left">如果设为 True ，这列允许使用空值；如果设为 False ，这列不允许使用空值</td>
</tr>
<tr>
<td style="text-align:center">default</td>
<td style="text-align:left">为这列定义默认值</td>
</tr>
</tbody>
</table>
<blockquote>
<p>Flask-SQLAlchemy 要求每个模型都要定义 主键 ，这一列经常命名为 id 。</p>
</blockquote>
<p>虽然没有强制要求，但这两个模型都定义了 <strong>repr()</strong> 方法，返回一个具有可读性的字符串表示模型，可在调试和测试时使用。</p>
<h2 id="关系">关系&nbsp;<a class="headline-hash no-text-decoration" href="#关系">#</a> </h2>
<p>关系型数据库使用关系把不同表中的行联系起来。图 5-1 所示的关系图表示用户和角色之间的一种简单关系。这是角色到用户的一对多关系，因为一个角色可属于多个用户，而每个用户都只能有一个角色。</p>
<p>图 5-1 中的一对多关系在<strong>模型</strong>中的表示方法如示例 5-3 所示:
示例 5-3 hello.py: 关系</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Role</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># ...</span>
</span></span><span class="line"><span class="cl">    <span class="n">users</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">relationship</span><span class="p">(</span><span class="s1">&#39;User&#39;</span><span class="p">,</span> <span class="n">backref</span><span class="o">=</span><span class="s1">&#39;role&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># ...</span>
</span></span><span class="line"><span class="cl">    <span class="n">role_id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;roles.id&#39;</span><span class="p">))</span>
</span></span></code></pre></div><p>如图 5-1 所示, 关系使用了 users 表中的外键连接了两行。添加到 User 模型中的 role_id 列被定义为外键, 就是这个外键建立起了关系。传给 db.ForeignKey() 的参数 <code>roles.id</code> 表明, 这列的值是 roles 表中行的 id 值。</p>
<p>对于一个 Role 类的<strong>实例</strong>, 其 users 属性将返回<strong>与角色相关联</strong>的用户组成的<strong>列表</strong>。 db.relationship() 的第一个参数表明这个关系的另一端是哪个模型。关系表明有两方, 一方是 Role, 一方是 User。</p>
<p>db.relationship() 中的 backref 参数向 User 模型(类)中<strong>添加了一个 role 属性</strong>, 它是一个 Role 的实例, 从而定义反向关系。这一属性可替代 role_id 访问 Role 模型。
注意, 这时候 User 类中的属性有 <strong>tablename</strong>、id、username、role_id、还有 role 共 5 个属性。</p>
<p>大多数情况下， db.relationship() 都能自行找到关系中的外键，但有时却无法决定把哪一列作为外键。例如，如果 User 模型中有两个或以上的列定义为 Role 模型的外键，SQLAlchemy 就不知道该使用哪列。如果无法决定外键，你就要为 db.relationship() 提供
额外参数，从而确定所用外键。表 5-4 列出了定义关系时常用的配置选项。</p>
<p><strong>表5-4　常用的SQLAlchemy关系选项</strong></p>
<table>
<thead>
<tr>
<th style="text-align:center">选项名</th>
<th style="text-align:left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">backref</td>
<td style="text-align:left">在关系的另一个模型中添加反向引用</td>
</tr>
<tr>
<td style="text-align:center">primaryjoin</td>
<td style="text-align:left">明确指定两个模型之间使用的联结条件。只在模棱两可的关系中需要指定</td>
</tr>
<tr>
<td style="text-align:center">lazy</td>
<td style="text-align:left">指定如何加载相关记录。可选值有 select （首次访问时按需加载）、 immediate （源对象加载后就加载）、 joined （加载记录，但使用联结）、 subquery （立即加载，但使用子查询），noload （永不加载）和 dynamic （不加载记录，但提供加载记录的查询）</td>
</tr>
<tr>
<td style="text-align:center">uselist</td>
<td style="text-align:left">如果设为 Fales ，不使用列表，而使用标量值</td>
</tr>
<tr>
<td style="text-align:center">order_by</td>
<td style="text-align:left">指定关系中记录的排序方式</td>
</tr>
<tr>
<td style="text-align:center">secondary</td>
<td style="text-align:left">指定多对多关系中关系表的名字</td>
</tr>
<tr>
<td style="text-align:center">secondaryjoin</td>
<td style="text-align:left">SQLAlchemy 无法自行决定时，指定多对多关系中的二级联结条件</td>
</tr>
</tbody>
</table>
<h2 id="数据库操作">数据库操作&nbsp;<a class="headline-hash no-text-decoration" href="#数据库操作">#</a> </h2>
<p>在 Python shell 中操作数据库。</p>
<h3 id="创建表">创建表&nbsp;<a class="headline-hash no-text-decoration" href="#创建表">#</a> </h3>
<p>让 Flask-SQLAlchemy 根据模型类型创建数据库。 方法是使用 <code>db.create_all()</code> 函数:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="p">(</span><span class="n">venv</span><span class="p">)</span> <span class="err">$</span> <span class="n">python</span> <span class="n">hello</span><span class="o">.</span><span class="n">py</span> <span class="n">shell</span>
</span></span><span class="line"><span class="cl"><span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">hello</span> <span class="kn">import</span> <span class="n">db</span> <span class="c1"># hello 是一个包, db 是包中的变量</span>
</span></span><span class="line"><span class="cl"><span class="o">&gt;&gt;&gt;</span> <span class="n">db</span><span class="o">.</span><span class="n">create_all</span><span class="p">()</span>
</span></span></code></pre></div><p>这会在程序的根目录下创建一个名为 data.sqlite 的数据库文件。这个数据库的名字是在配置中指定的。如果数据库表已经存在于数据库中, 那么 db.create_all() 不会重新创建或更新这个表。如果修改模型后要把改动应用到现有数据库中, 那更新<strong>现有数据库</strong>的粗暴方式是先删除旧表再重建新表:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="o">&gt;&gt;&gt;</span> <span class="n">db</span><span class="o">.</span><span class="n">drop_all</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="o">&gt;&gt;&gt;</span> <span class="n">db</span><span class="o">.</span><span class="n">create_all</span><span class="p">()</span>
</span></span></code></pre></div><p>这样会把数据库中原有的数据都销毁了。本章末尾会使用数据库迁移工具来达到更好的解决方法。</p>
<h3 id="插入行">插入行&nbsp;<a class="headline-hash no-text-decoration" href="#插入行">#</a> </h3>
<p>我们先创建一些角色和用户:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># 创建三个角色</span>
</span></span><span class="line"><span class="cl"><span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">hello</span> <span class="kn">import</span> <span class="n">Role</span><span class="p">,</span> <span class="n">User</span>
</span></span><span class="line"><span class="cl"><span class="o">&gt;&gt;&gt;</span> <span class="n">admin_role</span> <span class="o">=</span> <span class="n">Role</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Admin&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="o">&gt;&gt;&gt;</span> <span class="n">mod_role</span>   <span class="o">=</span> <span class="n">Role</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Moderator&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="o">&gt;&gt;&gt;</span> <span class="n">user_role</span>  <span class="o">=</span> <span class="n">Role</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;User&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 创建三个用户</span>
</span></span><span class="line"><span class="cl"><span class="o">&gt;&gt;&gt;</span> <span class="n">user_john</span>  <span class="o">=</span> <span class="n">User</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s1">&#39;John&#39;</span><span class="p">,</span> <span class="n">role</span><span class="o">=</span><span class="n">admin_role</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="o">&gt;&gt;&gt;</span> <span class="n">user_susan</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s1">&#39;susan&#39;</span><span class="p">,</span> <span class="n">role</span><span class="o">=</span><span class="n">user_role</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="o">&gt;&gt;&gt;</span> <span class="n">user_david</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s1">&#39;david&#39;</span><span class="p">,</span> <span class="n">role</span><span class="o">=</span><span class="n">user_role</span><span class="p">)</span>
</span></span></code></pre></div><p>模型类的构造函数接受的参数是使用<strong>关键字参数</strong>指定的模型属性的初始值。(实际上是初始化一个 role/user 对象)。注意 role 属性也可以使用, 虽然它<strong>不是真正的数据库列</strong>, 但却是一对多关系的高级表示。这些新建对象的 <strong>id属性</strong>并没有明确设定, 因为主键是由 Flask-SQLAlchemy 管理的。现在这些对象只存在于 Python 中, 还未写入数据库, 因此 id 尚未被赋值:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="o">&gt;&gt;&gt;</span> <span class="nb">print</span><span class="p">(</span><span class="n">admin_role</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kc">None</span>
</span></span><span class="line"><span class="cl"><span class="o">&gt;&gt;&gt;</span> <span class="nb">print</span><span class="p">(</span><span class="n">user_susan</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kc">None</span>
</span></span><span class="line"><span class="cl"><span class="o">...</span>
</span></span></code></pre></div><p>通过<strong>数据库会话</strong>(db.session)来管理对数据库所做的改动。在把对象写入数据库之前, 先要将这些对象添加到会话中:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="o">&gt;&gt;&gt;</span> <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">admin_role</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="o">&gt;&gt;&gt;</span> <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">mod_role</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="o">&gt;&gt;&gt;</span> <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">user_role</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="o">&gt;&gt;&gt;</span> <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">user_john</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="o">&gt;&gt;&gt;</span> <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">user_susan</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="o">&gt;&gt;&gt;</span> <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">user_david</span><span class="p">)</span>
</span></span></code></pre></div><p>或者简写为:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add_all</span><span class="p">([</span><span class="n">admin_role</span><span class="p">,</span> <span class="n">mod_role</span><span class="p">,</span> <span class="n">user_role</span><span class="p">,</span> <span class="n">user_john</span><span class="p">,</span> <span class="n">user_susan</span><span class="p">,</span> <span class="n">user_david</span><span class="p">])</span>
</span></span></code></pre></div><p>把对象添加(想想 git add)到会话中后我们还需要调用 commit() 方法<strong>提交</strong>会话(想想 git commit)：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</span></span></code></pre></div><p>提交后就会执行数据库语句, 再次查看 id 属性，现在它们已经赋值了：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="o">&gt;&gt;&gt;</span> <span class="nb">print</span><span class="p">(</span><span class="n">admin_role</span><span class="o">.</span><span class="n">id</span><span class="p">)</span> <span class="c1"># 1</span>
</span></span><span class="line"><span class="cl"><span class="o">&gt;&gt;&gt;</span> <span class="nb">print</span><span class="p">(</span><span class="n">mod_role</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>   <span class="c1"># 2</span>
</span></span><span class="line"><span class="cl"><span class="o">&gt;&gt;&gt;</span> <span class="nb">print</span><span class="p">(</span><span class="n">user_role</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>  <span class="c1"># 3</span>
</span></span></code></pre></div><p>数据库会话(session)能保证数据库的<strong>一致性</strong>。提交操作使用<strong>原子方式</strong>把会话中的对象<strong>全部</strong>写入数据库。如果在写入会话的过程中发生了错误, 那么<strong>整个会话</strong>都会失效。如果你始终把相关改动放在会话中提交, 就能避免因<strong>部分更新</strong>导致的数据库不一致性。</p>
<blockquote>
<p>数据库会话也可回滚。调用 db.session.rollback() 后, 添加到数据库会话中的所有对象都会还原到它们在数据库中时的状态。</p>
</blockquote>
<h3 id="修改行">修改行&nbsp;<a class="headline-hash no-text-decoration" href="#修改行">#</a> </h3>
<p>在<strong>数据库会话</strong>上调用 add() 方法也能更新模型。我们继续在之前的 shell 会话中进行操作:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># 把 Admin 这个角色重命名为 Administrator</span>
</span></span><span class="line"><span class="cl"><span class="o">&gt;&gt;&gt;</span> <span class="n">admin_role</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;Administrator&#39;</span> <span class="c1"># 对管理员角色进行重命名</span>
</span></span><span class="line"><span class="cl"><span class="o">&gt;&gt;&gt;</span> <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">admin_role</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="o">&gt;&gt;&gt;</span> <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span> <span class="c1"># 提交</span>
</span></span></code></pre></div><h3 id="删除行">删除行&nbsp;<a class="headline-hash no-text-decoration" href="#删除行">#</a> </h3>
<p>数据库会话中的 delete() 方法用于从数据库中删除数据(想想 git rm/delete):</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">mod_role</span><span class="p">)</span> <span class="c1"># 删除 mod_role</span>
</span></span><span class="line"><span class="cl"><span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span> <span class="c1"># 提交</span>
</span></span></code></pre></div><p>注意，删除与插入和更新一样，提交数据库会话后才会执行。</p>
<h3 id="查询行">查询行&nbsp;<a class="headline-hash no-text-decoration" href="#查询行">#</a> </h3>
<p>Flask-SQLAlchemy 为每个模型类都提供了 query 对象。最基本的模型查询是取回对应表中的所有记录:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="o">&gt;&gt;&gt;</span> <span class="n">Role</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="o">&lt;</span><span class="n">Role</span> <span class="sa">u</span><span class="s1">&#39;Administrator&#39;</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="n">Role</span> <span class="sa">u</span><span class="s1">&#39;User&#39;</span><span class="o">&gt;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="o">&gt;&gt;&gt;</span> <span class="n">User</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="o">&lt;</span><span class="n">User</span> <span class="sa">u</span><span class="s1">&#39;john&#39;</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="n">User</span> <span class="sa">u</span><span class="s1">&#39;susan&#39;</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="n">User</span> <span class="sa">u</span><span class="s1">&#39;david&#39;</span><span class="o">&gt;</span><span class="p">]</span>
</span></span></code></pre></div><p>使用<strong>过滤器</strong>可以过滤查询结果:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># 过滤列 role 为 user_role 的行</span>
</span></span><span class="line"><span class="cl"><span class="o">&gt;&gt;&gt;</span> <span class="n">User</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="n">user_role</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="o">&lt;</span><span class="n">User</span> <span class="sa">u</span><span class="s1">&#39;susan&#39;</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="n">User</span> <span class="sa">u</span><span class="s1">&#39;david&#39;</span><span class="o">&gt;</span><span class="p">]</span>
</span></span></code></pre></div><p>若要查看 SQLAlchemy 为查询生成的原生 SQL 查询语句，只需把 query 对象转换成字符串：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="nb">str</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="n">user_role</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="s1">&#39;SELECT users.id AS users_id, users.username AS users_username,users.role_id AS users_role_id FROM users WHERE :param_1 = users.role_id&#39;</span>
</span></span></code></pre></div><p>如果你退出了 Python shell 的话, 前面例子中创建的对象就不会以 Python 对象的形式存在，而是作为各自数据库表中的行存在。如果你打开了一个新的 shell 会话, 就要从数据库中读取行, 再重新创建 Python 对象。最基本的模型查询是取回对应表中的所有记录</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># 发起一个查询, 加载名为 User 的用户角色</span>
</span></span><span class="line"><span class="cl"><span class="o">&gt;&gt;&gt;</span> <span class="n">user_role</span> <span class="o">=</span> <span class="n">Role</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;User&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
</span></span></code></pre></div><p>filter_by() 等过滤器在 query 对象上调用，返回一个更精确的 query 对象。多个过滤器可以一起调用，直到获得所需结果。</p>
<p>表 5-5 列出了可在 query 对象上调用的常用过滤器。</p>
<p><strong>表5-5　常用的SQLAlchemy查询过滤器</strong></p>
<table>
<thead>
<tr>
<th style="text-align:center">过滤器</th>
<th style="text-align:left">说 明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">filter()</td>
<td style="text-align:left">把过滤器添加到原查询上，返回一个新查询</td>
</tr>
<tr>
<td style="text-align:center">filter_by()</td>
<td style="text-align:left">把等值过滤器添加到原查询上，返回一个新查询</td>
</tr>
<tr>
<td style="text-align:center">limit()</td>
<td style="text-align:left">使用指定的值限制原查询返回的结果数量，返回一个新查询</td>
</tr>
<tr>
<td style="text-align:center">offset()</td>
<td style="text-align:left">偏移原查询返回的结果，返回一个新查询</td>
</tr>
<tr>
<td style="text-align:center">order_by()</td>
<td style="text-align:left">根据指定条件对原查询结果进行排序，返回一个新查询</td>
</tr>
<tr>
<td style="text-align:center">group_by()</td>
<td style="text-align:left">根据指定条件对原查询结果进行分组，返回一个新查询</td>
</tr>
</tbody>
</table>
<p>在查询上应用指定的过滤器后, 通过调用 <code>all()</code> 执行查询, 以「列表」的形式返回结果。除了 all() 之外，还有其它方法能触发查询的执行。表 5-6 列出了执行查询的其它方法。</p>
<p><strong>表5-6　最常使用的SQLAlchemy查询执行函数</strong></p>
<table>
<thead>
<tr>
<th style="text-align:center">方 法</th>
<th style="text-align:left">说 明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">all()</td>
<td style="text-align:left">以列表形式返回查询的所有结果</td>
</tr>
<tr>
<td style="text-align:center">first()</td>
<td style="text-align:left">返回查询的第一个结果，如果没有结果，则返回 None</td>
</tr>
<tr>
<td style="text-align:center">first_or_404()</td>
<td style="text-align:left">返回查询的第一个结果，如果没有结果，则终止请求，返回 404 错误响应</td>
</tr>
<tr>
<td style="text-align:center">get()</td>
<td style="text-align:left">返回指定主键对应的行，如果没有对应的行，则返回 None</td>
</tr>
<tr>
<td style="text-align:center">get_or_404()</td>
<td style="text-align:left">返回指定主键对应的行，如果没找到指定的主键，则终止请求，返回 404 错误响应</td>
</tr>
<tr>
<td style="text-align:center">count()</td>
<td style="text-align:left">返回查询结果的数量</td>
</tr>
<tr>
<td style="text-align:center">paginate()</td>
<td style="text-align:left">返回一个 Paginate 对象，它包含指定范围内的结果</td>
</tr>
</tbody>
</table>
<p>关系和查询的处理方式类似。下面这个例子分别从关系的两端查询角色和用户之间的一对多关系:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="o">&gt;&gt;&gt;</span> <span class="n">users</span> <span class="o">=</span> <span class="n">user_role</span><span class="o">.</span><span class="n">users</span>
</span></span><span class="line"><span class="cl"><span class="o">&gt;&gt;&gt;</span> <span class="n">users</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="o">&lt;</span><span class="n">User</span> <span class="sa">u</span><span class="s1">&#39;susan&#39;</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="n">User</span> <span class="sa">u</span><span class="s1">&#39;david&#39;</span><span class="o">&gt;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="o">&gt;&gt;&gt;</span> <span class="n">users</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">role</span>
</span></span><span class="line"><span class="cl"><span class="o">&lt;</span><span class="n">Role</span> <span class="sa">u</span><span class="s1">&#39;User&#39;</span><span class="o">&gt;</span>
</span></span></code></pre></div><p>这个例子中的 user_role.users 查询有个小问题。执行 user_role.users 表达式时, 隐含的查询会调用 <code>all()</code> 函数并返回一个用户列表。 query 对象是隐藏的, 因此无法指定更精确的查询过滤器。就这个给定的示例而言, 返回一个按照字母顺序排列的用户列表可能会更好。在下面的示例中, 我们修改了关系的设置, 加入了 lazy = &lsquo;dynamic&rsquo; 参数, 以<strong>禁止自动执行查询</strong>。</p>
<p>示例 5-4 hello.py: 动态关系</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Role</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># ...</span>
</span></span><span class="line"><span class="cl">    <span class="n">users</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">relationship</span><span class="p">(</span><span class="s1">&#39;User&#39;</span><span class="p">,</span> <span class="n">backref</span><span class="o">=</span><span class="s1">&#39;role&#39;</span><span class="p">,</span> <span class="n">lazy</span><span class="o">=</span><span class="s1">&#39;dynamic&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># ...</span>
</span></span></code></pre></div><p>这样配置关系之后， user_role.roles 会返回一个<strong>尚未执行</strong>的查询，因此可以在其上添加<em>过滤器</em>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="o">&gt;&gt;&gt;</span> <span class="n">user_role</span><span class="o">.</span><span class="n">users</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">username</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="o">&lt;</span><span class="n">User</span> <span class="sa">u</span><span class="s1">&#39;david&#39;</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="n">User</span> <span class="sa">u</span><span class="s1">&#39;susan&#39;</span><span class="o">&gt;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="o">&gt;&gt;&gt;</span> <span class="n">user_role</span><span class="o">.</span><span class="n">users</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="mi">2</span>
</span></span></code></pre></div><h3 id="在视图函数中操作数据库">在视图函数中操作数据库&nbsp;<a class="headline-hash no-text-decoration" href="#在视图函数中操作数据库">#</a> </h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="nd">@app.route</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;POST&#39;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="n">form</span> <span class="o">=</span> <span class="n">NameForm</span><span class="p">()</span> <span class="c1"># 用户名表单</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">validate_on_submit</span><span class="p">():</span> <span class="c1"># 提交表单后</span>
</span></span><span class="line"><span class="cl">        <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">form</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span> <span class="c1"># 在数据库中查询当前输入的姓名</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">user</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span><span class="n">username</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">data</span><span class="p">)</span> <span class="c1"># 如果这个名字是新人, 就在数据库中新添加一个</span>
</span></span><span class="line"><span class="cl">            <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">session</span><span class="p">[</span><span class="s1">&#39;known&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span> <span class="c1"># 并在 session 中把 known 设置为假</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">session</span><span class="p">[</span><span class="s1">&#39;known&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># 否则, 用户名已存在, known 为真</span>
</span></span><span class="line"><span class="cl">        <span class="n">session</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">data</span> <span class="c1"># 把用户名保存在 session 的 name 变量中</span>
</span></span><span class="line"><span class="cl">        <span class="n">form</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span> <span class="c1"># 提交完成后清空表单的用户名</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">))</span> <span class="c1"># 重定向到主页</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;index.html&#39;</span><span class="p">,</span> <span class="n">form</span><span class="o">=</span><span class="n">form</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">),</span> <span class="n">known</span><span class="o">=</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;known&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">))</span>
</span></span></code></pre></div><p>在这个修改后的版本中，提交表单后，程序会使用 filter_by() 查询过滤器在数据库中查找提交的名字。变量 known 被写入用户会话中，因此重定向之后，可以把数据传给模板，用来显示自定义的欢迎消息。</p>
<blockquote>
<p>注意，要想让程序正常运行，你必须按照前面介绍的方法，在 Python shell 中创建数据库表。我再强调一遍如下所示：</p>
</blockquote>
<pre tabindex="0"><code>&gt;&gt;&gt; from hello import db
&gt;&gt;&gt; db.create_all()
&gt;&gt;&gt; from hello import Role, User
&gt;&gt;&gt; admin_role = Role(name=&#39;Admin&#39;)
&gt;&gt;&gt; mod_role = Role(name=&#39;Moderator&#39;)
&gt;&gt;&gt; user_role = Role(name=&#39;User&#39;)
&gt;&gt;&gt; user_john = User(username=&#39;john&#39;, role=admin_role)
&gt;&gt;&gt; user_susan = User(username=&#39;susan&#39;, role=user_role)
&gt;&gt;&gt; user_david = User(username=&#39;david&#39;, role=user_role)
&gt;&gt;&gt; db.session.add_all([admin_role, mod_role, user_role,user_john, user_susan, user_david])
&gt;&gt;&gt; db.session.commit()
</code></pre><p>对应的模板新版本如示例 5-6 所示。这个模板使用 known 参数在欢迎消息中加入第二行, 从而对<strong>已知用户</strong>和<strong>新用户</strong>显示不同的内容。</p>
<p><strong>示例 5-6 templates/index.html</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-html" data-lang="html"><span class="line"><span class="cl">{% extends &#34;base.html&#34; %}
</span></span><span class="line"><span class="cl">{% import &#34;bootstrap/wtf.html&#34; as wtf %}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">{% block title %}Flasky{% endblock %}
</span></span><span class="line"><span class="cl">{% block page_content %}
</span></span><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;page-header&#34;</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="p">&lt;</span><span class="nt">h1</span><span class="p">&gt;</span>Hello, {% if name %}{{ name }}{% else %}Strangr{% endif %}!<span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">    {% if not konwn %}
</span></span><span class="line"><span class="cl">    <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>Pleased to meet you!<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">    {% else %}
</span></span><span class="line"><span class="cl">    <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>Happy to meet you again!<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">{{ wtf.quick_form(form) }}
</span></span><span class="line"><span class="cl">{% endblock %}    
</span></span></code></pre></div><p>再说一遍,</p>
<pre tabindex="0"><code> git clone https://github.com/miguelgrinberg/flasky.git
</code></pre><p>下载官方源码后使用 <code>git checkout xx</code> 就会出现该章节对应的代码, 但是没有虚拟环境, 你需要激活虚拟环境后才能运行</p>
<pre tabindex="0"><code>python hello.py runserver --host=127.0.0.1
</code></pre><h3 id="集成-python-shell">集成 Python shell&nbsp;<a class="headline-hash no-text-decoration" href="#集成-python-shell">#</a> </h3>
<p>你在上面也看到了, 每次启动 shell 会话都要导入数据库实例(db)和模型(User, Role), 枯燥又重复。为了发挥我们的懒惰精神, 我们可以使用 Flask-Script 命令自动导入特定的对象。</p>
<p>我们来为 shell 命令注册一个 make_context 回调函数, 如示例 5-7 所示。这个模板所示。</p>
<p><strong>示例 5-7 hello.py: 为 shell 命令添加一个上下文</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">flask_script</span> <span class="kn">import</span> <span class="n">Shell</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">make_shell_context</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">app</span><span class="o">=</span><span class="n">app</span><span class="p">,</span> <span class="n">db</span><span class="o">=</span><span class="n">db</span><span class="p">,</span> <span class="n">User</span><span class="o">=</span><span class="n">User</span><span class="p">,</span> <span class="n">Role</span><span class="o">=</span><span class="n">Role</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">manager</span><span class="o">.</span><span class="n">add_command</span><span class="p">(</span><span class="s2">&#34;shell&#34;</span><span class="p">,</span> <span class="n">Shell</span><span class="p">(</span><span class="n">make_context</span><span class="o">=</span><span class="n">make_shell_context</span><span class="p">))</span>
</span></span></code></pre></div><p>make_shell_context() 函数注册了程序(app)、数据库实例(app)、模型(User, Role), 因此这些对象能直接导入 shell：</p>
<pre tabindex="0"><code>$ python hello.py shell
&gt;&gt;&gt; app 
&lt;Flask &#39;hello&#39;&gt;
&gt;&gt;&gt; db
&lt;SQLAlchemy engine=&#39;sqlite:////home/flask/flasky/data.sqlite&#39;&gt;
&gt;&gt;&gt; User
&lt;class &#39;app.User&#39;&gt;
</code></pre><p>这时你启动 hello.py, 输入名字进行查询, 如果数据库中已存在该名字网页就会显示：</p>
<pre tabindex="0"><code>hello, xxx
Happy to see you again!
</code></pre><p>如果该名字是首次被查询, 则会显示：</p>
<pre tabindex="0"><code>Hello, xxxxxx!
Pleased to meet you!
</code></pre><p>同时你在 Python shell 中可以查询数据库中是否已经插入了新值：</p>
<pre tabindex="0"><code>&gt;&gt;&gt; User.query.all()
[&lt;User &#39;john&#39;&gt;, &lt;User &#39;susan&#39;&gt;, &lt;User &#39;david&#39;&gt;, &lt;User &#39;chenyf&#39;&gt;, &lt;User &#39;xxxxxx&#39;&gt;]
</code></pre><p>你也可以在这时把 Python shell 停掉, 然后提交网页, 也能正常运行。因为数据库中已经存在了相关的表了。如果先启动 hello.py 就进行查询会出现内部服务器错误, 因为数据库还没有准备好(里面什么也没有)。命令行中的 debug 信息显示 <code>no such table</code>。所以：</p>
<blockquote>
<p>注意， 在启动 hello.py 程序之前执行 python hello.py shell 初始化数据库, 实例化 Role 和 User 时就会创建roles表和 users 表。</p>
</blockquote>
<p>所以</p>
<pre tabindex="0"><code>$ python hello.py shell
&gt;&gt;&gt; admin_role = Role(name=&#39;Admin&#39;)
&gt;&gt;&gt; mod_role = Role(name=&#39;Moderator&#39;)
&gt;&gt;&gt; user_role = Role(name=&#39;User&#39;)
&gt;&gt;&gt; user_john = User(username=&#39;john&#39;, role=admin_role)
&gt;&gt;&gt; user_susan = User(username=&#39;susan&#39;, role=user_role)
&gt;&gt;&gt; user_david = User(username=&#39;david&#39;, role=user_role)
&gt;&gt;&gt; db.session.add_all([admin_role, mod_role, user_role,user_john, user_susan, user_david])
&gt;&gt;&gt; db.session.commit()
&gt;&gt;&gt; User.query.all()
[&lt;User &#39;john&#39;&gt;, &lt;User &#39;susan&#39;&gt;, &lt;User &#39;david&#39;&gt;]
</code></pre><h2 id="使用-flask-migrate-实现数据库迁移">使用 Flask-Migrate 实现数据库迁移&nbsp;<a class="headline-hash no-text-decoration" href="#使用-flask-migrate-实现数据库迁移">#</a> </h2>
<p>在开发程序的过程中, 你会发现有时候需要修改数据库模型(如为 User 增加 age 属性), 而且修改之后还需要更新数据库。</p>
<p>仅当数据库表不存在时, Flask-SQLAlchemy 才会根据模型进行创建。因此, 更新表的<strong>唯一</strong>方式就是先删除旧表, 不过这样会丢失数据库中的所有数据, 傻狍子才这样做。</p>
<p><strong>更新表</strong>的更好的方法是使用<em>数据库迁移</em>框架。源码版本控制工具(例如 git)可以跟踪源码文件的变化, 类似地, 数据库迁移框架能跟踪<strong>数据库模式的变化</strong>, 然后<strong>增量式</strong>的把变化应用到数据库中。</p>
<p>SQLAlchemy 的主力开发人员编写了一个迁移框架，称为 <a href="https://alembic.readthedocs.org/en/latest/index.html">Alembic</a>。除了直接使用 Alembic 之外，Flask 程序还可使用 <a href="http://flask-migrate.readthedocs.org/en/latest/">Flask-Migrate</a> 扩展。这个扩展对 Alembic 做了轻量级包装，并集成到 Flask-Script 中，所有操作都通过 Flask-Script 命令完成。</p>
<h3 id="创建迁移仓库">创建迁移仓库&nbsp;<a class="headline-hash no-text-decoration" href="#创建迁移仓库">#</a> </h3>
<p>首先在虚拟环境中安装 Flask-Migrate：</p>
<pre tabindex="0"><code>$ venv\Scripts\activate
$ pip install Flask-Migrate
</code></pre><p>这个扩展的初始化方法如下所示：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">flask_migrate</span> <span class="kn">import</span> <span class="n">Migrate</span><span class="p">,</span> <span class="n">MigrateCommand</span>
</span></span><span class="line"><span class="cl"><span class="c1"># ...</span>
</span></span><span class="line"><span class="cl"><span class="n">migrate</span> <span class="o">=</span> <span class="n">Migrate</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">db</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">manager</span><span class="o">.</span><span class="n">add_command</span><span class="p">(</span><span class="s1">&#39;db&#39;</span><span class="p">,</span> <span class="n">MigrateCommand</span><span class="p">)</span>
</span></span></code></pre></div><p>为了导出数据库迁移命令, Flask-Migrate 提供了一个 MigrateCommand 类, 可附加到 Flask-Script 的 manager 对象上。在这里, MigrateCommand 类使用 db 命令附加。是不是很熟悉, 我们刚见过：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">manager</span><span class="o">.</span><span class="n">add_command</span><span class="p">(</span><span class="s2">&#34;shell&#34;</span><span class="p">,</span> <span class="n">Shell</span><span class="p">(</span><span class="n">make_context</span><span class="o">=</span><span class="n">make_shell_context</span><span class="p">))</span>
</span></span></code></pre></div><p>在维护数据库迁移之前, 要使用 init 子命令创建迁移仓库:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="p">(</span><span class="n">venv</span><span class="p">)</span> <span class="err">$</span> <span class="n">python</span> <span class="n">hello</span><span class="o">.</span><span class="n">py</span> <span class="n">db</span> <span class="n">init</span>
</span></span><span class="line"><span class="cl"><span class="n">Creating</span> <span class="n">directory</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">flask</span><span class="o">/</span><span class="n">flasky</span><span class="o">/</span><span class="n">migrations</span><span class="o">...</span><span class="n">done</span>
</span></span><span class="line"><span class="cl"><span class="n">Creating</span> <span class="n">directory</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">flask</span><span class="o">/</span><span class="n">flasky</span><span class="o">/</span><span class="n">migrations</span><span class="o">/</span><span class="n">versions</span><span class="o">...</span><span class="n">done</span>
</span></span><span class="line"><span class="cl"><span class="n">Generating</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">flask</span><span class="o">/</span><span class="n">flasky</span><span class="o">/</span><span class="n">migrations</span><span class="o">/</span><span class="n">alembic</span><span class="o">.</span><span class="n">ini</span><span class="o">...</span><span class="n">done</span>
</span></span><span class="line"><span class="cl"><span class="n">Generating</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">flask</span><span class="o">/</span><span class="n">flasky</span><span class="o">/</span><span class="n">migrations</span><span class="o">/</span><span class="n">env</span><span class="o">.</span><span class="n">py</span><span class="o">...</span><span class="n">done</span>
</span></span><span class="line"><span class="cl"><span class="n">Generating</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">flask</span><span class="o">/</span><span class="n">flasky</span><span class="o">/</span><span class="n">migrations</span><span class="o">/</span><span class="n">env</span><span class="o">.</span><span class="n">pyc</span><span class="o">...</span><span class="n">done</span>
</span></span><span class="line"><span class="cl"><span class="n">Generating</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">flask</span><span class="o">/</span><span class="n">flasky</span><span class="o">/</span><span class="n">migrations</span><span class="o">/</span><span class="n">README</span><span class="o">...</span><span class="n">done</span>
</span></span><span class="line"><span class="cl"><span class="n">Generating</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">flask</span><span class="o">/</span><span class="n">flasky</span><span class="o">/</span><span class="n">migrations</span><span class="o">/</span><span class="n">script</span><span class="o">.</span><span class="n">py</span><span class="o">.</span><span class="n">mako</span><span class="o">...</span><span class="n">done</span>
</span></span><span class="line"><span class="cl"><span class="n">Please</span> <span class="n">edit</span> <span class="n">configuration</span><span class="o">/</span><span class="n">connection</span><span class="o">/</span><span class="n">logging</span> <span class="n">settings</span> <span class="ow">in</span>
</span></span><span class="line"><span class="cl"><span class="s1">&#39;/home/flask/flasky/migrations/alembic.ini&#39;</span> <span class="n">before</span> <span class="n">proceeding</span><span class="o">.</span>
</span></span></code></pre></div><p>这个命令会创建一个 migrations 文件夹，所有「迁移脚本」都存放其中</p>
<blockquote>
<p>数据库迁移仓库中的文件要和程序的其他文件一起纳入版本控制。</p>
</blockquote>
<h3 id="创建迁移脚本">创建迁移脚本&nbsp;<a class="headline-hash no-text-decoration" href="#创建迁移脚本">#</a> </h3>
<p>在 Alembic 中, 数据库迁移用<em>迁移脚本</em>表示。脚本中有两个<strong>函数</strong>, 分别是 <code>upgrade()</code> 和 <code>downgrade()</code>。 upgrade() 函数把迁移中的改动应用到数据库中, downgrade() 函数则将改动<strong>删除</strong>。Alembic 具有「添加改动」和「删除改动」的能力, 因此数据库可重设到修改历史的<strong>任意一点</strong>。</p>
<p>我们可以使用 revision 命令手动创建 Alembic 迁移, 也可使用 migrate 命令自动创建。手动创建的迁移只是一个骨架, upgrade() 和 downgrade() 函数都是<strong>空的</strong>, 开发者要使用 Alembic 提供的 Operations 对象指令实现具体操作。自动创建的迁移会根据模型定义和<strong>数据库当前状态</strong>之间的「差异」生成 upgrade() 和 downgrade() 函数的内容。</p>
<blockquote>
<p>自动创建的迁移不一定总是正确的，有可能会漏掉一些细节。自动生成迁移脚本后一定要进行检查。</p>
</blockquote>
<p>migrate 子命令用来<strong>自动</strong>创建迁移脚本:</p>
<pre tabindex="0"><code>(venv) $ python hello.py db migrate -m &#34;initial migration&#34;
INFO [alembic.migration] Context impl SQLiteImpl.
INFO [alembic.migration] Will assume non-transactional DDL.
INFO [alembic.autogenerate] Detected added table &#39;roles&#39;
INFO [alembic.autogenerate] Detected added table &#39;users&#39;
INFO [alembic.autogenerate.compare] Detected added index
&#39;ix_users_username&#39; on &#39;[&#39;username&#39;]&#39;
Generating /home/flask/flasky/migrations/versions/1bc
594146bb5_initial_migration.py...done
</code></pre><h3 id="更新数据库">更新数据库&nbsp;<a class="headline-hash no-text-decoration" href="#更新数据库">#</a> </h3>
<p>检查并修正好迁移脚本之后, 我们可以使用 <code>db upgrade</code> 命令<strong>把迁移应用到数据库中</strong>：</p>
<pre tabindex="0"><code>(venv) $ python hello.py db upgrade
INFO [alembic.migration] Context impl SQLiteImpl.
INFO [alembic.migration] Will assume non-transactional DDL.
INFO [alembic.migration] Running upgrade None -&gt; 1bc594146bb5, initial migration
</code></pre><p>对第一个迁移来说, 其作用和调用 <code>db.create_all()</code> 方法一样。但在<strong>后续</strong>的迁移中, upgrade 命令能把改动应用到数据库中, 且不影响其中保存的数据。</p>


        </div>
    </div>
</article>



                <footer>
                    




<div class="no-text-decoration">
    <div class="jump top"><a href="#" title="Top of this page">⮉</a></div>
    <div class="jump bottom"><a href="#bottom" title="Bottom of this page">⮋</a></div>
</div>


 
    
        <div class="hugotoc no-text-decoration">
            <nav id="TableOfContents">
  <ul>
    <li><a href="#sql-数据库">SQL 数据库</a></li>
    <li><a href="#nosql-数据库">NoSQL 数据库</a></li>
    <li><a href="#使用sql还是nosql">使用SQL还是NoSQL</a></li>
    <li><a href="#python-数据库框架-flask-sqlalchemy">Python 数据库框架 Flask-SQLAlchemy</a></li>
    <li><a href="#定义模型">定义模型</a></li>
    <li><a href="#关系">关系</a></li>
    <li><a href="#数据库操作">数据库操作</a>
      <ul>
        <li><a href="#创建表">创建表</a></li>
        <li><a href="#插入行">插入行</a></li>
        <li><a href="#修改行">修改行</a></li>
        <li><a href="#删除行">删除行</a></li>
        <li><a href="#查询行">查询行</a></li>
        <li><a href="#在视图函数中操作数据库">在视图函数中操作数据库</a></li>
        <li><a href="#集成-python-shell">集成 Python shell</a></li>
      </ul>
    </li>
    <li><a href="#使用-flask-migrate-实现数据库迁移">使用 Flask-Migrate 实现数据库迁移</a>
      <ul>
        <li><a href="#创建迁移仓库">创建迁移仓库</a></li>
        <li><a href="#创建迁移脚本">创建迁移脚本</a></li>
        <li><a href="#更新数据库">更新数据库</a></li>
      </ul>
    </li>
  </ul>
</nav>
            <a href="#" class="back-to-top">Back to top</a>
        </div>
    
    
<script src="/js/libs/jquery/3.3.1/jquery.slim.min.min.22ee3db0c0e99fd0fbce3aee19672bd53d25469daf734bd4c165649f6eaf7d7f.js"></script>

<link rel="preload" href="/js/libs/jquery/3.3.1/jquery.slim.min.min.22ee3db0c0e99fd0fbce3aee19672bd53d25469daf734bd4c165649f6eaf7d7f.js" as="script">

<script type="application/javascript">(function() {
     var $window = $(window);
     if ($window.width() >= 1400) { 
         var $toc = $('#TableOfContents');
         if ($toc.length > 0) {
             function onScroll(){
                 var currentScroll = $window.scrollTop();
                 var h = $('.content h1, .content h2, .content h3, .content h4, .content h5, .content h6, .h-feed h2');
                 var id = "";
                 h.each(function (i, e) {
                     e = $(e);
                     if (e.offset().top - 10 <= currentScroll) {
                         id = e.attr('id');
                     }
                 });
                 var current = $toc.find('a.current');
                 if (current.length == 1 && current.eq(0).attr('href') == '#' + id) return true;

                 current.each(function (i, e) {
                     $(e).removeClass('current').siblings('ul').hide();
                 });
                 $toc.find('a[href="#' + id + '"]').parentsUntil('#TableOfContents').each(function (i, e) {
                     $(e).children('a').addClass('current').siblings('ul').show();
                 });
             }
             $window.on('scroll', onScroll);
             $(document).ready(function() {
                 $toc.find('a').parent('li').find('ul').hide();
                 onScroll();
                 document.getElementsByClassName('hugotoc')[0].style.display = '';
             });}}})();</script>








<div class="backtotop center no-text-decoration">
    <a href="#">back to <span class="top">top</span></a>
</div>


<div class="right">
    <div class="taxo no-text-decoration">
         
            
                <ul class="no-bullets inline categories">
                    
                        
                        
                        
                            
                            
                            
                            
                            
                            <li class="__rakulang__"
                                
                                
                                title="See all 0 posts categorized in ‘rakulang’"
                                
                            >
                                <a class="p-category" href="https://ohmycloud.github.io/categories/rakulang/">rakulang</a>
                            </li>
                        
                    
                </ul>
            
         
            
                <ul class="no-bullets inline tags">
                    
                        
                        
                        
                            
                            
                            
                            
                            
                            <li class="__rakulang__"
                                
                                
                                title="See all 0 posts tagged with ‘rakulang’"
                                
                            >
                                <a class="p-category" href="https://ohmycloud.github.io/tags/rakulang/">rakulang</a>
                            </li>
                        
                    
                </ul>
            
        
    </div>

</div>
<div class="clear-float"></div>



<div class="prev-next-navigator clear-float">
    
        <span class="prev-post left no-text-decoration">
            <a href="https://ohmycloud.github.io/notes/%E7%AC%AC%E5%85%AD%E7%AB%A0-%E7%94%B5%E5%AD%90%E9%82%AE%E4%BB%B6/" class="nobr">« Flask 入门 - 电子邮件</a>
        </span>
    
    
        <span class="next-post right no-text-decoration">
            <a href="https://ohmycloud.github.io/notes/%E7%AC%AC%E4%BA%8C%E7%AB%A0-app-%E7%9A%84%E5%9F%BA%E6%9C%AC%E7%BB%93%E6%9E%84/" class="nobr">Flask 入门 - app 的基本结构 »</a>
        </span>
    
</div>


<a id="bottom"></a>









                       







                    <ul class="no-bullets feed right inline">
    
        
        
    
</ul>
<div class="clear-float"></div>

                </footer>
                <hr />
            </div>               

            <footer> 
                

<ul class="social no-text-decoration">
    
</ul>










 
    
    



<p class="generated no-text-decoration">
    Generated using  <a href="https://gitlab.com/kaushalmodi/hugo-theme-refined"><code class="nobr">hugo-theme-refined</code></a> + <span class="nobr">Hugo <a href="https://github.com/gohugoio/hugo/commit/312735366b20d64bd61bff8627f593749f86c964">0.123.7</a></span>
</p>

<p>
    
</p>




<div class="badges no-text-decoration">
    
    

    
</div>




<script type="application/javascript">var nav=responsiveNav("#nav");</script>




<script defer src="/js/libs/fragmentions/wrapper.min.e8c468c89edc4f5dccaa8c720c6b220b3088a16cd7b1e4a1e3345985788260c9.js"></script>









            </footer>
        </div> 
    </body>
</html>
