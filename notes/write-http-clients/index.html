<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-us" lang="en-us">

    <head>
    <link href="https://gmpg.org/xfn/11" rel="profile">
    <meta charset="utf-8">
    
    
    

    
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5">

    
    <meta name="referrer" content="no-referrer">

    <title>
        
            编写HTTP客户端和服务器 ❚ 焉知非鱼
        
    </title>

    
    


    
    
    
    

    
    
    
    

    
    
    

    
    
    
    <style>
     
     
     :root {
         --theme-color: #ac4142;
         --theme-color-light: rgba(172, 65, 66, 0.2);
     }
     
     html {
         line-height: 1.5;
     }
    </style>

    
    

    
    
    
    
    <link rel="stylesheet" href="/css/refined.min.61b1de55623520dab99b70e9e2298001fb97241583a47396e2f10feb789e300d.css">
    
    <link rel="preload" href="/css/refined.min.61b1de55623520dab99b70e9e2298001fb97241583a47396e2f10feb789e300d.css" as="style">

    



    
        <style>
         
         /* Background */ .chroma { background-color: #ffffff }
/* Error */ .chroma .err { color: #a61717; background-color: #e3d2d2 }
/* LineTableTD */ .chroma .lntd { vertical-align: top; padding: 0; margin: 0; border: 0; }
/* LineTable */ .chroma .lntable { border-spacing: 0; padding: 0; margin: 0; border: 0; width: auto; overflow: auto; display: block; }
/* LineHighlight */ .chroma .hl { display: block; width: 100%;background-color: #ffffcc }
/* LineNumbersTable */ .chroma .lnt { margin-right: 0.4em; padding: 0 0.4em 0 0.4em; }
/* LineNumbers */ .chroma .ln { margin-right: 0.4em; padding: 0 0.4em 0 0.4em; }
/* Keyword */ .chroma .k { color: #000000; font-weight: bold }
/* KeywordConstant */ .chroma .kc { color: #000000; font-weight: bold }
/* KeywordDeclaration */ .chroma .kd { color: #000000; font-weight: bold }
/* KeywordNamespace */ .chroma .kn { color: #000000; font-weight: bold }
/* KeywordPseudo */ .chroma .kp { color: #000000; font-weight: bold }
/* KeywordReserved */ .chroma .kr { color: #000000; font-weight: bold }
/* KeywordType */ .chroma .kt { color: #445588; font-weight: bold }
/* NameAttribute */ .chroma .na { color: #008080 }
/* NameBuiltin */ .chroma .nb { color: #0086b3 }
/* NameBuiltinPseudo */ .chroma .bp { color: #999999 }
/* NameClass */ .chroma .nc { color: #445588; font-weight: bold }
/* NameConstant */ .chroma .no { color: #008080 }
/* NameDecorator */ .chroma .nd { color: #3c5d5d; font-weight: bold }
/* NameEntity */ .chroma .ni { color: #800080 }
/* NameException */ .chroma .ne { color: #990000; font-weight: bold }
/* NameFunction */ .chroma .nf { color: #990000; font-weight: bold }
/* NameLabel */ .chroma .nl { color: #990000; font-weight: bold }
/* NameNamespace */ .chroma .nn { color: #555555 }
/* NameTag */ .chroma .nt { color: #000080 }
/* NameVariable */ .chroma .nv { color: #008080 }
/* NameVariableClass */ .chroma .vc { color: #008080 }
/* NameVariableGlobal */ .chroma .vg { color: #008080 }
/* NameVariableInstance */ .chroma .vi { color: #008080 }
/* LiteralString */ .chroma .s { color: #dd1144 }
/* LiteralStringAffix */ .chroma .sa { color: #dd1144 }
/* LiteralStringBacktick */ .chroma .sb { color: #dd1144 }
/* LiteralStringChar */ .chroma .sc { color: #dd1144 }
/* LiteralStringDelimiter */ .chroma .dl { color: #dd1144 }
/* LiteralStringDoc */ .chroma .sd { color: #dd1144 }
/* LiteralStringDouble */ .chroma .s2 { color: #dd1144 }
/* LiteralStringEscape */ .chroma .se { color: #dd1144 }
/* LiteralStringHeredoc */ .chroma .sh { color: #dd1144 }
/* LiteralStringInterpol */ .chroma .si { color: #dd1144 }
/* LiteralStringOther */ .chroma .sx { color: #dd1144 }
/* LiteralStringRegex */ .chroma .sr { color: #009926 }
/* LiteralStringSingle */ .chroma .s1 { color: #dd1144 }
/* LiteralStringSymbol */ .chroma .ss { color: #990073 }
/* LiteralNumber */ .chroma .m { color: #009999 }
/* LiteralNumberBin */ .chroma .mb { color: #009999 }
/* LiteralNumberFloat */ .chroma .mf { color: #009999 }
/* LiteralNumberHex */ .chroma .mh { color: #009999 }
/* LiteralNumberInteger */ .chroma .mi { color: #009999 }
/* LiteralNumberIntegerLong */ .chroma .il { color: #009999 }
/* LiteralNumberOct */ .chroma .mo { color: #009999 }
/* Operator */ .chroma .o { color: #000000; font-weight: bold }
/* OperatorWord */ .chroma .ow { color: #000000; font-weight: bold }
/* Comment */ .chroma .c { color: #999988; font-style: italic }
/* CommentHashbang */ .chroma .ch { color: #999988; font-style: italic }
/* CommentMultiline */ .chroma .cm { color: #999988; font-style: italic }
/* CommentSingle */ .chroma .c1 { color: #999988; font-style: italic }
/* CommentSpecial */ .chroma .cs { color: #999999; font-weight: bold; font-style: italic }
/* CommentPreproc */ .chroma .cp { color: #999999; font-weight: bold; font-style: italic }
/* CommentPreprocFile */ .chroma .cpf { color: #999999; font-weight: bold; font-style: italic }
/* GenericDeleted */ .chroma .gd { color: #000000; background-color: #ffdddd }
/* GenericEmph */ .chroma .ge { color: #000000; font-style: italic }
/* GenericError */ .chroma .gr { color: #aa0000 }
/* GenericHeading */ .chroma .gh { color: #999999 }
/* GenericInserted */ .chroma .gi { color: #000000; background-color: #ddffdd }
/* GenericOutput */ .chroma .go { color: #888888 }
/* GenericPrompt */ .chroma .gp { color: #555555 }
/* GenericStrong */ .chroma .gs { font-weight: bold }
/* GenericSubheading */ .chroma .gu { color: #aaaaaa }
/* GenericTraceback */ .chroma .gt { color: #aa0000 }
/* GenericUnderline */ .chroma .gl { text-decoration: underline }
/* TextWhitespace */ .chroma .w { color: #bbbbbb }

         
         /* Overrides on top of the theme and Chroma CSS */
/* Chroma-based lines highlighting in code blocks */
.chroma .hl {
    background-color: #e8e8e8;
    /* Extend highlight up to 100 characters (assuming that the code blocks never have more than 100 characters in a line) */
    min-width: 100ch;
}
/* GenericHeading */ .chroma .gh { color: #999999; font-weight: bold }
/* GenericSubheading */ .chroma .gu { color: #aaaaaa; font-weight: bold }

         
        </style>
    

    

    
    
    

    
    <script src="/js/responsive-nav-orig.min.355eebd835ac8071d56b337f68ffbbddc0f6487625599895e3e0b0461e791ebb.js"></script>
    
    <link rel="preload" href="/js/responsive-nav-orig.min.355eebd835ac8071d56b337f68ffbbddc0f6487625599895e3e0b0461e791ebb.js" as="script">

    
    
    <script defer src="/js/libs/fa/fontawesome-all.min.78bd3583027f40ce4330d39e1f1df56bda5f4af819aac2d0214ba529918c9e95.js"></script>
    
    <link rel="preload" href="/js/libs/fa/fontawesome-all.min.78bd3583027f40ce4330d39e1f1df56bda5f4af819aac2d0214ba529918c9e95.js" as="script">

    

    

    
    
    

    
    
<!-- rel="me" links for IndieAuth -->







    
 
<meta property="og:title" content="编写HTTP客户端和服务器" />
<meta property="og:description"
      content="Write HTTP clients &amp;amp; servers" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://ohmyweekly.github.io/notes/write-http-clients/" />


    
        <meta property="article:published_time" content="2020-06-30T00:00:00&#43;08:00"/>
    
    
        <meta property="article:modified_time" content="2020-06-30T00:00:00&#43;08:00"/>
    









    




     <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="编写HTTP客户端和服务器"/>
<meta name="twitter:description" content="Write HTTP clients &amp;amp; servers"/>


    
    
    <link rel="alternate" type="application/jf2post+json" href="https://ohmyweekly.github.io/notes/write-http-clients/jf2post.json" title="Jf2post for 焉知非鱼" />
    
     



    
    
    
        
    


     
        
        <meta name="DC.Creator" content="焉知非鱼"/>
    



    
    
    
    <meta name="hugo-build-date" content=""/>
    <meta name="hugo-commit-hash" content=""/>
    <meta name="generator" content="Hugo 0.63.2" />
</head>


    
        <body lang="en">
    

        
        <div class="border" id="home"></div>

        <div class="wrapper">   
            
<nav id="nav" class="nav-collapse opened" aria-hidden="false">
    <ul class="navbar">
        <li><a class="" href="/">Home</a></li>
        
            
                <li><a class="" href="https://ohmyweekly.github.io/posts/">Posts</a></li>
            
        
            
                <li><a class="" href="https://ohmyweekly.github.io/notes/">Notes</a></li>
            
        
        
            <li><a class="" href="https://ohmyweekly.github.io/search/">Search</a></li>
        
    </ul>
</nav>

            <div class="container">
                <header class="masthead">
                    <div class="masthead-title no-text-decoration">
                        <a href="/">焉知非鱼</a> <span class="blinking-cursor">❚</span>
                    </div>
                    <div class="masthead-tagline">
                        rakulang, dartlang, nimlang, golang, rustlang, lang lang no see
                    </div>
                </header>

                








<article class="post h-entry notes">
    <header>
        <div class="center">
    <div class="taxo no-text-decoration">
         
            
                <ul class="no-bullets inline categories">
                    
                        
                        
                        
                            
                            
                            
                            
                            
                            <li class="__programming__"
                                
                                
                                title="See all 22 posts categorized in ‘programming’"
                                
                            >
                                <a class="p-category" href="https://ohmyweekly.github.io/categories/programming/">programming</a>
                            </li>
                        
                    
                </ul>
            
         
            
                <ul class="no-bullets inline tags">
                    
                        
                        
                        
                            
                            
                            
                            
                            
                            <li class="__flutter__"
                                
                                
                                title="See all 7 posts tagged with ‘flutter’"
                                
                            >
                                <a class="p-category" href="https://ohmyweekly.github.io/tags/flutter/">flutter</a>
                            </li>
                        
                    
                        
                        
                        
                            
                            
                            
                            
                            
                            <li class="__client__"
                                
                                
                                title="This is the only post tagged with ‘client’"
                                
                            >
                                <a class="p-category" href="https://ohmyweekly.github.io/tags/client/">client</a>
                            </li>
                        
                    
                </ul>
            
        
    </div>

</div>

        <h1 class="post-title p-name">编写HTTP客户端和服务器</h1>

        
        <data class="u-url" value="https://ohmyweekly.github.io/notes/write-http-clients/"></data>

        <div class="date-syndication">
            


    
    
    <div class="post-date">
        
        <time datetime="2020-06-30T00:00:00+0800" class="dt-published">Tue Jun 30, 2020</time>
        
        
    </div>


            




        </div>
         



    
    
    
        
    


    
        
        <span class="hide">
            &mdash; <a href="https://ohmyweekly.github.io" class="u-author">焉知非鱼</a>
        </span>
    


    </header>

    <div class="content">
        
    <div class="description p-summary">
        
        
        
        
        
            
            
        
        <p>Write HTTP clients &amp; servers</p>
    </div>



        





                       


        <div class="e-content">
            




<p>有什么意义呢？</p>
<ul>
<li>HTTP 协议允许客户端和服务器进行通信。</li>
<li>dart:io 包有编写 HTTP 程序的类。</li>
<li>服务器监听主机和端口上的请求。</li>
<li>客户端使用 HTTP 方法请求发送请求。</li>
<li>http_server 包提供了更高级别的构件。</li>
</ul>
<p>前提条件: HTTP 服务器和客户端严重依赖 future 和流，本教程中没有解释这些内容。你可以从<a href="https://dart.dev/codelabs/async-await">异步编程 codelab</a>和<a href="https://dart.dev/tutorials/language/streams">流教程</a>中了解它们。</p>
<p>HTTP（超文本传输协议）是一种通信协议，用于通过互联网将数据从一个程序发送到另一个程序。数据传输的一端是服务器，另一端是客户端。客户端通常是基于浏览器的（用户在浏览器中输入或在浏览器中运行的脚本），但也可能是一个独立的程序。</p>
<p>服务器与主机和端口绑定（它与一个IP地址和一个端口号建立专属连接）。然后服务器监听请求。由于 Dart 的异步性，服务器可以同时处理很多请求，具体如下。</p>
<ul>
<li>服务器监听</li>
<li>客户端连接</li>
<li>服务器接受并接收请求(并继续监听)</li>
<li>服务器可以继续接受其他请求</li>
<li>服务器写入请求的响应或几个请求，可能是交错的请求</li>
<li>服务器最终结束(关闭)响应</li>
</ul>
<p>在 Dart 中，<a href="https://api.dart.dev/stable/dart-io/dart-io-library.html">dart:io</a> 库包含了编写 HTTP 客户端和服务器所需的类和函数。此外，<a href="https://pub.dev/packages/http_server">http_server</a> 包包含了一些更高层次的类，使其更容易编写客户端和服务器。</p>
<p>重要：基于浏览器的程序不能使用 dart:io 库。</p>
<p>dart:io 库中的 API 只适用于独立的命令行程序。它们不能在浏览器中工作。要从基于浏览器的客户端发出 HTTP 请求，请参考 <a href="https://api.dart.dev/stable/dart-html/HttpRequest-class.html">dart:html HttpRequest</a> 类。</p>
<p>本教程提供了几个例子，说明编写 Dart HTTP 服务器和客户端是多么容易。从服务器的 <code>hello world</code> 开始，你将学习如何编写服务器的代码，从绑定和监听到响应请求。你还可以学习到客户端：提出不同类型的请求(GET 和 POST)，编写基于浏览器和命令行的客户端。</p>
<h2 id="获取源码">获取源码&nbsp;<a class="headline-hash no-text-decoration" href="#获取源码">#</a> </h2>
<ul>
<li>获取 Dart 教程的<a href="https://github.com/dart-lang/dart-tutorials-samples/archive/master.zip">示例代码</a>。</li>
<li>查看 <code>httpserver</code> 目录，其中包含本教程所需的源码。</li>
</ul>
<h2 id="运行-hello-world-服务器">运行 hello world 服务器&nbsp;<a class="headline-hash no-text-decoration" href="#运行-hello-world-服务器">#</a> </h2>
<p>本节的示例文件：<a href="https://github.com/dart-lang/site-www/blob/master/examples/httpserver/bin/hello_world_server.dart">hello_world_server.dart</a>。</p>
<p>让我们从一个小型的服务器开始，用字符串 <code>Hello, world</code> 来响应所有的请求。</p>
<p>在命令行中，运行 <code>hello_world_server.dart</code> 脚本:</p>
<div class="highlight"><pre class="chroma"><code class="language-dart" data-lang="dart"><span class="n">$</span> <span class="n">cd</span> <span class="n">httpserver</span>
<span class="n">$</span> <span class="n">dart</span> <span class="n">bin</span><span class="o">/</span><span class="n">hello_world_server</span><span class="p">.</span><span class="n">dart</span>
<span class="n">listening</span> <span class="n">on</span> <span class="n">localhost</span><span class="p">,</span> <span class="n">port</span> <span class="m">4040</span>
</code></pre></div><p>在任何浏览器中，访问 <a href="http://localhost:4040/">localhost:4040</a>。浏览器会显示 <code>Hello, world!</code>。</p>
<p><img src="https://dart.dev/tutorials/server/images/hello_world_response.png" alt="img"></p>
<p>在这种情况下，服务器是一个 Dart 程序，客户端是你使用的浏览器。然而，你可以用 Dart 编写客户端程序-无论是基于浏览器的客户端脚本，还是独立的程序。</p>
<h3 id="快速浏览一下代码">快速浏览一下代码&nbsp;<a class="headline-hash no-text-decoration" href="#快速浏览一下代码">#</a> </h3>
<p>在 <code>hello world</code> 服务器的代码中，一个 HTTP 服务器与主机和端口绑定，监听 HTTP 请求，并写入响应。需要注意的是，该程序导入了 <a href="https://api.dart.dev/stable/dart-io/dart-io-library.html">dart:io</a> 库，其中包含了服务器端程序和客户端程序的 HTTP 相关类(但不包含 Web 应用)。</p>
<div class="highlight"><pre class="chroma"><code class="language-dart" data-lang="dart"><span class="k">import</span> <span class="s1">&#39;</span><span class="s1">dart:io</span><span class="s1">&#39;</span><span class="p">;</span>

<span class="n">Future</span> <span class="n">main</span><span class="p">(</span><span class="p">)</span> <span class="kd">async</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="n">server</span> <span class="o">=</span> <span class="kd">await</span> <span class="n">HttpServer</span><span class="p">.</span><span class="n">bind</span><span class="p">(</span>
    <span class="n">InternetAddress</span><span class="p">.</span><span class="n">loopbackIPv4</span><span class="p">,</span>
    <span class="m">4040</span><span class="p">,</span>
  <span class="p">)</span><span class="p">;</span>
  <span class="n">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="s1">Listening on localhost:</span><span class="si">${</span><span class="n">server</span><span class="p">.</span><span class="n">port</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span><span class="p">;</span>

  <span class="kd">await</span> <span class="k">for</span> <span class="p">(</span><span class="n">HttpRequest</span> <span class="n">request</span> <span class="k">in</span> <span class="n">server</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">request</span><span class="p">.</span><span class="n">response</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="s1">Hello, world!</span><span class="s1">&#39;</span><span class="p">)</span><span class="p">;</span>
    <span class="kd">await</span> <span class="n">request</span><span class="p">.</span><span class="n">response</span><span class="p">.</span><span class="n">close</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div><p>接下来的几节内容包括服务器端绑定、发出客户端 GET 请求、监听和响应。</p>
<h2 id="将服务器绑定到主机和端口">将服务器绑定到主机和端口&nbsp;<a class="headline-hash no-text-decoration" href="#将服务器绑定到主机和端口">#</a> </h2>
<p>本节示例：<a href="https://github.com/dart-lang/site-www/blob/master/examples/httpserver/bin/hello_world_server.dart">hello_world_server.dart</a>。</p>
<p><code>main()</code> 中的第一条语句使用 <code>HttpServer.bind()</code> 创建一个 <a href="https://api.dart.dev/stable/dart-io/HttpServer-class.html">HttpServer</a> 对象，并将其绑定到主机和端口。</p>
<div class="highlight"><pre class="chroma"><code class="language-dart" data-lang="dart"><span class="kd">var</span> <span class="n">server</span> <span class="o">=</span> <span class="kd">await</span> <span class="n">HttpServer</span><span class="p">.</span><span class="n">bind</span><span class="p">(</span>
  <span class="n">InternetAddress</span><span class="p">.</span><span class="n">loopbackIPv4</span><span class="p">,</span>
  <span class="m">4040</span><span class="p">,</span>
<span class="p">)</span><span class="p">;</span>
</code></pre></div><p>该代码使用 <code>await</code> 异步调用 <code>bind</code> 方法。</p>
<h3 id="主机名">主机名&nbsp;<a class="headline-hash no-text-decoration" href="#主机名">#</a> </h3>
<p><code>bind()</code> 的第一个参数是指定主机名。你可以用一个字符串来指定一个特定的主机名或IP地址，也可以用 <a href="https://api.dart.dev/stable/dart-io/InternetAddress-class.html">InternetAddress</a> 类提供的这些预定义的值来指定主机。</p>
<table>
<thead>
<tr>
<th align="left">值</th>
<th align="left">用例</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left">回环 IPv4 或 loopbackIPv6</td>
<td align="left">服务器在 loopback 地址上监听客户端活动，该地址实际上是 localhost。使用IP协议的4或6版本。这些主要用于测试。我们建议您使用这些值而不是 <code>localhost</code> 或 <code>127.0.0.1</code>。</td>
</tr>
<tr>
<td align="left">任何 IPv4 或 anyIPv6</td>
<td align="left">服务器监听任何 IP 地址上指定端口上的客户端活动。使用IP协议的4或6版本。</td>
</tr>
</tbody>
</table>
<p>默认情况下，当使用V6互联网地址时，也会使用V4监听器。</p>
<h3 id="端口">端口&nbsp;<a class="headline-hash no-text-decoration" href="#端口">#</a> </h3>
<p><code>bind()</code> 的第二个参数是指定端口的整数。端口唯一地标识主机上的服务。1024 以下的端口号为标准服务保留(0除外)。例如，FTP 数据传输通常在端口20上运行，每日报价在端口17上运行，HTTP 在端口80上运行。你的程序应该使用1024以上的端口号。如果端口已经在使用中，你的服务器的连接将被拒绝。</p>
<h3 id="侦听请求">侦听请求&nbsp;<a class="headline-hash no-text-decoration" href="#侦听请求">#</a> </h3>
<p>服务器使用 <code>await for</code> 开始监听 HTTP 请求。每收到一个请求，代码就会发送一个 &ldquo;Hello, world!&rdquo; 的响应。</p>
<div class="highlight"><pre class="chroma"><code class="language-dart" data-lang="dart"><span class="kd">await</span> <span class="k">for</span> <span class="p">(</span><span class="n">HttpRequest</span> <span class="n">request</span> <span class="k">in</span> <span class="n">server</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">request</span><span class="p">.</span><span class="n">response</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="s1">Hello, world!</span><span class="s1">&#39;</span><span class="p">)</span><span class="p">;</span>
  <span class="kd">await</span> <span class="n">request</span><span class="p">.</span><span class="n">response</span><span class="p">.</span><span class="n">close</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div><p>你将在<a href="https://dart.dev/tutorials/server/httpserver#httprequest-object">监听和处理请求</a>一节中了解更多关于 <a href="https://api.dart.dev/stable/dart-io/HttpRequest-class.html">HttpRequest</a> 对象包含的内容以及如何编写响应。但首先，让我们看看客户端产生请求的一种方式。</p>
<h2 id="使用-html-表单发出-get-请求">使用 HTML 表单发出 GET 请求&nbsp;<a class="headline-hash no-text-decoration" href="#使用-html-表单发出-get-请求">#</a> </h2>
<p>本节的示例文件：<a href="https://github.com/dart-lang/site-www/blob/master/examples/httpserver/bin/number_thinker.dart">number_thinker.dart</a> 和 <a href="https://github.com/dart-lang/site-www/blob/master/examples/httpserver/web/make_a_guess.html">make_a_guess.html</a>。</p>
<p>本节介绍了一个命令行服务器，它可以随机选择一个0到9之间的数字。客户端是一个基本的 HTML 网页，<code>make_a_guess.html</code>，你可以用它来猜数字。</p>
<p>试试吧</p>
<ol>
<li>运行数字思考者服务器</li>
</ol>
<p>在命令行，运行 <code>number_thinker.dart</code> server。你应该看到类似下面的东西:</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">$ <span class="nb">cd</span> httpserver
$ dart bin/number_thinker.dart
I<span class="err">&#39;</span>m thinking of a number: <span class="m">6</span>
</code></pre></div><ol start="2">
<li>启动网络服务器</li>
</ol>
<p>从应用程序的顶部目录运行 <code>webdev serve</code>。</p>
<p>更多信息：<a href="https://dart.dev/tools/webdev">webdev 文档</a></p>
<ol start="3">
<li>打开 HTML 页面</li>
</ol>
<p>在浏览器中，进入 <a href="http://localhost:8080/make_a_guess.html">localhost:8080/make_a_guess.html</a>。</p>
<ol start="4">
<li>做一个猜测</li>
</ol>
<p>选择一个数字，然后按猜测按钮。</p>
<p><img src="https://dart.dev/tutorials/server/images/guessing.png" alt="img"></p>
<p>在客户端中没有涉及到 Dart 代码。客户端请求是通过浏览器向 Dart 服务器发出的，在 <code>make_a_guess.html</code> 中的 HTML 表单，它提供了一个自动制定和发送客户端 HTTP 请求的方法。该表单包含下拉列表和按钮。该表单还指定了 URL，其中包括端口号，以及请求的种类（请求方法）。它还可能包含建立查询字符串的元素。</p>
<p>下面是 <code>make_a_guess.html</code> 中的表单 HTML。</p>
<div class="highlight"><pre class="chroma"><code class="language-html" data-lang="html"><span class="p">&lt;</span><span class="nt">form</span> <span class="na">action</span><span class="o">=</span><span class="s">&#34;http://localhost:4041&#34;</span> <span class="na">method</span><span class="o">=</span><span class="s">&#34;GET&#34;</span><span class="p"></span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">select</span> <span class="na">name</span><span class="o">=</span><span class="s">&#34;q&#34;</span><span class="p"></span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">option</span> <span class="na">value</span><span class="o">=</span><span class="s">&#34;0&#34;</span><span class="p"></span><span class="p">&gt;</span>0<span class="p">&lt;</span><span class="p">/</span><span class="nt">option</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">option</span> <span class="na">value</span><span class="o">=</span><span class="s">&#34;1&#34;</span><span class="p"></span><span class="p">&gt;</span>1<span class="p">&lt;</span><span class="p">/</span><span class="nt">option</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">option</span> <span class="na">value</span><span class="o">=</span><span class="s">&#34;2&#34;</span><span class="p"></span><span class="p">&gt;</span>2<span class="p">&lt;</span><span class="p">/</span><span class="nt">option</span><span class="p">&gt;</span>
    <span class="c">&lt;!--</span><span class="c"> ··· </span><span class="c">--&gt;</span>
    <span class="p">&lt;</span><span class="nt">option</span> <span class="na">value</span><span class="o">=</span><span class="s">&#34;9&#34;</span><span class="p"></span><span class="p">&gt;</span>9<span class="p">&lt;</span><span class="p">/</span><span class="nt">option</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="p">/</span><span class="nt">select</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&#34;submit&#34;</span> <span class="na">value</span><span class="o">=</span><span class="s">&#34;Guess&#34;</span><span class="p"></span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="p">/</span><span class="nt">form</span><span class="p">&gt;</span>
</code></pre></div><p>下面是表单的工作原理:</p>
<ul>
<li>表单的 <code>action</code> 属性被分配给发送请求的 URL</li>
<li>表单的 <code>method</code> 属性定义了请求的类型，这里是 <code>GET</code>。其他常见的请求类型包括 POST、PUT 和 DELETE。</li>
<li>表单中任何有名称(<code>name</code>)的元素，比如 <code>&lt;select&gt;</code> 元素，都会成为查询字符串中的一个参数。</li>
<li>当按下提交按钮(<code>&lt;input type=&quot;submit&quot;...&gt;</code>)时，提交按钮会根据表单的内容制定请求并发送。</li>
</ul>
<h3 id="一个-restful-get-请求">一个 RESTful GET 请求&nbsp;<a class="headline-hash no-text-decoration" href="#一个-restful-get-请求">#</a> </h3>
<p>REST(REpresentational State Transfer)是一套设计 Web 服务的原则。乖巧的 HTTP 客户端和服务器遵守为 GET 请求定义的 REST 原则。</p>
<p>一个 GET 请求:</p>
<ul>
<li>只检索数据</li>
<li>不会改变服务器的状态</li>
<li>有长度限制</li>
<li>可以在请求的 URL 中发送查询字符串</li>
</ul>
<p>在这个例子中，客户端发出了一个符合 REST 的 GET 请求。</p>
<h2 id="监听和处理请求">监听和处理请求&nbsp;<a class="headline-hash no-text-decoration" href="#监听和处理请求">#</a> </h2>
<p>本节的示例文件: <a href="https://github.com/dart-lang/site-www/blob/master/examples/httpserver/bin/number_thinker.dart">number_thinker.dart</a> 和 <a href="https://github.com/dart-lang/site-www/blob/master/examples/httpserver/web/make_a_guess.html">make_a_guess.html</a>。</p>
<p>现在你已经看到这个基于浏览器的客户端的例子，让我们看看数字思维服务器的 Dart 代码，从 <code>main()</code> 开始。</p>
<p>再一次，服务器绑定了一个主机和端口。在这里，每收到一个请求都会调用顶层的 <code>handleRequest()</code> 方法。因为 HttpServer 实现了 <a href="https://api.dart.dev/stable/dart-async/Stream-class.html">Stream</a>，所以可以使用 <code>await for</code> 来处理请求。</p>
<div class="highlight"><pre class="chroma"><code class="language-dart" data-lang="dart"><span class="k">import</span> <span class="s1">&#39;</span><span class="s1">dart:io</span><span class="s1">&#39;</span><span class="p">;</span>
<span class="k">import</span> <span class="s1">&#39;</span><span class="s1">dart:math</span><span class="s1">&#39;</span> <span class="k">show</span> <span class="n">Random</span><span class="p">;</span>

<span class="n">Random</span> <span class="n">intGenerator</span> <span class="o">=</span> <span class="n">Random</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">myNumber</span> <span class="o">=</span> <span class="n">intGenerator</span><span class="p">.</span><span class="n">nextInt</span><span class="p">(</span><span class="m">10</span><span class="p">)</span><span class="p">;</span>

<span class="n">Future</span> <span class="n">main</span><span class="p">(</span><span class="p">)</span> <span class="kd">async</span> <span class="p">{</span>
  <span class="n">print</span><span class="p">(</span><span class="s2">&#34;</span><span class="s2">I&#39;m thinking of a number: </span><span class="si">$</span><span class="n">myNumber</span><span class="s2">&#34;</span><span class="p">)</span><span class="p">;</span>

  <span class="n">HttpServer</span> <span class="n">server</span> <span class="o">=</span> <span class="kd">await</span> <span class="n">HttpServer</span><span class="p">.</span><span class="n">bind</span><span class="p">(</span>
    <span class="n">InternetAddress</span><span class="p">.</span><span class="n">loopbackIPv4</span><span class="p">,</span>
    <span class="m">4041</span><span class="p">,</span>
  <span class="p">)</span><span class="p">;</span>
  <span class="kd">await</span> <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="n">request</span> <span class="k">in</span> <span class="n">server</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">handleRequest</span><span class="p">(</span><span class="n">request</span><span class="p">)</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div><p>当一个 <code>GET</code> 请求到达时，<code>handleRequest()</code> 方法会调用 <code>handleGet()</code> 来处理该请求。</p>
<div class="highlight"><pre class="chroma"><code class="language-dart" data-lang="dart"><span class="kt">void</span> <span class="n">handleRequest</span><span class="p">(</span><span class="n">HttpRequest</span> <span class="n">request</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">try</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">method</span> <span class="o">=</span><span class="o">=</span> <span class="s1">&#39;</span><span class="s1">GET</span><span class="s1">&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">handleGet</span><span class="p">(</span><span class="n">request</span><span class="p">)</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="c1">// ···
</span><span class="c1"></span>    <span class="p">}</span>
  <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="s1">Exception in handleRequest: </span><span class="si">$</span><span class="n">e</span><span class="s1">&#39;</span><span class="p">)</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="s1">Request handled.</span><span class="s1">&#39;</span><span class="p">)</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div><p>一个 <a href="https://api.dart.dev/stable/dart-io/HttpRequest-class.html">HttpRequest</a> 对象有很多属性，提供了关于请求的信息。下表列出了一些有用的属性。</p>
<table>
<thead>
<tr>
<th align="left">属性</th>
<th align="left">信息</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left">method</td>
<td align="left">&lsquo;GET&rsquo;, &lsquo;POST&rsquo;, &lsquo;PUT&rsquo; 等方法中的一个。</td>
</tr>
<tr>
<td align="left">uri</td>
<td align="left">一个 <a href="https://api.dart.dev/stable/dart-core/Uri-class.html">Uri</a> 对象：scheme、host、port、query string 和其他关于请求资源的信息。</td>
</tr>
<tr>
<td align="left">response</td>
<td align="left">一个 <a href="https://api.dart.dev/stable/dart-io/HttpResponse-class.html">HttpResponse</a> 对象：服务器将其响应写入其中。</td>
</tr>
<tr>
<td align="left">headers</td>
<td align="left">一个 <a href="https://api.dart.dev/stable/dart-io/HttpHeaders-class.html">HttpHeaders</a> 对象：请求的头信息，包括 <a href="https://api.dart.dev/stable/dart-io/ContentType-class.html">ContentType</a>、内容长度、日期等。</td>
</tr>
</tbody>
</table>
<h3 id="使用方法属性">使用方法属性&nbsp;<a class="headline-hash no-text-decoration" href="#使用方法属性">#</a> </h3>
<p>下面的数想器例子中的代码使用 HttpRequest 的 <code>method</code> 属性来确定收到了什么样的请求。这个服务器只处理 GET 请求。</p>
<div class="highlight"><pre class="chroma"><code class="language-dart" data-lang="dart"><span class="k">if</span> <span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">method</span> <span class="o">=</span><span class="o">=</span> <span class="s1">&#39;</span><span class="s1">GET</span><span class="s1">&#39;</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">handleGet</span><span class="p">(</span><span class="n">request</span><span class="p">)</span><span class="p">;</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
  <span class="n">request</span><span class="p">.</span><span class="n">response</span>
    <span class="p">.</span><span class="p">.</span><span class="n">statusCode</span> <span class="o">=</span> <span class="n">HttpStatus</span><span class="p">.</span><span class="n">methodNotAllowed</span>
    <span class="p">.</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="s1">Unsupported request: </span><span class="si">${</span><span class="n">request</span><span class="p">.</span><span class="n">method</span><span class="si">}</span><span class="s1">.</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="p">.</span><span class="p">.</span><span class="n">close</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div><h3 id="使用-uri-属性">使用 uri 属性&nbsp;<a class="headline-hash no-text-decoration" href="#使用-uri-属性">#</a> </h3>
<p>在浏览器中输入一个 URL 会产生一个 GET 请求，它只是简单地从指定的资源中请求数据。它可以通过附加在 URI 上的查询字符串随请求发送少量数据。</p>
<div class="highlight"><pre class="chroma"><code class="language-dart" data-lang="dart"><span class="kt">void</span> <span class="n">handleGet</span><span class="p">(</span><span class="n">HttpRequest</span> <span class="n">request</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">final</span> <span class="n">guess</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">uri</span><span class="p">.</span><span class="n">queryParameters</span><span class="p">[</span><span class="s1">&#39;</span><span class="s1">q</span><span class="s1">&#39;</span><span class="p">]</span><span class="p">;</span>
  <span class="c1">// ···
</span><span class="c1"></span><span class="p">}</span>
</code></pre></div><p>使用 HttpRequest 对象的 <code>uri</code> 属性来获取一个 <a href="https://api.dart.dev/stable/dart-core/Uri-class.html">Uri</a> 对象，这个 Uri 对象包含了用户输入的 URL 的信息。Uri 对象的 <code>queryParameters</code> 属性是一个 Map，包含查询字符串的组件。通过名称来引用所需的参数。本例使用 <code>q</code> 来标识猜测的数字。</p>
<h3 id="设置响应的状态码">设置响应的状态码&nbsp;<a class="headline-hash no-text-decoration" href="#设置响应的状态码">#</a> </h3>
<p>服务器应该设置状态码来表示请求的成功或失败。前面看到数想家将状态码设置为 <code>methodNotAllowed</code> 来拒绝非 GET 请求。在后面的代码中，为了表示请求成功，响应完成，数想家服务器将 <code>HttpResponse</code> 状态码设置为 <code>HttpStatus.ok</code>。</p>
<div class="highlight"><pre class="chroma"><code class="language-dart" data-lang="dart"><span class="kt">void</span> <span class="n">handleGet</span><span class="p">(</span><span class="n">HttpRequest</span> <span class="n">request</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">final</span> <span class="n">guess</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">uri</span><span class="p">.</span><span class="n">queryParameters</span><span class="p">[</span><span class="s1">&#39;</span><span class="s1">q</span><span class="s1">&#39;</span><span class="p">]</span><span class="p">;</span>
  <span class="kd">final</span> <span class="n">response</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">response</span><span class="p">;</span>
  <span class="n">response</span><span class="p">.</span><span class="n">statusCode</span> <span class="o">=</span> <span class="n">HttpStatus</span><span class="p">.</span><span class="n">ok</span><span class="p">;</span>
  <span class="c1">// ···
</span><span class="c1"></span><span class="p">}</span>
</code></pre></div><p><code>HttpStatus.ok</code> 和 <code>HttpStatus.methodNotAllowed</code> 是 <a href="https://api.dart.dev/stable/dart-io/HttpStatus-class.html">HttpStatus</a> 类中许多预定义状态码中的两个。另一个有用的预定义状态码是 <code>HttpStatus.notFound</code>(经典的 404）。</p>
<p>除了状态码(<code>statusCode</code>)，HttpResponse 对象还有其他有用的属性:</p>
<table>
<thead>
<tr>
<th align="left">属性</th>
<th align="left">信息</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left">contentLength</td>
<td align="left">响应的长度，-1 表示事先不知道长度。</td>
</tr>
<tr>
<td align="left">cookies</td>
<td align="left">要在客户端设置的 <a href="https://api.dart.dev/stable/dart-io/Cookie-class.html">Cookies</a> 列表。</td>
</tr>
<tr>
<td align="left">encoding</td>
<td align="left">编写字符串时使用的<a href="https://api.dart.dev/stable/dart-convert/Encoding-class.html">编码</a>，如 JSON 和 UTF-8。</td>
</tr>
<tr>
<td align="left">headers</td>
<td align="left">响应头，是一个 <a href="https://api.dart.dev/stable/dart-io/HttpHeaders-class.html">HttpHeaders</a> 对象。</td>
</tr>
</tbody>
</table>
<h3 id="将响应写到-httpresponse-对象">将响应写到 HttpResponse 对象&nbsp;<a class="headline-hash no-text-decoration" href="#将响应写到-httpresponse-对象">#</a> </h3>
<p>每个 HttpRequest 对象都有一个对应的 HttpResponse 对象。服务器通过响应对象将数据发回给客户端。</p>
<p>使用 HttpResponse 写方法之一(<code>write()</code>、<code>writeln()</code>、<code>writeAll()</code> 或 <code>writeCharCodes()</code>)将响应数据写入 HttpResponse 对象。或者通过 <code>addStream</code> 将 <code>HttpResponse</code> 对象连接到一个流，并写入流。响应完成后关闭对象。关闭 HttpResponse 对象会将数据发回给客户端。</p>
<div class="highlight"><pre class="chroma"><code class="language-dart" data-lang="dart"><span class="kt">void</span> <span class="n">handleGet</span><span class="p">(</span><span class="n">HttpRequest</span> <span class="n">request</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// ···
</span><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">guess</span> <span class="o">=</span><span class="o">=</span> <span class="n">myNumber</span><span class="p">.</span><span class="n">toString</span><span class="p">(</span><span class="p">)</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">response</span>
      <span class="p">.</span><span class="p">.</span><span class="n">writeln</span><span class="p">(</span><span class="s1">&#39;</span><span class="s1">true</span><span class="s1">&#39;</span><span class="p">)</span>
      <span class="p">.</span><span class="p">.</span><span class="n">writeln</span><span class="p">(</span><span class="s2">&#34;</span><span class="s2">I&#39;m thinking of another number.</span><span class="s2">&#34;</span><span class="p">)</span>
      <span class="p">.</span><span class="p">.</span><span class="n">close</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>
    <span class="c1">// ···
</span><span class="c1"></span>  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div><h2 id="从独立的客户端进行-post-请求">从独立的客户端进行 POST 请求&nbsp;<a class="headline-hash no-text-decoration" href="#从独立的客户端进行-post-请求">#</a> </h2>
<p>本节的示例文件：<a href="https://github.com/dart-lang/site-www/blob/master/examples/httpserver/bin/basic_writer_server.dart">basic_writer_server.dart</a> 和  <a href="https://github.com/dart-lang/site-www/blob/master/examples/httpserver/bin/basic_writer_client.dart">basic_writer_client.dart</a>。</p>
<p>在 <code>hello world</code> 和 <code>number thinker</code> 的例子中，浏览器生成了简单的 GET 请求，对于更复杂的 GET 请求和其他类型的请求，如 POST、PUT 或 DELETE，你需要写一个客户端程序，其中有两种。</p>
<ul>
<li>一个独立的客户端程序，它使用 <code>dart:io</code> 的 <a href="https://api.dart.dev/stable/dart-io/HttpClient-class.html">HttpClient</a> 类。</li>
<li>基于浏览器的客户端，使用 <a href="https://api.dart.dev/stable/dart-html/dart-html-library.html">dart:html</a> 中的 API。本教程不涉及基于浏览器的客户端。要查看基于浏览器的客户端和相关服务器的代码，请参见 <a href="https://github.com/dart-lang/site-www/blob/master/examples/httpserver/web/note_client.dart">note_client.dart</a>、<a href="https://github.com/dart-lang/site-www/blob/master/examples/httpserver/bin/note_server.dart">note_server.dart</a> 和 <a href="https://github.com/dart-lang/site-www/blob/master/examples/httpserver/web/note_taker.html">note_taker.html</a>。</li>
</ul>
<p>让我们看看一个独立的客户端，<code>basic_writer_client.dart</code> 和它的服务器 <code>basic_writer_server.dart</code>。客户端发出一个 POST 请求，将 JSON 数据保存到服务器端的文件中。服务器接受请求并保存文件。</p>
<h4 id="试试吧">试试吧&nbsp;<a class="headline-hash no-text-decoration" href="#试试吧">#</a> </h4>
<p>在命令行上运行服务器和客户端。</p>
<ol>
<li>首先，运行服务器:</li>
</ol>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell"><span class="nb">cd</span> httpserver
$ dart bin/basic_writer_server.dart
</code></pre></div><ol start="2">
<li>在一个新的终端中，运行客户端:</li>
</ol>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">$ <span class="nb">cd</span> httpserver
$ dart bin/basic_writer_client.dart
Wrote data <span class="k">for</span> Han Solo.
</code></pre></div><p>看看服务器写入 <code>file.txt</code> 的 JSON 数据:</p>
<div class="highlight"><pre class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span><span class="nt">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;Han Solo&#34;</span><span class="p">,</span><span class="nt">&#34;job&#34;</span><span class="p">:</span><span class="s2">&#34;reluctant hero&#34;</span><span class="p">,</span><span class="nt">&#34;BFF&#34;</span><span class="p">:</span><span class="s2">&#34;Chewbacca&#34;</span><span class="p">,</span><span class="nt">&#34;ship&#34;</span><span class="p">:</span><span class="s2">&#34;Millennium Falcon&#34;</span><span class="p">,</span><span class="nt">&#34;weakness&#34;</span><span class="p">:</span><span class="s2">&#34;smuggling debts&#34;</span><span class="p">}</span>
</code></pre></div><p>客户端创建一个 HttpClient 对象，并使用 <code>post()</code> 方法进行请求。发起一个请求涉及两个 Future。</p>
<ul>
<li><code>post()</code> 方法建立与服务器的网络连接并完成第一个 Future，返回一个 HttpClientRequest 对象。</li>
<li>客户端组成请求对象并关闭它。<code>close()</code> 方法将请求发送到服务器并返回第二个 Future，它以一个 HttpClientResponse 对象完成。</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-dart" data-lang="dart"><span class="k">import</span> <span class="s1">&#39;</span><span class="s1">dart:io</span><span class="s1">&#39;</span><span class="p">;</span>
<span class="k">import</span> <span class="s1">&#39;</span><span class="s1">dart:convert</span><span class="s1">&#39;</span><span class="p">;</span>

<span class="kt">String</span> <span class="n">_host</span> <span class="o">=</span> <span class="n">InternetAddress</span><span class="p">.</span><span class="n">loopbackIPv4</span><span class="p">.</span><span class="n">host</span><span class="p">;</span>
<span class="kt">String</span> <span class="n">path</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s1">file.txt</span><span class="s1">&#39;</span><span class="p">;</span>

<span class="n">Map</span> <span class="n">jsonData</span> <span class="o">=</span> <span class="p">{</span>
  <span class="s1">&#39;</span><span class="s1">name</span><span class="s1">&#39;</span><span class="o">:</span> <span class="s1">&#39;</span><span class="s1">Han Solo</span><span class="s1">&#39;</span><span class="p">,</span>
  <span class="s1">&#39;</span><span class="s1">job</span><span class="s1">&#39;</span><span class="o">:</span> <span class="s1">&#39;</span><span class="s1">reluctant hero</span><span class="s1">&#39;</span><span class="p">,</span>
  <span class="s1">&#39;</span><span class="s1">BFF</span><span class="s1">&#39;</span><span class="o">:</span> <span class="s1">&#39;</span><span class="s1">Chewbacca</span><span class="s1">&#39;</span><span class="p">,</span>
  <span class="s1">&#39;</span><span class="s1">ship</span><span class="s1">&#39;</span><span class="o">:</span> <span class="s1">&#39;</span><span class="s1">Millennium Falcon</span><span class="s1">&#39;</span><span class="p">,</span>
  <span class="s1">&#39;</span><span class="s1">weakness</span><span class="s1">&#39;</span><span class="o">:</span> <span class="s1">&#39;</span><span class="s1">smuggling debts</span><span class="s1">&#39;</span>
<span class="p">}</span><span class="p">;</span>

<span class="n">Future</span> <span class="n">main</span><span class="p">(</span><span class="p">)</span> <span class="kd">async</span> <span class="p">{</span>
  <span class="n">HttpClientRequest</span> <span class="n">request</span> <span class="o">=</span> <span class="kd">await</span> <span class="n">HttpClient</span><span class="p">(</span><span class="p">)</span><span class="p">.</span><span class="n">post</span><span class="p">(</span><span class="n">_host</span><span class="p">,</span> <span class="m">4049</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span> <span class="cm">/*1*/</span>
    <span class="p">.</span><span class="p">.</span><span class="n">headers</span><span class="p">.</span><span class="n">contentType</span> <span class="o">=</span> <span class="n">ContentType</span><span class="p">.</span><span class="n">json</span> <span class="cm">/*2*/</span>
    <span class="p">.</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">jsonEncode</span><span class="p">(</span><span class="n">jsonData</span><span class="p">)</span><span class="p">)</span><span class="p">;</span> <span class="cm">/*3*/</span>
  <span class="n">HttpClientResponse</span> <span class="n">response</span> <span class="o">=</span> <span class="kd">await</span> <span class="n">request</span><span class="p">.</span><span class="n">close</span><span class="p">(</span><span class="p">)</span><span class="p">;</span> <span class="cm">/*4*/</span>
  <span class="kd">await</span> <span class="n">utf8</span><span class="p">.</span><span class="n">decoder</span><span class="p">.</span><span class="n">bind</span><span class="p">(</span><span class="n">response</span> <span class="cm">/*5*/</span><span class="p">)</span><span class="p">.</span><span class="n">forEach</span><span class="p">(</span><span class="n">print</span><span class="p">)</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div><p>/<em>1</em>/ <code>post()</code> 方法需要主机、端口和请求资源的路径。除了 <code>post()</code> 之外，<a href="https://api.dart.dev/stable/dart-io/HttpClient-class.html">HttpClient</a> 类还提供了其他类型的请求函数，包括 <code>postUrl()</code>、<code>get()</code> 和 <code>open()</code>。</p>
<p>/<em>2</em>/ 一个 <a href="https://api.dart.dev/stable/dart-io/HttpClientRequest-class.html">HttpClientRequest</a> 对象有一个 <a href="https://api.dart.dev/stable/dart-io/HttpHeaders-class.html">HttpHeaders</a> 对象，它包含了请求头的信息。对于一些请求头，比如 <code>contentType</code>，HttpHeaders 有一个针对该请求头的属性。对于其他的请求头，使用 <code>set()</code> 方法将该请求头放入 HttpHeaders 对象中。</p>
<p>/<em>3</em>/ 客户端使用 <code>write()</code> 向请求对象写入数据。编码，在这个例子中是 JSON，与 <a href="https://api.dart.dev/stable/dart-io/ContentType-class.html">ContentType</a> 头中指定的类型相匹配。</p>
<p>/<em>4</em>/ <code>close()</code> 方法将请求发送到服务器，完成后返回一个 <a href="https://api.dart.dev/stable/dart-io/HttpClientResponse-class.html">HttpClientResponse</a> 对象。</p>
<p>/<em>5</em>/ 来自服务器的 UTF-8 响应将被解码。使用在 <a href="https://api.dart.dev/stable/dart-convert/dart-convert-library.html">dart:convert</a> 库中定义的转换器将数据转换为常规的 Dart 字符串格式。</p>
<h3 id="一个-restful-post-请求">一个 RESTful POST 请求&nbsp;<a class="headline-hash no-text-decoration" href="#一个-restful-post-请求">#</a> </h3>
<p>与 GET 请求类似，REST 为 POST 请求提供了指导方针。</p>
<p>一个 POST 请求:</p>
<ul>
<li>创建一个资源(在这个例子中，一个文件)</li>
<li>使用一个 URI，其结构与文件和目录路径名相似；例如，URI 没有查询字符串。</li>
<li>以 JSON 或 XML 格式传输数据</li>
<li>没有状态，也不会改变服务器的状态。</li>
<li>无长度限制</li>
</ul>
<p>这个例子中的客户端发出 REST 兼容的 POST 请求。</p>
<p>要想看到使 REST 兼容的 GET 请求的客户端代码，请看 <a href="https://github.com/dart-lang/site-www/blob/master/examples/httpserver/bin/number_guesser.dart">number_guesser.dart</a>。它是一个独立的客户端，用于数字思考者服务器，定期进行猜测，直到猜对为止。</p>
<h2 id="在服务器中处理一个-post-请求">在服务器中处理一个 POST 请求&nbsp;<a class="headline-hash no-text-decoration" href="#在服务器中处理一个-post-请求">#</a> </h2>
<p>本节的示例文件：<a href="https://github.com/dart-lang/site-www/blob/master/examples/httpserver/bin/basic_writer_server.dart">basic_writer_server.dart</a> 和 <a href="https://github.com/dart-lang/site-www/blob/master/examples/httpserver/bin/basic_writer_client.dart">basic_writer_client.dart</a>。</p>
<p>一个 HttpRequest 对象是一个字节列表流(<code>Stream&lt;List&lt;int&gt;</code>)。要获得客户端发送的数据，就要监听 HttpRequest 对象上的数据。</p>
<p>如果来自客户端的请求包含了大量的数据，数据可能会以多个分块的形式到达。你可以使用 Stream 中的 <code>join()</code> 方法来连接这些分块的字符串值。</p>
<p><img src="https://dart.dev/tutorials/server/images/flowchart.png" alt="img"></p>
<p><code>basic_writer_server.dart</code> 文件实现了一个遵循这种模式的服务器。</p>
<div class="highlight"><pre class="chroma"><code class="language-dart" data-lang="dart"><span class="k">import</span> <span class="s1">&#39;</span><span class="s1">dart:io</span><span class="s1">&#39;</span><span class="p">;</span>
<span class="k">import</span> <span class="s1">&#39;</span><span class="s1">dart:convert</span><span class="s1">&#39;</span><span class="p">;</span>

<span class="kt">String</span> <span class="n">_host</span> <span class="o">=</span> <span class="n">InternetAddress</span><span class="p">.</span><span class="n">loopbackIPv4</span><span class="p">.</span><span class="n">host</span><span class="p">;</span>

<span class="n">Future</span> <span class="n">main</span><span class="p">(</span><span class="p">)</span> <span class="kd">async</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="n">server</span> <span class="o">=</span> <span class="kd">await</span> <span class="n">HttpServer</span><span class="p">.</span><span class="n">bind</span><span class="p">(</span><span class="n">_host</span><span class="p">,</span> <span class="m">4049</span><span class="p">)</span><span class="p">;</span>
  <span class="kd">await</span> <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="n">req</span> <span class="k">in</span> <span class="n">server</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">ContentType</span> <span class="n">contentType</span> <span class="o">=</span> <span class="n">req</span><span class="p">.</span><span class="n">headers</span><span class="p">.</span><span class="n">contentType</span><span class="p">;</span>
    <span class="n">HttpResponse</span> <span class="n">response</span> <span class="o">=</span> <span class="n">req</span><span class="p">.</span><span class="n">response</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="p">.</span><span class="n">method</span> <span class="o">=</span><span class="o">=</span> <span class="s1">&#39;</span><span class="s1">POST</span><span class="s1">&#39;</span> <span class="o">&amp;</span><span class="o">&amp;</span>
        <span class="n">contentType</span><span class="o">?</span><span class="p">.</span><span class="n">mimeType</span> <span class="o">=</span><span class="o">=</span> <span class="s1">&#39;</span><span class="s1">application/json</span><span class="s1">&#39;</span> <span class="cm">/*1*/</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">try</span> <span class="p">{</span>
        <span class="kt">String</span> <span class="n">content</span> <span class="o">=</span>
            <span class="kd">await</span> <span class="n">utf8</span><span class="p">.</span><span class="n">decoder</span><span class="p">.</span><span class="n">bind</span><span class="p">(</span><span class="n">req</span><span class="p">)</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="p">)</span><span class="p">;</span> <span class="cm">/*2*/</span>
        <span class="kd">var</span> <span class="n">data</span> <span class="o">=</span> <span class="n">jsonDecode</span><span class="p">(</span><span class="n">content</span><span class="p">)</span> <span class="o">as</span> <span class="n">Map</span><span class="p">;</span> <span class="cm">/*3*/</span>
        <span class="kd">var</span> <span class="n">fileName</span> <span class="o">=</span> <span class="n">req</span><span class="p">.</span><span class="n">uri</span><span class="p">.</span><span class="n">pathSegments</span><span class="p">.</span><span class="n">last</span><span class="p">;</span> <span class="cm">/*4*/</span>
        <span class="kd">await</span> <span class="n">File</span><span class="p">(</span><span class="n">fileName</span><span class="p">)</span>
            <span class="p">.</span><span class="n">writeAsString</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="nl">mode:</span> <span class="n">FileMode</span><span class="p">.</span><span class="n">write</span><span class="p">)</span><span class="p">;</span>
        <span class="n">req</span><span class="p">.</span><span class="n">response</span>
          <span class="p">.</span><span class="p">.</span><span class="n">statusCode</span> <span class="o">=</span> <span class="n">HttpStatus</span><span class="p">.</span><span class="n">ok</span>
          <span class="p">.</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="s1">Wrote data for </span><span class="si">${</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;</span><span class="s1">name</span><span class="s1">&#39;</span><span class="p">]</span><span class="si">}</span><span class="s1">.</span><span class="s1">&#39;</span><span class="p">)</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">response</span>
          <span class="p">.</span><span class="p">.</span><span class="n">statusCode</span> <span class="o">=</span> <span class="n">HttpStatus</span><span class="p">.</span><span class="n">internalServerError</span>
          <span class="p">.</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="s1">Exception during file I/O: </span><span class="si">$</span><span class="n">e</span><span class="s1">.</span><span class="s1">&#39;</span><span class="p">)</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="n">response</span>
        <span class="p">.</span><span class="p">.</span><span class="n">statusCode</span> <span class="o">=</span> <span class="n">HttpStatus</span><span class="p">.</span><span class="n">methodNotAllowed</span>
        <span class="p">.</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="s1">Unsupported request: </span><span class="si">${</span><span class="n">req</span><span class="p">.</span><span class="n">method</span><span class="si">}</span><span class="s1">.</span><span class="s1">&#39;</span><span class="p">)</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="kd">await</span> <span class="n">response</span><span class="p">.</span><span class="n">close</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div><p>/<em>1</em>/ 该请求有一个 HttpHeaders 对象。记得客户端将 <code>contentType</code> 头设置为 JSON(application/json)。该服务器拒绝不是 JSON 编码的请求。</p>
<p>/<em>2</em>/ 一个 POST 请求对它可以发送的数据量没有限制，数据可能会以多块形式发送。此外，JSON 是 UTF-8，而 UTF-8 字符可以在多个字节上进行编码。<code>join()</code> 方法将这些分块放在一起。</p>
<p>/<em>3</em>/ 客户端发送的数据是 JSON 格式的。服务器使用 <a href="https://api.dart.dev/stable/dart-convert/dart-convert-library.html">dart:convert</a> 库中的 JSON 编解码器对其进行解码。</p>
<p>/<em>4</em>/ 请求的 URL 是 <a href="http://localhost:4049/file.txt">localhost:4049/file.txt</a>。代码 <code>req.uri.pathSegments.last</code> 从 URI 中提取文件名: <code>file.txt</code>。</p>
<h3 id="关于-cors-头的说明">关于 CORS 头的说明&nbsp;<a class="headline-hash no-text-decoration" href="#关于-cors-头的说明">#</a> </h3>
<p>如果你想为运行在不同源头（不同主机或端口）的客户端提供服务，你需要添加 CORS 头。下面的代码，取自 note_server.dart，允许从任何来源的 POST 和 OPTIONS 请求。谨慎使用 CORS 头文件，因为它们会给你的网络带来安全风险。</p>
<div class="highlight"><pre class="chroma"><code class="language-dart" data-lang="dart"><span class="kt">void</span> <span class="n">addCorsHeaders</span><span class="p">(</span><span class="n">HttpResponse</span> <span class="n">response</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">response</span><span class="p">.</span><span class="n">headers</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;</span><span class="s1">Access-Control-Allow-Origin</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s1">*</span><span class="s1">&#39;</span><span class="p">)</span><span class="p">;</span>
  <span class="n">response</span><span class="p">.</span><span class="n">headers</span>
      <span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;</span><span class="s1">Access-Control-Allow-Methods</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s1">POST, OPTIONS</span><span class="s1">&#39;</span><span class="p">)</span><span class="p">;</span>
  <span class="n">response</span><span class="p">.</span><span class="n">headers</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;</span><span class="s1">Access-Control-Allow-Headers</span><span class="s1">&#39;</span><span class="p">,</span>
      <span class="s1">&#39;</span><span class="s1">Origin, X-Requested-With, Content-Type, Accept</span><span class="s1">&#39;</span><span class="p">)</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div><p>更多信息，请参考维基百科的<a href="https://en.wikipedia.org/wiki/Cross-origin_resource_sharing">跨源资源共享</a>一文。</p>
<h2 id="使用-http_server-包">使用 http_server 包&nbsp;<a class="headline-hash no-text-decoration" href="#使用-http_server-包">#</a> </h2>
<p>本节的示例文件：<a href="https://github.com/dart-lang/site-www/blob/master/examples/httpserver/bin/mini_file_server.dart">mini_file_server.dart</a> 和 <a href="https://github.com/dart-lang/site-www/blob/master/examples/httpserver/bin/static_file_server.dart">static_file_server.dart</a>。</p>
<p>对于一些更高层次的构件，我们推荐你尝试 <a href="https://pub.dev/packages/http_server">http_server</a> pub 包，它包含了一组类，与 <code>dart:io</code> 库中的 HttpServer 类一起，使得实现 HTTP 务器更加容易。</p>
<p>在本节中，我们比较了一个只使用 <code>dart:io</code> 的 API 编写的服务器和一个使用 dart:io 和 http_server 一起编写的具有相同功能的服务器。</p>
<p>你可以在 <code>mini_file_server.dart</code> 中找到第一个服务器。它通过从 <code>web</code> 目录返回 <code>index.html</code> 文件的内容来响应所有请求。</p>
<h3 id="试试吧-1">试试吧&nbsp;<a class="headline-hash no-text-decoration" href="#试试吧-1">#</a> </h3>
<p>在命令行中运行服务器:</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">$ <span class="nb">cd</span> httpserver
$ dart bin/mini_file_server.dart
</code></pre></div><p>在浏览器中输入 <a href="http://localhost:4044/">localhost:4044</a>。服务器会显示一个 HTML 文件。</p>
<p><img src="https://dart.dev/tutorials/server/images/index_file.png" alt="img"></p>
<p>这是迷你文件服务器的代码:</p>
<div class="highlight"><pre class="chroma"><code class="language-dart" data-lang="dart"><span class="k">import</span> <span class="s1">&#39;</span><span class="s1">dart:io</span><span class="s1">&#39;</span><span class="p">;</span>

<span class="n">File</span> <span class="n">targetFile</span> <span class="o">=</span> <span class="n">File</span><span class="p">(</span><span class="s1">&#39;</span><span class="s1">web/index.html</span><span class="s1">&#39;</span><span class="p">)</span><span class="p">;</span>

<span class="n">Future</span> <span class="n">main</span><span class="p">(</span><span class="p">)</span> <span class="kd">async</span> <span class="p">{</span>
  <span class="n">Stream</span><span class="o">&lt;</span><span class="n">HttpRequest</span><span class="o">&gt;</span> <span class="n">server</span><span class="p">;</span>

  <span class="k">try</span> <span class="p">{</span>
    <span class="n">server</span> <span class="o">=</span> <span class="kd">await</span> <span class="n">HttpServer</span><span class="p">.</span><span class="n">bind</span><span class="p">(</span><span class="n">InternetAddress</span><span class="p">.</span><span class="n">loopbackIPv4</span><span class="p">,</span> <span class="m">4044</span><span class="p">)</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">print</span><span class="p">(</span><span class="s2">&#34;</span><span class="s2">Couldn&#39;t bind to port 4044: </span><span class="si">$</span><span class="n">e</span><span class="s2">&#34;</span><span class="p">)</span><span class="p">;</span>
    <span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="m">1</span><span class="p">)</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">await</span> <span class="k">for</span> <span class="p">(</span><span class="n">HttpRequest</span> <span class="n">req</span> <span class="k">in</span> <span class="n">server</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="kd">await</span> <span class="n">targetFile</span><span class="p">.</span><span class="n">exists</span><span class="p">(</span><span class="p">)</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">print</span><span class="p">(</span><span class="s2">&#34;</span><span class="s2">Serving </span><span class="si">${</span><span class="n">targetFile</span><span class="p">.</span><span class="n">path</span><span class="si">}</span><span class="s2">.</span><span class="s2">&#34;</span><span class="p">)</span><span class="p">;</span>
      <span class="n">req</span><span class="p">.</span><span class="n">response</span><span class="p">.</span><span class="n">headers</span><span class="p">.</span><span class="n">contentType</span> <span class="o">=</span> <span class="n">ContentType</span><span class="p">.</span><span class="n">html</span><span class="p">;</span>
      <span class="k">try</span> <span class="p">{</span>
        <span class="kd">await</span> <span class="n">req</span><span class="p">.</span><span class="n">response</span><span class="p">.</span><span class="n">addStream</span><span class="p">(</span><span class="n">targetFile</span><span class="p">.</span><span class="n">openRead</span><span class="p">(</span><span class="p">)</span><span class="p">)</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">print</span><span class="p">(</span><span class="s2">&#34;</span><span class="s2">Couldn&#39;t read file: </span><span class="si">$</span><span class="n">e</span><span class="s2">&#34;</span><span class="p">)</span><span class="p">;</span>
        <span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="m">1</span><span class="p">)</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="n">print</span><span class="p">(</span><span class="s2">&#34;</span><span class="s2">Can&#39;t open </span><span class="si">${</span><span class="n">targetFile</span><span class="p">.</span><span class="n">path</span><span class="si">}</span><span class="s2">.</span><span class="s2">&#34;</span><span class="p">)</span><span class="p">;</span>
      <span class="n">req</span><span class="p">.</span><span class="n">response</span><span class="p">.</span><span class="n">statusCode</span> <span class="o">=</span> <span class="n">HttpStatus</span><span class="p">.</span><span class="n">notFound</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="kd">await</span> <span class="n">req</span><span class="p">.</span><span class="n">response</span><span class="p">.</span><span class="n">close</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div><p>这段代码确定文件是否存在，如果存在，则打开文件，并将文件内容管道化到HttpResponse对象。</p>
<p>第二个服务器，你可以在 <a href="https://github.com/dart-lang/site-www/blob/master/examples/httpserver/bin/basic_file_server.dart">basic_file_server.dart</a> 中找到它的代码，使用 <a href="https://pub.dev/packages/http_server">http_server</a> 包。</p>
<h3 id="试试吧-2">试试吧&nbsp;<a class="headline-hash no-text-decoration" href="#试试吧-2">#</a> </h3>
<p>在命令行中运行服务器:</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">$ <span class="nb">cd</span> httpserver
$ dart bin/basic_file_server.dart
</code></pre></div><p>在浏览器中输入 <a href="http://localhost:4046/">localhost:4046</a>。服务器显示与之前相同的 index.html 文件。</p>
<p><img src="https://dart.dev/tutorials/server/images/index_file_4046.png" alt="img"></p>
<p>在这个服务器中，处理请求的代码要短得多，因为 <a href="https://pub.dev/documentation/http_server/latest/http_server/VirtualDirectory-class.html">VirtualDirectory</a> 类处理服务文件的细节。</p>
<div class="highlight"><pre class="chroma"><code class="language-dart" data-lang="dart"><span class="k">import</span> <span class="s1">&#39;</span><span class="s1">dart:io</span><span class="s1">&#39;</span><span class="p">;</span>
<span class="k">import</span> <span class="s1">&#39;</span><span class="s1">package:http_server/http_server.dart</span><span class="s1">&#39;</span><span class="p">;</span>

<span class="n">File</span> <span class="n">targetFile</span> <span class="o">=</span> <span class="n">File</span><span class="p">(</span><span class="s1">&#39;</span><span class="s1">web/index.html</span><span class="s1">&#39;</span><span class="p">)</span><span class="p">;</span>

<span class="n">Future</span> <span class="n">main</span><span class="p">(</span><span class="p">)</span> <span class="kd">async</span> <span class="p">{</span>
  <span class="n">VirtualDirectory</span> <span class="n">staticFiles</span> <span class="o">=</span> <span class="n">VirtualDirectory</span><span class="p">(</span><span class="s1">&#39;</span><span class="s1">.</span><span class="s1">&#39;</span><span class="p">)</span><span class="p">;</span>

  <span class="kd">var</span> <span class="n">serverRequests</span> <span class="o">=</span>
      <span class="kd">await</span> <span class="n">HttpServer</span><span class="p">.</span><span class="n">bind</span><span class="p">(</span><span class="n">InternetAddress</span><span class="p">.</span><span class="n">loopbackIPv4</span><span class="p">,</span> <span class="m">4046</span><span class="p">)</span><span class="p">;</span>
  <span class="kd">await</span> <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="n">request</span> <span class="k">in</span> <span class="n">serverRequests</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">staticFiles</span><span class="p">.</span><span class="n">serveFile</span><span class="p">(</span><span class="n">targetFile</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div><p>这里，请求的资源 index.html 是由 VirtualDirectory 类中的 <code>serviceFile()</code> 方法提供的。你不需要写代码来打开一个文件并将其内容用管道传送到请求中。</p>
<p>另一个文件服务器 <code>static_file_server.dart</code> 也使用 http_server 包。这个服务器可以服务于服务器目录或子目录中的任何文件。</p>
<p>运行 <code>static_file_server.dart</code>，用 <a href="http://localhost:4048/">localhost:4048</a> 这个 URL 进行测试。</p>
<p>下面是 <code>static_file_server.dart</code> 的代码:</p>
<div class="highlight"><pre class="chroma"><code class="language-dart" data-lang="dart"><span class="k">import</span> <span class="s1">&#39;</span><span class="s1">dart:io</span><span class="s1">&#39;</span><span class="p">;</span>
<span class="k">import</span> <span class="s1">&#39;</span><span class="s1">package:http_server/http_server.dart</span><span class="s1">&#39;</span><span class="p">;</span>

<span class="n">Future</span> <span class="n">main</span><span class="p">(</span><span class="p">)</span> <span class="kd">async</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="n">staticFiles</span> <span class="o">=</span> <span class="n">VirtualDirectory</span><span class="p">(</span><span class="s1">&#39;</span><span class="s1">web</span><span class="s1">&#39;</span><span class="p">)</span><span class="p">;</span>
  <span class="n">staticFiles</span><span class="p">.</span><span class="n">allowDirectoryListing</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span> <span class="cm">/*1*/</span>
  <span class="n">staticFiles</span><span class="p">.</span><span class="n">directoryHandler</span> <span class="o">=</span> <span class="p">(</span><span class="n">dir</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span> <span class="cm">/*2*/</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="n">indexUri</span> <span class="o">=</span> <span class="n">Uri</span><span class="p">.</span><span class="n">file</span><span class="p">(</span><span class="n">dir</span><span class="p">.</span><span class="n">path</span><span class="p">)</span><span class="p">.</span><span class="n">resolve</span><span class="p">(</span><span class="s1">&#39;</span><span class="s1">index.html</span><span class="s1">&#39;</span><span class="p">)</span><span class="p">;</span>
    <span class="n">staticFiles</span><span class="p">.</span><span class="n">serveFile</span><span class="p">(</span><span class="n">File</span><span class="p">(</span><span class="n">indexUri</span><span class="p">.</span><span class="n">toFilePath</span><span class="p">(</span><span class="p">)</span><span class="p">)</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span><span class="p">;</span> <span class="cm">/*3*/</span>
  <span class="p">}</span><span class="p">;</span>

  <span class="kd">var</span> <span class="n">server</span> <span class="o">=</span> <span class="kd">await</span> <span class="n">HttpServer</span><span class="p">.</span><span class="n">bind</span><span class="p">(</span><span class="n">InternetAddress</span><span class="p">.</span><span class="n">loopbackIPv4</span><span class="p">,</span> <span class="m">4048</span><span class="p">)</span><span class="p">;</span>
  <span class="n">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="s1">Listening on port 4048</span><span class="s1">&#39;</span><span class="p">)</span><span class="p">;</span>
  <span class="kd">await</span> <span class="n">server</span><span class="p">.</span><span class="n">forEach</span><span class="p">(</span><span class="n">staticFiles</span><span class="p">.</span><span class="n">serveRequest</span><span class="p">)</span><span class="p">;</span> <span class="cm">/*4*/</span>
<span class="p">}</span>
</code></pre></div><p>/<em>1</em>/ 允许客户端请求服务器目录内的文件。</p>
<p>/<em>2</em>/ 一个匿名函数，处理对目录本身的请求，即 URL 不包含文件名。该函数将这些请求重定向到 <code>index.html</code>。</p>
<p>/<em>3</em>/ <code>serveFile</code> 方法为一个文件提供服务，在这个例子中，它为目录请求服务index.html。</p>
<p>/<em>4</em>/ VirtualDirectory 类提供的 <code>serviceRequest</code> 方法处理指定文件的请求。</p>
<h2 id="使用-bindsecure-的-https-方法">使用 bindSecure() 的 https 方法&nbsp;<a class="headline-hash no-text-decoration" href="#使用-bindsecure-的-https-方法">#</a> </h2>
<p>本节的示例：<a href="https://github.com/dart-lang/site-www/blob/master/examples/httpserver/bin/hello_world_server_secure.dart">hello_world_server_secure.dart</a>。</p>
<p>你可能已经注意到，HttpServer 类定义了一个叫做 <code>bindSecure()</code> 的方法，它使用 HTTPS(Hyper Text Transfer Protocol with Secure Sockets Layer)提供安全连接。要使用 <code>bindSecure()</code> 方法，你需要一个证书，这个证书由证书颁发机构(CA)提供。有关证书的更多信息，请参考<a href="https://www.tldp.org/HOWTO/SSL-Certificates-HOWTO/x64.html">什么是 SSL 和什么是证书</a>？</p>
<p>为了说明问题，下面的服务器 <code>hello_world_server_secure.dart</code> 使用 Dart 团队创建的证书调用 <code>bindSecure()</code> 进行测试。你必须为你的服务器提供自己的证书。</p>
<div class="highlight"><pre class="chroma"><code class="language-dart" data-lang="dart"><span class="k">import</span> <span class="s1">&#39;</span><span class="s1">dart:io</span><span class="s1">&#39;</span><span class="p">;</span>

<span class="kt">String</span> <span class="n">certificateChain</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s1">server_chain.pem</span><span class="s1">&#39;</span><span class="p">;</span>
<span class="kt">String</span> <span class="n">serverKey</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s1">server_key.pem</span><span class="s1">&#39;</span><span class="p">;</span>

<span class="n">Future</span> <span class="n">main</span><span class="p">(</span><span class="p">)</span> <span class="kd">async</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="n">serverContext</span> <span class="o">=</span> <span class="n">SecurityContext</span><span class="p">(</span><span class="p">)</span><span class="p">;</span> <span class="cm">/*1*/</span>
  <span class="n">serverContext</span><span class="p">.</span><span class="n">useCertificateChain</span><span class="p">(</span><span class="n">certificateChain</span><span class="p">)</span><span class="p">;</span> <span class="cm">/*2*/</span>
  <span class="n">serverContext</span><span class="p">.</span><span class="n">usePrivateKey</span><span class="p">(</span><span class="n">serverKey</span><span class="p">,</span> <span class="nl">password:</span> <span class="s1">&#39;</span><span class="s1">dartdart</span><span class="s1">&#39;</span><span class="p">)</span><span class="p">;</span> <span class="cm">/*3*/</span>

  <span class="kd">var</span> <span class="n">server</span> <span class="o">=</span> <span class="kd">await</span> <span class="n">HttpServer</span><span class="p">.</span><span class="n">bindSecure</span><span class="p">(</span>
    <span class="s1">&#39;</span><span class="s1">localhost</span><span class="s1">&#39;</span><span class="p">,</span>
    <span class="m">4047</span><span class="p">,</span>
    <span class="n">serverContext</span><span class="p">,</span> <span class="cm">/*4*/</span>
  <span class="p">)</span><span class="p">;</span>
  <span class="n">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="s1">Listening on localhost:</span><span class="si">${</span><span class="n">server</span><span class="p">.</span><span class="n">port</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span><span class="p">;</span>
  <span class="kd">await</span> <span class="k">for</span> <span class="p">(</span><span class="n">HttpRequest</span> <span class="n">request</span> <span class="k">in</span> <span class="n">server</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">request</span><span class="p">.</span><span class="n">response</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="s1">Hello, world!</span><span class="s1">&#39;</span><span class="p">)</span><span class="p">;</span>
    <span class="kd">await</span> <span class="n">request</span><span class="p">.</span><span class="n">response</span><span class="p">.</span><span class="n">close</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div><p>/<em>1</em>/ 安全网络连接的可选设置在 SecurityContext 对象中指定，有一个默认的对象 SecurityContext.defaultContext，包括知名证书机构的可信根证书。</p>
<p>/<em>2</em>/ 一个包含从服务器证书到签名机关根证书链的文件，<a href="https://en.wikipedia.org/wiki/Privacy-Enhanced_Mail">格式为 PEM</a>。</p>
<p>/<em>3</em>/ 一个包含（加密的）服务器证书私钥的文件，<a href="https://en.wikipedia.org/wiki/Privacy-Enhanced_Mail">PEM 格式</a>。</p>
<p>/<em>4</em>/ 在服务器上，上下文参数是必需的，对客户端来说是可选的。如果省略它，则使用默认的内置可信根的上下文。</p>
<h2 id="其他资源">其他资源&nbsp;<a class="headline-hash no-text-decoration" href="#其他资源">#</a> </h2>
<p>请访问这些 API 文档，了解本教程中讨论的类和库的更多细节。</p>
<table>
<thead>
<tr>
<th align="left">Dart 类</th>
<th align="left">目的</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left"><a href="https://api.dart.dev/stable/dart-io/HttpServer-class.html">HttpServer</a></td>
<td align="left">一个 HTTP 服务器</td>
</tr>
<tr>
<td align="left"><a href="https://api.dart.dev/stable/dart-io/HttpClient-class.html">HttpClient</a></td>
<td align="left">一个 HTTP 客户端</td>
</tr>
<tr>
<td align="left"><a href="https://api.dart.dev/stable/dart-io/HttpRequest-class.html">HttpRequest</a></td>
<td align="left">一个服务器端请求对象</td>
</tr>
<tr>
<td align="left"><a href="https://api.dart.dev/stable/dart-io/HttpResponse-class.html">HttpResponse</a></td>
<td align="left">一个服务器端响应对象</td>
</tr>
<tr>
<td align="left"><a href="https://api.dart.dev/stable/dart-io/HttpClientRequest-class.html">HttpClientRequest</a></td>
<td align="left">一个客户端请求对象</td>
</tr>
<tr>
<td align="left"><a href="https://api.dart.dev/stable/dart-io/HttpClientResponse-class.html">HttpClientResponse</a></td>
<td align="left">一个客户端响应对象</td>
</tr>
<tr>
<td align="left"><a href="https://api.dart.dev/stable/dart-io/HttpHeaders-class.html">HttpHeaders</a></td>
<td align="left">请求头</td>
</tr>
<tr>
<td align="left"><a href="https://api.dart.dev/stable/dart-io/HttpStatus-class.html">HttpStatus</a></td>
<td align="left">响应的状态</td>
</tr>
<tr>
<td align="left"><a href="https://api.dart.dev/stable/dart-io/InternetAddress-class.html">InternetAddress</a></td>
<td align="left">一个互联网地址</td>
</tr>
<tr>
<td align="left"><a href="https://api.dart.dev/stable/dart-io/SecurityContext-class.html">SecurityContext</a></td>
<td align="left">包含安全连接的证书、密钥和信任信息。</td>
</tr>
<tr>
<td align="left"><a href="https://pub.dev/packages/http_server">http_server</a> 包</td>
<td align="left">一个具有较高级别的 HTTP 类的包</td>
</tr>
</tbody>
</table>
<h2 id="下一步该怎么做">下一步该怎么做？&nbsp;<a class="headline-hash no-text-decoration" href="#下一步该怎么做">#</a> </h2>
<ul>
<li>如果你还没有尝试过服务器端的 codelab，可以尝试<a href="https://dart-lang.github.io/server/codelab/">编写一个服务器应用程序</a>。</li>
<li><a href="https://dart-lang.github.io/server/">Servers with Dart</a> 链接到编写独立 Dart 应用程序的资源，包括服务器。</li>
</ul>


        </div>
    </div>
</article>



                <footer>
                    




<div class="no-text-decoration">
    <div class="jump top"><a href="#" title="Top of this page">⮉</a></div>
    <div class="jump bottom"><a href="#bottom" title="Bottom of this page">⮋</a></div>
</div>


 
    
        <div class="hugotoc no-text-decoration">
            <nav id="TableOfContents">
  <ul>
    <li><a href="#获取源码">获取源码</a></li>
    <li><a href="#运行-hello-world-服务器">运行 hello world 服务器</a>
      <ul>
        <li><a href="#快速浏览一下代码">快速浏览一下代码</a></li>
      </ul>
    </li>
    <li><a href="#将服务器绑定到主机和端口">将服务器绑定到主机和端口</a>
      <ul>
        <li><a href="#主机名">主机名</a></li>
        <li><a href="#端口">端口</a></li>
        <li><a href="#侦听请求">侦听请求</a></li>
      </ul>
    </li>
    <li><a href="#使用-html-表单发出-get-请求">使用 HTML 表单发出 GET 请求</a>
      <ul>
        <li><a href="#一个-restful-get-请求">一个 RESTful GET 请求</a></li>
      </ul>
    </li>
    <li><a href="#监听和处理请求">监听和处理请求</a>
      <ul>
        <li><a href="#使用方法属性">使用方法属性</a></li>
        <li><a href="#使用-uri-属性">使用 uri 属性</a></li>
        <li><a href="#设置响应的状态码">设置响应的状态码</a></li>
        <li><a href="#将响应写到-httpresponse-对象">将响应写到 HttpResponse 对象</a></li>
      </ul>
    </li>
    <li><a href="#从独立的客户端进行-post-请求">从独立的客户端进行 POST 请求</a>
      <ul>
        <li></li>
        <li><a href="#一个-restful-post-请求">一个 RESTful POST 请求</a></li>
      </ul>
    </li>
    <li><a href="#在服务器中处理一个-post-请求">在服务器中处理一个 POST 请求</a>
      <ul>
        <li><a href="#关于-cors-头的说明">关于 CORS 头的说明</a></li>
      </ul>
    </li>
    <li><a href="#使用-http_server-包">使用 http_server 包</a>
      <ul>
        <li><a href="#试试吧-1">试试吧</a></li>
        <li><a href="#试试吧-2">试试吧</a></li>
      </ul>
    </li>
    <li><a href="#使用-bindsecure-的-https-方法">使用 bindSecure() 的 https 方法</a></li>
    <li><a href="#其他资源">其他资源</a></li>
    <li><a href="#下一步该怎么做">下一步该怎么做？</a></li>
  </ul>
</nav>
            <a href="#" class="back-to-top">Back to top</a>
        </div>
    
    
<script src="/js/libs/jquery/3.3.1/jquery.slim.min.min.528a9ce56371729e50605653bf72b1e933574cdb97519529bf8fab01b63f9703.js"></script>

<link rel="preload" href="/js/libs/jquery/3.3.1/jquery.slim.min.min.528a9ce56371729e50605653bf72b1e933574cdb97519529bf8fab01b63f9703.js" as="script">

<script type="application/javascript">(function() {
     var $window = $(window);
     if ($window.width() >= 1400) { 
         var $toc = $('#TableOfContents');
         if ($toc.length > 0) {
             function onScroll(){
                 var currentScroll = $window.scrollTop();
                 var h = $('.content h1, .content h2, .content h3, .content h4, .content h5, .content h6, .h-feed h2');
                 var id = "";
                 h.each(function (i, e) {
                     e = $(e);
                     if (e.offset().top - 10 <= currentScroll) {
                         id = e.attr('id');
                     }
                 });
                 var current = $toc.find('a.current');
                 if (current.length == 1 && current.eq(0).attr('href') == '#' + id) return true;

                 current.each(function (i, e) {
                     $(e).removeClass('current').siblings('ul').hide();
                 });
                 $toc.find('a[href="#' + id + '"]').parentsUntil('#TableOfContents').each(function (i, e) {
                     $(e).children('a').addClass('current').siblings('ul').show();
                 });
             }
             $window.on('scroll', onScroll);
             $(document).ready(function() {
                 $toc.find('a').parent('li').find('ul').hide();
                 onScroll();
                 document.getElementsByClassName('hugotoc')[0].style.display = '';
             });}}})();</script>








<div class="backtotop center no-text-decoration">
    <a href="#">back to <span class="top">top</span></a>
</div>


<div class="right">
    <div class="taxo no-text-decoration">
         
            
                <ul class="no-bullets inline categories">
                    
                        
                        
                        
                            
                            
                            
                            
                            
                            <li class="__programming__"
                                
                                
                                title="See all 22 posts categorized in ‘programming’"
                                
                            >
                                <a class="p-category" href="https://ohmyweekly.github.io/categories/programming/">programming</a>
                            </li>
                        
                    
                </ul>
            
         
            
                <ul class="no-bullets inline tags">
                    
                        
                        
                        
                            
                            
                            
                            
                            
                            <li class="__flutter__"
                                
                                
                                title="See all 7 posts tagged with ‘flutter’"
                                
                            >
                                <a class="p-category" href="https://ohmyweekly.github.io/tags/flutter/">flutter</a>
                            </li>
                        
                    
                        
                        
                        
                            
                            
                            
                            
                            
                            <li class="__client__"
                                
                                
                                title="This is the only post tagged with ‘client’"
                                
                            >
                                <a class="p-category" href="https://ohmyweekly.github.io/tags/client/">client</a>
                            </li>
                        
                    
                </ul>
            
        
    </div>

</div>
<div class="clear-float"></div>



<div class="prev-next-navigator clear-float">
    
        <span class="prev-post left no-text-decoration">
            <a href="https://ohmyweekly.github.io/notes/publishing-packages/" class="nobr">« 发布包</a>
        </span>
    
    
        <span class="next-post right no-text-decoration">
            <a href="https://ohmyweekly.github.io/notes/how-to-use-packages/" class="nobr">如何使用包 »</a>
        </span>
    
</div>


<a id="bottom"></a>









                       







                    <ul class="no-bullets feed right inline">
    
        
        
    
</ul>
<div class="clear-float"></div>

                </footer>
                <hr />
            </div>               

            <footer> 
                

<ul class="social no-text-decoration">
    
</ul>













<p class="generated no-text-decoration">
    Generated using  <a href="https://gitlab.com/kaushalmodi/hugo-theme-refined"><code class="nobr">hugo-theme-refined</code></a> + <span class="nobr">Hugo 0.63.2</span>
</p>

<p>
    
</p>




<div class="badges no-text-decoration">
    
    

    
</div>




<script type="application/javascript">var nav=responsiveNav("#nav");</script>




<script defer src="/js/libs/fragmentions/wrapper.min.4c511209cd3786314b251d891c8da528b47a972669aa4eea416b64d4be01eee2.js"></script>









            </footer>
        </div> 
    </body>
</html>
