<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-us" lang="en-us">

    <head>
    <link href="https://gmpg.org/xfn/11" rel="profile">
    <meta charset="utf-8">
    
    
    

    
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5">

    
    <meta name="referrer" content="no-referrer">

    <title>
        
            NQP 练习题 ❚ 焉知非鱼
        
    </title>

    
    


    
    
    
    

    
    
    
    

    
    
    

    
    
    
    <style>
     
     
     :root {
         --theme-color: #ac4142;
         --theme-color-light: rgba(172, 65, 66, 0.2);
     }
     
     html {
         line-height: 1.5;
     }
    </style>

    
    

    
    
    
    
    <link rel="stylesheet" href="/css/refined.min.7f6d3ee611034e4ebcbc063f1db3bc042fecdc8901afbedad80ff02bae409204.css">
    
    <link rel="preload" href="/css/refined.min.7f6d3ee611034e4ebcbc063f1db3bc042fecdc8901afbedad80ff02bae409204.css" as="style">

    



    
        <style>
         
         /* Background */ .chroma { background-color: #ffffff }
/* Error */ .chroma .err { color: #a61717; background-color: #e3d2d2 }
/* LineTableTD */ .chroma .lntd { vertical-align: top; padding: 0; margin: 0; border: 0; }
/* LineTable */ .chroma .lntable { border-spacing: 0; padding: 0; margin: 0; border: 0; width: auto; overflow: auto; display: block; }
/* LineHighlight */ .chroma .hl { display: block; width: 100%;background-color: #ffffcc }
/* LineNumbersTable */ .chroma .lnt { margin-right: 0.4em; padding: 0 0.4em 0 0.4em; }
/* LineNumbers */ .chroma .ln { margin-right: 0.4em; padding: 0 0.4em 0 0.4em; }
/* Keyword */ .chroma .k { color: #000000; font-weight: bold }
/* KeywordConstant */ .chroma .kc { color: #000000; font-weight: bold }
/* KeywordDeclaration */ .chroma .kd { color: #000000; font-weight: bold }
/* KeywordNamespace */ .chroma .kn { color: #000000; font-weight: bold }
/* KeywordPseudo */ .chroma .kp { color: #000000; font-weight: bold }
/* KeywordReserved */ .chroma .kr { color: #000000; font-weight: bold }
/* KeywordType */ .chroma .kt { color: #445588; font-weight: bold }
/* NameAttribute */ .chroma .na { color: #008080 }
/* NameBuiltin */ .chroma .nb { color: #0086b3 }
/* NameBuiltinPseudo */ .chroma .bp { color: #999999 }
/* NameClass */ .chroma .nc { color: #445588; font-weight: bold }
/* NameConstant */ .chroma .no { color: #008080 }
/* NameDecorator */ .chroma .nd { color: #3c5d5d; font-weight: bold }
/* NameEntity */ .chroma .ni { color: #800080 }
/* NameException */ .chroma .ne { color: #990000; font-weight: bold }
/* NameFunction */ .chroma .nf { color: #990000; font-weight: bold }
/* NameLabel */ .chroma .nl { color: #990000; font-weight: bold }
/* NameNamespace */ .chroma .nn { color: #555555 }
/* NameTag */ .chroma .nt { color: #000080 }
/* NameVariable */ .chroma .nv { color: #008080 }
/* NameVariableClass */ .chroma .vc { color: #008080 }
/* NameVariableGlobal */ .chroma .vg { color: #008080 }
/* NameVariableInstance */ .chroma .vi { color: #008080 }
/* LiteralString */ .chroma .s { color: #dd1144 }
/* LiteralStringAffix */ .chroma .sa { color: #dd1144 }
/* LiteralStringBacktick */ .chroma .sb { color: #dd1144 }
/* LiteralStringChar */ .chroma .sc { color: #dd1144 }
/* LiteralStringDelimiter */ .chroma .dl { color: #dd1144 }
/* LiteralStringDoc */ .chroma .sd { color: #dd1144 }
/* LiteralStringDouble */ .chroma .s2 { color: #dd1144 }
/* LiteralStringEscape */ .chroma .se { color: #dd1144 }
/* LiteralStringHeredoc */ .chroma .sh { color: #dd1144 }
/* LiteralStringInterpol */ .chroma .si { color: #dd1144 }
/* LiteralStringOther */ .chroma .sx { color: #dd1144 }
/* LiteralStringRegex */ .chroma .sr { color: #009926 }
/* LiteralStringSingle */ .chroma .s1 { color: #dd1144 }
/* LiteralStringSymbol */ .chroma .ss { color: #990073 }
/* LiteralNumber */ .chroma .m { color: #009999 }
/* LiteralNumberBin */ .chroma .mb { color: #009999 }
/* LiteralNumberFloat */ .chroma .mf { color: #009999 }
/* LiteralNumberHex */ .chroma .mh { color: #009999 }
/* LiteralNumberInteger */ .chroma .mi { color: #009999 }
/* LiteralNumberIntegerLong */ .chroma .il { color: #009999 }
/* LiteralNumberOct */ .chroma .mo { color: #009999 }
/* Operator */ .chroma .o { color: #000000; font-weight: bold }
/* OperatorWord */ .chroma .ow { color: #000000; font-weight: bold }
/* Comment */ .chroma .c { color: #999988; font-style: italic }
/* CommentHashbang */ .chroma .ch { color: #999988; font-style: italic }
/* CommentMultiline */ .chroma .cm { color: #999988; font-style: italic }
/* CommentSingle */ .chroma .c1 { color: #999988; font-style: italic }
/* CommentSpecial */ .chroma .cs { color: #999999; font-weight: bold; font-style: italic }
/* CommentPreproc */ .chroma .cp { color: #999999; font-weight: bold; font-style: italic }
/* CommentPreprocFile */ .chroma .cpf { color: #999999; font-weight: bold; font-style: italic }
/* GenericDeleted */ .chroma .gd { color: #000000; background-color: #ffdddd }
/* GenericEmph */ .chroma .ge { color: #000000; font-style: italic }
/* GenericError */ .chroma .gr { color: #aa0000 }
/* GenericHeading */ .chroma .gh { color: #999999 }
/* GenericInserted */ .chroma .gi { color: #000000; background-color: #ddffdd }
/* GenericOutput */ .chroma .go { color: #888888 }
/* GenericPrompt */ .chroma .gp { color: #555555 }
/* GenericStrong */ .chroma .gs { font-weight: bold }
/* GenericSubheading */ .chroma .gu { color: #aaaaaa }
/* GenericTraceback */ .chroma .gt { color: #aa0000 }
/* GenericUnderline */ .chroma .gl { text-decoration: underline }
/* TextWhitespace */ .chroma .w { color: #bbbbbb }

         
         /* Overrides on top of the theme and Chroma CSS */
/* Chroma-based lines highlighting in code blocks */
.chroma .hl {
    background-color: #e8e8e8;
    /* Extend highlight up to 100 characters (assuming that the code blocks never have more than 100 characters in a line) */
    min-width: 100ch;
}
/* GenericHeading */ .chroma .gh { color: #999999; font-weight: bold }
/* GenericSubheading */ .chroma .gu { color: #aaaaaa; font-weight: bold }

         
        </style>
    

    

    
    
    

    
    <script src="/js/responsive-nav-orig.min.e2b5f2a956b488f466da513820636134defdc38b90ed566248960593f2bb4ba5.js"></script>
    
    <link rel="preload" href="/js/responsive-nav-orig.min.e2b5f2a956b488f466da513820636134defdc38b90ed566248960593f2bb4ba5.js" as="script">

    
    
    <script defer src="/js/libs/fa/fontawesome-all.min.08916ac0fd078adfb58edc890460e2c8990729aee02bca7586404b56805f5219.js"></script>
    
    <link rel="preload" href="/js/libs/fa/fontawesome-all.min.08916ac0fd078adfb58edc890460e2c8990729aee02bca7586404b56805f5219.js" as="script">

    

    

    
    
    

    
    
<!-- rel="me" links for IndieAuth -->







    
 
<meta property="og:title" content="NQP 练习题" />
<meta property="og:description"
      content=" " />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://ohmyweekly.github.io/notes/nqp-exercises/" />


    
        <meta property="article:published_time" content="2019-07-20T11:05:26&#43;08:00"/>
    
    
        <meta property="article:modified_time" content="2019-07-20T11:05:26&#43;08:00"/>
    









    




     <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="NQP 练习题"/>
<meta name="twitter:description" content=" "/>


    
    
    <link rel="alternate" type="application/jf2post+json" href="https://ohmyweekly.github.io/notes/nqp-exercises/jf2post.json" title="Jf2post for 焉知非鱼" />
    
     



    
    
    
        
    


     
        
        <meta name="DC.Creator" content="焉知非鱼"/>
    



    
    
    
    <meta name="hugo-build-date" content="2024-03-01T16:16:06Z"/>
    <meta name="hugo-commit-hash" content="312735366b20d64bd61bff8627f593749f86c964"/>
    <meta name="generator" content="Hugo 0.123.7">
</head>


    
        <body lang="en">
    

        
        <div class="border" id="home"></div>

        <div class="wrapper">   
            
<nav id="nav" class="nav-collapse opened" aria-hidden="false">
    <ul class="navbar">
        <li><a class="" href="/">Home</a></li>
        
            
                <li><a class="" href="https://ohmyweekly.github.io/posts/">Posts</a></li>
            
        
            
                <li><a class="" href="https://ohmyweekly.github.io/notes/">Notes</a></li>
            
        
        
            <li><a class="" href="https://ohmyweekly.github.io/search/">Search</a></li>
        
    </ul>
</nav>

            <div class="container">
                <header class="masthead">
                    <div class="masthead-title no-text-decoration">
                        <a href="/">焉知非鱼</a> <span class="blinking-cursor">❚</span>
                    </div>
                    <div class="masthead-tagline">
                        Wait the light to fall
                    </div>
                </header>

                








<article class="post h-entry notes">
    <header>
        <div class="center">
    <div class="taxo no-text-decoration">
         
            
                <ul class="no-bullets inline categories">
                    
                        
                        
                        
                            
                            
                            
                            
                            
                            <li class="__rakulang__"
                                
                                
                                title="See all 0 posts categorized in ‘rakulang’"
                                
                            >
                                <a class="p-category" href="https://ohmyweekly.github.io/categories/rakulang/">rakulang</a>
                            </li>
                        
                    
                </ul>
            
         
            
                <ul class="no-bullets inline tags">
                    
                        
                        
                        
                            
                            
                            
                            
                            
                            <li class="__rakulang__"
                                
                                
                                title="See all 0 posts tagged with ‘rakulang’"
                                
                            >
                                <a class="p-category" href="https://ohmyweekly.github.io/tags/rakulang/">rakulang</a>
                            </li>
                        
                    
                </ul>
            
        
    </div>

</div>

        <h1 class="post-title p-name">NQP 练习题</h1>

        
        <data class="u-url" value="https://ohmyweekly.github.io/notes/nqp-exercises/"></data>

        <div class="date-syndication">
            


    
    
    <div class="post-date">
        
        <time datetime="2019-07-20T11:05:26+0800" class="dt-published">Sat Jul 20, 2019</time>
        
        
    </div>


            




        </div>
         



    
    
    
        
    


    
        
        <span class="hide">
            &mdash; <a href="https://ohmyweekly.github.io/" class="u-author">焉知非鱼</a>
        </span>
    


    </header>

    <div class="content">
        


        





                       


        <div class="e-content">
            




<h1 id="练习-1">练习 1</h1>
<p>本练习将让您在 NQP 中执行一些简单的任务，以熟悉基本语法。</p>
<h2 id="hello-world">Hello, world&nbsp;<a class="headline-hash no-text-decoration" href="#hello-world">#</a> </h2>
<p>最简单的事情:</p>
<pre><code>say('Hello, world');
</code></pre>
<p>现在把它弄错:</p>
<pre><code>say 'Hello, world';
</code></pre>
<p>请注意你将如何大声地抱怨。</p>
<h2 id="变量">变量&nbsp;<a class="headline-hash no-text-decoration" href="#变量">#</a> </h2>
<ol>
<li>将值绑定到标量。</li>
<li>使用 <code>say</code> 来输出它.</li>
<li>尝试使用赋值代替绑定。 观察它的失败。</li>
<li>声明一个数组。 使用索引, 例如 <code>@a[0]</code>, 去绑定并访问元素。
注意在 Raku 中, 符号是不变的; 使用 <code>$a[0]</code> 则会抱怨未声明的 <code>$a</code>!</li>
<li>尝试绑定一个数组字面量, 例如 <code>[1,2,3]</code> 到一个 <code>@arr</code> 变量上。现在把该数组字面量绑定到一个 <code>$scalar</code> 变量上。注意观察索引是怎样在这两种结构上都工作良好的。</li>
<li>声明一个哈希变量, <code>%h</code>. 尝试使用字面值语法索引 (<code>%h&lt;key&gt;</code>) 和花括号语法索引 (<code>%h{'key'}</code>)。</li>
</ol>
<h2 id="循环">循环&nbsp;<a class="headline-hash no-text-decoration" href="#循环">#</a> </h2>
<ol>
<li>使用 <code>for</code> 来迭代数组, 一次迭代一个元素, 先使用 <code>$_</code> 迭代, 然后使用 pointy block (<code>for @a -&gt; $val { ... }</code>) 迭代。</li>
<li>你可以一次迭代两个元素吗？ 试试看！</li>
<li>迭代散列变量, 打印出该散列每个 pair 对儿的 <code>.key</code> 和 <code>.value</code>。</li>
</ol>
<h2 id="子例程">子例程&nbsp;<a class="headline-hash no-text-decoration" href="#子例程">#</a> </h2>
<p>实现一个递归的阶乘子例程, <code>sub fac</code>。 如果你做对了 , <code>fac(10)</code> 会返回 3628800。</p>
<h2 id="类">类&nbsp;<a class="headline-hash no-text-decoration" href="#类">#</a> </h2>
<ol>
<li>声明一个 <code>BarTab</code> 类。为它提供表号的标量属性和项的数组属性。</li>
<li>写一个返回表号的 <code>table</code>方法。</li>
<li>写一个接收项名和价格的 <code>add_order</code> 方法。在项属性上放上一个带有键 <code>name</code> 和键 <code>price</code> 的散列。</li>
<li>写一个能产生字符串的 <code>render_tab</code> 方法, 它描述 tab 上有什么(items, price for each item, total)</li>
<li>创建一个 tab (<code>BarTab.new(table =&gt; 42)</code>)。 检查 <code>table</code> 方法是否返回 42。添加一些项并确保工作正常。你甚至想使用 NQP 的内置函数 <code>plan(...)</code> 和 <code>ok(...)</code> - 来测试!</li>
</ol>
<h2 id="multi-methods">Multi-methods&nbsp;<a class="headline-hash no-text-decoration" href="#multi-methods">#</a> </h2>
<ol>
<li>给 <code>add_order</code> 添加一个方法。然后把当前的 <code>add_order</code> 方法变成一个 multi 方法 (只须在它前面加上关键字 <code>multi</code>)。确保所有的都正常工作。</li>
<li>给 <code>add_order</code> 添加另一个接收 3 个参数的 multi 候选者, 第三个参数是数量。对于此候选者，将指定次数的项散列添加到数组中。</li>
</ol>
<h2 id="如果时间允许">如果时间允许&hellip;&nbsp;<a class="headline-hash no-text-decoration" href="#如果时间允许">#</a> </h2>
<ol>
<li>写一个词法类 <code>Item</code> (在你的 <code>BarTab</code> 类中用 <code>my</code> 声明的类). 给它加上 <code>name</code> 和 <code>price</code> 属性, 和访问这些属性的方法。</li>
<li>重构你的代码以使用该内部类, 所以你拥有一个 <code>Item</code> 的数组, 而不是一个散列的数组。</li>
<li>重构你的代码，以便代替项目列表中显示的项目, 如果被订购多次，则每个项都有一个数量。 （您可能希望在 <code>BarTab</code> 中切换到使用散列而不是数组，因此您可以按名称查找项，只更新已订购的项的数量。）</li>
</ol>
<h1 id="练习-2">练习 2</h1>
<h2 id="grammar">Grammar&nbsp;<a class="headline-hash no-text-decoration" href="#grammar">#</a> </h2>
<p>以纯文本格式，来自 Raku irc 频道的日志如下所示:</p>
<pre><code>14:30 colomon     r: say 2**100
14:30 camelia     rakudo 624ff7: OUTPUT«1267650600228229401496703205376␤»
14:30 colomon     sweet!!!!!
14:30 TimToady    bet that took a lot of electrons...
</code></pre>
<p>也就是说，时间，昵称和一些文本。首先写一个解析任意行数的 grammar，捕获时间，昵称和文本。遍历匹配对象并检查它是否具有正确的输出。</p>
<h2 id="actions">Actions&nbsp;<a class="headline-hash no-text-decoration" href="#actions">#</a> </h2>
<p>声明一个 <code>Utterance</code> 类来表示一行聊天。它应该有三个属性：time，nick 和 text，以及访问它们的方法。您可以依赖默认构造函数来设置它们。</p>
<p>现在编写一个 actions 类，为每行文本构建此类的实例。最后，添加一个生成数组的 <code>TOP</code> action 方法。</p>
<h2 id="额外任务-actions">额外任务: Actions&nbsp;<a class="headline-hash no-text-decoration" href="#额外任务-actions">#</a> </h2>
<p>除了正常的聊天行外，还有一些 action 行，它们在昵称前有一个 <code>*</code>：</p>
<pre><code>    07:26 moritz      r: say (1, 2, 3).map({()}).flat.perl
    07:26 camelia     rakudo 099f0b: OUTPUT«().list␤»
    07:26 * moritz    wonders if .grep itself flattens
</code></pre>
<p>添加对解析此内容的支持，并将其作为额外属性记录在 <code>Utterance</code> 中。</p>
<h2 id="额外任务-collect-lines">额外任务: Collect lines&nbsp;<a class="headline-hash no-text-decoration" href="#额外任务-collect-lines">#</a> </h2>
<p>用一个数组替换 <code>Utterance</code> 中的 text 属性。然后，如果单个昵称说出多个连续的文本行，则将它们放入单个数组中并为它们创建单个 <code>Utterance</code> 实例。</p>
<h1 id="练习-3">练习 3</h1>
<h2 id="熟悉">熟悉&nbsp;<a class="headline-hash no-text-decoration" href="#熟悉">#</a> </h2>
<p>采用 SlowDB 实现。查看我们目前看到的代码，并运行一些简单的 <code>INSERT</code> 和 <code>SELECT</code> 查询。</p>
<h2 id="delete">DELETE&nbsp;<a class="headline-hash no-text-decoration" href="#delete">#</a> </h2>
<p>实现删除行的功能。 <code>DELETE</code> 查询的示例如下：</p>
<pre><code>DELETE WHERE name = 'jnthn'
DELETE WHERE name = 'jnthn', is_action = 1
</code></pre>
<p>也就是说，可以存在一个条件或由逗号分隔的条件的组合。</p>
<h2 id="update">UPDATE&nbsp;<a class="headline-hash no-text-decoration" href="#update">#</a> </h2>
<p>实现更新现有行的功能。 <code>UPDATE</code> 查询的示例如下：</p>
<pre><code>UPDATE WHERE type = 'stout' SET tasty = 1
UPDATE WHERE type = 'stout' SET tasty = 1, dark = 1
UPDATE WHERE type = 'stotu' SET type = 'stout'
</code></pre>
<h2 id="refactor">Refactor&nbsp;<a class="headline-hash no-text-decoration" href="#refactor">#</a> </h2>
<p>现在有三件事支持 <code>WHERE</code> 子句：<code>SELECT</code>，<code>DELETE</code> 和 <code>UPDATE</code>。你能想出来吗？</p>
<h2 id="如果你是-10x-工程师">如果你是 10x 工程师&hellip;&nbsp;<a class="headline-hash no-text-decoration" href="#如果你是-10x-工程师">#</a> </h2>
<p>扩展 <code>WHERE</code> 子句中可用的运算符范围以包括 <code>!=</code>，<code>&lt;</code>，<code>&lt;=</code>，<code>&gt;</code> 和 <code>&gt;=</code>。</p>
<h1 id="练习-4">练习 4</h1>
<p>创建一个只支持 <code>echo</code> 语句的最小 php 编译器：</p>
<pre><code>echo &quot;&lt;h2&gt;PHP is fun!&lt;/h2&gt;&quot;;
echo &quot;&lt;blink&gt;So 1990s!&lt;/blink&gt;&quot;;
</code></pre>
<h2 id="基础">基础&nbsp;<a class="headline-hash no-text-decoration" href="#基础">#</a> </h2>
<ol>
<li>创建一个新的 NQP 源文件, 然后 <code>use NQPHLL</code>。</li>
<li>创建 <code>HLL::Grammar</code>, <code>HLL::Actions</code> 和 <code>HLL::Compiler</code> 的子类。</li>
<li>写一个 <code>MAIN</code> 子例程, 就像那个 Rubyish 那样, 设立编译器对象并调用 <code>command_line</code>。验证运行没有参数的程序现在进入 REPL，但尝试运行任何代码失败，因为语法没有 <code>TOP</code> 规则。</li>
<li>只需要足够的语法就可以解析一个 <code>echo</code> 状态列表。最后一个不需要后跟分号。再次运行 REPL 并确保您的语法解析，并且您得到的错误是因为没有构建 AST。</li>
<li>写一个 action 方法来制作 <code>QAST</code>。确保您的程序现在运行。</li>
</ol>
<h2 id="走得更远">走得更远&nbsp;<a class="headline-hash no-text-decoration" href="#走得更远">#</a> </h2>
<p>是时候变得更 PHP-ish 了!</p>
<ol>
<li><code>echo</code> 语句不会自动在输出的末尾添加新行，因此请使用 <code>print</code> op 而不是 <code>say</code>。</li>
<li>在你的引用解析器中打开反斜杠序列的解析。这是通过 <code>&lt;quote_EXPR: ':q', ':b'&gt;</code> (注意 <code>:b</code>) 来完成的。 确保现在你可以在 <code>echo &quot;stuff\n&quot;</code> 时是否带有换行。</li>
<li>还可以使用 <code>echo(&quot;with parentheses&quot;)</code>。请实现它。</li>
</ol>
<h1 id="练习-5">练习 5</h1>
<p>在本练习中，您将为 PHPish 添加一些功能，以便探索我们一直在研究的 QAST 节点。到最后，您应该能够运行以下程序：</p>
<h2 id="values">Values&nbsp;<a class="headline-hash no-text-decoration" href="#values">#</a> </h2>
<p>到目前为止，<code>echo</code> 只能处理字符串参数。是时候改变它了！添加一个 <code>value</code> protoregex，以及解析整数，浮点数和字符串的候选者。确保您的 string token 如下所示：</p>
<pre><code>token value:sym&lt;string&gt; { &lt;?[&quot;]&gt; &lt;quote_EXPR: ':q', ':b'&gt; }
</code></pre>
<p>这样你就能够处理 <code>\n</code>。 添加适当的 action 方法（记住 protoregex 本身不需要一个 action 方法）。 更新 <code>echo</code> 规则和 action 方法以接收 <code>value</code>，而不仅仅是字符串。 确保您可以像以前一样运行相同的操作，并且：</p>
<pre><code>echo 42;
echo 1.5;
</code></pre>
<h2 id="operators">Operators&nbsp;<a class="headline-hash no-text-decoration" href="#operators">#</a> </h2>
<p>研究运算符优先级解析材料。 设置两个优先级，一个用于加法，一个用于乘法运算符。 像 Rubyish 一样添加四个常用的算术运算（<code>+</code>， <code>-</code> ，<code>*</code>，<code>/</code>）。 再添加 <code>.</code> 用于字符串连接（NQP 用于连接操作的叫 <code>concat</code>）。</p>
<p>接下来，为<code>术语</code> protoregex 添加一个候选项，该术语应该调用 <code>value</code> 来解析一个值。 这需要匹配的 action 方法。</p>
<p>最后，更新 <code>echo</code> 以解析 <code>EXPR</code> 而不是 <code>value</code>。 你现在应该能够运行：</p>
<pre><code>echo 2 * 5 . &quot;\n&quot;;
</code></pre>
<h2 id="variables">Variables&nbsp;<a class="headline-hash no-text-decoration" href="#variables">#</a> </h2>
<p>奇怪的是，PHP 局部变量对 Ruby 有类似的声明语义：首先赋值声明。 围绕全局变量有一些更有趣的规则，但我们暂时将它们放在一边。</p>
<p>首先，为赋值添加优先级，并且赋值运算符被映射到 <code>bind</code> op。 此外，添加 grammar 规则和 action 方法，以便表达式可以用作语句。 在此之后，您应该能够解析：</p>
<pre><code>1 = 1
</code></pre>
<p>但是，这是无稽之谈，所以它会在代码生成过程中出错。</p>
<p>我们现在需要更多地关注块结构。 更新您的 <code>TOP</code> grammar 规则以声明 <code>$*CUR_BLOCK</code>，就像我们在 Rubyish 中所做的那样，并对 action 方法进行匹配更新。</p>
<p>接下来，实现变量解析。 再一次，您可以从我们在 Rubyish 中所做的工作中获得灵感，但变量命名规则如下：</p>
<ul>
<li>变量以 <code>$</code> 符号开头，后跟变量名。</li>
<li>变量名必须以字母或下划线字符开头（不是数字）</li>
<li>变量名只能包含字母数字字符和下划线（A..Z，a..z，0..9，和 <code>_</code>）</li>
</ul>
<p>还要记住 PHP 不是面向行的。 完成后，您应该能够执行以下程序:</p>
<pre><code>$emotion = &quot;awesome&quot;;
echo &quot;PHP is &quot; . $emotion . &quot;\n&quot;;
$emotion = $emotion . &quot;st&quot;;
echo &quot;Raku is &quot; . $emotion . &quot;\n&quot;;
</code></pre>
<h2 id="额外任务-functions">额外任务: functions&nbsp;<a class="headline-hash no-text-decoration" href="#额外任务-functions">#</a> </h2>
<p>实现带参数和参数传递的函数！ 完成后，您应该能够运行：</p>
<pre><code>function greet($name) {
    echo &quot;Good day, &quot; . $name . &quot;\n&quot;;
}
greet(&quot;Lena&quot;);
</code></pre>
<p>你可以从 Rubyish 的例子中汲取灵感。 但是，您还需要注意确保函数声明后面不需要分号。</p>
<h1 id="练习-6">练习 6</h1>
<p>这个练习是为了在第一天结束时填补时间，如果我们以某种方式通关了！ 以下是您可以做的一些想法。</p>
<h2 id="基本的数字关系运算符">基本的数字关系运算符&nbsp;<a class="headline-hash no-text-decoration" href="#基本的数字关系运算符">#</a> </h2>
<p>现在，我们将忽略 PHP 的关系运算符所做的类型杂耍，以处理字符串和数字，并处理数字情况。 PHP 有两个比较运算符的优先级：</p>
<pre><code>Tighter level:    &lt; &lt;= &gt; &gt;=
Looser level:     == !=
</code></pre>
<p>它们同时比加法操作更宽松，比赋值操作更紧凑。 不需要任何 action 方法，因为： <code>:op&lt;...&gt;</code> 可以在 <code>&lt;O(...)&gt;</code> 中使用。</p>
<h2 id="ifelse-ifelse">if/else if/else&nbsp;<a class="headline-hash no-text-decoration" href="#ifelse-ifelse">#</a> </h2>
<p>既然我们有关系运算符，那么实现 <code>if</code> 语句是有意义的。 从简单开始：</p>
<pre><code>if ($a &gt; $b) {
  echo &quot;a is bigger than b&quot;;
}
</code></pre>
<p>然后添加 <code>else</code>:</p>
<pre><code>if ($a == $b) {
  echo &quot;a is the same as b&quot;;
}
else {
    echo &quot;a and b differ&quot;;
}
</code></pre>
<p>最后添加上 <code>elseif</code>:</p>
<pre><code>if ($a &gt; $b) {
    echo &quot;a is bigger than b&quot;;
} elseif ($a == $b) {
    echo &quot;a is equal to b&quot;;
} else {
    echo &quot;a is smaller than b&quot;;
}
</code></pre>
<p>要更好地理解如何处理 <code>elseif</code>，请阅读 NQP 的 grammar 和 action 中的适用代码。 在 grammar 和 action 中搜索 <code>statement_control:sym&lt;if&gt;</code> 。</p>
<p>最后但并非最不重要的，您甚至可能想尝试实现悬空形式：</p>
<pre><code>if ($a &gt; $b)
  echo &quot;a is bigger than b&quot;;
</code></pre>
<p>似乎在 <code>elseif</code> 和 <code>else</code> 形式中还有其他奇妙的违规行为，其中也涉及冒号，谁知道它是什么。 但如果你这样做，最好去喝点酒。 或者，我也不知道。</p>
<h2 id="while-循环">while 循环&nbsp;<a class="headline-hash no-text-decoration" href="#while-循环">#</a> </h2>
<p>解析并实现 while 循环:</p>
<pre><code>$i = 1;
while ($i &lt;= 10) {
    $i = $i + 1;
    echo $i;
}
</code></pre>
<p>恭喜。你的 PHP 实现现在是图灵完备的了，现在一切就绪了！
<em>(旁白：实际上图灵完成的时间早一些，因为递归函数和 while 循环是等价的。)</em></p>
<h1 id="练习-7">练习 7</h1>
<p>在本练习中，您将为类，方法，对 PHPish 的 <code>new</code> 运算符和方法调用添加基本支持。当你完成后，你应该能够运行：</p>
<pre><code>class Greeter {
    function greet($who) {
        echo &quot;Greetings, &quot; . $who . &quot;\n&quot;;
    }
}
$g = new Greeter();
$g-&gt;greet(&quot;Anna&quot;);
</code></pre>
<h2 id="首先-元对象">首先, 元对象&nbsp;<a class="headline-hash no-text-decoration" href="#首先-元对象">#</a> </h2>
<p>创建一个简单的元对象，就像 Rubyish 一样，可以支持添加和查找方法。</p>
<h2 id="接下来解析类并为它们生成代码">接下来，解析类并为它们生成代码&nbsp;<a class="headline-hash no-text-decoration" href="#接下来解析类并为它们生成代码">#</a> </h2>
<p>基础知识类似于 Rubyish：类中的函数成为类的方法。因此，您可以窃取该方法，确保使用 PHP 语法。</p>
<h2 id="添加新项">添加新项&nbsp;<a class="headline-hash no-text-decoration" href="#添加新项">#</a> </h2>
<p>这非常相似，你几乎可以直接从 Rubyish 窃取它。请注意不同的空格规则（换行符并不重要）。</p>
<h2 id="添加方法调用">添加方法调用&nbsp;<a class="headline-hash no-text-decoration" href="#添加方法调用">#</a> </h2>
<p>再次，类似的方法工作，模数语法：方法调用运算符是 <code>-&gt;</code>。添加之后，您应该能够运行本节开头的程序 - 但它仍然会失败。问题是我们没有让方法接受调用者（它们所调用的对象）。</p>
<h2 id="支持-this">支持 $this&nbsp;<a class="headline-hash no-text-decoration" href="#支持-this">#</a> </h2>
<p>方法的第一个参数是调用它的对象。在 PHP 中，这被分配给 <code>$this</code>。因此，在类中时，请确保函数始终使用 <code>$this</code> 作为<em>第一个</em>参数。</p>
<h2 id="好吧这是很多复制粘贴">好吧，这是很多复制粘贴&hellip;&nbsp;<a class="headline-hash no-text-decoration" href="#好吧这是很多复制粘贴">#</a> </h2>
<p>对。大多数基于类的对象系统在这个级别上相对类似。尽管如此，你自己有希望能把它们整合到一块儿会让整个事情变得不那么神奇！</p>
<p>顺便说一下，现在你支持 <code>$this</code>，这也应该有效：</p>
<pre><code>class Greeter {
    function greet($who) {
        $this-&gt;greet_custom(&quot;Hej&quot;, $who);
    }
    function greet_custom($greeting, $who) {
        echo $greeting . &quot;, &quot; . $who . &quot;\n&quot;;
    }
}
$g = new Greeter();
$g-&gt;greet(&quot;masak&quot;);
</code></pre>
<h1 id="练习-8">练习 8</h1>
<p>在本练习中，您将稍微扩展 PHPish 对象系统。。。或许很多。</p>
<h2 id="method-缓存">Method 缓存&nbsp;<a class="headline-hash no-text-decoration" href="#method-缓存">#</a> </h2>
<p>首先，使用方法在 NQP 中手动创建一个新的 PHP 类。它看起来像这样：</p>
<pre><code>my $c := PHPClassHOW.new_type(:name('Foo'));
$c.HOW.add_method($c, 'bar', -&gt; $obj { 1 });
</code></pre>
<p>计算 100,000 次方法调用的时间。</p>
<pre><code>my $start := nqp::time_n();
my int $i := 0;
while $i &lt; 100000 {
    $obj.bar();
    $i++;
}
say(nqp::time_n() - $start);
</code></pre>
<p>在您的 <code>PHPClassHOW</code> 中添加一个 <code>compose</code> 方法。在其中，使用 <code>setmethcache</code> 指令。您现在可以使用 <code>%!methods</code> 作为方法缓存散列。添加对您的 <code>compose</code> 方法的调用。重复计时。缓存应该更快（在练习题作者的机器上，没有缓存是 0.194s, 有缓存是 0.066s）。
现在，更新 <code>statement:sym&lt;class&gt;</code> action 方法中的代码, 以便在添加所有方法后调用 <code>compose</code> 方法。</p>
<h2 id="继承">继承&nbsp;<a class="headline-hash no-text-decoration" href="#继承">#</a> </h2>
<p>这是我们想要让其能够工作的例子：</p>
<pre><code>class Dog {
    function bark()  { echo &quot;woof!\n&quot;; }
    function smell() { echo &quot;terrible\n&quot;; }
}
class Puppy extends Dog {
    function bark()  { echo &quot;yap!\n&quot;; }
}
$d = new Dog();
$d-&gt;bark();
$d-&gt;smell();
$p = new Puppy();
$p-&gt;bark();
$p-&gt;smell();
</code></pre>
<p>首先，从解析开始。它是解析类声明的一个非常小的补充，可选择接受 <code>extends</code> 关键字。一旦它解析，你应该能够运行程序，但它将无法进行最后的 <code>smell</code> 调用，因为它是继承的，我们还没有继承。</p>
<p>接下来，更新类的 action 方法。在添加方法的代码之前，如果有 <code>extends</code>，请在元对象上添加一个对 <code>add_parent</code> 的调用（稍后会写入）。要查找父级，请使用作用域设置为 <code>lexical</code> 的 <code>QAST::Var</code> 节点。</p>
<p>您现在应该收到一条错误消息，指出 <code>add_parent</code> 尚未被实现。从这里开始，所有工作都将在 <code>PHPClassHOW</code> 中进行。</p>
<p>添加属性 <code>@!parents</code>。实现将添加到此数组的 <code>add_parent</code>，但仅限于还没有存在父级。如果有，那么 <code>nqp::die</code> 就可以了。这应该清除错误，但同样，最后的<code>ssnell</code> 调用还不起作用。</p>
<p>接下来，更新 <code>find_method</code> 方法。如果要搜索的方法不在 <code>%!methods</code> 中，则应该查看所有父项的方法表。为此，您需要实现方法 <code>parent</code> 和 <code>method_table</code>，以便从基类获取所需的信息。</p>
<p>到目前为止，事情应该能工作 - 但效率不高！为此，您现在还应该更新方法缓存。您可以通过在 <code>find_method</code> 中添加调试语句来确保正确执行此操作，如果缓存正在运行，则不应调用该语句。</p>
<h2 id="如果时间允许-interfaces">如果时间允许: interfaces&nbsp;<a class="headline-hash no-text-decoration" href="#如果时间允许-interfaces">#</a> </h2>
<p>在 PHP 中，接口表示要求某个方法列表由声明它实现它的任何类提供。例如，给定：</p>
<pre><code>interface iBarkable {
    function bark();
}
</code></pre>
<p>那么这个类就是好的:</p>
<pre><code>class Dog implements iBarkable {
    function bark()  { echo &quot;woof!\n&quot;; }
    function smell() { echo &quot;terrible\n&quot;; }
}
</code></pre>
<p>而这个类应该导致错误:</p>
<pre><code>class BadDog implements iBarkable {
    function smell() { echo &quot;terrible\n&quot;; }
}
</code></pre>
<p>因为它缺少 <code>bark</code> 方法。 您的目标是实现此功能。 这里有一些提示。</p>
<ol>
<li>首先在其中添加对接口和方法需求的解析。</li>
<li>一旦有效，编写一个 <code>PHPInterfaceHOW</code>，可用于保存所需方法的列表。 因为你应该使用 <code>Uninstantiable</code> REPR, 因为不允许创建接口的实例。</li>
<li>将 <code>implements</code> 关键字解析添加到 <code>class</code> 声明中。 设置在 <code>PHPClassHOW</code> 上调用 <code>add_interface</code> 方法的 action 方法，应该将接口添加到  <code>@!interfaces</code> 属性。</li>
<li>你现在应该发现上面的例子都编译了，但第二个例子没有被拒绝。 为了实现这一点，在 <code>PHPClassHOW</code> 的 <code>compose</code> 方法中，编写代码，获取每个接口需求方法的列表。并检查类是否提供它们。</li>
</ol>
<h1 id="练习-9">练习 9</h1>
<p>本练习将带您进行正则表达式实现的简短介绍。</p>
<h2 id="解析和-actions">解析和 actions&nbsp;<a class="headline-hash no-text-decoration" href="#解析和-actions">#</a> </h2>
<p>运行以下代码:</p>
<pre><code>nqp --rxtrace -e &quot;/a+/&quot;
</code></pre>
<p>现在，让我们试着理解它。</p>
<p>在 NQP 仓库中, 打开 <code>src/NQP/Gramamr.nqp</code> 并定位到 <code>quote:sym&lt;/ /&gt;</code>。
观察到它调用了 <code>LANG</code>, 那是做语言切换. 这可以在 <code>src/HLL/Grammar.nqp</code> 中找到。 注意它如何使用编织，还有切换操作以及语言类型。</p>
<p>下面, 打开 <code>src/QRegex/P6Regex/Grammar.nqp</code> 并定位到 <code>nibbler</code>。尝试挑出对 <code>termaltseq</code> 的调用. 看看 <code>termaltseq</code> 自身, 然后该 action 方法所在的 Action 文件。 往下找, 找到 <code>termish</code>, 并尝试理解它在那儿做什么: 处理不同的备选分支和连词的相对优先级。</p>
<p>再往下, 看看下面的 <code>atom</code>。 注意这里我们的正则表达式中的 <code>a</code> 是怎样被解析的。然后回头查看 <code>quantified_atom</code>。 阅读 action 方法，看看原子如何放入量词节点。</p>
<p>您可能希望探索如何处理其他一些结构。</p>
<h2 id="探索嵌入式代码块">探索嵌入式代码块&nbsp;<a class="headline-hash no-text-decoration" href="#探索嵌入式代码块">#</a> </h2>
<p>在 NQP grammar 中, 查看 <code>NQP::Regex</code>。 注意它是你正在看的基本 <code>QRegex::P6Regex::Grammar</code>  的一个子类。这是 grammar 真正成为类的力量的一部分：我们可以将它们子类化以专门化它们。</p>
<p>让我们来看一下 <code>/[a { say('here') }]+/</code> 是怎样被处理的. 这很有趣, 因为我们从 NQP 开始, 然后解析正则表达式语法, 然后以在块中再次解析 NQP 代码结束。定位到 <code>assertion:sym&lt;{ }&gt;</code>, 然后查看 <code>codeblock</code>。 享受相对简单的事情!</p>
<p>看一下 <code>NQP::RegexActions</code> 里面的 <code>codeblock</code> action 方法。 你能弄清楚发生了什么吗？ 如果没有，请问你的老师或你周围的人！</p>
<h2 id="探索-nfas">探索 NFAs&nbsp;<a class="headline-hash no-text-decoration" href="#探索-nfas">#</a> </h2>
<p>保存的 NFA 形式存储在规则的代码对象中。 因此，我们可以获得它并返回到一个对象，如下所示：</p>
<pre><code>grammar Example {
    token t { 'foo' }
}

my $t   := nqp::findmethod(Example, 't');
my $nfa := QRegex::NFA.from_saved($t.NFA());
</code></pre>
<p>但是怎么办呢？ 接下来，打开 <code>src/QRegex/NFA.nqp</code>。 查看顶部附近的边缘类型常量列表。 NFA 的整体结构是列表。 外部列表表示状态 - 图中的节点。 每个节点由其出局边缘列表组成，由 3 个值表示：</p>
<ul>
<li>一个 action，它是 NFA.nqp 顶部的边缘类型常量之一</li>
<li>action 的参数</li>
<li>如果我们匹配，将转到下一个状态的索引</li>
</ul>
<p>我们可以写一些代码来转储这个：</p>
<pre><code>my $i := 0;
for $nfa.states -&gt; @edges {
    say(&quot;State $i&quot;);
    for @edges -&gt; $act, $arg, $to {
        say(&quot;    $act ($arg) ==&gt; $to&quot;);
    }
    $i++;
}
</code></pre>
<p>对于我们的简单示例，我们得到:</p>
<pre><code>State 0
State 1
    2 (102) ==&gt; 2
State 2
    2 (111) ==&gt; 3
State 3
    2 (111) ==&gt; 0
</code></pre>
<p>边缘类型 2 表示代码点，这里的参数是我们应该匹配的字符代码，如果我们要进入下一个状态。 看看我们如何从状态 1 开始，到达状态 0 是成功的。
在 token 中尝试一些不同的东西，看看 NFA 是什么样的。 这是一些想法。</p>
<pre><code>a+
&lt;[abc]&gt;
&lt;[abc]&gt;*
&lt;foo&gt;?
\w*
:i abc
:i a+
</code></pre>


        </div>
    </div>
</article>



                <footer>
                    




<div class="no-text-decoration">
    <div class="jump top"><a href="#" title="Top of this page">⮉</a></div>
    <div class="jump bottom"><a href="#bottom" title="Bottom of this page">⮋</a></div>
</div>


 
    
        <div class="hugotoc no-text-decoration">
            <nav id="TableOfContents">
  <ul>
    <li><a href="#hello-world">Hello, world</a></li>
    <li><a href="#变量">变量</a></li>
    <li><a href="#循环">循环</a></li>
    <li><a href="#子例程">子例程</a></li>
    <li><a href="#类">类</a></li>
    <li><a href="#multi-methods">Multi-methods</a></li>
    <li><a href="#如果时间允许">如果时间允许&hellip;</a></li>
  </ul>

  <ul>
    <li><a href="#grammar">Grammar</a></li>
    <li><a href="#actions">Actions</a></li>
    <li><a href="#额外任务-actions">额外任务: Actions</a></li>
    <li><a href="#额外任务-collect-lines">额外任务: Collect lines</a></li>
  </ul>

  <ul>
    <li><a href="#熟悉">熟悉</a></li>
    <li><a href="#delete">DELETE</a></li>
    <li><a href="#update">UPDATE</a></li>
    <li><a href="#refactor">Refactor</a></li>
    <li><a href="#如果你是-10x-工程师">如果你是 10x 工程师&hellip;</a></li>
  </ul>

  <ul>
    <li><a href="#基础">基础</a></li>
    <li><a href="#走得更远">走得更远</a></li>
  </ul>

  <ul>
    <li><a href="#values">Values</a></li>
    <li><a href="#operators">Operators</a></li>
    <li><a href="#variables">Variables</a></li>
    <li><a href="#额外任务-functions">额外任务: functions</a></li>
  </ul>

  <ul>
    <li><a href="#基本的数字关系运算符">基本的数字关系运算符</a></li>
    <li><a href="#ifelse-ifelse">if/else if/else</a></li>
    <li><a href="#while-循环">while 循环</a></li>
  </ul>

  <ul>
    <li><a href="#首先-元对象">首先, 元对象</a></li>
    <li><a href="#接下来解析类并为它们生成代码">接下来，解析类并为它们生成代码</a></li>
    <li><a href="#添加新项">添加新项</a></li>
    <li><a href="#添加方法调用">添加方法调用</a></li>
    <li><a href="#支持-this">支持 $this</a></li>
    <li><a href="#好吧这是很多复制粘贴">好吧，这是很多复制粘贴&hellip;</a></li>
  </ul>

  <ul>
    <li><a href="#method-缓存">Method 缓存</a></li>
    <li><a href="#继承">继承</a></li>
    <li><a href="#如果时间允许-interfaces">如果时间允许: interfaces</a></li>
  </ul>

  <ul>
    <li><a href="#解析和-actions">解析和 actions</a></li>
    <li><a href="#探索嵌入式代码块">探索嵌入式代码块</a></li>
    <li><a href="#探索-nfas">探索 NFAs</a></li>
  </ul>
</nav>
            <a href="#" class="back-to-top">Back to top</a>
        </div>
    
    
<script src="/js/libs/jquery/3.3.1/jquery.slim.min.min.22ee3db0c0e99fd0fbce3aee19672bd53d25469daf734bd4c165649f6eaf7d7f.js"></script>

<link rel="preload" href="/js/libs/jquery/3.3.1/jquery.slim.min.min.22ee3db0c0e99fd0fbce3aee19672bd53d25469daf734bd4c165649f6eaf7d7f.js" as="script">

<script type="application/javascript">(function() {
     var $window = $(window);
     if ($window.width() >= 1400) { 
         var $toc = $('#TableOfContents');
         if ($toc.length > 0) {
             function onScroll(){
                 var currentScroll = $window.scrollTop();
                 var h = $('.content h1, .content h2, .content h3, .content h4, .content h5, .content h6, .h-feed h2');
                 var id = "";
                 h.each(function (i, e) {
                     e = $(e);
                     if (e.offset().top - 10 <= currentScroll) {
                         id = e.attr('id');
                     }
                 });
                 var current = $toc.find('a.current');
                 if (current.length == 1 && current.eq(0).attr('href') == '#' + id) return true;

                 current.each(function (i, e) {
                     $(e).removeClass('current').siblings('ul').hide();
                 });
                 $toc.find('a[href="#' + id + '"]').parentsUntil('#TableOfContents').each(function (i, e) {
                     $(e).children('a').addClass('current').siblings('ul').show();
                 });
             }
             $window.on('scroll', onScroll);
             $(document).ready(function() {
                 $toc.find('a').parent('li').find('ul').hide();
                 onScroll();
                 document.getElementsByClassName('hugotoc')[0].style.display = '';
             });}}})();</script>








<div class="backtotop center no-text-decoration">
    <a href="#">back to <span class="top">top</span></a>
</div>


<div class="right">
    <div class="taxo no-text-decoration">
         
            
                <ul class="no-bullets inline categories">
                    
                        
                        
                        
                            
                            
                            
                            
                            
                            <li class="__rakulang__"
                                
                                
                                title="See all 0 posts categorized in ‘rakulang’"
                                
                            >
                                <a class="p-category" href="https://ohmyweekly.github.io/categories/rakulang/">rakulang</a>
                            </li>
                        
                    
                </ul>
            
         
            
                <ul class="no-bullets inline tags">
                    
                        
                        
                        
                            
                            
                            
                            
                            
                            <li class="__rakulang__"
                                
                                
                                title="See all 0 posts tagged with ‘rakulang’"
                                
                            >
                                <a class="p-category" href="https://ohmyweekly.github.io/tags/rakulang/">rakulang</a>
                            </li>
                        
                    
                </ul>
            
        
    </div>

</div>
<div class="clear-float"></div>



<div class="prev-next-navigator clear-float">
    
        <span class="prev-post left no-text-decoration">
            <a href="https://ohmyweekly.github.io/notes/import-external-libs-in-idea/" class="nobr">« 在 IDEA 中导入外部库</a>
        </span>
    
    
        <span class="next-post right no-text-decoration">
            <a href="https://ohmyweekly.github.io/notes/yet-another-udaf/" class="nobr">Spark 中的 UDAF 函数 »</a>
        </span>
    
</div>


<a id="bottom"></a>









                       







                    <ul class="no-bullets feed right inline">
    
        
        
    
</ul>
<div class="clear-float"></div>

                </footer>
                <hr />
            </div>               

            <footer> 
                

<ul class="social no-text-decoration">
    
</ul>










 
    
    



<p class="generated no-text-decoration">
    Generated using  <a href="https://gitlab.com/kaushalmodi/hugo-theme-refined"><code class="nobr">hugo-theme-refined</code></a> + <span class="nobr">Hugo <a href="https://github.com/gohugoio/hugo/commit/312735366b20d64bd61bff8627f593749f86c964">0.123.7</a></span>
</p>

<p>
    
</p>




<div class="badges no-text-decoration">
    
    

    
</div>




<script type="application/javascript">var nav=responsiveNav("#nav");</script>




<script defer src="/js/libs/fragmentions/wrapper.min.e8c468c89edc4f5dccaa8c720c6b220b3088a16cd7b1e4a1e3345985788260c9.js"></script>









            </footer>
        </div> 
    </body>
</html>
