<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-us" lang="en-us">

    <head>
    <link href="https://gmpg.org/xfn/11" rel="profile">
    <meta charset="utf-8">
    
    
    

    
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5">

    
    <meta name="referrer" content="no-referrer">

    <title>
        
            Raku 时间戳转换器命令行版 ❚ 焉知非鱼
        
    </title>

    
    


    
    
    
    

    
    
    
    

    
    
    

    
    
    
    <style>
     
     
     :root {
         --theme-color: #ac4142;
         --theme-color-light: rgba(172, 65, 66, 0.2);
     }
     
     html {
         line-height: 1.5;
     }
    </style>

    
    

    
    
    
    
    <link rel="stylesheet" href="/css/refined.min.7f6d3ee611034e4ebcbc063f1db3bc042fecdc8901afbedad80ff02bae409204.css">
    
    <link rel="preload" href="/css/refined.min.7f6d3ee611034e4ebcbc063f1db3bc042fecdc8901afbedad80ff02bae409204.css" as="style">

    



    
        <style>
         
         /* Background */ .chroma { background-color: #ffffff }
/* Error */ .chroma .err { color: #a61717; background-color: #e3d2d2 }
/* LineTableTD */ .chroma .lntd { vertical-align: top; padding: 0; margin: 0; border: 0; }
/* LineTable */ .chroma .lntable { border-spacing: 0; padding: 0; margin: 0; border: 0; width: auto; overflow: auto; display: block; }
/* LineHighlight */ .chroma .hl { display: block; width: 100%;background-color: #ffffcc }
/* LineNumbersTable */ .chroma .lnt { margin-right: 0.4em; padding: 0 0.4em 0 0.4em; }
/* LineNumbers */ .chroma .ln { margin-right: 0.4em; padding: 0 0.4em 0 0.4em; }
/* Keyword */ .chroma .k { color: #000000; font-weight: bold }
/* KeywordConstant */ .chroma .kc { color: #000000; font-weight: bold }
/* KeywordDeclaration */ .chroma .kd { color: #000000; font-weight: bold }
/* KeywordNamespace */ .chroma .kn { color: #000000; font-weight: bold }
/* KeywordPseudo */ .chroma .kp { color: #000000; font-weight: bold }
/* KeywordReserved */ .chroma .kr { color: #000000; font-weight: bold }
/* KeywordType */ .chroma .kt { color: #445588; font-weight: bold }
/* NameAttribute */ .chroma .na { color: #008080 }
/* NameBuiltin */ .chroma .nb { color: #0086b3 }
/* NameBuiltinPseudo */ .chroma .bp { color: #999999 }
/* NameClass */ .chroma .nc { color: #445588; font-weight: bold }
/* NameConstant */ .chroma .no { color: #008080 }
/* NameDecorator */ .chroma .nd { color: #3c5d5d; font-weight: bold }
/* NameEntity */ .chroma .ni { color: #800080 }
/* NameException */ .chroma .ne { color: #990000; font-weight: bold }
/* NameFunction */ .chroma .nf { color: #990000; font-weight: bold }
/* NameLabel */ .chroma .nl { color: #990000; font-weight: bold }
/* NameNamespace */ .chroma .nn { color: #555555 }
/* NameTag */ .chroma .nt { color: #000080 }
/* NameVariable */ .chroma .nv { color: #008080 }
/* NameVariableClass */ .chroma .vc { color: #008080 }
/* NameVariableGlobal */ .chroma .vg { color: #008080 }
/* NameVariableInstance */ .chroma .vi { color: #008080 }
/* LiteralString */ .chroma .s { color: #dd1144 }
/* LiteralStringAffix */ .chroma .sa { color: #dd1144 }
/* LiteralStringBacktick */ .chroma .sb { color: #dd1144 }
/* LiteralStringChar */ .chroma .sc { color: #dd1144 }
/* LiteralStringDelimiter */ .chroma .dl { color: #dd1144 }
/* LiteralStringDoc */ .chroma .sd { color: #dd1144 }
/* LiteralStringDouble */ .chroma .s2 { color: #dd1144 }
/* LiteralStringEscape */ .chroma .se { color: #dd1144 }
/* LiteralStringHeredoc */ .chroma .sh { color: #dd1144 }
/* LiteralStringInterpol */ .chroma .si { color: #dd1144 }
/* LiteralStringOther */ .chroma .sx { color: #dd1144 }
/* LiteralStringRegex */ .chroma .sr { color: #009926 }
/* LiteralStringSingle */ .chroma .s1 { color: #dd1144 }
/* LiteralStringSymbol */ .chroma .ss { color: #990073 }
/* LiteralNumber */ .chroma .m { color: #009999 }
/* LiteralNumberBin */ .chroma .mb { color: #009999 }
/* LiteralNumberFloat */ .chroma .mf { color: #009999 }
/* LiteralNumberHex */ .chroma .mh { color: #009999 }
/* LiteralNumberInteger */ .chroma .mi { color: #009999 }
/* LiteralNumberIntegerLong */ .chroma .il { color: #009999 }
/* LiteralNumberOct */ .chroma .mo { color: #009999 }
/* Operator */ .chroma .o { color: #000000; font-weight: bold }
/* OperatorWord */ .chroma .ow { color: #000000; font-weight: bold }
/* Comment */ .chroma .c { color: #999988; font-style: italic }
/* CommentHashbang */ .chroma .ch { color: #999988; font-style: italic }
/* CommentMultiline */ .chroma .cm { color: #999988; font-style: italic }
/* CommentSingle */ .chroma .c1 { color: #999988; font-style: italic }
/* CommentSpecial */ .chroma .cs { color: #999999; font-weight: bold; font-style: italic }
/* CommentPreproc */ .chroma .cp { color: #999999; font-weight: bold; font-style: italic }
/* CommentPreprocFile */ .chroma .cpf { color: #999999; font-weight: bold; font-style: italic }
/* GenericDeleted */ .chroma .gd { color: #000000; background-color: #ffdddd }
/* GenericEmph */ .chroma .ge { color: #000000; font-style: italic }
/* GenericError */ .chroma .gr { color: #aa0000 }
/* GenericHeading */ .chroma .gh { color: #999999 }
/* GenericInserted */ .chroma .gi { color: #000000; background-color: #ddffdd }
/* GenericOutput */ .chroma .go { color: #888888 }
/* GenericPrompt */ .chroma .gp { color: #555555 }
/* GenericStrong */ .chroma .gs { font-weight: bold }
/* GenericSubheading */ .chroma .gu { color: #aaaaaa }
/* GenericTraceback */ .chroma .gt { color: #aa0000 }
/* GenericUnderline */ .chroma .gl { text-decoration: underline }
/* TextWhitespace */ .chroma .w { color: #bbbbbb }

         
         /* Overrides on top of the theme and Chroma CSS */
/* Chroma-based lines highlighting in code blocks */
.chroma .hl {
    background-color: #e8e8e8;
    /* Extend highlight up to 100 characters (assuming that the code blocks never have more than 100 characters in a line) */
    min-width: 100ch;
}
/* GenericHeading */ .chroma .gh { color: #999999; font-weight: bold }
/* GenericSubheading */ .chroma .gu { color: #aaaaaa; font-weight: bold }

         
        </style>
    

    

    
    
    

    
    <script src="/js/responsive-nav-orig.min.e2b5f2a956b488f466da513820636134defdc38b90ed566248960593f2bb4ba5.js"></script>
    
    <link rel="preload" href="/js/responsive-nav-orig.min.e2b5f2a956b488f466da513820636134defdc38b90ed566248960593f2bb4ba5.js" as="script">

    
    
    <script defer src="/js/libs/fa/fontawesome-all.min.08916ac0fd078adfb58edc890460e2c8990729aee02bca7586404b56805f5219.js"></script>
    
    <link rel="preload" href="/js/libs/fa/fontawesome-all.min.08916ac0fd078adfb58edc890460e2c8990729aee02bca7586404b56805f5219.js" as="script">

    

    

    
    
    

    
    
<!-- rel="me" links for IndieAuth -->







    
 
<meta property="og:title" content="Raku 时间戳转换器命令行版" />
<meta property="og:description"
      content=" " />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://ohmycloud.github.io/posts/2016-12-31-raku%E6%97%B6%E9%97%B4%E6%88%B3%E8%BD%AC%E6%8D%A2%E5%99%A8%E5%91%BD%E4%BB%A4%E8%A1%8C%E7%89%88/" />


    
        <meta property="article:published_time" content="2016-12-31T23:14:12&#43;00:00"/>
    
    
        <meta property="article:modified_time" content="2016-12-31T23:14:12&#43;00:00"/>
    









    




     <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Raku 时间戳转换器命令行版"/>
<meta name="twitter:description" content=" "/>


    
    
    <link rel="alternate" type="application/jf2post+json" href="https://ohmycloud.github.io/posts/2016-12-31-raku%E6%97%B6%E9%97%B4%E6%88%B3%E8%BD%AC%E6%8D%A2%E5%99%A8%E5%91%BD%E4%BB%A4%E8%A1%8C%E7%89%88/jf2post.json" title="Jf2post for 焉知非鱼" />
    
     



    
    
    
        
    


     
        
        <meta name="DC.Creator" content="焉知非鱼"/>
    



    
    
    
    <meta name="hugo-build-date" content="2024-03-01T16:16:06Z"/>
    <meta name="hugo-commit-hash" content="312735366b20d64bd61bff8627f593749f86c964"/>
    <meta name="generator" content="Hugo 0.123.7">
</head>


    
        <body lang="en">
    

        
        <div class="border" id="home"></div>

        <div class="wrapper">   
            
<nav id="nav" class="nav-collapse opened" aria-hidden="false">
    <ul class="navbar">
        <li><a class="" href="/">Home</a></li>
        
            
                <li><a class="" href="https://ohmycloud.github.io/posts/">Posts</a></li>
            
        
            
                <li><a class="" href="https://ohmycloud.github.io/notes/">Notes</a></li>
            
        
        
            <li><a class="" href="https://ohmycloud.github.io/search/">Search</a></li>
        
    </ul>
</nav>

            <div class="container">
                <header class="masthead">
                    <div class="masthead-title no-text-decoration">
                        <a href="/">焉知非鱼</a> <span class="blinking-cursor">❚</span>
                    </div>
                    <div class="masthead-tagline">
                        Wait the light to fall
                    </div>
                </header>

                








<article class="post h-entry posts">
    <header>
        <div class="center">
    <div class="taxo no-text-decoration">
         
            
                <ul class="no-bullets inline categories">
                    
                        
                        
                        
                            
                            
                            
                            
                            
                            <li class="__rakulang__"
                                
                                
                                title="See all 0 posts categorized in ‘rakulang’"
                                
                            >
                                <a class="p-category" href="https://ohmycloud.github.io/categories/rakulang/">rakulang</a>
                            </li>
                        
                    
                </ul>
            
         
            
                <ul class="no-bullets inline tags">
                    
                        
                        
                        
                            
                            
                            
                            
                            
                            <li class="__rakulang__"
                                
                                
                                title="See all 0 posts tagged with ‘rakulang’"
                                
                            >
                                <a class="p-category" href="https://ohmycloud.github.io/tags/rakulang/">rakulang</a>
                            </li>
                        
                    
                </ul>
            
        
    </div>

</div>

        <h1 class="post-title p-name">Raku 时间戳转换器命令行版</h1>

        
        <data class="u-url" value="https://ohmycloud.github.io/posts/2016-12-31-raku%E6%97%B6%E9%97%B4%E6%88%B3%E8%BD%AC%E6%8D%A2%E5%99%A8%E5%91%BD%E4%BB%A4%E8%A1%8C%E7%89%88/"></data>

        <div class="date-syndication">
            


    
    
    <div class="post-date">
        
        <time datetime="2016-12-31T23:14:12+0000" class="dt-published">Sat Dec 31, 2016</time>
        
        
    </div>


            




        </div>
         



    
    
    
        
    


    
        
        <span class="hide">
            &mdash; <a href="https://ohmycloud.github.io/" class="u-author">焉知非鱼</a>
        </span>
    


    </header>

    <div class="content">
        


        





                       


        <div class="e-content">
            




<h1 id="raku-by-example-datetime-conversion-for-the-command-line">Raku By Example: Datetime Conversion for the Command Line</h1>
<p>我偶尔会在数据库中存储 UNIX 时间戳, 即从 1970-01-01 开始的秒数。我在按照日期查询数据库中的数据时, 需要将 UNIX 时间戳转换为人类可读的时间, 所以我写了个很小的工具来帮助我在 UNIX  时间戳和日期/时间之间来回转换:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-raku" data-lang="raku"><span class="line"><span class="cl"><span class="nv">$</span> <span class="n">autotime</span> <span class="mi">2015</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">24</span>
</span></span><span class="line"><span class="cl"><span class="mi">1450915200</span>
</span></span><span class="line"><span class="cl"><span class="nv">$</span> <span class="n">autotime</span> <span class="mi">2015</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">24</span> <span class="mi">11</span><span class="p">:</span><span class="mi">2</span><span class="s">3</span><span class="p">:</span><span class="mi">0</span><span class="s">0</span>
</span></span><span class="line"><span class="cl"><span class="mi">1450956180</span>
</span></span><span class="line"><span class="cl"><span class="nv">$</span> <span class="n">autotime</span> <span class="mi">1450915200</span>
</span></span><span class="line"><span class="cl"><span class="mi">2015</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">24</span>
</span></span><span class="line"><span class="cl"><span class="nv">$</span> <span class="n">autotime</span> <span class="mi">1450956180</span>
</span></span><span class="line"><span class="cl"><span class="mi">2015</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">24</span> <span class="mi">11</span><span class="p">:</span><span class="mi">2</span><span class="s">3</span><span class="p">:</span><span class="mi">0</span><span class="s">0</span>
</span></span></code></pre></div><h2 id="使用库">使用库&nbsp;<a class="headline-hash no-text-decoration" href="#使用库">#</a> </h2>
<p>Raku 的 <a href="https://docs.raku.org/type/DateTime">DateTime</a> 和 <a href="https://docs.raku.org/type/Date">Date</a> 模块会做实际的转换。
<code>DateTime.new</code> 构造函数有一个接收单个整数作为 UNIX 时间戳的变体:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-raku" data-lang="raku"><span class="line"><span class="cl"><span class="nv">$</span> <span class="nb">raku</span> <span class="o">-</span><span class="no">e</span> <span class="p">&#34;</span><span class="s2">say DateTime.new(1480915200)</span><span class="p">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="mi">2016</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mo">05</span><span class="n">T05:20:00Z</span>
</span></span></code></pre></div><p>看起来我们已经完成了一个方向的转换,对吗?</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-raku" data-lang="raku"><span class="line"><span class="cl"><span class="ch">#!/usr/bin/env raku</span>
</span></span><span class="line"><span class="cl"><span class="k">sub</span> <span class="nb">MAIN</span> <span class="p">(</span><span class="kt">Int</span> <span class="nv">$timestamp</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nb">say</span> <span class="kt">DateTime</span><span class="o">.</span><span class="nb">new</span><span class="p">(</span><span class="nv">$timestamp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>我们来运行它:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-raku" data-lang="raku"><span class="line"><span class="cl"><span class="nv">$</span> <span class="n">autotime</span> <span class="mi">1450915200</span>
</span></span><span class="line"><span class="cl"><span class="n">Invalid</span> <span class="kt">DateTime</span> <span class="n">string</span> <span class="p">&#39;</span><span class="s1">1450915200</span><span class="p">&#39;;</span> <span class="k">use</span> <span class="nn">an</span> <span class="n">ISO</span> <span class="mi">8601</span> <span class="n">timestamp</span> <span class="p">(</span><span class="n">yyyy-mm-ddThh:mm:ssZ</span> <span class="ow">or</span> <span class="n">yyyy-mm-ddThh:mm:ss</span><span class="o">+</span><span class="mo">01</span><span class="p">:</span><span class="mi">0</span><span class="s">0</span><span class="p">)</span> <span class="nb">instead</span>
</span></span><span class="line"><span class="cl">  <span class="nb">in</span> <span class="k">sub</span> <span class="nb">MAIN</span> <span class="nb">at</span> <span class="n">autotime</span> <span class="nb">line</span> <span class="mi">2</span>
</span></span><span class="line"><span class="cl">  <span class="nb">in</span> <span class="nb">block</span> <span class="o">&lt;</span><span class="k">unit</span><span class="o">&gt;</span> <span class="nb">at</span> <span class="n">autotime</span> <span class="nb">line</span> <span class="mi">2</span>
</span></span></code></pre></div><p>发生了什么？看起来 <code>DateTime</code> 构造函数把参数当作了字符串, 尽管 <code>sub MAIN</code> 的参数被声明为 <code>Int</code>。怎么会变成那样呢? 我们添加一些调试输出:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-raku" data-lang="raku"><span class="line"><span class="cl"><span class="ch">#!/usr/bin/env raku</span>
</span></span><span class="line"><span class="cl"><span class="k">sub</span> <span class="nb">MAIN</span><span class="p">(</span><span class="kt">Int</span> <span class="nv">$timestamp</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nb">say</span> <span class="nv">$timestamp</span><span class="o">.^</span><span class="nb">name</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nb">say</span> <span class="kt">DateTime</span><span class="o">.</span><span class="nb">new</span><span class="p">(</span><span class="nv">$timestamp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>打印出:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-raku" data-lang="raku"><span class="line"><span class="cl"><span class="kt">IntStr</span>
</span></span></code></pre></div><p><code>$thing.^name</code> 是 $thing 所属类的名字。 <a href="https://docs.raku.org/type/IntStr">IntStr</a> 是 <code>Int</code> 和 <code>Str</code> 类的子类, 这就是为什么 <code>DateTime</code> 构造函数正常地认为 $timestamp 是一个 <code>Str</code> 的原因。</p>
<p>长话短说, 我们可以在参数前添加一个 <code>+</code> 前缀使参数强制为 &ldquo;真&rdquo; 整数, 这也是将字符串转为数值的通用机制:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-raku" data-lang="raku"><span class="line"><span class="cl"><span class="ch">#!/usr/bin/env raku</span>
</span></span><span class="line"><span class="cl"><span class="k">sub</span> <span class="nb">MAIN</span><span class="p">(</span><span class="kt">Int</span> <span class="nv">$timestamp</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nb">say</span> <span class="kt">DateTime</span><span class="o">.</span><span class="nb">new</span><span class="p">(</span><span class="o">+</span><span class="nv">$timestamp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>这一次它真的工作了:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-raku" data-lang="raku"><span class="line"><span class="cl"><span class="nv">$</span> <span class="o">./</span><span class="n">autotime-01</span><span class="o">.</span><span class="nf">p6</span> <span class="mi">1450915200</span>
</span></span><span class="line"><span class="cl"><span class="mi">2015</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">24</span><span class="n">T00:00:00Z</span>
</span></span></code></pre></div><p>输出是 ISO 8601 样式的时间戳格式, 对眼睛不太友好。对于小时,分钟和秒数都为 0 的日期, 我们真正想要的只有日期:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-raku" data-lang="raku"><span class="line"><span class="cl"><span class="ch">#!/usr/bin/env raku</span>
</span></span><span class="line"><span class="cl"><span class="k">sub</span> <span class="nb">MAIN</span><span class="p">(</span><span class="kt">Int</span> <span class="nv">$timestamp</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">my</span> <span class="nv">$dt</span> <span class="o">=</span> <span class="kt">DateTime</span><span class="o">.</span><span class="nb">new</span><span class="p">(</span><span class="o">+</span><span class="nv">$timestamp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nv">$dt</span><span class="o">.</span><span class="nb">hour</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nv">$dt</span><span class="o">.</span><span class="nb">minute</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nv">$dt</span><span class="o">.</span><span class="nb">second</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nb">say</span> <span class="nv">$dt</span><span class="o">.</span><span class="kt">Date</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nb">say</span> <span class="nv">$dt</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>这样看起来更好一点:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-raku" data-lang="raku"><span class="line"><span class="cl"><span class="nv">$</span> <span class="o">./</span><span class="n">autotime</span> <span class="mi">1450915200</span>
</span></span><span class="line"><span class="cl"><span class="mi">2015</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">24</span>
</span></span></code></pre></div><p>但是上面那种三个比较都为 0 的写法实在太丑了, 如果是 4 个, 5 个, 6 个&hellip; 那就是又丑又长。Raku 有一个 <code>all</code> Junction:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-raku" data-lang="raku"><span class="line"><span class="cl"><span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="nv">$dt</span><span class="o">.</span><span class="nb">hour</span><span class="o">,</span> <span class="nv">$dt</span><span class="o">.</span><span class="nb">minute</span><span class="o">,</span> <span class="nv">$dt</span><span class="o">.</span><span class="nb">second</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nb">say</span> <span class="nv">$dt</span><span class="o">.</span><span class="kt">Date</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p><code>all(...)</code> 创建了一个 <a href="https://docs.raku.org/type/Junction">Junction</a>, 它是几个其他值的组合值, 它也存储了一个逻辑模式。当你比较一个 junction 和其他值的时候, 那个比较会自动地应用到该 junction 中的所有值上。<code>if</code> 语句在布尔上下文中对该 junction 进行求值, 在这个例子中, 当所有的比较为 <code>True</code> 时, if 也返回 <code>True</code>。</p>
<p>其他类型的 junction 还有 <code>any</code>, <code>all</code>, <code>none</code>。考虑到在布尔上下文中, 0 是唯一一个求值为 false 的整数, 我们甚至可以把上面的例子写为:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-raku" data-lang="raku"><span class="line"><span class="cl"><span class="k">if</span> <span class="nb">none</span><span class="p">(</span><span class="nv">$dt</span><span class="o">.</span><span class="nb">hour</span><span class="o">,</span> <span class="nv">$dt</span><span class="o">.</span><span class="nb">minute</span><span class="o">,</span> <span class="nv">$dt</span><span class="o">.</span><span class="nb">second</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nb">say</span> <span class="nv">$dt</span><span class="o">.</span><span class="kt">Date</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>但是也可能没有必要搞得那么复杂,  如果 <code>$dt</code> 这个 Datetime 对象转换为 <code>Date</code>  然后再转换为 DateTime 而不丢失信息, 那么它肯定是一个 Date:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-raku" data-lang="raku"><span class="line"><span class="cl"><span class="k">if</span> <span class="nv">$dt</span><span class="o">.</span><span class="kt">Date</span><span class="o">.</span><span class="kt">DateTime</span> <span class="o">==</span> <span class="nv">$dt</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nb">say</span> <span class="nv">$dt</span><span class="o">.</span><span class="kt">Date</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nb">say</span> <span class="nv">$dt</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h2 id="datetime-格式化">DateTime 格式化&nbsp;<a class="headline-hash no-text-decoration" href="#datetime-格式化">#</a> </h2>
<p>如果时间戳没有被解析为整天, 那么当前我们的脚本的输出就会像这样:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-raku" data-lang="raku"><span class="line"><span class="cl"><span class="mi">2015</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">24</span><span class="n">T00:00:01Z</span>
</span></span></code></pre></div><p>其中的 &ldquo;Z&rdquo; 表示 UTC 或 &ldquo;Zulu&rdquo; 时区。</p>
<p><code>DateTime</code> 类支持自定义格式化, 所以我们来写一个:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-raku" data-lang="raku"><span class="line"><span class="cl"><span class="k">sub</span> <span class="nb">MAIN</span><span class="p">(</span><span class="kt">Int</span> <span class="nv">$timestamp</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">my</span> <span class="nv">$dt</span> <span class="o">=</span> <span class="kt">DateTime</span><span class="o">.</span><span class="nb">new</span><span class="p">(</span><span class="o">+</span><span class="nv">$timestamp</span><span class="o">,</span> <span class="s">formatter</span> <span class="o">=&gt;</span> <span class="k">sub</span> <span class="p">(</span><span class="nv">$o</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nb">sprintf</span> <span class="p">&#39;</span><span class="s1">%04d-%02d-%02d %02d:%02d:%02d</span><span class="p">&#39;</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                    <span class="nv">$o</span><span class="o">.</span><span class="nb">year</span><span class="o">,</span> <span class="nv">$o</span><span class="o">.</span><span class="nb">month</span><span class="o">,</span>  <span class="nv">$o</span><span class="o">.</span><span class="nb">day</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                    <span class="nv">$o</span><span class="o">.</span><span class="nb">hour</span><span class="o">,</span> <span class="nv">$o</span><span class="o">.</span><span class="nb">minute</span><span class="o">,</span> <span class="nv">$o</span><span class="o">.</span><span class="nb">second</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">});</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nv">$dt</span><span class="o">.</span><span class="kt">Date</span><span class="o">.</span><span class="kt">DateTime</span> <span class="o">==</span> <span class="nv">$dt</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nb">say</span> <span class="nv">$dt</span><span class="o">.</span><span class="kt">Date</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nb">say</span> <span class="nv">$dt</span><span class="o">.</span><span class="kt">Str</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>现在输出看起来更好看了:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-raku" data-lang="raku"><span class="line"><span class="cl"><span class="o">./</span><span class="n">autotime</span> <span class="mi">1450915201</span>
</span></span><span class="line"><span class="cl"><span class="mi">2015</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">24</span> <span class="mo">00</span><span class="p">:</span><span class="mi">0</span><span class="s">0</span><span class="p">:</span><span class="mi">0</span><span class="s">1</span>
</span></span></code></pre></div><p>语法 <code>formatter =&gt; ...</code> 在参数上下文中表示具名参数。
这样的代码我不喜欢, 因为在 <code>DateTime.new</code> 调用中它是内联的, 这并不清晰。</p>
<p>我们来单独写一个例程:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-raku" data-lang="raku"><span class="line"><span class="cl"><span class="ch">#!/usr/bin/env raku</span>
</span></span><span class="line"><span class="cl"><span class="k">sub</span> <span class="nb">MAIN</span><span class="p">(</span><span class="kt">Int</span> <span class="nv">$timestamp</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">sub</span> <span class="nb">formatter</span><span class="p">(</span><span class="nv">$o</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nb">sprintf</span> <span class="p">&#39;</span><span class="s1">%04d-%02d-%02d %02d:%02d:%02d</span><span class="p">&#39;</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                <span class="nv">$o</span><span class="o">.</span><span class="nb">year</span><span class="o">,</span> <span class="nv">$o</span><span class="o">.</span><span class="nb">month</span><span class="o">,</span>  <span class="nv">$o</span><span class="o">.</span><span class="nb">day</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                <span class="nv">$o</span><span class="o">.</span><span class="nb">hour</span><span class="o">,</span> <span class="nv">$o</span><span class="o">.</span><span class="nb">minute</span><span class="o">,</span> <span class="nv">$o</span><span class="o">.</span><span class="nb">second</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">my</span> <span class="nv">$dt</span> <span class="o">=</span> <span class="kt">DateTime</span><span class="o">.</span><span class="nb">new</span><span class="p">(</span><span class="o">+</span><span class="nv">$timestamp</span><span class="o">,</span> <span class="s">formatter</span> <span class="o">=&gt;</span> <span class="nv">&amp;formatter</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nv">$dt</span><span class="o">.</span><span class="kt">Date</span><span class="o">.</span><span class="kt">DateTime</span> <span class="o">==</span> <span class="nv">$dt</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nb">say</span> <span class="nv">$dt</span><span class="o">.</span><span class="kt">Date</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nb">say</span> <span class="nv">$dt</span><span class="o">.</span><span class="kt">Str</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>是的, 你可以把一个子例程声明放在另一个子例程声明的正文中; 子例程只是一个普通的词法符号,就像一个用 <code>my</code> 声明的变量。</p>
<p>在行 <code>my $dt = DateTime.new(+$timestamp,formatter =&gt; &amp;formatter);</code> 中, 语法 <code>&amp;formatter</code> 引用子例程作为一个对象,而不调用它。</p>
<p>这是 Raku, <code>formatter =&gt; &amp;formatter</code> 有一个简写: <code>&amp;formatter</code>。
作为一般规则,如果要填充一个名称为变量名称并且其值为变量值的命名参数, 可以通过写入 <code>:$variable</code> 创建它。 作为扩展, <code>:thing</code> 是 <code>thing =&gt; True</code> 的缩写。</p>
<h2 id="寻找其他途径">寻找其他途径&nbsp;<a class="headline-hash no-text-decoration" href="#寻找其他途径">#</a> </h2>
<p>现在, 从时间戳到日期和时间的转换工作的很好, 让我们看另一种途径。
我们的小工具需要解析输入, 并决定输入的是时间戳还是日期和可选的时间。</p>
<p>一种无聊的方式是使用条件:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-raku" data-lang="raku"><span class="line"><span class="cl"><span class="k">sub</span> <span class="nb">MAIN</span><span class="p">(</span><span class="nv">$input</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nv">$input</span> <span class="o">~~</span> <span class="p">/</span><span class="sr"> </span><span class="ni">^</span><span class="sr"> </span><span class="se">\d</span><span class="o">+</span><span class="sr"> </span><span class="ni">$</span><span class="sr"> </span><span class="p">/</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># convert from timestamp to date/datetime</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># convert from date to timestamp</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>但我讨厌无聊, 所以我想看看一个更令人兴奋的（端可扩展）方法。</p>
<p>Raku 支持多重分派。这意味着您可以有多个具有相同名称但不同签名的子例程。
Raku 自动决定要调用哪一个。 您必须通过编写 <code>multi sub</code> 而不是 <code>sub</code> 来显式地启用此功能, 以便 Raku 可以捕获意外的重新声明。</p>
<p>让我们看看它在实际中的运用:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-raku" data-lang="raku"><span class="line"><span class="cl"><span class="ch">#!/usr/bin/env raku</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">multi</span> <span class="k">sub</span> <span class="nb">MAIN</span><span class="p">(</span><span class="kt">Int</span> <span class="nv">$timestamp</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">sub</span> <span class="nb">formatter</span><span class="p">(</span><span class="nv">$o</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nb">sprintf</span> <span class="p">&#39;</span><span class="s1">%04d-%02d-%02d %02d:%02d:%02d</span><span class="p">&#39;</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                <span class="nv">$o</span><span class="o">.</span><span class="nb">year</span><span class="o">,</span> <span class="nv">$o</span><span class="o">.</span><span class="nb">month</span><span class="o">,</span>  <span class="nv">$o</span><span class="o">.</span><span class="nb">day</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                <span class="nv">$o</span><span class="o">.</span><span class="nb">hour</span><span class="o">,</span> <span class="nv">$o</span><span class="o">.</span><span class="nb">minute</span><span class="o">,</span> <span class="nv">$o</span><span class="o">.</span><span class="nb">second</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">my</span> <span class="nv">$dt</span> <span class="o">=</span> <span class="kt">DateTime</span><span class="o">.</span><span class="nb">new</span><span class="p">(</span><span class="o">+</span><span class="nv">$timestamp</span><span class="o">,</span> <span class="o">:</span><span class="nv">&amp;formatter</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nv">$dt</span><span class="o">.</span><span class="kt">Date</span><span class="o">.</span><span class="kt">DateTime</span> <span class="o">==</span> <span class="nv">$dt</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nb">say</span> <span class="nv">$dt</span><span class="o">.</span><span class="kt">Date</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nb">say</span> <span class="nv">$dt</span><span class="o">.</span><span class="kt">Str</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">multi</span> <span class="k">sub</span> <span class="nb">MAIN</span><span class="p">(</span><span class="kt">Str</span> <span class="nv">$date</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nb">say</span> <span class="kt">Date</span><span class="o">.</span><span class="nb">new</span><span class="p">(</span><span class="nv">$date</span><span class="p">)</span><span class="o">.</span><span class="kt">DateTime</span><span class="o">.</span><span class="nb">posix</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>我们看一下效果:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-raku" data-lang="raku"><span class="line"><span class="cl"><span class="nv">$</span> <span class="o">./</span><span class="n">autotime</span> <span class="mi">2015</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">24</span>
</span></span><span class="line"><span class="cl"><span class="mi">1450915200</span>
</span></span><span class="line"><span class="cl"><span class="nv">$</span> <span class="o">./</span><span class="n">autotime</span> <span class="mi">1450915200</span>
</span></span><span class="line"><span class="cl"><span class="n">Ambiguous</span> <span class="n">call</span> <span class="nb">to</span> <span class="p">&#39;</span><span class="s1">MAIN</span><span class="p">&#39;;</span> <span class="n">these</span> <span class="n">signatures</span> <span class="nb">all</span> <span class="nb">match</span><span class="o">:</span>
</span></span><span class="line"><span class="cl"><span class="o">:</span><span class="p">(</span><span class="kt">Int</span> <span class="nv">$timestamp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="o">:</span><span class="p">(</span><span class="kt">Str</span> <span class="nv">$date</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="nb">in</span> <span class="nb">block</span> <span class="o">&lt;</span><span class="k">unit</span><span class="o">&gt;</span> <span class="nb">at</span> <span class="o">./</span><span class="n">autotime</span> <span class="nb">line</span> <span class="mi">17</span>
</span></span></code></pre></div><p>不是我所想象的。问题又是整数参数自动被转换为了 <code>IntStr</code>, Int 和 Str <code>multi</code>（或候选）都接受它作为参数。</p>
<p>避免这种错误的最简单的方法是缩小 Str 候选者接受的字符串的种类。
经典的方法是用一个正则表达式粗略验证传入的参数:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-raku" data-lang="raku"><span class="line"><span class="cl"><span class="k">multi</span> <span class="k">sub</span> <span class="nb">MAIN</span><span class="p">(</span><span class="kt">Str</span> <span class="nv">$date</span> <span class="k">where</span> <span class="o">/^</span> \<span class="nb">d</span><span class="o">+</span> \<span class="o">-</span> \<span class="nb">d</span><span class="o">+</span> \<span class="o">-</span> \<span class="nb">d</span><span class="o">+</span> <span class="nv">$</span> <span class="o">/</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nb">say</span> <span class="kt">Date</span><span class="o">.</span><span class="nb">new</span><span class="p">(</span><span class="nv">$date</span><span class="p">)</span><span class="o">.</span><span class="kt">DateTime</span><span class="o">.</span><span class="nb">posix</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>它确实能工作, 但为什么重复 Date.new 已经有用于验证日期字符串的逻辑？
如果你传递一个看起来不像日期的字符串参数,你会得到这样的错误：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-raku" data-lang="raku"><span class="line"><span class="cl"><span class="n">Invalid</span> <span class="kt">Date</span> <span class="n">string</span> <span class="p">&#39;</span><span class="s1">foobar</span><span class="p">&#39;;</span> <span class="k">use</span> <span class="nb">yyyy-mm-dd</span> <span class="nb">instead</span>
</span></span></code></pre></div><p>我们可以使用这种行为约束 <code>MAIN multi</code> 候选者的字符串参数：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-raku" data-lang="raku"><span class="line"><span class="cl"><span class="k">multi</span> <span class="k">sub</span> <span class="nb">MAIN</span><span class="p">(</span><span class="kt">Str</span> <span class="nv">$date</span> <span class="k">where</span> <span class="p">{</span> <span class="k">try</span> <span class="kt">Date</span><span class="o">.</span><span class="nb">new</span><span class="p">(</span><span class="nv">$_</span><span class="p">)</span> <span class="p">})</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nb">say</span> <span class="kt">Date</span><span class="o">.</span><span class="nb">new</span><span class="p">(</span><span class="nv">$date</span><span class="p">)</span><span class="o">.</span><span class="kt">DateTime</span><span class="o">.</span><span class="nb">posix</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>在这里额外的 <code>try</code> 是因为子类型约束后面的 <code>where</code> 不应该抛出异常, 而只是返回一个假值。</p>
<p>现在它的工作得像预期的一样:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-raku" data-lang="raku"><span class="line"><span class="cl"><span class="nv">$</span> <span class="o">./</span><span class="n">autotime</span> <span class="mi">2015</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">24</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="mi">1450915200</span>
</span></span><span class="line"><span class="cl"><span class="nv">$</span> <span class="o">./</span><span class="n">autotime</span> <span class="mi">1450915200</span>
</span></span><span class="line"><span class="cl"><span class="mi">2015</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">24</span>
</span></span></code></pre></div><h2 id="处理时间">处理时间&nbsp;<a class="headline-hash no-text-decoration" href="#处理时间">#</a> </h2>
<p>剩下要实现的功能是把日期和时间转换为时间戳。换句话说, 我们想这样调用 <code>autotime 2015-12-24 11:23:00</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-raku" data-lang="raku"><span class="line"><span class="cl"><span class="k">multi</span> <span class="k">sub</span> <span class="nb">MAIN</span><span class="p">(</span><span class="kt">Str</span> <span class="nv">$date</span> <span class="k">where</span> <span class="p">{</span> <span class="k">try</span> <span class="kt">Date</span><span class="o">.</span><span class="nb">new</span><span class="p">(</span><span class="nv">$_</span><span class="p">)</span> <span class="p">}</span><span class="o">,</span> <span class="kt">Str</span> <span class="nv">$time</span><span class="o">?</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">my</span> <span class="nv">$d</span> <span class="o">=</span> <span class="kt">Date</span><span class="o">.</span><span class="nb">new</span><span class="p">(</span><span class="nv">$date</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nv">$time</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">my</span> <span class="p">(</span> <span class="nv">$hour</span><span class="o">,</span> <span class="nv">$minute</span><span class="o">,</span> <span class="nv">$second</span> <span class="p">)</span> <span class="o">=</span> <span class="nv">$time</span><span class="o">.</span><span class="nb">split</span><span class="p">(&#39;</span><span class="s1">:</span><span class="p">&#39;);</span>
</span></span><span class="line"><span class="cl">        <span class="nb">say</span> <span class="kt">DateTime</span><span class="o">.</span><span class="nb">new</span><span class="p">(</span><span class="s">date</span> <span class="o">=&gt;</span> <span class="nv">$d</span><span class="o">,</span> <span class="o">:</span><span class="nv">$hour</span><span class="o">,</span> <span class="o">:</span><span class="nv">$minute</span><span class="o">,</span> <span class="o">:</span><span class="nv">$second</span><span class="p">)</span><span class="o">.</span><span class="nb">posix</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nb">say</span> <span class="nv">$d</span><span class="o">.</span><span class="kt">DateTime</span><span class="o">.</span><span class="nb">posix</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>凭借尾部的?, 新的第二个参数是可选的 。 如果存在第二个参数, 我们用冒号将时间字符串分割成小时,分钟和秒。 我写的第一个本能是使用较短的变量名称, <code>my($h, $m, $s) = $time.split(':')</code>, 但然后调用 <code>DateTime</code> 构造函数看起来像这样：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-raku" data-lang="raku"><span class="line"><span class="cl"><span class="kt">DateTime</span><span class="o">.</span><span class="nb">new</span><span class="p">(</span><span class="s">date</span> <span class="o">=&gt;</span> <span class="nv">$d</span><span class="o">,</span> <span class="s">hour</span> <span class="o">=&gt;</span> <span class="nv">$h</span><span class="o">,</span> <span class="s">minute</span> <span class="o">=&gt;</span> <span class="nv">$m</span><span class="o">,</span> <span class="s">second</span> <span class="o">=&gt;</span> <span class="nv">$s</span><span class="p">);</span>
</span></span></code></pre></div><p>所以构造函数的命名参数使我选择更多的自解释变量名。</p>
<p>所以, 这个可以工作:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-raku" data-lang="raku"><span class="line"><span class="cl"><span class="o">./</span><span class="n">autotime</span> <span class="mi">2015</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">24</span> <span class="mi">11</span><span class="p">:</span><span class="mi">2</span><span class="s">3</span><span class="p">:</span><span class="mi">0</span><span class="s">0</span>
</span></span><span class="line"><span class="cl"><span class="mi">1450956180</span>
</span></span></code></pre></div><p>而且我们还可以检测它的原形:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-raku" data-lang="raku"><span class="line"><span class="cl"><span class="nv">$</span> <span class="o">./</span><span class="n">autotime</span> <span class="mi">1450956180</span>
</span></span><span class="line"><span class="cl"><span class="mi">2015</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">24</span> <span class="mi">11</span><span class="p">:</span><span class="mi">2</span><span class="s">3</span><span class="p">:</span><span class="mi">0</span><span class="s">0</span>
</span></span></code></pre></div><h2 id="系好你的安全带">系好你的安全带&nbsp;<a class="headline-hash no-text-decoration" href="#系好你的安全带">#</a> </h2>
<p>Raku 的隐式变量或主题变量:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-raku" data-lang="raku"><span class="line"><span class="cl"><span class="k">for</span> <span class="mi">1</span><span class="o">..</span><span class="mi">3</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="nb">say</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>产生如下输出:</p>
<p>[source]</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-raku" data-lang="raku"><span class="line"><span class="cl"><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="mi">2</span>
</span></span><span class="line"><span class="cl"><span class="mi">3</span>
</span></span></code></pre></div><p>这个例子中没有显式的迭代变量, 所以 Perl 隐式地把当前循环的值绑定给叫做 <code>$_</code> 的变量。方法调用 <code>.say</code> 是 <code>$_.say</code> 的缩写。由于我们有一个子例程在同一个变量上调用了 6 个方法, 所以使用 <code>$_</code> 会有很好的可视效果:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-raku" data-lang="raku"><span class="line"><span class="cl"><span class="k">sub</span> <span class="nb">formatter</span><span class="p">(</span><span class="nv">$_</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nb">sprintf</span> <span class="p">&#39;</span><span class="s1">%04d-%02d-%02d %02d:%02d:%02d</span><span class="p">&#39;</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">            <span class="o">.</span><span class="nb">year</span><span class="o">,</span> <span class="o">.</span><span class="nb">month</span><span class="o">,</span>  <span class="o">.</span><span class="nb">day</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">            <span class="o">.</span><span class="nb">hour</span><span class="o">,</span> <span class="o">.</span><span class="nb">minute</span><span class="o">,</span> <span class="o">.</span><span class="nb">second</span><span class="o">,</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>如果你不想求助于函数定义在词法作用域中设置 <code>$_</code>, 那么你可以使用 <code>given VALUE BLOCK</code> 结构:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-raku" data-lang="raku"><span class="line"><span class="cl"><span class="k">given</span> <span class="kt">DateTime</span><span class="o">.</span><span class="nb">new</span><span class="p">(</span><span class="o">+</span><span class="nv">$timestamp</span><span class="o">,</span> <span class="o">:</span><span class="nv">&amp;formatter</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">.</span><span class="kt">Date</span><span class="o">.</span><span class="kt">DateTime</span> <span class="o">==</span> <span class="nv">$_</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nb">say</span> <span class="o">.</span><span class="kt">Date</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="o">.</span><span class="nb">say</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>Raku 还提供了对 <code>$_</code> 变量的条件语句的快捷方式,可以用作一个通用的switch语句：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-raku" data-lang="raku"><span class="line"><span class="cl"><span class="k">given</span> <span class="kt">DateTime</span><span class="o">.</span><span class="nb">new</span><span class="p">(</span><span class="o">+</span><span class="nv">$timestamp</span><span class="o">,</span> <span class="o">:</span><span class="nv">&amp;formatter</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">when</span> <span class="o">.</span><span class="kt">Date</span><span class="o">.</span><span class="kt">DateTime</span> <span class="o">==</span> <span class="nv">$_</span> <span class="p">{</span> <span class="nb">say</span> <span class="o">.</span><span class="kt">Date</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">default</span> <span class="p">{</span> <span class="o">.</span><span class="nb">say</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>如果你有一个只读的变量或参数, 那么你可以不使用 <code>$</code> 符号, 虽然你可以在声明时使用反斜线:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-raku" data-lang="raku"><span class="line"><span class="cl"><span class="k">multi</span> <span class="k">sub</span> <span class="nb">MAIN</span><span class="p">(</span><span class="kt">Int</span> \<span class="n">timestamp</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span>
</span></span><span class="line"><span class="cl">    <span class="k">given</span> <span class="kt">DateTime</span><span class="o">.</span><span class="nb">new</span><span class="p">(</span><span class="o">+</span><span class="n">timestamp</span><span class="o">,</span> <span class="o">:</span><span class="nv">&amp;formatter</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>所以现在完整的代码看起来像这样:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-raku" data-lang="raku"><span class="line"><span class="cl"><span class="ch">#!/usr/bin/env raku</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">multi</span> <span class="k">sub</span> <span class="nb">MAIN</span><span class="p">(</span><span class="kt">Int</span> \<span class="n">timestamp</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">sub</span> <span class="nb">formatter</span><span class="p">(</span><span class="nv">$_</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nb">sprintf</span> <span class="p">&#39;</span><span class="s1">%04d-%02d-%02d %02d:%02d:%02d</span><span class="p">&#39;</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="nb">year</span><span class="o">,</span> <span class="o">.</span><span class="nb">month</span><span class="o">,</span>  <span class="o">.</span><span class="nb">day</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="nb">hour</span><span class="o">,</span> <span class="o">.</span><span class="nb">minute</span><span class="o">,</span> <span class="o">.</span><span class="nb">second</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">given</span> <span class="kt">DateTime</span><span class="o">.</span><span class="nb">new</span><span class="p">(</span><span class="o">+</span><span class="n">timestamp</span><span class="o">,</span> <span class="o">:</span><span class="nv">&amp;formatter</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">when</span> <span class="o">.</span><span class="kt">Date</span><span class="o">.</span><span class="kt">DateTime</span> <span class="o">==</span> <span class="nv">$_</span> <span class="p">{</span> <span class="nb">say</span> <span class="o">.</span><span class="kt">Date</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">default</span> <span class="p">{</span> <span class="o">.</span><span class="nb">say</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">multi</span> <span class="k">sub</span> <span class="nb">MAIN</span><span class="p">(</span><span class="kt">Str</span> <span class="nv">$date</span> <span class="k">where</span> <span class="p">{</span> <span class="k">try</span> <span class="kt">Date</span><span class="o">.</span><span class="nb">new</span><span class="p">(</span><span class="nv">$_</span><span class="p">)</span> <span class="p">}</span><span class="o">,</span> <span class="kt">Str</span> <span class="nv">$time</span><span class="o">?</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">my</span> <span class="nv">$d</span> <span class="o">=</span> <span class="kt">Date</span><span class="o">.</span><span class="nb">new</span><span class="p">(</span><span class="nv">$date</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nv">$time</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">my</span> <span class="p">(</span> <span class="nv">$hour</span><span class="o">,</span> <span class="nv">$minute</span><span class="o">,</span> <span class="nv">$second</span> <span class="p">)</span> <span class="o">=</span> <span class="nv">$time</span><span class="o">.</span><span class="nb">split</span><span class="p">(&#39;</span><span class="s1">:</span><span class="p">&#39;);</span>
</span></span><span class="line"><span class="cl">        <span class="nb">say</span> <span class="kt">DateTime</span><span class="o">.</span><span class="nb">new</span><span class="p">(</span><span class="s">date</span> <span class="o">=&gt;</span> <span class="nv">$d</span><span class="o">,</span> <span class="o">:</span><span class="nv">$hour</span><span class="o">,</span> <span class="o">:</span><span class="nv">$minute</span><span class="o">,</span> <span class="o">:</span><span class="nv">$second</span><span class="p">)</span><span class="o">.</span><span class="nb">posix</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nb">say</span> <span class="nv">$d</span><span class="o">.</span><span class="kt">DateTime</span><span class="o">.</span><span class="nb">posix</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h2 id="main-魔法">MAIN 魔法&nbsp;<a class="headline-hash no-text-decoration" href="#main-魔法">#</a> </h2>
<p>为我们调用 <code>sub MAIN</code> 的魔法还为我们提供了一个自动化的用法消息, 如果我们用不匹配任何 <code>multi</code> 的参数调用 MAIN, 例如调用时不提供参数:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-raku" data-lang="raku"><span class="line"><span class="cl"><span class="nv">$</span> <span class="o">./</span><span class="nf">autotime</span>
</span></span><span class="line"><span class="cl"><span class="n">Usage:</span>
</span></span><span class="line"><span class="cl">  <span class="o">./</span><span class="n">autotime</span> <span class="p">&lt;</span><span class="s">timestamp</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="o">./</span><span class="n">autotime</span> <span class="o">&lt;</span><span class="n">date</span><span class="o">&gt;</span> <span class="o">[</span><span class="p">&lt;</span><span class="s">time</span><span class="p">&gt;</span><span class="o">]</span>
</span></span></code></pre></div><p>我们可以通过在 MAIN subs 之前添加语义注释来为这些用法行添加简短描述:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-raku" data-lang="raku"><span class="line"><span class="cl"><span class="ch">#!/usr/bin/env raku</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">#| </span><span class="sd">Convert timestamp to ISO date
</span></span></span><span class="line"><span class="cl"><span class="sd"></span><span class="k">multi</span> <span class="k">sub</span> <span class="nb">MAIN</span><span class="p">(</span><span class="kt">Int</span> \<span class="n">timestamp</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">#| </span><span class="sd">Convert ISO date to timestamp
</span></span></span><span class="line"><span class="cl"><span class="sd"></span><span class="k">multi</span> <span class="k">sub</span> <span class="nb">MAIN</span><span class="p">(</span><span class="kt">Str</span> <span class="nv">$date</span> <span class="k">where</span> <span class="p">{</span> <span class="k">try</span> <span class="kt">Date</span><span class="o">.</span><span class="nb">new</span><span class="p">(</span><span class="nv">$_</span><span class="p">)</span> <span class="p">}</span><span class="o">,</span> <span class="kt">Str</span> <span class="nv">$time</span><span class="o">?</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>现在用法信息变为了:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-raku" data-lang="raku"><span class="line"><span class="cl"><span class="nv">$</span> <span class="o">./</span><span class="nf">autotime</span>
</span></span><span class="line"><span class="cl"><span class="n">Usage:</span>
</span></span><span class="line"><span class="cl">  <span class="o">./</span><span class="n">autotime</span> <span class="p">&lt;</span><span class="s">timestamp</span><span class="p">&gt;</span> <span class="o">--</span> <span class="n">Convert</span> <span class="n">timestamp</span> <span class="nb">to</span> <span class="n">ISO</span> <span class="n">date</span>
</span></span><span class="line"><span class="cl">  <span class="o">./</span><span class="n">autotime</span> <span class="o">&lt;</span><span class="n">date</span><span class="o">&gt;</span> <span class="o">[</span><span class="p">&lt;</span><span class="s">time</span><span class="p">&gt;</span><span class="o">]</span> <span class="o">--</span> <span class="n">Convert</span> <span class="n">ISO</span> <span class="n">date</span> <span class="nb">to</span> <span class="n">timestamp</span>
</span></span></code></pre></div><h2 id="总结">总结&nbsp;<a class="headline-hash no-text-decoration" href="#总结">#</a> </h2>
<p>我们已经看到了一些 Date 和 DateTime 算法, 但令人兴奋的部分是 multi dispatch, 命名参数,带有 where 从句的子类型约束, given/ when 和 隐式 $_ 变量, 以及一些魔法, 当涉及到 MAIN subs 时。</p>
<p>原文请参见 <a href="https://perlgeek.de/blog-en/perl-6/2016-book-timestamp-converter.html">Raku By Example: Datetime Conversion for the Command Line</a></p>


        </div>
    </div>
</article>



                <footer>
                    




<div class="no-text-decoration">
    <div class="jump top"><a href="#" title="Top of this page">⮉</a></div>
    <div class="jump bottom"><a href="#bottom" title="Bottom of this page">⮋</a></div>
</div>


 
    
        <div class="hugotoc no-text-decoration">
            <nav id="TableOfContents">
  <ul>
    <li><a href="#使用库">使用库</a></li>
    <li><a href="#datetime-格式化">DateTime 格式化</a></li>
    <li><a href="#寻找其他途径">寻找其他途径</a></li>
    <li><a href="#处理时间">处理时间</a></li>
    <li><a href="#系好你的安全带">系好你的安全带</a></li>
    <li><a href="#main-魔法">MAIN 魔法</a></li>
    <li><a href="#总结">总结</a></li>
  </ul>
</nav>
            <a href="#" class="back-to-top">Back to top</a>
        </div>
    
    
<script src="/js/libs/jquery/3.3.1/jquery.slim.min.min.22ee3db0c0e99fd0fbce3aee19672bd53d25469daf734bd4c165649f6eaf7d7f.js"></script>

<link rel="preload" href="/js/libs/jquery/3.3.1/jquery.slim.min.min.22ee3db0c0e99fd0fbce3aee19672bd53d25469daf734bd4c165649f6eaf7d7f.js" as="script">

<script type="application/javascript">(function() {
     var $window = $(window);
     if ($window.width() >= 1400) { 
         var $toc = $('#TableOfContents');
         if ($toc.length > 0) {
             function onScroll(){
                 var currentScroll = $window.scrollTop();
                 var h = $('.content h1, .content h2, .content h3, .content h4, .content h5, .content h6, .h-feed h2');
                 var id = "";
                 h.each(function (i, e) {
                     e = $(e);
                     if (e.offset().top - 10 <= currentScroll) {
                         id = e.attr('id');
                     }
                 });
                 var current = $toc.find('a.current');
                 if (current.length == 1 && current.eq(0).attr('href') == '#' + id) return true;

                 current.each(function (i, e) {
                     $(e).removeClass('current').siblings('ul').hide();
                 });
                 $toc.find('a[href="#' + id + '"]').parentsUntil('#TableOfContents').each(function (i, e) {
                     $(e).children('a').addClass('current').siblings('ul').show();
                 });
             }
             $window.on('scroll', onScroll);
             $(document).ready(function() {
                 $toc.find('a').parent('li').find('ul').hide();
                 onScroll();
                 document.getElementsByClassName('hugotoc')[0].style.display = '';
             });}}})();</script>








<div class="backtotop center no-text-decoration">
    <a href="#">back to <span class="top">top</span></a>
</div>


<div class="right">
    <div class="taxo no-text-decoration">
         
            
                <ul class="no-bullets inline categories">
                    
                        
                        
                        
                            
                            
                            
                            
                            
                            <li class="__rakulang__"
                                
                                
                                title="See all 0 posts categorized in ‘rakulang’"
                                
                            >
                                <a class="p-category" href="https://ohmycloud.github.io/categories/rakulang/">rakulang</a>
                            </li>
                        
                    
                </ul>
            
         
            
                <ul class="no-bullets inline tags">
                    
                        
                        
                        
                            
                            
                            
                            
                            
                            <li class="__rakulang__"
                                
                                
                                title="See all 0 posts tagged with ‘rakulang’"
                                
                            >
                                <a class="p-category" href="https://ohmycloud.github.io/tags/rakulang/">rakulang</a>
                            </li>
                        
                    
                </ul>
            
        
    </div>

</div>
<div class="clear-float"></div>



<div class="prev-next-navigator clear-float">
    
        <span class="prev-post left no-text-decoration">
            <a href="https://ohmycloud.github.io/notes/termux/" class="nobr">« 使用 termux 运行 Linux 系统</a>
        </span>
    
    
        <span class="next-post right no-text-decoration">
            <a href="https://ohmycloud.github.io/notes/%E9%81%8D%E5%8E%86%E6%97%A5%E6%9C%9F/" class="nobr">使用 shell 遍历日期 »</a>
        </span>
    
</div>


<a id="bottom"></a>









                       







                    <ul class="no-bullets feed right inline">
    
        
        
    
</ul>
<div class="clear-float"></div>

                </footer>
                <hr />
            </div>               

            <footer> 
                

<ul class="social no-text-decoration">
    
</ul>










 
    
    



<p class="generated no-text-decoration">
    Generated using  <a href="https://gitlab.com/kaushalmodi/hugo-theme-refined"><code class="nobr">hugo-theme-refined</code></a> + <span class="nobr">Hugo <a href="https://github.com/gohugoio/hugo/commit/312735366b20d64bd61bff8627f593749f86c964">0.123.7</a></span>
</p>

<p>
    
</p>




<div class="badges no-text-decoration">
    
    

    
</div>




<script type="application/javascript">var nav=responsiveNav("#nav");</script>




<script defer src="/js/libs/fragmentions/wrapper.min.e8c468c89edc4f5dccaa8c720c6b220b3088a16cd7b1e4a1e3345985788260c9.js"></script>









            </footer>
        </div> 
    </body>
</html>
